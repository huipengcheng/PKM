---
tags: ğŸ“¥ï¸/ğŸ“šï¸/ğŸŸ¥ï¸
aliases:
type: book
status: ğŸŸ¥ï¸
created: 2022-05-05 15-52
updated: 2022-06-01 22-15
---

# Title: [[{ 2021-07 Effective Java]]

## Metadata
- `Topics:` [[Java]]
- `Title:` [[{ 2021-07 Effective Java]]
- `Type:` [[{]]
- `Publish Date:` 
- `Reviewed Date:` [[2022-05-05]]

## Note

TODO æ¸…å•ï¼š

äºŒã€ä¸‰17-æœ€åã€å››ã€äº”ã€ä»¥åŠå…¶ä»–TODO

# ä¸€. åˆ›å»ºå’Œé”€æ¯å¯¹è±¡

## 1. è€ƒè™‘ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•ä»£æ›¿æ„é€ å™¨

ä¸‹é¢æ˜¯ `Boolean` ç±»çš„ä¸€ä¸ªç®€å•ä¾‹å­ï¼š

Â public static Boolean valueOf(boolean b) {  
Â  Â  Â return b ? Boolean.TRUE : Boolean.FALSE;  
Â }

æ³¨æ„é™æ€å·¥å‚æ–¹æ³•å’Œè®¾è®¡æ¨¡å¼ä¸­çš„å·¥å‚æ–¹æ³•å¹¶ä¸ç›¸åŒã€‚

ä¸€ä¸ªç±»å¯ä»¥ç»™å®¢æˆ·ç«¯æä¾›é™æ€å·¥å‚æ–¹æ³•æ¥ä»£æ›¿ public æ„é€ å™¨ï¼Œæˆ–è€…ä¸¤è€…éƒ½æœ‰ã€‚æä¾›é™æ€å·¥å‚æ–¹æ³•æœ‰ä¼˜ç‚¹ä¹Ÿæœ‰ç¼ºç‚¹ã€‚

### ä¼˜ç‚¹

#### é™æ€å·¥å‚æ–¹æ³•æœ‰åå­—

æœ‰ä¸€ä¸ªå¥½åå­—çš„é™æ€å·¥å‚æ–¹æ³•ä¼šä½¿å¾—å®¢æˆ·ç«¯çš„ä»£ç æ›´æ˜“è¯»ã€‚

åŒä¸€ä¸ªç±»å¯èƒ½æœ‰å¾ˆå¤šæ„é€ å™¨ï¼Œç”šè‡³æœ‰çš„æ„é€ å™¨å¯èƒ½ä»…ä»…åªæ˜¯å‚æ•°é¡ºåºä¸åŒã€‚ç”¨æˆ·è®°ä¸ä½ï¼Œæ¯æ¬¡ä½¿ç”¨çš„æ—¶å€™éƒ½å¿…é¡»æŸ¥çœ‹ç±»æ–‡æ¡£ã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªç±»æœ‰å¥½å‡ ä¸ªæ„é€ å™¨æœ‰ç€ç›¸åŒçš„ç­¾åï¼Œåªæ˜¯å‚æ•°é¡ºåºä¸åŒï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨å‡ ä¸ªé™æ€å·¥å‚æ–¹æ³•åˆ†åˆ«ä»£æ›¿å®ƒä»¬ï¼Œå¹¶ä¸”ç»™æ¯ä¸ªéƒ½å–ä¸ªå¥½åå­—æ¥ä½“ç°åŒºåˆ«ã€‚

#### å¹¶ä¸è¦æ±‚åœ¨æ¯æ¬¡è¢«è°ƒç”¨çš„æ—¶å€™åˆ›å»ºæ–°å¯¹è±¡

æ¯æ¬¡è°ƒç”¨æ„é€ å™¨çš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œè€Œé™æ€å·¥å‚æ–¹æ³•å¯ä»¥ä¸åŒã€‚è¿™å°±å…è®¸äº†ä¸å¯å˜ç±»ï¼ˆè¯¦è§ç¬¬ 17 æ¡ï¼‰ä½¿ç”¨ä¸€ä¸ªé¢„å…ˆåˆ›å»ºå¥½çš„å®ä¾‹ï¼Œæˆ–è€…åœ¨å®ä¾‹åˆ›å»ºçš„æ—¶å€™å°†å®ƒä»¬ç¼“å­˜èµ·æ¥ï¼Œè¿™æ ·å°±é¿å…äº†åˆ›å»ºä¸å¿…è¦çš„é‡å¤å¯¹è±¡ã€‚ä¾‹å¦‚ `Boolean.valueOf(boolean)` æ°¸è¿œä¸åˆ›å»ºæ–°å¯¹è±¡ã€‚è¿™ç§æ–¹æ³•ç±»ä¼¼äºäº«å…ƒï¼ˆflyweightï¼‰æ¨¡å¼ã€‚å®ƒå¯ä»¥åœ¨ç›¸åŒå¯¹è±¡è¢«ç»å¸¸è®¿é—®çš„æ—¶å€™ï¼Œæå¤§æé«˜æ€§èƒ½ï¼Œåœ¨åˆ›å»ºå¯¹è±¡èŠ±è´¹å¤§çš„æ—¶å€™æç¤ºå°¤å…¶æ˜¾è‘—ã€‚

é™æ€å·¥å‚æ–¹æ³•çš„è¿™ä¸ªèƒ½åŠ›å¯ä»¥ä½¿å¾—ç±»å¯ä»¥ä¸¥æ ¼æ§åˆ¶å“ªäº›å®ä¾‹åœ¨å“ªäº›æ—¶é—´å¯ä»¥å­˜åœ¨ã€‚è¿™ç§ç±»è¢«ç§°ä½œå®ä¾‹å—æ§ï¼ˆinstance-controlledï¼‰çš„ç±»ã€‚ç¼–å†™è¿™ç§ç±»çš„ç†ç”±å¦‚ä¸‹ã€‚å®ä¾‹å—æ§å¯ä»¥è®©ç±»ç¡®ä¿å®ƒæ˜¯ Singletonï¼ˆè¯¦è§ç¬¬ 3 æ¡ï¼‰æˆ–è€…æ˜¯ä¸å¯å®ä¾‹åŒ–ï¼ˆnoninstantiableï¼‰çš„ï¼ˆè¯¦è§ç¬¬ 4 æ¡ï¼‰ã€‚æ­¤å¤–ï¼Œå®ä¾‹å—æ§ä¹Ÿå¯ä»¥è®©ä¸å¯å˜å€¼ç±»ï¼ˆè¯¦è§ç¬¬ 17 æ¡ï¼‰ç¡®ä¿æ²¡æœ‰ä¸¤ä¸ªç›¸åŒçš„å®ä¾‹å­˜åœ¨ï¼š`a.equals(b)` åªæœ‰åœ¨ `a == b` çš„æ—¶å€™æ‰ä¸ºçœŸã€‚è¿™æ˜¯äº«å…ƒæ¨¡å¼çš„åŸºç¡€ï¼Œæšä¸¾ç±»å‹ä¹Ÿä¿è¯äº†è¿™ä¸€ç‚¹ã€‚

#### å¯ä»¥è¿”å›åŸè¿”å›ç±»å‹çš„ä»»æ„å­ç±»

è¿™ç§çµæ´»æ€§çš„ä¸€ç§è¿ç”¨æ˜¯ API åœ¨è¿”å›å¯¹è±¡ï¼ŒåŒæ—¶åˆå¯ä»¥è®©ç±»ä¸æ˜¯ publicã€‚ç”¨è¿™ç§æ–¹å¼æ¥éšè—å®ç°ç±»å¯ä»¥ä½¿ API å˜å¾—éå¸¸ç®€æ´ç´§å‡‘ã€‚è¿™ç§æ–¹å¼é€‚åˆäºåŸºäºæ¥å£çš„æ¡†æ¶ï¼ˆè¯¦è§ç¬¬ 20 æ¡ï¼‰ï¼Œå…¶ä¸­æ¥å£ä¸ºé™æ€å·¥å‚æ–¹æ³•æä¾›äº†è‡ªç„¶çš„è¿”å›ç±»å‹ï¼ˆä¹Ÿå°±æ˜¯è¯´é™æ€å·¥å‚æ–¹æ³•å£°æ˜ä¸Šçš„è¿”å›å€¼å¯ä»¥ç›´æ¥å†™æˆæ¥å£ï¼‰ã€‚

åœ¨ Java 8 ä¹‹å‰ï¼Œæ¥å£ä¸èƒ½æœ‰é™æ€æ–¹æ³•ã€‚æ‰€ä»¥æŒ‰ç…§æƒ¯ä¾‹ï¼Œä¸€ä¸ªåä¸º Type çš„æ¥å£ï¼Œå®ƒçš„é™æ€å·¥å‚æ–¹æ³•åº”è¯¥æ”¾åˆ°ä¸€ä¸ªåä¸º Types çš„ä¸å¯å®ä¾‹åŒ–çš„ä¼´ç”Ÿç±»ï¼ˆnoninstantiable companion classï¼Œè¯¦è§ç¬¬ 4 æ¡ï¼‰ã€‚ä¾‹å¦‚ï¼ŒJava é›†åˆæ¡†æ¶çš„æ¥å£æœ‰ 45 ä¸ªå·¥å…·å®ç°ï¼Œæä¾›äº†ä¸å¯å˜é›†åˆã€åŒæ­¥é›†åˆç­‰ã€‚å‡ ä¹æ‰€æœ‰è¿™äº›å®ç°éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªä¸å¯å®ä¾‹åŒ–çš„ç±»ï¼ˆjava.util.Collectionsï¼‰ä¸­çš„é™æ€å·¥å‚æ–¹æ³•å¯¼å‡ºçš„ï¼Œè¿™äº›è¿”å›å¯¹è±¡çš„ç±»éƒ½æ˜¯é publicã€‚

å¦‚æœå®ƒå¯¼å‡ºäº† 45 ä¸ªç‹¬ç«‹çš„å…¬æœ‰ç±»ï¼Œé‚£ä¹ˆé›†åˆæ¡†æ¶çš„ API å°±ä¼šå¾ˆåºå¤§è®¸å¤šã€‚å‡å°‘çš„ä¸ä»…ä»…æ˜¯ API çš„ä½“ç§¯ï¼Œè¿˜æœ‰æ¦‚å¿µä¸Šçš„é‡é‡ï¼šç¨‹åºå‘˜ä¸ºäº†ä½¿ç”¨ API è€Œå¿…é¡»æŒæ¡çš„æ¦‚å¿µçš„æ•°é‡å’Œéš¾åº¦ã€‚ç¨‹åºå‘˜çŸ¥é“è¿”å›çš„å¯¹è±¡å…·æœ‰å…¶æ¥å£æ‰€æŒ‡å®šçš„ APIï¼Œæ‰€ä»¥æ²¡æœ‰å¿…è¦ä¸ºå®ç°ç±»é˜…è¯»é¢å¤–çš„ç±»æ–‡æ¡£ã€‚æ­¤å¤–ï¼Œä½¿ç”¨è¿™æ ·çš„é™æ€å·¥å‚æ–¹æ³•éœ€è¦å®¢æˆ·é€šè¿‡æ¥å£è€Œä¸æ˜¯å®ç°ç±»æ¥å¼•ç”¨è¿”å›çš„å¯¹è±¡ï¼Œè¿™é€šå¸¸æ˜¯å¾ˆå¥½çš„åšæ³•ï¼ˆè¯¦è§ç¬¬ 64 æ¡ï¼‰ã€‚

Java 8 ä¹‹åï¼Œæ¥å£ä¸èƒ½æœ‰é™æ€æ–¹æ³•çš„é™åˆ¶å–æ¶ˆäº†ï¼Œæ‰€ä»¥æ²¡å¿…è¦å†å»ä¸ºä¸€ä¸ªæ¥å£æä¾›ä¸Šé¢è¿™ç§ä¸å¯å®ä¾‹åŒ–çš„ä¼´ç”Ÿç±»äº†ï¼Œå¯ä»¥å°†è¿™äº› public static æˆå‘˜æ”¾åˆ°å®ƒä»¬çš„æ¥å£ä¸­ã€‚æ³¨æ„ï¼Œä»ç„¶æœ‰å¿…è¦å°†è¿™äº›é™æ€å·¥å‚æ–¹æ³•èƒŒåçš„å¤§éƒ¨åˆ†å®ç°ä»£ç æ”¾åˆ°ä¸€ä¸ªå•ç‹¬çš„ package-private ç±»ä¸­ã€‚è¿™æ˜¯å› ä¸º Java 8 è¦æ±‚æ¥å£ä¸­æ‰€æœ‰ static æˆå‘˜éƒ½æ˜¯ public çš„ã€‚Java 9 å…è®¸äº† private static æ–¹æ³•ï¼Œä½†æ˜¯ static åŸŸå’Œ static æˆå‘˜ç±»ä»ç„¶è¢«è¦æ±‚æ˜¯ public çš„ã€‚

#### è¿”å›å¯¹è±¡çš„ç±»å¯ä»¥æ ¹æ®å‚æ•°çš„ä¸åŒè€Œæ”¹å˜

è¿”å›å£°æ˜ä¸­çš„è¿”å›ç±»å‹çš„ä»»æ„å­ç±»å‹éƒ½æ˜¯å¯ä»¥çš„ï¼Œè¿”å›å¯¹è±¡çš„ç±»å‹ä¹Ÿå¯ä»¥éšç€ç‰ˆæœ¬è€Œå˜åŒ–ã€‚

`EnumSet` ç±»ï¼ˆè¯¦è§ç¬¬ 36 æ¡ï¼‰æ²¡æœ‰ public æ„é€ å™¨ï¼Œåªæœ‰é™æ€å·¥å‚æ–¹æ³•ã€‚åœ¨ OpenJDK çš„å®ç°ä¸­ï¼Œå®ƒè¿”å›ä¸¤ä¸ªå­ç±»ä¸­çš„ä¸€ä¸ªå®ä¾‹ï¼Œå–å†³äºåº•å±‚æšä¸¾ç±»å‹çš„å¤§å°ï¼šå¦‚æœå°äºç­‰äº 64ï¼Œåˆ™è¿”å› `RegularEnumSet` å®ä¾‹ï¼Œå®ƒä½¿ç”¨ä¸€ä¸ª long åŸŸæ¥å®ç°åŠŸèƒ½ï¼›å¦‚æœå¤§äº 64ï¼Œåˆ™è¿”å› `JumboEnumSet` å®ä¾‹ï¼Œå®ƒä½¿ç”¨ä¸€ä¸ª long æ•°ç»„æ¥å®ç°åŠŸèƒ½ã€‚

è¿™ä¸¤ä¸ªå®ç°ç±»å¯¹å®¢æˆ·ç«¯éƒ½æ˜¯ä¸å¯è§çš„ï¼Œå¦‚æœä¸€ä¸ªç±»å‡ºç°äº†é—®é¢˜ï¼Œå¯ä»¥åœ¨ä¹‹åçš„ç‰ˆæœ¬ä¸­ä¿®å¤ï¼Œå¹¶ä¸”ä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ã€‚åŒæ ·çš„ï¼Œæœªæ¥ç‰ˆæœ¬ä¸­ä¹Ÿå¯èƒ½ä¼šæ·»åŠ æ›´å¤šå¯¹æ€§èƒ½æœ‰ç›Šçš„å®ç°ã€‚å®¢æˆ·ç«¯æ—¢ä¸çŸ¥é“ä¹Ÿä¸å…³å¿ƒé™æ€å·¥å‚æ–¹æ³•è¿”å›å¯¹è±¡çš„ç±»ï¼Œå®ƒä»¬åªè¦çŸ¥é“è¿™æ˜¯ EnumSet çš„æŸä¸ªå­ç±»å°±è¶³å¤Ÿäº†ã€‚

#### è¿”å›å¯¹è±¡çš„ç±»åœ¨ç¼–å†™é™æ€å·¥å‚æ–¹æ³•çš„æ—¶å€™å¯ä»¥ä¸å­˜åœ¨

é™æ€å·¥å‚æ–¹æ³•è¿™ç§çµæ´»çš„ç‰¹æ€§æ„æˆäº†æœåŠ¡æä¾›è€…æ¡†æ¶ï¼ˆservice provider framworkï¼‰çš„åŸºç¡€ï¼Œä¾‹å¦‚ Java Database Connectivity APIï¼ˆJDBCï¼‰ã€‚ä¸€ä¸ªæœåŠ¡æä¾›è€…æ¡†æ¶æ˜¯ä¸€ä¸ªå¤šä¸ªæœåŠ¡æä¾›è€…å®ç°ä¸€ä¸ªæœåŠ¡çš„ç³»ç»Ÿï¼Œç³»ç»Ÿä¸ºå®¢æˆ·ç«¯æä¾›å¤šä¸ªå®ç°ï¼ŒæŠŠå®¢æˆ·ç«¯ä»å¤šä¸ªå®ç°ä¸­è§£è€¦å‡ºæ¥ã€‚

æœåŠ¡æä¾›è€…æ¡†æ¶ä¸­æœ‰ä¸‰ä¸ªåŸºæœ¬ç»„ä»¶ï¼š

-   ä¸€ä¸ªæœåŠ¡æ¥å£ï¼ˆservice interfaceï¼‰ï¼Œä»£è¡¨äº†ä¸€ä¸ªå®ç°ï¼›
    
-   ä¸€ä¸ªæä¾›è€…æ³¨å†Œï¼ˆprovice registrationï¼‰APIï¼ŒæœåŠ¡æä¾›è€…ä½¿ç”¨å®ƒæ¥æ³¨å†Œå®ç°ï¼›
    
-   ä¸€ä¸ªæœåŠ¡è®¿é—®ï¼ˆservice accessï¼‰APIï¼Œå®¢æˆ·ç«¯ä½¿ç”¨å®ƒæ¥è·å¾—æœåŠ¡çš„å®ä¾‹ã€‚æœåŠ¡è®¿é—® API å¯ä»¥è®©å®¢æˆ·ç«¯åœ¨é€‰æ‹©å®ç°çš„æ—¶å€™æŒ‡å®šæ¡ä»¶ã€‚å¦‚æœæ²¡æœ‰æ¡ä»¶ï¼Œé‚£ä¹ˆ API å°±è¿”å›é»˜è®¤å®ç°çš„ä¸€ä¸ªå®ä¾‹ï¼Œæˆ–è€…è®©å®¢æˆ·ç«¯å¾ªç¯éå†æ‰€æœ‰å¯ç”¨çš„å®ç°ã€‚æœåŠ¡è®¿é—® API æ­£æ˜¯æ„æˆæœåŠ¡æä¾›è€…æ¡†æ¶åŸºç¡€çš„çµæ´»é™æ€å·¥å‚æ–¹æ³•ã€‚
    

å¯é€‰çš„ç¬¬å››ä¸ªç»„ä»¶æ˜¯æœåŠ¡æä¾›è€…æ¥å£ï¼Œå®ƒæè¿°äº†äº§ç”ŸæœåŠ¡æ¥å£å®ä¾‹çš„å·¥å‚å¯¹è±¡ï¼ˆTODOï¼šå¯ä»¥åˆ›å»ºæœåŠ¡æ¥å£å®ç°çš„å·¥å‚å¯¹è±¡æ¥å£ï¼Ÿï¼‰ã€‚å¦‚æœæ²¡æœ‰å®ƒï¼Œå®ç°å°±å¿…é¡»é€šè¿‡åå°„æ¥è¿›è¡Œå®ä¾‹åŒ–ï¼ˆè¯¦è§ç¬¬ 65 æ¡ï¼‰ã€‚å¯¹ JDBC æ¥è¯´ï¼Œ`Connection` å°±æ˜¯å…¶æœåŠ¡æ¥å£çš„ä¸€éƒ¨åˆ†ï¼Œ`DriverManager.registerDrive` å¯¹åº”æä¾›è€…æ³¨å†Œ APIï¼Œ`DriverManager.getConnection` å¯¹åº”æœåŠ¡è®¿é—® APIï¼Œ`Driver` å¯¹åº”æœåŠ¡æä¾›è€…æ¥å£ï¼ˆæ‰€æœ‰æ•°æ®åº“çš„é©±åŠ¨éƒ½è¦å®ç°è¿™ä¸ªç±»ï¼Œå®ƒæœ‰ä¸ª `connect` æ–¹æ³•è¿”å› `Connection`ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡å®ç°ï¼‰ã€‚

æœåŠ¡æä¾›è€…æ¡†æ¶æ¨¡å¼æœ‰å¾ˆå¤šå˜ä½“ï¼Œä¾‹å¦‚ï¼ŒæœåŠ¡è®¿é—® API å¯ç”¨è¿”å›å¦ä¸€ä¸ªæ¥å£ï¼Œè¿™ä¸ªæ¥å£æ¯”æä¾›è€…çš„æä¾›çš„æ¥å£åŠŸèƒ½æ›´å¤šã€‚è¿™å°±æ˜¯æ¡¥æ¥æ¨¡å¼ã€‚ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼ˆè¯¦è§ç¬¬ 5 æ¡ï¼‰æ˜¯ä¸€ä¸ªååˆ†å¼ºå¤§çš„æœåŠ¡æä¾›è€…ã€‚Java 6 ä¹‹åï¼Œå¹³å°æä¾›äº†é€šç”¨çš„æœåŠ¡æä¾›è€…æ¡†æ¶ï¼ˆjava.util.ServiceLoadedï¼‰ï¼Œæ‰€ä»¥å°±ä¸éœ€è¦ï¼Œä¹Ÿä¸åº”è¯¥ç¼–å†™æ–°çš„ï¼ˆè¯¦è§ç¬¬ 58 æ¡ï¼‰ã€‚JDBC ä¸ä½¿ç”¨ `ServiceLoader`ï¼Œå› ä¸ºå®ƒå‡ºç°çš„æ›´æ—©ã€‚

> TODOï¼šç¬¬ä¸€å¥è¯çš„åŸæ–‡å¦‚ä¸‹ï¼Œä¸æ˜¯å¾ˆæ˜ç™½ï¼Œè€Œä¸”ä¸ºä»€ä¹ˆè¿™ä¸ªåƒæ¡¥æ¥æ¨¡å¼ã€‚
> 
> There are many variants of the service provider framework pattern. For example, the service access API can return a richer service interface to clients than the one furnished by providers.

### ç¼ºç‚¹

#### æ²¡æœ‰ public æˆ– protected æ„é€ æ–¹æ³•çš„ç±»ä¸èƒ½è¢«ç»§æ‰¿

è¿™æ˜¯é™æ€å·¥å‚æ–¹æ³•æœ€å¤§çš„é™åˆ¶ã€‚æ¯”å¦‚ï¼Œä¸å¯èƒ½ç»§æ‰¿é›†åˆæ¡†æ¶æä¾›çš„ä»»ä½•ä¸€ä¸ªæ–¹ä¾¿çš„å®ç°ï¼ˆä¹Ÿå°±æ˜¯æŒ‡ `Collections.syncronizedMap` ç­‰ï¼‰ã€‚ä½†è¿™æ ·ä¹Ÿæœ‰å®ƒçš„å¥½å¤„ï¼Œå› ä¸ºå®ƒé¼“åŠ±ç¨‹åºå‘˜ä½¿ç”¨ç»„åˆä»£æ›¿ç»§æ‰¿ï¼ˆè¯¦è§ç¬¬ 18 æ¡ï¼‰ï¼Œå¹¶ä¸”å®ƒé€‚åˆè¢«ä¸å¯å˜ç±»å‹ä½¿ç”¨ã€‚

#### å®ƒä»¬å¾ˆéš¾è¢«ç¨‹åºå‘˜å‘ç°

å®ƒä»¬ä¸åƒæ„é€ æ–¹æ³•é‚£æ ·åœ¨ API æ˜ç¡®æ ‡è¯†å‡ºæ¥ï¼Œæ‰€ä»¥å¾ˆéš¾å¼„æ˜ç™½æ€æ ·å»å®ä¾‹åŒ–ä¸€ä¸ªä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•ä»£æ›¿æ„é€ å™¨çš„ç±»ã€‚Javadoc å¯èƒ½åœ¨æœªæ¥å…³æ³¨é™æ€å·¥å‚æ–¹æ³•ï¼Œä½†åœ¨é‚£ä¹‹å‰ï¼Œé€šè¿‡åœ¨ç±»æˆ–è€…æ¥å£æ–‡æ¡£ä¸­æŒ‡å‡ºé™æ€å·¥å‚æ–¹æ³•ï¼Œå¹¶éµå®ˆæ ‡å‡†çš„å‘½åä¹ æƒ¯ï¼Œä¹Ÿå¯ä»¥å¼¥è¡¥è¿™ä¸€åŠ£åŠ¿ã€‚ä¸‹é¢æ˜¯é™æ€å·¥å‚æ–¹æ³•çš„ä¸€äº›æƒ¯ç”¨åç§°ï¼Œåˆ—å‡ºäº†å…¶ä¸­çš„ä¸€å°éƒ¨åˆ†ï¼š

-   fromï¼šç±»å‹è½¬æ¢æ–¹æ³•ï¼Œå®ƒåªæœ‰å•ä¸ªå‚æ•°ï¼Œè¿”å›ç±»å‹å¯¹åº”çš„å®ä¾‹ï¼Œä¾‹å¦‚ï¼š
    
    Date d = Date.from(instant);
    
-   ofï¼šèšåˆæ–¹æ³•ï¼Œæ¥å—å¤šä¸ªå‚æ•°ï¼Œè¿”å›åŒ…æ‹¬è¿™äº›å‚æ•°çš„ç±»å‹çš„å®ä¾‹ï¼Œä¾‹å¦‚ï¼š
    
    Set<Rank> faceCards = EnumSet.of(JACK, QUEEN, KING;
    
-   valueOfï¼šæ¯” from å’Œ of æ›´ç²—ç•¥çš„æ›¿ä»£æ–¹æ¡ˆï¼Œä¾‹å¦‚ï¼š
    
     BigInteger prime = BigInteger.valueOf(Integer.MAX_VALUE);
    
-   instance æˆ– getInstanceï¼šè¿”å›ä¸€ä¸ªç”±å…¶å‚æ•°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰æè¿°çš„å®ä¾‹ï¼Œä½†ä¸èƒ½è¯´å®ƒä»¬æœ‰ç›¸åŒçš„å€¼ï¼Œä¾‹å¦‚ï¼š
    
    Â  StackWalker luke = StackWalker.getInstance(options);
    
-   create æˆ– newInstanceï¼šç±»ä¼¼ instance æˆ– getInstanceï¼Œé™¤äº†è¿™ä¸ªæ–¹æ³•ç¡®ä¿æ¯æ¬¡éƒ½è¦éƒ½è¿”å›ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œä¾‹å¦‚ï¼š
    
    Â Object newArray = Array.newInstance(classObject, arrayLen);
    
-   getTypeï¼šç±»ä¼¼ getInstanceï¼Œä½†æ˜¯å®ƒåœ¨é™æ€å·¥å‚æ–¹æ³•å¤„äºä¸€ä¸ªä¸åŒçš„ç±»ä¸­æ—¶ä½¿ç”¨ï¼ŒType æ˜¯è¿”å›å¯¹è±¡çš„ç±»å‹ï¼Œä¾‹å¦‚ï¼š
    
    Â FileStore fs = Files.getFileStore(path);
    
-   newTypeï¼šç±»ä¼¼ newInstanceï¼Œä½†æ˜¯å®ƒåœ¨é™æ€å·¥å‚æ–¹æ³•å¤„äºä¸€ä¸ªä¸åŒçš„ç±»ä¸­æ—¶ä½¿ç”¨ï¼ŒType æ˜¯è¿”å›å¯¹è±¡çš„ç±»å‹ï¼Œä¾‹å¦‚ï¼š
    
    Â BufferedReader br = Files.newBufferedReader(path);
    
-   typeï¼šgetType å newType çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œä¾‹å¦‚ï¼š
    
    Â List<Complaint> litany = Collections.list(legacyLitany);
    

### æ€»ç»“

æ€»è€Œè¨€ä¹‹ï¼Œé™æ€å·¥å‚æ–¹æ³•å’Œ public æ„é€ å™¨éƒ½æœ‰å®ƒä»¬çš„ç”¨å¤„ï¼Œéœ€è¦ç†è§£å®ƒä»¬å„è‡ªçš„é•¿å¤„ã€‚é€šå¸¸æƒ…å†µä¸‹é™æ€å·¥å‚æ–¹æ³•è¦æ›´ä¼˜å…ˆï¼Œæ‰€ä»¥ç¬¬ä¸€ååº”æ˜¯è€ƒè™‘é™æ€å·¥å‚æ–¹æ³•ã€‚

## 2. å½“æ„é€ å™¨æœ‰å¾ˆå¤šå‚æ•°çš„æ—¶å€™è€ƒè™‘ä½¿ç”¨ builder

é™æ€å·¥å‚æ–¹æ³•å’Œæ„é€ å™¨éƒ½æœ‰ä¸€ä¸ªä¸è¶³ï¼šå®ƒä»¬åœ¨é¢å¯¹å¤§é‡å¯é€‰å‚æ•°çš„æ—¶å€™ä¸èƒ½å¾ˆå¥½åœ°æ‹“å±•ã€‚

### ä¼¸ç¼©æ„é€ å™¨

å¯¹äºä¸‹é¢è¿™ä¸ªç±»ï¼Œä¼ ç»Ÿä¸Šå¾ˆå¤šäººä¼šé€‰æ‹©ä½¿ç”¨ä¼¸ç¼©æ„é€ å™¨ï¼ˆtelescoping contructorï¼‰æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æä¾›ä¸€ä¸ªåªéœ€è¦å¿…éœ€çš„å‚æ•°çš„æ„é€ å™¨ï¼Œä¸€ä¸ªåªéœ€è¦ä¸€ä¸ªå¯é€‰å‚æ•°çš„æ„é€ å™¨ï¼Œä¸€ä¸ªéœ€è¦ä¸¤ä¸ªå¯é€‰å‚æ•°çš„æ„é€ å™¨ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°æœ€åéœ€è¦æ‰€æœ‰å¯é€‰å‚æ•°çš„æ„é€ å™¨ï¼š

// Telescoping constructor pattern - does not scale well!  
public class NutritionFacts {  
    private final int servingSize;  // (mL)            required  
    private final int servings;		// (per container) required  
    private final int calories;		// (per serving)   optional  
    private final int fat;			// (g/serving)	   optional  
    private final int sodium;		// (mg/serving)    optional  
    private final int carbohydrate; // (g/serving)     optional  
  
    public NutritionFacts(int servingSize, int servings) {  
        this(servingSize, servings, 0);  
    }  
  
    public NutritionFacts(int servingSize, int servings,   
                          int calories) {  
        this(servingSize, servings, calories, 0);  
    }  
  
    public NutritionFacts(int servingSize, int servings,  
                          int calories, int fat) {  
        this(servingSize, servings, calories, fat, 0);  
    }  
  
    public NutritionFacts(int servingSize, int servings,  
                          int calories, int fat, int sodium) {  
        this(servingSize, servings, calories, fat, sodium, 0);  
    }  
  
    public NutritionFacts(int servingSize, int servings,  
                         int calories, int fat, int sodium, int carbohydrate) {  
        this.servingSize  = servingSize;  
        this.servings= servings;  
        this.calories=calories;  
        this.fat=fat;  
        this.sodium=sodium;  
        this.carbohydrate = carbohydrate;  
    }  
}

å½“è¦åˆ›å»ºå®ä¾‹çš„æ—¶å€™ï¼Œä½¿ç”¨åŒ…å«æ‰€æœ‰æ‰€éœ€å‚æ•°ä¸”å‚æ•°åˆ—è¡¨æœ€çŸ­çš„æ„é€ å™¨ã€‚é€šå¸¸æ¥è¯´ï¼Œè¿™ç§æ–¹æ³•ä¼šè¦æ±‚è®¾ç½®å¾ˆå¤šä¸æƒ³è®¾ç½®çš„å‚æ•°ï¼Œä½†å¿…é¡»è¦ä¸ºå®ƒä»¬ä¼ ä¸€ä¸ªå€¼ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­å°±æ˜¯ä¸º `fat` è¿™ä¸ªå‚æ•°ä¼ é€’äº† 0ï¼š

NutritionFacts cocaCola = new NutritionFacts(240, 8, 100, 0, 35, 27);

ç®€å•æ¥è¯´ï¼Œä¼¸ç¼©æ„é€ å™¨æ¨¡å¼å¯ä»¥å·¥ä½œï¼Œä½†å®¢æˆ·ç«¯çš„ä»£ç å¾ˆéš¾ç¼–å†™ï¼Œä¸”å¾ˆéš¾é˜…è¯»ã€‚è¯»è€…è¦æƒ³çŸ¥é“è¿™äº›å‚æ•°çš„æ„ä¹‰ï¼Œå¿…é¡»è¦æ•°å‚æ•°ä½ç½®æ‰èƒ½çŸ¥é“ã€‚è€Œä¸”ï¼Œç›¸åŒç±»å‹å‚æ•°çš„é•¿åºåˆ—å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œå¦‚æœå®¢æˆ·ç«¯ä¸å°å¿ƒé¢ å€’äº†ä¸¤ä¸ªå‚æ•°çš„ä½ç½®ï¼Œç¼–è¯‘å™¨å¹¶ä¸ä¼šå‘ç°.

### JavaBeans æ¨¡å¼

è¿™æ˜¯ä¸€ç§é€šè¿‡ä½¿ç”¨æ— å‚æ„é€ å™¨æ¥åˆ›å»ºå¯¹è±¡ï¼Œç„¶åé€šè¿‡è°ƒç”¨ setter æ¥è®¾ç½®æ¯ä¸ªå¿…éœ€çš„å’Œéœ€è¦çš„å¯é€‰å‚æ•°ã€‚

// JavaBeans Pattern - allows inconsistency, mandates mutabilit  
public class NutritionFacts {  
    // Parameters initialized to default values (if any)  
    private int servingSize = -1;  // Required; no default value  
    private int servings = -1;     // Required; no default value  
    private int calories = 0;  
    private int fat = 0;  
    private int sodium = 0;  
    private int carbohydrate = 0;  
  
	// Setters  
    public void setServingSize(int val)  { servingSize = val; }  
    public void setServings(int val) { servings = val; }  
    public void setCalories(int val) { calories = val; }  
    public void setFat(int val) {fat=val;}  
    public void setSodium(int val) { sodium = val; }  
    public void setCarbohydrate(int val) { carbohydrate = val; }  
}

è¿™ç§æ¨¡å¼æ²¡æœ‰ä¼¸ç¼©æ„é€ å™¨æ¨¡å¼çš„ä»»ä½•ç¼ºç‚¹ã€‚åˆ›å»ºå®ä¾‹å¾ˆç®€å•ï¼Œä¹Ÿå¾ˆå®¹æ˜“é˜…è¯»ï¼Œå°±æ˜¯æœ‰ç‚¹å•°å—¦ï¼š

NutritionFacts cocaCola = new NutritionFacts();  
cocaCola.setServingSize(240);  
cocaCola.setServings(8);  
cocaCola.setCalories(100);  
cocaCola.setSodium(35);  
cocaCola.setCarbohydrate(27);

ä½†æ˜¯ï¼ŒJavaBeans æ¨¡å¼æœ‰éå¸¸ä¸¥é‡çš„ç¼ºç‚¹ã€‚å› ä¸ºå®ƒå®ä¾‹çš„æ„é€ è¢«åˆ’åˆ†æˆäº†è®¸å¤šä¸ªæ–¹æ³•è°ƒç”¨ï¼Œä¸€ä¸ª JavaBean å¯èƒ½åœ¨æ„é€ è¿‡ç¨‹ä¸­å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ã€‚ç±»æ— æ³•ä»…ä»…é€šè¿‡æ£€æŸ¥æ„é€ å‡½æ•°å‚æ•°çš„æœ‰æ•ˆæ€§æ¥å¼ºåˆ¶å®ç°ä¸€è‡´æ€§ï¼ˆå› ä¸ºåªæœ‰æ— å‚æ„é€ å™¨ï¼Ÿï¼‰ã€‚å½“ä¸€ä¸ªå¯¹è±¡å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€æ—¶ï¼Œè¯•å›¾ä½¿ç”¨å®ƒå¯èƒ½ä¼šå¯¼è‡´æ•…éšœï¼Œè€Œè¿™ç§æ•…éšœéš¾ä»¥è°ƒè¯•ã€‚è¿˜æœ‰ä¸€ä¸ªç›¸å…³çš„ç¼ºç‚¹æ˜¯ï¼ŒJavaBeans æ¨¡å¼æ’é™¤äº†ä½¿ä¸€ä¸ªç±»æˆä¸ºä¸å¯å˜çš„å¯èƒ½æ€§ï¼ˆè¯¦è§ç¬¬ 17 æ¡ï¼‰ï¼Œè¿™å°±è¦æ±‚ç¨‹åºå‘˜çš„ä»˜å‡ºåŠªåŠ›æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

> æ„é€ æ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

### Builder æ¨¡å¼

#### é€šå¸¸ç”¨æ³•

è¿™ç§æ¨¡å¼ä¸ä»…æä¾›äº†ä¼¸ç¼©æ„é€ å™¨æ¨¡å¼çš„å®‰å…¨æ€§ï¼Œä¹Ÿæä¾›äº† JavaBeans æ¨¡å¼çš„å¯è¯»æ€§ã€‚å®¢æˆ·ç«¯å¹¶ä¸ç›´æ¥åˆ›å»ºå¯¹è±¡ï¼Œè€Œæ˜¯è°ƒç”¨ä¸€ä¸ªæ„é€ å™¨ï¼ˆæˆ–é™æ€å·¥å‚æ–¹æ³•ï¼‰æ¥åˆ›å»ºä¸€ä¸ª builder å¯¹è±¡ï¼Œè¿™ä¸ªæ„é€ å™¨åŒ…å«äº†æ‰€æœ‰å¿…éœ€çš„å‚æ•°ã€‚ç„¶åå®¢æˆ·ç«¯åœ¨ builder å¯¹è±¡ä¸Šè°ƒç”¨ç±»ä¼¼ setter çš„æ–¹æ³•æ¥è®¾ç½®æ¯ä¸ªéœ€è¦çš„å¯é€‰å‚æ•°ã€‚æœ€å¥½ï¼Œå®¢æˆ·ç«¯è°ƒç”¨ä¸€ä¸ªæ— å‚ build æ–¹æ³•æ¥ç”Ÿäº§è¿™ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”è¿™ä¸ªå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼ˆã€‚builder ä¸€èˆ¬éƒ½æ˜¯å®ƒæ‰€åˆ›å»ºçš„ç±»ä¸­çš„ä¸€ä¸ªé™æ€æˆå‘˜ç±»ï¼ˆè¯¦è§ç¬¬ 24 æ¡ï¼‰ï¼š

// Builder Pattern  
public class NutritionFacts {  
   private final int servingSize;  
    private final int servings;  
    private final int calories;  
    private final int fat;  
    private final int sodium;  
    private final int carbohydrate;  
      
    public static class Builder {  
        // Required parameters  
        private final int servingSize;  
        private final int servings;  
        // Optional parameters - initialized to default values  
        private int calories      = 0;  
        private int fat			  = 0;  
        private int sodium        = 0;  
        private int carbohydrate  = 0;  
        public Builder(int servingSize, int servings) {  
            this.servingSize = servingSize;  
            this.servings    = servings;  
        }  
          
        public Builder calories(int val)  
            { calories = val;      return this; }  
        public Builder fat(int val)  
            { fat = val;           return this; }  
        public Builder sodium(int val)  
            { sodium = val;        return this; }  
        public Builder carbohydrate(int val)  
            { carbohydrate = val;  return this; }  
          
        public NutritionFacts build() {  
            return new NutritionFacts(this);  
        }   
    }  
      
    private NutritionFacts(Builder builder) {  
        servingSize  = builder.servingSize;  
      	servings 	 = builder.servings;  
      	calories     = builder.calories;  
        fat 		 = builder.fat;  
      	sodium 		 = builder.sodium;  
      	carbohydrate = builder.carbohydrate;  
    }   
}

`NutritionFacts` ç±»æ˜¯ä¸å¯å˜çš„ï¼Œå¹¶ä¸”æ‰€æœ‰å‚æ•°çš„é»˜è®¤å€¼éƒ½åœ¨åŒä¸€ä¸ªåœ°æ–¹ï¼ˆTODOï¼šåŒä¸€ä¸ªåœ°æ–¹æ˜¯å•¥æ„æ€ï¼‰builder çš„ setter æ–¹æ³•è¿”å› builder è‡ªèº«ï¼Œæ‰€ä»¥å¤šä¸ªè°ƒç”¨å¯ä»¥è¢«é“¾æ¥èµ·æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªæµå¼ï¼ˆfluentï¼‰APIï¼š

NutritionFacts cocaCola = new NutritionFacts.Builder(240, 8)  
           .calories(100).sodium(35).carbohydrate(27).build();

è¦å°½å¿«æ£€æµ‹å‡ºéæ³•å‚æ•°ï¼Œå¯ä»¥åœ¨ builder çš„æ„é€ å™¨å’Œæ–¹æ³•ä¸­æ£€æµ‹å‚æ•°çš„åˆæ³•æ€§ã€‚æ£€æŸ¥ç”± `build` æ–¹æ³•è°ƒç”¨çš„æ„é€ æ–¹æ³•ä¸­æ¶‰åŠå¤šä¸ªå‚æ•°çš„çº¦æŸï¼ˆinvariantsï¼‰ã€‚ä¸ºäº†ç¡®ä¿è¿™äº›çº¦æŸä¸å—æ”»å‡»ï¼Œåœ¨ä» builder å¤åˆ¶å‚æ•°åæ£€æŸ¥å¯¹è±¡çš„åŸŸï¼ˆè¯¦è§ç¬¬ 50 æ¡ï¼‰ã€‚å¦‚æœæ£€æŸ¥å¤±è´¥ï¼ŒæŠ›å‡º `IllegalArgumentExcetpion`ï¼Œå¹¶åœ¨è¯¦ç»†ä¿¡æ¯ä¸­æŒ‡å‡ºå“ªäº›å‚æ•°éæ³•ã€‚

#### ç”¨äºç±»å±‚æ¬¡ç»“æ„ä¸­

Builder æ¨¡å¼ä¹Ÿé€‚ç”¨äºç±»å±‚æ¬¡ç»“æ„ã€‚ æŠ½è±¡ç±»æœ‰æŠ½è±¡ builderï¼Œå…·ä½“ç±»æœ‰å…·ä½“ builderã€‚ä¾‹å¦‚ï¼š

// Builder pattern for class hierarchies  
public abstract class Pizza {  
    public enum Topping { HAM, MUSHROOM, ONION, PEPPER, SAUSAGE }   
  	final Set<Topping> toppings;  
    
    abstract static class Builder<T extends Builder<T>> {   
      	EnumSet<Topping> toppings = EnumSet.noneOf(Topping.class);   
      	public T addTopping(Topping topping) {  
            toppings.add(Objects.requireNonNull(topping));  
            return self();  
        }  
  
        abstract Pizza build();  
          
        // Subclasses must override this method to return "this"  
        protected abstract T self();  
    }  
    
    Pizza(Builder<?> builder) {  
    	toppings = builder.toppings.clone(); // See Item 50  
    }  
}

æ³¨æ„ `Pizza.Builder` æ˜¯æœ‰ä¸€ä¸ªé€’å½’ç±»å‹å‚æ•°çš„æ³›å‹ï¼ˆè¯¦è§ç¬¬ 30 æ¡ï¼‰ã€‚é€šè¿‡æŠ½è±¡ `self` æ–¹æ³•ï¼Œå…è®¸æ–¹æ³•é“¾åœ¨å­ç±»ä¸­æ­£å¸¸å·¥ä½œï¼Œè€Œä¸éœ€è¦è¿›è¡Œè½¬å‹ã€‚è¿™ç§é’ˆå¯¹ Java ç¼ºä¹ self ç±»å‹çš„å˜é€šæ–¹æ³•è¢«ç§°ä¸ºæ¨¡æ‹Ÿ slef ç±»å‹ï¼ˆsimulated self-typeï¼‰çš„ä¹ æƒ¯åšæ³•ã€‚

 public class NyPizza extends Pizza {  
     public enum Size { SMALL, MEDIUM, LARGE }  
     private final Size size;  
  
     // æ³›å‹æ˜¯ NyPizza.Builderï¼Œä¸ºäº†åœ¨çˆ¶ç±» addToping() å’Œ self() æ–¹æ³•ä¸­è¿”å›æ­¤ç±»å®ä¾‹  
     public static class Builder extends Pizza.Builder<Builder> {   
         private final Size size;  
           
         public Builder(Size size) {  
             this.size = Objects.requireNonNull(size);  
         }  
  
         @Override   
         public NyPizza build() {  
             return new NyPizza(this);  
         }  
  
         @Override   
         protected Builder self() { return this; }  
     }  
     
     private NyPizza(Builder builder) {  
         super(builder);  
         size = builder.size;  
   	}  
}  
  
public class Calzone extends Pizza {  
    private final boolean sauceInside;  
  
    public static class Builder extends Pizza.Builder<Builder> {   
        private boolean sauceInside = false; // Default  
          
        public Builder sauceInside() {  
            sauceInside = true;  
            return this;  
        }  
          
        @Override   
        public Calzone build() {  
            return new Calzone(this);  
        }  
          
        @Override   
        protected Builder self() { return this; }  
    }  
      
    private Calzone(Builder builder) {  
        super(builder);  
        sauceInside = builder.sauceInside;  
    }  
}

æ³¨æ„åˆ°æ¯ä¸ªå­ç±»ä¸­ builder çš„ `build` æ–¹æ³•è¿”å›çš„æ˜¯æ­£ç¡®çš„å­ç±»ã€‚è¿™ç§æŠ€æœ¯ï¼Œå³å­ç±»æ–¹æ³•è¢«å£°æ˜ä¸ºè¿”å›ã€Œè¶…ç±»ä¸­å£°æ˜çš„è¿”å›ç±»å‹ã€çš„å­ç±»å‹ï¼Œè¢«ç§°ä¸ºåå˜è¿”å›ç±»å‹ï¼ˆcovariant return typingï¼‰ã€‚å®ƒå…è®¸å®¢æˆ·ä½¿ç”¨è¿™äº› builder è€Œä¸éœ€è¦è½¬å‹ã€‚

å®¢æˆ·ç«¯ä»£ç ä¸ `NutritionFacts` builder çš„ä»£ç åŸºæœ¬ç›¸åŒï¼š

NyPizza pizza = new NyPizza.Builder(SMALL)  
     .addTopping(SAUSAGE).addTopping(ONION).build();  
Calzone calzone = new Calzone.Builder()  
    .addTopping(HAM).sauceInside().build();

#### Builder çš„å…¶ä»–ä¼˜ç‚¹

ä¸æ„é€ å™¨ç›¸æ¯”ï¼Œbuilder æ¨¡å¼è¿˜æœ‰ä¸€ä¸ªå°ä¼˜åŠ¿ã€‚builder å¯ä»¥æœ‰å¤šä¸ªå˜é•¿ï¼ˆvarargsï¼‰å‚æ•°ï¼Œå› ä¸ºæ¯ä¸ªå˜é•¿å‚æ•°éƒ½æœ‰è‡ªå·±çš„æ–¹æ³•ã€‚æ­¤å¤–ï¼Œbuilder å¯ä»¥å¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶æŠŠæ¯æ¬¡çš„å‚æ•°èšåˆè¿›ä¸€ä¸ªåŸŸï¼Œæ­£å¦‚ä¸Šé¢çš„ `addTopping` æ–¹æ³•ã€‚

Builder æ¨¡å¼å¾ˆçµæ´»ã€‚å•ä¸ª builder å¯ä»¥è¢«é‡å¤ä½¿ç”¨æ¥åˆ›å»ºå¤šä¸ªå¯¹è±¡ï¼šBuilder çš„å‚æ•°å¯ä»¥åœ¨å¤šæ¬¡ `build` æ–¹æ³•çš„è°ƒç”¨ä¹‹é—´è¿›è¡Œè°ƒæ•´ï¼Œä»¥æ”¹å˜æ‰€åˆ›å»ºçš„å¯¹è±¡ã€‚

Builder å¯ä»¥åœ¨åˆ›å»ºå¯¹è±¡æ—¶è‡ªåŠ¨å¡«å†™ä¸€äº›å­—æ®µï¼Œä¾‹å¦‚ï¼Œæ¯æ¬¡åˆ›å»ºå¯¹è±¡æ—¶éƒ½ä¼šå¢åŠ ä¸€ä¸ªåºåˆ—å·ã€‚

#### ç¼ºç‚¹

åœ¨åˆ›å»ºå¯¹è±¡ä¹‹å‰ï¼Œå¿…é¡»å…ˆåˆ›å»ºå®ƒçš„ builderã€‚è™½ç„¶åˆ›å»ºè¿™ä¸ª builder çš„æˆæœ¬åœ¨å®è·µä¸­ä¸å¤ªå¯èƒ½è¢«æ³¨æ„åˆ°ï¼Œä½†åœ¨å¯¹æ€§èƒ½è¦æ±‚å¾ˆé«˜çš„æƒ…å†µä¸‹ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚å¦å¤–ï¼Œbuilder æ¨¡å¼æ¯”ä¼¸ç¼©æ„é€ å™¨æ¨¡å¼æ›´å•°å—¦ï¼Œæ‰€ä»¥åªæœ‰åœ¨æœ‰è¶³å¤Ÿå¤šçš„å‚æ•°ä½¿å…¶å€¼å¾—ä½¿ç”¨æ—¶ï¼Œä¾‹å¦‚å››ä¸ªæˆ–æ›´å¤šï¼Œæ‰åº”è¯¥ä½¿ç”¨å®ƒã€‚ä½†ä¹Ÿè¦æ³¨æ„ï¼Œå¦‚æœæœªæ¥å‚æ•°ä¼šæ›´å¤šï¼Œä¸”ä¸€å¼€å§‹ä½¿ç”¨çš„æ˜¯æ„é€ å‡½æ•°æˆ–é™æ€å·¥å‚æ–¹æ³•ï¼Œå¦‚æœæ­¤æ—¶æ”¹ç”¨ builder æ¨¡å¼ï¼Œé‚£ä¹ˆæ„é€ å‡½æ•°æˆ–é™æ€å·¥å‚æ–¹æ³•ä¹Ÿæ˜¯ä¸èƒ½åˆ æ‰çš„ï¼Œå› æ­¤ä¸€å¼€å§‹å°±ä½¿ç”¨æ„å»ºå™¨å¾€å¾€æ›´å¥½ã€‚

### æ€»ç»“

æ€»è€Œè¨€ä¹‹ï¼Œbuilder æ¨¡å¼åœ¨æ„é€ å™¨æˆ–é™æ€å·¥å‚æ–¹æ³•çš„æœ‰å¾ˆå¤šå‚æ•°çš„æ—¶å€™æ˜¯ä¸ªå¥½çš„é€‰æ‹©ï¼Œå°¤å…¶æœ‰å¤§é‡å¯é€‰å‚æ•°æˆ–ç±»å‹ç›¸åŒçš„å‚æ•°æ—¶ã€‚å®¢æˆ·ç«¯ä»£ç ä¼šæ¯”ä¼¸ç¼©æ„é€ å™¨æ›´å®¹æ˜“ç¼–å†™å’Œé˜…è¯»ï¼Œä¹Ÿä¼šæ¯” JavaBeans æ›´å®‰å…¨ã€‚

## 3. ç”¨ç§æœ‰æ„é€ å™¨æˆ–æšä¸¾ç±»å‹å¼ºåŒ– Singleton å±æ€§

Singleton æ˜¯ä¸€ä¸ªåªä¼šå®ä¾‹åŒ–ä¸€æ¬¡çš„ç±»ï¼Œå®ƒé€šå¸¸ä»£è¡¨ä¸€ä¸ªæ— çŠ¶æ€çš„ç±»ï¼Œä¾‹å¦‚ä¸€ä¸ªå‡½æ•°ï¼ˆè¯¦è§ç¬¬ 24 æ¡ï¼‰æˆ–è€…ä¸€ä¸ªå”¯ä¸€çš„ç³»ç»Ÿç»„ä»¶ã€‚Singleton çš„ç±»ä¼šä½¿æµ‹è¯•å˜å›°éš¾ï¼Œå› ä¸ºä¸å¯èƒ½ Mock æ‰ Singletonï¼Œé™¤éå®ç°ä¸€ä¸ªå……å½“å…¶ç±»å‹çš„æ¥å£ï¼ˆTODOï¼šè·Ÿ singleton çš„ç±»å®ç°ç»Ÿä¸€çš„æ¥å£ï¼Ÿï¼‰ã€‚

### ä¸¤ç§å¸¸è§å®ç°æ–¹å¼

å®ç° singleton æœ‰ä¸¤ç§å¸¸è§çš„æ–¹å¼ï¼Œéƒ½æ˜¯é€šè¿‡ä¿æŒæ„é€ å™¨ç§æœ‰ï¼Œç„¶åå¯¼å‡ºä¸€ä¸ªå…¬æœ‰é™æ€æˆå‘˜æ¥æä¾›å¯¹å•ä¸€å®ä¾‹çš„è®¿é—®ã€‚

#### public final åŸŸ

// Singleton with public final field  
public class Elvis {  
    public static final Elvis INSTANCE = new Elvis();  
    private Elvis() { ... }  
      
    public void leaveTheBuilding() { ... }  
}

ç§æœ‰æ„é€ å™¨åªè°ƒç”¨äº†ä¸€æ¬¡ï¼Œç”¨æ¥åˆå§‹åŒ– public static åŸŸã€‚å› ä¸ºæ²¡æœ‰ public å’Œ protected æ„é€ å™¨ï¼Œæ‰€ä»¥ä¿è¯äº†å…¨å±€å”¯ä¸€æ€§ã€‚å®¢æˆ·ç«¯åªæœ‰ä¸€ç§æ–¹å¼å¯ä»¥æ”¹å˜è¿™ç§æƒ…å†µï¼šå€ŸåŠ© `AccessibleObject.setAccessible` æ–¹æ³•åå°„è°ƒç”¨ç§æœ‰æ„é€ å™¨ï¼ˆè¯¦è§ç¬¬ 65 æ¡ï¼‰ã€‚å¦‚æœæƒ³é˜²å¾¡è¿™ç§æ”»å‡»ï¼Œå¯ä»¥ä¿®æ”¹æ„é€ å™¨ï¼Œè®©å®ƒåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨æ—¶æŠ›å‡ºå¼‚å¸¸ã€‚

#### é™æ€å·¥å‚

// Singleton with static factory  
public class Elvis {  
    private static final Elvis INSTANCE = new Elvis();   
  	private Elvis() { ... }  
    public static Elvis getInstance() { return INSTANCE; }  
    
    public void leaveTheBuilding() { ... }  
}

è¿™ç§æ–¹æ³•å’Œ `final` åŸŸæ–¹æ³•å¯èƒ½å—åˆ°çš„æ”»å‡»æ˜¯ä¸€æ ·çš„ï¼Œé˜²å¾¡æ–¹æ³•ä¹Ÿä¸€æ ·ã€‚

#### å¦‚ä½•é€‰æ‹©

public åŸŸçš„ä¸»è¦ä¼˜åŠ¿å°±æ˜¯å®ƒçš„ API å¯ä»¥æ¸…æ¥šè¡¨æ˜è¿™æ˜¯ä¸ª Singleton ç±»ï¼špubilc staticd åŸŸæ˜¯ final çš„ï¼Œæ‰€ä»¥å®ƒæ€»æ˜¯ç›¸åŒçš„å¯¹è±¡å¼•ç”¨ã€‚ç¬¬äºŒä¸ªä¼˜åŠ¿å°±æ˜¯æ›´ç®€å•ã€‚

é™æ€å·¥å‚æ–¹æ³•çš„ä¼˜åŠ¿æœ‰ï¼š

-   çµæ´»ã€‚ä¸æ”¹å˜ API çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦ç»§ç»­ä¸ºè¯¥ç±»å®ç° Singletonï¼Œæ¯”å¦‚åœ¨é™æ€å·¥å‚æ–¹æ³•ä¸­ä¸ºæ¯ä¸ªçº¿ç¨‹è¿”å›ä¸€ä¸ª Singletonï¼›
    
-   å¯ä»¥å®ç°æ³›å‹ Singleton å·¥å‚ï¼ˆè¯¦è§ç¬¬ 30 æ¡ï¼‰ï¼›
    
-   å¯ä»¥ä½¿ç”¨æ–¹æ³•å¼•ç”¨ä½œä¸ºä¸€ä¸ª supplierï¼Œä¾‹å¦‚ `Elvis::instance` å°±æ˜¯ä¸€ä¸ª `Supplier<Elvis>`ã€‚
    

é™¤ééœ€è¦é™æ€å·¥å‚çš„ä¼˜åŠ¿ï¼Œå¦åˆ™ä¼˜å…ˆè€ƒè™‘ public åŸŸæ–¹æ³•ã€‚

#### å¯åºåˆ—åŒ–æ—¶çš„é—®é¢˜

è¦ä½¿ä¸Šé¢ä¸¤ç§æ–¹æ³•çš„ singleton ç±»å¯åºåˆ—åŒ–ï¼ˆè¯¦è§ç¬¬ 12 ç« ï¼‰ï¼Œä»…ä»…åœ¨å…¶å£°æ˜ä¸­æ·»åŠ  `implements Serializable` æ˜¯ä¸å¤Ÿçš„ã€‚ä¸ºäº†ä¿è¯å•ä¾‹ï¼Œè¦å£°æ˜æ‰€æœ‰çš„å®ä¾‹åŸŸéƒ½æ˜¯ `transient` çš„ï¼Œå¹¶æä¾›ä¸€ä¸ª `readResolve` æ–¹æ³•ï¼ˆè¯¦è§ç¬¬ 89 æ¡ï¼‰ã€‚å¦åˆ™ï¼Œæ¯æ¬¡åºåˆ—åŒ–çš„å®ä¾‹è¢«ååºåˆ—åŒ–æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼š

// readResolve method to preserve singleton property  
private Object readResolve() {  
    // Return the one true Elvis and let the garbage collector  
    // take care of the Elvis impersonator.  
    return INSTANCE;  
}

### å•å…ƒç´ æšä¸¾ç±»å‹

// Enum singleton - the preferred approach  
public enum Elvis {  
    INSTANCE;  
    public void leaveTheBuilding() { ... }  
}

è¿™ç§æ–¹æ³•å’Œ public åŸŸçš„æ–¹æ³•ç›¸ä¼¼ï¼Œä½†æ›´åŠ ç®€æ´ï¼Œä¸”å…è´¹æä¾›äº†åºåˆ—åŒ–æœºåˆ¶ã€‚å³ä½¿åœ¨é¢å¯¹å¤æ‚çš„åºåˆ—åŒ–æˆ–è€…åå°„æ”»å‡»çš„æ—¶å€™ä¹Ÿ**ç»å¯¹é˜²æ­¢å¤šæ¬¡å®ä¾‹åŒ–**ã€‚è¿™ç§æ–¹æ³•è™½ç„¶çœ‹èµ·æ¥ä¸è‡ªç„¶ï¼Œä½†æ˜¯å®ƒå¾€å¾€æ˜¯å®ç° singleton æœ€å¥½çš„æ–¹å¼ã€‚

**æ³¨æ„**ï¼šå¦‚æœ Singleton å¿…é¡»ç»§æ‰¿ä¸€ä¸ªç±»ï¼Œä¸”è¿™ä¸ªç±»ä¸æ˜¯æšä¸¾ç±»å‹çš„æ—¶å€™ï¼Œåˆ™ä¸å®œä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼ˆå°½ç®¡å¯ä»¥å£°æ˜æšä¸¾å»å®ç°æ¥å£ï¼‰ã€‚

## 4. é€šè¿‡ç§æœ‰æ„é€ å™¨å¼ºåŒ–ä¸å¯å®ä¾‹åŒ–çš„èƒ½åŠ›

æœ‰æ—¶å€™å¯èƒ½éœ€è¦ç¼–å†™åªåŒ…å«é™æ€æ–¹æ³•å’Œé™æ€åŸŸçš„ç±»ã€‚å®ƒä»¬å¯ä»¥ç”¨æ¥å°†åŸºæœ¬ç±»å‹å€¼æˆ–æ•°ç»„ä¸Šçš„ç›¸å…³æ–¹æ³•ç»„ç»‡èµ·æ¥ï¼Œä¾‹å¦‚ java.lang.Math æˆ– java.util.Arraysã€‚å®ƒä»¬ä¹Ÿå¯ä»¥ç”¨æ¥å°†é™æ€æ–¹æ³•ï¼ˆåŒ…æ‹¬é™æ€å·¥å‚æ–¹æ³•ï¼‰ç»„ç»‡èµ·æ¥ï¼Œè¿™äº›æ–¹æ³•ç”¨äºã€Œå®ç°æŸäº›æ¥å£çš„å¯¹è±¡ã€ï¼Œä¾‹å¦‚ java.util.Collectionsï¼ˆJava 8 ä¹‹åï¼Œå¯ä»¥å°†è¿™ç§æ–¹æ³•æ”¾è¿›æ¥å£é‡Œï¼‰ã€‚æœ€åï¼Œè¿˜å¯ä»¥åˆ©ç”¨è¿™ç§ç±»å°† final ç±»é‡Œæ–¹æ³•ç»„ç»‡èµ·æ¥ï¼Œå› ä¸ºä¸èƒ½æŠŠå®ƒä»¬æ”¾åœ¨å­ç±»ä¸­ï¼ˆTODOï¼šæ²¡æ˜ç™½ï¼‰ã€‚

è¿™ç§**å·¥å…·ç±»**å¹¶ä¸æ˜¯ä¸ºäº†è¢«å®ä¾‹åŒ–è€Œè®¾è®¡çš„ï¼šå®ƒçš„å®ä¾‹æ˜¯æ¯«æ— æ„ä¹‰çš„ã€‚ä½†æ˜¯åœ¨æ²¡æœ‰æä¾›æ„é€ å‡½æ•°çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨æä¾›äº†ä¸€ä¸ªå…¬å…±çš„ã€æ— å‚æ•°çš„é»˜è®¤æ„é€ å‡½æ•°ã€‚

> ç†è§£ï¼š
> 
> 1.  é™æ€å·¥å…·ç±»å¹¶ä¸æ˜¯è¯´ç±»æ˜¯é™æ€çš„ï¼Œè€Œæ˜¯ç±»ä¸­æä¾›äº†å¤§é‡é™æ€å·¥å…·æ–¹æ³•ã€‚
>     
> 2.  é™æ€å·¥å…·ç±»å’Œå•ä¾‹æ²¡æœ‰å…³ç³»ï¼Œé™æ€å·¥å…·ç±»å¦‚æœä½¿ç”¨äº† private æ„é€ å™¨ï¼Œé‚£ä¹ˆå®ƒç”šè‡³å¯ä»¥é€‰æ‹©æ°¸è¿œæ²¡æœ‰å®ä¾‹ï¼Œé€šå¸¸ä¹Ÿåº”è¯¥è¿™ä¹ˆä½œã€‚
>     

**é€šè¿‡å°†è¿™ç§ç±»ç¼–å†™æˆæŠ½è±¡ç±»æ¥å¼ºè¿«ä¸å¯å®ä¾‹åŒ–æ˜¯è¡Œä¸é€šçš„ã€‚**å› ä¸ºè¯¥ç±»å¯ä»¥è¢«ç»§æ‰¿ï¼Œå¹¶ä¸”è¯¥å­ç±»å¯ä»¥è¢«å®ä¾‹åŒ–ã€‚è¿™æ ·ç”šè‡³ä¼šè¯¯å¯¼ç”¨æˆ·ï¼Œä»¥ä¸ºè¿™ä¸ªæŠ½è±¡ç±»å°±æ˜¯ä¸“é—¨ä¸ºäº†ç»§æ‰¿è€Œè®¾è®¡çš„ï¼ˆè¯¦è§ç¬¬ 19 æ¡ï¼‰ã€‚è§£å†³åŠæ³•æ˜¯ï¼Œ**åªè¦è®©è¿™ä¸ªç±»åŒ…å«ä¸€ä¸ªç§æœ‰æ„é€ å™¨ï¼Œå®ƒå°±ä¸èƒ½è¢«å®ä¾‹åŒ–ã€‚**

// Noninstantiable utility class  
public class UtilityClass {  
    // Suppress default constructor for noninstantiability  
    private UtilityClass() {  
        throw new AssertionError();  
    }  
    ...  // Remainder omitted  
}

`AssertionError` ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†æ˜¯å®ƒå¯ä»¥é¿å…ä¸å°å¿ƒåœ¨ç±»çš„å†…éƒ¨è°ƒç”¨æ„é€ å™¨ã€‚è¿™ç§æ–¹å¼å¯ä»¥ä¿è¯åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸ä¼šè¢«å®ä¾‹åŒ–ã€‚æœ€å¥½åœ¨ç§æœ‰æ„é€ å™¨ä¸Šæ–¹åŠ ä¸Šä¸€æ¡æ³¨é‡Šã€‚

è¿™ç§æ–¹æ³•ä½¿å¾—ä¸€ä¸ªç±»ä¸èƒ½è¢«ç»§æ‰¿ï¼Œå› ä¸ºæ‰€æœ‰çš„æ„é€ å™¨éƒ½å¿…é¡»æ˜¾å¼æˆ–éšå¼åœ°è°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨ã€‚

## 5. ä¼˜å…ˆè€ƒè™‘ä¾èµ–æ³¨å…¥æ¥ä¾èµ–èµ„æº

### æ™®é€šæ–¹å¼

è®¸å¤šç±»éƒ½ä¾èµ–ä¸€ä¸ªæˆ–å¤šä¸ªåº•å±‚èµ„æºã€‚ä¾‹å¦‚ï¼Œæ‹¼å†™æ£€æŸ¥å™¨ä¾èµ–å­—å…¸ã€‚å¾ˆå¯èƒ½å°†è¿™ç§ç±»å®ç°æˆé™æ€å·¥å…·ç±»ï¼š

// Inappropriate use of static utility - inflexible & untestable!  
public class SpellChecker {  
    private static final Lexicon dictionary = ...;  
      
    private SpellChecker() {} // Noninstantiable  
      
    public static boolean isValid(String word) { ... }  
    public static List<String> suggestions(String typo) { ... }  
}

ä¹Ÿå¾ˆå¯èƒ½å°†å®ƒå®ç°ä¸ºå•ä¾‹ï¼š

// Inappropriate use of singleton - inflexible & untestable!  
    
public class SpellChecker {  
    private final Lexicon dictionary = ...;  
      
    private SpellChecker(...) {}  
    public static INSTANCE = new SpellChecker(...);  
      
    public boolean isValid(String word) { ... }  
    public List<String> suggestions(String typo) { ... }  
}

è¿™ä¸¤ç§æ–¹æ³•éƒ½ä¸ç†æƒ³ï¼Œå› ä¸ºå®ƒä»¬éƒ½å‡è®¾äº†åªä¼šä½¿ç”¨ä¸€ä¸ªå­—å…¸ã€‚

å¯ä»¥å°è¯•é€šè¿‡ä¿®æ”¹ `dictionary` åŸŸä¸ºé finalï¼Œå¹¶æ·»åŠ ä¸€ä¸ªæ”¹å˜ dictionary çš„æ–¹æ³•ï¼Œæ¥è§£å†³é—®é¢˜ã€‚ä½†è¿™ç§æ–¹å¼å¾ˆå®¹æ˜“å‡ºé”™ï¼Œå¹¶ä¸”æ— æ³•å¹¶å‘è®¾ç½®ã€‚é™æ€å·¥å…·ç±»å’Œå•ä¾‹éƒ½ä¸é€‚åˆé‚£äº›è¡Œä¸ºè¢«åº•å±‚èµ„æºå‚æ•°åŒ–çš„ç±»ï¼ˆTODOï¼šè¿™ä¸ªå‚æ•°åŒ–ï¼Œå°±æ˜¯æŒ‡æ ¹æ®åº•å±‚èµ„æºå¯ä»¥æ§åˆ¶ç±»çš„è¡Œä¸ºï¼Ÿï¼‰ã€‚

### ä¾èµ–æ³¨å…¥

çœŸæ­£éœ€è¦çš„æ˜¯èƒ½åœ¨ç±»ä¸­èƒ½æ”¯æŒå¤šä¸ªå®ä¾‹çš„èƒ½åŠ›ï¼Œæ¯ä¸ªå®ä¾‹éƒ½ä½¿ç”¨å®¢æˆ·ç«¯æ‰€éœ€è¦çš„èµ„æºï¼ˆæ­¤ä¾‹ä¸­æ˜¯å­—å…¸ï¼‰ã€‚æ»¡è¶³éœ€æ±‚çš„æœ€ç®€å•æ¨¡å¼æ˜¯åœ¨åˆ›å»ºå®ä¾‹çš„æ—¶å€™ï¼Œå°†è¿™ä¸ªèµ„æºä¼ é€’ç»™æ„é€ å™¨ã€‚è¿™æ˜¯ä¾èµ–æ³¨å…¥çš„ä¸€ç§å½¢å¼ï¼šå­—å…¸æ˜¯ä¸€ä¸ªæ‹¼å†™æ£€æŸ¥å™¨çš„ä¸€ä¸ªä¾èµ–ï¼Œå¹¶ä¸”å®ƒåœ¨æ‹¼å†™æ£€æŸ¥å™¨åœ¨åˆ›å»ºçš„æ—¶å€™è¢«æ³¨å…¥è¿›å»äº†ã€‚

// Dependency injection provides flexibility and testability  
public class SpellChecker {  
    private final Lexicon dictionary;  
  
    public SpellChecker(Lexicon dictionary) {   
        this.dictionary = Objects.requireNonNull(dictionary);  
    }  
      
    public boolean isValid(String word) { ... }  
    public List<String> suggestions(String typo) { ... }  
}

è¿™ç§æ–¹å¼å¤ªç®€å•äº†ï¼Œä»¥è‡³äºè®¸å¤šç¨‹åºå‘˜ä½¿ç”¨å¤šå¹´éƒ½ä¸çŸ¥é“å®ƒçš„åå­—ã€‚

ä¾èµ–æ€§æ³¨å…¥å¯ä»¥å¤„ç†ä»»æ„æ•°é‡çš„èµ„æºå’Œä»»æ„çš„ä¾èµ–æ€§å›¾ï¼ˆdependency graphï¼‰ã€‚å®ƒä¿ç•™äº†ä¸å˜æ€§ï¼ˆè¯¦è§ç¬¬ 17 æ¡ï¼‰ï¼Œæ‰€ä»¥å¤šä¸ªå®¢æˆ·åœ¨æœ‰ç›¸åŒéœ€æ±‚çš„æ—¶å€™å¯ä»¥å…±äº«ä¾èµ–å¯¹è±¡ã€‚ä¾èµ–æ³¨å…¥åŒæ ·é€‚ç”¨äºæ„é€ å‡½æ•°ã€é™æ€å·¥å‚æ–¹æ³•å’Œ Builderã€‚

è¯¥æ¨¡å¼ä¸€ä¸ªæœ‰ç”¨çš„å˜ä½“å°±æ˜¯ä¼ é€’ä¸€ä¸ªèµ„æºçš„å·¥å‚ç»™æ„é€ å™¨ã€‚å·¥å‚æ˜¯ä¸€ä¸ªå¯ä»¥é‡å¤è°ƒç”¨çš„å¯¹è±¡ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ªç±»å‹çš„å®ä¾‹ã€‚è¿™ç§å·¥å‚ä½“ç°äº†å·¥å‚æ–¹æ³•æ¨¡å¼ã€‚Java 8 å¼•è¿›çš„ `Supplier<T>` æ¥å£æœ€é€‚åˆç”¨æ¥è¡¨ç¤ºå·¥å‚ã€‚æ¥å— `Supplier<T>` è¾“å…¥çš„æ–¹æ³•é€šå¸¸åº”è¯¥ä½¿ç”¨æœ‰ç•Œé€šé…ç¬¦ç±»å‹ï¼ˆbounded wildcard typeï¼Œè¯¦è§ç¬¬ 31 æ¡ï¼‰æ¥çº¦æŸå·¥å‚çš„ç±»å‹å‚æ•°ï¼Œä»¥å…è®¸å®¢æˆ·ä¼ é€’ä¸€ä¸ªåˆ›å»ºæŒ‡å®šç±»å‹çš„ä»»ä½•å­ç±»å‹çš„å·¥å‚ï¼ˆè·Ÿä¸Šé¢çš„ç”¨äºç±»å±‚æ¬¡çš„ builder æ–¹å¼ä¸€æ ·ï¼Œå¯ä»¥è®©å®¢æˆ·ç«¯ä¸ç”¨è½¬å‹ï¼‰ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢è¿™ä¸ªæ–¹æ³•å¯ä»¥æ¥å—å®¢æˆ·ç«¯æä¾›çš„å·¥å‚ï¼Œå®¢æˆ·ç«¯æä¾›çš„å·¥å‚å¯ä»¥åˆ›å»º Tile çš„ä»»ä½•å­ç±»ã€‚

Mosaic create(Supplier<? extends Tile> tileFactory) { ... }

å°½ç®¡ä¾èµ–æ³¨å…¥æå¤§åœ°æé«˜äº†çµæ´»æ€§å’Œå¯æµ‹è¯•æ€§ï¼Œä½†å®ƒä¼šä½¿å¤§å‹é¡¹ç›®å˜å¾—æ‚ä¹±æ— ç« ï¼Œè¿™äº›é¡¹ç›®é€šå¸¸åŒ…å«æˆåƒä¸Šä¸‡çš„ä¾èµ–å…³ç³»ã€‚é€šè¿‡ä½¿ç”¨ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œå¦‚Daggerã€Guice æˆ– Springï¼Œå¯ä»¥å®Œå…¨æ¶ˆé™¤è¿™ç§æ‚ä¹±ã€‚

> TODOï¼šç»“åˆç¬¬ä¸€æ¡å’Œè¿™æ¡ï¼ŒSpring çš„ä¾èµ–æ³¨å…¥æ˜¯å¦æ˜¯é€šè¿‡æœåŠ¡æä¾›è€…æ¡†æ¶å®ç°çš„ï¼Ÿæ¯”å¦‚ @Component æ³¨è§£æ³¨å†ŒæœåŠ¡ï¼Œä»¥åŠå®ƒæ³¨è§£çš„ç±»æ˜¯æœåŠ¡å®ç°ï¼Œ@Autowired å¯¹åº”æœåŠ¡è®¿é—® APIã€‚

### æ€»ç»“

æ€»ä¹‹ï¼Œä¸è¦ä½¿ç”¨ Singleton æˆ–é™æ€å·¥å…·ç±»æ¥å®ç°ä¾èµ–äºä¸€ä¸ªæˆ–å¤šä¸ªåº•å±‚èµ„æºçš„ç±»ï¼Œè¿™äº›åº•å±‚èµ„æºçš„è¡Œä¸ºä¼šå½±å“è¯¥ç±»çš„è¡Œä¸ºï¼Œä¹Ÿä¸è¦è®©è¯¥ç±»ç›´æ¥åˆ›å»ºè¿™äº›èµ„æºã€‚ç›¸åï¼Œå¯ä»¥å°†èµ„æºæˆ–åˆ›å»ºå®ƒä»¬çš„å·¥å‚ä¼ é€’ç»™æ„é€ å‡½æ•°ï¼ˆæˆ–é™æ€å·¥å‚æˆ– builderï¼‰ï¼Œè¿™ç§åšæ³•è¢«ç§°ä¸ºä¾èµ–æ€§æ³¨å…¥ï¼Œå°†å¤§å¤§å¢å¼ºç±»çš„çµæ´»æ€§ã€å¯é‡ç”¨æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

> ä¸ºä»€ä¹ˆä¸æŠŠæ„é€ æ–¹æ³•ä¼ å‚çš„æ–¹å¼ç”¨äºé™æ€å·¥å…·ç±»ï¼Ÿå› ä¸ºéƒ½æ˜¯å·¥å…·ç±»äº†ï¼Œå®ƒæ˜¯ä¸å¯å®ä¾‹åŒ–çš„ç±»ã€‚å½“ç„¶ï¼Œå¦‚æœåªæ˜¯æ™®é€šçš„é™æ€ç±»ï¼Œæˆ‘è®¤ä¸ºæ˜¯å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•çš„ã€‚

## 6. é¿å…åˆ›å»ºä¸å¿…è¦çš„å¯¹è±¡

### å°½å¯èƒ½é‡ç”¨å¯¹è±¡

ä¸€èˆ¬æ¥è¯´ï¼Œæœ€å¥½èƒ½é‡ç”¨å•ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯åœ¨æ¯æ¬¡éœ€è¦çš„æ—¶å€™å°±åˆ›å»ºä¸€ä¸ªç›¸åŒåŠŸèƒ½çš„æ–°å¯¹è±¡ã€‚é‡ç”¨ä¸ä»…å¿«ï¼Œè€Œä¸”å¾ˆä¼˜é›…ã€‚å¦‚æœå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œå®ƒå°±å§‹ç»ˆå¯ä»¥è¢«é‡ç”¨ï¼ˆè¯¦è§ç¬¬ 17 æ¡ï¼‰ã€‚

ä¾‹å¦‚ï¼Œ`String s = new String("bikini")` ä¼šåœ¨æ¯æ¬¡è°ƒç”¨çš„æ—¶å€™åˆ›å»ºä¸€ä¸ªæ–°çš„ `String` å®ä¾‹ï¼Œè€Œ `String s = "bikini"` æ— è®ºè°ƒç”¨å¤šå°‘æ¬¡ï¼Œåªä¼šä½¿ç”¨ä¸€ä¸ª `String` å®ä¾‹ã€‚æ­¤å¤–ï¼Œè¿™ç§æ–¹å¼è¿˜ä¿è¯åŒä¸€ä¸ª VM ä¸Šï¼Œåªè¦ String å­—é¢é‡ç›¸åŒï¼Œå°±å…±ç”¨åŒä¸€ä¸ªå¯¹è±¡ã€‚

åœ¨é¢å¯¹ä¸å¯å˜ç±»çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•è€Œä¸æ˜¯æ„é€ å™¨æ¥é¿å…åˆ›å»ºä¸å¿…è¦çš„å¯¹è±¡ã€‚ä¾‹å¦‚ `Boolean.valueOf(String)` ä¼˜äº æ„é€ å™¨ `Boolean(String)`ï¼Œåœ¨åè€…åœ¨ Java 9 ç§è¢«åºŸå¼ƒã€‚åŒæ ·ï¼Œå¦‚æœå¯å˜å¯¹è±¡æ²¡æœ‰æ”¹å˜ï¼Œä¹Ÿå¯ä»¥é‡ç”¨å®ƒã€‚

> å…¶ä»–é€‚ç”¨çš„æƒ…å†µï¼š
> 
> -   å·²çŸ¥ä¸ä¼šä¿®æ”¹çš„å¯¹è±¡ï¼›
>     
> -   é€‚é…å™¨ï¼ˆæœ‰æ—¶å€™ä¹Ÿå«è§†å›¾ viewï¼‰é™¤äº†ä»£ç†å¯¹è±¡ä¹‹å¤–ï¼Œæ²¡æœ‰å…¶ä»–çš„çŠ¶æ€ä¿¡æ¯ï¼Œæ‰€ä»¥é’ˆå¯¹æŸä¸ªç»™å®šå¯¹è±¡çš„ç‰¹å®šé€‚é…å™¨è€Œè¨€ï¼Œä¸éœ€è¦åˆ›å»ºå¤šä¸ªé€‚é…å™¨å®ä¾‹ã€‚
>     
>     ä¾‹å¦‚ï¼Œ`Map` æ¥å£çš„ `keySet()` æ–¹æ³•è¿”å› Map å¯¹è±¡çš„ Set è§†å›¾ï¼Œæ¯æ¬¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•éƒ½è¿”å›åŒæ ·çš„ Set å®ä¾‹ã€‚è™½ç„¶è¿™ä¸ª Set å®ä¾‹ä¸€èˆ¬æ˜¯å¯æ”¹å˜çš„ï¼Œä½†æ˜¯æ‰€æœ‰è¿”å›çš„å¯¹è±¡åœ¨åŠŸèƒ½ä¸Šæ˜¯ç­‰åŒçš„ï¼šå½“å…¶ä¸­ä¸€ä¸ªè¿”å›å¯¹è±¡å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæ‰€æœ‰å…¶ä»–çš„è¿”å›å¯¹è±¡ä¹Ÿè¦å‘ç”Ÿå˜åŒ–ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ç”±åŒä¸€ä¸ª Map å®ä¾‹æ”¯æ’‘çš„ ã€‚ è™½ç„¶åˆ›å»º keySet è§†å›¾å¯¹è±¡çš„å¤šä¸ªå®ä¾‹å¹¶æ— å®³å¤„ï¼Œ å´æ˜¯æ²¡æœ‰å¿…è¦ï¼Œä¹Ÿæ²¡æœ‰å¥½å¤„çš„ ã€‚
>     

### â€œæ˜‚è´µâ€ çš„å¯¹è±¡

æœ‰äº›çš„å¯¹è±¡åˆ›å»ºçš„æˆæœ¬æ¯”å…¶ä»–å¯¹è±¡è¦é«˜å¾—å¤šï¼Œå¦‚æœè¦å¤šæ¬¡é‡å¤ä½¿ç”¨åŒä¸€ä¸ªæ˜‚è´µå¯¹è±¡ï¼Œå¯ä»¥å°†å®ƒä»¬ç¼“å­˜èµ·æ¥ä»¥é‡ç”¨ã€‚ä½†æ˜‚è´µçš„å¯¹è±¡å¹¶éæ€»æ˜¯æ˜¾è€Œæ˜“è§ã€‚ä¾‹å¦‚ `String.matches()` å¹¶ä¸é€‚åˆåœ¨æ³¨é‡æ€§èƒ½çš„æƒ…å½¢ä¸­é‡å¤ä½¿ç”¨ã€‚å› ä¸ºå®ƒåœ¨å†…éƒ¨ä¸ºæ­£åˆ™è¡¨è¾¾å¼åˆ›å»ºäº†ä¸€ä¸ª `Pattern` å®ä¾‹ï¼Œå´åªä½¿ç”¨äº†ä¸€æ¬¡ï¼Œä¹‹åå°±å¯ä»¥è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚åˆ›å»º `Pattern` çš„æˆæœ¬å¾ˆé«˜ï¼Œå› ä¸ºéœ€è¦å°†æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘æˆä¸€ä¸ªæœ‰é™çŠ¶æ€æœºã€‚

ä¸ºäº†æå‡æ€§èƒ½ï¼Œåº”è¯¥æ˜¾å¼åœ°å°†æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘æˆä¸€ä¸ª `Pattern` å®ä¾‹ï¼ˆä¸å¯å˜ï¼‰ï¼Œè®©å®ƒæˆä¸ºç±»åˆå§‹åŒ–çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶å°†å®ƒç¼“å­˜èµ·æ¥ã€‚

// Reusing expensive object for improved performance  
public class RomanNumerals {  
    private static final Pattern ROMAN = Pattern.compile(  
        "^(?=.)M*(C[MD]|D?C{0,3})"  
        + "(X[CL]|L?X{0,3})(I[XV]|V?I{0,3})$");  
  
    static boolean isRomanNumeral(String s) {  
        return ROMAN.matcher(s).matches();  
    }   
}

å¦‚æœ `isRomanNumeral` æ²¡è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆå°±æ²¡å¿…è¦åˆå§‹åŒ– `ROMAN`ã€‚å¯ä»¥åœ¨ `isRomanNumeral` ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨çš„æ—¶å€™**å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆlazily initializingï¼‰**ï¼ˆ83 æ¡ï¼‰ `ROMAN`ï¼Œä½†å¹¶**ä¸å»ºè®®**ï¼Œè¿™æ ·ä¼šä½¿æ–¹æ³•æ›´åŠ å¤æ‚ï¼Œä»è€Œæ— æ³•æå‡æ€§èƒ½ï¼ˆ67 æ¡ï¼‰ã€‚

### ä¸æ˜æ˜¾çš„ä¸å¯å˜å¯¹è±¡

å½“ä¸€ä¸ªå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œå¾ˆæ˜æ˜¾å®ƒå¯ä»¥è¢«å®‰å…¨åœ°é‡ç”¨ï¼Œä½†æœ‰äº›æƒ…å†µå¾ˆéš¾çœ‹å‡ºä¸€ä¸ªç±»æ˜¯ä¸å¯å˜çš„ã€‚è€ƒè™‘ä¸€ä¸‹é€‚é…å™¨çš„æƒ…å†µï¼Œä¹Ÿè¢«ç§°ä¸ºè§†å›¾ï¼ˆviewï¼‰ã€‚é€‚é…å™¨æ˜¯ä¸€ä¸ªã€Œå§”æ‰˜ç»™æ”¯æŒå¯¹è±¡ï¼ˆdelegating to a backing objectï¼‰ã€çš„å¯¹è±¡ï¼Œæä¾›äº†ä¸€ä¸ªæ›¿ä»£æ¥å£ã€‚å› ä¸ºé€‚é…å™¨é™¤äº†å…¶æ”¯æŒå¯¹è±¡çš„çŠ¶æ€å¤–æ²¡æœ‰å…¶ä»–çŠ¶æ€ï¼Œæ‰€ä»¥æ²¡æœ‰å¿…è¦ä¸ºä¸€ä¸ªç»™å®šçš„å¯¹è±¡åˆ›å»ºä¸€ä¸ªä»¥ä¸Šçš„é€‚é…å™¨å®ä¾‹ã€‚

ä¾‹å¦‚ï¼Œ`Map` çš„ `keySet` æ–¹æ³•è¿”å›äº†ä¸€ä¸ªç”±æ‰€æœ‰ key ç»„æˆçš„ Set viewã€‚ç›´è§‚ä¸Šæ¥çœ‹ï¼Œä¼¼ä¹æ¯ä¸€æ¬¡å¯¹ `keySet` çš„è°ƒç”¨éƒ½å¿…é¡»åˆ›å»ºä¸€ä¸ªæ–°çš„ `Set` å®ä¾‹ï¼Œä½†æ˜¯åœ¨ä¸€ä¸ªç»™å®šçš„ `Map` å¯¹è±¡ä¸Šæ¯ä¸€æ¬¡å¯¹ `keySet` çš„è°ƒç”¨éƒ½è¿”å›åŒä¸€ä¸ª `Set` å®ä¾‹ã€‚å°½ç®¡è¿”å›çš„ `Set` å®ä¾‹é€šå¸¸æ˜¯å¯å˜çš„ï¼Œä½†æ‰€æœ‰è¿”å›çš„å¯¹è±¡åœ¨åŠŸèƒ½ä¸Šæ˜¯ç›¸åŒçš„ï¼šå½“ä¸€ä¸ªè¿”å›çš„å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰€æœ‰å…¶ä»–çš„å¯¹è±¡ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯ç”±åŒä¸€ä¸ª Map å®ä¾‹æ”¯æŒçš„ã€‚è™½ç„¶åˆ›å»ºå¤šä¸ªä¸åŒ `keySet` è§†å›¾å¯¹è±¡çš„å®ä¾‹åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯æ— å®³çš„ï¼Œä½†è¿™æ˜¯ä¸å¿…è¦çš„ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•å¥½å¤„ã€‚

### è‡ªåŠ¨è£…ç®±ï¼ˆautoboxingï¼‰

è‡ªåŠ¨è£…ç®±ä¼šåˆ›å»ºå¤šä½™å¯¹è±¡ï¼Œå®ƒå…è®¸å°†åŸºæœ¬ç±»å‹å’Œè£…ç®±åŸºæœ¬ç±»å‹ï¼ˆBoxed Primitive Typeï¼‰æ··ç”¨ã€‚ä½†è¿™ä¸¤ç§ç±»å‹åœ¨æ€§èƒ½ä¸Šæœ‰ç€æ¯”è¾ƒæ˜æ˜¾çš„å·®åˆ«ï¼ˆ61 æ¡ï¼‰ã€‚

// Hideously slow! Can you spot the object creation?  
   private static long sum() {  
       Long sum = 0L;  
       for (long i = 0; i <= Integer.MAX_VALUE; i++)  
           sum += i;  
	   return sum;   
   }

`sum` å£°æ˜æˆ `Long` è€Œä¸æ˜¯ `long`ï¼Œä¼šä½¿ç¨‹åºæ„é€ äº†å¤§çº¦ 2^31 ä¸ªå¤šä½™çš„ `Long` å®ä¾‹ï¼ˆå¤§çº¦æ¯æ¬¡å¾€ `Long sum` ä¸­å¢åŠ  `long i` æ—¶æ„é€ ä¸€ä¸ªå®ä¾‹ï¼‰ã€‚**è¦ä¼˜å…ˆä½¿ç”¨åŸºæœ¬ç±»å‹ï¼Œè¦å½“å¿ƒæ— æ„è¯†çš„è‡ªåŠ¨è£…ç®±ã€‚**

> å¹¶ä¸æ˜¯è¯´è¦å°½å¯èƒ½åœ°é¿å…åˆ›å»ºå¯¹è±¡ï¼Œç›¸åï¼Œå°å¯¹è±¡çš„åˆ›å»ºå’Œå›æ”¶åŠ¨ä½œéå¸¸å»‰ä»·ã€‚é€šè¿‡åˆ›å»ºé™„åŠ å¯¹è±¡ï¼Œå¯ä»¥æå‡ç¨‹åºçš„æ¸…æ™°æ€§ã€ç®€æ´æ€§å’ŒåŠŸèƒ½æ€§ã€‚

### å¯¹è±¡æ± ï¼ˆobject poolï¼‰

é€šè¿‡ç»´æŠ¤è‡ªå·±çš„å¯¹è±¡æ± æ¥é¿å…åˆ›å»ºå¯¹è±¡å¹¶ä¸æ˜¯ä¸€ç§å¥½çš„åšæ³•ï¼Œé™¤éæ± ä¸­çš„å¯¹è±¡æ˜¯éå¸¸é‡é‡çº§çš„ã€‚æ•°æ®åº“è¿æ¥æ˜¯è¯æ˜å¯¹è±¡æ± åˆç†æ€§çš„ç»å…¸ä¾‹å­ã€‚å› ä¸ºå»ºç«‹è¿™äº›è¿æ¥ä»£ä»·éå¸¸å¤§ï¼Œæ‰€ä»¥æ‰æœ‰ç†ç”±é‡ç”¨è¿™äº›å¯¹è±¡ã€‚

ä½†æ˜¯ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œç»´æŠ¤è‡ªå·±çš„å¯¹è±¡æ± ä¼šæŠŠä»£ç å¼„å¾—å¾ˆä¹±ï¼ŒåŒæ—¶å¢åŠ å†…å­˜å ç”¨ï¼ˆfootprintï¼‰ï¼Œå¹¶ä¸”è¿˜ä¼šæŸå®³æ€§èƒ½ã€‚ç°ä»£çš„ JVM å®ç°å…·æœ‰é«˜åº¦ä¼˜åŒ–çš„åƒåœ¾å›æ”¶å™¨ï¼Œå…¶æ€§èƒ½å¾ˆå®¹æ˜“å°±ä¼šè¶…è¿‡è½»é‡çº§å¯¹è±¡æ± ã€‚

## 7. æ¶ˆé™¤åºŸå¼ƒçš„å¯¹è±¡å¼•ç”¨

Java å¹¶ä¸æ˜¯å®Œå…¨ä¸éœ€è¦è€ƒè™‘å†…å­˜ç®¡ç†ã€‚

### åºŸå¼ƒçš„å¯¹è±¡å¼•ç”¨

// Can you spot the "memory leak"?  
public class Stack {  
    private Object[] elements;  
    private int size = 0;  
    private static final int DEFAULT_INITIAL_CAPACITY = 16;  
    public Stack() {  
        elements = new Object[DEFAULT_INITIAL_CAPACITY];  
    }  
      
    public void push(Object e) {  
        ensureCapacity();  
        elements[size++] = e;  
    }  
  
    public Object pop() {  
        if (size == 0)  
            throw new EmptyStackException();  
        return elements[--size];  
    }  
      
    /**  
    * Ensure space for at least one more element, roughly  
    * doubling the capacity each time the array needs to grow.  
    */  
    private void ensureCapacity() {  
        if (elements.length == size)  
            elements = Arrays.copyOf(elements, 2 * size + 1);  
    }   
}

è¿™ä¸ªç±»çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•æ˜æ˜¾çš„é—®é¢˜ï¼Œä½†å®ƒä¼šå¼•å‘å†…å­˜æ³„éœ²ï¼Œå®ƒå¯ä»¥é»˜é»˜è¡¨ç°ä¸ºåƒåœ¾å›æ”¶å™¨çš„æ´»åŠ¨å¢åŠ æˆ–è€…å†…å­˜å ç”¨å¢åŠ è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚æç«¯æƒ…å†µä¸‹ï¼Œå†…å­˜æ³„æ¼ä¼šå¯¼è‡´ç£ç›˜åˆ†é¡µï¼Œç”šè‡³å‡ºç° OOMã€‚

å¦‚æœæ ˆå…ˆå¢é•¿å†æ”¶ç¼©ï¼Œé‚£ä¹ˆæ ˆä¸­å¼¹å‡ºæ¥çš„å¯¹è±¡å³ä½¿åœ¨ç¨‹åºä¸­æ²¡æœ‰ä»»ä½•æŒ‡å‘å®ƒä»¬çš„å¼•ç”¨ï¼Œå®ƒä»¬ä¹Ÿä¸ä¼šè¢«åƒåœ¾å›æ”¶ã€‚å› ä¸ºæ ˆä¾ç„¶ç»´æŠ¤ç€å¯¹è¿™äº›å¯¹è±¡çš„åºŸå¼ƒå¼•ç”¨ï¼ˆobsolete referenceï¼‰ã€‚åºŸå¼ƒå¼•ç”¨å¯ä»¥ç®€å•è®¤ä¸ºæ˜¯ä¸€ä¸ªæ°¸è¿œä¸ä¼šè¢«å–æ¶ˆå¼•ç”¨ï¼ˆdereferenceï¼‰çš„å¼•ç”¨ã€‚åœ¨æ­¤ä¾‹ä¸­ï¼Œå¯¹è±¡æ•°ç»„ä¸­æ´»åŠ¨éƒ¨åˆ†ï¼ˆå¤§äºç­‰äº `size` ï¼‰ä¹‹å¤–éƒ¨åˆ†çš„ä»»ä½•å¼•ç”¨éƒ½æ˜¯åºŸå¼ƒçš„ã€‚

å†…å­˜æ³„æ¼åœ¨åƒåœ¾å›æ”¶è¯­è¨€ä¸­æ˜¯æ½œä¼çš„ï¼Œæ›´æ°å½“çš„è¯´æ³•æ˜¯æ— æ„è¯†çš„å¯¹è±¡ä¿ç•™ï¼ˆunintentional object retentionsï¼‰ã€‚åƒåœ¾æ”¶é›†å™¨ä¸ä»…ä¼šå°†è¿™ç§æ— æ„è¯†ä¿ç•™ä¸‹æ¥çš„å¯¹è±¡å¼•ç”¨æ’é™¤å›æ”¶èŒƒå›´ï¼Œè€Œä¸”è¿˜ä¼šå°†è¯¥å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡ä¹Ÿæ’é™¤ï¼Œä»¥æ­¤ç±»æ¨ã€‚å³ä½¿åªæœ‰å¾ˆå°ä¸€éƒ¨åˆ†æ— æ„è¯†ä¿ç•™çš„å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´è®¸è®¸å¤šå¤šå¯¹è±¡ä¸ä¼šè¢«è¢«å›æ”¶ï¼Œå¯¹æ€§èƒ½æœ‰æ½œåœ¨çš„å·¨å¤§å½±å“ã€‚

### è‡ªå·±ç®¡ç†å†…å­˜çš„ç±»

è¿™ç§é—®é¢˜çš„ä¿®å¤æ–¹æ³•å¾ˆç®€å•ï¼Œåªéœ€æ¸…ç©ºï¼ˆnull outï¼‰è¿™äº›å¼•ç”¨å³å¯ã€‚

public Object pop() {  
    if (size == 0)  
    	throw new EmptyStackException();  
    Object result = elements[--size];  
    elements[size] = null; // Eliminate obsolete reference   
    return result;  
}

å°†åºŸå¼ƒçš„å¼•ç”¨æ¸…ç©ºçš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¦‚æœå®ƒä»¬è¢«é”™è¯¯åœ°å–æ¶ˆå¼•ç”¨ï¼Œç¨‹åºå°†ç«‹å³å‡ºç° `NullPointerException`ï¼Œè€Œä¸æ˜¯æ‚„æ‚„åœ°åšé”™äº‹ã€‚

å½“ç„¶ï¼Œæ²¡å¿…è¦åœ¨æ¯ä¸ªç¨‹åºç”¨å®Œçš„æ—¶å€™ç«‹é©¬æ¸…ç©ºå¯¹è±¡å¼•ç”¨ã€‚è¿™æ ·ä½¿å¾—ç¨‹åºå˜å¾—ååˆ†æ··ä¹±ã€‚æ¸…ç©ºåºŸå¼ƒå¯¹è±¡å¼•ç”¨åº”è¯¥æ˜¯ä¸€ç§ä¾‹å¤–ï¼Œè€Œä¸æ˜¯å¸¸è§„åšæ³•ã€‚æœ€å¥½çš„æ¶ˆé™¤åºŸå¼ƒå¯¹è±¡å¼•ç”¨çš„æ–¹å¼æ˜¯è®©åŒ…å«è¯¥å¼•ç”¨çš„å˜é‡è¶…å‡ºå®ƒçš„ä½œç”¨åŸŸï¼ˆfall out of scopeï¼‰ã€‚å¦‚æœå°†æ¯ä¸ªå˜é‡éƒ½é™åˆ¶åœ¨äº†æœ€å°ä½œç”¨åŸŸå†…ï¼Œè¿™ç§æƒ…å†µä¼šè‡ªç„¶å‘ç”Ÿï¼ˆè¯¦è§ç¬¬ 57 æ¡ï¼‰ã€‚

ä½†**æ¸…ç©ºå¯¹è±¡å¼•ç”¨çš„åšæ³•æ˜¯ä¸ªä¾‹å¤–ï¼Œè€Œä¸æ˜¯ä¸€ç§è§„èŒƒè¡Œä¸º**ï¼Œæœ€å¥½åŠæ³•æ˜¯è®©åŒ…å«è¯¥å¼•ç”¨çš„å˜é‡ç»“æŸå…¶ç”Ÿå‘½å‘¨æœŸã€‚ï¼ˆTODOï¼šä¹¦ä¸Šæ¥ä¸‹æ¥å†™é“ï¼šã€Œå¦‚æœä½ æ˜¯åœ¨æœ€ç´§å‡‘çš„ä½œç”¨åŸŸèŒƒå›´å†…å®šä¹‰æ¯ä¸€ä¸ªå˜é‡ï¼ˆè¯¦è§ç¬¬ 57 æ¡ï¼‰ï¼Œè¿™ç§æƒ…å½¢å°±ä¼šè‡ªç„¶è€Œç„¶åœ°å‘ç”Ÿã€‚ã€ï¼Œä¸å¤ªæ˜ç™½æ„æ€ã€‚ï¼‰

é‚£ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™åº”è¯¥æŠŠä¸€ä¸ªå¼•ç”¨æ¸…ç©ºï¼ˆnull outï¼‰ï¼ŸStack ç±»çš„å“ªä¸ªæ–¹é¢ä½¿å®ƒå®¹æ˜“å‘ç”Ÿå†…å­˜æ³„æ¼ï¼Ÿç®€å•åœ°è¯´ï¼Œå®ƒç®¡ç†ç€è‡ªå·±çš„å†…å­˜ã€‚å®ƒçš„å­˜å‚¨æ± ç”± `elements` æ•°ç»„çš„å…ƒç´ ç»„æˆï¼ˆå¯¹è±¡çš„å¼•ç”¨å•å…ƒï¼Œè€Œä¸æ˜¯å¯¹è±¡æœ¬èº«ï¼‰ã€‚æ•°ç»„æ´»åŠ¨éƒ¨åˆ†çš„å…ƒç´ è¢«åˆ†é…ï¼Œè€Œæ•°ç»„å…¶ä½™éƒ¨åˆ†çš„å…ƒç´ è¢«é‡Šæ”¾ã€‚ä½†åƒåœ¾æ”¶é›†å™¨æ²¡æœ‰åŠæ³•çŸ¥é“è¿™ä¸€ç‚¹ï¼›å¯¹åƒåœ¾æ”¶é›†å™¨æ¥è¯´ï¼Œ`elements` æ•°ç»„ä¸­æ‰€æœ‰çš„å¯¹è±¡å¼•ç”¨éƒ½æ˜¯åŒæ ·æœ‰æ•ˆçš„ã€‚åªæœ‰ç¨‹åºå‘˜çŸ¥é“æ•°ç»„çš„éæ´»åŠ¨éƒ¨åˆ†æ˜¯ä¸é‡è¦çš„ã€‚ç¨‹åºå‘˜é€šè¿‡åœ¨æ•°ç»„å…ƒç´ æˆä¸ºéæ´»åŠ¨éƒ¨åˆ†æ—¶æ‰‹åŠ¨å°†å…¶æ¸…ç©ºæ¥æœ‰æ•ˆåœ°å°†è¿™ä¸ªäº‹å®ä¼ è¾¾ç»™åƒåœ¾æ”¶é›†å™¨ã€‚

é€šå¸¸æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªç±»ç®¡ç†è‡ªå·±çš„å†…å­˜ï¼Œé‚£ä¹ˆå°±ä¸€å®šè¦æ³¨æ„å†…å­˜æ³„æ¼ã€‚å½“ä¸€ä¸ªå…ƒç´ è¢«é‡Šæ”¾æ—¶ï¼Œè¯¥å…ƒç´ åŒ…å«çš„ä»»ä½•å¯¹è±¡å¼•ç”¨éƒ½åº”è¯¥è¢«æ¸…ç©ºã€‚

> ä¸Šé¢æ‰€è¯´çš„æ¸…ç©ºï¼ŒåŸæ–‡æ˜¯ null outï¼Œåœ¨ç¨‹åºä¸­ä¹Ÿå°±æ˜¯å°†å˜é‡æŒ‡å‘ nullï¼›è€Œæ¶ˆé™¤çš„åŸæ–‡æ˜¯ eliminateï¼Œè¿™ä¸ªçš„å«ä¹‰æ›´å¹¿æ³›ç‚¹ï¼ŒåŒ…æ‹¬äº† null outï¼Œè¿˜æœ‰è®©å˜é‡ fall out of scopeã€‚

### ç¼“å­˜

ç¬¬äºŒç§å¸¸è§çš„å†…å­˜æ³„æ¼æºæ˜¯ç¼“å­˜ã€‚ä¸€æ—¦æŠŠä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨æ”¾åˆ°ç¼“å­˜ä¸­ï¼Œå°±å¾ˆå®¹æ˜“å¿˜è®°å®ƒçš„å­˜åœ¨ï¼Œä½¿å®ƒé•¿æ—¶é—´ç•™åœ¨ç¼“å­˜ä¸­ã€‚

æœ‰ä¸¤ç§æƒ…å†µï¼š

å½“æ‰€è¦çš„ç¼“å­˜é¡¹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç”±è¯¥é”®çš„å¤–éƒ¨å¼•ç”¨è€Œä¸æ˜¯ç”±å€¼å†³å®šæ—¶ï¼Œå¯ä»¥ç”¨ `WeakHashMap` ä»£è¡¨ç¼“å­˜ã€‚key-value å¯¹ä¼šåœ¨å®ƒä»¬è¢«åºŸå¼ƒä¹‹åè‡ªåŠ¨ç§»é™¤ï¼›

æ›´å¸¸è§çš„æƒ…å†µæ—¶ï¼Œç¼“å­˜é¡¹çš„å¯¿å‘½æ²¡æœ‰æ˜ç¡®å®šä¹‰ï¼Œä½†éšç€æ—¶é—´çš„æ¨ç§»ä¼šå˜å¾—è¶Šæ¥è¶Šæ²¡æœ‰ä»·å€¼ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåº”è¯¥å¶å°”æ¸…é™¤ä¸ç”¨çš„ç¼“å­˜é¡¹ã€‚æ¸…é™¤å·¥ä½œå¯ä»¥ç”±ä¸€ä¸ªåå°çº¿ç¨‹ï¼ˆå¯èƒ½æ˜¯ `ScheduledThreadPoolExecutor`ï¼‰æ¥å®Œæˆã€‚ä¹Ÿå¯ä»¥åœ¨ç»™ç¼“å­˜æ·»åŠ æ–°æ¡ç›®çš„æ—¶å€™é¡ºä¾¿è¿›è¡Œæ¸…ç†ï¼ˆ`LinkedHashMap` çš„ `removeEldestEntry()` æ–¹æ³•ï¼‰ã€‚å¯¹äºæ›´åŠ å¤æ‚çš„ç¼“å­˜ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ java.lang.refã€‚

### ç›‘å¬å™¨å’Œå…¶ä»–å›è°ƒ

ç¬¬äºŒç§å¸¸è§çš„å†…å­˜æ³„æ¼æºæ˜¯ç›‘å¬å™¨å’Œå…¶ä»–å›è°ƒã€‚æ³¨å†Œå›è°ƒå´æ²¡æœ‰æ˜¾å¼åœ°å–æ¶ˆæ³¨å†Œï¼Œå®ƒä»¬å°±ä¼šä¸æ–­åœ°å †ç§¯ã€‚ç¡®ä¿å›è°ƒè¢«åŠæ—¶åƒåœ¾å›æ”¶çš„ä¸€ä¸ªæ–¹æ³•æ˜¯åªä¿å­˜å®ƒä»¬çš„å¼±å¼•ç”¨ï¼ˆweak referenceï¼‰ï¼Œä¾‹å¦‚å°†ä»–ä»¬ä»…ä½œä¸ºé”®ä¿å­˜åœ¨ `WeakHashMap` ä¸­ã€‚

### æ€»ç»“

å› ä¸ºå†…å­˜æ³„æ¼é€šå¸¸ä¸ä¼šè¡¨ç°ä¸ºæ˜æ˜¾çš„æ•…éšœï¼Œå®ƒä»¬å¯èƒ½ä¼šåœ¨ç³»ç»Ÿä¸­å­˜åœ¨å¤šå¹´ã€‚ å®ƒä»¬é€šå¸¸ä»…åœ¨ä»”ç»†æ£€æŸ¥ä»£ç æˆ–å€ŸåŠ©ç§°ä¸ºå †åˆ†æå™¨ï¼ˆheap profilerï¼‰çš„è°ƒè¯•å·¥å…·çš„å¸®åŠ©ä¸‹æ‰èƒ½è¢«å‘ç°ã€‚ å› æ­¤ï¼Œå­¦ä¼šåœ¨é—®é¢˜å‘ç”Ÿä¹‹å‰é¢„æµ‹å¹¶é˜²æ­¢å®ƒä»¬å‘ç”Ÿæ˜¯éå¸¸å¯å–çš„ã€‚

## 8. é¿å…ä½¿ç”¨ finalizer å’Œ cleaner

### finalizer å’Œ cleaner ä¸èƒ½ä¿è¯åŠæ—¶æ€§

Finalizer æ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œé€šå¸¸å¾ˆå±é™©ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸å¿…è¦çš„ã€‚ä½¿ç”¨ finalizer é€šå¸¸ä¼šå¯¼è‡´è¡Œä¸ºä¸ç¨³å®šã€æ€§èƒ½é™ä½ï¼Œä»¥åŠå¯ç§»æ¤æ€§é—®é¢˜ã€‚è™½ç„¶ç»ˆç»“æ–¹æ³•æœ‰å°‘æ•°å‡ ä¸ªåˆæ³•ç”¨æ³•ä¼šåœ¨æœ¬æ¡åé¢è®²åˆ°ï¼Œä½†ä½œä¸ºä¸€é¡¹è§„åˆ™ï¼Œåº”è¯¥é¿å…ä½¿ç”¨å®ƒä»¬ã€‚åˆ° Java 9ï¼Œfinalizer è¢«åºŸå¼ƒï¼Œä½† Java ç±»åº“ä¸­ä¾ç„¶ä½¿ç”¨å®ƒä»¬ã€‚Java 9 æä¾›äº†æ›¿ä»£ finalizer çš„ cleanerã€‚**Cleaner æ²¡æœ‰ finalizer é‚£ä¹ˆå±é™©ï¼Œä½†åŒæ ·ä¸å¯é¢„æµ‹ã€ç¼“æ…¢ï¼Œä¸”ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯ä¸å¿…è¦çš„ã€‚**

Finalizer å’Œ cleaner çš„ä¸€ä¸ªç¼ºç‚¹åœ¨äº**ä¸èƒ½ä¿è¯ä¼šè¢«åŠæ—¶æ‰§è¡Œ**ï¼Œä»ä¸€ä¸ªå¯¹è±¡å˜æˆä¸å¯è¾¾ï¼Œåˆ°å®ƒçš„ finalizer æˆ– cleaner å¼€å§‹è¿è¡Œï¼Œè¿™ä¸­é—´çš„æ—¶é—´å¯ä»¥ä¸ºä»»æ„é•¿ã€‚è¿™å°±æ„å‘³ç€ï¼Œ**æ°¸è¿œä¸è¦åœ¨ finalizer æˆ–è€… cleaner ä¸­åšä»»ä½•éœ€è¦åŠæ—¶å®Œæˆçš„äº‹æƒ…**ã€‚ä¾‹å¦‚ï¼Œä¸åº”è¯¥åœ¨ finalizer æˆ– cleaner æ–¹æ³•ä¸­æ‰§è¡Œå…³é—­æ–‡ä»¶çš„æ“ä½œï¼Œè¿™æ˜¯ä¸€ç§ä¸¥é‡çš„é”™è¯¯ï¼Œå› ä¸ºæ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ç§æœ‰é™çš„èµ„æºã€‚

Finalizer å’Œ cleaner æ‰§è¡Œçš„åŠæ—¶æ€§ä¸»è¦æ˜¯åƒåœ¾æ”¶é›†ç®—æ³•çš„åŠŸèƒ½ï¼Œè¿™ç§ç®—æ³•åœ¨ä¸åŒçš„ JVM å®ç°ä¸­ä¼šå¤§ç›¸å¾„åº­ã€‚ä¾èµ– finalizer æˆ– cleaner æ‰§è¡ŒåŠæ—¶æ€§çš„ç¨‹åºçš„è¡Œä¸ºä¹ŸåŒæ ·ä¼šå‘ç”Ÿå˜åŒ–ã€‚

Finalizer çº¿ç¨‹çš„ä¼˜å…ˆçº§å¾ˆä½ï¼Œæ‰€ä»¥å®ƒå¹¶ä¸èƒ½åŠæ—¶æ‰§è¡Œã€‚è¯­è¨€è§„èŒƒæ²¡æœ‰ä¿è¯å“ªä¸ªçº¿ç¨‹æ¥æ‰§è¡Œ finalizerã€‚æ‰€ä»¥é™¤äº†ä¸ä½¿ç”¨ finalizer å¤–ï¼Œæ²¡æœ‰ä»»ä½•å¯æŠ‘åˆ¶çš„åŠæ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚Cleaner åœ¨è¿™ç‚¹ä¸Šæ¯” finalizer å¥½ä¸€ç‚¹ç‚¹ï¼Œå› ä¸ºç±»ä½œè€…å¯ä»¥æ§åˆ¶ä»–è‡ªå·±çš„ cleaner çº¿ç¨‹ï¼Œä½† cleaner ä»ç„¶è¿˜æ˜¯åœ¨åå°è¿è¡Œï¼Œå—åƒåœ¾æ”¶é›†å™¨çš„æ§åˆ¶ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½ä¿è¯å®ƒå¯ä»¥åŠæ—¶æ¸…ç†ã€‚

å®é™…ä¸Šï¼Œè¯­è¨€è§„èŒƒç”šè‡³**ä¸ä¿è¯ finalizer æˆ– cleaner æœ€ç»ˆå¯ä»¥è¿è¡Œ**ï¼Œè¿™æ˜¯å®Œå…¨æœ‰å¯èƒ½çš„ï¼šä¸€ä¸ªç¨‹åºç»ˆæ­¢äº†ï¼Œä½†æ²¡æœ‰è¿è¡Œä¸€äº›ä¸å¯è¾¾å¯¹è±¡çš„ finalizer æˆ– cleanerã€‚ä½œä¸ºç»“è®ºï¼Œ**æ°¸è¿œä¸è¦åœ¨ finalizer æˆ– cleaner ä¸­æ›´æ–°è¦æŒä¹…åŒ–çš„çŠ¶æ€ã€‚**ä¾‹å¦‚ï¼Œå¦‚æœä¾èµ– finalizer æˆ– cleaner æ¥é‡Šæ”¾ä¸€ä¸ªå…±äº«èµ„æºï¼ˆå¦‚æ•°æ®åº“ï¼‰ä¸Šçš„æŒä¹…åŒ–é”ï¼ˆpersisitent lockï¼‰æ—¶ï¼Œå¾ˆå®¹æ˜“è®©æ•´ä¸ªæ•°æ®åº“å®æ‰ã€‚

> `System.gc` å’Œ `System.runFinalization` è¿™ä¸¤ä¸ªæ–¹æ³•ç¡®å®å¢åŠ äº† finalizer æˆ– cleaner è¢«æ‰§è¡Œçš„æœºä¼šï¼Œä½†æ˜¯å®ƒä»¬åŒæ ·ä¹Ÿå¹¶ä¸ä¿è¯ finalizer æˆ–è€… cleaner ä¸€å®šä¼šè¢«æ‰§è¡Œã€‚
> 
> `System.runFinalizersOnExit` å’Œ `Runtime.runFinalizersOnExit` æ›¾ç»å£°ç§°å¯ä»¥åšå‡ºä¸Šé¢çš„ä¿è¯ï¼Œä½†å®ƒä»¬éƒ½æœ‰ä¸¥é‡çš„ç¼ºé™·ï¼Œå·²ç»è¢«åºŸå¼ƒå‡ åå¹´äº†ã€‚

### finalizer ä¼šæ©ç›–å¼‚å¸¸

å¦‚æœåœ¨æŸä¸ªå¯¹è±¡ finalization æœŸé—´æŠ›å‡ºäº†ä¸€ä¸ªæœªè¢«æ•æ‰çš„å¼‚å¸¸ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡çš„ finalization ä¼šç›´æ¥ç»“æŸã€‚æœªè¢«æ•æ‰çš„å¼‚å¸¸å¯èƒ½ä½¿å¯¹è±¡å¤„äºç ´åçš„çŠ¶æ€ï¼ˆcorrupt stateï¼‰ä¸­ï¼Œä»»æ„ä¸ç¡®å®šçš„è¡Œä¸ºéƒ½æœ‰å¯èƒ½å‘ç”Ÿã€‚å¹¶ä¸”ï¼Œè¿™ä¸ªæœªè¢«æ•æ‰çš„å¼‚å¸¸ä¸ä¼šåœæ­¢å½“å‰çº¿ç¨‹ï¼Œä¹Ÿä¸ä¼šæ‰“å°å †æ ˆä¿¡æ¯ã€‚Cleaner ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºä½¿ç”¨ cleaner çš„ç±»åº“å¯ä»¥æ§åˆ¶è‡ªå·±çš„çº¿ç¨‹ã€‚

### finalizer å’Œ cleaner æœ‰ä¸¥é‡çš„æ€§èƒ½æŸå¤±

ä¸ä½¿ç”¨ finalizer æ¯”ä½¿ç”¨ finalizer å¿«äº†å¾ˆå¤šï¼Œå› ä¸º finalizer é™åˆ¶äº†æœ‰æ•ˆçš„åƒåœ¾å›æ”¶ã€‚

å¦‚æœä½¿ç”¨ finalizer å’Œ cleaner æ¥æ¸…é™¤ä¸€ä¸ªç±»çš„æ‰€æœ‰å®ä¾‹ï¼Œé‚£ä¹ˆå®ƒä»¬çš„é€Ÿåº¦å·®ä¸å¤šï¼›å¦‚æœåªæŠŠå®ƒä»¬å½“æˆä¸€é“å®‰å…¨ç½‘ï¼ˆsafety netï¼‰ï¼Œcleaner ä¼šæ¯” finalizer å¿«å¾ˆå¤šï¼Œä½†è¿˜æ˜¯æ¯”ä¸ä½¿ç”¨å®‰å…¨ç½‘æ…¢äº†å¾ˆå¤šã€‚

### finalizer æœ‰ä¸¥é‡çš„å®‰å…¨é—®é¢˜

Finalizer ä¸º _finalizer attack_ æ•å¼€äº†å¤§é—¨ã€‚Finalizer attack å¾ˆç®€å•ï¼šå¦‚æœåœ¨ä¸€ä¸ªæ„é€ å‡½æ•°æˆ–è€…ã€Œå…¶åºåˆ—åŒ–çš„ç­‰ä»·ç‰©ã€ï¼ˆserialization equvalentsï¼Œ`readObject` å’Œ `readResolve` æ–¹æ³•ï¼Œè¯¦è§ç¬¬ 12 ç« ï¼‰æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆæ¶æ„å­ç±»çš„ finalizer å°±å¯ä»¥åœ¨è¿™ä¸ªéƒ¨åˆ†åˆ›å»ºçš„å¯¹è±¡ä¸Šè¿è¡Œäº†ï¼Œè€Œè¿™ä¸ªå¯¹è±¡æœ¬åº”è¯¥å·²ç» â€œæ­»â€ äº†ã€‚Finalizer å¯ä»¥ç”¨ä¸€ä¸ªé™æ€åŸŸè®°å½•è¿™ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œé˜»æ­¢å®ƒè¢«åƒåœ¾å›æ”¶ã€‚ä¸€æ—¦è¿™ä¸ªå¯¹è±¡è¢«è®°å½•äº†ï¼Œå°±å¯ä»¥å¾ˆè½»æ¾è°ƒç”¨å®ƒçš„ä»»æ„æ–¹æ³•ï¼Œè€Œè¿™äº›æ–¹æ³•æœ¬æ¥å°±ä¸åº”è¯¥è¢«å…è®¸å­˜åœ¨ã€‚**åœ¨æ„é€ å™¨ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥ä¿è¯é˜²æ­¢å¯¹è±¡ç»§ç»­å­˜åœ¨ï¼Œä½†å¦‚æœå­˜åœ¨ finalizer å°±æ— æ³•ä¿è¯ã€‚**è¿™ç§æ”»å‡»ä¼šé€ æˆä¸¥é‡çš„åæœã€‚Final ç±»å…ç–«è¿™ç§æ”»å‡»ï¼Œå› ä¸ºå®ƒæ˜¯ä¸å¯è¢«ç»§æ‰¿çš„ã€‚**ä¸ºäº†ä¿æŠ¤é final ç±»å…å— finalizer attackï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ªç©ºçš„ final `finalize` æ–¹æ³•ã€‚**

> ä¸ªäººç†è§£ï¼šä»»ä½•æ„é€ å™¨çš„ç¬¬ä¸€æ­¥éƒ½æ˜¯è°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨ï¼Œæ¶æ„å­ç±»çš„æ„é€ å™¨æ•…æ„è®©çˆ¶ç±»çš„æ„é€ å™¨æŠ›å‡ºå¼‚å¸¸ã€‚é‚£ä¹ˆè¿™ä¸ªç±»å°±ä¼šåˆ›å»ºå¤±è´¥ï¼Œç­‰å¾…è¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶ã€‚è€Œåƒåœ¾æ”¶é›†å™¨åœ¨é‡Šæ”¾è¿™ä¸ªå¯¹è±¡çš„å†…å­˜æ—¶ï¼Œä¼šå…ˆè°ƒç”¨å®ƒçš„ `finalize` æ–¹æ³•ï¼Œæ­¤æ—¶å¦‚æœæ¶æ„å­ç±»é‡å†™äº† `finalize` æ–¹æ³•ï¼Œå¹¶ä¿å­˜äº†å¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±ä¸ä¼šè¢«æ¸…é™¤ï¼Œç„¶è€Œå®ƒä¸åº”è¯¥æ˜¯å­˜åœ¨çš„ã€‚è¿™ç§æƒ…å†µå¥½åƒåœ¨ Java 8 ä¹‹åè§£å†³äº†ï¼Œä½†è¿˜æœ‰æ–°çš„æ”»å‡»æ–¹å¼ã€‚é’ˆå¯¹æè¿°çš„æ”»å‡»æ–¹å¼ï¼Œè¯•ç€å†™äº†ä¸ªä¾‹å­ï¼š
> 
> public class Secret {  
>  public Secret(int password) {  
>      if (password == 0) {  
>          throw new IllegalArgumentException();  
>      }  
>  }  
>   
>  public String getSecret() {  
>      return "secret!";  
>  }  
> }  
>   
> class FinalizerAttack extends Secret {  
>  public static Secret instance;  
>  public FinalizerAttack() {  
>      super(0);  
>  }  
>   
>  @Override  
>  protected void finalize() throws Throwable {  
>      instance = this;  
>  }  
> }

### å¦‚æœéœ€è¦å…³é—­èµ„æº

å¦‚æœå¯¹è±¡å°è£…äº†å¿…é¡»è¢«å…³é—­çš„èµ„æºæ—¶ï¼Œè¯¥ç”¨ä»€ä¹ˆå–ä»£ finalizr æˆ– cleaner å‘¢ï¼Ÿå¯ä»¥è®©è¿™ä¸ªç±»å®ç° `AutoCloseable` æ¥å£ï¼Œç„¶åè¦æ±‚å®¢æˆ·ç«¯åœ¨æ¯ä¸ªä¸éœ€è¦çš„å®ä¾‹ä¸Šè°ƒç”¨ `close` æ–¹æ³•ï¼Œé€šå¸¸ä½¿ç”¨ try-with-resource æ¥ç¡®ä¿å¼‚å¸¸ï¼ˆè¯¦è§ç¬¬ 9 æ¡ï¼‰çš„æ—¶å€™ä¹Ÿèƒ½å…³é—­èµ„æºã€‚è¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ä¾‹å¿…é¡»è·Ÿè¸ªåˆ°å®ƒæ˜¯å¦è¢«å…³é—­äº†ï¼š `close` æ–¹æ³•å¿…é¡»åœ¨ä¸€ä¸ªåŸŸä¸­è®°å½•è¯¥å¯¹è±¡ä¸å†æœ‰æ•ˆï¼Œå…¶ä»–æ–¹æ³•å¿…é¡»æ£€æŸ¥è¯¥åŸŸï¼Œå¹¶åœ¨å¯¹è±¡å…³é—­åè°ƒç”¨å®ƒä»¬æ—¶æŠ›å‡º `IllegalStateException`ã€‚

### finalizer å’Œ cleaner çš„åˆæ³•ç”¨æ³•

#### å®‰å…¨ç½‘

å½“èµ„æºæ‹¥æœ‰è€…å¿˜è®°è°ƒç”¨ `close` æ–¹æ³•çš„æ—¶å€™ï¼Œå®ƒä»¬å¯ä»¥ä½œä¸ºå®‰å…¨ç½‘ï¼ˆsafety netï¼‰ã€‚è™½ç„¶ä»ç„¶æ— æ³•ä¿è¯ finalizer æˆ– cleaner èƒ½åŠæ—¶ï¼ˆæˆ–è€…å‹æ ¹ä¸ï¼‰è¿è¡Œï¼Œä½†å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰è¿™æ ·åšï¼Œæ™šé‡Šæ”¾èµ„æºæ€»æ¯”ä¸é‡Šæ”¾å¥½ã€‚å¦‚æœçœŸçš„è€ƒè™‘æä¾›è¿™ä¸ªå®‰å…¨ç½‘ï¼Œè¦è€ƒè™‘æ¸…æ¥šè¿™ç§ä¿æŠ¤æ˜¯å¦å€¼å¾—ä»˜å‡ºè¿™æ ·çš„ä»£ä»·ã€‚æœ‰äº› Java ç±»åº“çš„ç±»ï¼Œå¦‚ `FileInputStream`ã€`FileOutputStream`ã€`ThreadPoolExcutor` å’Œ `java.sql.Connection` éƒ½æœ‰ä½œä¸ºå®‰å…¨ç½‘çš„ finalizerã€‚

#### å›æ”¶æœ¬åœ°å¯¹ç­‰ä½“

ä¸€ä¸ªæœ¬åœ°å¯¹ç­‰ä½“å°±æ˜¯ä¸€ä¸ªæœ¬åœ°ï¼ˆä¹Ÿå°±æ˜¯ non-Javaï¼‰å¯¹è±¡ï¼Œæ™®é€šå¯¹è±¡é€šè¿‡æœ¬åœ°æ–¹æ³•å§”æ‰˜ç»™å®ƒã€‚å› ä¸ºä¸€ä¸ªæœ¬åœ°å¯¹ç­‰ä½“ä¸æ˜¯ä¸€ä¸ªæ­£å¸¸å¯¹è±¡ï¼Œåƒåœ¾å›æ”¶å™¨ä¸è®¤è¯†å®ƒï¼Œä¹Ÿä¸èƒ½åœ¨å®ƒ Java å¯¹ç­‰ä½“è¢«å›æ”¶æ—¶å›æ”¶å®ƒã€‚å¦‚æœå¯æ¥å—æ€§èƒ½ï¼Œä¸”æœ¬åœ°å¯¹ç­‰ä½“ä¸æŒæœ‰é‡è¦èµ„æºï¼Œé‚£ä¹ˆ cleaner æˆ–è€… finalizer å°±æ˜¯å®Œæˆè¿™é¡¹ä»»åŠ¡çš„åˆé€‚å·¥å…·ã€‚ä½†å¦‚æœä¸èƒ½æ¥å—æ€§èƒ½ï¼Œæˆ–è€…æœ¬åœ°å¯¹ç­‰ä½“æŒæœ‰å¿…é¡»è¢«åŠæ—¶å›æ”¶çš„é‡è¦èµ„æºï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±å¿…é¡»æœ‰ä¸€ä¸ª `colse` æ–¹æ³•ï¼Œå¦‚å‰æ‰€è¿°ã€‚

### Cleaner çš„ä½¿ç”¨æ–¹å¼

> TODOï¼šè¿™ä¸€å°èŠ‚çœ‹äº†å¥½ä¹…ï¼Œæ•´ä¸ªéƒ½æ²¡çœ‹æ˜ç™½ï¼Œæ„Ÿè§‰ä¹Ÿä¸å¤ªéœ€è¦çœ‹ã€‚ã€‚ã€‚

Cleaner çš„ä½¿ç”¨æ–¹å¼æœ‰ä¸€ç‚¹æŠ€å·§ï¼Œä¸‹é¢ä»¥ä¸€ä¸ªç®€å•çš„ `Room` ç±»ä¸ºä¾‹æ¥æ¼”ç¤ºã€‚å‡è®¾æ‰€æœ‰çš„ room åœ¨è¢«å›æ”¶å‰å¿…é¡»è¢« cleandã€‚`Room` ç±»å®ç°äº† `AutoCloseable`ï¼›å®ƒçš„è‡ªåŠ¨ cleaning safety net ä½¿ç”¨äº†ä¸€ä¸ª cleanerï¼Œè¿™åªæ˜¯ä¸€ä¸ªå®ç°ç»†èŠ‚ã€‚ä¸ finalizer ä¸åŒï¼Œcleaner ä¸ä¼šæ±¡æŸ“ç±»çš„ public APIï¼š

Â // An autocloseable class using a cleaner as a safety net  
Â public class Room implements AutoCloseable {  
Â  Â  Â private static final Cleaner cleaner = Cleaner.create();  
Â â€‹  
Â  Â  Â // Resource that requires cleaning. Must not refer to Room!   
Â  Â  Â private static class State implements Runnable {  
Â  Â  Â  Â  Â int numJunkPiles; // Number of junk piles in this room  
Â  Â  Â  Â  Â   
Â  Â  Â  Â  Â State(int numJunkPiles) {  
Â  Â  Â  Â  Â  Â  Â this.numJunkPiles = numJunkPiles;  
Â  Â  Â  Â   }  
Â â€‹  
Â  Â  Â  Â  Â // Invoked by close method or cleaner   
Â  Â  Â  Â  Â @Override   
Â  Â  Â  Â  Â public void run() {  
Â  Â  Â  Â  Â  Â  Â System.out.println("Cleaning room");  
Â  Â  Â  Â  Â  Â  Â numJunkPiles = 0;  
Â  Â  Â  Â   }  
Â     }  
Â â€‹  
Â     // The state of this room, shared with our cleanable  
Â     private final State state;  
Â â€‹  
Â     // Our cleanable. Cleans the room when itâ€™s eligible for gc  
Â     private final Cleaner.Cleanable cleanable;  
Â  Â  Â   
Â  Â  Â public Room(int numJunkPiles) {  
Â  Â  Â  Â  Â state = new State(numJunkPiles);  
Â  Â  Â  Â  Â cleanable = cleaner.register(this, state);  
Â  Â   }  
Â â€‹  
Â  Â  Â @Override   
Â  Â  Â public void close() {  
Â  Â  Â  Â  Â cleanable.clean();  
Â  Â   }   
Â }

é™æ€å†…éƒ¨ç±» `State` æŒæœ‰ cleaner æ‰“æ‰«æˆ¿é—´æ‰€éœ€çš„èµ„æºã€‚åœ¨æ­¤ä¾‹ä¸­ï¼Œèµ„æºæ˜¯ `numJunkPiles` åŸŸï¼Œä»£è¡¨äº†æˆ¿é—´åƒåœ¾å †çš„æ•°é‡ã€‚æ›´ç°å®çš„è¯´ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ª final longï¼Œå®ƒåŒ…å«ä¸€ä¸ªæŒ‡å‘æœ¬åœ°å¯¹ç­‰ä½“çš„æŒ‡é’ˆã€‚`State` å®ç°äº† `Runnable` æ¥å£ï¼Œå®ƒçš„ `run` æ–¹æ³•æœ€å¤šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œè€Œå®ƒæ˜¯ç”±åœ¨ Room æ„é€ å‡½æ•°ä¸­å‘ cleaner æ³¨å†Œ `State` å®ä¾‹æ—¶è·å¾—çš„ `Cleanable` è°ƒç”¨ã€‚åªæœ‰ä¸¤ç§æƒ…å†µä¼šè§¦å‘ `run` æ–¹æ³•çš„è°ƒç”¨ï¼šé€šå¸¸æ˜¯é€šè¿‡è°ƒç”¨ `Room` çš„ `close` æ–¹æ³•ï¼Œç„¶å `close` æ–¹æ³•å†…éƒ¨è°ƒç”¨ `Cleanable` çš„ `clean` æ–¹æ³•æ¥è§¦å‘çš„ã€‚ å¦‚æœå®¢æˆ·ç«¯åœ¨ `Room` å®ä¾‹å¯ä»¥è¢«åƒåœ¾æ”¶é›†æ—¶æœªèƒ½è°ƒç”¨ `close` æ–¹æ³•ï¼Œåˆ™ cleaner å°†ï¼ˆæœ‰å¸Œæœ›ï¼‰è°ƒç”¨ `State` çš„ `run` æ–¹æ³•ã€‚

å…³é”®æ˜¯ `State` å®ä¾‹æ²¡æœ‰å¼•ç”¨å®ƒçš„ `Room` å®ä¾‹ã€‚å¦‚æœå®ƒå¼•ç”¨äº†ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªå¾ªç¯ï¼Œé‚£ä¹ˆå°±ä¼šé˜»æ­¢ `Room` å®ä¾‹è¢«åƒåœ¾å›æ”¶ï¼ˆä»¥åŠè¢« automatically cleanedï¼‰ã€‚å› æ­¤ï¼Œ`State` å¿…é¡»æ˜¯ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œå› ä¸º**éé™æ€å†…éƒ¨ç±»ä¼šåŒ…å«å…¶å¤–å›´å®ä¾‹çš„å¼•ç”¨**ã€‚åŒæ ·çš„ï¼Œä¹Ÿä¸å»ºè®®ä½¿ç”¨ lambdaï¼Œå› ä¸ºå®ƒä»¬å¾ˆå®¹æ˜“æ•æ‰åˆ°å¤–å›´å¯¹è±¡çš„å¼•ç”¨ã€‚

`Room` çš„ cleaner åªç”¨æ¥ä½œä¸ºå®‰å…¨ç½‘ï¼Œå¦‚æœå®¢æˆ·ç«¯å°†æ‰€æœ‰ `Room` çš„å®ä¾‹åŒ–éƒ½åŒ…åœ¨ try-with- resource å—ä¸­ï¼Œé‚£ä¹ˆ automatic cleaning å°±æ°¸è¿œä¸ä¼šå‘ç”Ÿï¼š

public class Adult {  
    public static void main(String[] args) {  
        try (Room myRoom = new Room(7)) {  
            System.out.println("Goodbye");  
        }   
    }  
}

ä¸Šé¢çš„ç¨‹åºä¼šæ‰“å°å‡º â€œGoodbyeâ€ï¼Œæ¥ç€æ˜¯ â€œCleaning roomâ€ã€‚ä½†ä¸‹é¢è¿™ä¸ªç¨‹åºï¼š

public class Teenager {  
    public static void main(String[] args) {  
        new Room(99);  
        System.out.println("Peace out");  
    }  
}

åœ¨ä½œè€…çš„æœºå™¨ä¸Šï¼Œåªæ‰“å°å‡ºäº† â€œPeace outâ€ å°±ç›´æ¥é€€å‡ºç¨‹åºã€‚è¿™å°±æ˜¯ä¹‹å‰æåˆ°çš„ä¸å¯é¢„æµ‹æ€§ã€‚Cleaner è§„èŒƒæŒ‡å‡ºï¼šâ€cleaner åœ¨ System.exit æœŸé—´çš„è¡Œä¸ºä¸å…·ä½“å®ç°æœ‰å…³ã€‚ä¸ä¿è¯ cleaning action æ˜¯å¦è¢«è°ƒç”¨ã€‚â€œ è™½ç„¶è§„èŒƒæ²¡æœ‰æŒ‡æ˜ï¼Œä½†å¯¹äºæ­£å¸¸çš„ç¨‹åºé€€å‡ºæ¥è¯´ä¹Ÿæ˜¯å¦‚æ­¤ã€‚åœ¨ä½œè€…çš„æœºå™¨ä¸Šï¼Œåœ¨ `Teenager` çš„ä¸»æ–¹æ³•ä¸­åŠ å…¥ `System.gc()` ä¸€è¡Œå°±å¯ä»¥ä½¿å®ƒåœ¨é€€å‡ºå‰æ‰“å°å‡º â€œCleaning roomâ€ï¼Œä½†ä¸èƒ½ä¿è¯ä½ åœ¨ä½ çš„æœºå™¨ä¸Šä¹Ÿèƒ½çœ‹åˆ°åŒæ ·çš„è¡Œä¸ºã€‚

### æ€»ç»“

æ€»ä¹‹ï¼Œä¸è¦ä½¿ç”¨ cleanerï¼Œæˆ–è€…åœ¨ Java 9 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ä¸è¦ä½¿ç”¨ finalizerï¼Œé™¤éä½œä¸ºå®‰å…¨ç½‘æˆ–ç»ˆæ­¢éå…³é”®çš„æœ¬åœ°èµ„æºã€‚å³ä½¿å¦‚æ­¤ï¼Œä¹Ÿè¦æ³¨æ„ä¸ç¡®å®šæ€§å’Œæ€§èƒ½æ–¹é¢çš„åæœã€‚

## 9. try-with-resources ä¼˜å…ˆäº try-finally

Java åº“ä¸­åŒ…å«äº†å¾ˆå¤šèµ„æºï¼Œè¿™äº›èµ„æºåœ¨ä½¿ç”¨è¿‡å¿…é¡»é€šè¿‡è°ƒç”¨ `close()` æ–¹æ³•æ¥æ‰‹åŠ¨å…³é—­ï¼Œä¾‹å¦‚ `InputSteam`ã€`OutputStream`å’Œ `java.sql.Connection`ã€‚å®¢æˆ·ç«¯æ€»æ˜¯ä¼šå¿˜è®°å…³é—­èµ„æºï¼Œè¿™å¯èƒ½ä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚è®¸å¤šèµ„æºéƒ½æ˜¯ä½¿ç”¨ç»ˆç»“æ–¹æ³•ä½œä¸ºå®‰å…¨ç½‘ï¼Œä½†å®ƒæ•ˆæœå¹¶ä¸ç†æƒ³ï¼ˆç¬¬ 8 æ¡ï¼‰ã€‚

### try-finally

æœ€åˆï¼Œ`try-finally` è¯­å¥æ˜¯ä¿è¯èµ„æºæ­£ç¡®å…³é—­çš„æœ€ä½³æ–¹å¼ï¼Œå³ä½¿é‡åˆ°å¼‚å¸¸æˆ–è¿”å›ä¹Ÿä¸å½±å“ï¼š

// try-finally - No longer the best way to close resources!  
static String firstLineOfFile(String path) throws IOException {   
    BufferedReader br = new BufferedReader(new FileReader(path));   
    try {  
		return br.readLine();  
    } finally {  
		br.close();  
	}  
}

ä½†æ˜¯å¦‚æœæ·»åŠ ç¬¬äºŒä¸ªèµ„æºï¼Œå°±ä¼šä¸€å›¢ç³Ÿäº†ï¼š

// try-finally is ugly when used with more than one resource!  
     
static void copy(String src, String dst) throws IOException {  
    InputStream in = new FileInputStream(src);  
    try {  
        OutputStream out = new FileOutputStream(dst);  
        try {  
            byte[] buf = new byte[BUFFER_SIZE];  
            int n;  
            while ((n = in.read(buf)) >= 0)  
                out.write(buf, 0, n);  
        } finally {  
            out.close();  
        }  
    } finally {  
        in.close();  
    }   
}

è¿™æ—¶å€™ï¼Œtry-finally çš„ä»£ç å°±å¾ˆå®¹æ˜“å‡ºé”™ã€‚å³ä¾¿ `try-finally` èƒ½æ­£ç¡®å…³é—­èµ„æºï¼Œä½†ä¹Ÿæœ‰å¾ˆå¤šä¸è¶³ã€‚try å—å’Œ finally å—çš„ä»£ç éƒ½æœ‰å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œå‡è®¾åœ¨ `firstLineOfFile()` æ–¹æ³•ä¸­ï¼Œåº•å±‚ç‰©ç†è®¾å¤‡å¼‚å¸¸ï¼Œå¯¼è‡´ `readLine()` æŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶ä¸” `close()` ä¹Ÿå› ä¸ºåŒæ ·çš„åŸå› å¤±è´¥ã€‚è¿™æ ·ï¼Œç¬¬äºŒä¸ªå¼‚å¸¸å°±ä¼šå®Œå…¨æŠ¹é™¤ç¬¬ä¸€ä¸ªå¼‚å¸¸ï¼Œå¹¶ä¸”åœ¨å¼‚å¸¸å †æ ˆä¸­å®Œå…¨æ²¡æœ‰ç¬¬ä¸€ä¸ªå¼‚å¸¸çš„è®°å½•ã€‚è¿™å°†ä¼šå¯¼è‡´å¾ˆéš¾æ‰¾å‡ºé”™è¯¯åŸå› ï¼Œå› ä¸ºåœ¨è§£å†³é—®é¢˜çš„æ—¶å€™é€šå¸¸ä¼šå…³æ³¨ç¬¬ä¸€ä¸ªå¼‚å¸¸ã€‚è™½ç„¶å¯ä»¥ç¼–å†™ä»£ç æ¥æŠ‘åˆ¶æ‰ç¬¬äºŒä¸ªå¼‚å¸¸ï¼Œä½¿å¾—æŠ›å‡ºç¬¬ä¸€ä¸ªå¼‚å¸¸ï¼Œä½†è¿™æ ·åšå¤ªéº»çƒ¦äº†ã€‚

### try-with-resource

æ‰€æœ‰è¿™äº›é—®é¢˜éƒ½å¯ä»¥é€šè¿‡ Java 7 å¼•å…¥çš„ `try-with-resources` è§£å†³ã€‚è¦ä½¿ç”¨è¿™ç§æ–¹æ³•çš„èµ„æºï¼Œå¿…é¡»å…ˆå®ç° `AutoCloseable` æ¥å£ï¼Œå…¶ä¸­åªåŒ…å«äº†ä¸€ä¸ªè¿”å› void çš„ `close` æ–¹æ³• ã€‚å¦‚æœè¦ç¼–å†™ä¸€ä¸ªä»£è¡¨**å¿…é¡»**è¢«å…³é—­çš„èµ„æºçš„ç±»ï¼Œå¿…é¡»è¦å®ç° `AutoCloseable` æ¥å£ã€‚

// try-with-resources - the the best way to close resources!  
static String firstLineOfFile(String path) throws IOException {  
    try (BufferedReader br = new BufferedReader(new FileReader(path))) {  
        return br.readLine();  
    }   
}

// try-with-resources on multiple resources - short and sweet  
static void copy(String src, String dst) throws IOException {  
    try (InputStream in = new FileInputStream(src);   
         OutputStream out = new FileOutputStream(dst)) {  
        byte[] buf = new byte[BUFFER_SIZE];  
        int n;  
        while ((n = in.read(buf)) >= 0)  
            out.write(buf, 0, n);  
    }  
}

ä½¿ç”¨ `try-with-resources` ä¸ä»…ä½¿ä»£ç å˜å¾—æ›´ç®€æ´æ˜“æ‡‚ï¼Œ ä¹Ÿæ›´å®¹æ˜“è¿›è¡Œè¯Šæ–­ ã€‚ ä»¥ `firstÂ­LineOfFile` æ–¹æ³•ä¸ºä¾‹ï¼Œå¦‚æœè°ƒç”¨ `readLine` å’Œï¼ˆä¸å¯è§çš„ï¼‰`close` æ–¹æ³•éƒ½æŠ›å‡ºå¼‚å¸¸ï¼Œåä¸€ä¸ªå¼‚å¸¸å°±ä¼šè¢«æŠ‘åˆ¶ï¼Œä»¥ä¿ç•™ç¬¬ä¸€ä¸ªå¼‚å¸¸ã€‚è¿™ç§è¢«æŠ‘åˆ¶çš„å¼‚å¸¸å¹¶ä¸æ˜¯ç®€å•åœ°è¢«æŠ›å¼ƒäº†ï¼Œè€Œæ˜¯ä¼šè¢«æ‰“å°åœ¨å †æ ˆè½¨è¿¹ä¸­ï¼Œå¹¶æ³¨æ˜å®ƒä»¬æ˜¯è¢«æŠ‘åˆ¶çš„ã€‚é€šè¿‡è°ƒç”¨ Java 7 å¼•å…¥çš„ `getSuppressed` æ–¹æ³•å¯ä»¥è®¿é—®åˆ°å®ƒä»¬ã€‚

åœ¨ `try-with-resources` è¯­å¥ä¸­è¿˜å¯ä»¥ä½¿ç”¨ **catch** å­å¥ï¼Œå°±åƒåœ¨å¹³æ—¶çš„ `try-finally` è¯­å¥ä¸­ä¸€æ ·ã€‚è¿™æ ·æ—¢å¯ä»¥å¤„ç†å¼‚å¸¸ï¼Œåˆä¸éœ€è¦å†å¥—ç”¨ä¸€å±‚ä»£ç ã€‚ä¸‹é¢è¿™ä¸ªèŒƒä¾‹ä¸­ï¼Œå¦‚æœ `firstLineOfFile` æ–¹æ³•ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä½†æ˜¯å¦‚æœå®ƒæ— æ³•æ‰“å¼€æ–‡ä»¶ï¼Œæˆ–è€…æ— æ³•ä»ä¸­è¯»å–ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ªé»˜è®¤å€¼ï¼š

// try-with-resources with a catch clause  
static String firstLineOfFile(String path, String defaultVal) {  
    try (BufferedReader br = new BufferedReader(new FileReader(path))) {  
        return br.readLine();  
    } catch (IOException e) {  
        return defaultVal;  
    }   
}

### æ€»ç»“

å¦‚æœèµ„æºå¿…é¡»è¢«å…³é—­ï¼Œé‚£ä¹ˆ `try-with-resourece` æ°¸è¿œä¼˜äº `try-catch`ã€‚äº§ç”Ÿçš„ä»£ç æ›´çŸ­æ›´æ¸…æ™°ï¼Œäº§ç”Ÿçš„å¼‚å¸¸ä¹Ÿä¼šæ›´æœ‰ç”¨ï¼Œå¹¶ä¸”ç¼–å†™ä»£ç æ—¶æ›´ä¸å®¹æ˜“å‡ºé”™ã€‚

# äºŒ. å¯¹äºæ‰€æœ‰å¯¹è±¡éƒ½é€šç”¨çš„æ–¹æ³•

## 10. è¦†ç›– equals æ—¶è¯·éµå®ˆçº¦å®š

ä»¥ä¸‹è¿™äº›æƒ…å†µä¸éœ€è¦è¦†ç›– `equals` æ–¹æ³•ï¼š

-   ç±»çš„æ¯ä¸ªå®ä¾‹æœ¬è´¨ä¸Šéƒ½æ˜¯å”¯ä¸€çš„ ã€‚å¯¹äºä»£è¡¨æ´»åŠ¨å®ä½“è€Œä¸æ˜¯å€¼çš„ç±»æ¥è¯´ç¡®å®å¦‚æ­¤ï¼Œä¾‹å¦‚ `Thread`ã€‚ `Object` æä¾›çš„ `equals` å®ç°å¯¹äºè¿™äº›ç±»æ¥è¯´æ­£æ˜¯æ­£ç¡®çš„è¡Œä¸ºã€‚
    
-   ç±»æ²¡æœ‰å¿…è¦æä¾› â€œé€»è¾‘ç›¸ç­‰â€ï¼ˆlogical equalityï¼‰çš„æµ‹è¯•åŠŸèƒ½ã€‚æ¯”å¦‚ä»£è¡¨æ­£åˆ™è¡¨è¾¾å¼çš„ `Pattern`ï¼Œè®¾è®¡è€…å¹¶ä¸è®¤ä¸ºå®¢æˆ·éœ€è¦æˆ–è€…æœŸæœ›æ£€æŸ¥ä¸¤ä¸ª `Pattern` å®ä¾‹æ˜¯å¦ä»£è¡¨åŒä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ã€‚
    
-   è¶…ç±»å·²ç»è¦†ç›–äº† `equals`ï¼Œä¸”è¶…ç±»çš„è¡Œä¸ºå¯¹äºè¿™ä¸ªç±»ä¹Ÿæ˜¯åˆé€‚çš„ã€‚
    
-   ç±»æ˜¯ç§æœ‰çš„ï¼Œæˆ–è€…æ˜¯åŒ…çº§ç§æœ‰ï¼Œå¯ä»¥ç¡®å®šå®ƒçš„ `equals` æ–¹æ³•æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ã€‚ä¹Ÿå¯ä»¥ç¡®ä¿å®ƒä¸ä¼šè¢«æ„å¤–è°ƒç”¨ï¼š
    
    @Override   
    public boolean equals(Object o) {  
    	throw new AssertionError(); // Method is never called  
    }
    
    æœç±»å…·æœ‰è‡ªå·±ç‰¹æœ‰çš„â€œé€»è¾‘ç›¸ç­‰â€( logical equality)æ¦‚å¿µ(ä¸åŒäºå¯¹è±¡ç­‰åŒçš„æ¦‚å¿µ)ï¼Œè€Œä¸”è¶…ç±»è¿˜æ²¡æœ‰è¦†ç›– equalsã€‚ è¿™é€šå¸¸å±äºâ€œå€¼ ç±»â€( value class)çš„æƒ…å½¢ ã€‚
    

## 11. è¦†ç›– equals æ—¶æ€»è¦è¦†ç›– hashcode

**åœ¨æ¯ä¸ªè¦†ç›–äº† equals æ–¹æ³•çš„ç±»ä¸­ï¼Œ éƒ½å¿…é¡»è¦†ç›– `hashCode` æ–¹æ³• ã€‚**å¦‚æœä¸è¿™æ ·åšçš„è¯ï¼Œå°±ä¼šè¿å `hashCode` çš„é€šç”¨çº¦å®šï¼Œä»è€Œå¯¼è‡´è¯¥ç±»æ— æ³•ç»“åˆæ‰€æœ‰åŸºäºæ•£åˆ—çš„é›†åˆä¸€èµ·æ­£å¸¸è¿ä½œï¼Œè¿™ç±»é›†åˆåŒ…æ‹¬ `HashMap` å’Œ `HashSet`ã€‚

ä¸‹é¢æ˜¯çº¦å®šçš„å†…å®¹ï¼Œæ‘˜è‡ª `Object` è§„èŒƒï¼š

> -   åœ¨åº”ç”¨ç¨‹åºçš„æ‰§è¡ŒæœŸé—´ï¼Œåªè¦å¯¹è±¡çš„ `equals` æ–¹æ³•çš„æ¯”è¾ƒæ“ä½œæ‰€ç”¨åˆ°çš„ä¿¡æ¯æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆå¯¹åŒä¸€ä¸ªå¯¹è±¡çš„å¤šæ¬¡è°ƒç”¨ï¼Œ `hashCode` æ–¹æ³•éƒ½å¿…é¡»å§‹ç»ˆè¿”å›åŒä¸€ä¸ªå€¼ ã€‚ åœ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸å¦ä¸€ä¸ªç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œ `hashCode` æ–¹æ³•æ‰€è¿”å›çš„å€¼å¯ä»¥ä¸ä¸€è‡´ã€‚
>     
> -   å¦‚æœä¸¤ä¸ªå¯¹è±¡æ ¹æ® `equals(Object)` æ–¹æ³•æ¯”è¾ƒæ˜¯ç›¸ç­‰çš„ï¼Œé‚£ä¹ˆè°ƒç”¨è¿™ä¸¤ä¸ªå¯¹è±¡ä¸­çš„ `hashCode` æ–¹æ³•éƒ½å¿…é¡»äº§ç”ŸåŒæ ·çš„æ•´æ•°ç»“æœã€‚
>     
> -   å¦‚æœä¸¤ä¸ªå¯¹è±¡æ ¹æ® `equals(Object)` æ–¹æ³•æ¯”è¾ƒæ˜¯ä¸ç›¸ç­‰çš„ï¼Œé‚£ä¹ˆè°ƒç”¨è¿™ä¸¤ä¸ªå¯¹è±¡ä¸­çš„ hashCode æ–¹æ³•ï¼Œåˆ™ä¸ä¸€å®šè¦æ±‚ `hashCode` æ–¹æ³•å¿…é¡»äº§ç”Ÿä¸åŒçš„ç»“æœã€‚
>     

æ²¡æœ‰è¦†ç›– `hashCode` è¿åäº†ç¬¬äºŒæ¡ã€‚å› ä¸ºé‡å†™çš„ `equals` æ–¹æ³•ï¼Œå¯èƒ½ä½¿ä¸¤ä¸ªå®ä¾‹åœ¨é€»è¾‘ä¸Šç›¸ç­‰ï¼Œä½† `hashcode` åªä¼šè¿”å›ä¸¤ä¸ªéšæœºæ•´æ•°ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œ`HashMap` æå¤§å¯èƒ½å°†è¿™ä¸¤ä¸ªå®ä¾‹æ”¾å…¥ä¸åŒçš„æ¡¶ä¸­ï¼Œå³ä½¿ç¢°å·§è½åœ¨äº†åŒä¸€ä¸ªæ¡¶ï¼Œä¹Ÿå¯ä»¥åŒæ—¶å­˜åœ¨ã€‚å› ä¸º `HashMap` ä¼šå…ˆæ£€æŸ¥å®ä¾‹çš„ `hashcode` æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸åŒå°±ä¸ä¼šå†å»æ£€éªŒ `equals`ã€‚

### æ‰‹åŠ¨ç¼–å†™

ä¸€ä¸ªç†æƒ³çš„æ•£åˆ—å‡½æ•°ä¼šä¸ºä¸åŒçš„å¯¹è±¡äº§ç”Ÿä¸ç›¸ç­‰çš„æ•£åˆ—ç ï¼Œä¸€ä¸ªååˆ†æ¥è¿‘ç†æƒ³çš„è§£å†³åŠæ³•ï¼š

1.  å£°æ˜ä¸€ä¸ª int ç±»å‹çš„å˜é‡ resultï¼Œå°†å®ƒåˆå§‹åŒ–ç¬¬ä¸€ä¸ªå…³é”®åŸŸçš„æ•£åˆ—ç ï¼ˆå…³é”®åŸŸæŒ‡çš„æ˜¯å½±å“ equlas æ¯”è¾ƒçš„åŸŸï¼‰ã€‚
    
2.  å¯¹å‰©ä¸‹çš„æ¯ä¸€ä¸ªå…³é”®åŸŸå®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š
    
    1.  è®¡ç®—è¯¥åŸŸçš„æ•£åˆ—ç  cï¼š
        
        1.  å¦‚æœè¯¥åŸŸæ˜¯åŸºæœ¬ç±»å‹ï¼Œè®¡ç®— `Type.hashCode()`ï¼Œè¿™é‡Œçš„ Type æ˜¯åŸºæœ¬ç±»å‹å¯¹åº”çš„è£…ç®±åŸºæœ¬ç±»å‹ï¼›
            
        2.  å¦‚æœè¯¥åŸŸæ˜¯ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œå¹¶ä¸”è¯¥ç±»çš„ `equals` æ–¹æ³•é€šè¿‡é€’å½’åœ°è°ƒç”¨ `equals` çš„æ–¹å¼æ¥æ¯”è¾ƒè¿™ä¸ªåŸŸï¼Œåˆ™åŒæ ·ä¸ºè¿™ä¸ªåŸŸé€’å½’åœ°è°ƒç”¨ `hashCode`ã€‚ å¦‚æœéœ€è¦æ›´å¤æ‚çš„æ¯”è¾ƒï¼Œåˆ™ä¸ºè¿™ä¸ªåŸŸè®¡ç®—ä¸€ä¸ªâ€œèŒƒå¼â€ï¼ˆcanonical representationï¼‰ï¼Œç„¶åé’ˆå¯¹è¿™ä¸ªèŒƒå¼è°ƒç”¨ `hashCode`ã€‚ å¦‚æœè¿™ä¸ªåŸŸçš„å€¼ä¸º nullï¼Œ åˆ™è¿”å›ä¸€ä¸ªå¸¸æ•°ï¼Œé€šå¸¸æ˜¯ 0ã€‚
            
            > -    ä¸æ‡‚èŒƒå¼å•¥æ„æ€ã€‚
            
        3.  å¦‚æœè¯¥åŸŸæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ™è¦æŠŠæ¯ä¸€ä¸ªå…ƒç´ å½“ä½œå•ç‹¬çš„åŸŸæ¥å¤„ç†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé€’å½’åœ°åº”ç”¨ä¸Šè¿°è§„åˆ™ï¼Œå¯¹æ¯ä¸ªé‡è¦çš„å…ƒç´ è®¡ç®—ä¸€ ä¸ªæ•£åˆ—ç ï¼Œç„¶åæ ¹æ®æ­¥éª¤ 2.2 ä¸­çš„åšæ³•æŠŠè¿™äº›æ•£åˆ—å€¼ç»„åˆèµ·æ¥ã€‚å¦‚æœæ•°ç»„åŸŸä¸­æ²¡æœ‰é‡è¦çš„å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå¸¸é‡ï¼Œä½†æœ€å¥½ä¸è¦ç”¨ 0ã€‚ å¦‚æœæ•°ç»„åŸŸä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½å¾ˆé‡è¦ï¼Œå¯ä»¥ä½¿ç”¨ Arrays.hashCodeæ–¹æ³•ã€‚
            
    2.  å°† 2.1 ä¸­è®¡ç®—å¾—åˆ°çš„æ•£åˆ—ç  c åˆå¹¶åˆ° result ä¸­ï¼š`result = 31 * result + c;`ã€‚
        
3.  è¿”å› `result`ã€‚
    

**æ³¨æ„ï¼š**

-   è®¡ç®—æ•£åˆ—ç çš„æ—¶å€™ï¼Œå¯ä»¥æŠŠè¡ç”ŸåŸŸï¼ˆderived fieldï¼‰æ’é™¤åœ¨å¤–ã€‚
    
-   å¿…é¡»æ’é™¤ equals æ¯”è¾ƒè®¡ç®—ä¸­æ²¡ç”¨åˆ°çš„ä»»ä½•åŸŸï¼Œå¦åˆ™å¯èƒ½è¿å hashCode çº¦å®šçš„ç¬¬äºŒæ¡ã€‚
    
-   ä¸è¦è¯•å›¾ä»æ•£åˆ—ç è®¡ç®—ä¸­æ’å‡ºä¸€ä¸ªå¯¹è±¡çš„**å…³é”®åŸŸ**ï¼Œè™½ç„¶æ•£åˆ—å‡½æ•°è¿è¡Œæ›´å¿«ï¼Œä½†å½“æ•£åˆ—è¡¨é¢å¯¹å¤§é‡çš„å®ä¾‹æ—¶å¯èƒ½ä¼šå˜å¾—ååˆ†æ…¢ã€‚
    

æ­¥éª¤ 2.2 çš„ä¹˜æ³•éƒ¨åˆ†ä½¿å¾—æ•£åˆ—å€¼ä¼šä¾èµ–åŸŸçš„é¡ºåºï¼Œå¦åˆ™åªæ˜¯å­—æ¯é¡ºåºçš„ä¸åŒçš„ `String` ä¹Ÿä¼šè¿”å›ç›¸åŒçš„æ•£åˆ—ç ã€‚ä¹‹æ‰€ä»¥é€‰æ‹© 31 ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¥‡ç´ æ•°ã€‚å¦‚æœä¹˜æ•°æ˜¯å¶æ•°ï¼Œå¹¶ä¸”ä¹˜æ³•æº¢å‡ºçš„è¯ï¼Œä¿¡æ¯å°±ä¼šä¸¢å¤±ï¼Œå› ä¸ºä¸ 2 ç›¸ä¹˜ç­‰ä»·äºç§»ä½è¿ç®—ã€‚ä½¿ç”¨ç´ æ•°çš„å¥½å¤„å¹¶ä¸å¾ˆæ˜æ˜¾ï¼Œä½†æ˜¯ä¹ æƒ¯ä¸Šéƒ½ä½¿ç”¨ç´ æ•°æ¥è®¡ç®—æ•£åˆ—ç»“æœã€‚31 æœ‰ä¸ªå¾ˆå¥½çš„ç‰¹æ€§ï¼Œå³ç”¨ç§»ä½å’Œå‡æ³•æ¥ä»£æ›¿ä¹˜æ³•ï¼Œå¯ä»¥å¾—åˆ°æ›´å¥½çš„æ€§èƒ½ï¼š `31 * i = = ( i << 5 ) - i`ã€‚ ç°ä»£çš„è™šæ‹Ÿæœºå¯ä»¥è‡ªåŠ¨å®Œæˆè¿™ç§ä¼˜åŒ– ã€‚

### å…¶ä»–æ–¹æ¡ˆ

å¦‚æœæƒ³ç”¨æ›´å¥½çš„æ•£åˆ—å‡½æ•°ï¼Œå‚é˜…ï¼šGuavaâ€™s com.google.common.hash.Hashing [Guava]ã€‚

`Objects` çš„é™æ€æ–¹æ³• `hash()` æ¥æ”¶ä»»æ„æ•°é‡çš„å‚æ•°å¹¶è¿”å›ä¸€ä¸ªæ•£åˆ—ç ã€‚ä¸æ‰‹åŠ¨ç¼–å†™çš„æ–¹æ¡ˆè´¨é‡ç›¸å½“ï¼Œä½†è¿è¡Œé€Ÿåº¦æ…¢ä¸€äº›ï¼Œå› ä¸ºä¼šæœ‰æ•°ç»„çš„åˆ›å»ºã€‚è€Œä¸”å¦‚æœå‚æ•°æœ‰åŸºæœ¬ç±»å‹ï¼Œè¿˜éœ€è¦è£…ç®±å’Œæ‹†ç®±ã€‚

### ç¼“å­˜æ•£åˆ—ç 

å¦‚æœç±»æ˜¯ä¸å¯å˜çš„ï¼Œä¸”è®¡ç®—æ•£åˆ—ç å¼€é”€è¾ƒå¤§ï¼Œå¯ä»¥å°†æ•£åˆ—ç ç¼“å­˜åœ¨å¯¹è±¡å†…éƒ¨ã€‚å¦‚æœè¿™ä¸ªç±»çš„å¤§å¤šæ•°å®ä¾‹éƒ½ä¼šç”¨æ¥ä½œä¸ºæ•£åˆ—é”®ï¼ˆhash keyï¼‰ï¼Œå°±åº”è¯¥åœ¨åˆ›å»ºå®ä¾‹çš„æ—¶å€™è®¡ç®—æ•£åˆ—ç ã€‚å¦åˆ™å¯ä»¥é€‰æ‹©å»¶è¿Ÿåˆå§‹åŒ–æ•£åˆ—ç ã€‚

## 12. å§‹ç»ˆè¦è¦†ç›– toString

`Object` æä¾›çš„ `toString` æ–¹æ³•è¿”å›ç±»ååŠ  @ å†åŠ ä¸Šæ•£åˆ—ç çš„æ— ç¬¦å·åå…­è¿›åˆ¶ã€‚

åœ¨é™æ€å·¥å…·ç±»ï¼ˆè¯¦è§ç¬¬ 4 æ¡ï¼‰ä¸­ç¼–å†™ `toString` æ–¹æ³•æ˜¯æ²¡æœ‰æ„ä¹‰çš„ ã€‚ ä¹Ÿä¸è¦åœ¨å¤§å¤šæ•°æšä¸¾ç±»å‹ï¼ˆè¯¦è§ç¬¬ 34 æ¡ï¼‰ä¸­ç¼–å†™ `toString` æ–¹æ³•ï¼Œå› ä¸º Java å·²ç»ä¸ºä½ æä¾›äº†éå¸¸å®Œç¾çš„æ–¹æ³• ã€‚ ä½†æ˜¯ï¼Œåœ¨æ‰€æœ‰å…¶å­ç±»å…±äº«é€šç”¨å­—ç¬¦ä¸²è¡¨ç¤ºæ³•çš„æŠ½è±¡ç±»ä¸­ï¼Œä¸€å®šè¦ç¼–å†™ä¸€ä¸ª `toString` æ–¹æ³• ã€‚ ä¾‹å¦‚ï¼Œå¤§å¤šæ•°é›†åˆå®ç°ä¸­çš„ `toString` æ–¹æ³•éƒ½æ˜¯ç»§æ‰¿è‡ªæŠ½è±¡çš„é›†åˆç±» ã€‚

## 13. è°¨æ…åœ°è¦†ç›– clone

`Cloneable` æ¥å£çš„ç›®çš„æ˜¯ä½œä¸ºå¯¹è±¡çš„ä¸€ä¸ª _minxin_ æ¥å£ï¼ˆè¯¦è§ç¬¬ 20 æ¡ï¼‰ï¼Œè¡¨æ˜è¿™æ ·çš„å¯¹è±¡å…è®¸å…‹éš†ã€‚è¿™ä¸ªæ¥å£å¹¶ä¸åŒ…å« `clone` æ–¹æ³•ï¼Œè€Œ `Object` çš„ `clone` æ–¹æ³•æ˜¯å—ä¿æŠ¤ï¼ˆæ„æ€æ˜¯ native çš„ï¼Ÿï¼‰çš„ã€‚å®ƒçš„ä½œç”¨æ˜¯ï¼šå¦‚æœä¸€ä¸ªç±»å®ç°äº† `Cloneable`ï¼Œ`Object` çš„ `clone` æ–¹æ³•å°±è¿”å›è¯¥å¯¹è±¡çš„é€åŸŸæ‹·è´ï¼Œå¦åˆ™å°±ä¼šæŠ›å‡º `CloneNotSupportedException` å¼‚å¸¸ã€‚

> é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ç°æ¥å£æ˜¯ä¸ºäº†è¡¨æ˜ç±»å¯ä»¥ä¸ºå®ƒçš„å®¢æˆ·åšäº›ä»€ä¹ˆã€‚ç„¶è€Œï¼Œå¯¹äº `Cloneable` æ¥å£ï¼Œå®ƒæ”¹å˜äº†è¶…ç±»ä¸­å—ä¿æŠ¤çš„æ–¹æ³•çš„è¡Œä¸º ã€‚

è™½ç„¶è§„èŒƒä¸­æ²¡æœ‰æ˜ç¡®æŒ‡å‡ºï¼Œäº‹å®ä¸Šï¼Œ**å®ç° `Cloneable` æ¥å£çš„ç±»æ˜¯ä¸ºäº†æä¾›ä¸€ä¸ªåŠŸèƒ½é€‚å½“çš„å…¬æœ‰çš„ `clone` æ–¹æ³•**ï¼Œç”±æ­¤å¾—åˆ°ä¸€ç§è¯­è¨€ä¹‹å¤–çš„æœºåˆ¶ï¼šå®ƒæ— é¡»è°ƒç”¨æ„é€ å™¨å°±å¯ä»¥åˆ›å»ºå¯¹è±¡ ã€‚

> ä¸‹é¢æ˜¯æ¥è‡ª Object è§„èŒƒä¸­çš„çº¦å®šå†…å®¹ï¼š
> 
> 1.  `x.clone() != x` è¿”å› true
>     
> 2.  `x.clone().getClass() == x.getClass` è¿”å› true
>     
> 3.  `x.clone().equals(x)` è¿”å› true
>     
> 
> è¿™äº›éƒ½ä¸æ˜¯ç»å¯¹çš„è¦æ±‚

TODO

# ä¸‰. ç±»å’Œæ¥å£

## 15. ä½¿ç±»å’Œæˆå‘˜çš„å¯è®¿é—®æ€§æœ€å°åŒ–

### ä¿¡æ¯éšè—

åŒºåˆ«ç»„ä»¶è®¾è®¡å¥½åçš„æœ€é‡è¦å› ç´ å°±æ˜¯ï¼šç»„ä»¶å¯¹å…¶ä»–ç»„ä»¶éšè—å…¶å†…éƒ¨æ•°æ®å’Œå…¶ä»–å®ç°ç»†èŠ‚çš„ç¨‹åº¦ã€‚è®¾è®¡è‰¯å¥½çš„ç»„ä»¶å°†å®ƒæ‰€æœ‰çš„å®ç°ç»†èŠ‚éƒ½éšè—èµ·æ¥ï¼Œå°† API å’Œå®ƒçš„å®ç°å¹²å‡€åœ°åˆ†å¼€ã€‚ä¹‹åï¼Œç»„ä»¶ç›´æ¥åªé€šè¿‡å®ƒä»¬çš„ API é€šä¿¡ï¼Œå¹¶ä¸”éƒ½ä¸çŸ¥é“å¯¹æ–¹å†…éƒ¨æ‰€åšçš„å·¥ä½œã€‚è¿™ä¸ªæ¦‚å¿µè¢«ç§°ä¸º**ä¿¡æ¯éšè—**æˆ–**å°è£…**ï¼Œæ˜¯è½¯ä»¶è®¾è®¡çš„ä¸€ä¸ªåŸºæœ¬åŸåˆ™ã€‚

ä¿¡æ¯éšè—çš„æœ€å¤§åŸå› å°±æ˜¯å®ƒå¯ä»¥å°†ç³»ç»Ÿç»„ä»¶è§£è€¦ï¼Œä½¿å®ƒä»¬å¯ä»¥è¢«å¼€å‘ã€æµ‹è¯•ã€ä¼˜åŒ–ã€ä½¿ç”¨ã€ç†è§£å’Œç‹¬ç«‹ä¿®æ”¹ã€‚è¿™åŠ é€Ÿäº†ç³»ç»Ÿçš„å¼€å‘ï¼Œå› ä¸ºç»„ä»¶å¯ä»¥å¹¶è¡Œå¼€å‘ã€‚å®ƒä¹Ÿå‡è½»äº†ç»´æŠ¤çš„è´Ÿæ‹…ï¼Œå› ä¸ºç»„ä»¶å®¹æ˜“ç†è§£ã€è°ƒè¯•å’Œæ›¿æ¢ã€‚è™½ç„¶ä¿¡æ¯éšè—æœ¬èº«å¹¶ä¸èƒ½å¸¦æ¥è‰¯å¥½çš„æ€§èƒ½ï¼Œä½†å®ƒå¯ä»¥å®ç°æœ‰æ•ˆçš„æ€§èƒ½è°ƒæ•´ï¼šä¸€æ—¦ç³»ç»Ÿå®Œæˆï¼Œå¹¶ä¸”å‰–æç¡®å®šäº†å“ªäº›ç»„ä»¶å¯¼è‡´äº†æ€§èƒ½é—®é¢˜ï¼ˆè¯¦è§ç¬¬ 67 æ¡ï¼‰ï¼Œè¿™äº›ç»„ä»¶å°±å¯ä»¥è¢«ä¼˜åŒ–è€Œä¸å½±å“å…¶ä»–ç»„ä»¶çš„æ­£ç¡®æ€§ã€‚ä¿¡æ¯éšè—æé«˜äº†è½¯ä»¶çš„å¯å¤ç”¨æ€§ã€‚æœ€åï¼Œä¿¡æ¯éšè—å‡å°‘äº†æ„å»ºå¤§å‹ç³»ç»Ÿçš„é£é™©ï¼Œå› ä¸ºå³ä½¿ç³»ç»Ÿä¸æˆåŠŸï¼Œå•ä¸ªç»„ä»¶ä¹Ÿå¯èƒ½è¢«è¯æ˜æ˜¯æˆåŠŸçš„ã€‚

**å°½å¯èƒ½ä½¿æ¯ä¸ªç±»æˆ–è€…æˆå‘˜ä¸è¢«å¤–ç•Œè®¿é—®**ï¼Œä¹Ÿå°±æ˜¯è¯´å°†è®¿é—®çº§åˆ«é™åˆ°æœ€ä½ã€‚

### ç±»

å¯¹äºé¡¶å±‚çš„ï¼ˆtop-level or non-nestedï¼‰ç±»å’Œæ¥å£ï¼Œåªæœ‰ä¸¤ç§è®¿é—®çº§åˆ«ï¼špackage-private å’Œ publicã€‚å¦‚æœé¡¶å±‚çš„çš„ç±»æˆ–è€…æ¥å£å¯ä»¥æ˜¯ package-private çš„ï¼Œé‚£ä¹ˆå®ƒå°±åº”è¯¥æ˜¯ package-privateï¼Œè¿™æ ·å®ƒå°±æˆä¸ºäº†å®ç°çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯ exported APIã€‚å¹¶ä¸”åœ¨ä¹‹åçš„ç‰ˆæœ¬ä¸­å¯¹å®ƒä¿®æ”¹ã€æ›¿æ¢æˆ–è€…åˆ é™¤ï¼Œéƒ½ä¸ä¼šç ´åå®¢æˆ·ç«¯ã€‚ä½†å¦‚æœå®ƒæ˜¯ publicï¼Œå°±æœ‰ä¹‰åŠ¡æ°¸è¿œç»´æŠ¤å…¼å®¹æ€§ã€‚

å¦‚æœä¸€ä¸ª package-private çš„é¡¶å±‚ç±»æˆ–è€…æ¥å£**åªæ˜¯**åœ¨æŸä¸€ä¸ªç±»çš„å†…éƒ¨è¢«ç”¨åˆ°ï¼Œå°±åº”è¯¥è€ƒè™‘ä½¿å®ƒæˆä¸ºå”¯ä¸€ä½¿ç”¨å®ƒçš„é‚£ä¸ªç±»çš„ private static åµŒå¥—ç±»ï¼ˆè¯¦è§ç¬¬ 24 æ¡ï¼‰ï¼Œå°†å®ƒçš„å¯è®¿é—®èŒƒå›´ç¼©å°åˆ°ä½¿ç”¨å®ƒçš„é‚£ä¸ªç±»ã€‚ç„¶è€Œï¼Œé™ä½ä¸å¿…è¦ public ç±»çš„å¯è®¿é—®æ€§é‡è¦çš„å¤šï¼šå› ä¸º public ç±»æ˜¯åŒ…çš„ API çš„ä¸€éƒ¨åˆ†ï¼Œè€Œ package-private çš„é¡¶å±‚ç±»æ˜¯è¿™ä¸ªåŒ…çš„å®ç°çš„ä¸€éƒ¨åˆ† ã€‚

### æˆå‘˜ï¼ˆåŸŸã€æ–¹æ³•ã€åµŒå¥—ç±»å’ŒåµŒå¥—æ¥å£ï¼‰

-   ç§æœ‰çš„ï¼ˆprivateï¼‰ï¼šåªæœ‰åœ¨å£°æ˜è¯¥æˆå‘˜çš„é¡¶å±‚ç±»å†…éƒ¨ï¼ˆå†…éƒ¨åŒ…æ‹¬åµŒå¥—ç±»ï¼‰æ‰å¯ä»¥è®¿é—®è¿™ä¸ªæˆå‘˜ã€‚
    
-   åŒ…çº§ç§æœ‰çš„ï¼ˆpackage-privateï¼‰ï¼šå£°æ˜è¯¥æˆå‘˜çš„åŒ…å†…éƒ¨çš„ä»»ä½•ç±»éƒ½å¯ä»¥è®¿é—®ã€‚ï¼ˆæ¥å£æˆå‘˜å¦‚æœä¸æŒ‡å®šè®¿é—®çº§åˆ«ï¼Œé»˜è®¤æ˜¯å…¬æœ‰çš„ï¼‰
    
-   å—ä¿æŠ¤çš„ï¼ˆprotectedï¼‰ï¼šå£°æ˜è¯¥æˆå‘˜çš„ç±»çš„å­ç±»å’Œæ‰€åœ¨åŒ…å†…éƒ¨çš„ä»»ä½•ç±»å¯ä»¥è®¿é—®ã€‚
    
-   å…¬æœ‰çš„ï¼ˆpublicï¼‰
    

private å’Œ package-private æˆå‘˜éƒ½æ˜¯ä¸€ä¸ªç±»çš„å®ç°ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œä¸€èˆ¬ä¸ä¼šå½±å“å¯¼å‡ºçš„ APIã€‚ç„¶è€Œï¼Œå¦‚æœè¿™ä¸ªç±»å®ç°äº† `Serializable` æ¥å£ï¼ˆè¯¦è§ç¬¬ 86 æ¡å’Œç¬¬ 87 æ¡ï¼‰ï¼Œè¿™äº›åŸŸå°±æœ‰å¯èƒ½è¢«æ³„éœ²åˆ°å¯¼å‡ºçš„ API ä¸­ã€‚

å¯¹äºå…¬æœ‰ç±»çš„æˆå‘˜ï¼Œprotected æˆå‘˜æ˜¯ç±»å¯¼å‡ºçš„ API çš„ä¸€éƒ¨åˆ†ï¼Œå¿…é¡»æ°¸è¿œå¾—åˆ°çš„æ”¯æŒã€‚å¯¼å‡ºçš„ç±»çš„å—ä¿æŠ¤æˆå‘˜ä¹Ÿä»£è¡¨äº†è¯¥ç±»å¯¹äºæŸä¸ªå®ç°ç»†èŠ‚çš„å…¬å¼€æ‰¿è¯ºï¼ˆè¯¦è§ç¬¬ 19 æ¡ï¼‰ã€‚åº”è¯¥å°½é‡å°‘ç”¨ protected æˆå‘˜ã€‚

å¦‚æœæ–¹æ³•è¦†ç›–äº†è¶…ç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œ å­ç±»ä¸­çš„è®¿é—®çº§åˆ«å°±ä¸å…è®¸ä½äºè¶…ç±»ä¸­çš„è®¿é—®çº§åˆ«ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ä»»ä½•å¯ä½¿ç”¨è¶…ç±»çš„å®ä¾‹çš„åœ°æ–¹ä¹Ÿéƒ½å¯ä»¥ä½¿ç”¨å­ç±»çš„å®ä¾‹ï¼ˆé‡Œæ°æ›¿æ¢åŸåˆ™ï¼Œè¯¦è§ç¬¬ 10 æ¡ï¼‰ã€‚è¿™æ¡è§„åˆ™æœ‰ä¸€ä¸ªç‰¹ä¾‹ï¼šå¦‚æœä¸€ä¸ªç±»å®ç°äº†ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆç±»æ‰€å®ç°çš„æ¥å£æ–¹æ³•å¿…é¡»å£°æ˜ä¸º publicã€‚

ä¸ºäº†æµ‹è¯•ï¼Œå¯ä»¥å°† public ç±»çš„ private å˜æˆ package-privateï¼Œä½†æœ€å¥½ä¸è¦è¶…è¿‡ pacakge-privateã€‚

> æµ‹è¯•ç±»å¯ä»¥å½“ä½œè¢«æµ‹è¯•ç±»æ˜¯åŒä¸€ä¸ªåŒ…ï¼Œæ‰€ä»¥èƒ½è®¿é—®è¢«æµ‹è¯•ç±» package-private æˆå‘˜ã€‚

**public ç±»ä¸åº”è¯¥æœ‰ä»»ä½• public å®ä¾‹åŸŸ** ï¼ˆè¯¦è§ç¬¬ 16 æ¡ï¼‰ï¼š

-   å¦‚æœå®ä¾‹åŸŸæ˜¯é `final` çš„ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæŒ‡å‘å¯å˜å¯¹è±¡çš„ `final` å¼•ç”¨ï¼Œ é‚£ä¹ˆä¸€æ—¦ä½¿è¿™ä¸ªåŸŸæˆä¸º public çš„ï¼Œé‚£ä¹ˆå®ƒèƒ½åœ¨ä»»ä½•åœ°æ–¹è¢«ä¿®æ”¹ã€‚å› æ­¤ï¼ŒåŒ…å« public å¯å˜åŸŸçš„ç±»é€šå¸¸å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
    
-   å³ä½¿åŸŸæ˜¯ `final` çš„ï¼Œå¹¶ä¸”å¼•ç”¨ä¸å¯å˜çš„å¯¹è±¡ï¼Œä½†å½“æŠŠè¿™ä¸ªåŸŸå˜æˆ public çš„æ—¶å€™ï¼Œä¹Ÿå°±æ”¾å¼ƒäº†â€œåˆ‡æ¢åˆ°ä¸€ç§æ–°çš„å†…éƒ¨æ•°æ®è¡¨ç¤ºæ³•â€ çš„çµæ´»æ€§ ã€‚
    

è¿™æ¡å»ºè®®ä¹ŸåŒæ ·**é€‚ç”¨äº static åŸŸ**ï¼Œåªæ˜¯æœ‰ä¸€ç§æƒ…å†µä¾‹å¤–ã€‚å‡è®¾å¸¸é‡æ„æˆäº†ç±»æä¾›çš„æ•´ä¸ªæŠ½è±¡ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥é€šè¿‡ `public static final` åŸŸæ¥æš´éœ²è¿™äº›å¸¸é‡ã€‚æŒ‰æƒ¯ä¾‹ï¼Œè¿™ç§åŸŸçš„åç§°ç”±å¤§å†™å­—æ¯ç»„æˆ ï¼Œå•è¯ä¹‹é—´ç”¨ä¸‹åˆ’çº¿éš”å¼€ï¼ˆè¯¦è§ç¬¬ 68 æ¡ï¼‰ã€‚å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™äº›åŸŸ**è¦ä¹ˆæ˜¯åŸºæœ¬ç±»å‹ï¼Œè¦ä¹ˆæ˜¯æŒ‡å‘ä¸å¯å˜å¯¹è±¡çš„å¼•ç”¨**ï¼ˆè¯¦è§ç¬¬ 17 æ¡ï¼‰ã€‚å¦‚æœ `final` åŸŸåŒ…å«å¯å˜å¯¹è±¡çš„å¼•ç”¨ï¼Œå®ƒä¾¿å…·æœ‰é `final` åŸŸçš„æ‰€æœ‰ç¼ºç‚¹ã€‚**è™½ç„¶å¼•ç”¨æœ¬èº«ä¸èƒ½è¢«ä¿®æ”¹ï¼Œä½†æ˜¯å®ƒæ‰€å¼•ç”¨çš„å¯¹è±¡å´å¯ä»¥è¢«ä¿®æ”¹**ï¼Œè¿™ä¼šå¯¼è‡´ç¾éš¾æ€§çš„åæœ ã€‚

æ³¨æ„ï¼Œé•¿åº¦éé›¶çš„æ•°ç»„æ€»æ˜¯å¯å˜çš„ï¼Œæ‰€ä»¥è®©ç±»å…·æœ‰ `public static final` æ•°ç»„åŸŸï¼Œæˆ–è€…è¿”å›è¿™ç§åŸŸçš„è®¿é—®æ–¹æ³•ï¼Œè¿™æ˜¯é”™è¯¯çš„ã€‚å¦‚æœç±»å…·æœ‰è¿™æ ·çš„åŸŸæˆ–è€…è®¿é—®æ–¹æ³•ï¼Œå®¢æˆ·ç«¯å°†èƒ½å¤Ÿä¿®æ”¹æ•°ç»„ä¸­çš„å†…å®¹ã€‚ è¿™æ˜¯å®‰å…¨æ¼æ´çš„ä¸€ä¸ªå¸¸è§æ ¹æºï¼š

// Potential security hole!  
public static final Thing[] VALUES= { .. . };

ä¿®æ­£è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§æ–¹æ³•ã€‚å¯ä»¥ä½¿ public æ•°ç»„å˜æˆ private çš„ï¼Œå¹¶å¢åŠ ä¸€ä¸ª public çš„ä¸å¯å˜åˆ—è¡¨ï¼Œæˆ–è€…æ·»åŠ ä¸€ä¸ª public æ–¹æ³•è¿”å› private æ•°ç»„çš„ä¸€ä¸ªæ‹·è´ï¼š

// 1.  
private static final Thing[] PRIVATE_VALUES = { ... };   
public static final List<Thing> VALUES = Collections.unmodifiableList(Arrays.aslist(PRIVATE_VALUES));  
  
// 2.  
private static final Thing[] PRIVATE_VALUES = { ... };  
public static final Thing[] values() {return PRIVATE_VALUES.clone();}

é™¤äº† `public static final` åŸŸçš„ç‰¹æ®Šæƒ…å½¢ä¹‹å¤–ï¼ˆæ­¤æ—¶å®ƒä»¬å……å½“å¸¸é‡ï¼‰ï¼Œ**å…¬æœ‰ç±»éƒ½ä¸åº”è¯¥åŒ…å«å…¬æœ‰åŸŸ**ï¼Œå¹¶ä¸”è¦ç¡®ä¿å…¬æœ‰é™æ€ `final` åŸŸæ‰€å¼•ç”¨çš„å¯¹è±¡éƒ½æ˜¯ä¸å¯å˜çš„ ã€‚

### æ¨¡å—ç³»ç»Ÿ

> TODOï¼šæ„Ÿè§‰ä¸ç”¨çœ‹ï¼Œè€Œä¸”ä¹Ÿæ²¡çœ‹æ‡‚ã€‚

Java 9 å¼•å…¥äº†ä¸¤ä¸ªé¢å¤–çš„ã€éšå«çš„è®¿é—®çº§åˆ«ï¼Œä½œä¸ºæ¨¡å—ç³»ç»Ÿï¼ˆmodule systemï¼‰çš„ä¸€éƒ¨åˆ†ã€‚æ¨¡å—æ˜¯ä¸€ç»„åŒ…ï¼Œå°±åƒåŒ…æ˜¯ä¸€ç»„ç±»ä¸€æ ·ã€‚ä¸€ä¸ªæ¨¡å—å¯ä»¥é€šè¿‡æ¨¡å—å£°æ˜ï¼ˆmodule declarationï¼‰ä¸­çš„å¯¼å‡ºå£°æ˜ï¼ˆexport declarationsï¼‰æ˜¾å¼å¯¼å‡ºä¸€éƒ¨åˆ†åŒ…ï¼ˆæŒ‰ç…§æƒ¯ä¾‹ï¼Œæ¨¡å—å£°æ˜åŒ…å«åœ¨ä¸€ä¸ªåä¸º module-info.java çš„æºæ–‡ä»¶ä¸­ï¼‰ã€‚æ¨¡å—ä¸­æœªå¯¼å‡ºçš„ public å’Œ protected æˆå‘˜åœ¨æ¨¡å—å¤–æ— æ³•è¢«è®¿é—®ï¼›åœ¨æ¨¡å—å†…éƒ¨ï¼Œå¯è®¿é—®æ€§ä¸å—å¯¼å‡ºå£°æ˜å½±å“ã€‚ä½¿ç”¨æ¨¡å—ç³»ç»Ÿå…è®¸ä½ åœ¨ä¸€ä¸ªæ¨¡å—å†…çš„åŒ…ä¹‹é—´å…±äº«ç±»ï¼Œè€Œä¸ä½¿å®ƒä»¬å¯¹æ‰€æœ‰äººå¯è§ã€‚åœ¨æœªå¯¼å‡ºçš„åŒ…ä¸­ï¼Œpublic ç±»çš„ public æˆå‘˜å’Œ portected æˆå‘˜äº§ç”Ÿäº†ä¸¤ä¸ªéšå«çš„è®¿é—®çº§åˆ«ï¼Œå®ƒä»¬æ˜¯ intramodular analogues of the normal public and protected levelsã€‚å¯¹è¿™ç§å…±äº«çš„éœ€æ±‚ç›¸å¯¹è¾ƒå°‘ï¼Œé€šå¸¸å¯ä»¥é€šè¿‡é‡æ–°å®‰æ’åŒ…ä¸­çš„ç±»æ¥æ¶ˆé™¤ã€‚

ä¸å››ä¸ªä¸»è¦çš„è®¿é—®çº§åˆ«ä¸åŒï¼Œä¸¤ä¸ªåŸºäºæ¨¡å—çš„çº§åˆ«ä¸»è¦æ˜¯å’¨è¯¢æ€§çš„ï¼ˆadvisoryï¼‰ã€‚å¦‚æœä½ æŠŠæ¨¡å—çš„ JAR æ–‡ä»¶æ”¾åœ¨åº”ç”¨ç¨‹åºçš„ç±»è·¯å¾„ï¼ˆclass pathï¼‰ä¸Šï¼Œè€Œä¸æ˜¯æ¨¡å—è·¯å¾„ï¼ˆmodule pathï¼‰ä¸Šï¼Œé‚£ä¹ˆæ¨¡å—ä¸­çš„åŒ…å°±ä¼šæ¢å¤åˆ°å®ƒä»¬çš„éæ¨¡å—åŒ–è¡Œä¸ºï¼šåŒ…çš„ public ç±»ä¸­çš„æ‰€æœ‰ public æˆå‘˜å’Œ protected æˆå‘˜éƒ½å…·æœ‰æ­£å¸¸çš„å¯è®¿é—®æ€§ï¼Œæ— è®ºè¿™äº›åŒ…æ˜¯å¦è¢«æ¨¡å—å¯¼å‡ºã€‚è¿™ä¸¤ä¸ªæ–°å¼•å…¥çš„è®¿é—®çº§åˆ«è¢«ä¸¥æ ¼æ‰§è¡Œçš„åœ°æ–¹æ˜¯ JDK è‡ªå·±ï¼šJava åº“ä¸­æœªå¯¼å‡ºçš„åŒ…åœ¨å…¶æ¨¡å—ä¹‹å¤–æ˜¯çœŸæ­£ä¸å¯è®¿é—®çš„ã€‚

å¯¹äºå…¸å‹çš„ Java ç¨‹åºå‘˜æ¥è¯´ï¼Œæ¨¡å—æ‰€æä¾›çš„è®¿é—®ä¿æŠ¤ä¸ä»…ä½œç”¨æœ‰é™ï¼Œè€Œä¸”åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯å’¨è¯¢æ€§è´¨çš„ï¼›ä¸ºäº†åˆ©ç”¨å®ƒï¼Œä½ å¿…é¡»å°†ä½ çš„åŒ…å½’å…¥æ¨¡å—ï¼Œåœ¨æ¨¡å—å£°æ˜ä¸­æ˜ç¡®å®ƒä»¬çš„æ‰€æœ‰ä¾èµ–å…³ç³»ï¼Œé‡æ–°å®‰æ’ä½ çš„æºä»£ç æ ‘ï¼Œå¹¶é‡‡å–ç‰¹åˆ«çš„è¡ŒåŠ¨æ¥é€‚åº”ä»ä½ çš„æ¨¡å—ä¸­å¯¹éæ¨¡å—åŒ–åŒ…çš„ä»»ä½•è®¿é—®ã€‚ç°åœ¨è¯´æ¨¡å—æ˜¯å¦ä¼šåœ¨ JDK ä¹‹å¤–å¾—åˆ°å¹¿æ³›ä½¿ç”¨è¿˜ä¸ºæ—¶è¿‡æ—©ã€‚åŒæ—¶ï¼Œé™¤éæœ‰ä»¤äººä¿¡æœçš„éœ€è¦ï¼Œå¦åˆ™æœ€å¥½é¿å…ä½¿ç”¨å®ƒä»¬ã€‚

## 16. åœ¨ public ç±»ä¸­ä½¿ç”¨è®¿é—®æ–¹æ³•ï¼Œè€Œä¸æ˜¯ public åŸŸ

ä¸‹é¢è¿™ç§ç±»ï¼Œé™¤äº†ç”¨äºå°†åŸŸç»„åˆåœ¨ä¸€èµ·ï¼Œæ²¡æœ‰ä»»ä½•ç›®çš„ï¼š

// Degenerate classes like this should not be public!  
class Point {  
    public double x;  
    public double y;  
}

å› ä¸ºè¿™ç§ç±»çš„æ•°æ®åŸŸéƒ½å¯ä»¥ç›´æ¥æ–¹æ³•ï¼Œç±»æ²¡æœ‰æä¾›ç»™å¤–ç•Œä»»ä½•å°è£…çš„å¥½å¤„ã€‚ä¸æ”¹å˜ API å°±ä¸èƒ½æ”¹å˜ç±»çš„è¡¨ç¤ºæ³•ï¼ˆrepresentationï¼‰ï¼›ä¸èƒ½å®ç°çº¦æŸæ¡ä»¶ï¼ˆinvariantsï¼‰ï¼›ä¸èƒ½åœ¨åŸŸè¢«è®¿é—®çš„æ—¶å€™é‡‡å–è¾…åŠ©è¡ŒåŠ¨ã€‚è¿™ç§ç±»åº”è¯¥è¢«ä¸‹é¢çš„ç±»æ›¿ä»£ï¼Œä¸‹é¢çš„ç±»ä½¿ç”¨ private åŸŸã€public è®¿é—®æ–¹æ³•ï¼ˆgettersï¼‰ï¼Œé’ˆå¯¹å¯å˜ç±»ï¼Œæä¾›ä¿®æ”¹æ–¹æ³•ï¼ˆmutators æˆ– settersï¼‰ï¼š

> -   ä¸èƒ½æ”¹å˜ç±»çš„è¡¨ç¤ºæ³•ï¼Œä¹Ÿå°±æ˜¯ç±»æ€ä¹ˆå®ç°è‡ªå·±çš„åŠŸèƒ½ã€‚å¦‚æœå°†åŸŸæš´éœ²å‡ºå»ï¼Œå®¢æˆ·ç«¯ç›´æ¥ä½¿ç”¨äº†è¿™äº›åŸŸï¼Œé‚£ä¹ˆå³ä½¿åœ¨è¯¥ç±»è¯•å›¾ä¿®æ”¹å†…éƒ¨å®ç°æ–¹å¼çš„æ—¶å€™ï¼Œä¹Ÿæ°¸è¿œä¸èƒ½åˆ é™¤è¿™ä¸ªåŸŸï¼ˆä¿®æ”¹äº†å°±æ˜¯æ”¹å˜ APIï¼‰ï¼Œå¦åˆ™å®¢æˆ·ç«¯ä¼šå‘ç”Ÿç¼–è¯‘é”™è¯¯ã€‚
>     
> -   ä¸èƒ½å®ç°çº¦æŸæ¡ä»¶ï¼Œå¦‚æœæŠŠå¯å˜å¯¹è±¡æš´éœ²ç»™å¤–ç•Œï¼Œç±»çš„ä¸€äº›çº¦æŸï¼ˆæ¯”å¦‚å¼€å§‹æ—¶é—´åœ¨ç»“æŸä¹‹å‰ã€ä¸€å¤©æœ‰ 24 å°æ—¶ç­‰ï¼‰å°±å¯èƒ½è¢«å¤–ç•Œç ´åã€‚
>     
> -   ä¸èƒ½é‡‡å–è¾…åŠ©è¡ŒåŠ¨ï¼Œä¹Ÿå°±æ˜¯åœ¨ get æ–¹æ³•ä¸­ï¼Œå¯¹åŸŸä½œè¾…åŠ©å¤„ç†ã€‚æ¯”å¦‚ç”¨ 1,2...,7 æ¥è¡¨ç¤ºå‘¨ä¸€åˆ°å‘¨æ—¥ï¼Œé‚£ä¹ˆåœ¨è¿”å›è¿™ä¸ªæ•°å­—çš„æ—¶å€™ï¼Œå¯èƒ½å°†å®ƒè½¬ä¸ºå­—ç¬¦ä¸²ã€‚
>     
> -   getter å’Œ setter å¥½åƒå¯ä»¥ç»Ÿç§° accessorã€‚
>     

Â // Encapsulation of data by accessor methods and mutators  
Â class Point {  
Â  Â  Â private double x;  
Â  Â  Â private double y;  
Â  Â  Â public Point(double x, double y) {  
Â  Â  Â  Â  Â this.x = x;  
Â  Â  Â  Â  Â this.y = y;   
Â  Â   }  
Â  Â  Â   
Â  Â  Â public double getX() { return x; }  
Â  Â  Â public double getY() { return y; }  
Â  Â  Â   
Â  Â  Â public void setX(double x) { this.x = x; }  
Â  Â  Â public void setY(double y) { this.y = y; }  
Â }

å¦‚æœä¸€ä¸ªç±»æ˜¯ publicï¼Œé‚£ä¹ˆå°±æä¾›è®¿é—®æ–¹æ³•ä»¥ä¿æŒæ”¹å˜è¯¥ç±»å†…éƒ¨è¡¨ç¤ºçš„çµæ´»æ€§ã€‚å¦‚æœä¸€ä¸ª public ç±»æš´éœ²äº†å®ƒçš„æ•°æ®åŸŸï¼Œé‚£ä¹ˆå°±ä¸å¯èƒ½å†æ”¹å˜å†…éƒ¨è¡¨ç¤ºäº†ã€‚

ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªç±»æ˜¯ package-private çš„æˆ–è€…æ˜¯ private nested ç±»ï¼Œå‡è®¾å®ƒä»¬å……åˆ†æè¿°äº†ç±»æ‰€æä¾›çš„æŠ½è±¡æ€§ï¼Œé‚£ä¹ˆå°±å¯ä»¥æš´éœ²å®ƒçš„æ•°æ®åŸŸã€‚å› ä¸ºè¿™ç§æ–¹æ³•æ¯”è®¿é—®æ–¹æ³•äº§ç”Ÿçš„è§†è§‰æ··ä¹±æ›´å°‘ã€‚å°±ç®—ç±»çš„å†…éƒ¨è¡¨ç¤ºæ³•éœ€è¦ä¿®æ”¹æ—¶ï¼ŒåŒæ—¶è¦è¢«ä¿®æ”¹çš„ä»£ç è¢«é™åˆ¶åœ¨åŒä¸€ä¸ªåŒ…ä¸­ï¼Œå¯ä»¥åœ¨ä¸å½±å“åŒ…å¤–ä»»ä½•ä»£ç çš„æƒ…å†µä¸‹è¿›è¡Œæ”¹å˜ã€‚åœ¨ private nested ç±»çš„æƒ…å†µä¸‹ï¼Œæ”¹å˜çš„èŒƒå›´ä»…ä»…è¢«é™åˆ¶åœ¨å¤–éƒ¨çš„ç±»ä¸­ã€‚

> Java ç±»åº“ä¸­æœ‰å¥½å‡ ä¸ªè¿åäº†è¿™æ¡å»ºè®®ï¼Œæœ‰åçš„ä¾‹å­æœ‰ java.awt. åŒ…å†…çš„ `Point` å’Œ `Dimension`ã€‚æ­£å¦‚ç¬¬ 67 æ¡æ‰€è¯´ï¼Œæš´éœ²`Dimension` ç±»çš„å†…éƒ¨ç»“æ„å¯¼è‡´äº†ä¸€ä¸ªä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜è‡³ä»Šä»ç„¶å­˜åœ¨ã€‚

æ°¸è¿œä¸è¦ç›´æ¥æš´éœ² public ç±»çš„åŸŸï¼Œä½†æ˜¯å¦‚æœæš´éœ²ä¸å¯å˜çš„åŸŸï¼Œå½±å“ä¼šç¨å¾®å°ä¸€ç‚¹ã€‚è™½ç„¶ä¾ç„¶ä¸èƒ½ç±»è¡¨ç¤ºæ³•ï¼Œé™¤éä¿®æ”¹ APIï¼›ä¹Ÿä¸èƒ½å†è¯»å–åŸŸçš„æ—¶å€™ï¼Œä¹Ÿæ— æ³•é‡‡å–è¾…åŠ©è¡ŒåŠ¨ï¼Œä½†æ˜¯å¯ä»¥å¼ºåˆ¶çº¦æŸæ¡ä»¶ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œpublic ç±»æ°¸è¿œä¸åº”è¯¥æš´éœ²å‡ºå¯å˜åŸŸï¼Œæš´éœ²ä¸å¯å˜åŸŸå±å®³ç¨å¾®å°ä¸€ç‚¹ï¼Œä½†ä»ç„¶ä¸å»ºè®®ã€‚ä½†æ˜¯ï¼Œå¯¹äº package-private ç±»æˆ– private nested ç±»æ¥è¯´ï¼Œæ— è®ºæš´éœ²å¯å˜æˆ–ä¸å¯å˜åŸŸçš„ï¼Œæœ‰æ—¶éƒ½æ˜¯å¯å–çš„ï¼ˆå› ä¸ºåªå½±å“åŒ…ç±»æˆ–å¤–éƒ¨ç±»ï¼‰ã€‚

## 17. æœ€å°åŒ–å¯å˜æ€§

ä¸å¯å˜ç±»æ˜¯æŒ‡å…¶å®ä¾‹ä¸èƒ½è¢«ä¿®æ”¹çš„ç±»ã€‚æ¯ä¸ªå®ä¾‹ä¸­åŒ…å«çš„æ‰€æœ‰ä¿¡æ¯éƒ½å¿…é¡»åœ¨åˆ›å»ºè¯¥å®ä¾‹çš„æ—¶å€™å°±æä¾›ï¼Œå¹¶åœ¨å¯¹è±¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼ˆlifetimeï¼‰å†…å›ºå®šä¸å˜ã€‚Java ç±»åº“ä¸­æœ‰å¾ˆå¤šä¸å¯å˜ç±»ï¼Œå¦‚ `String`ã€è£…ç®±ç±»å‹ã€`BigInteger` å’Œ `BigDecimal`ã€‚ä¸å¯å˜ç±»æ¯”å¯å˜ç±»æ›´åŠ æ˜“äºè®¾è®¡ã€å®ç°å’Œä½¿ç”¨ï¼Œä¸å®¹æ˜“å‡ºé”™ä¸”æ›´åŠ å®‰å…¨ã€‚

ä¸ºäº†ä½¿ç±»æˆä¸ºä¸å¯å˜ï¼Œè¦éµå¾ªä¸‹é¢äº”æ¡è§„åˆ™ï¼š

1.  ä¸è¦æä¾›ä»»ä½•ä¼šä¿®æ”¹å¯¹è±¡çŠ¶æ€çš„æ–¹æ³•ã€‚
    
2.  ä¿è¯ç±»ä¸ä¼šè¢«ç»§æ‰¿ã€‚è¿™å¯ä»¥é˜²æ­¢ç²—å¿ƒçš„æˆ–æ¶æ„çš„å­ç±»é€šè¿‡è¡¨ç°å¾—åƒå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼Œè€Œç ´åç±»çš„ä¸å¯å˜è¡Œä¸ºã€‚
    
    > é˜²æ­¢å­ç±»åŒ–çš„åšæ³•ï¼š
    > 
    > 1.  å°†è¯¥ç±»å£°æ˜ä¸º `final`ã€‚
    >     
    > 2.  è®©ç±»çš„æ‰€æœ‰æ„é€ å™¨éƒ½å˜æˆç§æœ‰çš„æˆ–è€…åŒ…çº§ç§æœ‰çš„ï¼Œå¹¶æ·»åŠ å…¬æœ‰çš„é™æ€å·¥å‚ï¼ˆstatic factoryï¼‰æ¥ä»£æ›¿å…¬æœ‰çš„æ„é€ å™¨ï¼ˆè¯¦è§ç¬¬ 1 æ¡ï¼‰ã€‚è¿™ç§æ–¹æ³•è¿˜å…è®¸æ·»åŠ åé¢æåˆ°çš„å¯¹è±¡ç¼“å­˜èƒ½åŠ›ã€‚
    >     
    > 
    > > `BitInteger` å’Œ `BigDecimal` åˆšç¼–å†™å‡ºæ¥çš„æ—¶å€™ï¼Œå¯¹äº â€œä¸å¯å˜çš„ç±»å¿…é¡»ä¸º `final`â€ çš„è¯´æ³•è¿˜æ²¡æœ‰å¾—åˆ°å¹¿æ³›çš„ç†è§£ï¼Œæ‰€ä»¥å®ƒä»¬çš„æ‰€æœ‰æ–¹æ³•éƒ½æœ‰å¯èƒ½è¢«è¦†ç›–ã€‚ä¸ºäº†ä¿æŒå‘åå…¼å®¹ï¼Œè¿™ä¸ªé—®é¢˜ä¸€ç›´æ— æ³•å¾—ä»¥ä¿®æ­£ã€‚å¦‚æœä½ åœ¨ç¼–å†™ä¸€ä¸ªç±»ï¼Œå®ƒçš„å®‰å…¨æ€§ä¾èµ–äºæ¥è‡ªä¸å¯ä¿¡å®¢æˆ·ç«¯çš„ `BigInteger` æˆ–è€… `BigDecimal` å‚æ•°çš„ä¸å¯å˜æ€§ï¼Œå°±å¿…é¡»è¿›è¡Œæ£€æŸ¥ï¼Œä»¥ç¡®å®šè¿™ä¸ªå‚æ•°æ˜¯å¦ä¸ºâ€œçœŸæ­£çš„â€ `BigInteger` æˆ–è€… `BigDecimal` ï¼Œè€Œä¸æ˜¯ä¸å¯ä¿¡ä»»å­ç±» çš„å®ä¾‹ã€‚å¦‚æœæ˜¯åè€…ï¼Œå°±å¿…é¡»åœ¨å‡è®¾å®ƒå¯èƒ½æ˜¯å¯å˜çš„å‰æä¸‹å¯¹å®ƒè¿›è¡Œä¿æŠ¤æ€§æ‹·è´ï¼ˆè¯¦è§ç¬¬ 50 æ¡ï¼‰ï¼š
    > > 
    > > public static BigInteger safeInstance(BigInteger val) {  
    > >     return val.getClass() == BigInteger.class ? val : new BigInteger(val.toByteArray());  
    > > }
    
3.  å£°æ˜æ‰€æœ‰çš„åŸŸéƒ½æ˜¯ final çš„ã€‚é€šè¿‡è¿™ç§ã€Œç³»ç»Ÿä¸Šçš„å¼ºåˆ¶æ–¹å¼ã€å¯ä»¥æ¸…æ¥šåœ°è¡¨æ˜æ„å›¾ã€‚å¹¶ä¸”ï¼Œå¦‚æœå¯¹æ–°åˆ›å»ºçš„å®ä¾‹çš„å¼•ç”¨ä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€’åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è€Œä¸åŒæ­¥ï¼Œåˆ™æœ‰å¿…è¦ç¡®ä¿è¡Œä¸ºçš„æ­£ç¡®æ€§ï¼Œæ­£å¦‚å†…å­˜æ¨¡å‹ä¸­æ‰€é˜è¿°çš„é‚£æ ·
    
4.  å£°æ˜æ‰€æœ‰çš„åŸŸéƒ½æ˜¯ç§æœ‰çš„ã€‚é˜²æ­¢å®¢æˆ·ç«¯è®¿é—®å¯å˜å¯¹è±¡åŸŸå¹¶ç›´æ¥ä¿®æ”¹è¿™äº›å¯¹è±¡ã€‚
    
    > è™½ç„¶ä¸å¯å˜ç±»å¯ä»¥å…·æœ‰ `public final` åŸŸï¼Œåªè¦è¿™äº›åŸŸåŒ…å«åŸºæœ¬ç±»å‹çš„å€¼æˆ–è€…æŒ‡å‘å…¶ä»–ä¸å¯å˜å¯¹è±¡çš„å¼•ç”¨ã€‚ä½†æ˜¯ä¸å»ºè®®è¿™æ ·åšï¼ˆé™¤äº† `public static final`ï¼‰ï¼Œå› ä¸ºæš´éœ²å‡ºå»ä¹‹åï¼Œåœ¨åç»­çš„ç‰ˆæœ¬ä¸­å°±æ— æ³•æ”¹å˜å†…éƒ¨çš„è¡¨ç¤ºæ³•ã€‚
    
5.  ç¡®ä¿å¯¹äºä»»ä½•å¯å˜ç»„ä»¶çš„äº’æ–¥è®¿é—®ã€‚å¦‚æœç±»å…·æœ‰æŒ‡å‘å¯å˜å¯¹è±¡çš„åŸŸï¼Œåˆ™å¿…é¡»ç¡®ä¿è¯¥ç±»çš„å®¢æˆ·ç«¯æ— æ³•è·å¾—æŒ‡å‘è¿™äº›å¯¹è±¡çš„å¼•ç”¨ã€‚å¹¶ä¸”ï¼Œæ°¸è¿œä¸è¦ç”¨å®¢æˆ·ç«¯æä¾›çš„å¯¹è±¡å¼•ç”¨æ¥åˆå§‹åŒ–è¿™æ ·çš„åŸŸï¼Œä¹Ÿä¸è¦ä»ä»»ä½•è®¿é—®æ–¹æ³•ï¼ˆaccessorï¼‰ä¸­è¿”å›è¯¥å¯¹è±¡å¼•ç”¨ã€‚åœ¨æ„é€ å™¨ã€è®¿é—®æ–¹æ³•å’Œ `readObject` æ–¹æ³•ï¼ˆè¯¦è§ç¬¬ 88 æ¡ï¼‰ä¸­è¯·ä½¿ç”¨ä¿æŠ¤æ€§æ‹·è´ï¼ˆdefensive copyï¼‰æŠ€æœ¯ï¼ˆè¯¦è§ç¬¬ 50 æ¡ï¼‰ã€‚ï¼ˆè®¾å€¼æ–¹æ³•ï¼šmutatorï¼‰
    

// Immutable complex number class public final class Complex { private final double re; private final double im;  
public Complex(double re, double im) {  
        this.re = re;  
        this.im = im;  
    }  
    public double realPart()      { return re; }  
    public double imaginaryPart() { return im; }  
    public Complex plus(Complex c) {  
        return new Complex(re + c.re, im + c.im);  
	}  
    public Complex minus(Complex c) {  
        return new Complex(re - c.re, im - c.im);  
	}  
    public Complex times(Complex c) {  
        return new Complex(re * c.re - im * c.im,  
                           re * c.im + im * c.re);  
	}  
    public Complex dividedBy(Complex c) {  
        double tmp = c.re * c.re + c.im * c.im;  
        return new Complex((re * c.re + im * c.im) / tmp,  
                           (im * c.re - re * c.im) / tmp);  
	}  
    @Override   
	public boolean equals(Object o) {  
       if (o == this)  
           return true;  
       if (!(o instanceof Complex))  
           return false;  
       Complex c = (Complex) o;  
       return Double.compare(c.re, re) == 0 && Double.compare(c.im, im) == 0;  
    }  
    @Override   
	public int hashCode() {  
        return 31 * Double.hashCode(re) + Double.hashCode(im);  
    }  
    @Override   
	public String toString() {  
        return "(" + re + " + " + im + "i)";  
  
    }   
}

Complex ç±»æä¾›äº†è®¿é—®å±æ€§çš„æ–¹æ³•ï¼Œè¿˜æœ‰å››ç§è¿ç®—æ–¹æ³•ã€‚è¿™å››ç§æ–¹æ³•è¿”å›äº†æ–°çš„ Complex å®ä¾‹ã€‚è¿™ç§æ–¹æ³•çš„æ¨¡å¼æˆä¸ºå‡½æ•°çš„ï¼ˆfunctionalï¼‰æ–¹æ³•ï¼Œå› ä¸ºè¿™äº›æ–¹æ³•è¿”å›äº†ä¸€ä¸ªå‡½æ•°çš„ç»“æœï¼Œè¿™äº›å‡½æ•°å¯¹æ“ä½œæ•°è¿›è¡Œè¿ç®—ä½†å¹¶ä¸ä¿®æ”¹å®ƒã€‚ä¸ä¹‹ç›¸å¯¹åº”çš„æ˜¯è¿‡ç¨‹çš„ï¼ˆproceduralï¼‰æˆ–è€…å‘½ä»¤å¼çš„ï¼ˆimperativeï¼‰æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•å°†ä¸€ä¸ªè¿‡ç¨‹ä½œç”¨åœ¨æ“ä½œæ•°ä¸Šï¼Œä¼šå¯¼è‡´å®ƒçš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ã€‚è¿™ç§æ–¹æ³•çš„åç§°éƒ½æ˜¯ä»‹è¯ï¼ˆå¦‚ plusï¼‰ï¼Œå‡½æ•°å¼æ–¹æ³•çš„åç§°é€šå¸¸æ˜¯åŠ¨è¯ï¼ˆå¦‚ addï¼‰ã€‚

ä¸å¯å˜å¯¹è±¡åªæœ‰**ä¸€ç§çŠ¶æ€**ï¼Œå³è¢«åˆ›å»ºæ—¶çš„çŠ¶æ€ï¼Œè€Œå¯å˜å¯¹è±¡æœ‰ä»»æ„å¤æ‚çš„çŠ¶æ€ç©ºé—´ã€‚

ä¸å¯å˜å¯¹è±¡æœ¬è´¨ä¸Šæ˜¯**çº¿ç¨‹å®‰å…¨**çš„ï¼Œå®ƒä»¬ä¸è¦æ±‚åŒæ­¥ ã€‚

åº”è¯¥å°½å¯èƒ½é‡ç”¨ç°æœ‰çš„ä¸å¯å˜ç±»çš„å®ä¾‹ï¼Œå¯¹äºé¢‘ç¹ç”¨åˆ°çš„å€¼ï¼Œä¸ºå®ƒä»¬æä¾› `public static final` å¸¸é‡ã€‚ä¹Ÿå¯ä»¥è¿›ä¸€æ­¥æ‹“å±•ï¼šä¸å¯å˜çš„ç±»å¯ä»¥æä¾›ä¸€äº›é™æ€å·¥å‚ï¼ŒæŠŠé¢‘ç¹è¢«è¯·æ±‚çš„å®ä¾‹ç¼“å­˜èµ·æ¥ã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯ä¹‹é—´å¯ä»¥å…±äº«ç°æœ‰çš„å®ä¾‹ï¼Œä»è€Œé™ä½å†…å­˜å ç”¨å’Œåƒåœ¾å›æ”¶çš„æˆæœ¬ã€‚

> -   åŸºæœ¬ç±»å‹çš„åŒ…è£…ç±» å’Œ `BigInteger` éƒ½æœ‰è¿™æ ·çš„é™æ€å·¥å‚ã€‚
>     
> -   è®¾è®¡æ–°çš„ç±»æ—¶ï¼Œé€‰æ‹©ç”¨é™æ€å·¥å‚ä»£æ›¿å…¬æœ‰çš„æ„é€ å™¨å¯ä»¥ä½¿å¾—ä»¥åæœ‰æ·»åŠ ç¼“å­˜çš„çµæ´»æ€§ï¼Œè€Œä¸å¿…å½±å“å®¢æˆ·ç«¯ã€‚
>     

â€œ**ä¸å¯å˜å¯¹è±¡å¯ä»¥è¢«è‡ªç”±åœ°å…±äº«**â€ å¯¼è‡´çš„ç»“æœæ˜¯ï¼Œæ°¸è¿œä¹Ÿä¸éœ€è¦è¿›è¡Œä¿æŠ¤æ€§æ‹·è´ï¼ˆdefensive copyï¼‰ï¼ˆè¯¦è§ç¬¬ 50 æ¡)ã€‚ å®é™…ä¸Šæ ¹æœ¬æ— é¡»åšä»»ä½•æ‹·è´ï¼Œå› ä¸ºè¿™äº›æ‹·è´å§‹ç»ˆç­‰äºåŸå§‹çš„å¯¹è±¡ã€‚å› æ­¤ä¸éœ€è¦ä¹Ÿä¸åº”è¯¥ä¸ºä¸å¯å˜çš„ç±»æä¾› `clone` æ–¹æ³•æˆ–è€…æ‹·è´æ„é€ å™¨ï¼ˆè¯¦è§ç¬¬ 13 æ¡ï¼‰ã€‚è¿™ä¸€ç‚¹åœ¨ Java å¹³å°çš„æ—©æœŸå¹¶ä¸å¥½ç†è§£ï¼Œæ‰€ä»¥ `String` ç±»ä»ç„¶å…·æœ‰æ‹·è´æ„é€ å™¨ï¼Œä½†æ˜¯åº”è¯¥å°½é‡å°‘ç”¨å®ƒï¼ˆè¯¦è§ç¬¬ 6æ¡ï¼‰ã€‚

**ä¸ä»…å¯ä»¥å…±äº«ä¸å¯å˜å¯¹è±¡ï¼Œç”šè‡³ä¹Ÿå¯ä»¥å…±äº«å®ƒä»¬çš„å†…éƒ¨ä¿¡æ¯ã€‚**ä¾‹å¦‚ï¼Œ `Biginteger` ç±»å†…éƒ¨ä½¿ç”¨äº†ç¬¦å·æ•°å€¼è¡¨ç¤ºæ³•ã€‚ç¬¦å·ç”¨ ä¸€ä¸ª `int` ç±»å‹çš„å€¼æ¥è¡¨ç¤ºï¼Œæ•°å€¼åˆ™ç”¨ä¸€ä¸ª `int` æ•°ç»„è¡¨ ç¤º ã€‚ `negate` æ–¹æ³•äº§ç”Ÿä¸€ä¸ªæ–°çš„ `Biginteger`ï¼Œå…¶ä¸­æ•°å€¼æ˜¯ä¸€æ ·çš„ï¼Œç¬¦å·åˆ™æ˜¯ç›¸åçš„ ã€‚ å®ƒå¹¶ä¸éœ€è¦æ‹·è´æ•°ç»„ï¼Œæ–°å»ºçš„ `Biginteger` ä¹ŸæŒ‡å‘åŸå§‹å®ä¾‹ä¸­çš„åŒä¸€ä¸ªå†…éƒ¨æ•°ç»„ ã€‚

**ä¸å¯å˜å¯¹è±¡æ— å¿åœ°æä¾›äº†å¤±è´¥çš„åŸå­æ€§**ï¼ˆè¯¦è§ç¬¬ 76æ¡ï¼‰ã€‚å®ƒä»¬çš„çŠ¶æ€æ°¸è¿œä¸å˜ï¼Œå› æ­¤ä¸å­˜åœ¨ä¸´æ—¶ä¸ä¸€è‡´çš„å¯èƒ½æ€§ ã€‚

**ä¸å¯å˜ç±»çœŸæ­£å”¯ä¸€çš„ç¼ºç‚¹æ˜¯ï¼Œå¯¹äºæ¯ä¸ªä¸åŒçš„å€¼éƒ½éœ€è¦ä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡ã€‚**åˆ›å»ºè¿™äº›å¯¹è±¡çš„ä»£ä»·å¯èƒ½å¾ˆé«˜ï¼Œç‰¹åˆ«æ˜¯å¤§å‹çš„å¯¹è±¡ ã€‚

å¦‚æœä½ æ‰§è¡Œä¸€ä¸ªå¤šæ­¥éª¤çš„æ“ä½œï¼Œå¹¶ä¸”æ¯ä¸ªæ­¥éª¤éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„å¯¹è±¡ ï¼Œ**é™¤äº†æœ€åçš„ç»“æœä¹‹å¤–ï¼Œå…¶ä»–çš„å¯¹è±¡æœ€ç»ˆéƒ½ä¼šè¢«ä¸¢å¼ƒ**ï¼Œæ­¤æ—¶æ€§èƒ½é—®é¢˜å°±ä¼šæ˜¾éœ²å‡ºæ¥ã€‚å¤„ç†è¿™ç§é—®é¢˜æœ‰ä¸¤ç§åŠæ³•ï¼š

-   ç¬¬ä¸€ç§åŠæ³•ï¼Œå…ˆçŒœæµ‹ä¸€ä¸‹ç»å¸¸ä¼šç”¨åˆ°å“ªäº›å¤šæ­¥éª¤çš„æ“ä½œï¼Œç„¶åå°†å®ƒä»¬ä½œä¸ºåŸºæœ¬ç±»å‹æä¾›ã€‚ å¦‚æœæŸä¸ªå¤šæ­¥éª¤æ“ä½œå·²ç»ä½œä¸ºåŸºæœ¬ç±»å‹æä¾›ï¼Œä¸å¯å˜çš„ç±»å°±æ— é¡»åœ¨æ¯ä¸ªæ­¥éª¤å•ç‹¬åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚ï¼ˆå°†ä¸­é—´å¯¹è±¡æ‹†è§£æˆå¤šä¸ªåŸºæœ¬ç±»å‹ï¼Ÿï¼‰
    
-   ç¬¬äºŒç§åŠæ³•ï¼Œæä¾›å¯å˜é…å¥—ç±»ï¼ˆcompaning classï¼‰ï¼š
    
    -   å¦‚æœèƒ½é¢„æµ‹å‡ºå®¢æˆ·ç«¯å°†è¦åœ¨ä¸å¯å˜ç±»ä¸Šæ‰§è¡Œå“ªäº›å¤æ‚çš„å¤šé˜¶æ®µæ“ä½œï¼Œå¯ä»¥æä¾›åŒ…çº§ç§æœ‰çš„å¯å˜é…å¥—ç±»ã€‚`BigInteger` æœ‰ä¸€ä¸ªåŒ…çº§ç§æœ‰çš„å¯å˜é…å¥—ç±»ï¼Œå®ƒçš„ç”¨é€”æ˜¯åŠ é€Ÿè¯¸å¦‚ â€œæ¨¡æŒ‡æ•°â€ è¿™æ ·çš„å¤šæ­¥éª¤æ“ä½œã€‚
        
    -   å¦åˆ™ï¼Œæœ€å¥½æä¾›ä¸€ä¸ªå…¬æœ‰çš„å¯å˜é…å¥—ç±»ã€‚å¦‚ String çš„å¯å˜é…å¥—ç±»æ—¶ `StringBuilder` ç±»ã€‚
        

å‰é¢æå‡ºçš„å…³äºä¸å¯å˜ç±»çš„è¯¸å¤šè§„åˆ™æŒ‡å‡ºæ²¡æœ‰æ–¹æ³•ä¼šä¿®æ”¹å¯¹è±¡ï¼Œå¹¶ä¸”å®ƒçš„æ‰€æœ‰åŸŸéƒ½å¿…é¡»æ˜¯ `final` çš„ã€‚ å®é™…ä¸Šï¼Œè¿™äº›è§„åˆ™æ¯”çœŸæ­£çš„è¦æ±‚æ›´å¼ºç¡¬äº†ä¸€ç‚¹ï¼Œä¸ºäº†æé«˜æ€§èƒ½å¯ä»¥æœ‰æ‰€æ”¾æ¾ã€‚äº‹å®ä¸Šåº”è¯¥æ˜¯è¿™æ ·ï¼šæ²¡æœ‰ä¸€ä¸ªæ–¹æ³•èƒ½å¤Ÿå¯¹å¯¹è±¡çš„çŠ¶æ€äº§ç”Ÿå¤–éƒ¨å¯è§ï¼ˆexternally visibleï¼‰çš„æ”¹å˜ã€‚ç„¶è€Œï¼Œè®¸å¤šä¸å¯å˜çš„ç±»æ‹¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªé `final` çš„åŸŸï¼Œå®ƒä»¬åœ¨ç¬¬ä¸€æ¬¡è¢«è¯·æ±‚æ‰§è¡Œè¿™äº›è®¡ç®—çš„æ—¶å€™ï¼ŒæŠŠä¸€äº›å¼€é”€æ˜‚è´µçš„è®¡ç®—ç»“æœç¼“å­˜åœ¨è¿™äº›åŸŸä¸­ã€‚å¦‚æœå°†æ¥å†æ¬¡è¯·æ±‚åŒæ ·çš„è®¡ç®—ï¼Œå°±ç›´æ¥è¿”å›è¿™äº›ç¼“å­˜çš„å€¼ï¼Œä»è€ŒèŠ‚çº¦äº†é‡æ–°è®¡ç®—æ‰€éœ€è¦çš„å¼€é”€ã€‚è¿™ç§æŠ€å·§å¯ä»¥å¾ˆå¥½åœ°å·¥ä½œï¼Œå› ä¸ºå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œå®ƒçš„ä¸å¯å˜æ€§ä¿è¯äº†è¿™äº›è®¡ç®—å¦‚æœè¢«å†æ¬¡æ‰§è¡Œï¼Œå°±ä¼šäº§ç”ŸåŒæ ·çš„ç»“æœã€‚

> -   å¯ä»¥å°† hashCode ç¼“å­˜ã€‚
>     
> -   å¦‚æœæŠŠè®¡ç®—ç»“æœç¼“å­˜è¿› `final` åŸŸä¸­ï¼Œé‚£ä¹ˆå°±å¿…é¡»åœ¨æ„é€ æ–¹æ³•æˆ–è€…å£°æ˜çš„æ—¶å€™åˆå§‹åŒ–ã€‚å¦‚æœç”¨é `final` åŸŸæ¥ç¼“å­˜ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°å»¶è¿Ÿåˆå§‹åŒ–ã€‚
>     

å¦‚æœä½ é€‰æ‹©è®©è‡ªå·±çš„ä¸å¯å˜ç±»å®ç° `Serializable` æ¥å£ ï¼Œå¹¶ä¸”å®ƒåŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªæŒ‡å‘å¯å˜å¯¹è±¡çš„åŸŸï¼Œå°±å¿…é¡»æä¾›ä¸€ä¸ªæ˜¾å¼çš„ `readObject` æˆ–è€… `readResolve` æ–¹æ³•ï¼Œæˆ–è€…ä½¿ç”¨ `ObjectOutputStream.writeUnshared` å’Œ `ObjectInputStream.readUnshared` æ–¹æ³•ï¼Œå³ä¾¿é»˜è®¤çš„åºåˆ—åŒ–å½¢å¼æ˜¯å¯ä»¥æ¥å—çš„ï¼Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚å¦åˆ™ï¼Œæ”»å‡»è€…å¯èƒ½ä»ä¸å¯å˜çš„ç±»åˆ›å»ºå¯å˜çš„å®ä¾‹ï¼ˆè¯¦è§ç¬¬ 88 æ¡ï¼‰ã€‚

ä¸å¯å˜çš„ç±»æœ‰è®¸å¤šä¼˜ç‚¹ï¼Œå”¯ä¸€çš„ç¼ºç‚¹æ˜¯åœ¨ç‰¹å®šçš„æƒ…å†µä¸‹å­˜åœ¨æ½œåœ¨çš„æ€§èƒ½é—®é¢˜ã€‚ä½ åº”è¯¥æ€»æ˜¯ä½¿ä¸€äº›å°çš„å€¼å¯¹è±¡ï¼Œæ¯”å¦‚ PhoneNumber å’Œ Complexï¼Œæˆä¸ºä¸å¯å˜çš„ã€‚ (åœ¨ Java å¹³å°ç±»åº“ä¸­ï¼Œæœ‰å‡ ä¸ªç±»å¦‚ `java.util.Date` å’Œ `java.awt.Point`ï¼Œå®ƒä»¬æœ¬åº”è¯¥æ˜¯ä¸å¯å˜çš„ï¼Œä½†å®é™…ä¸Šå´ä¸æ˜¯ã€‚ï¼‰ä½ ä¹Ÿåº”è¯¥è®¤çœŸè€ƒè™‘æŠŠä¸€äº›è¾ƒå¤§çš„å€¼å¯¹è±¡åšæˆä¸å¯å˜çš„ï¼Œä¾‹å¦‚ `String` å’Œ `Biginteger`ã€‚åªæœ‰å½“ä½ ç¡®è®¤æœ‰å¿…è¦å®ç°ä»¤äººæ»¡æ„çš„æ€§èƒ½æ—¶ï¼ˆè¯¦è§ç¬¬ 67æ¡ï¼‰ï¼Œæ‰åº”è¯¥ä¸ºä¸å¯å˜çš„ç±»æä¾›å…¬æœ‰çš„å¯å˜é…å¥—ç±»ã€‚

å¦‚æœç±»ä¸èƒ½è¢«åšæˆä¸å¯å˜çš„ï¼Œåº”è¯¥å°½å¯èƒ½åœ°é™åˆ¶å®ƒçš„å¯å˜æ€§ã€‚é™ä½å¯¹è±¡å¯ä»¥å­˜åœ¨çš„çŠ¶æ€æ•°ï¼Œå¯ä»¥æ›´å®¹æ˜“åœ°åˆ†æè¯¥å¯¹è±¡çš„è¡Œä¸ºï¼ŒåŒæ—¶é™ä½å‡ºé”™çš„å¯èƒ½æ€§ã€‚å› æ­¤ï¼Œé™¤éæœ‰ä»¤äººä¿¡æœçš„ç†ç”±ä½¿åŸŸå˜æˆé `final` çš„ ï¼Œå¦åˆ™è®©æ¯ä¸ªåŸŸéƒ½æ˜¯ `final` çš„ã€‚ç»“åˆè¿™æ¡çš„å»ºè®®å’Œç¬¬ 15 æ¡çš„å»ºè®®ï¼Œä½ è‡ªç„¶å€¾å‘äºï¼šé™¤éæœ‰ä»¤äººä¿¡æœçš„ç†ç”±è¦ä½¿åŸŸå˜æˆæ˜¯é `final` çš„ï¼Œå¦åˆ™è¦ä½¿æ¯ä¸ªåŸŸéƒ½æ˜¯ `private final` çš„ ã€‚

æ„é€ å™¨åº”è¯¥åˆ›å»ºå®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡ï¼Œå¹¶å»ºç«‹èµ·æ‰€æœ‰çš„çº¦æŸå…³ç³»ã€‚ä¸è¦åœ¨æ„é€ å™¨æˆ–è€…é™æ€å·¥å‚ä¹‹å¤–å†æä¾›å…¬æœ‰çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œé™¤éæœ‰ä»¤äººä¿¡æœçš„ç†ç”±å¿…é¡»è¿™ä¹ˆåšã€‚åŒæ ·åœ°ï¼Œä¹Ÿä¸åº”è¯¥æä¾› â€œé‡æ–°åˆå§‹åŒ–â€ æ–¹æ³•ï¼ˆå®ƒä½¿å¾—å¯¹è±¡å¯ä»¥è¢«é‡ç”¨ï¼Œå°±å¥½åƒè¿™ä¸ªå¯¹è±¡æ˜¯ç”±å¦ä¸€ä¸åŒçš„åˆå§‹çŠ¶æ€æ„é€ å‡ºæ¥çš„ä¸€æ ·ï¼‰ã€‚ä¸æ‰€å¢åŠ çš„å¤æ‚æ€§ç›¸æ¯”ï¼Œâ€œé‡æ–°åˆå§‹åŒ–â€ æ–¹æ³•é€šå¸¸å¹¶æ²¡æœ‰å¸¦æ¥å¤ªå¤šçš„æ€§èƒ½ä¼˜åŠ¿ã€‚

## 18. å¤åˆä¼˜å…ˆäºç»§æ‰¿

å¯¹æ™®é€šçš„å…·ä½“ç±»ï¼ˆconcrete classï¼‰è¿›è¡Œè·¨åŒ…ç»§æ‰¿æ˜¯éå¸¸å±é™©çš„ï¼ˆæœ¬èŠ‚è¯´çš„ç»§æ‰¿ä¸é€‚ç”¨äºç±»å®ç°æ¥å£æˆ–è€…æ¥å£ç»§æ‰¿ï¼‰ï¼Œåœ¨åŒ…å†…ä½¿ç”¨ç»§æ‰¿ï¼Œæˆ–è€…åœ¨åŒ…å¤–ç»§æ‰¿ä¸“é—¨ä¸ºäº†ç»§æ‰¿è€Œè®¾è®¡å¹¶ä¸”å…·æœ‰å¾ˆå¥½çš„æ–‡æ¡£è¯´æ˜çš„ç±»æ˜¯å®‰å…¨çš„ã€‚

äºæ–¹æ³•è°ƒç”¨ä¸åŒï¼Œç»§æ‰¿æ‰“ç ´äº†å°è£…æ€§ã€‚å­ç±»ä¾èµ–äºå…¶è¶…ç±»ä¸­ç‰¹å®šåŠŸèƒ½çš„å®ç°ç»†èŠ‚ï¼Œå¦‚æœè¶…ç±»å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆå­ç±»å¯èƒ½ä¼šé­åˆ°ç ´åã€‚é™¤éè¶…ç±»æ˜¯ä¸“é—¨ä¸ºäº†æ‰©å±•è€Œè®¾è®¡çš„ã€‚

### ç»§æ‰¿çš„ç¼ºç‚¹

#### è¦†ç›–ï¼ˆoverridingï¼‰å¸¦æ¥çš„é—®é¢˜

é—®é¢˜ 1ï¼š

ä¸‹é¢çš„ç±»è¯•å›¾å®ç°ç»Ÿè®¡ HashSet åˆ›å»ºä»¥æ¥ä¸€å…±è¢«æ·»åŠ è¿‡å¤šå°‘æ¬¡å…ƒç´ ã€‚

 // Broken - Inappropriate use of inheritance!  
   public class InstrumentedHashSet<E> extends HashSet<E> {  
       // The number of attempted element insertions  
       private int addCount = 0;  
       public InstrumentedHashSet() {  
       }  
       public InstrumentedHashSet(int initCap, float loadFactor) {  
           super(initCap, loadFactor);  
       }  
       @Override public boolean add(E e) {  
            addCount++;  
            return super.add(e);  
        }  
        @Override public boolean addAll(Collection<? extends E> c) { addCount += c.size();  
        return super.addAll(c);  
        }  
        public int getAddCount() {  
            return addCount;  
        }  
	}

çœ‹ä¼¼åˆç†ï¼Œä½†å¹¶ä¸èƒ½æ­£å¸¸å·¥ä½œï¼š

 InstrumentedHashSet<String> s = new InstrumentedHashSet<>();  
 s.addAll(List.of("Snap", "Crackle", "Pop"));

`getAddCount()` è¿”å›çš„ç»“æœæ˜¯ 6 è€Œä¸æ˜¯ 3ã€‚å› ä¸º `HashSet` çš„ `addAll` æ–¹æ³•æ˜¯åŸºäº `add` æ–¹æ³•æ¥å®ç°çš„ã€‚è¿™ç§è‡ªç”¨å‹ï¼ˆself-useï¼‰æ˜¯å®ç°ç»†èŠ‚ï¼Œè€Œä¸æ˜¯æ‰¿è¯ºï¼Œä¸èƒ½ä¿è¯åœ¨ Java å¹³å°çš„æ‰€æœ‰å®ç°ä¸­éƒ½ä¿æŒä¸å˜ã€‚

> `super.addAll` ä¹‹åï¼Œçˆ¶ç±»çš„ `addAll` æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ `add` æ–¹æ³•ï¼Œå› ä¸ºå­ç±»è¦†ç›–äº† `add` æ–¹æ³•ï¼Œæ‰€ä»¥çˆ¶ç±»ä¼šå»è°ƒç”¨å­ç±»çš„ `add` æ–¹æ³•ã€‚

é—®é¢˜ 2ï¼š

å‡è®¾å®ç°ä¸€ä¸ªç±»ç»§æ‰¿äº†æŸä¸ªé›†åˆç±»ï¼Œä¿è¯æ·»åŠ åˆ°é›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½æ»¡è¶³æŸä¸ªæ¡ä»¶ï¼Œè¿™å°±éœ€è¦è¦†ç›–ç›®å‰æ‰€æœ‰èƒ½å¤Ÿæ·»åŠ å…ƒç´ çš„æ–¹æ³•ï¼Œæ¥ç¡®ä¿æ·»åŠ çš„å…ƒç´ æ˜¯æ»¡è¶³æ¡ä»¶çš„ã€‚ä½†åœ¨åç»­ç‰ˆæœ¬ä¸­ï¼Œé›†åˆç±»å¯èƒ½å¢åŠ äº†æ·»åŠ å…ƒç´ çš„æ–°æ–¹æ³•ã€‚å¦‚æœè°ƒç”¨è¿™ä¸ªæœªè¢«å­ç±»è¦†ç›–çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½æ·»åŠ äº†éæ³•å…ƒç´ ã€‚

#### æ‰©å±•å¸¦æ¥çš„é—®é¢˜

æ‰©å±•ä¼šæ¯”è¦†ç›–å®‰å…¨çš„å¤šï¼Œä½†ä»ç„¶ä¼šæœ‰é£é™©ã€‚

å¦‚æœå­ç±»æ‰©å±•äº†è¶…ç±»çš„æ–¹æ³•ï¼Œä½†è¶…ç±»åœ¨åç»­çš„ç‰ˆæœ¬ä¸­ç¢°å·§æä¾›ä¸‹é¢ä¸¤ç§æ–°æ–¹æ³•ï¼š

-   ä¸å­ç±»æ‰©å±•çš„æ–¹æ³•ç­¾åç›¸åŒä½†è¿”å›ç±»å‹ä¸åŒï¼Œé‚£ä¹ˆç¼–è¯‘çš„æ—¶å€™å°±ä¼šå¤±è´¥ã€‚
    
-   ä¸å­ç±»æ‰©å±•çš„æ–¹æ³•ç­¾åå’Œè¿”å›ç±»å‹éƒ½ç›¸åŒï¼Œé‚£ä¹ˆå°±åˆå›åˆ°äº†ä¸Šè¿°è¦†ç›–å¸¦æ¥çš„ä¸¤ä¸ªé—®é¢˜ã€‚
    

### å¤åˆï¼ˆcompositionï¼‰

ç°æœ‰çš„ç±»å˜æˆäº†æ–°ç±»çš„ä¸€ä¸ªç»„ä»¶ã€‚æ–°ç±»ä¸­çš„æ¯ä¸ªå®ä¾‹æ–¹æ³•éƒ½å¯ä»¥è°ƒç”¨è¢«åŒ…å«çš„ç°æœ‰ç±»å®ä¾‹ä¸­å¯¹åº”çš„æ–¹æ³•ï¼Œå¹¶è¿”å›å®ƒçš„ç»“æœã€‚è¿™è¢«ç§°ä¸ºè½¬å‘ï¼ˆforwardingï¼‰ï¼Œæ–°ç±»ä¸­çš„æ–¹æ³•è¢«ç§°ä¸ºè½¬å‘æ–¹æ³•ï¼ˆforwarding methodï¼‰ã€‚è¿™æ ·å¾—åˆ°çš„ç±»å°†ä¼šéå¸¸ç¨³å›ºï¼Œå®ƒä¸ä¾èµ–äºç°æœ‰ç±»çš„å®ç°ç»†èŠ‚ã€‚å³ä½¿ç°æœ‰çš„ç±»æ·»åŠ äº†æ–°çš„æ–¹æ³•ï¼Œä¹Ÿä¸ä¼šå½±å“æ–°çš„ç±»ã€‚

// Reusable forwarding class  
public class ForwardingSet<E> implements Set<E> {  
    private final Set<E> s;  
    public ForwardingSet(Set<E> s) { this.s = s; }  
    public void clear()               { s.clear();            }  
    public boolean contains(Object o) { return s.contains(o); }  
    public boolean isEmpty()  
    public int size()  
    public Iterator<E> iterator()  
    public boolean add(E e)  
    public boolean remove(Object o)  
    public boolean containsAll(Collection<?> c) { return s.containsAll(c); }  
    public boolean addAll(Collection<? extends E> c) { return s.addAll(c);      }  
    public boolean removeAll(Collection<?> c) { return s.removeAll(c);   }  
    public boolean retainAll(Collection<?> c) { return s.retainAll(c);   }  
    public Object[] toArray()          { return s.toArray();  }  
    public <T> T[] toArray(T[] a)      { return s.toArray(a); }  
    @Override public boolean equals(Object o) { return s.equals(o);  }  
    @Override public int hashCode()    { return s.hashCode(); }  
    @Override public String toString() { return s.toString(); }  
}

å…ˆå®ç°ä¸€ä¸ª `Set` çš„è½¬å‘ç±» `ForwardingSet`ã€‚

// Wrapper class - uses composition in place of inheritance  
public class InstrumentedSet<E> extends ForwardingSet<E> {  
    private int addCount = 0;  
    public InstrumentedSet(Set<E> s) {  
        super(s);  
	}  
    @Override public boolean add(E e) {  
        addCount++;  
        return super.add(e);  
    }  
    @Override public boolean addAll(Collection<? extends E> c) { addCount += c.size();  
    	return super.addAll(c);  
    }  
    public int getAddCount() {  
        return addCount;  
    }  
}

å†ç»§æ‰¿ `ForwadingSet`ï¼Œè¿™æ · `InstrumentedSet` å°±å¯ä»¥å®ç°ç»Ÿè®¡æ‰€æœ‰è¢«æ·»åŠ å…ƒç´ çš„ä¸ªæ•°äº†ã€‚

> å†™æˆä¸¤ä¸ªç±»ï¼Œæ˜¯ä¸ºäº†å¤ç”¨ `ForwardingSet` æ¥å®ç°å…¶ä»–éœ€æ±‚ã€‚ä¹Ÿå¯ä»¥ç›´æ¥å°† `Set` å¤åˆè¿› `InstrumentedSet` æ¥å®ç°ä¸Šè¿°éœ€æ±‚ã€‚

è¿™ä¸ªåŒ…è£…ç±»å¯ä»¥åŒ…è£…ä»»ä½• `Set` å®ç°ï¼Œè¿™ä¹Ÿæ­£æ˜¯è£…é¥°è€…ï¼ˆDecoratorï¼‰æ¨¡å¼ã€‚åŒ…è£…ç±»ä¸ä»…æ¯”å­ç±»æ›´åŠ å¥å£®ï¼Œè€Œä¸”åŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚

> åŒ…è£…ç±»å‡ ä¹æ²¡æœ‰ä»€ä¹ˆç¼ºç‚¹ã€‚éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼ŒåŒ…è£…ç±»ä¸é€‚åˆç”¨äºå›è°ƒæ¡†æ¶ï¼ˆcallback frameworkï¼‰ã€‚åœ¨å›è°ƒæ¡†æ¶ä¸­ï¼Œå¯¹è±¡æŠŠè‡ªèº«çš„å¼•ç”¨ä¼ é€’ç»™å…¶ä»–çš„å¯¹è±¡ï¼Œç”¨äºåç»­çš„å›è°ƒã€‚å› ä¸ºè¢«åŒ…è£…èµ·æ¥çš„å¯¹è±¡å¹¶ä¸çŸ¥é“å®ƒå¤–é¢çš„åŒ…è£…å¯¹è±¡ï¼Œæ‰€ä»¥å®ƒä¼ é€’ä¸€ä¸ªæŒ‡å‘è‡ªèº«çš„å¼•ç”¨ï¼ˆ`this`ï¼‰ï¼Œå›è°ƒæ—¶é¿å¼€äº†å¤–é¢çš„åŒ…è£…å¯¹è±¡ã€‚è¿™è¢«ç§°ä¸º SELF é—®é¢˜ã€‚ï¼ˆTODOï¼šæ²¡çœ‹æ˜ç™½ï¼‰

> ä¸å¿…æ‹…å¿ƒè½¬å‘æ–¹æ³•è°ƒç”¨å¸¦æ¥çš„æ€§èƒ½å½±å“ï¼Œæˆ–è€…æ˜¯åŒ…è£…å¯¹è±¡å¯¼è‡´çš„å†…å­˜å ç”¨ï¼Œè¿™äº›éƒ½ä¸ä¼šé€ æˆä»€ä¹ˆå½±å“ã€‚Guava ä¸ºæ‰€æœ‰çš„é›†åˆæ¥å£æä¾›äº†è½¬å‘ç±»ã€‚

åªæœ‰å½“å­ç±»çœŸæ­£æ˜¯è¶…ç±»çš„å­ç±»å‹ï¼ˆsubtypeï¼‰æ—¶ï¼Œæ‰é€‚åˆç”¨ç»§æ‰¿ã€‚æ¢å¥è¯è¯´ï¼Œå¯¹äºä¸¤ä¸ªç±» A å’Œ Bï¼Œåªæœ‰å½“ä¸¤è€…ä¹‹é—´ç¡®å®å­˜åœ¨ â€œis-aâ€ å…³ç³»çš„æ—¶å€™ï¼Œç±» B æ‰åº”è¯¥æ‰©å±•ç±» Aã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼ŒB åº”è¯¥åŒ…å« A çš„ä¸€ä¸ªç§æœ‰å®ä¾‹ï¼Œå¹¶ä¸”æš´éœ²ä¸€ä¸ªè¾ƒå°çš„ã€è¾ƒç®€å•çš„ APIï¼šA æœ¬è´¨ä¸Šä¸æ˜¯ B çš„ä¸€éƒ¨åˆ†ï¼Œåªæ˜¯å®ƒçš„å®ç°ç»†èŠ‚è€Œå·²ã€‚

> åœ¨ Java å¹³å°ç±»åº“ä¸­ï¼Œæœ‰è®¸å¤šæ˜æ˜¾è¿åè¿™æ¡åŸåˆ™çš„åœ°æ–¹ã€‚ ä¾‹å¦‚ï¼Œæ ˆï¼ˆ`Stack`ï¼‰å¹¶ä¸æ˜¯å‘é‡ï¼ˆ`Vector`ï¼‰ï¼Œæ‰€ä»¥ `Stack` ä¸åº”è¯¥æ‰©å±• `Vector`ã€‚åŒæ ·åœ°ï¼Œå±æ€§åˆ—è¡¨ä¹Ÿä¸æ˜¯æ•£åˆ—è¡¨ï¼Œæ‰€ä»¥ `Properties` ä¸åº”è¯¥æ‰©å±• `Hashtable`ã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œå¤åˆæ¨¡å¼æ‰æ˜¯æ°å½“çš„ ã€‚
> 
> Properties ä¸åˆé€‚çš„ç»§æ‰¿å¸¦æ¥çš„é—®é¢˜ï¼š
> 
> -   p.getProperty(key) æœ‰å¯èƒ½äº§ç”Ÿä¸ p.get(key) ä¸åŒçš„ç»“æœï¼Œå› ä¸ºå‰ä¸€ä¸ªæ–¹æ³•æ˜¯å­ç±»æ‰©å±•çš„ï¼Œè€ƒè™‘äº†é»˜è®¤çš„å±æ€§è¡¨ï¼Œè€Œåä¸€ä¸ªæ–¹æ³•ç»§æ‰¿å­ Hashtableï¼Œæ²¡æœ‰è€ƒè™‘é»˜è®¤çš„å±æ€§åˆ—è¡¨ã€‚
>     
> -   Properties è®¾è®¡çš„ç›®æ ‡æ˜¯åªå…è®¸å­—ç¬¦ä¸²ä½œä¸º key å’Œ valueï¼Œå¦‚æœç›´æ¥è°ƒç”¨è¶…ç±» Hashtable çš„ put æ–¹æ³•ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿åè¿™ä¸ªçº¦æŸæ¡ä»¶ã€‚
>     

## 19. è¦ä¹ˆè®¾è®¡ç»§æ‰¿å¹¶æä¾›æ–‡æ¡£è¯´æ˜ï¼Œè¦ä¹ˆç¦æ­¢ç»§æ‰¿

TODO

## 20. æ¥å£ä¼˜äºæŠ½è±¡ç±»

> Java 8 ä¸ºæ¥å£å¼•å…¥äº†é»˜è®¤æ–¹æ³•ã€‚
> 
> å› ä¸ºå¦‚æœè¦ä¸ºæ¥å£æ‰©å±•å…¶ä»–æ–¹æ³•ï¼Œé‚£ä¹ˆæ‰€æœ‰å·²ç»å®ç°æ¥å£çš„ç±»éƒ½å¿…é¡»è¦å®ç°è¿™ä¸ªæ–¹æ³•ã€‚
> 
> Â interface Cat {  
> Â  //æŠ½è±¡æ–¹æ³•  
> Â     void play();   
> Â â€‹  
> Â     //é™æ€æ–¹æ³•  
> Â     static void eat() {  
> Â         System.out.println("çŒ«åƒé±¼");  
> Â     }  
> Â â€‹  
> Â     //é»˜è®¤æ–¹æ³•  
> Â     default void run() {  
> Â         System.out.println("çŒ«è·‘");  
> Â     }  
> Â     default void climb() {  
> Â         System.out.println("çŒ«çˆ¬æ ‘");  
> Â     }  
> Â }  
> Â â€‹  
> Â class WhiteCat implements Cat {  
> Â     @Override  
> Â     public void play() {  
> Â         System.out.println("ç™½çŒ«ç©");  
> Â     }  
> Â â€‹  
> Â  // é‡å†™é»˜è®¤æ–¹æ³•  
> Â     @Override  
> Â     public void run() {  
> Â         System.out.println("ç™½çŒ«è·‘");  
> Â     }  
> Â }

### æ¥å£çš„ä¼˜ç‚¹

-   -   Java åªå…è®¸å•ç»§æ‰¿ï¼Œæ‰€ä»¥ç”¨æŠ½è±¡ç±»ä½œä¸ºç±»å‹å®šä¹‰å—åˆ°äº†é™åˆ¶ã€‚
        
    -   ä½†ç±»å±‚æ¬¡ç»“æ„ä¸­ä»»ä½•ä½ç½®çš„ç±»éƒ½å…è®¸å®ç°ä¸€ä¸ªæ¥å£ã€‚
        
-   -   å¦‚æœéœ€è¦æ–°çš„æ¥å£ï¼Œç°æœ‰çš„ç±»å¾ˆå®¹æ˜“å»å®ç°ï¼›
        
    -   ä½†å¦‚æœç°æœ‰çš„ç±»å·²ç»æœ‰äº†çˆ¶ç±»ï¼Œå°±æ— æ³•ç»§æ‰¿æ–°çš„æŠ½è±¡ç±»ã€‚å¦‚æœæ²¡æœ‰çˆ¶ç±»ï¼Œå¹¶é€‰æ‹©å»ç»§æ‰¿æ–°çš„æŠ½è±¡ç±»ï¼Œé‚£ä¹ˆä¹‹åè¿™ä¸ªç°æœ‰ç±»çš„æ‰€æœ‰å­ç±»ä¹Ÿéƒ½ä¼šåŸºå±‚è¿™ä¸ªæŠ½è±¡ç±»ï¼Œæ— è®ºæ˜¯å¦åˆé€‚ã€‚
        
-   -   **æ¥å£æ˜¯å®šä¹‰ mixinï¼ˆæ··åˆç±»å‹ï¼‰çš„ç†æƒ³é€‰æ‹©ã€‚**mixin æ¥å£è¡¨æ˜å®ƒæä¾›äº†æŸäº›å¯ä¾›é€‰æ‹©çš„è¡Œä¸ºï¼Œä¾‹å¦‚ Comparableã€‚ä¹‹æ‰€ä»¥è¢«ç§°ä¸º mixinï¼Œæ˜¯å› ä¸ºå®ƒå…è®¸ä»»é€‰çš„åŠŸèƒ½å¯è¢«æ··åˆåˆ°ç±»å‹çš„ä¸»è¦åŠŸèƒ½ä¸­ã€‚
        
    -   è€ŒæŠ½è±¡ç±»ä¸èƒ½è¢«ç”¨äºå®šä¹‰ mixinï¼ŒåŒæ ·ä¹Ÿæ˜¯å› ä¸ºå•ç»§æ‰¿ï¼Œä¸”ç±»å±‚æ¬¡ç»“æ„ä¸­ä¹Ÿæ²¡æœ‰é€‚å½“çš„åœ°æ–¹æ¥æ’å…¥ mixinã€‚
        
-   -   **æ¥å£å…è®¸æ„é€ éå±‚æ¬¡ç»“æ„çš„ç±»å‹æ¡†æ¶ã€‚**ç±»å‹å±‚æ¬¡å¯¹äºç»„ç»‡æŸäº›äº‹ç‰©æ˜¯éå¸¸åˆé€‚çš„ï¼Œä½†æ˜¯å…¶ä»–äº‹ç‰©å¹¶ä¸èƒ½è¢«æ•´é½åœ°ç»„ç»‡æˆä¸€ä¸ªä¸¥æ ¼çš„å±‚æ¬¡ç»“æ„ã€‚ä¾‹å¦‚åœ¨ç°å®ç”Ÿæ´»ä¸­ï¼Œæœ‰äº› Singer åŒæ—¶ä¹Ÿæ˜¯ Songwriterï¼Œæ‰€ä»¥å¯¹äºå•ä¸ªç±»è€Œè¨€ï¼Œå¯ä»¥åŒæ—¶å®ç° Singer å’Œ Songwriter æ¥å£ã€‚ç”šè‡³å¯ä»¥å®šä¹‰ç¬¬ä¸‰ä¸ªæ¥å£ï¼ŒåŒæ—¶æ‰©å±• Singer å’Œ Songwriterï¼Œå¹¶æ·»åŠ ä¸€äº›é€‚åˆäºè¿™ç§ç»„åˆçš„æ–°æ–¹æ³•ã€‚
        
        Â public interface Singer {  
        Â  Â  Â AudioClip sing(Song s);  
        Â }  
        Â public interface Songwriter {  
        Â  Â  Â Song compose(int chartPosition);  
        Â }  
        Â â€‹  
        Â public interface SingerSongwriter extends Singer Songwriter {  
        Â  Â  Â AudioClip strum();  
        Â  Â  Â void actSensitve();  
        Â }
        
    -   å¦‚æœé‡‡ç”¨æŠ½è±¡ç±»ï¼Œåœ¨ç±»å‹ç³»ç»Ÿä¸­æœ‰ n ä¸ªç±»ä¼¼ Singer çš„ç±»ï¼Œé‚£ä¹ˆå°±å¿…é¡»æ”¯æŒ 2^n ç§å¯èƒ½çš„ç»„åˆã€‚è€Œä¸”ä¼šå¯¼è‡´ç±»åŒ…å«è®¸å¤šæ–¹æ³•ï¼Œå¹¶ä¸”è¿™äº›æ–¹æ³•åªæ˜¯åœ¨å‚æ•°çš„ç±»å‹ä¸Šæœ‰æ‰€ä¸åŒã€‚
        
-   -   æ¥å£èƒ½å®‰å…¨çš„å®ç°ç¬¬ 18 æ¡ä¸­çš„åŒ…è£…ç±»æ¨¡å¼æ¥å¢åŠ åŠŸèƒ½ï¼ˆå®ç° Set æ¥å£ï¼Œå¹¶æŠŠ Set ç»„åˆè¿›æ¥ï¼Œå¢åŠ  Set çš„åŠŸèƒ½ï¼‰ã€‚
        
    -   å¦‚æœ Set æ˜¯æŠ½è±¡ç±»ï¼Œå°±åªèƒ½é€šè¿‡ç»§æ‰¿çš„æ‰‹æ®µã€‚è¿™æ ·å¾—åˆ°çš„ç±»æ¯”åŒ…è£…ç±»åŠŸèƒ½æ›´å·®ä¸”æ›´åŠ è„†å¼±ã€‚ï¼ˆTODOï¼šä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ç»„åˆ Setï¼Ÿï¼‰
        

### æ¥å£çš„éª¨æ¶å®ç°ç±»

é€šè¿‡å¯¹æ¥å£æä¾›ä¸€ä¸ªæŠ½è±¡çš„éª¨æ¶å®ç°ï¼ˆskeletal implementationï¼‰ç±»ï¼Œå¯ä»¥æŠŠæ¥å£å’ŒæŠ½è±¡ç±»çš„ä¼˜ç‚¹ç»“åˆèµ·æ¥ã€‚æ¥å£è´Ÿè´£å®šä¹‰ç±»å‹ï¼Œè¿˜å¯ä»¥æä¾›ä¸€äº›ç¼ºçœæ–¹æ³•ï¼Œè€Œéª¨æ¶å®ç°ç±»åˆ™è´Ÿè´£å®ç°**éåŸºæœ¬ç±»å‹æ¥å£æ–¹æ³•**ã€‚ æ‰©å±•éª¨æ¶å®ç°å äº†å®ç°æ¥å£ä¹‹å¤–çš„å¤§éƒ¨åˆ†å·¥ä½œï¼Œè¿™å°±æ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€‚

> -   å¦‚æœæä¾›äº†ç¼ºçœæ–¹æ³•ï¼Œè¦ç¡®ä¿åˆ©ç”¨ Javadoc æ ‡ç­¾ @implSpec å»ºç«‹æ–‡æ¡£ï¼ˆè¯¦è§ç¬¬ 19æ¡ï¼‰ã€‚
>     
> -   æ¥å£å¯ä»¥å®šä¹‰ equalsã€hashCode å’Œ toString ç­‰ Object ç­‰æ–¹æ³•ï¼Œä½†æ˜¯ä¸å…è®¸æä¾›å®ƒä»¬çš„ç¼ºçœæ–¹æ³•ã€‚
>     
> -   æ¥å£ä¸­ä¸å…è®¸åŒ…å«å®ä¾‹åŸŸæˆ–è€…éå…¬æœ‰çš„é™æ€æˆå‘˜ï¼ˆç§æœ‰çš„é™æ€æ–¹æ³•é™¤å¤–ï¼‰ã€‚
>     

æŒ‰ç…§æƒ¯ä¾‹ï¼Œéª¨æ¶å®ç°ç±»è¢«ç§°ä¸º `AbstractInterface`ï¼ˆä¹Ÿå¯ä»¥å«åš `SkeletalInterface`ï¼Œä½† Abstract æ›´å¸¸ç”¨ï¼‰ï¼Œè¿™é‡Œçš„ `Interface` æ˜¯æŒ‡æ‰€å®ç°çš„æ¥å£çš„åå­—ã€‚ä¾‹å¦‚ï¼Œ Collections Framework ä¸ºæ¯ä¸ªé‡è¦çš„é›†åˆæ¥å£éƒ½æä¾›äº†ä¸€ä¸ªéª¨æ¶å®ç°ï¼ŒåŒ…æ‹¬ `AbstractCollection`ã€`AbstractList` ç­‰ã€‚å¦‚æœè®¾è®¡å¾—å½“ï¼Œéª¨æ¶å®ç°ï¼ˆæ— è®ºæ˜¯å•ç‹¬ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè¿˜æ˜¯æ¥å£ä¸­å”¯ä¸€åŒ…å«çš„ç¼ºçœæ–¹æ³•ï¼‰å¯ä»¥ä½¿ç¨‹åºå‘˜æ›´æ–¹ä¾¿å®ç°æ¥å£ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªé™æ€å·¥å‚æ–¹æ³•ï¼Œé™¤ `AbstractList` ä¹‹å¤–ï¼Œå®ƒè¿˜åŒ…å«äº†ä¸€ä¸ªå®Œæ•´çš„ã€åŠŸèƒ½å…¨é¢çš„ List å®ç°ï¼š

   // Concrete implementation built atop skeletal implementation  
   static List<Integer> intArrayAsList(int[] a) {  
       Objects.requireNonNull(a);  
	   // The diamond operator is only legal here in Java 9 and later   
       // If you're using an earlier release, specify <Integer>   
       return new AbstractList<>() {  
           @Override public Integer get(int i) {  
               return a[i];  // Autoboxing (Item 6)  
		   }  
           @Override public Integer set(int i, Integer val) {  
               int oldVal = a[i];  
               a[i] = val;     // Auto-unboxing  
               return oldVal;  // Autoboxing  
		   }  
           @Override public int size() {  
               return a.length;  
           }   
       };  
	}

> å› ä¸ºè®¤ä¸º getã€set å’Œ size æ˜¯ List æ¥å£çš„åŸºæœ¬æ–¹æ³•ï¼Œæ‰€ä»¥ AbstractList å¹¶æ²¡æœ‰å®ç°å®ƒä»¬ï¼Œè®©å­ç±»å»å®ç°ã€‚

å¯¹äºæ¥å£çš„å¤§å¤šæ•°å®ç°æ¥è®²ï¼Œç»§æ‰¿éª¨æ¶å®ç°ç±»æ˜¯ä¸ªå¾ˆæ˜¾ç„¶çš„é€‰æ‹©ï¼Œä½†å¹¶ä¸æ˜¯å¿…é¡»çš„ã€‚

å¦‚æœç°æœ‰ç±»æ— æ³•ç»§æ‰¿éª¨æ¶å®ç°ç±»ï¼Œä½†ä¾ç„¶èƒ½æ‰‹åŠ¨å®ç°æ¥å£ã€‚åŒæ—¶ï¼Œè¿™ä¸ªç±»ä¹Ÿèƒ½ä½¿ç”¨æ¥å£ä¸­å‡ºç°çš„ä»»ä½•ç¼ºçœæ–¹æ³•ã€‚

æ­¤å¤–ï¼Œéª¨æ¶å®ç°ç±»æœ‰åŠ©äºæ¥å£çš„å®ç°ã€‚å®ç°äº†è¿™ä¸ªæ¥å£çš„ç±»å¯ä»¥æŠŠå¯¹äºæ¥å£æ–¹æ³•çš„è°ƒç”¨è½¬å‘åˆ°ä¸€ä¸ªå†…éƒ¨ç§æœ‰ç±»çš„å®ä¾‹ä¸Šï¼Œè¿™ä¸ªå†…éƒ¨ç§æœ‰ç±»æ‰©å±•äº†éª¨æ¶å®ç°ç±»ã€‚è¿™ç§æ–¹æ³•è¢«ç§°ä½œæ¨¡æ‹Ÿå¤šé‡ç»§æ‰¿ï¼ˆsimulated multiple inheritanceï¼‰ï¼Œå®ƒä¸ç¬¬ 18 æ¡ä¸­è®¨è®ºè¿‡çš„åŒ…è£…ç±»æ¨¡å¼å¯†åˆ‡ç›¸å…³ã€‚è¿™é¡¹æŠ€æœ¯å…·æœ‰å¤šé‡ç»§æ‰¿çš„ç»å¤§å¤šæ•°ä¼˜ç‚¹ï¼ŒåŒæ—¶åˆé¿å…äº†ç›¸åº”çš„ç¼ºé™· ã€‚// TODOï¼šæ²¡çœ‹æ‡‚

ç¼–å†™éª¨æ¶å®ç°ç±»çš„è¿‡ç¨‹ï¼šé¦–å…ˆï¼Œç¡®å®šæ¥å£ä¸­å“ªäº›æ–¹æ³•æ˜¯æœ€ä¸ºåŸºæœ¬çš„ï¼Œå…¶ä»–çš„éåŸºæœ¬æ–¹æ³•åˆ™å¯ä»¥æ ¹æ®å®ƒä»¬æ¥å®ç°ã€‚è¿™äº›åŸºæœ¬æ–¹æ³•å°†æˆä¸ºéª¨æ¶å®ç°ç±»ä¸­çš„æŠ½è±¡æ–¹æ³•ï¼ˆ**ä¸éœ€è¦åœ¨æŠ½è±¡ç±»ä¸­å£°æ˜è¿™ä¸ªæ–¹æ³•**ï¼‰ã€‚æ¥ä¸‹æ¥ï¼Œåœ¨æ¥å£ä¸­ä¸ºæ‰€æœ‰å¯ä»¥åœ¨åŸºæœ¬æ–¹æ³•ä¹‹ä¸Šç›´æ¥å®ç°çš„æ–¹æ³•æä¾›ç¼ºçœæ–¹æ³•ã€‚ å¦‚æœåŸºæœ¬æ–¹æ³•å’Œç¼ºçœæ–¹æ³•è¦†ç›–äº†æ¥å£ã€‚å°±ä¸éœ€è¦éª¨æ¶å®ç°ç±»äº†ã€‚å¦åˆ™ï¼Œå°±è¦ç¼–å†™ä¸€ä¸ªç±»ï¼Œå£°æ˜å®ç°æ¥å£ï¼Œå¹¶å®ç°æ‰€æœ‰å‰©ä¸‹çš„æ¥å£æ–¹æ³•ã€‚è¿™ä¸ªç±»ä¸­å¯ä»¥åŒ…å«ä»»ä½•éå…¬æœ‰çš„åŸŸï¼Œä»¥åŠé€‚åˆè¯¥ä»»åŠ¡çš„ä»»ä½•æ–¹æ³• ã€‚

ä»¥ Map.Entry æ¥å£ä¸ºä¾‹ï¼Œæ˜æ˜¾çš„åŸºæœ¬æ–¹æ³•æ˜¯ getKeyã€getValue å’Œï¼ˆå¯é€‰çš„ï¼‰setValueã€‚æ¥å£å®šä¹‰äº† equals å’Œ hashCode çš„è¡Œä¸ºï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ˜æ˜¾çš„ toString å®ç°ã€‚ç”±äºä¸å…è®¸ç»™ Object æ–¹æ³•æä¾›ç¼ºçœå®ç°ï¼Œå› æ­¤æ‰€æœ‰å®ç°éƒ½æ”¾åœ¨éª¨æ¶å®ç°ç±»ä¸­:

    interface Entry<K,V> {  
        K getKey();  
        V getValue();  
        V setValue();  
        boolean equals(Object o);  
        int hashCode();  
		...  
    }  
  
	// Skeletal implementation class  
   	public abstract class AbstractMapEntry<K,V>	implements Map.Entry<K,V> {  
       	// Entries in a modifiable map must override this method  
       	@Override   
        public V setValue(V value) {  
           	throw new UnsupportedOperationException();  
       	}  
          
        // Implements the general contract of Map.Entry.equals  
       	@Override   
        public boolean equals(Object o) {  
           	if (o == this)  
               	return true;  
           	if (!(o instanceof Map.Entry))  
               	return false;  
            Map.Entry<?, ?> e = (Map.Entry) o;  
        	return Objects.equals(e.getKey(), getKey()) && Objects.equals(e.getValue(), getValue());  
        }  
       	// Implements the general contract of Map.Entry.hashCode  
       	@Override   
            public int hashCode() {  
           	return Objects.hashCode(getKey()) ^ Objects.hashCode(getValue());  
		}  
       	@Override   
            public String toString() {  
           	return getKey() + "=" + getValue();  
		}   
	}

è¿™ä¸ªéª¨æ¶å®ç°ä¸èƒ½åœ¨ Map.Entry æ¥å£ä¸­å®ç°ï¼Œä¹Ÿä¸èƒ½ä½œä¸ºå­æ¥å£ï¼Œå› ä¸ºä¸å…è®¸ç¼ºçœæ–¹æ³•è¦†ç›– Object æ–¹æ³•ã€‚

å› ä¸ºéª¨æ¶å®ç°ç±»æ˜¯ä¸ºäº†ç»§æ‰¿çš„ç›®çš„è€Œè®¾è®¡çš„ï¼Œæ‰€ä»¥åº”è¯¥éµä»ç¬¬ 19 æ¡ä¸­ä»‹ç»çš„æ‰€æœ‰å…³äºè®¾è®¡å’Œæ–‡æŒ¡çš„æŒ‡å¯¼åŸåˆ™ã€‚

éª¨æ¶å®ç°ä¸Šæœ‰ä¸ªå°å°çš„ä¸åŒï¼Œå°±æ˜¯ç®€å•å®ç°ï¼ˆsimple implementationï¼‰ï¼ŒAbstractMap.SimpleEntry å°±æ˜¯ä¸ªä¾‹å­ã€‚ç®€å•å®ç°å°±åƒéª¨æ¶å®ç°ä¸€æ ·ï¼Œè¿™æ˜¯å› ä¸ºå®ƒå®ç°äº†æ¥å£ï¼Œå¹¶ä¸”æ˜¯ä¸ºäº†ç»§æ‰¿è€Œè®¾è®¡çš„ï¼Œä½†æ˜¯åŒºåˆ«åœ¨äºå®ƒä¸æ˜¯æŠ½è±¡çš„ï¼šå®ƒæ˜¯æœ€ç®€å•çš„å¯èƒ½çš„æœ‰æ•ˆå®ç°ã€‚ä½ å¯ä»¥åŸå°ä¸åŠ¨åœ°ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥çœ‹æƒ…å†µå°†å®ƒå­ç±»åŒ–ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œæ¥å£é€šå¸¸æ˜¯å®šä¹‰å…è®¸å¤šä¸ªå®ç°çš„ç±»å‹çš„æœ€ä½³é€”å¾„ã€‚å¦‚æœä½ å¯¼å‡ºäº†ä¸€ä¸ªé‡è¦çš„æ¥å£ï¼Œå°±åº”è¯¥åšå†³è€ƒè™‘åŒæ—¶æä¾›éª¨æ¶å®ç°ç±»ã€‚è€Œä¸”ï¼Œè¿˜åº”è¯¥å°½å¯èƒ½åœ°é€šè¿‡ç¼ºçœæ–¹æ³•åœ¨æ¥å£ä¸­æä¾›éª¨æ¶å®ç°ï¼Œä»¥ä¾¿æ¥å£çš„æ‰€æœ‰å®ç°ç±»éƒ½èƒ½ä½¿ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæ¥å£çš„é™åˆ¶ï¼Œé€šå¸¸ä¹Ÿé™åˆ¶äº†éª¨æ¶å®ç°ä¼šé‡‡ç”¨çš„æŠ½è±¡ç±»çš„å½¢å¼ ã€‚

> æ¯”å¦‚æœ‰ List æ¥å£ï¼ŒAbstractList å…ˆç®€å•å®ç°äº† Listã€‚sizeã€get ç­‰åŸºæœ¬æ–¹æ³•æ²¡æœ‰å®ç°ï¼Œå› ä¸ºå­ç±» size å’Œ get å®ç°ç»†èŠ‚ä¸åŒï¼Œæ‰€ä»¥ç•™ç»™å­ç±»å»å®ç°ï¼Œè€Œç±»ä¼¼ iterator å¯ä»¥é€šè¿‡å­ç±»å®ç°çš„ get æ–¹æ³•æ¥å®ç°è¿­ä»£å™¨ã€‚çœ‹ä¸æ˜ç™½çš„è¯å¯ä»¥å»çœ‹çœ‹ AbstractList ç­‰çš„æºç ã€‚
> 
> public abstract int size();  
> abstract public E get(int index);  
> ...
> 
> add çš„å†™æ³•å¦‚ä¸‹ï¼Œset å’Œ remove ä¹Ÿç±»ä¼¼ã€‚è¿™è¡¨æ˜ï¼Œå¦‚æœå­ç±»æƒ³è¦èƒ½å¤Ÿä¿®æ”¹å…ƒç´ ï¼Œè¿˜éœ€è¦é‡å†™ add(), set(), remove() æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ¥ `UnsupportedOperationException` é”™ã€‚
> 
> public boolean add(E e) {  
> 	throw new UnsupportedOperationException();  
> }

## 21. ä¸ºåä»£è®¾è®¡æ¥å£

åœ¨ Java 8 å‘è¡Œä¹‹å‰ï¼Œå¦‚æœä¸ç ´åç°æœ‰çš„å®ç°ï¼Œæ˜¯ä¸å¯èƒ½ç»™æ¥å£æ·»åŠ æ–¹æ³•çš„ã€‚åœ¨ Java 8 ä¸­ï¼Œå¢åŠ äº†ç¼ºçœæ–¹æ³•ï¼ˆdefault methodï¼‰æ„é€ ï¼Œç›®çš„å°±æ˜¯å…è®¸ç»™ç°æœ‰çš„æ¥å£æ·»åŠ æ–¹æ³•ã€‚ä½†æ˜¯ç»™ç°æœ‰æ¥å£æ·»åŠ æ–°æ–¹æ³•è¿˜æ˜¯å……æ»¡é£é™©çš„ã€‚Java 8 åœ¨æ ¸å¿ƒé›†åˆæ¥å£ä¸­å¢åŠ äº†è®¸å¤šæ–°çš„ç¼ºçœæ–¹æ³•ï¼Œä¸»è¦æ˜¯ä¸ºäº†ä¾¿äºä½¿ç”¨ lambda (è¯¦è§ç¬¬ 6ç« )ï¼ŒJava ç±»åº“çš„ç¼ºçœæ–¹æ³•æ˜¯é«˜å“è´¨çš„é€šç”¨å®ç°ã€‚è™½ç„¶å¯ä»¥ç»™ç°æœ‰æ¥å£æ·»åŠ æ–¹æ³•äº†ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ç¡®ä¿è¿™äº›æ–¹æ³•åœ¨ä¹‹å‰å­˜åœ¨çš„å®ç°ä¸­éƒ½èƒ½è‰¯å¥½è¿è¡Œã€‚

æ¯”å¦‚ï¼Œä»¥ removeIf æ–¹æ³•ä¸ºä¾‹ï¼š

// Default method added to the Collection interface in Java 8  
   	default boolean removeIf(Predicate<? super E> filter) {  
       	Objects.requireNonNull(filter);  
       	boolean result = false;  
       	for (Iterator<E> it = iterator(); it.hasNext(); ) {  
           	if (filter.test(it.next())) {  
               	it.remove();  
               	result = true;  
           	}  
		}  
		return result;  
   	}

Apache ç‰ˆæœ¬çš„ SynchronizedCollection ç±»ï¼ˆCollection çš„å®ç°ç±»ï¼‰ä¾ç„¶æœ‰äººç»´æŠ¤ï¼Œä½†æ˜¯åˆ°ç¼–å†™æœ¬ä¹¦ä¹‹æ—¶ï¼Œå®ƒä¹Ÿæ²¡æœ‰å–ä»£ removeIf æ–¹æ³•ã€‚å¦‚æœè¿™ä¸ªç±»ä¸ Java 8 ç»“åˆä½¿ç”¨ï¼Œå°†ä¼šç»§æ‰¿ removeIf çš„ç¼ºçœå®ç°ï¼Œå®ƒä¸ä¼šä¿æŒè¿™ä¸ªç±»çš„åŸºæœ¬æ‰¿è¯ºï¼šå›´ç»•ç€æ¯ä¸€ä¸ªæ–¹æ³•è°ƒç”¨æ‰§è¡Œè‡ªåŠ¨åŒæ­¥ã€‚ç¼ºçœå®ç°å‹æ ¹ä¸çŸ¥é“åŒæ­¥è¿™å›äº‹ï¼Œä¹Ÿæ— æƒè®¿é—®åŒ…å«è¯¥é”å®šå¯¹è±¡çš„åŸŸã€‚å¦‚æœå®¢æˆ·åœ¨ SynchronizedCollection å®ä¾‹ä¸Šè°ƒç”¨ removeIf æ–¹æ³•ï¼ŒåŒæ—¶å¦ä¸€ä¸ªçº¿ç¨‹å¯¹è¯¥é›†åˆè¿›è¡Œä¿®æ”¹ï¼Œå°±ä¼šå¯¼è‡´ ConcurrentModificationException æˆ–è€…å…¶ä»–å¼‚å¸¸è¡Œä¸ºã€‚

ä¸ºäº†é¿å…åœ¨ç±»ä¼¼çš„ Java å¹³å°ç±»åº“å®ç°ä¸­å‘ç”Ÿè¿™ç§å¼‚å¸¸ï¼Œå¦‚ Collections.synchronized Collection è¿”å›çš„åŒ…ç§æœ‰ç±»ï¼ŒJDK ç»´æŠ¤äººå‘˜å¿…é¡»è¦†ç›–é»˜è®¤çš„ removeIf å®ç°ã€‚

å»ºè®®å°½é‡é¿å…åˆ©ç”¨ç¼ºçœæ–¹æ³•åœ¨ç°æœ‰æ¥å£ä¸Šæ·»åŠ æ–°çš„æ–¹æ³•ï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€è¦ï¼Œä½†å°±ç®—åœ¨é‚£æ ·çš„æƒ…å†µä¸‹ä¹Ÿåº”è¯¥æ…é‡è€ƒè™‘ï¼šç¼ºçœçš„æ–¹æ³•å®ç°æ˜¯å¦ä¼šç ´åç°æœ‰çš„æ¥å£å®ç°ã€‚ç„¶è€Œï¼Œåœ¨åˆ›å»ºæ¥å£çš„æ—¶å€™ï¼Œç”¨ç¼ºçœæ–¹æ³•æä¾›æ ‡å‡†çš„æ–¹æ³•å®ç°æ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œå®ƒç®€åŒ–äº†å®ç°æ¥å£çš„ä»»åŠ¡ï¼ˆè¯¦è§ç¬¬ 20 æ¡ï¼‰ã€‚

## 22. æ¥å£åªç”¨äºå®šäºç±»å‹

å½“ç±»å®ç°æ¥å£æ—¶ï¼Œæ¥å£å°±å……å½“å¯ä»¥å¼•ç”¨è¿™ä¸ªç±»çš„å®ä¾‹çš„ç±»å‹ï¼ˆtypeï¼‰ã€‚å› æ­¤ï¼Œç±»å®ç°äº†æ¥å£ï¼Œå°±è¡¨æ˜å®¢æˆ·ç«¯å¯ä»¥å¯¹è¿™ä¸ªç±»çš„å®ä¾‹å®æ–½æŸäº›åŠ¨ä½œã€‚ä¸ºäº†ä»»ä½•å…¶ä»–ç›®çš„è€Œå®šä¹‰æ¥å£æ˜¯ä¸æ°å½“çš„ã€‚

æœ‰ä¸€ç§æ¥å£è¢«ç§°ä¸ºå¸¸é‡æ¥å£ï¼ˆconstant interfaceï¼‰ï¼Œå®ƒä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ã€‚è¿™ç§æ¥å£ä¸åŒ…å«ä»»ä½•æ–¹æ³•ï¼Œå®ƒåªåŒ…å« static final åŸŸï¼ˆæ¥å£ä¸­æ‰€æœ‰çš„åŸŸéƒ½æ˜¯ public static final çš„ï¼‰ï¼Œæ¯ä¸ªåŸŸéƒ½å¯¼å‡ºä¸€ä¸ªå¸¸é‡ã€‚ä½¿ç”¨è¿™äº›å¸¸é‡çš„ç±»å®ç°è¿™ä¸ªæ¥å£ï¼Œä»¥é¿å…ç”¨ç±»åæ¥ä¿®é¥°å¸¸é‡åã€‚ä¸‹é¢ä¸¾ä¸ªä¾‹å­:

 	// Constant interface antipattern - do not use!  
   	public interface PhysicalConstants {  
       	// Avogadro's number (1/mol)  
       	static final double AVOGADROS_NUMBER   = 6.022_140_857e23;  
       	// Boltzmann constant (J/K)  
       	static final double BOLTZMANN_CONSTANT = 1.380_648_52e-23;  
       	// Mass of the electron (kg)  
       	static final double ELECTRON_MASS      = 9.109_383_56e-31;  
   	}

å¸¸é‡æ¥å£æ¨¡å¼æ˜¯å¯¹æ¥å£çš„**ä¸è‰¯ä½¿ç”¨**ã€‚ç±»åœ¨å†…éƒ¨ä½¿ç”¨æŸäº›å¸¸é‡ï¼Œè¿™çº¯ç²¹æ˜¯å®ç°ç»†èŠ‚ã€‚å®ç°å¸¸é‡æ¥å£ä¼šå¯¼è‡´æŠŠè¿™æ ·çš„å®ç°ç»†èŠ‚æ³„éœ²åˆ°è¯¥ç±»çš„å¯¼å‡º API ä¸­ã€‚ç±»å®ç°å¸¸é‡æ¥å£å¯¹äºè¯¥ç±»çš„ç”¨æˆ·è€Œè¨€å¹¶æ²¡æœ‰ä»€ä¹ˆä»·å€¼ï¼Œæ›´ç³Ÿç³•çš„æ˜¯ï¼Œå®ƒä»£è¡¨äº†ä¸€ç§æ‰¿è¯ºï¼šå¦‚æœåœ¨å°†æ¥çš„å‘è¡Œç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªç±»è¢«ä¿®æ”¹äº†ï¼Œå®ƒä¸å†éœ€è¦ä½¿ç”¨è¿™äº›å¸¸é‡äº†ï¼Œ å®ƒä¾ç„¶å¿…é¡»å®ç°è¿™ä¸ªæ¥å£ï¼Œä»¥ç¡®ä¿äºŒè¿›åˆ¶å…¼å®¹æ€§ã€‚å¦‚æœé final ç±»å®ç°äº†å¸¸é‡æ¥å£ï¼Œå®ƒçš„æ‰€æœ‰å­ç±»çš„å‘½åç©ºé—´ä¹Ÿä¼šè¢«æ¥å£ä¸­çš„å¸¸é‡æ‰€ â€œæ±¡æŸ“â€ã€‚

> åœ¨ Javaå¹³å°ç±»åº“ä¸­æœ‰å‡ ä¸ªå¸¸é‡æ¥å£ï¼Œä¾‹å¦‚ java.io.ObjectStreamConstantsã€‚è¿™äº›æ¥å£åº”è¯¥è¢«è®¤ä¸ºæ˜¯åé¢çš„å…¸å‹ã€‚

å¦‚æœè¦å¯¼å‡ºå¸¸é‡ï¼Œå¯ä»¥æœ‰å‡ ç§åˆç†çš„é€‰æ‹©æ–¹æ¡ˆã€‚å¦‚æœè¿™äº›å¸¸é‡ä¸æŸä¸ªç°æœ‰çš„ç±»æˆ–è€…æ¥å£ç´§å¯†ç›¸å…³ï¼Œå°±åº”è¯¥æŠŠè¿™äº›å¸¸é‡æ·»åŠ åˆ°è¿™ä¸ªç±»æˆ–è€…æ¥å£ä¸­ã€‚ä¾‹å¦‚ï¼Œåœ¨ Java å¹³å°ç±»åº“ä¸­æ‰€æœ‰çš„æ•°å€¼åŒ…è£…ç±»ï¼Œå¦‚ Integer å’Œ Doubleï¼Œéƒ½å¯¼å‡ºäº† MIN_VALUE å’Œ MAX)VALUE å¸¸é‡ã€‚

å¦‚æœè¿™äº›å¸¸é‡æœ€å¥½è¢«çœ‹ä½œæšä¸¾ç±»å‹çš„æˆå‘˜ï¼Œå°±åº”è¯¥ç”¨æšä¸¾ç±»å‹ï¼ˆenum typeï¼‰ï¼ˆè¯¦è§ç¬¬ 34 æ¡ï¼‰æ¥å¯¼å‡ºè¿™äº›å¸¸é‡ã€‚å¦åˆ™ï¼Œåº”è¯¥ä½¿ç”¨ä¸å¯å®ä¾‹åŒ–çš„å·¥å…·ç±»ï¼ˆutility classï¼‰ï¼ˆè¯¦è§ç¬¬4æ¡ï¼‰æ¥å¯¼å‡ºè¿™äº›å¸¸é‡ã€‚ä¸‹é¢çš„ä¾‹å­æ˜¯å‰é¢çš„ PhysicalConstants ä¾‹å­çš„å·¥å…·ç±»ç¿»ç‰ˆï¼š

 	// Constant utility class  
	package com.effectivejava.science;  
  
   	public class PhysicalConstants {  
     	private PhysicalConstants() { }  // Prevents instantiation  
		public static final double AVOGADROS_NUMBER = 6.022_140_857e23;   
        public static final double BOLTZMANN_CONST = 1.380_648_52e-23;   
        public static final double ELECTRON_MASS = 9.109_383_56e-31;  
}

> æ³¨æ„ï¼Œæœ‰æ—¶å€™ä¼šåœ¨æ•°å­—çš„å­—é¢é‡ä¸­ä½¿ç”¨ä¸‹åˆ’çº¿ã€‚ ä»Java7å¼€å§‹ï¼Œä¸‹åˆ’çº¿çš„ä½¿ç”¨å·²ç»åˆæ³•äº†ï¼Œå®ƒå¯¹æ•°å­—å­—é¢é‡çš„å€¼æ²¡æœ‰å½±å“ï¼Œå¦‚æœä½¿ç”¨å¾—å½“ï¼Œè¿˜å¯ä»¥æå¤§åœ°æå‡å®ƒä»¬çš„å¯è¯»æ€§ã€‚å¦‚æœå…¶ä¸­åŒ…å«äº”ä¸ªæˆ–äº”ä¸ªä»¥ä¸Šè¿ç»­çš„æ•°å­—ï¼Œæ— è®ºæ˜¯æµ®ç‚¹è¿˜æ˜¯å®šç‚¹ï¼Œéƒ½è¦è€ƒè™‘åœ¨æ•°å­—çš„å­—é¢é‡ ä¸­æ·»åŠ ä¸‹åˆ’çº¿ã€‚å¯¹äºåŸºæ•°ä¸º 10 çš„å­—é¢é‡ï¼Œæ— è®ºæ˜¯æ•´æ•°è¿˜æ˜¯æµ®ç‚¹ï¼Œéƒ½åº”è¯¥ç”¨ä¸‹åˆ’çº¿æŠŠæ•°å­—éš”æˆæ¯ä¸‰ä½ä¸€ç»„ ã€‚

å·¥å…·ç±»é€šå¸¸è¦æ±‚å®¢æˆ·ç«¯è¦ç”¨ç±»åæ¥ä¿®é¥°è¿™äº›å¸¸é‡åï¼Œä¾‹å¦‚ PhysicalConstants.AVOÂ­_GADROS_NUMBERã€‚å¦‚æœå¤§é‡åˆ©ç”¨å·¥å…·ç±»å¯¼å‡ºçš„å¸¸é‡ï¼Œå¯ä»¥é€šè¿‡åˆ©ç”¨é™æ€å¯¼å…¥ï¼ˆstatic importï¼‰æœºåˆ¶ï¼Œé¿å…ç”¨ç±»åæ¥ä¿®é¥°å¸¸é‡åï¼š

 	// Use of static import to avoid qualifying constants  
   	import static com.effectivejava.science.PhysicalConstants.*;  
  
   	public class Test {  
       	double atoms(double mols) {  
           	return AVOGADROS_NUMBER * mols;  
       	}  
		...  
		// Many more uses of PhysicalConstants justify static import   
    }

## 23. ç±»å±‚æ¬¡ä¼˜å…ˆäºæ ‡ç­¾ç±»

æœ‰æ—¶å¯èƒ½ä¼šé‡åˆ°å¸¦æœ‰ä¸¤ç§ç”šè‡³æ›´å¤šç§é£æ ¼çš„å®ä¾‹çš„ç±»ï¼Œå¹¶åŒ…å«è¡¨ç¤ºå®ä¾‹é£æ ¼çš„æ ‡ç­¾ï¼ˆtagï¼‰åŸŸã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹é¢è¿™ä¸ªç±»å®ƒèƒ½å¤Ÿè¡¨ç¤ºåœ†å½¢æˆ–è€…çŸ©å½¢ï¼š

Â     // Tagged class - vastly inferior to a class hierarchy!  
Â  Â   class Figure {  
Â  Â  Â  Â   enum Shape { RECTANGLE, CIRCLE };  
Â  Â  Â  Â   // Tag field - the shape of this figure  
Â  Â  Â  Â   final Shape shape;  
Â  Â  Â  Â   // These fields are used only if shape is RECTANGLE  
Â  Â  Â  Â   double length;  
Â  Â  Â  Â   double width;  
Â  Â  Â  Â   // This field is used only if shape is CIRCLE  
Â  Â  Â  Â   double radius;  
Â  Â  Â  Â   // Constructor for circle  
Â  Â  Â  Â   Figure(double radius) {  
Â  Â  Â  Â  Â  Â   shape = Shape.CIRCLE;  
Â  Â  Â  Â  Â  Â   this.radius = radius;  
Â  Â  Â  Â   }  
Â  Â  Â  Â   // Constructor for rectangle  
Â  Â  Â  Â   Figure(double length, double width) {  
Â  Â  Â  Â  Â  Â   shape = Shape.RECTANGLE;  
Â  Â  Â  Â  Â  Â   this.length = length;  
Â  Â  Â  Â  Â  Â   this.width = width;  
Â         }  
Â  Â  Â  Â   double area() {  
Â  Â  Â  Â  Â  Â   switch(shape) {  
Â  Â  Â  Â  Â  Â  Â     case RECTANGLE:  
Â  Â  Â  Â  Â  Â  Â  Â       return length * width;  
Â  Â  Â  Â  Â  Â  Â     case CIRCLE:  
Â  Â  Â  Â  Â  Â  Â  Â       return Math.PI * (radius * radius);  
Â  Â  Â  Â  Â  Â  Â     default:  
Â  Â  Â  Â  Â  Â  Â  Â       throw new AssertionError(shape);  
Â  Â  Â  Â  Â  Â   }   
Â  Â  Â  Â   }  
Â     }

è¿™ç§æ ‡ç­¾ç±»ï¼ˆtagged classï¼‰æœ‰è®¸å¤šç¼ºç‚¹ï¼šå®ƒä»¬ä¸­å……æ–¥ç€æ ·æ¿ä»£ç ï¼ŒåŒ…æ‹¬æšä¸¾å£°æ˜ã€æ ‡ç­¾åŸŸä»¥åŠæ¡ä»¶è¯­å¥ã€‚ç”±äºå¤šä¸ªå®ç°ä¹±ä¸ƒå…«ç³Ÿåœ°æŒ¤åœ¨å•ä¸ªç±»ä¸­ï¼Œç ´åäº†å¯è¯»æ€§ã€‚ç”±äºå®ä¾‹æ‰¿æ‹…ç€å±äºå…¶ä»–é£æ ¼çš„ä¸ç›¸å…³çš„åŸŸï¼Œå› æ­¤å†…å­˜å ç”¨ä¹Ÿå¢åŠ äº†ã€‚åŸŸä¸èƒ½åšæˆ final çš„ï¼Œå¦åˆ™æ„é€ å™¨å°±è¦åˆå§‹åŒ–ä¸ç›¸å…³çš„åŸŸã€‚æ„é€ å™¨å¿…é¡»ä¸å€ŸåŠ©ç¼–è¯‘å™¨æ¥è®¾ç½®æ ‡ç­¾åŸŸï¼Œå¹¶åˆå§‹åŒ–æ­£ç¡®çš„æ•°æ®åŸŸï¼šå¦‚æœåˆå§‹åŒ–äº†é”™è¯¯çš„åŸŸï¼Œç¨‹åºå°±ä¼šåœ¨è¿è¡Œæ—¶å¤±è´¥ã€‚å¦‚æœè¦æ·»åŠ é£æ ¼ï¼Œå°±å¿…é¡»è®°å¾—ç»™æ¯ä¸ªæ¡ä»¶è¯­å¥éƒ½æ·»åŠ ä¸€ä¸ªæ¡ä»¶ã€‚æœ€åï¼Œå®ä¾‹çš„æ•°æ®ç±»å‹æ²¡æœ‰æä¾›ä»»ä½•å…³äºå…¶é£æ ¼çš„çº¿ç´¢ã€‚ä¸€å¥è¯ï¼Œæ ‡ç­¾ç±»è¿‡äºå†—é•¿ã€å®¹æ˜“å‡ºé”™ï¼Œå¹¶ä¸”æ•ˆç‡ä½ä¸‹ã€‚

å­ç±»å‹åŒ–ï¼ˆsubtypingï¼‰èƒ½æ›´å¥½çš„å®šä¹‰è¡¨ç¤ºå¤šç§é£æ ¼å¯¹è±¡çš„å•ä¸ªæ•°æ®ç±»å‹ï¼Œæ ‡ç­¾ç±»æ˜¯å¯¹ç±»å±‚æ¬¡çš„ä¸€ç§ç®€å•çš„ä»¿æ•ˆã€‚

Â     abstract class Figure {  
Â  Â  Â  Â   abstract double area();  
Â     }  
Â  Â   class Circle extends Figure {  
Â  Â  Â  Â   final double radius;  
Â  Â  Â  Â   Circle(double radius) { this.radius = radius; }  
Â         @Override double area() { return Math.PI * (radius * radius); }   
Â  Â   }  
Â     class Rectangle extends Figure {  
Â  Â  Â  Â   final double length;  
Â  Â  Â  Â   final double width;  
Â  Â  Â  Â   Rectangle(double length, double width) {  
Â  Â  Â  Â  Â  Â   this.length = length;  
Â  Â  Â  Â  Â  Â   this.width Â = width;  
Â         }  
Â  Â  Â  Â   @Override double area() { return length * width; }  
Â  Â  }

-   æ¯ä¸ªç±»å‹éƒ½æœ‰è‡ªå·±çš„å®ç°ç±»ï¼Œä¸ä¼šè¢«å…¶ä»–ç±»å‹å½±å“ï¼›
    
-   æ‰€æœ‰åŸŸéƒ½å¯ä»¥æ˜¯ final çš„ã€‚
    
-   ç¡®ä¿æ‰€æœ‰ç±»å‹éƒ½èƒ½å®ç° area() æ–¹æ³•ï¼Œä¸åƒä¹‹å‰å¯èƒ½ä¼šé—æ¼ä¸€ä¸ª switch caseã€‚
    

ç±»å±‚æ¬¡çš„å¦ä¸€ä¸ªå¥½å¤„åœ¨äºï¼Œå®ƒä»¬å¯ä»¥ç”¨æ¥åæ˜ ç±»å‹ä¹‹é—´æœ¬è´¨ä¸Šçš„å±‚æ¬¡å…³ç³»ï¼Œæœ‰åŠ©äºå¢å¼ºçµæ´»æ€§ï¼Œå¹¶æœ‰åŠ©äºæ›´å¥½åœ°è¿›è¡Œç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ã€‚å‡è®¾ä¸Šè¿°ä¾‹å­ä¸­çš„æ ‡ç­¾ç±»ä¹Ÿå…è®¸è¡¨è¾¾æ­£æ–¹å½¢ã€‚ç±»å±‚æ¬¡å¯ä»¥åæ˜ å‡ºæ­£æ–¹å½¢æ˜¯ä¸€ç§ç‰¹æ®Šçš„çŸ©å½¢è¿™ä¸€äº‹å®ï¼ˆå‡è®¾ä¸¤è€…éƒ½æ˜¯ä¸å¯å˜çš„ï¼‰ï¼š

Â class Square extends Rectangle {  
Â     Square(double side) {  
Â         super(side, side);  
Â     }  
Â }

> æ³¨æ„ï¼Œä¸Šè¿°å±‚æ¬¡ä¸­çš„åŸŸè¢«ç›´æ¥è®¿é—®ï¼Œè€Œä¸æ˜¯é€šè¿‡è®¿é—®æ–¹æ³•è®¿é—®ã€‚è¿™æ˜¯ä¸ºäº†ç®€æ´èµ·è§ï¼Œå¦‚æœå±‚æ¬¡ç»“æ„æ˜¯å…¬æœ‰çš„ï¼ˆè¯¦è§ç¬¬ 16æ¡ï¼‰ï¼Œåˆ™ä¸å…è®¸è¿™æ ·åšã€‚

## 24. é™æ€æˆå‘˜ç±»ä¼˜äºéé™æ€æˆå‘˜ç±»

åµŒå¥—ç±»ï¼ˆnested classï¼‰æ˜¯æŒ‡å®šä¹‰åœ¨å¦ä¸€ä¸ªç±»çš„å†…éƒ¨çš„ç±»ã€‚åµŒå¥—ç±»å­˜åœ¨çš„ç›®çš„åº”è¯¥åªæ˜¯ä¸ºå®ƒçš„å¤–å›´ç±»ï¼ˆenclosing classï¼‰æä¾›æœåŠ¡ã€‚å¦‚æœåµŒå¥—ç±»å°†æ¥å¯èƒ½ä¼šç”¨äºå…¶ä»–çš„æŸä¸ªç¯å¢ƒä¸­ï¼Œå®ƒå°±åº”è¯¥æ˜¯é¡¶å±‚ç±»ï¼ˆtop-level classï¼‰ã€‚åµŒå¥—ç±»æœ‰å››ç§ï¼š**é™æ€æˆå‘˜ç±»**ï¼ˆstatic member classï¼‰ã€**éé™æ€æˆå‘˜ç±»**ï¼ˆnonstatic member classï¼‰ã€**åŒ¿åç±»**ï¼ˆanonymous classï¼‰å’Œ**å±€éƒ¨ç±»**ï¼ˆlocal classï¼‰ã€‚é™¤äº†ç¬¬ä¸€ç§ä¹‹å¤–ï¼Œå…¶ä»–ä¸‰ç§éƒ½ç§°ä¸ºå†…éƒ¨ç±»ï¼ˆinner classï¼‰ã€‚

### é™æ€æˆå‘˜ç±»

é™æ€æˆå‘˜ç±»æ˜¯æœ€ç®€å•çš„ä¸€ç§åµŒå¥—ç±»ã€‚æœ€å¥½æŠŠå®ƒçœ‹ä½œæ˜¯æ™®é€šçš„ç±»ï¼Œåªæ˜¯ç¢°å·§è¢«å£°æ˜åœ¨å¦ä¸€ä¸ªç±»çš„å†…éƒ¨è€Œå·±ï¼Œå®ƒå¯ä»¥è®¿é—®å¤–å›´ç±»çš„æ‰€æœ‰æˆå‘˜ï¼ŒåŒ…æ‹¬é‚£äº›å£°æ˜ä¸ºç§æœ‰çš„æˆå‘˜ã€‚é™æ€æˆå‘˜ç±»æ˜¯å¤–å›´ç±»çš„ä¸€ä¸ªé™æ€æˆå‘˜ï¼Œä¸å…¶ä»–çš„é™æ€æˆå‘˜ä¸€æ ·ï¼Œä¹Ÿéµå®ˆåŒæ ·çš„å¯è®¿é—®æ€§è§„åˆ™ã€‚å¦‚æœå®ƒè¢«å£°æ˜ä¸ºç§æœ‰çš„ï¼Œå®ƒå°±åªèƒ½åœ¨å¤–å›´ç±»çš„å†…éƒ¨æ‰å¯ä»¥è¢«è®¿é—®ï¼Œç­‰ç­‰ ã€‚

é™æ€æˆå‘˜ç±»çš„ä¸€ç§å¸¸è§ç”¨æ³•æ˜¯ä½œä¸º**å…¬æœ‰çš„è¾…åŠ©ç±»**ï¼Œåªæœ‰ä¸å®ƒçš„å¤–éƒ¨ç±»ä¸€èµ·ä½¿ç”¨æ‰æœ‰æ„ä¹‰ã€‚ä¾‹å¦‚ï¼Œä»¥æšä¸¾ä¸ºä¾‹ï¼Œå®ƒæè¿°äº†è®¡ç®—å™¨æ”¯æŒçš„å„ç§æ“ä½œï¼ˆè¯¦è§ç¬¬ 34 æ¡ï¼‰ã€‚Operation æšä¸¾åº”è¯¥æ˜¯ Calculator ç±»çš„å…¬æœ‰é™æ€æˆå‘˜ç±»ï¼Œä¹‹å Calculator ç±»çš„å®¢æˆ·ç«¯å°±å¯ä»¥ç”¨è¯¸å¦‚Calculator.Operation.PLUS å’Œ Calculator.Operation.MINUS è¿™æ ·çš„åç§°æ¥å¼•ç”¨è¿™äº›æ“ä½œ ã€‚

### éé™æ€æˆå‘˜ç±»

éé™æ€æˆå‘˜ç±»å’Œé™æ€æˆå‘˜ç±»è¯­æ³•åªæ˜¯å°‘äº†ä¸€ä¸ª staticï¼Œä½†æœ‰å¾ˆå¤§çš„ä¸åŒã€‚

éé™æ€æˆå‘˜ç±»çš„æ¯ä¸ªå®ä¾‹éƒ½éšå«åœ°ä¸å¤–å›´ç±»çš„ä¸€ä¸ª**å¤–å›´å®ä¾‹**ï¼ˆenclosing instanceï¼‰ç›¸å…³è”ã€‚åœ¨éé™æ€æˆå‘˜ç±»çš„å®ä¾‹æ–¹æ³•å†…éƒ¨ï¼Œå¯ä»¥è°ƒç”¨å¤–å›´å®ä¾‹ä¸Šçš„æ–¹æ³•ï¼Œæˆ–è€…åˆ©ç”¨ä¿®é¥°è¿‡çš„ this ï¼ˆqualified thisï¼‰æ„é€ è·å¾—å¤–å›´å®ä¾‹çš„å¼•ç”¨ã€‚

å¦‚æœåµŒå¥—ç±»çš„å®ä¾‹å¯ä»¥åœ¨å®ƒå¤–å›´ç±»çš„å®ä¾‹ä¹‹å¤–**ç‹¬ç«‹å­˜åœ¨**ï¼Œè¿™ä¸ªåµŒå¥—ç±»å°±å¿…é¡»æ˜¯é™æ€æˆå‘˜ç±»ï¼›åœ¨æ²¡æœ‰å¤–å›´å®ä¾‹çš„æƒ…å†µä¸‹ï¼Œè¦æƒ³åˆ›å»ºéé™æ€æˆå‘˜ç±»çš„å®ä¾‹æ˜¯ä¸å¯èƒ½çš„ã€‚

å½“éé™æ€æˆå‘˜ç±»çš„å®ä¾‹è¢«åˆ›å»ºçš„æ—¶å€™ï¼Œå®ƒå’Œå¤–å›´å®ä¾‹ä¹‹é—´çš„å…³è”å…³ç³»ä¹Ÿéšä¹‹è¢«å»ºç«‹èµ·æ¥ï¼›è€Œä¸”ï¼Œè¿™ç§å…³è”å…³ç³»ä»¥åä¸èƒ½è¢«ä¿®æ”¹ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå½“åœ¨å¤–å›´ç±»çš„æŸä¸ªå®ä¾‹æ–¹æ³•çš„å†…éƒ¨è°ƒç”¨éé™æ€æˆå‘˜ç±»çš„æ„é€ å™¨æ—¶ï¼Œè¿™ç§å…³è”å…³ç³»è¢«è‡ªåŠ¨å»ºç«‹èµ·æ¥ã€‚ä½¿ç”¨è¡¨è¾¾å¼ enclosing-Instance.new MemberClass(args) æ¥æ‰‹å·¥å»ºç«‹è¿™ç§å…³è”å…³ç³»ä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ï¼Œä½†æ˜¯å¾ˆå°‘ä½¿ç”¨ã€‚æ­£å¦‚ä½ æ‰€é¢„æ–™çš„é‚£æ ·ï¼Œè¿™ç§å…³è”å…³ç³»éœ€è¦æ¶ˆè€—éé™æ€æˆå‘˜ç±»å®ä¾‹çš„ç©ºé—´ï¼Œå¹¶ä¸”ä¼šå¢åŠ æ„é€ çš„æ—¶é—´å¼€é”€ ã€‚

éé™æ€æˆå‘˜ç±»çš„ä¸€ç§å¸¸è§ç”¨æ³•æ˜¯å®šä¹‰ä¸€ä¸ª Adapteï¼Œå®ƒå…è®¸å¤–éƒ¨ç±»çš„å®ä¾‹è¢«çœ‹ä½œæ˜¯å¦ä¸€ä¸ªä¸ç›¸å…³çš„ç±»çš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼ŒMap æ¥å£çš„å®ç°å¾€å¾€ä½¿ç”¨éé™æ€æˆå‘˜ç±»æ¥å®ç°å®ƒä»¬çš„é›†åˆè§†å›¾ï¼ˆcollection viewï¼‰è¿™äº›é›†åˆè§†å›¾æ˜¯ç”± Map çš„ keySetã€entrySet å’Œ values æ–¹æ³•è¿”å›çš„ã€‚åŒæ ·åœ°ï¼Œè¯¸å¦‚ Set å’Œ List è¿™ç§é›†åˆæ¥å£çš„å®ç°å¾€å¾€ä¹Ÿä½¿ç”¨éé™æ€æˆå‘˜ç±»æ¥å®ç°å®ƒä»¬çš„è¿­ä»£å™¨ï¼ˆiteratorï¼‰ï¼š

// Typical use of a nonstatic member class  
   	public class MySet<E> extends AbstractSet<E> {  
       	... // Bulk of the class omitted  
             
       	@Override   
        public Iterator<E> iterator() {  
           return new MyIterator();  
		}  
		private class MyIterator implements Iterator<E> {   
        	...  
    	}   
   	}

å¦‚æœå£°æ˜æˆå‘˜ç±»ä¸è¦æ±‚è®¿é—®å¤–å›´å®ä¾‹ï¼Œå°±è¦å§‹ç»ˆæŠŠä¿®é¥°ç¬¦ staticæ”¾åœ¨å®ƒçš„å£°æ˜ä¸­ï¼Œ ä½¿å®ƒ

## 25. é™åˆ¶æºæ–‡ä»¶ä¸ºå•ä¸ªé¡¶çº§ç±»

è™½ç„¶ Java ç¼–è¯‘å™¨å…è®¸åœ¨ä¸€ä¸ªæºæ–‡ä»¶ä¸­å®šä¹‰å¤šä¸ªé¡¶çº§ç±»ï¼Œä½†è¿™ä¹ˆåšå¹¶æ²¡æœ‰ä»€ä¹ˆå¥½å¤„ï¼Œåªä¼šå¸¦æ¥å·¨å¤§çš„é£é™©ã€‚å› ä¸ºåœ¨ä¸€ä¸ªæºæ–‡ä»¶ä¸­å®šä¹‰å¤šä¸ªé¡¶çº§ç±»ï¼Œå¯èƒ½å¯¼è‡´ç»™ä¸€ä¸ªç±»æä¾›å¤šä¸ªå®š ä¹‰ã€‚å“ªä¸€ä¸ªå®šä¹‰ä¼šè¢«ç”¨åˆ°ï¼Œå–å†³äºæºæ–‡ä»¶è¢«ä¼ ç»™ç¼–è¯‘å™¨çš„é¡ºåºã€‚

ä¸‹é¢è¿™ä¸ªæºæ–‡ä»¶ä¸­åªåŒ…å«ä¸€ä¸ª Main ç±»ï¼Œå®ƒå°†å¼•ç”¨å¦å¤–ä¸¤ä¸ªé¡¶çº§ç±»ï¼ˆUtensil å’Œ Dessertï¼‰çš„æˆå‘˜ï¼š

public class Main {  
	public static void main(String[] args) {  
		System.out.println(Utensil.NAME + Dessert.NAME);  
	}  
}

ç°åœ¨å‡è®¾åœ¨ä¸€ä¸ªåä¸º Utensil. java çš„æºæ–‡ä»¶ åŒæ—¶å®šä¹‰äº† Utensil å’Œ Dessertï¼š

// Two classes defined in one file. Don't ever do this!  
class Utensil {  
	static final String NAME = "pan";  
}  
class Dessert {  
	static final String NAME = "cake";  
}

ç¨‹åºä¼šè¾“å‡º "Pancake"ã€‚

ç°åœ¨å‡è®¾ä¸å°å¿ƒåœ¨å¦ä¸€ä¸ªåä¸º Dessert.java çš„æºæ–‡ä»¶ä¸­ä¹Ÿå®šä¹‰äº†åŒæ ·çš„ä¸¤ä¸ªç±»ï¼š

// Two classes defined in one file. Don't ever do this!  
class Utensil {  
	static final String NAME = "pot";  
}  
class Dessert {  
	static final String NAME = "pie";  
}

å¦‚æœä¾¥å¹¸ç”¨å‘½ä»¤ javac Main.java Dessert.java æ¥ç¼–è¯‘ç¨‹åºï¼Œé‚£ä¹ˆç¼–è¯‘å°±ä¼šå¤±è´¥ï¼Œæ­¤æ—¶ç¼–è¯‘å™¨ä¼šæé†’ä½ å®šä¹‰äº†å¤šä¸ª Utensil å’Œ Dessert ç±»ã€‚è¿™æ˜¯å› ä¸ºç¼–è¯‘å™¨ä¼šå…ˆç¼–è¯‘ Main.javaï¼Œå½“å®ƒçœ‹åˆ° Utensil çš„å¼•ç”¨ï¼ˆåœ¨ Dessert å¼•ç”¨ä¹‹å‰ï¼‰ï¼Œå°±ä¼šåœ¨ Utensil.java ä¸­æŸ¥çœ‹è¿™ä¸ªç±»ï¼Œç»“æœæ‰¾åˆ° Utensil å’Œ Dessert è¿™ä¸¤ä¸ªç±»ã€‚å½“ç¼–è¯‘å™¨åœ¨å‘½ä»¤è¡Œé‡åˆ° Dessert.java æ—¶ä¹Ÿä¼šå»æŸ¥æ‰¾è¯¥æ–‡ä»¶ï¼Œç»“æœä¼šé‡åˆ° Utensil å’Œ Dessert è¿™ä¸¤ä¸ªå®šä¹‰ ã€‚

å¦‚æœç”¨å‘½ä»¤ javac Main.java æˆ–è€… javac Main.java Utensil.java ç¼–è¯‘ç¨‹åºï¼Œç»“æœå°†å¦‚åŒä½ è¿˜æ²¡æœ‰ç¼–å†™ Dessert. java æ–‡ä»¶ä¸€æ ·ï¼Œè¾“å‡º pancakeã€‚ä½†å¦‚æœæ˜¯ç”¨å‘½ä»¤ javac Dessert.java Main.java ç¼–è¯‘ç¨‹åºï¼Œå°±ä¼šè¾“å‡º potpieã€‚ç¨‹åºçš„è¡Œä¸ºå—æºæ–‡ä»¶è¢«ä¼ ç»™ç¼–è¯‘å™¨çš„é¡ºåºå½±å“ï¼Œè¿™æ˜¾ç„¶æ˜¯è®©äººæ— æ³•æ¥å—çš„ ã€‚

è¿™ä¸ªé—®é¢˜çš„ä¿®æ­£æ–¹æ³•å¾ˆç®€å•ï¼Œåªè¦æŠŠé¡¶çº§ç±»ï¼ˆåœ¨æœ¬ä¾‹ä¸­æ˜¯æŒ‡ Utensil å’Œ Dessertï¼‰åˆ†åˆ«æ”¾å…¥ç‹¬ç«‹çš„æºæ–‡ä»¶å³å¯ã€‚å¦‚æœä¸€å®šè¦æŠŠå¤šä¸ªé¡¶çº§ç±»æ”¾è¿›ä¸€ä¸ªæºæ–‡ä»¶ä¸­ï¼Œå°±è¦è€ƒè™‘ä½¿ç”¨é™æ€æˆå‘˜ç±»ï¼ˆè¯¦è§ç¬¬ 24æ¡ï¼‰ï¼Œä»¥æ­¤ä»£æ›¿å°†è¿™ä¸¤ä¸ªç±»åˆ†åˆ°ç‹¬ç«‹æºæ–‡ä»¶ä¸­å»ã€‚ å¦‚æœè¿™äº›ç±»æœä»äºå¦ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆå°†å®ƒä»¬åšæˆé™æ€æˆå‘˜ç±»é€šå¸¸æ¯”è¾ƒå¥½ï¼Œå› ä¸ºè¿™æ ·å¢å¼ºäº†ä»£ç çš„å¯è¯»æ€§ï¼Œå¦‚æœå°†è¿™äº›ç±»å£°æ˜ä¸ºç§æœ‰çš„ï¼ˆè¯¦è§ç¬¬ 15 æ¡ï¼‰ï¼Œè¿˜å¯ä»¥ä½¿å®ƒä»¬å‡å°‘è¢«è¯»å–çš„æ¦‚ç‡ã€‚ä»¥ä¸‹å°±æ˜¯åšæˆé™æ€æˆå‘˜ç±»çš„èŒƒä¾‹ï¼š

	// Static member classes instead of multiple top-level classes  
   	public class Test {  
       	public static void main(String[] args) {  
           	System.out.println(Utensil.NAME + Dessert.NAME);  
       	}  
       	private static class Utensil {  
           	static final String NAME = "pan";  
		}  
       	private static class Dessert {  
           	static final String NAME = "cake";  
        }   
    }

ç»“è®ºæ˜¾è€Œæ˜“è§ï¼šæ°¸è¿œä¸è¦æŠŠå¤šä¸ªé¡¶çº§ç±»æˆ–è€…æ¥å£æ”¾åœ¨ä¸€ä¸ªæºæ–‡ä»¶ä¸­ã€‚éµå¾ªè¿™ä¸ªè§„åˆ™å¯ä»¥ç¡®ä¿ç¼–è¯‘æ—¶ä¸€ä¸ªç±»ä¸ä¼šæœ‰å¤šä¸ªå®šä¹‰ã€‚è¿™ä¹ˆåšåè¿‡æ¥ä¹Ÿèƒ½ç¡®ä¿ç¼–è¯‘äº§ç”Ÿçš„ç±»æ–‡ä»¶ï¼Œä»¥åŠç¨‹åºç»“æœçš„è¡Œä¸ºï¼Œéƒ½ä¸ä¼šå—åˆ°æºæ–‡ä»¶è¢«ä¼ ç»™ç¼–è¯‘å™¨æ—¶çš„é¡ºåºçš„å½±å“ã€‚

# å››. æ³›å‹

> å£°æ˜ä¸­å…·æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªç±»å‹å‚æ•°ï¼ˆtype parameterï¼‰çš„ç±»æˆ–è€…æ¥å£ï¼Œå°±æ˜¯æ³›å‹ï¼ˆgenericï¼‰ç±»æˆ–è€…æ¥å£ã€‚æ³›å‹ç±»å’Œæ¥å£ç»Ÿç§°ä¸ºæ³›å‹ï¼ˆgeneric typeï¼‰ã€‚

## 26. è¯·ä¸è¦ä½¿ç”¨åŸç”Ÿæ€ç±»å‹

æ¯ä¸€ç§æ³›å‹å®šä¹‰ä¸€ç§å‚æ•°åŒ–çš„ç±»å‹ï¼ˆparameterized typeï¼‰ï¼Œæ„æˆæ ¼å¼ä¸ºï¼šå…ˆæ˜¯ç±»æˆ–è€…æ¥å£çš„åç§°ï¼Œç„¶åç”¨å°–æ‹¬å·æŠŠå¯¹åº”äºæ³›å‹å½¢å¼ç±»å‹å‚æ•°çš„å®é™…ç±»å‹å‚æ•°ï¼ˆactual type parameterï¼‰åˆ—è¡¨æ‰©èµ·æ¥ã€‚ä¾‹å¦‚ï¼ŒList<String>ï¼ˆè¯»ä½œ â€œå­—ç¬¦ä¸²åˆ—è¡¨â€ï¼‰æ˜¯ä¸€ä¸ªå‚æ•°åŒ–çš„ç±»å‹ï¼Œè¡¨ç¤ºå…ƒç´ ç±»å‹ä¸º String çš„åˆ—è¡¨ã€‚ï¼ˆString æ˜¯ä¸å½¢å¼çš„ç±»å‹å‚æ•° E ç›¸å¯¹åº”çš„å®é™…ç±»å‹å‚æ•°ã€‚ï¼‰

æ¯ä¸€ç§æ³›å‹éƒ½å®šä¹‰ä¸€ä¸ªåŸç”Ÿæ€ç±»å‹ï¼ˆraw typeï¼‰ï¼Œå³ä¸å¸¦ä»»ä½•å®é™…ç±»å‹å‚æ•°çš„æ³›å‹åç§°ã€‚ä¾‹å¦‚ï¼Œä¸ List<E> ç›¸å¯¹åº”çš„åŸç”Ÿæ€ç±»å‹æ˜¯ Listã€‚

å¦‚æœä½¿ç”¨åŸç”Ÿæ€ç±»å‹ï¼Œå°±å¤±æ‰äº†æ³›å‹åœ¨å®‰å…¨æ€§å’Œæè¿°æ€§æ–¹é¢çš„æ‰€æœ‰ä¼˜åŠ¿ã€‚å®ƒä»¬çš„å­˜åœ¨ä¸»è¦æ˜¯ä¸ºäº†ä¸æ³›å‹å‡ºç°å‰çš„ä»£ç ç›¸å…¼å®¹ã€‚

1.  åŸç”Ÿæ€ç±»å‹é€ƒé¿äº†æ³›å‹æ£€æŸ¥ï¼Œå¦‚ Listï¼Œå¯ä»¥æ’å…¥ä»»ä½•å…ƒç´ ï¼Œåœ¨å–å‡ºçš„æ—¶å€™å¾ˆå®¹æ˜“å‘ç”Ÿè½¬å‹é”™è¯¯ï¼Œè€Œä¸”è¿™ç§é”™è¯¯åœ¨ç¼–è¯‘å™¨ä¸ä¼šè¢«å‘ç°ã€‚
    
2.  æ³›å‹æœ‰å­ç±»å‹åŒ–ï¼ˆsubtypingï¼‰çš„è§„åˆ™ï¼ŒList<String> æ˜¯åŸç”Ÿæ€ç±»å‹ List çš„ä¸€ä¸ªå­ç±»å‹ï¼Œè€Œä¸æ˜¯å‚æ•°åŒ–ç±»å‹ List<Object> çš„å­ç±»å‹ï¼ˆè¯¦è§ç¬¬ 28 æ¡ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœä½¿ç”¨åƒ List è¿™æ ·çš„åŸç”Ÿæ€ç±»å‹ï¼Œå°±ä¼šå¤±æ‰ç±»å‹å®‰å…¨æ€§ ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨åƒ List<Object>è¿™æ ·çš„å‚æ•°åŒ–ç±»å‹ï¼Œåˆ™ä¸ä¼š ã€‚
    
    // Fails at runtime - unsafeAdd method uses a raw type (List)!  
    public static void main(String[] args) {  
    	List<String> strings = new ArrayList<>();   
        unsafeAdd(strings, 	Integer.valueOf(42));  
    	String s = strings.get(0); // Has compiler-generated cast  
    }  
      
    private static void unsafeAdd(List list, Object o) {   
        list.add(o);  
    }
    
    è¿™æ®µç¨‹åºå¯ä»¥ç¼–è¯‘ï¼Œä½†æ˜¯è¿è¡Œæ—¶ä¼šæ”¶åˆ° ClassCastException å¼‚å¸¸ã€‚
    
    Test.java:10: warning: [unchecked] unchecked call to add(E) as a member of the raw type List  
    	list.add(o);  
    			^
    
    å¦‚æœåœ¨ unsafeAdd å£°æ˜ä¸­ç”¨å‚æ•°åŒ–ç±»å‹ List<Object> ä»£æ›¿åŸç”Ÿæ€ç±»å‹ Listï¼Œç¼–è¯‘çš„æ—¶å€™å°±ä¼šæŠ¥é”™ã€‚
    
    Test.java:5: error: incompatible types: List<String> cannot be converted to List<Object>  
    	unsafeAdd(strings, Integer.valueOf(42));  
    		^
    
3.  å¦‚æœè¦ç»Ÿè®¡é›†åˆå…ƒç´ ä¸ªæ•°ï¼Œä¸‹é¢çš„æ–¹æ³•æ˜¯å¯è¡Œçš„ã€‚
    
    // Use of raw type for unknown element type - don't do this!   
    static int numElementsInCommon(Set s1, Set s2) {  
    	int result = 0;  
    	for (Object o1 : s1)  
    		if (s2.contains(o1))  
                result++;  
        return result;  
    }
    
    ä½†ä½¿ç”¨äº†åŸç”Ÿæ€ç±»å‹ï¼Œä¹Ÿæ˜¯å¾ˆå±é™©çš„ã€‚å®‰å…¨çš„æ›¿ä»£æ˜¯ä½¿ç”¨æ— é™åˆ¶çš„é€šé…ç¬¦ç±»å‹ï¼ˆunbounded wildcard typeï¼‰ã€‚
    
    // Uses unbounded wildcard type - typesafe and flexible   
    static int numElementsInCommon(Set<?> s1, Set<?> s2) { ... }
    
    ç”±äºå¯ä»¥å°†ä»»ä½•å…ƒç´ æ”¾è¿›ä½¿ç”¨åŸç”Ÿæ€ç±»å‹çš„é›†åˆä¸­ï¼Œå› æ­¤å¾ˆå®¹æ˜“ç ´åè¯¥é›†åˆçš„ç±»å‹çº¦æŸæ¡ä»¶ï¼›**ä½†ä¸èƒ½å°†ä»»ä½•å…ƒç´ ï¼ˆé™¤äº† null ä¹‹å¤–ï¼‰æ”¾åˆ° Collection<?> ä¸­**ã€‚å¦‚æœå°è¯•è¿™ä¹ˆåšï¼Œå°†ä¼šäº§ç”Ÿä¸€æ¡åƒä¸‹é¢è¿™æ ·çš„ç¼–è¯‘æ—¶é”™è¯¯æ¶ˆæ¯ã€‚Collection<?> è¡¨ç¤ºèƒ½åŒ…å«æŸç§æœªçŸ¥å¯¹è±¡ç±»å‹çš„ä¸€ä¸ªé›†åˆã€‚
    
     WildCard.java:13: error: incompatible types: String cannot be converted to CAP#1  
    	c.add("verboten");  
    		^  
    	where CAP#1 is a fresh type-variable:  
           CAP#1 extends Object from capture of ?
    

ä¸è¦ä½¿ç”¨åŸç”Ÿæ€ç±»å‹ï¼Œè¿™æ¡è§„åˆ™æœ‰å‡ ä¸ªå°å°çš„ä¾‹å¤–ã€‚

-   å¿…é¡»åœ¨ç±»æ–‡å­—ï¼ˆclass literalï¼‰ä¸­ä½¿ç”¨åŸç”Ÿæ€ç±»å‹ã€‚ è§„èŒƒä¸å…è®¸ä½¿ç”¨å‚æ•°åŒ–ç±»å‹ï¼ˆè™½ç„¶å…è®¸æ•°ç»„ç±»å‹å’ŒåŸºæœ¬ç±»å‹ï¼‰ã€‚æ¢å¥è¯è¯´ï¼ŒList.classã€String[].class å’Œ int[].class éƒ½åˆæ³•ï¼Œä½†æ˜¯ List<String>.class å’Œ List<?>.class åˆ™ä¸åˆæ³•ã€‚
    
-   è¿™æ¡è§„åˆ™çš„ç¬¬äºŒä¸ªä¾‹å¤–ä¸ instanceof æ“ä½œç¬¦æœ‰å…³ã€‚ç”±äºæ³›å‹ä¿¡æ¯å¯ä»¥åœ¨è¿è¡Œæ—¶è¢«æ“¦é™¤ï¼Œå› æ­¤åœ¨å‚æ•°åŒ–ç±»å‹è€Œéæ— é™åˆ¶é€šé…ç¬¦ç±»å‹ä¸Šä½¿ç”¨ instanceof æ“ä½œç¬¦æ˜¯éæ³•çš„ã€‚ç”¨æ— é™åˆ¶é€šé…ç¬¦ç±»å‹ä»£æ›¿åŸç”Ÿæ€ç±»å‹ï¼Œå¯¹ instanceof æ“ä½œç¬¦çš„è¡Œä¸ºä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°–æ‹¬å· ï¼ˆ<>ï¼‰å’Œé—®å·ï¼ˆ?ï¼‰å°±æ˜¾å¾—å¤šä½™äº†ã€‚ä¸‹é¢æ˜¯åˆ©ç”¨æ³›å‹æ¥ä½¿ç”¨ instanceof æ“ä½œç¬¦çš„é¦–é€‰æ–¹æ³•ï¼š
    
    // Legitimate use of raw type - instanceof operator   
    if (o instanceof Set) { // Raw type  
    	Set<?> s = (Set<?>) o; // Wildcard type  
    	...   
    }
    
    æ³¨æ„ï¼Œä¸€æ—¦ç¡®å®šè¿™ä¸ª o æ˜¯ä¸ª Setï¼Œå°±å¿…é¡»å°†å®ƒè½¬æ¢æˆé€šé…ç¬¦ç±»å‹ Set<?>ï¼Œè€Œä¸æ˜¯è½¬æ¢æˆåŸç”Ÿæ€ç±»å‹ Setã€‚è¿™æ˜¯ä¸ªå—æ£€çš„ï¼ˆcheckedï¼‰è½¬æ¢ï¼Œå› æ­¤ä¸ä¼šå¯¼è‡´ç¼–è¯‘æ—¶è­¦å‘Š ã€‚
    

![Screen Shot 2021-06-05 at 13.36.13](https://chp-image-hosting.oss-cn-hangzhou.aliyuncs.com/uPic/Screen%20Shot%202021-06-05%20at%2013.36.13.png)

## 27. æ¶ˆé™¤éå—æ£€çš„è­¦å‘Š

ç”¨æ³›å‹ç¼–ç¨‹æ—¶ä¼šé‡åˆ°è®¸å¤šç¼–è¯‘å™¨è­¦å‘Šï¼šéå—æ£€è½¬æ¢è­¦å‘Šï¼ˆunchecked cast warningï¼‰ã€éå—æ£€æ–¹æ³•è°ƒç”¨è­¦å‘Šã€éå—æ£€å‚æ•°åŒ–å¯å˜å‚æ•°ç±»å‹è­¦å‘Šï¼ˆunchecked parameterized vararg type warningï¼‰ï¼Œä»¥åŠéå—æ£€è½¬æ¢è­¦å‘Šï¼ˆunchecked conversion warningï¼‰ã€‚

è¦å°½å¯èƒ½åœ°æ¶ˆé™¤æ¯ä¸€ä¸ªéå—æ£€è­¦å‘Šï¼Œå¦‚æœæ— æ³•æ¶ˆé™¤è­¦å‘Šï¼ŒåŒæ—¶å¯ä»¥è¯æ˜å¼•èµ·è­¦å‘Šçš„ä»£ç æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œåªæœ‰åœ¨è¿™ç§æƒ…å†µä¸‹æ‰å¯ä»¥ç”¨ä¸€ä¸ª @SuppressWarnings("unchecked") æ³¨è§£æ¥ç¦æ­¢è¿™æ¡è­¦å‘Šã€‚

SuppressWarnings æ³¨è§£å¯ä»¥ç”¨åœ¨ä»»ä½•ç²’åº¦çš„çº§åˆ«ä¸­ï¼Œä»å•ç‹¬çš„å±€éƒ¨å˜é‡å£°æ˜åˆ°æ•´ä¸ªç±»éƒ½å¯ä»¥ã€‚åº”è¯¥å§‹ç»ˆåœ¨å°½å¯èƒ½å°çš„èŒƒå›´å†…ä½¿ç”¨ SuppressWarnings æ³¨è§£ã€‚å®ƒé€šå¸¸æ˜¯ä¸ªå˜é‡å£°æ˜ï¼Œæˆ–æ˜¯éå¸¸ç®€çŸ­çš„æ–¹æ³•æˆ–æ„é€ å™¨ã€‚

å¦‚æœå‘ç°è‡ªå·±åœ¨é•¿åº¦ä¸æ­¢ä¸€è¡Œçš„æ–¹æ³•æˆ–è€…æ„é€ å™¨ä¸­ä½¿ç”¨äº† SuppressWarnings æ³¨è§£ï¼Œå¯ä»¥å°†å®ƒç§»åˆ°ä¸€ä¸ªå±€éƒ¨å˜é‡çš„å£°æ˜ä¸­ã€‚ è™½ç„¶ä½ å¿…é¡»å£°æ˜ä¸€ä¸ªæ–°çš„å±€éƒ¨å˜é‡ï¼Œä¸è¿‡è¿™ä¹ˆåšè¿˜æ˜¯å€¼å¾—çš„ã€‚ä¾‹å¦‚ï¼Œçœ‹çœ‹ ArrayList ç±»å½“ä¸­çš„ toArray æ–¹æ³•ï¼š

public <T> T[] toArray(T[] a) {  
	if (a.length < size)  
        return (T[]) Arrays.copyOf(elements, size, a.getClass());  
    System.arraycopy(elements, 0, a, 0, size);  
    if (a.length > size)  
        a[size] = null;  
    return a;  
}

å¦‚æœç¼–è¯‘ ArrayListï¼Œè¯¥æ–¹æ³•å°±ä¼šäº§ç”Ÿè¿™æ¡è­¦å‘Šï¼š

ArrayList.java:305: warning: [unchecked] unchecked cast  
return (T[]) Arrays.copyOf(elements, size, a.getClass());  
							^  
     required: T[]  
     found:    Object[]

å°† SuppressWarnings æ³¨è§£æ”¾åœ¨ return è¯­å¥ä¸­æ˜¯åˆæ³•çš„ï¼Œå› ä¸ºå®ƒä¸æ˜¯å£°æ˜ã€‚ä½ å¯ä»¥è¯•ç€å°†æ³¨è§£æ”¾åœ¨æ•´ä¸ªæ–¹æ³•ä¸Šï¼Œä½†æ˜¯åœ¨å®è·µä¸­åƒä¸‡ä¸è¦è¿™ä¹ˆåšï¼Œè€Œæ˜¯åº”è¯¥å£°æ˜ä¸€ä¸ªå±€éƒ¨å˜é‡æ¥ä¿å­˜è¿”å›å€¼ï¼Œå¹¶æ³¨è§£å…¶å£°æ˜ï¼Œåƒè¿™æ ·ï¼š

// Adding local variable to reduce scope of @SuppressWarnings  
public <T> T[] toArray(T[] a) {  
	if (a.length < size) {  
        // This cast is correct because the array we're creating   
        // is of the same type as the one passed in, which is T[]. 		  
        @SuppressWarnings("unchecked") T[] result =  
            (T[]) Arrays.copyOf(elements, size, a.getClass());  
        return result;  
    }  
          
    System.arraycopy(elements, 0, a, 0, size);  
    if (a.length > size)  
        a[size] = null;  
    return a;  
}

æ¯å½“ä½¿ç”¨ SuppressWarnings("unchecked") æ³¨è§£æ—¶ï¼Œéƒ½è¦æ·»åŠ ä¸€æ¡æ³¨é‡Šï¼Œè¯´æ˜ä¸ºä»€ä¹ˆè¿™ä¹ˆåšæ˜¯å®‰å…¨çš„ã€‚è¿™æ ·å¯ä»¥å¸®åŠ©å…¶ä»–äººç†è§£ä»£ç ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå¯ä»¥å°½é‡å‡å°‘å…¶ä»–äººä¿®æ”¹ä»£ç åå¯¼è‡´è®¡ç®—ä¸å®‰å…¨çš„æ¦‚ç‡ã€‚å¦‚æœä½ è§‰å¾—è¿™ç§æ³¨é‡Šå¾ˆéš¾ç¼–å†™ï¼Œå°±è¦å¤šåŠ æ€è€ƒã€‚æœ€ç»ˆä½ ä¼šå‘ç°éå—æ£€æ“ä½œæ˜¯éå¸¸ä¸å®‰å…¨çš„ã€‚

## 28. åˆ—è¡¨ä¼˜äºæ•°ç»„

æ•°ç»„ä¸æ³›å‹ç›¸æ¯”ï¼Œæœ‰ä¸¤ä¸ªé‡è¦çš„ä¸åŒç‚¹ã€‚

é¦–å…ˆï¼Œæ•°ç»„æ˜¯åå˜çš„ï¼ˆcovariantï¼‰ï¼Œè¡¨ç¤ºå¦‚æœ Sub ä¸º Super çš„å­ç±»å‹ï¼Œé‚£ä¹ˆæ•°ç»„ç±»å‹ Sub[] å°±æ˜¯ Super[] çš„å­ç±»å‹ã€‚ç›¸åï¼Œæ³›å‹åˆ™æ˜¯å¯å˜çš„ï¼ˆinvariantï¼‰ï¼šå¯¹äºä»»æ„ä¸¤ä¸ªä¸åŒçš„ç±»å‹ Type1 å’Œ Type2ï¼ŒList<Type1> æ—¢ä¸æ˜¯ List<Type2> çš„å­ç±»å‹ï¼Œä¹Ÿä¸æ˜¯ List<Type2> çš„è¶…ç±»å‹ã€‚ä½ å¯èƒ½è®¤ä¸ºï¼Œè¿™æ„å‘³ç€æ³›å‹æ˜¯æœ‰ç¼ºé™·çš„ï¼Œä½†å®é™…ä¸Šå¯ä»¥è¯´æ•°ç»„æ‰æ˜¯æœ‰ç¼ºé™·çš„ã€‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ˜¯åˆæ³•çš„ï¼š

// Fails at runtime!  
Object[] objectArray = new Long[l];  
objectArray[0] = â€I donâ€™t fit inâ€; // Throws ArrayStoreException

ä½†ä¸‹é¢è¿™æ®µä»£ç åˆ™ä¸åˆæ³•ï¼š

// Wonâ€™t compile!  
List<Object> ol = new Arraylist<Long>(); // Incompatible types   
al.add(â€I donâ€™t fit inâ€);

ç¬¬äºŒå¤§åŒºåˆ«åœ¨äºæ•°ç»„æ˜¯å…·ä½“åŒ–çš„ï¼ˆreifiedï¼‰ã€‚å› æ­¤æ•°ç»„ä¼šåœ¨è¿è¡Œæ—¶çŸ¥é“å’Œå¼ºåŒ–å®ƒä»¬çš„å…ƒç´ ç±»å‹ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œå¦‚æœä¼å›¾å°† String ä¿å­˜åˆ° Long æ•°ç»„ä¸­ï¼Œå°±ä¼šå¾—åˆ°ä¸€ä¸ªArrayStoreException å¼‚å¸¸ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œæ³›å‹åˆ™æ˜¯é€šè¿‡æ“¦é™¤ï¼ˆerasureï¼‰æ¥å®ç°çš„ã€‚è¿™æ„å‘³ç€ï¼Œ**æ³›å‹åªåœ¨ç¼–è¯‘æ—¶å¼ºåŒ–å®ƒä»¬çš„ç±»å‹ä¿¡æ¯ï¼Œå¹¶åœ¨è¿è¡Œæ—¶ä¸¢å¼ƒ**ï¼ˆæˆ–è€…æ“¦é™¤ï¼‰å®ƒä»¬çš„å…ƒç´ ç±»å‹ä¿¡æ¯ ã€‚ æ“¦é™¤å°±æ˜¯ä½¿æ³›å‹å¯ä»¥ä¸æ²¡æœ‰ä½¿ç”¨æ³›å‹çš„ä»£ç éšæ„è¿›è¡Œäº’ç”¨ï¼ˆè¯¦è§ç¬¬ 26 æ¡ï¼‰ï¼Œä»¥ç¡®ä¿åœ¨ Java 5 ä¸­å¹³æ»‘è¿‡æ¸¡åˆ°æ³›å‹ã€‚

ç”±äºä¸Šè¿°è¿™äº›æ ¹æœ¬çš„åŒºåˆ«ï¼Œå› æ­¤æ•°ç»„å’Œæ³›å‹ä¸èƒ½å¾ˆå¥½åœ°æ··åˆä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œåˆ›å»ºæ³›å‹ã€ å‚æ•°åŒ–ç±»å‹æˆ–è€…ç±»å‹å‚æ•°çš„æ•°ç»„æ˜¯éæ³•çš„ã€‚è¿™äº›æ•°ç»„åˆ›å»ºè¡¨è¾¾å¼æ²¡æœ‰ä¸€ä¸ªæ˜¯åˆæ³•çš„ï¼š`new List<E>[]`ã€`new List<String>[]` å’Œ `new E[]`ã€‚è¿™äº›åœ¨ç¼–è¯‘æ—¶éƒ½ä¼šå¯¼è‡´ä¸€ä¸ªæ³›å‹æ•°ç»„åˆ›å»ºï¼ˆgeneric array creationï¼‰é”™è¯¯ã€‚

ä¸ºä»€ä¹ˆåˆ›å»ºæ³›å‹æ•°ç»„æ˜¯éæ³•çš„ï¼Ÿå› ä¸ºå®ƒä¸æ˜¯ç±»å‹å®‰å…¨çš„ã€‚è¦æ˜¯å®ƒåˆæ³•ï¼Œç¼–è¯‘å™¨åœ¨å…¶ä»–æ­£ç¡®çš„ç¨‹åºä¸­å‘ç”Ÿçš„è½¬æ¢å°±ä¼šåœ¨è¿è¡Œæ—¶å¤±è´¥ï¼Œå¹¶å‡ºç°ä¸€ä¸ª ClassCastException å¼‚å¸¸ã€‚è¿™å°±è¿èƒŒäº†æ³›å‹ç³»ç»Ÿæä¾›çš„åŸºæœ¬ä¿è¯ã€‚ ä»¥ä¸‹é¢çš„ä»£ç ç‰‡æ®µä¸ºä¾‹ :

// Why generic array creation is illegal - wonâ€™t compile!  
List<String>[] stringlists = new List<String>[1]; 	// (1)  
List<Integer> intlist = List.of(42);				// (2)  
Object[] objects = stringlists;						// (3)  
objects[0] = intList;								// (4)  
String s = stringLists[0].get(0);					// (5)

æˆ‘ä»¬å‡è®¾ç¬¬ 1 è¡Œæ˜¯åˆæ³•çš„ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªæ³›å‹æ•°ç»„ã€‚ç¬¬ 2 è¡Œåˆ›å»ºå¹¶åˆå§‹åŒ–äº†ä¸€ä¸ªåŒ…å«å•ä¸ªå…ƒç´ çš„ `List<Integer>`ã€‚ ç¬¬ 3 è¡Œå°† `List<String>` æ•°ç»„ä¿å­˜åˆ°ä¸€ä¸ª Object æ•°ç»„å˜é‡ ä¸­ï¼Œè¿™æ˜¯åˆæ³•çš„ï¼Œå› ä¸ºæ•°ç»„æ˜¯**åå˜**çš„ã€‚ç¬¬ 4 è¡Œå°† `List<Integer>` ä¿å­˜åˆ° Object æ•°ç»„é‡Œå”¯ä¸€çš„å…ƒç´ ä¸­ï¼Œè¿™æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºæ³›å‹æ˜¯é€šè¿‡æ“¦é™¤å®ç°çš„ï¼š`List<Integer>` å®ä¾‹çš„è¿è¡Œæ—¶ç±»å‹åªæ˜¯ `List`ï¼Œ`List<String>[]` å®ä¾‹çš„è¿è¡Œæ—¶ç±»å‹åˆ™æ˜¯ `List []`ï¼Œå› æ­¤è¿™ç§å®‰æ’ä¸ä¼šäº§ç”Ÿ `ArrayStoreException` å¼‚å¸¸ã€‚ä½†ç°åœ¨æˆ‘ä»¬æœ‰éº»çƒ¦äº†ã€‚æˆ‘ä»¬å°†ä¸€ä¸ª `List<Integer>` å®ä¾‹ä¿å­˜åˆ°äº†åŸæœ¬å£°æ˜åªåŒ…å« `List<String>` å®ä¾‹çš„æ•°ç»„ä¸­ã€‚åœ¨ç¬¬ 5 è¡Œä¸­ï¼Œæˆ‘ä»¬ä»è¿™ä¸ªæ•°ç»„é‡Œå”¯ä¸€çš„åˆ—è¡¨ä¸­è·å–äº†å”¯ä¸€çš„å…ƒç´ ã€‚ç¼–è¯‘å™¨è‡ªåŠ¨åœ°å°†è·å–åˆ°çš„å…ƒç´ è½¬æ¢æˆ Stringï¼Œä½†å®ƒæ˜¯ä¸€ä¸ª Integerï¼Œå› æ­¤ï¼Œæˆ‘ä»¬åœ¨è¿è¡Œæ—¶å¾—åˆ°äº†ä¸€ä¸ª ClassCastException å¼‚å¸¸ã€‚ä¸ºäº†é˜²æ­¢å‡ºç°è¿™ç§æƒ…å†µï¼Œï¼ˆåˆ›å»ºæ³›å‹æ•°ç»„çš„ï¼‰ç¬¬ 1 è¡Œå¿…é¡»äº§ç”Ÿä¸€æ¡ç¼–è¯‘æ—¶é”™è¯¯ã€‚

ä»æŠ€æœ¯çš„è§’åº¦æ¥è¯´ï¼Œåƒ `E`ã€`List<E>` å’Œ `List<String>` è¿™æ ·çš„ç±»å‹åº”ç§°ä½œ**ä¸å¯å…·ä½“åŒ–**çš„ï¼ˆnonreifiableï¼‰ç±»å‹ã€‚ç›´è§‚åœ°è¯´ï¼Œä¸å¯å…·ä½“åŒ–çš„ï¼ˆnon-reifiableï¼‰ç±»å‹æ˜¯æŒ‡å…¶è¿è¡Œæ—¶è¡¨ç¤ºæ³•åŒ…å«çš„ä¿¡æ¯æ¯”å®ƒçš„ç¼–è¯‘æ—¶è¡¨ç¤ºæ³•åŒ…å«çš„ä¿¡æ¯æ›´å°‘çš„ç±»å‹ã€‚å”¯ä¸€å¯å…·ä½“åŒ–çš„ï¼ˆreifiableï¼‰å‚æ•°åŒ–ç±»å‹æ˜¯æ— é™åˆ¶çš„é€šé…ç¬¦ç±»å‹ï¼Œå¦‚ `List<?>` å’Œ `Map<?,?>` (è¯¦è§ç¬¬ 26 æ¡)ã€‚è™½ç„¶ä¸å¸¸ç”¨ï¼Œä½†æ˜¯**åˆ›å»ºæ— é™åˆ¶é€šé…ç±»å‹çš„æ•°ç»„æ˜¯åˆæ³•çš„**ã€‚

ç¦æ­¢åˆ›å»ºæ³›å‹æ•°ç»„å¯èƒ½æœ‰ç‚¹è®¨åŒã€‚ä¾‹å¦‚ï¼Œè¿™è¡¨æ˜æ³›å‹ä¸€èˆ¬ä¸å¯èƒ½è¿”å›å®ƒçš„å…ƒç´ ç±»å‹æ•°ç»„ï¼ˆéƒ¨åˆ†è§£å†³æ–¹æ¡ˆè¯·è§ç¬¬ 33 æ¡ï¼‰ã€‚è¿™ä¹Ÿæ„å‘³ç€åœ¨ç»“åˆä½¿ç”¨å¯å˜å‚æ•°ï¼ˆvarargsï¼‰æ–¹æ³•ï¼ˆè¯¦è§ç¬¬ 53 æ¡ï¼‰å’Œæ³›å‹æ—¶ä¼šå‡ºç°ä»¤äººè´¹è§£çš„ è­¦å‘Šã€‚è¿™æ˜¯ç”±äºæ¯å½“è°ƒç”¨å¯å˜å‚æ•°æ–¹æ³•æ—¶ï¼Œå°±ä¼šåˆ›å»ºä¸€ ä¸ªæ•°ç»„æ¥å­˜æ”¾ varargs å‚æ•°ã€‚å¦‚æœè¿™ä¸ªæ•°ç»„çš„å…ƒç´ ç±»å‹ä¸æ˜¯å¯å…·ä½“åŒ–çš„ï¼ˆreifialbeï¼‰ï¼Œå°±ä¼šå¾—åˆ°ä¸€æ¡è­¦å‘Šã€‚åˆ©ç”¨ SafeVarargs æ³¨è§£å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼ˆè¯¦è§ç¬¬ 32 æ¡ï¼‰ã€‚

å½“ä½ å¾—åˆ°æ³›å‹æ•°ç»„åˆ›å»ºé”™è¯¯æ—¶ï¼Œæœ€å¥½çš„è§£å†³åŠæ³•é€šå¸¸æ˜¯ä¼˜å…ˆä½¿ç”¨é›†åˆç±»å‹ `List<E>`ï¼Œè€Œä¸æ˜¯æ•°ç»„ç±»å‹ `E[]`ã€‚è¿™æ ·å¯èƒ½ä¼šæŸå¤±ä¸€äº›æ€§èƒ½æˆ–è€…ç®€æ´æ€§ï¼Œä½†æ˜¯æ¢å›çš„å´æ˜¯æ›´é«˜çš„ç±»å‹å®‰å…¨æ€§å’Œäº’ç”¨æ€§ ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾è¦é€šè¿‡æ„é€ å™¨ç¼–å†™ä¸€ä¸ªå¸¦æœ‰é›†åˆçš„ Chooser ç±»å’Œä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶ç”¨è¯¥æ–¹æ³•è¿”å›åœ¨é›†åˆä¸­éšæœºé€‰æ‹©çš„ä¸€ä¸ªå…ƒç´ ã€‚æ ¹æ®ä¼ ç»™æ„é€ å™¨çš„é›†åˆç±»å‹ï¼Œå¯ä»¥ç”¨ chooser å……å½“æ¸¸æˆç”¨çš„è‰²å­ç­‰ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæ²¡æœ‰ä½¿ç”¨æ³›å‹çš„ç®€å•å®ç°ï¼š

 // Chooser - a class badly in need of generics!  
public class Chooser {  
    private final Object[] choiceArray;  
    public Chooser(Collection choices) {  
        choiceArray = choices.toArray();  
    }  
    public Object choose() {  
        Random rnd = ThreadLocalRandom.current();  
        return choiceArray[rnd.nextInt(choiceArray.length)];  
    }   
}

è¦ä½¿ç”¨è¿™ä¸ªç±»ï¼Œå¿…é¡»å°† `choose` æ–¹æ³•çš„è¿”å›å€¼ï¼Œä» Object è½¬æ¢æˆæ¯æ¬¡è°ƒç”¨è¯¥æ–¹æ³•æ—¶æƒ³è¦çš„ç±»å‹ï¼Œå¦‚æœæé”™ç±»å‹ï¼Œè½¬æ¢å°±ä¼šåœ¨è¿è¡Œæ—¶å¤±è´¥ã€‚ç‰¢è®°ç¬¬ 29 æ¡çš„å»ºè®®ï¼ŒåŠªåŠ›å°† Chooser ä¿®æ”¹æˆæ³›å‹ï¼š

// A first cut at making Chooser generic - won't compile   
public class Chooser<T> {  
	private final T[] choiceArray;  
	public Chooser(Collection<T> choices) {   
        choiceArray = choices.toArray();  
    }  
      
    // choose method unchanged  
    public Object choose() {  
        Random rnd = ThreadLocalRandom.current();  
        return choiceArray[rnd.nextInt(choiceArray.length)];  
    }  
}

å¦‚æœè¯•ç€ç¼–è¯‘è¿™ä¸ªç±»ï¼Œå°†ä¼šå¾—åˆ°ä»¥ä¸‹é”™è¯¯æ¶ˆæ¯ï¼š

Chooser.java:9: error: incompatible types: Object[] cannot be converted to T[]  
           choiceArray = choices.toArray();  
                                        ^  
     where T is a type-variable:  
       T extends Object declared in class Chooser

å¯ä»¥æŠŠ Object æ•°ç»„è½¬æ¢æˆ T æ•°ç»„æ¥æ¶ˆé™¤é”™è¯¯æ¶ˆæ¯ï¼Œä½†æ˜¯ç°åœ¨å¾—åˆ°äº†ä¸€æ¡è­¦å‘Šï¼š

choiceArray = (T[]) choices.toArray();  
  
Chooser.java:9: warning: [unchecked] unchecked cast  
      choiceArray = (T[]) choices.toArray();  
                                         ^  
	required: T[], found: Object[]  
    where T is a type-variable:  
T extends Object declared in class Chooser

ç¼–è¯‘å™¨å‘Šè¯‰ä½ ï¼Œå®ƒæ— æ³•åœ¨è¿è¡Œæ—¶æ£€æŸ¥è½¬æ¢çš„å®‰å…¨æ€§ï¼Œå› ä¸ºç¨‹åºåœ¨è¿è¡Œæ—¶è¿˜ä¸çŸ¥é“ T æ˜¯ä»€ä¹ˆâ€”â€”è®°ä½ï¼ˆTODOï¼šä¸ºä»€ä¹ˆå‘¢ï¼‰ï¼Œå…ƒç´ ç±»å‹ä¿¡æ¯ä¼šåœ¨è¿è¡Œæ—¶ä»æ³›å‹ä¸­è¢«æ“¦é™¤ã€‚è¿™æ®µç¨‹åºå¯ä»¥è¿è¡Œå—ï¼Ÿå¯ä»¥ï¼Œä½†æ˜¯ç¼–è¯‘å™¨æ— æ³•è¯æ˜è¿™ä¸€ç‚¹ã€‚ä½ å¯ä»¥äº²è‡ªè¯æ˜ï¼Œåªè¦å°†è¯æ®æ”¾åœ¨æ³¨é‡Šä¸­ï¼Œç”¨ä¸€æ¡æ³¨è§£ç¦æ­¢è­¦å‘Šï¼Œä½†æ˜¯æœ€å¥½èƒ½æ¶ˆé™¤é€ æˆè­¦å‘Šçš„æ ¹æºï¼ˆè¯¦è§ç¬¬ 27æ¡ï¼‰ã€‚

è¦æ¶ˆé™¤æœªå—æ£€çš„è½¬æ¢è­¦å‘Šï¼Œå¿…é¡»é€‰æ‹©ç”¨åˆ—è¡¨ä»£æ›¿æ•°ç»„ã€‚ä¸‹é¢æ˜¯ç¼–è¯‘æ—¶æ²¡æœ‰å‡ºé”™æˆ–è€…è­¦å‘Šçš„ Chooser ç±»ç‰ˆæœ¬ï¼š

 // List-based Chooser - typesafe  
public class Chooser<T> {  
	private final List<T> choiceList;  
	public Chooser(Collection<T> choices) {   
        choiceList = new ArrayList<>(choices);  
	}  
	public T choose() {  
        Random rnd = ThreadLocalRandom.current();  
        return choiceList.get(rnd.nextInt(choiceList.size()));  
    }   
}

è¿™ä¸ªç‰ˆæœ¬çš„ä»£ç ç¨å¾®å†—é•¿ ä¸€ç‚¹ï¼Œè¿è¡Œé€Ÿåº¦å¯èƒ½ä¹Ÿä¼šæ…¢ä¸€ç‚¹ï¼Œä½†æ˜¯åœ¨è¿è¡Œæ—¶ä¸ä¼šå¾—åˆ° ClassCastException å¼‚å¸¸ï¼Œä¸ºæ­¤ä¹Ÿå€¼äº†ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œæ•°ç»„å’Œæ³›å‹æœ‰ç€æˆªç„¶ä¸åŒçš„ç±»å‹è§„åˆ™ã€‚æ•°ç»„æ˜¯åå˜ä¸”å¯ä»¥å…·ä½“åŒ–çš„ï¼›æ³›å‹æ˜¯ä¸å¯å˜çš„ä¸”å¯ä»¥è¢«æ“¦é™¤çš„ã€‚å› æ­¤ï¼Œæ•°ç»„æä¾›äº†è¿è¡Œæ—¶çš„ç±»å‹å®‰å…¨ï¼Œä½†æ˜¯æ²¡æœ‰ç¼–è¯‘æ—¶çš„ç±»å‹å®‰å…¨ï¼Œåä¹‹ï¼Œå¯¹äºæ³›å‹ä¹Ÿä¸€æ ·ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ•°ç»„å’Œæ³›å‹ä¸èƒ½å¾ˆå¥½åœ°æ··åˆä½¿ç”¨ã€‚å¦‚æœä½ å‘ç°è‡ªå·±å°†å®ƒä»¬æ··åˆèµ·æ¥ä½¿ç”¨ï¼Œå¹¶ä¸”å¾—åˆ°äº†ç¼–è¯‘æ—¶é”™è¯¯æˆ–è€…è­¦å‘Šï¼Œä½ çš„ç¬¬ä¸€ååº”å°±åº”è¯¥æ˜¯ç”¨åˆ—è¡¨ä»£æ›¿æ•°ç»„ã€‚

## 29. ä¼˜å…ˆè€ƒè™‘æ³›å‹

ä»¥ç¬¬ 7 æ¡ä¸­ç®€å•çš„å †æ ˆå®ç°ä¸ºä¾‹ï¼š

// Object-based collection - a prime candidate for generics  
public class Stack {  
	private Object[] elements;  
	private int size = 0;  
	private static final int DEFAULT_INITIAL_CAPACITY = 16;  
	public Stack() {  
		elements = new Object[DEFAULT_INITIAL_CAPACITY];  
		}  
	public void push(Object e) {   
        ensureCapacity();   
        elements[size++] = e;  
	}  
	public Object pop() {   
        if (size == 0)  
			throw new EmptyStackException();  
		Object result = elements[--size];  
		elements[size] = null; // Eliminate obsolete reference   
        return result;  
	}  
    public boolean isEmpty() {  
        return size == 0;  
	}  
    private void ensureCapacity() {  
        if (elements.length == size)  
            elements = Arrays.copyOf(elements, 2 * size + 1);  
    }   
}

è¿™ä¸ªç±»åº”è¯¥å…ˆè¢«å‚æ•°åŒ–ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åé¢å°†å®ƒæ³›å‹åŒ–ï¼ˆgenerifyï¼‰ã€‚å°†å®ƒå‚æ•°åŒ–ï¼Œä½†ä¸ä¼šç ´ååŸæ¥éå‚æ•°åŒ–ç‰ˆæœ¬çš„å®¢æˆ·ç«¯ä»£ç ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®¢æˆ·ç«¯å¿…é¡»è½¬æ¢ä»å †æ ˆé‡Œå¼¹å‡ºçš„å¯¹è±¡ï¼Œä»¥åŠå¯èƒ½åœ¨è¿è¡Œæ—¶å¤±è´¥çš„é‚£äº›è½¬æ¢ã€‚å°†ç±»æ³›å‹åŒ–çš„ç¬¬ä¸€æ­¥æ˜¯åœ¨å®ƒçš„å£°æ˜ä¸­æ·»åŠ ä¸€ä¸ªæˆ–è€…å¤šä¸ªç±»å‹å‚æ•°ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­æœ‰ä¸€ä¸ªç±»å‹å‚æ•°ï¼Œå®ƒè¡¨ç¤ºå †æ ˆçš„å…ƒç´ ç±»å‹ï¼Œè¿™ä¸ªå‚æ•°çš„åç§°é€šå¸¸ä¸º Eï¼ˆè¯¦è§ç¬¬ 68æ¡ï¼‰ã€‚

ä¸‹ä¸€æ­¥æ˜¯ç”¨ç›¸åº”çš„ç±»å‹å‚æ•°æ›¿æ¢æ‰€æœ‰çš„ Object ç±»å‹ï¼Œç„¶åè¯•ç€ç¼–è¯‘æœ€ç»ˆçš„ç¨‹åºï¼š

// Initial attempt to generify Stack - won't compile!   
public class Stack<E> {  
	private E[] elements;  
	private int size = 0;  
	private static final int DEFAULT_INITIAL_CAPACITY = 16;  
	public Stack() {  
		elements = new E[DEFAULT_INITIAL_CAPACITY];  
	}  
	public void push(E e) {   
        ensureCapacity();   
        elements[size++] = e;  
	}  
	public E pop() {   
        if (size == 0)  
			throw new EmptyStackException();  
		E result = elements[--size];  
		elements[size] = null; // Eliminate obsolete reference   
        return result;  
	}  
       ... // no changes in isEmpty or ensureCapacity  
}

è¿™ä¸ªç±»ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯ï¼š

Stack.java:8: generic array creation  
	elements = new E[DEFAULT_INITIAL_CAPACITY];  
				^

å¦‚ç¬¬ 28 æ¡ä¸­æ‰€è¿°ï¼Œä¸èƒ½åˆ›å»ºä¸å¯å…·ä½“åŒ–çš„ç±»å‹çš„æ•°ç»„ï¼Œå¦‚ Eã€‚æ¯å½“ç¼–å†™ç”¨æ•°ç»„æ”¯æŒçš„æ³›å‹æ—¶ï¼Œéƒ½ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ã€‚è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§æ–¹æ³•ã€‚

-   ç¬¬ä¸€ç§ï¼Œç›´æ¥ç»•è¿‡åˆ›å»ºæ³›å‹æ•°ç»„çš„ç¦ä»¤ï¼šåˆ›å»ºä¸€ä¸ª Object çš„æ•°ç»„ï¼Œå¹¶å°†å®ƒè½¬æ¢æˆæ³›å‹æ•°ç»„ç±»å‹ã€‚ç°åœ¨é”™ è¯¯æ˜¯æ¶ˆé™¤äº†ï¼Œä½†æ˜¯ç¼–è¯‘å™¨ä¼šäº§ç”Ÿä¸€æ¡è­¦å‘Šã€‚è¿™ç§ç”¨æ³•æ˜¯åˆæ³•çš„ï¼Œä½†ï¼ˆæ•´ä½“ä¸Šè€Œè¨€0ä¸æ˜¯ç±»å‹å®‰å…¨çš„ï¼š
    
        // The elements array will contain only E instances from push(E).   
        // This is sufficient to ensure type safety, but the runtime  
        // type of the array won't be E[]; it will always be Object[]!   
        @SuppressWarnings("unchecked")  
        public Stack() {  
            elements = (E[]) new Object[DEFAULT_INITIAL_CAPACITY];  
        }  
    	  
      
    Stack.java:8: warning: [unchecked] unchecked cast  
    found: Object[], required: E[]  
    		elements = (E[]) new Object[DEFAULT_INITIAL_CAPACITY];   
    						^
    
    ç¼–è¯‘å™¨ä¸å¯èƒ½è¯æ˜ä½ çš„ç¨‹åºæ˜¯ç±»å‹å®‰å…¨çš„ï¼Œä½†æ˜¯ä½ å¯ä»¥ã€‚ä½ è‡ªå·±å¿…é¡»ç¡®ä¿æœªå—æ£€çš„è½¬æ¢ä¸ä¼šå±åŠç¨‹åºçš„ç±»å‹å®‰å…¨æ€§ã€‚ç›¸å…³çš„æ•°ç»„ï¼ˆå³ elements å˜é‡ï¼‰ä¿å­˜åœ¨ä¸€ä¸ªç§æœ‰çš„åŸŸä¸­ï¼Œæ°¸è¿œä¸ä¼šè¢«è¿”å›åˆ°å®¢æˆ·ç«¯ï¼Œæˆ–è€…ä¼ ç»™ä»»ä½•å…¶ä»–æ–¹æ³•ã€‚è¿™ä¸ªæ•°ç»„ä¸­ä¿å­˜çš„å”¯ä¸€å…ƒç´ ï¼Œæ˜¯ä¼ ç»™ push æ–¹æ³•çš„é‚£äº›å…ƒç´ ï¼Œå®ƒä»¬çš„ç±»å‹ä¸º Eï¼Œå› æ­¤æœªå—æ£€çš„è½¬æ¢ä¸ä¼šæœ‰ä»»ä½•å±å®³ã€‚
    
    ä¸€æ—¦ä½ è¯æ˜äº†æœªå—æ£€çš„è½¬æ¢æ˜¯å®‰å…¨çš„ï¼Œå°±è¦åœ¨å°½å¯èƒ½å°çš„èŒƒå›´ä¸­ç¦æ­¢è­¦å‘Šï¼ˆè¯¦è§ç¬¬ 27 æ¡ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ„é€ å™¨åªåŒ…å«æœªå—æ£€çš„æ•°ç»„åˆ›å»ºï¼Œå› æ­¤å¯ä»¥åœ¨æ•´ä¸ªæ„é€ å™¨ä¸­ç¦æ­¢è¿™æ¡è­¦å‘Šã€‚é€šè¿‡å¢åŠ ä¸€æ¡æ³¨è§£ @SuppressWarnings æ¥å®Œæˆç¦æ­¢ï¼ŒStack èƒ½å¤Ÿæ­£ç¡®æ— è¯¯åœ°è¿›è¡Œç¼–è¯‘ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨å®ƒäº†ï¼Œæ— é¡»æ˜¾å¼çš„è½¬æ¢ï¼Œä¹Ÿæ— é¡»æ‹…å¿ƒä¼šå‡ºç° ClassCastException å¼‚å¸¸ã€‚
    
-   æ¶ˆé™¤ Stack ä¸­æ³›å‹æ•°ç»„åˆ›å»ºé”™è¯¯çš„ç¬¬äºŒç§æ–¹æ³•æ˜¯ï¼Œå°† elements åŸŸçš„ç±»å‹ä» `E[]` æ”¹ ä¸º `Object[]`ã€‚è¿™ä¹ˆåšä¼šå¾—åˆ°ä¸€æ¡ä¸åŒçš„é”™è¯¯ã€‚
    
    Stack.java:19: warning: [unchecked] unchecked cast  
    found: Object, required: E  
    		E result = (E) elements[--size];   
    								^
    
    ç”±äº E æ˜¯ä¸€ä¸ªä¸å¯å…·ä½“åŒ–çš„ç±»å‹ï¼Œç¼–è¯‘å™¨æ— æ³•åœ¨è¿è¡Œæ—¶æ£€éªŒè½¬æ¢ã€‚ä½ è¿˜æ˜¯å¯ä»¥è‡ªå·±è¯å®æœªå—æ£€çš„è½¬æ¢æ˜¯å®‰å…¨çš„ï¼Œå› æ­¤å¯ä»¥ç¦æ­¢è¯¥è­¦å‘Šã€‚æ ¹æ®ç¬¬ 27 æ¡çš„å»ºè®®ï¼Œæˆ‘ä»¬åªè¦åœ¨åŒ…å«æœªå—æ£€è½¬æ¢çš„ä»»åŠ¡ä¸Šç¦æ­¢è­¦å‘Šï¼Œè€Œä¸æ˜¯åœ¨æ•´ä¸ª pop æ–¹æ³•ä¸Šç¦æ­¢å°±å¯ä»¥äº†ï¼Œæ–¹æ³•å¦‚ä¸‹:
    
    	// Appropriate suppression of unchecked warning  
       	public E pop() {  
           	if (size == 0)  
               	throw new EmptyStackException();  
    		// push requires elements to be of type E, so cast is correct 		  
           	@SuppressWarnings("unchecked") E result =  
               	(E) elements[--size];  
           	elements[size] = null; // Eliminate obsolete reference  
           	return result;  
       	}
    

è¿™ä¸¤ç§æ¶ˆé™¤æ³›å‹æ•°ç»„åˆ›å»ºçš„æ–¹æ³•ï¼Œå„æœ‰æ‰€é•¿ã€‚ç¬¬ä¸€ç§æ–¹æ³•çš„å¯è¯»æ€§æ›´å¼ºï¼šæ•°ç»„è¢«å£°æ˜ä¸º `E[]` ç±»å‹æ¸…æ¥šåœ°è¡¨æ˜å®ƒåªåŒ…å« E å®ä¾‹ã€‚å®ƒä¹Ÿæ›´åŠ ç®€æ´ï¼šåœ¨ä¸€ä¸ªå…¸å‹çš„æ³›å‹ç±»ä¸­ï¼Œå¯ä»¥åœ¨ä»£ç ä¸­çš„å¤šä¸ªåœ°æ–¹è¯»å–åˆ°è¯¥æ•°ç»„ï¼›ç¬¬ä¸€ç§æ–¹æ³•åªéœ€è¦è½¬æ¢ä¸€æ¬¡ï¼ˆåˆ›å»ºæ•°ç»„çš„æ—¶å€™ï¼‰ï¼Œè€Œç¬¬äºŒ ç§æ–¹æ³•åˆ™æ˜¯æ¯æ¬¡è¯»å–ä¸€ä¸ªæ•°ç»„å…ƒç´ æ—¶éƒ½éœ€è¦è½¬æ¢ä¸€æ¬¡ã€‚ å› æ­¤ï¼Œç¬¬ä¸€ç§æ–¹æ³•ä¼˜å…ˆï¼Œåœ¨å®è·µä¸­ä¹Ÿæ›´å¸¸ç”¨ã€‚ä½†æ˜¯ï¼Œå®ƒä¼šå¯¼è‡´å †æ±¡æŸ“ï¼ˆheap pollutionï¼‰ï¼Œè¯¦è§ç¬¬ 32æ¡ï¼šæ•°ç»„çš„è¿è¡Œæ—¶ç±»å‹ä¸å®ƒçš„ç¼–è¯‘æ—¶ç±»å‹ä¸åŒ¹é…ï¼ˆé™¤é E æ­£å¥½æ˜¯ 0bject)ã€‚è¿™ä½¿å¾—æœ‰äº›ç¨‹åºå‘˜ä¼šè§‰å¾—å¾ˆä¸èˆ’æœï¼Œå› è€Œé€‰æ‹©ç¬¬äºŒç§æ–¹æ¡ˆï¼Œè™½ç„¶å †æ±¡æŸ“åœ¨è¿™ç§æƒ…å†µä¸‹å¹¶æ²¡æœ‰ä»€ä¹ˆå±å®³ã€‚

ä¸‹é¢çš„ç¨‹åºç¤ºèŒƒäº†æ³›å‹ Stack ç±»çš„ä½¿ç”¨æ–¹æ³•ã€‚ç¨‹åºä»¥å€’åºçš„æ–¹å¼æ‰“å°å‡ºå®ƒçš„å‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶è½¬æ¢æˆå¤§å†™å­—æ¯ã€‚å¦‚æœè¦åœ¨ä»å †æ ˆä¸­å¼¹å‡ºçš„å…ƒç´ ä¸Šè°ƒç”¨ String çš„ toUpperCase æ–¹æ³•ï¼Œå¹¶ä¸éœ€è¦æ˜¾å¼çš„è½¬æ¢ï¼Œå¹¶ä¸”ç¡®ä¿è‡ªåŠ¨ç”Ÿæˆçš„è½¬æ¢ä¼šæˆåŠŸï¼š

	// Little program to exercise our generic Stack  
   	public static void main(String[] args) {  
       	Stack<String> stack = new Stack<>();  
       	for (String arg : args)  
           	stack.push(arg);  
       	while (!stack.isEmpty())  
	}

ç¬¬ 28 æ¡é¼“åŠ±ä¼˜å…ˆä½¿ç”¨åˆ—è¡¨è€Œéæ•°ç»„ã€‚å®é™…ä¸Šä¸å¯èƒ½æ€»æ˜¯æˆ–è€…æ€»æƒ³åœ¨æ³›å‹ä¸­ä½¿ç”¨åˆ—è¡¨ã€‚Java å¹¶ä¸æ˜¯ç”Ÿæ¥å°±æ”¯æŒåˆ—è¡¨ï¼Œå› æ­¤æœ‰äº›æ³›å‹å¦‚ ArrayList å¿…é¡»åœ¨æ•°ç»„ä¸Šå®ç°ã€‚ä¸ºäº†æå‡æ€§èƒ½ï¼Œå…¶ä»–æ³›å‹å¦‚ HashMap ä¹Ÿåœ¨æ•°ç»„ä¸Šå®ç°ã€‚

1.  ä¸èƒ½åˆ›å»ºåŸºæœ¬ç±»å‹çš„æ³›å‹ã€‚
    
2.  æœ‰ä¸€äº›æ³›å‹é™åˆ¶äº†å¯å…è®¸çš„ç±»å‹å‚æ•°å€¼ï¼š
    
    class DelayQueue<E extends Delayed> implements BlockingQueue<E>
    

æ€»è€Œè¨€ä¹‹ï¼Œä½¿ç”¨æ³›å‹æ¯”ä½¿ç”¨éœ€è¦åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­è¿›è¡Œè½¬æ¢çš„ç±»å‹æ¥å¾—æ›´åŠ å®‰å…¨ï¼Œä¹Ÿæ›´åŠ å®¹æ˜“ã€‚

## 30. ä¼˜å…ˆè€ƒè™‘æ³›å‹æ–¹æ³•

é™æ€å·¥å…·æ–¹æ³•å°¤å…¶é€‚åˆäºæ³›å‹åŒ–ã€‚Collections ä¸­çš„æ‰€æœ‰ ç®—æ³•æ–¹æ³•ï¼ˆä¾‹å¦‚ binarySearch å’Œ sortï¼‰éƒ½æ³›å‹åŒ–äº†ã€‚

 	// Uses raw types - unacceptable! (Item 26)  
   	public static Set union(Set s1, Set s2) {  
       	Set result = new HashSet(s1);  
       	result.addAll(s2);  
       	return result;  
	}

è¿™ä¸ªæ–¹æ³•å¯ä»¥ç¼–è¯‘ï¼Œä½†æ˜¯æœ‰ä¸¤æ¡è­¦å‘Šï¼š

Union.java:5: warning: [unchecked] unchecked call to   
HashSet(Collection<? extends E>) as a member of raw type HashSet  
		Set result = new HashSet(s1);  
					 ^  
Union.java:6: warning: [unchecked] unchecked call to  
addAll(Collection<? extends E>) as a member of raw type Set  
		result.addAll(s2);  
					 ^

å°†æ–¹æ³•å£°æ˜ä¿®æ”¹ä¸ºå£°æ˜ä¸€ä¸ªç±»å‹å‚æ•°ï¼Œè¡¨ç¤ºè¿™ä¸‰ä¸ªé›†åˆçš„å…ƒç´ ç±»å‹ï¼ˆä¸¤ä¸ªå‚æ•°å’Œä¸€ä¸ªè¿”å›å€¼ï¼‰ã€‚å£°æ˜ç±»å‹å‚æ•°çš„ç±»å‹å‚æ•°åˆ—è¡¨ï¼Œ**å¤„åœ¨æ–¹æ³•çš„ä¿®é¥°æ³•åŠå…¶è¿”å›å€¼ä¹‹é—´**ã€‚å¦‚ä¸‹ï¼Œç±»å‹å‚æ•°åˆ—è¡¨ä¸º `<E>`ã€‚

// Generic method  
public static <E> Set<E> union(Set<E> s1, Set<E> s2) {  
	Set<E> result = new HashSet<>(s1); result.addAll(s2);  
	return result;  
}

union æ–¹æ³•çš„å±€é™æ€§åœ¨äºä¸‰ä¸ªé›†åˆçš„ç±»å‹å¿…é¡»å®Œå…¨ç›¸åŒã€‚åˆ©ç”¨æœ‰é™åˆ¶çš„é€šé…ç¬¦ç±»å‹å¯ä»¥ä½¿æ–¹æ³•å˜å¾—æ›´åŠ çµæ´»ï¼ˆè¯¦è§ç¬¬ 31 æ¡ï¼‰ã€‚

æœ‰æ—¶å¯èƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªä¸å¯å˜ä½†åˆé€‚ç”¨äºè®¸å¤šä¸åŒç±»å‹çš„å¯¹è±¡ã€‚ç”±äºæ³›å‹æ˜¯é€šè¿‡æ“¦é™¤ï¼ˆè¯¦è§ç¬¬ 28 æ¡ï¼‰å®ç°çš„ï¼Œå¯ä»¥ç»™æ‰€æœ‰å¿…è¦çš„ç±»å‹å‚æ•°ä½¿ç”¨å•ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯éœ€è¦ç¼–å†™ä¸€ä¸ªé™æ€å·¥å‚æ–¹æ³•ï¼Œè®©å®ƒé‡å¤åœ°ç»™æ¯ä¸ªå¿…è¦çš„ç±»å‹å‚æ•°åˆ†å‘å¯¹è±¡ã€‚è¿™ç§æ¨¡å¼ç§°ä½œæ³›å‹å•ä¾‹å·¥å‚ï¼ˆgeneric singleton factoryï¼‰ï¼Œå¸¸ç”¨äºå‡½æ•°å¯¹è±¡ï¼ˆè¯¦è§ç¬¬ 42 æ¡ï¼‰ï¼Œå¦‚ `Collections.reverseÂ­Order`ï¼Œæœ‰æ—¶ä¹Ÿç”¨äºåƒ `Collections.emptySet` è¿™æ ·çš„é›†åˆã€‚

å‡è®¾è¦ç¼–å†™ä¸€ä¸ªæ’ç­‰å‡½æ•°ï¼ˆidentity functionï¼‰åˆ†å‘å™¨ã€‚ç±»åº“ä¸­æä¾›äº† `Function.identity`ï¼Œå› æ­¤ä¸éœ€è¦è‡ªå·±ç¼–å†™ï¼ˆè¯¦è§ç¬¬ 59æ¡ï¼‰ï¼Œä½†æ˜¯è‡ªå·±ç¼–å†™ä¹Ÿå¾ˆæœ‰æ„ä¹‰ã€‚å¦‚æœåœ¨æ¯æ¬¡éœ€è¦çš„æ—¶å€™éƒ½é‡æ–°åˆ›å»ºä¸€ä¸ªï¼Œè¿™æ ·ä¼šå¾ˆæµªè´¹ï¼Œå› ä¸ºå®ƒæ˜¯æ— çŠ¶æ€çš„( stateless)ã€‚å¦‚æœ Java æ³›å‹è¢«å…·ä½“åŒ–äº†ï¼Œæ¯ä¸ªç±»å‹éƒ½éœ€è¦ä¸€ä¸ªæ’ç­‰å‡½æ•°ï¼Œä½†æ˜¯å®ƒä»¬è¢«æ“¦é™¤åï¼Œå°±åªéœ€è¦ä¸€ä¸ªæ³›å‹å•ä¾‹ã€‚è¯·çœ‹ä»¥ä¸‹ç¤ºä¾‹ï¼š

// TODOï¼šä»è¿™å¼€å§‹

# å…­. Lambda å’Œ Stream

## 42. Lambda ä¼˜å…ˆäºåŒ¿åç±»

æ ¹æ®ä»¥å¾€çš„ç»éªŒï¼Œæ˜¯ç”¨å¸¦æœ‰å•ä¸ªæŠ½è±¡æ–¹æ³•çš„æ¥å£ï¼ˆå¯ä»¥ä½†å‡ ä¹éƒ½ä¸æ˜¯æŠ½è±¡ç±»ï¼‰ä½œä¸ºå‡½æ•°ç±»å‹ï¼ˆfunction typeï¼‰ã€‚å®ƒä»¬çš„å®ä¾‹ç§°ä½œå‡½æ•°å¯¹è±¡ï¼ˆfunction objectï¼‰ï¼Œè¡¨ç¤ºå‡½æ•°æˆ–è€…è¦é‡‡å–çš„åŠ¨ä½œã€‚è‡ªä» 1997 å¹´å‘å¸ƒ JDK 1. l ä»¥æ¥ï¼Œåˆ›å»ºå‡½æ•°å¯¹è±¡çš„ä¸»è¦æ–¹å¼æ˜¯é€šè¿‡åŒ¿åç±»ï¼ˆanonymous classï¼Œè¯¦è§ç¬¬ 24æ¡)ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæŒ‰ç…§å­—ç¬¦ä¸²çš„é•¿åº¦å¯¹å­—ç¬¦ä¸²åˆ—è¡¨è¿›è¡Œæ’åºçš„ä»£ç ç‰‡æ®µï¼Œå®ƒç”¨ä¸€ä¸ªåŒ¿åç±»åˆ›å»ºäº†æ’åºçš„æ¯”è¾ƒå‡½æ•°ï¼š

	// Anonymous class instance as a function object - obsolete!  
   	Collections.sort(words, new Comparator<String>() {  
       	public int compare(String s1, String s2) {  
           	return Integer.compare(s1.length(), s2.length());  
       	}  
	});

åœ¨ Java 8 ä¸­ï¼Œå½¢æˆ â€œå¸¦æœ‰å•ä¸ªæŠ½è±¡æ–¹æ³•çš„æ¥å£æ˜¯ç‰¹æ®Šçš„ï¼Œå€¼å¾—ç‰¹æ®Šå¯¹å¾…â€ çš„è§‚å¿µã€‚è¿™äº›æ¥å£ç°åœ¨è¢«ç§°ä½œå‡½æ•°æ¥å£ï¼ˆfunctional interfaceï¼‰ï¼ŒJava å…è®¸åˆ©ç”¨ Lambda è¡¨è¾¾å¼ï¼ˆLambda expressionï¼‰åˆ›å»ºè¿™äº›æ¥å£çš„å®ä¾‹ã€‚Lambda ç±»ä¼¼äºåŒ¿åç±»çš„å‡½æ•°ï¼Œä½†æ˜¯æ¯”å®ƒç®€æ´å¾—å¤šã€‚ä»¥ä¸‹æ˜¯ä¸Šè¿°ä»£ç ç”¨ Lambda ä»£æ›¿åŒ¿åç±»ä¹‹åçš„æ ·å­ã€‚æ ·æ¿ä»£ç æ²¡æœ‰äº†ï¼Œå…¶è¡Œä¸ºä¹Ÿååˆ†æ˜ç¡®ï¼š

// Lambda expression as function object (replaces anonymous class)  
Collections.sort(words, (s1, s2) -> Integer.compare(s1.length(), s2.length()));

æ³¨æ„ï¼Œ Lambda çš„ç±»å‹ï¼ˆComparator<String>ï¼‰ã€å…¶å‚æ•°çš„ç±»å‹ï¼ˆs1 å’Œ s2ï¼Œä¸¤ä¸ªéƒ½æ˜¯ Stringï¼‰åŠå…¶è¿”å›å€¼çš„ç±»å‹ï¼ˆintï¼‰ï¼Œéƒ½æ²¡æœ‰å‡ºç°åœ¨ä»£ç ä¸­ã€‚ç¼–è¯‘å™¨åˆ©ç”¨ä¸€ä¸ªç§°ä½œç±»å‹æ¨å¯¼ï¼ˆtype inferenceï¼‰çš„è¿‡ç¨‹ï¼Œæ ¹æ®ä¸Šä¸‹æ–‡æ¨æ–­å‡ºè¿™äº›ç±»å‹ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨æ— æ³•ç¡®å®šç±»å‹ï¼Œä½ å°±å¿…é¡»æŒ‡å®šã€‚ç±»å‹æ¨å¯¼çš„è§„åˆ™å¾ˆå¤æ‚ï¼Œå‡ ä¹æ²¡æœ‰ç¨‹åºå‘˜èƒ½å¤Ÿè¯¦ç»†äº†è§£è¿™äº›è§„åˆ™ï¼Œä½†æ˜¯æ²¡å…³ç³»ã€‚åˆ é™¤æ‰€æœ‰ Lambda **å‚æ•°çš„ç±»å‹**å§ï¼Œé™¤é å®ƒä»¬çš„å­˜åœ¨èƒ½å¤Ÿä½¿ç¨‹åºå˜å¾—æ›´åŠ æ¸…æ™°ã€‚å¦‚æœç¼–è¯‘å™¨äº§ç”Ÿä¸€æ¡é”™è¯¯æ¶ˆæ¯ï¼Œå‘Šè¯‰ä½ æ— æ³•æ¨å¯¼å‡º Lambda å‚æ•°çš„ç±»å‹ï¼Œé‚£ä¹ˆä½ å°±æŒ‡å®šç±»å‹ã€‚æœ‰æ—¶å€™è¿˜éœ€è¦è½¬æ¢è¿”å›å€¼æˆ–è€…æ•´ä¸ª Lambda è¡¨è¾¾å¼ï¼Œä½†æ˜¯è¿™ç§æƒ…å†µå¾ˆå°‘è§ã€‚

å…³äºç±»å‹æ¨å¯¼åº”è¯¥å¢åŠ ä¸€æ¡è­¦å‘Š ã€‚ ç¬¬ 26 æ¡å‘Šè¯‰ä½ ä¸è¦ä½¿ç”¨åŸç”Ÿæ€ç±»å‹ï¼Œç¬¬ 29 æ¡è¯´è¿‡è¦æ”¯æŒæ³›å‹ç±»å‹ï¼Œç¬¬ 30 æ¡è¯´è¿‡è¦æ”¯æŒæ³›å‹æ–¹æ³•ã€‚åœ¨ä½¿ç”¨ Lambda æ—¶ï¼Œè¿™æ¡å»ºè®®ç¡®å®éå¸¸é‡è¦ï¼Œå› ä¸ºç¼–è¯‘å™¨æ˜¯**ä»æ³›å‹è·å–åˆ°å¾—ä»¥æ‰§è¡Œç±»å‹æ¨å¯¼çš„å¤§éƒ¨åˆ†ç±»å‹ä¿¡æ¯çš„**ã€‚å¦‚æœä½ æ²¡æœ‰æä¾›è¿™äº›ä¿¡æ¯ï¼Œç¼–è¯‘å™¨å°±æ— æ³•è¿›è¡Œç±»å‹æ¨å¯¼ï¼Œä½ å°±å¿…é¡»åœ¨ Lambda ä¸­æ‰‹å·¥æŒ‡å®šç±»å‹ï¼Œè¿™æ ·æå¤§åœ°å¢åŠ äº†å®ƒä»¬çš„çƒ¦çç¨‹åº¦ã€‚å¦‚æœä¸Šè¿°ä»£ç ç‰‡æ®µä¸­çš„å˜é‡ words å£°æ˜ä¸ºåŸç”Ÿæ€ç±»å‹ List ï¼Œè€Œä¸æ˜¯å‚æ•°åŒ–çš„ç±»å‹ List<String>ï¼Œå®ƒå°±ä¸ä¼šè¿›è¡Œç¼–è¯‘ã€‚å½“ç„¶ï¼Œå¦‚æœç”¨ Lambda è¡¨è¾¾å¼ï¼ˆè¯¦è§ç¬¬ 14 æ¡å’Œç¬¬ 43 æ¡ï¼‰ä»£æ›¿æ¯”è¾ƒå™¨æ„é€ æ–¹æ³•ï¼ˆcomparator construction methodï¼‰ï¼Œæœ‰æ—¶è¿™ä¸ªä»£ç ç‰‡æ®µä¸­çš„æ¯”è¾ƒå™¨è¿˜ä¼šæ›´åŠ ç®€ç»ƒï¼š

Collections.sort(words, comparingInt(String::length));

äº‹å®ä¸Šï¼Œå¦‚æœåˆ©ç”¨ Java 8 åœ¨ List æ¥å£ä¸­æ·»åŠ çš„ sort æ–¹æ³•ï¼Œè¿™ä¸ªä»£ç ç‰‡æ®µè¿˜å¯ä»¥æ›´åŠ ç®€çŸ­ä¸€äº›ï¼š

words.sort(comparingInt(String::length));

Java ä¸­å¢åŠ äº† Lambda ä¹‹åï¼Œä½¿å¾—ä¹‹å‰ä¸èƒ½ä½¿ç”¨å‡½æ•°å¯¹è±¡çš„åœ°æ–¹ç°åœ¨ä¹Ÿèƒ½ä½¿ç”¨äº†ã€‚ä¾‹å¦‚ï¼Œä»¥ç¬¬ 34 æ¡ä¸­çš„ Operation æšä¸¾ç±»å‹ä¸ºä¾‹ã€‚ç”±äºæ¯ä¸ªæšä¸¾çš„ apply æ–¹æ³•éƒ½éœ€è¦ä¸åŒçš„è¡Œä¸ºï¼Œæˆ‘ä»¬ç”¨äº†ç‰¹å®šäºå¸¸é‡çš„ç±»ä¸»ä½“ï¼Œå¹¶è¦†ç›–äº†æ¯ä¸ªæšä¸¾å¸¸é‡ä¸­çš„ apply æ–¹æ³•ã€‚ é€šè¿‡ä»¥ä¸‹ä»£ç å›é¡¾ä¸€ä¸‹ï¼š

	// Enum type with constant-specific class bodies & data (Item 34)  
   	public enum Operation {  
       	PLUS("+") {  
			public double apply(double x, double y) { return x + y; }   
        },  
		MINUS("-") {  
            public double apply(double x, double y) { return x - y; }  
       	},  
       	TIMES("*") {  
			public double apply(double x, double y) { return x * y; }   
        },  
		DIVIDE("/") {  
			public double apply(double x, double y) { return x / y; }  
		};  
       	private final String symbol;  
       	Operation(String symbol) { this.symbol = symbol; }  
          
       	@Override   
        public String toString() { return symbol; }  
       	public abstract double apply(double x, double y);  
   	}

ç”±ç¬¬ 34 æ¡å¯çŸ¥ï¼Œæšä¸¾å®ä¾‹åŸŸä¼˜å…ˆäºç‰¹å®šäºå¸¸é‡çš„ç±»ä¸»ä½“ã€‚Lambda ä½¿å¾—åˆ©ç”¨å‰è€…å®ç°ç‰¹å®šäºå¸¸é‡çš„è¡Œä¸ºå˜å¾—æ¯”ç”¨åè€…æ¥å¾—æ›´åŠ å®¹æ˜“äº†ã€‚ åªè¦ç»™æ¯ä¸ªæšä¸¾å¸¸é‡çš„æ„é€ å™¨ä¼ é€’ä¸€ä¸ªå®ç°å…¶è¡Œä¸ºçš„ Lambda å³å¯ã€‚æ„é€ å™¨å°† Lambda ä¿å­˜åœ¨ä¸€ä¸ªå®ä¾‹åŸŸä¸­ï¼Œapply æ–¹æ³•å†å°†è°ƒç”¨è½¬ç»™ Lambdaã€‚ç”±æ­¤å¾—åˆ°çš„ä»£ç æ¯”åŸæ¥çš„ç‰ˆæœ¬æ›´ç®€å•ï¼Œä¹Ÿæ›´åŠ æ¸…æ™° :

// Enum with function object fields & constant-specific behavior  
public enum Operation {  
	PLUS ("+", (x, y) -> x + y),   
    MINUS ("-", (x, y) -> x - y),   
    TIMES ("*", (x, y) -> x * y),   
    DIVIDE("/", (x, y) -> x / y);  
         
    private final String symbol;  
	private final DoubleBinaryOperator op;  
      
	Operation(String symbol, DoubleBinaryOperator op) {  
		this.symbol = symbol;  
		this.op = op;  
	}  
	@Override   
    public String toString() { return symbol; }  
	public double apply(double x, double y) {  
		return op.applyAsDouble(x, y);  
	}   
}

æ³¨æ„ï¼Œè¿™é‡Œç»™ Lambda ä½¿ç”¨äº† DoubleBinaryOperator æ¥å£ï¼Œä»£è¡¨æšä¸¾å¸¸é‡çš„è¡Œä¸ºã€‚è¿™æ˜¯åœ¨ java.util.functionï¼ˆè¯¦è§ç¬¬ 44æ¡ï¼‰ä¸­é¢„å®šä¹‰çš„ä¼—å¤šå‡½æ•°æ¥å£ä¹‹ä¸€ã€‚å®ƒè¡¨ç¤ºä¸€ä¸ªå¸¦æœ‰ä¸¤ä¸ª double å‚æ•°çš„å‡½æ•°å¹¶è¿”å›ä¸€ä¸ª double ç»“æœã€‚

çœ‹çœ‹åŸºäº Lambda çš„ Operation æšä¸¾ï¼Œä½ å¯èƒ½ä¼šæƒ³ï¼Œç‰¹å®šäºå¸¸é‡çš„æ–¹æ³•ä¸»ä½“å·²ç»å½¢åŒè™šè®¾äº†ï¼Œä½†æ˜¯å®é™…å¹¶éå¦‚æ­¤ã€‚ä¸æ–¹æ³•å’Œç±»ä¸åŒçš„æ˜¯ï¼Œ Lambda æ²¡æœ‰åç§°å’Œæ–‡æ¡£ï¼šå¦‚æœä¸€ä¸ªè®¡ç®—æœ¬èº«ä¸æ˜¯è‡ªæè¿°çš„ï¼Œæˆ–è€…è¶…å‡ºäº†å‡ è¡Œï¼Œé‚£å°±ä¸è¦æŠŠå®ƒæ—‹åœ¨ä¸€ä¸ª Lambda ä¸­ã€‚å¯¹äº Lambda è€Œè¨€ï¼Œä¸€è¡Œæ˜¯æœ€ç†æƒ³çš„ï¼Œ ä¸‰è¡Œæ˜¯åˆç†çš„æœ€å¤§æé™ã€‚å¦‚æœè¿èƒŒäº†è¿™ä¸ªè§„åˆ™ï¼Œå¯èƒ½å¯¹ç¨‹åºçš„å¯è¯»æ€§é€ æˆä¸¥é‡çš„å±å®³ã€‚å¦‚æœ Lambda å¾ˆé•¿æˆ–è€…éš¾ä»¥é˜…è¯»ï¼Œè¦ä¹ˆæ‰¾ä¸€ç§æ–¹æ³•å°†å®ƒç®€åŒ–ï¼Œè¦ä¹ˆé‡æ„ç¨‹åºæ¥æ¶ˆé™¤å®ƒã€‚è€Œä¸”ï¼Œä¼ å…¥æšä¸¾æ„é€ å™¨çš„å‚æ•°æ˜¯åœ¨é™æ€çš„ç¯å¢ƒä¸­è®¡ç®—çš„ã€‚å› è€Œï¼Œæšä¸¾æ„é€ å™¨ä¸­çš„ Lambda æ— æ³•è®¿é—®æšä¸¾çš„å®ä¾‹æˆå‘˜ã€‚å¦‚æœæšä¸¾ç±»å‹å¸¦æœ‰éš¾ä»¥ç†è§£çš„ç‰¹å®šäºå¸¸é‡çš„è¡Œä¸ºï¼Œæˆ–è€…æ— æ³•åœ¨å‡ è¡Œä¹‹å†…å®ç°ï¼Œåˆæˆ–è€…éœ€è¦è®¿é—®å®ä¾‹åŸŸæˆ–æ–¹æ³•ï¼Œé‚£ä¹ˆç‰¹å®šäºå¸¸é‡çš„ç±»ä¸»ä½“ä»ç„¶æ˜¯é¦–é€‰ã€‚

Lambda é™äºå‡½æ•°æ¥å£ã€‚å¦‚æœæƒ³åˆ›å»ºæŠ½è±¡ç±»çš„å®ä¾‹ï¼Œå¯ä»¥ç”¨åŒ¿åç±»æ¥å®Œæˆï¼Œè€Œä¸æ˜¯ç”¨ Lambdaã€‚åŒæ ·åœ°ï¼Œå¯ä»¥ç”¨åŒ¿åç±»ä¸ºå¸¦æœ‰å¤šä¸ªæŠ½è±¡æ–¹æ³•çš„æ¥å£åˆ›å»ºå®ä¾‹ã€‚æœ€åä¸€ç‚¹ï¼ŒLambda æ— æ³•è·å¾—å¯¹è‡ªèº«çš„å¼•ç”¨ã€‚åœ¨ Lambda ä¸­ï¼Œå…³é”®å­— this æ˜¯æŒ‡å¤–å›´å®ä¾‹ï¼Œè¿™ä¸ªé€šå¸¸æ­£æ˜¯ä½ æƒ³è¦çš„ã€‚åœ¨åŒ¿åç±»ä¸­ï¼Œå…³é”®å­— this æ˜¯æŒ‡åŒ¿åç±»å®ä¾‹ã€‚å¦‚æœéœ€è¦ä»å‡½æ•°å¯¹è±¡çš„ä¸»ä½“å†…éƒ¨è®¿é—®å®ƒï¼Œå°±å¿…é¡»ä½¿ç”¨åŒ¿åç±» ã€‚

Lambda ä¸åŒ¿åç±»å…±äº«ä½ æ— æ³•å¯é åœ°é€šè¿‡å®ç°æ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å±æ€§ ã€‚ å› æ­¤ï¼Œ å°½å¯ èƒ½ä¸è¦(é™¤éè¿«ä¸å¾—å·²)åºåˆ—åŒ–ä¸€ä¸ª Lambda (æˆ–è€…åŒ¿åç±»å®ä¾‹) ã€‚ å¦‚æœæƒ³è¦å¯åºåˆ—åŒ–çš„å‡½æ•° å¯¹è±¡ï¼Œå¦‚ Comparatorï¼Œå°±ä½¿ç”¨ç§æœ‰é™æ€åµŒå¥—ç±»(è¯¦è§ç¬¬ 24æ¡)çš„å®ä¾‹ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œä» Java 8 å¼€å§‹ï¼ŒLambda å°±æˆäº†è¡¨ç¤ºå°å‡½æ•°å¯¹è±¡çš„æœ€ä½³æ–¹å¼ã€‚åƒä¸‡ä¸è¦ç»™å‡½æ•°å¯¹è±¡ä½¿ç”¨åŒ¿åç±»ï¼Œé™¤éå¿…é¡»åˆ›å»ºéå‡½æ•°æ¥å£çš„ç±»å‹çš„å®ä¾‹ã€‚åŒæ—¶ï¼Œè¿˜è¦è®°ä½ï¼Œ Lambda ä½¿å¾—è¡¨ç¤ºå°å‡½æ•°å¯¹è±¡å˜å¾—å®¹æ˜“ï¼Œå› æ­¤æ‰“å¼€äº†ä¹‹å‰ä»æœªå®è·µè¿‡çš„åœ¨ Java ä¸­è¿›è¡Œå‡½æ•°ç¼–ç¨‹çš„å¤§é—¨ ã€‚

## 43. æ–¹æ³•å¼•ç”¨ä¼˜äº Lambda

map.merge(key, 1, (oldValue, val) -> oldValue + val);

å¦‚æœæŒ‡å®šçš„é”®æ²¡æœ‰æ˜ å°„ï¼Œè¯¥æ–¹æ³•å°±ä¼šæ’å…¥æŒ‡å®šå€¼ï¼›å¦‚æœæœ‰æ˜ å°„å­˜åœ¨ï¼Œmerge æ–¹æ³•å°±ä¼šå°†æŒ‡å®šçš„å‡½æ•°åº”ç”¨åˆ°å½“å‰å€¼å’ŒæŒ‡å®šå€¼ä¸Šï¼Œå¹¶ç”¨ç»“æœè¦†ç›–å½“å‰å€¼ã€‚é’ˆå¯¹æ­¤ä¾‹ï¼Œå¦‚æœ map ä¸­æœ‰ key è¿™ä¸ªé”®ï¼Œé‚£ä¹ˆå°±åŠ ä¸Š 1ï¼›å¦åˆ™æ’å…¥ (key, 1)ã€‚

è¿™æ ·çš„ä»£ç è¯»èµ·æ¥æ¸…æ™°æ˜äº†ï¼Œä½†ä»æœ‰äº›æ ·æ¿ä»£ç  ã€‚ å‚æ•° oldValue å’Œ val æ²¡æœ‰æ·»åŠ å¤ªå¤šä»·å€¼ï¼Œå´å ç”¨äº†ä¸å°‘ç©ºé—´ã€‚å®é™…ä¸Šï¼Œ Lambda è¦å‘Šè¯‰ä½ çš„å°±æ˜¯ï¼Œè¯¥å‡½æ•°è¿”å›çš„æ˜¯å®ƒä¸¤ä¸ªå‚æ•°çš„å’Œã€‚ä» Java8 å¼€å§‹ï¼Œ Integerï¼ˆä»¥åŠæ‰€æœ‰å…¶ä»–çš„æ•°å­—åŒ–åŸºæœ¬åŒ…è£…ç±»å‹éƒ½ï¼‰æä¾›äº†ä¸€ä¸ªåä¸º sum çš„é™æ€æ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨ä¹ŸåŒæ ·æ˜¯æ±‚å’Œã€‚æˆ‘ä»¬åªè¦ä¼ äººä¸€ä¸ªå¯¹è¯¥æ–¹æ³•çš„å¼•ç”¨ï¼Œå°±å¯ä»¥æ›´è½»æ¾åœ°å¾—åˆ°ç›¸åŒçš„ç»“æœï¼š

map.merge(key, 1, Integer::sum);

æ–¹æ³•å¸¦çš„å‚æ•°è¶Šå¤šï¼Œèƒ½ç”¨æ–¹æ³•å¼•ç”¨æ¶ˆé™¤çš„æ ·æ¿ä»£ç å°±è¶Šå¤šã€‚ä½†åœ¨æœ‰äº› Lambda ä¸­ï¼Œå³ä¾¿å®ƒæ›´é•¿ï¼Œä½†ä½ æ‰€é€‰æ‹©çš„å‚æ•°åç§°æä¾›äº†éå¸¸æœ‰ç”¨çš„æ–‡æ¡£ä¿¡æ¯ï¼Œä¹Ÿä¼šä½¿å¾— Lambda çš„å¯è¯»æ€§æ›´å¼ºï¼Œå¹¶ä¸”æ¯”æ–¹æ³•å¼•ç”¨æ›´æ˜“äºç»´æŠ¤ã€‚

åªè¦æ–¹æ³•å¼•ç”¨èƒ½åšçš„äº‹ï¼Œå°±æ²¡æœ‰ Lambda ä¸èƒ½å®Œæˆçš„ï¼ˆåªæœ‰ä¸€ç§æƒ…å†µä¾‹å¤–ï¼Œæœ‰å…´è¶£çš„è¯»è€…è¯·å‚è§ JLS,9.9-2ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨æ–¹æ³•å¼•ç”¨é€šå¸¸èƒ½å¤Ÿå¾—åˆ°æ›´åŠ ç®€çŸ­ã€æ¸…æ™°çš„ä»£ç ã€‚å¦‚æœ Lambda å¤ªé•¿ï¼Œæˆ–è€…è¿‡äºå¤æ‚ï¼Œè¿˜æœ‰å¦ä¸€ç§é€‰æ‹©ï¼šä» Lambda ä¸­æå–ä»£ç ï¼Œæ”¾åˆ°ä¸€ä¸ªæ–°çš„æ–¹æ³•ä¸­ï¼Œå¹¶ç”¨è¯¥æ–¹æ³•çš„ä¸€ä¸ªå¼•ç”¨ä»£æ›¿ Lambdaã€‚ä½ å¯ä»¥ç»™è¿™ä¸ªæ–¹æ³•èµ·ä¸€ä¸ªæœ‰æ„ä¹‰çš„åå­—ï¼Œå¹¶ç”¨è‡ªå·±æ»¡æ„çš„æ–¹å¼ç¼–å†™è¿›å…¥æ–‡æ¡£ã€‚å¦‚æœæ˜¯ç”¨ IDE ç¼–ç¨‹ï¼Œåˆ™å¯ä»¥åœ¨ä»»ä½•å¯èƒ½çš„åœ°æ–¹éƒ½ç”¨æ–¹æ³•å¼•ç”¨ä»£æ›¿ Lambdaã€‚ æœ‰æ—¶å€™ï¼ŒLambda ä¹Ÿä¼šæ¯”æ–¹æ³•å¼•ç”¨æ›´åŠ ç®€æ´æ˜äº†ã€‚è¿™ç§æƒ…å†µå¤§å¤šæ˜¯å½“æ–¹æ³•ä¸ Lambda å¤„åœ¨åŒä¸€ä¸ªç±»ä¸­çš„æ—¶å€™ã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µï¼Œå‡å®šå‘ç”Ÿåœ¨ä¸€ä¸ªåä¸º GoshThisClassNameisHumongous çš„ç±»ä¸­ï¼š

service.execute(GoshThisClassNameIsHumongous::action);

Lambda ç‰ˆæœ¬å¦‚ä¸‹ï¼š

service.execute(() -> action());

è¿™ä¸ªä»£ç ç‰‡æ®µä½¿ç”¨äº†æ–¹æ³•å¼•ç”¨ï¼Œä½†æ˜¯å®ƒæ—¢ä¸æ¯” Lambda æ›´ç®€çŸ­ï¼Œä¹Ÿä¸æ¯”å®ƒæ›´æ¸…æ™°ï¼Œå› æ­¤åº”è¯¥ä¼˜å…ˆè€ƒè™‘ Lambdaã€‚ç±»ä¼¼çš„è¿˜æœ‰ Function æ¥å£ï¼Œå®ƒç”¨ä¸€ä¸ªé™æ€å·¥å‚æ–¹æ³•è¿”å› id å‡½æ•° Function.identity()ã€‚å¦‚æœå®ƒä¸ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè€Œæ˜¯åœ¨è¡Œå†…ç¼–å†™åŒç­‰çš„ Lambdaè¡¨è¾¾å¼ï¼šx -> xï¼Œä¸€èˆ¬ä¼šæ¯”è¾ƒç®€æ´æ˜äº†ã€‚

è®¸å¤šæ–¹æ³•å¼•ç”¨éƒ½æŒ‡å‘é™æ€æ–¹æ³•ï¼Œä½†å…¶ä¸­æœ‰ 4 ç§æ²¡æœ‰è¿™ä¹ˆåšã€‚å…¶ä¸­ä¸¤ä¸ªæ˜¯æœ‰é™åˆ¶ï¼ˆboundï¼‰å’Œæ— é™åˆ¶ï¼ˆunboundï¼‰çš„å®ä¾‹æ–¹æ³•å¼•ç”¨ã€‚åœ¨æœ‰é™åˆ¶çš„å¼•ç”¨ä¸­ï¼Œæ¥æ”¶å¯¹è±¡æ˜¯åœ¨æ–¹æ³•å¼•ç”¨ä¸­æŒ‡å®šçš„ã€‚æœ‰é™åˆ¶çš„å¼•ç”¨æœ¬è´¨ä¸Šç±»ä¼¼äºé™æ€å¼•ç”¨ï¼šå‡½æ•°å¯¹è±¡ä¸è¢«å¼•ç”¨æ–¹æ³•å¸¦æœ‰ç›¸åŒçš„å‚æ•°ã€‚åœ¨æ— é™ åˆ¶çš„å¼•ç”¨ä¸­ï¼Œæ¥æ”¶å¯¹è±¡æ˜¯åœ¨è¿ç”¨å‡½æ•°å¯¹è±¡æ—¶ï¼Œé€šè¿‡åœ¨è¯¥æ–¹æ³•çš„å£°æ˜å‡½æ•°å‰é¢é¢å¤–æ·»åŠ ä¸€ä¸ªå‚æ•°æ¥æŒ‡å®šçš„ã€‚æ— é™åˆ¶çš„å¼•ç”¨ç»å¸¸ç”¨åœ¨æµç®¡é“ï¼ˆStream pipelineï¼‰ï¼ˆè¯¦è§ç¬¬ 45 æ¡ï¼‰ä¸­ä½œä¸ºæ˜ å°„å’Œè¿‡æ»¤å‡½æ•°ã€‚æœ€åï¼Œè¿˜æœ‰ä¸¤ç§æ„é€ å™¨ï¼ˆconstructorï¼‰å¼•ç”¨ï¼Œåˆ†åˆ«é’ˆå¯¹ç±»å’Œæ•°ç»„ã€‚æ„é€ å™¨å¼•ç”¨æ˜¯å……å½“å·¥å‚å¯¹è±¡ã€‚è¿™äº”ç§æ–¹æ³•å¼•ç”¨æ¦‚æ‹¬å¦‚ä¸‹ï¼š![Screen Shot 2021-05-30 at 21.43.49](https://chp-image-hosting.oss-cn-hangzhou.aliyuncs.com/uPic/Screen%20Shot%202021-05-30%20at%2021.43.49.png)

æ€»è€Œè¨€ä¹‹ï¼Œæ–¹æ³•å¼•ç”¨å¸¸å¸¸æ¯” Lambda è¡¨è¾¾å¼æ›´åŠ ç®€æ´æ˜äº†ã€‚åªè¦æ–¹æ³•å¼•ç”¨æ›´åŠ ç®€æ´ã€æ¸…æ™°ï¼Œå°±ç”¨æ–¹æ³•å¼•ç”¨ï¼›å¦‚æœæ–¹æ³•å¼•ç”¨å¹¶ä¸ç®€æ´ï¼Œå°±åšæŒä½¿ç”¨ Lambdaã€‚

## 44. åšæŒä½¿ç”¨æ ‡å‡†çš„å‡½æ•°æ¥å£

åœ¨å‡ºç°äº† Lambda åï¼ŒAPI ç¼–å†™çš„æœ€ä½³å®è·µå‘ç”Ÿäº†æ”¹å˜ï¼Œä¾‹å¦‚å¯ä»¥ä¸å»ç”¨æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼äº†ï¼Œç°åœ¨çš„æ›¿ä»£æ–¹æ³•æ˜¯æä¾›ä¸€ä¸ªæ¥å—å‡½æ•°å¯¹è±¡çš„é™æ€å·¥å‚æˆ–è€…æ„é€ å™¨ã€‚

ä»¥ `LinkedHashMap` ä¸ºä¾‹ï¼Œæ¯å½“è°ƒç”¨ put çš„æ—¶å€™ï¼Œå†…éƒ¨éƒ½ä¼šè°ƒç”¨ protected æ–¹æ³• `removeEldestEntry` æ–¹æ³•æ¥åˆ é™¤æœ€æ—©è¢«æ·»åŠ çš„é”®å€¼å¯¹ã€‚

	protected boolean removeEldestEntry(Map.Entry<K,V> eldest) {  
        return false;  
    }

å­ç±»å¯ä»¥é€šè¿‡é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œæ¥è¾¾åˆ°ç¼“å­˜çš„ç›®çš„ï¼š

	private static final int MAX_ENTRIES = 100;  
        
	protected boolean removeEldestEntry(Map.Entry eldest) {  
		return size() > MAX_ENTRIES;  
	}

è¿™ç§åšæ³•å¾ˆå¥½ï¼Œä½†ä½¿ç”¨ Lambda å¯ä»¥å®Œæˆçš„æ›´æ¼‚äº®ã€‚

### æ ‡å‡†å‡½æ•°æ¥å£

å‡å¦‚ç°åœ¨ç¼–å†™ `LinkedHashMap`ï¼Œå®ƒä¼šæœ‰ä¸€ä¸ªå¸¦å‡½æ•°å¯¹è±¡çš„é™æ€å·¥å‚æˆ–è€…æ„é€ å™¨ã€‚çœ‹ä¸€ä¸‹ `removeEldestEntry` çš„å£°æ˜ï¼Œä½ å¯èƒ½ä¼šä»¥ä¸ºè¯¥å‡½æ•°å¯¹ è±¡åº”è¯¥å¸¦ä¸€ä¸ª `Map.Entry<K, V>`ï¼Œå¹¶ä¸”è¿”å›ä¸€ ä¸ª booleanï¼Œä½†å®é™…å¹¶éå¦‚æ­¤ï¼š`removeEldestEntry` ä¼šè°ƒç”¨ `size` æ–¹æ³•æ¥è·å–æ•°é‡ï¼Œå› ä¸ºå®ƒè‡ªå·±æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•ã€‚ä½†**ä¼ åˆ°æ„é€ å™¨çš„å‡½æ•°å¯¹è±¡åˆ™ä¸æ˜¯ Map ä¸­çš„å®ä¾‹æ–¹æ³•**ï¼Œæ— æ³•è·å–åˆ°æ•°é‡ï¼Œå› ä¸ºè°ƒç”¨å…¶å·¥å‚æˆ–è€…æ„é€ å™¨æ—¶ï¼Œè¿™ä¸ª Map è¿˜ä¸å­˜åœ¨ã€‚æ‰€ä»¥ï¼ŒMap å¿…é¡»å°†å®ƒè‡ªèº«ä¼ ç»™å‡½æ•°å¯¹è±¡ï¼Œå› æ­¤å¿…é¡»ä¼ å…¥æ˜ å°„ä»¥åŠæœ€æ—©è¢«æ·»åŠ çš„ Entryï¼š

	// Unnecessary functional interface; use a standard one instead.  
   @FunctionalInterface interface EldestEntryRemovalFunction<K,V>{  
       boolean remove(Map<K,V> map, Map.Entry<K,V> eldest);  
	}

è™½ç„¶è¿™æ ·å¯ä»¥ï¼Œä½†æ˜¯æœ€å¥½çš„åŠæ³•æ˜¯å°½å¯èƒ½ä½¿ç”¨ `java.util.function` åŒ…ä¸­æä¾›çš„æ ‡å‡†å‡½æ•°æ¥å£ï¼Œè¿™æ ·ä¹Ÿèƒ½ä½¿å¾— API æ›´åŠ æ˜“æ‡‚ã€‚ä¾‹å¦‚æ­¤ä¾‹ä¸­ï¼Œåº”è¯¥ä¼˜å…ˆä½¿ç”¨ `BiPredicate<Map<K, v>, Map.Entry<K, V>>`ã€‚

æ ‡å‡†å‡½æ•°æ¥å£æœ‰ 43 ä¸ªï¼Œä½†åªéœ€è®°ä½ 6 ä¸ªåŸºæœ¬çš„å³å¯ï¼š

-   `Operator` æ¥å£ä»£è¡¨è¿”å›å€¼å’Œå‚æ•°ç±»å‹ç›¸åŒçš„å‡½æ•°ã€‚æœ‰ Unary å’Œ Binary ä¸¤ç§ã€‚
    
-   `Predicate` æ¥å£ä»£è¡¨æœ‰ä¸€ä¸ªå‚æ•°å¹¶ä¸”è¿”å› boolean çš„å‡½æ•°ã€‚
    
-   `Function` æ¥å£ä»£è¡¨è¿”å›å€¼å’Œå‚æ•°ç±»å‹ä¸åŒçš„å‡½æ•°ã€‚
    
-   `Supplier` æ¥å£ä»£è¡¨æ²¡æœ‰å‚æ•°å¹¶ä¸”è¿”å›ï¼ˆæˆ– suppliesï¼‰ä¸€ä¸ªå€¼çš„å‡½æ•°ã€‚
    
-   `Consumer` æ¥å£ä»£è¡¨æœ‰ä¸€ä¸ªå‚æ•°å¹¶ä¸”æ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°ï¼Œåªæ˜¯æ¶ˆè´¹å‚æ•°ã€‚
    

æ€»ç»“å¦‚ä¸‹ï¼š

![Screen Shot 2021-06-06 at 16.09.20](https://chp-image-hosting.oss-cn-hangzhou.aliyuncs.com/uPic/Screen%20Shot%202021-06-06%20at%2016.09.20.png)

è¿™å…­ç§åŸºæœ¬æ¥å£æ¯ä¸ªéƒ½é’ˆå¯¹ intã€long å’Œ double æœ‰ä¸‰ä¸ªå˜å¼ã€‚ å¦‚ `IntPredicateã€` å’Œ `LongBinaryOperator`ã€‚é™¤äº† `Function` å˜ä½“ä»¥å¤–çš„å…¶ä»–å˜ä½“æ¥å£çš„ç±»å‹éƒ½ä¸æ˜¯å‚æ•°åŒ–çš„ï¼Œ`Function` å˜ä½“æ˜¯ä»¥è¿”å›ç±»å‹ä¸ºå‚æ•°ã€‚ä¾‹å¦‚ `LongFunction<int[]>` æœ‰ä¸€ä¸ª `long` ç±»å‹çš„å‚æ•°ç„¶åè¿”å›ä¸€ä¸ª `int[]`ã€‚

`Function` æ¥å£çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹æ€»æ˜¯ä¸åŒçš„ï¼Œå› ä¸ºå¦‚æœç›¸åŒï¼Œé‚£ä¹ˆå®ƒå°±ä¼šæ˜¯ä¸€ä¸ª `UnrayOperator` äº†ã€‚ï¼ˆå®é™…ä¸Š Operator éƒ½æ˜¯ç»§æ‰¿ Fuction æ¥å®ç°çš„ï¼Œä¾‹å¦‚ `UnaryOperator<T>` ç»§æ‰¿äº† `Function<T, T>`ã€‚ï¼‰

`Function` æ¥å£è¿˜æœ‰ 9 ç§é¢å¤–å˜ä½“ï¼Œå®ƒä»¬çš„è¿”å›å€¼ç±»å‹éƒ½æ˜¯ primitiveï¼š

-   å¦‚æœå‚æ•°å’Œè¿”å›å€¼éƒ½æ˜¯ primitiveï¼Œå®ƒä»¬çš„å‘½åæ ¼å¼æ˜¯ `SrcToResultFunction`ï¼Œæ¯”å¦‚ `LongToIntFunction`ï¼ˆ6 ç§å˜å¼ï¼‰ã€‚
    
-   å¦‚æœå‚æ•°ç±»å‹æ˜¯å¯¹è±¡å¼•ç”¨è€Œè¿”å›å€¼æ˜¯ primitiveï¼Œå‘½åæ ¼å¼ä¸º `<Src>ToObjFunction`ï¼Œæ¯”å¦‚ `DoubleToObjFunction` ï¼ˆ3 ç§å˜å¼ï¼‰ã€‚
    

æœ‰ä¸‰ç§åŸºæœ¬ç±»å‹æœ‰ä¸¤ä¸ªå‚æ•°çš„ç‰ˆæœ¬ï¼ˆ9 ç§å˜å¼ï¼‰ï¼š

-   `BiPredicate<T, U>`ã€‚
    
-   `BiFunction<T, U, R>`ã€‚ç±»ä¼¼çš„ï¼Œ`BiFunction` è¿˜ä¼šæœ‰ä¸‰ç§è¿”å›åŸºæœ¬ç±»å‹çš„å˜ä½“ï¼š`ToIntBiFunction<T, U>`ã€`ToLongBiFunction<T, U>` å’Œ `ToDoubleBiFunction<T, U>`ã€‚
    
-   `BiConsumer<T, U>`ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œ`Consumer` æ¥å£è¿˜æœ‰æ¥æ”¶ä¸¤ä¸ªå‚æ•°çš„å˜å¼ï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä¸€ä¸ªæ˜¯å¯¹è±¡å¼•ç”¨ï¼Œä¸€ä¸ªæ˜¯ primitiveï¼š`ObjDoubleConsumer<T>`ã€`ObjIntConsumer<T>` å’Œ `ObjLongConsumer<T>`ã€‚
    

æœ€åå°±æ˜¯ `BooleanSupplier` æ¥å£ï¼Œè¿”å›å€¼ä¸º booleanï¼Œè¿™ä¹Ÿæ˜¯ boolean åœ¨ 43 ç§å‡½æ•°æ¥å£åå­—ä¸­ç¬¬ä¸€æ¬¡å‡ºç°ï¼ˆä½†è¿”å›å€¼æ˜¯ boolean çš„æœ‰ `Predicate` å’Œå®ƒçš„å››ä¸ªå˜å¼ï¼‰ã€‚

ç»å¤§éƒ¨åˆ†æ ‡å‡†å‡½æ•°æ¥å£éƒ½æ”¯æŒ primitive ç±»å‹ã€‚æœ€å¥½ä¸è¦æŠŠ boxed primitives ç”¨åˆ° primiteve å‡½æ•°æ¥å£ä¸Šï¼Œè™½ç„¶è¿™æ ·å¯è¡Œï¼Œä½†ä¸ä»…è¿åäº† 61 æ¡ï¼Œè€Œä¸”åœ¨æ‰¹é‡æ“ä½œæ—¶æ€§èƒ½ä¼šå¾ˆå·®ã€‚

### è‡ªå·±ç¼–å†™å‡½æ•°æ¥å£

å½“æ‰€æœ‰çš„æ ‡å‡†å‡½æ•°æ¥å£æ²¡æœ‰ä¸€ä¸ªæ˜¯éœ€è¦çš„æ—¶å€™ï¼Œå°±å¯ä»¥è‡ªå·±ç¼–å†™äº†ã€‚æ¯”å¦‚éœ€è¦ä¸€ä¸ª `Predicate`ï¼Œå®ƒæœ‰ä¸‰ä¸ªå‚æ•°æˆ–è€…å¯ä»¥æŠ›å‡ºä¸€ä¸ªå·²æ£€æŸ¥çš„å¼‚å¸¸ã€‚

ä½†åœ¨æœ‰çš„æ—¶å€™ï¼Œæ ‡å‡†å‡½æ•°æ¥å£æœ‰æˆ‘ä»¬éœ€è¦çš„ç»“æ„ï¼Œä½†å´è¿˜æ˜¯ä¸ä½¿ç”¨ã€‚æ¯”å¦‚ `Comparator<T>`ï¼Œè™½ç„¶å®ƒåœ¨ç»“æ„ä¸Šå’Œ `ToIntBiFunction<T, T>` ç›¸åŒï¼Œä½†å¦‚æœä½¿ç”¨åè€…çš„è¯å°±é”™äº†ã€‚åŸå› æœ‰ä¸‰ï¼š

1.  Comparator çš„åå­—æä¾›äº†å¾ˆå¥½çš„è¯´æ˜ï¼›
    
2.  Comparator æœ‰ç€ä¸¥æ ¼çš„æ¡ä»¶é™åˆ¶ï¼Œæ„æˆäº†å®ƒçš„æ€»åˆ™ï¼ˆgeneral contractï¼‰ã€‚
    
3.  å®ƒå†…éƒ¨å®ç°äº†å¤§é‡å¥½ç”¨çš„ç¼ºçœæ–¹æ³•ï¼Œå¯ä»¥å¯¹ Comparator è¿›è¡Œè½¬æ¢å’Œåˆå¹¶ã€‚
    

æ‰€ä»¥ï¼Œå½“éœ€è¦ç¼–å†™çš„æ¥å£å…·æœ‰å’Œ Comparator ä¸€æ ·çš„ç†ç”±çš„æ—¶å€™ï¼Œå°±å¯ä»¥è‡ªå·±é¢å¤–ç¼–å†™ä¸“ç”¨çš„å‡½æ•°æ¥å£ã€‚

### å‡½æ•°æ¥å£æ³¨è§£

å¿…é¡»ç”¨ `@FunctionalInterface` æ¥æ³¨è§£å‡½æ•°æ¥å£ï¼Œå®ƒå’Œ `@Override` ç±»ä¼¼ï¼Œç”¨æ¥è¡¨æ˜è®¾è®¡æ„å›¾ã€‚æœ‰ä¸‰ä¸ªç›®çš„ï¼š

1.  å‘Šè¯‰è¯»è€…ï¼Œè¿™ä¸ªç±»æ˜¯é’ˆå¯¹ Lambda è®¾è®¡çš„ï¼›
    
2.  è¿™ä¸ªæ¥å£ä¸ä¼šè¿›è¡Œç¼–è¯‘ï¼Œé™¤éå®ƒåªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼›
    
3.  é¿å…åç»­ç»´æŠ¤äººå‘˜ä¸å°å¿ƒç»™è¯¥æ¥å£æ·»åŠ æŠ½è±¡æ–¹æ³•ã€‚
    

### å»ºè®®

æœ€åä¸€ç‚¹æ˜¯å…³äºå‡½æ•°æ¥å£åœ¨ API ä¸­çš„ä½¿ç”¨ã€‚ä¸è¦åœ¨ç›¸åŒçš„å‚æ•°ä½ç½®ï¼Œæä¾›ä¸åŒçš„å‡½æ•°æ¥å£æ¥è¿›è¡Œå¤šæ¬¡é‡è½½çš„æ–¹æ³•ï¼Œå¦åˆ™å¯èƒ½åœ¨å®¢æˆ·ç«¯å¯¼è‡´æ­§ä¹‰ã€‚è¿™ä¸ä»…ä»…æ˜¯ç†è®ºä¸Šçš„é—®é¢˜ã€‚æ¯”å¦‚ ExecutorService çš„ submit æ–¹æ³•å°±å¯èƒ½å¸¦æœ‰ `Callable<T>` æˆ–è€… `Runnable`ï¼Œå¹¶ä¸”è¿˜å¯ä»¥ç¼–å†™ä¸€ä¸ªå®¢æˆ·ç«¯ç¨‹åºï¼Œè¦æ±‚è¿›è¡Œä¸€æ¬¡è½¬æ¢ï¼Œä»¥æ˜¾ç¤ºæ­£ç¡®çš„é‡è½½ï¼ˆè¯¦è§ç¬¬ 52 æ¡ï¼‰ã€‚é¿å…è¿™ ä¸ªé—®é¢˜çš„æœ€ç®€å•æ–¹å¼æ˜¯ï¼Œä¸è¦ç¼–å†™åœ¨åŒä¸€ä¸ªå‚æ•°ä½ç½®ä½¿ç”¨ä¸åŒå‡½æ•°æ¥å£çš„é‡è½½ ã€‚ è¿™æ˜¯è¯¥å»ºè®®çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œè¯¦æƒ…è¯·è§ç¬¬ 52æ¡ã€‚

## 45. è°¨æ…ä½¿ç”¨ Stream

### ä»‹ç»

Stream API æä¾›äº†ä¸¤ä¸ªå…³é”®æŠ½è±¡ï¼š

-   Streamï¼ˆæµï¼‰ä»£è¡¨å…ƒç´ æœ‰é™æˆ–æ— é™çš„é¡ºåºã€‚
    
-   Stream pipelineï¼ˆæµç®¡é“ï¼‰ä»£è¡¨è¿™äº›å…ƒç´ çš„ä¸€ä¸ªå¤šçº§è¿ç®—ã€‚
    

Stream å…ƒç´ å¯ä»¥æ¥è‡ªé›†åˆã€æ•°ç»„ã€æ–‡ä»¶ã€æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…å™¨ã€ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ç­‰ã€‚è¿™äº›å…ƒç´ å¯ä»¥æ˜¯å¯¹è±¡å¼•ç”¨æˆ–è€…åŸºæœ¬ç±»å‹ï¼ˆåªæ”¯æŒ intã€long å’Œ doubleï¼‰ã€‚

ä¸€ä¸ª Stream pipeline ç§åŒ…å«ä¸€ä¸ªæº streamï¼Œæ¥ç€æ˜¯ 0 ä¸ªæˆ–å¤šä¸ª**ä¸­é—´æ“ä½œ**ï¼ˆintermediate operationï¼‰å’Œä¸€ä¸ª**ç»ˆæ­¢æ“ä½œ**ï¼ˆterminal operationï¼‰ã€‚æ¯ä¸ªä¸­é—´æ“ä½œéƒ½ä¼šé€šè¿‡æŸç§æ–¹å¼å¯¹ Stream è¿›è¡Œè½¬æ¢ï¼Œå¦‚æ˜ å°„æˆ–è€…è¿‡æ»¤ï¼Œæ‰€æœ‰ä¸­é—´æ“ä½œéƒ½æ˜¯å°†ä¸€ä¸ª Stream è½¬æ¢æˆå¦ä¸€ä¸ª Streamï¼Œä¸­é—´çš„å…ƒç´ ç±»å‹ä¹Ÿå¯èƒ½å‘ç”Ÿæ”¹å˜ã€‚ç»ˆæ­¢æ“ä½œä¼šåœ¨æœ€åä¸€ä¸ªä¸­é—´æ“ä½œäº§ç”Ÿçš„ Stream ä¸Šæ‰§è¡Œä¸€ä¸ªæœ€ç»ˆçš„è®¡ç®—ï¼Œå¦‚å°†å…ƒç´ ä¿å­˜åˆ°ä¸€ä¸ªé›†åˆä¸­å¹¶è¿”å›æŸä¸€ä¸ªå…ƒç´ ï¼Œæˆ–è€…æ‰“å°å‡ºæ‰€æœ‰å…ƒç´ ç­‰ã€‚

Stream pipeline é€šå¸¸æ˜¯ lazy çš„ï¼ŒçŸ¥é“è°ƒç”¨ç»ˆæ­¢æ“ä½œæ—¶æ‰ä¼šå¼€å§‹è®¡ç®—ï¼Œå¯¹äºå®Œæˆç»ˆæ­¢æ“ä½œä¸éœ€è¦çš„æ•°æ®å…ƒç´ ï¼Œå°†æ°¸è¿œéƒ½ä¸ä¼šè¢«è®¡ç®—ã€‚æ­£æ˜¯è¿™ç§ lazy è®¡ç®—ï¼Œä½¿æ— é™ Stream æˆä¸ºå¯èƒ½ã€‚ä½†æ³¨æ„ï¼Œæ²¡æœ‰ç»ˆæ­¢æ“ä½œçš„ Stream pipeline å°†æ˜¯ä¸€ä¸ªé™é»˜çš„æ— æ“ä½œæŒ‡ä»¤ï¼Œå› æ­¤åƒä¸‡ä¸èƒ½å¿˜è®°ç»ˆæ­¢æ“ä½œã€‚

Stream API æ˜¯æµå¼ï¼ˆfluentï¼‰çš„ï¼šæ‰€æœ‰åŒ…å« pipeline çš„è°ƒç”¨å¯ä»¥é“¾æ¥æˆä¸€ä¸ªè¡¨è¾¾å¼ã€‚å¤šä¸ª pipeline ä¹Ÿå¯ä»¥é“¾æ¥åœ¨ä¸€èµ·ï¼Œæˆä¸ºä¸€ä¸ªè¡¨è¾¾å¼ã€‚

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ Stream pipeline æ˜¯æŒ‰é¡ºåºè¿è¡Œçš„ã€‚è¦ä½¿ pipeline å¹¶å‘æ‰§è¡Œï¼Œåªéœ€åœ¨è¯¥ pipeline çš„ä»»ä½• Stream ä¸Šè°ƒç”¨ parallel æ–¹æ³•å³å¯ï¼Œä½†æ˜¯é€šå¸¸ä¸å»ºè®®è¿™ä¹ˆåšï¼ˆè¯¦è§ç¬¬ 48 æ¡ï¼‰ã€‚

### è°¨æ…ä½¿ç”¨

Stream å¯ä»¥æ‰§è¡Œä»»ä½•è®¡ç®—ï¼Œä½†å¹¶ä¸æ„å‘³ç€åº”è¯¥åœ¨ä»»ä½•æ—¶å€™éƒ½ç”¨ Streamã€‚Stream å¯ä»¥ä½¿ç¨‹åºå˜å¾—æ›´åŠ ç®€æ´ã€æ¸…æ™°ï¼›ä½†å¦‚æœä½¿ç”¨ä¸å½“ï¼Œä¼šä½¿ç¨‹åºå˜å¾—æ··ä¹±ä¸”éš¾ä»¥ç»´æŠ¤ã€‚å¯¹äºä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨ Streamï¼Œå¹¶æ²¡æœ‰ç¡¬æ€§çš„è§„å®šï¼Œä½†æ˜¯å¯ä»¥æœ‰æ‰€å¯å‘ã€‚

ä¸‹é¢çš„ç¨‹åºç»Ÿè®¡ç”¨æˆ·æŒ‡å®šæœ€ä½å€¼çš„æ‰€æœ‰æ¢ä½è¯ï¼ˆanagramï¼‰ï¼š

   // Prints all large anagram groups in a dictionary iteratively  
   public class Anagrams {  
       public static void main(String[] args) throws IOException {  
           File dictionary = new File(args[0]);  
           int minGroupSize = Integer.parseInt(args[1]);  
           Map<String, Set<String>> groups = new HashMap<>();  
           try (Scanner s = new Scanner(dictionary)) {  
               while (s.hasNext()) {  
                   String word = s.next();   
                     
                   groups.computeIfAbsent(alphabetize(word),  
                       (unused) -> new TreeSet<>()).add(word);  
               }   
           }  
             
           for (Set<String> group : groups.values())  
               if (group.size() >= minGroupSize)  
                   System.out.println(group.size() + ": " + group);  
       }  
       private static String alphabetize(String s) {  
           char[] a = s.toCharArray();  
           Arrays.sort(a);  
           return new String(a);  
  
       }   
   }

ä¸‹é¢è¿™æ®µä»£ç åŒæ ·èƒ½è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œåªä¸è¿‡å¤§é‡ä½¿ç”¨äº† Streamã€‚æ»¥ç”¨ Stream ä¼šä½¿ç¨‹åºä»£ç æ›´éš¾ä»¥è¯»æ‡‚å’Œç»´æŠ¤ã€‚

   	// Overuse of streams - don't do this!  
   	public class Anagrams {  
     	public static void main(String[] args) throws IOException {  
       	Path dictionary = Paths.get(args[0]);  
       	int minGroupSize = Integer.parseInt(args[1]);  
         	try (Stream<String> words = Files.lines(dictionary)) {  
           	words.collect(  
             	groupingBy(word -> word.chars().sorted()  
                         	.collect(StringBuilder::new,  
                           	(sb, c) -> sb.append((char) c),  
                           	StringBuilder::append).toString()))  
             	.values().stream()  
                .filter(group -> group.size() >= minGroupSize)  
                .map(group -> group.size() + ": " + group)  
                .forEach(System.out::println);  
            }   
        }  
    }

å¯ä»¥é‡‡ç”¨ä¸­é—´æ–¹æ¡ˆï¼Œè¿™æ ·ç¨‹åºä¼šå˜å¾—ç®€çŸ­åˆæ¸…æ™°ï¼š

	 // Tasteful use of streams enhances clarity and conciseness  
   	public class Anagrams {  
      	public static void main(String[] args) throws IOException {  
         	Path dictionary = Paths.get(args[0]);  
         	int minGroupSize = Integer.parseInt(args[1]);  
         	try (Stream<String> words = Files.lines(dictionary)) {  
            	words.collect(groupingBy(word -> alphabetize(word)))  
                    .values().stream()  
                    .filter(group -> group.size() >= minGroupSize)   
                    .forEach(g -> System.out.println(g.size() + ": " + g));  
            }   
        }  
        // alphabetize method is the same as in original version  
        private static String alphabetize(String s) {  
           	char[] a = s.toCharArray();  
           	Arrays.sort(a);  
           	return new String(a);  
       }   
    }

ä¸ª Stream ä¸­çš„ pipeline æ²¡æœ‰ä¸­é—´æ“ä½œï¼›å®ƒçš„ç»ˆæ­¢æ“ä½œå°†æ‰€æœ‰çš„å•è¯é›†åˆåˆ°ä¸€ä¸ªæ˜ å°„ä¸­ï¼ŒæŒ‰ç…§å®ƒä»¬çš„å­—æ¯æ’åºå½¢å¼å¯¹å•è¯è¿›è¡Œåˆ†ç»„ï¼ˆè¯¦è§ç¬¬ 46 æ¡ï¼‰ã€‚è¿™ä¸ªæ˜ å°„ä¸å‰é¢ä¸¤ä¸ªç‰ˆæœ¬ä¸­çš„æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚éšåï¼Œåœ¨æ˜ å°„çš„`values()` è§†å›¾ä¸­ æ‰“å¼€äº†ä¸€ä¸ªæ–°çš„ `Stream<List<String>>`ã€‚è¿™ä¸ª Stream ä¸­çš„å…ƒç´ éƒ½æ˜¯æ¢ä½è¯åˆ†ç»„ã€‚ Stream è¿›è¡Œäº†è¿‡æ»¤ï¼ŒæŠŠæ‰€æœ‰å•è¯é•¿åº¦å°äº minGroupSize çš„å•è¯éƒ½å»æ‰äº†ï¼Œæœ€åï¼Œé€šè¿‡ç»ˆæ­¢æ“ä½œçš„ `forEach` æ‰“å°å‡ºå‰©ä¸‹çš„åˆ†ç»„ã€‚

> åœ¨æ²¡æœ‰æ˜¾å¼ç±»å‹çš„æƒ…å†µä¸‹ï¼Œä»”ç»†å‘½å Lambda å‚æ•°ï¼Œ è¿™å¯¹äº Stream pipeline çš„å¯è¯»æ€§è‡³å…³é‡è¦ã€‚

åœ¨ Stream pipeline ä¸­ä½¿ç”¨ helper æ–¹æ³•ï¼ˆå¦‚ä¸Šé¢çš„ `alphabetize`ï¼‰ï¼Œå¯¹äºå¯è¯»æ€§è€Œè¨€ï¼Œæ¯”åœ¨è¿­ä»£åŒ–ï¼ˆå¾ªç¯ï¼‰ä»£ç ä¸­ä½¿ç”¨æ›´ä¸ºé‡è¦ã€‚å¹¶ä¸”å¦‚æœåœ¨ä¸Šä¾‹ Stream pipeline ä¸­å®ç° alphabetize å¯èƒ½ä¼šå¯¼è‡´é€Ÿåº¦å˜æ…¢ï¼Œå› ä¸ºä¸æ”¯æŒ char Streamã€‚ä¸æ”¯æŒå®ƒæ˜¯å› ä¸º Stream å¤„ç† char å€¼æœ‰å¾ˆå¤šå±é™©ï¼š

"Hello world!".chars().forEach(System.out::print);  
è¾“å‡ºï¼š721011081081113211911111410810033

å› ä¸º chars() è¿”å›çš„ Stream æ˜¯ IntStreamï¼Œé‡Œé¢çš„å…ƒç´ æ˜¯ intã€‚å¯ä»¥é€šè¿‡è½¬å‹ï¼š

"Hello world!".chars().forEach(x -> System.out.print((char) x));

### Stream pipeline å’Œ è¿­ä»£åŒ–ä»£ç 

Stream pipeline åˆ©ç”¨å‡½æ•°å¯¹è±¡ï¼ˆä¸€èˆ¬æ˜¯ Lambda æˆ–è€…æ–¹æ³•å¼•ç”¨ï¼‰æ¥æè¿°é‡å¤çš„è®¡ç®—ï¼Œè€Œè¿­ä»£ç‰ˆä»£ç åˆ™åˆ©ç”¨ä»£ç å—æ¥æè¿°é‡å¤çš„è®¡ç®—ã€‚ä¸‹åˆ—å·¥ä½œåªèƒ½é€šè¿‡ä»£ç å—ï¼Œè€Œä¸èƒ½é€šè¿‡å‡½æ•°å¯¹è±¡æ¥å®Œæˆï¼š

-   -   ä»£ç å—ä¸­å¯ä»¥è¯»å†™èŒƒå›´å†…çš„ä»»ä½•å±€éƒ¨å˜é‡ï¼›
        
    -   Lanbda åªèƒ½è¯»å– final æˆ–è€…æœ‰æ•ˆçš„ final å˜é‡ï¼Œå¹¶ä¸”ä¸èƒ½ä¿®æ”¹ä»»ä½•å±€éƒ¨å˜é‡ã€‚
        
-   -   ä»£ç å—ä¸­ï¼Œå¯ä»¥ä»å¤–å›´æ–¹æ³•ä¸­ returnã€break æˆ– continue å¤–å›´å¾ªç¯ï¼Œæˆ–è€…æŠ›å‡ºå—æ£€å¼‚å¸¸ï¼›
        
    -   Lambda åˆ™æ— æ³•å®Œæˆä¸Šè¿°äº‹æƒ…ã€‚
        

Stream é€‚åˆçš„ï¼š

-   ç»Ÿä¸€è½¬æ¢å…ƒç´ åºåˆ—ã€‚
    
-   è¿‡æ»¤å…ƒç´ åºåˆ—ã€‚
    
-   åˆ©ç”¨å•ä¸ªæ“ä½œï¼ˆå¦‚æ·»åŠ ã€è¿æ¥æˆ–è€…è®¡ç®—æœ€å°å€¼ï¼‰åˆå¹¶å…ƒç´ åºåˆ—ã€‚
    
-   å°†å…ƒç´ åºåˆ—å­˜æ”¾åˆ°ä¸€ä¸ªé›†åˆä¸­ï¼Œæ¯”å¦‚æ ¹æ®æŸäº›å…¬å…±å±æ€§è¿›è¡Œåˆ†ç»„ã€‚
    
-   æœç´¢æ»¡è¶³æŸäº›æ¡ä»¶çš„å…ƒç´ åºåˆ—ã€‚
    

### ä½¿ç”¨ Stream çš„å¦ä¸€ä¸ªéš¾äº‹

Stream å¾ˆéš¾å®Œæˆçš„ä¸€ä»¶äº‹ä»¶å°±æ˜¯ï¼Œè®¿é—®ä¹‹å‰ pipeline ä¸­ç›¸åº”å…ƒç´ ï¼šä¸€æ—¦å°†ä¸€ä¸ªå€¼æ˜ å°„åˆ°å…¶ä»–å€¼ï¼ŒåŸæ¥çš„å€¼å°±ä¼šä¸¢å¤±ã€‚ä¸€ç§è§£å†³æ–¹æ³•æ˜¯å°†æ¯ä¸ªå€¼éƒ½æ˜ å°„åˆ°åŒ…å«åŸå§‹å€¼å’Œæ–°å€¼çš„ä¸€ä¸ªå¯¹è±¡å¯¹ï¼ˆpair objectï¼‰ï¼Œä½†å½“ piperline çš„å¤šä¸ªé˜¶æ®µéƒ½éœ€è¦æ—¶ï¼Œä»£ç å°†ä¼šå˜å¾—æ··ä¹±ï¼Œè¿èƒŒ Stream çš„åˆè¡·ã€‚æœ€å¥½çš„è§£å†³æ–¹æ³•æ˜¯ï¼Œå½“éœ€è¦è®¿é—®è¾ƒæ—©é˜¶æ®µçš„å€¼æ—¶ï¼Œå°†æ˜ å°„é¢ å€’è¿‡æ¥ã€‚

ä¾‹å¦‚ï¼Œç¼–å†™ä¸€ä¸ªæ‰“å°å‰ 20 ä¸ªæ¢…æ£®ç´ æ•°ï¼ˆMersenne primesï¼‰çš„ç¨‹åºã€‚è¿™æ˜¯ä¸€ä¸ªå½¢å¼ä¸º 2^p - 1 çš„æ•°å­—ï¼Œå¦‚æœ p æ˜¯ç´ æ•°ï¼Œé‚£ä¹ˆå¯¹åº”çš„æ¢…æ£®æ•°å­—ä¹Ÿæ˜¯ç´ æ•°ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ªæ¢…æ£®ç´ æ•°ã€‚

ä½œä¸º pipeline çš„ç¬¬ä¸€ä¸ª Streamï¼Œæˆ‘ä»¬æƒ³è¦çš„æ˜¯æ‰€æœ‰ç´ æ•°ã€‚ä¸‹é¢çš„æ–¹æ³•å°†è¿”å›ï¼ˆæ— é™ï¼‰Streamã€‚å‡è®¾ä½¿ç”¨çš„æ˜¯é™æ€å¯¼å…¥ï¼Œä¾¿äºè®¿é—® `Biginteger` çš„é™æ€æˆå‘˜ï¼š

static Stream<BigInteger> primes() {  
	return Stream.iterate(TWO, BigInteger::nextProbablePrime);  
}

æ–¹æ³•çš„åç§°ï¼ˆprimesï¼‰æ˜¯ä¸€ä¸ªå¤æ•°åè¯ï¼Œå®ƒæè¿°äº† Stream çš„å…ƒç´ ã€‚å¼ºçƒˆå»ºè®®è¿”å› Stream çš„æ‰€æœ‰æ–¹æ³•éƒ½é‡‡ç”¨è¿™ç§å‘½åæƒ¯ä¾‹ï¼Œå¯ä»¥å¢å¼º Stream pipeline çš„å¯è¯»æ€§ã€‚è¯¥æ–¹æ³•ä½¿ç”¨é™æ€å·¥å‚ `Stream.iterate`ï¼Œå®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼šStream ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä»¥åŠä»å‰ä¸€ä¸ªå…ƒç´ ä¸­ç”Ÿæˆä¸‹ä¸€ä¸ªå…ƒç´ çš„ä¸€ä¸ªå‡½æ•°ã€‚ä¸‹é¢çš„ç¨‹åºç”¨äºæ‰“å°å‡ºå‰ 20 ä¸ªæ¢…æ£®ç´ æ•°ï¼š

public static void main(String[] args) {  
    primes().map(p -> TWO.pow(p.intValueExact()).subtract(ONE))  
        .filter(mersenne -> mersenne.isProbablePrime(50))  
        .limit(20)  
        .forEach(System.out::println);  
}

ä»£ç ä»ç´ æ•°å¼€å§‹ï¼Œè®¡ç®—å‡ºç›¸åº”çš„æ¢…æ£®ç´ æ•°ï¼Œè¿‡æ»¤æ‰æ‰€æœ‰ä¸æ˜¯ç´ æ•°çš„æ•°å­—ï¼ˆå…¶ä¸­ 50 æ˜¯ä¸ªç¥å¥‡çš„æ•°å­—ï¼Œå®ƒæ§åˆ¶ç€è¿™ä¸ªæ¦‚ç‡ç´ æ€§æµ‹è¯•ï¼‰ï¼Œé™åˆ¶æœ€ç»ˆå¾—åˆ°çš„ Stream ä¸º 20 ä¸ªå…ƒç´ ï¼Œå¹¶æ‰“å°å‡ºæ¥ã€‚

> `isProbablePrime(int certainty)`ï¼šå¦‚æœæ­¤ BigInteger å¯èƒ½ä¸ºç´ æ•°ï¼Œåˆ™è¿”å› trueï¼Œå¦‚æœå®ƒä¸€å®šä¸ºåˆæ•°ï¼Œåˆ™è¿”å› falseã€‚å¦‚æœ certainty <= 0ï¼Œåˆ™è¿”å› trueã€‚

ç°åœ¨å‡è®¾æƒ³è¦åœ¨æ¯ä¸ªæ¢…æ£®ç´ æ•°ä¹‹å‰åŠ ä¸Šå…¶æŒ‡æ•°ï¼ˆpï¼‰ã€‚è¿™ä¸ªå€¼åªå‡ºç°åœ¨ç¬¬ä¸€ä¸ª Stream ä¸­ï¼Œ å› æ­¤åœ¨è´Ÿè´£è¾“å‡ºç»“æœçš„ç»ˆæ­¢æ“ä½œä¸­æ˜¯è®¿é—®ä¸åˆ°çš„ã€‚å°†å‘ç”Ÿåœ¨ç¬¬ä¸€ä¸ªä¸­é—´æ“ä½œä¸­çš„æ˜ å°„é¢ å€’è¿‡æ¥ï¼Œä¾¿å¯ä»¥å¾ˆå®¹æ˜“åœ°è®¡ç®—å‡ºæ¢…æ£®æ•°å­—çš„æŒ‡æ•°ã€‚è¯¥æŒ‡æ•°åªä¸è¿‡æ˜¯ä¸€ä¸ªä»¥äºŒè¿›åˆ¶è¡¨ç¤ºçš„ä½æ•°ï¼Œå› æ­¤ç»ˆæ­¢æ“ä½œå¯ä»¥äº§ç”Ÿæ‰€è¦çš„ç»“æœï¼š

 .forEach(mp -> System.out.println(mp.bitLength() + ": " + mp));

### é€‰æ‹© Stream è¿˜æ˜¯è¿­ä»£

å‡è®¾ `Card` æ˜¯ä¸€ä¸ªä¸å˜å€¼ç±»ï¼Œç”¨äºå°è£… `Rank` å’Œ `Suit`ï¼Œè¿™ä¸¤è€…éƒ½æ˜¯æšä¸¾ç±»å‹ã€‚ç°åœ¨éœ€è¦è®¡ç®—ä»è¿™ä¸¤ä¸ªé›†åˆä¸­é€‰æ‹©æ‰€æœ‰å…ƒç´ å¯¹æ¥åˆå§‹åŒ–æ‰€æœ‰ Cardã€‚

å¦‚æœé‡‡ç”¨è¿­ä»£ï¼š

   // Iterative Cartesian product computation  
   private static List<Card> newDeck() {  
       List<Card> result = new ArrayList<>();  
       for (Suit suit : Suit.values())  
           for (Rank rank : Rank.values())  
               result.add(new Card(suit, rank));  
       return result;  
   }

å¦‚æœé‡‡ç”¨ Streamï¼š

// Stream-based Cartesian product computation  
   	private static List<Card> newDeck() {  
       	return Stream.of(Suit.values())  
           	.flatMap(suit ->   
                  Stream.of(Rank.values())  
                     .map(rank -> new Card(suit, rank)))   
            .collect(toList());  
	}

> åˆ©ç”¨äº†ä¸­é—´æ“ä½œ `flatMap`ï¼Œå°† Stream ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜ å°„åˆ°ä¸€ä¸ª Stream ä¸­ï¼Œç„¶åå°†è¿™äº›æ–°çš„ Stream å…¨éƒ¨åˆå¹¶åˆ°ä¸€ä¸ª Streamï¼ˆæˆ–è€…å°†å®ƒä»¬æ‰å¹³åŒ–ï¼‰ã€‚

è¿™ä¸¤ç§ç‰ˆæœ¬è°æ›´å¥½å®Œå…¨å–å†³äºä¸ªäººåå¥½ï¼Œä»¥åŠç¼–ç¨‹ç¯å¢ƒã€‚

æ€»ä¹‹ï¼Œæœ‰äº›ä»»åŠ¡æœ€å¥½ç”¨ Stream å®Œæˆï¼Œæœ‰äº›åˆ™è¦ç”¨è¿­ä»£ï¼Œè€Œæœ‰è®¸å¤šä»»åŠ¡åˆ™æœ€å¥½æ˜¯ç»“åˆä½¿ç”¨è¿™ä¸¤ç§æ–¹æ³•æ¥ä¸€èµ·å®Œæˆã€‚

## 46. ä¼˜å…ˆé€‰æ‹© Stream ä¸­æ— å‰¯ä½œç”¨çš„å‡½æ•°

### æ­£ç¡®ä½¿ç”¨ Stream

Stream å¹¶ä¸åªæ˜¯ä¸€ä¸ª APIï¼Œå®ƒæ˜¯ä¸€ç§åŸºäºå‡½æ•°ç¼–ç¨‹çš„æ¨¡å‹ã€‚ä¸ºäº†è·å¾— Stream å¸¦æ¥çš„æè¿°æ€§å’Œé€Ÿåº¦ï¼Œæœ‰æ—¶è¿˜æœ‰å¹¶è¡Œæ€§ï¼Œå¿…é¡»é‡‡ç”¨èŒƒå‹ä»¥åŠ APIã€‚

Stream èŒƒå‹æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯æŠŠè®¡ç®—æ„é€ æˆä¸€ç³»åˆ—å˜å‹ï¼Œæ¯ä¸€çº§ç»“æœéƒ½å°½å¯èƒ½é è¿‘ä¸Šä¸€çº§ç»“æœçš„çº¯å‡½æ•°ï¼ˆpure functionï¼‰ã€‚çº¯å‡½æ•°æ˜¯æŒ‡å…¶ç»“æœåªå–å†³äºè¾“å…¥çš„å‡½æ•°ï¼šå®ƒä¸ä¾èµ–ä»»ä½•å¯å˜çš„çŠ¶æ€ï¼Œä¹Ÿä¸æ›´æ–°ä»»ä½•çŠ¶æ€ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œä¼ å…¥ Stream æ“ä½œçš„ä»»ä½•å‡½æ•°å¯¹è±¡ï¼Œæ— è®ºæ˜¯ä¸­é—´æ“ä½œè¿˜æ˜¯ç»ˆæ­¢æ“ä½œï¼Œéƒ½åº”è¯¥æ˜¯æ— å‰¯ä½œç”¨çš„ã€‚

å¦‚æœè¦ç»Ÿè®¡å•è¯åœ¨ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ä¸­å‡ºç°çš„é¢‘ç‡ï¼š

// Uses the streams API but not the paradigm--Don't do this!  
Map<String, Long> freq = new HashMap<>();  
try (Stream<String> words = new Scanner(file).tokens()) {  
    words.forEach(word -> {  
        freq.merge(word.toLowerCase(), 1L, Long::sum);  
    });   
}

> `Scanner` çš„ `Stream` æ–¹æ³•å¯ä»¥è·å¾— Streamï¼Œè¿™æ˜¯ Java 9 ä¸­å¢åŠ çš„ã€‚å¦‚æœæ˜¯æ›´æ—©çš„ç‰ˆæœ¬ï¼Œå¯ä»¥æŠŠå®ç° Iterator çš„æ‰«æå™¨ï¼Œç¿»è¯‘æˆä½¿ç”¨äº†ç±»ä¼¼äº 47 æ¡ä¸­é€‚é…å™¨çš„ Streamï¼ˆ`streamOf (Iterable<E>)`ï¼‰ã€‚

è™½ç„¶ä½¿ç”¨äº† Streamã€Lambda å’Œæ–¹æ³•å¼•ç”¨ï¼Œä½†è¿™æ ¹æœ¬ä¸æ˜¯ Stream çš„ä»£ç ï¼Œåªæ˜¯ä¼ªè£…æˆ Stream ä»£ç çš„è¿­ä»£å¼ä»£ç ã€‚å®ƒå¹¶æ²¡æœ‰äº«å—åˆ° Stream API å¸¦æ¥çš„ä¼˜åŠ¿ï¼Œä»£ç åè€Œæ›´é•¿äº†ç‚¹ï¼Œå¯è¯»æ€§ä¹Ÿå·®äº†ç‚¹ï¼Œå¹¶ä¸”æ¯”ç›¸åº”çš„è¿­ä»£åŒ–ä»£ç æ›´éš¾ç»´æŠ¤ã€‚å› ä¸ºè¿™æ®µä»£ç åˆ©ç”¨ä¸€ä¸ªæ”¹å˜å¤–éƒ¨çŠ¶æ€ï¼ˆé¢‘ç‡è¡¨ï¼‰çš„ Lambdaï¼Œå®Œæˆäº†åœ¨ç»ˆæ­¢æ“ä½œçš„ forEach ä¸­çš„æ‰€æœ‰å·¥ä½œã€‚forEach æ“ä½œçš„ä»»åŠ¡ä¸åªå±•ç¤ºç”± Stream æ‰§è¡Œçš„è®¡ç®—ç»“æœï¼Œè¿™åœ¨ä»£ç ä¸­å¹¶éå¥½äº‹ï¼Œæ”¹å˜çŠ¶æ€çš„ Lambda ä¹Ÿæ˜¯å¦‚æ­¤ã€‚é‚£ä¹ˆè¿™æ®µä»£ç åº”è¯¥æ˜¯ä¸‹é¢è¿™æ ·ï¼š

// Proper use of streams to initialize a frequency table  
Map<String, Long> freq;  
try (Stream<String> words = new Scanner(file).tokens()) {  
    freq = words  
        .collect(groupingBy(String::toLowerCase, counting()));  
}

è¿™ä¸ªä»£ç æ­£ç¡®çš„ä½¿ç”¨äº† Stream APIï¼Œå˜å¾—æ›´åŠ ç®€æ´ã€æ¸…æ™°ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆæœ‰äººä¼šä»¥å…¶ä»–çš„æ–¹å¼ç¼–å†™å‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†ä½¿ç”¨ä»–ä»¬å·²ç»ç†Ÿæ‚‰çš„å·¥å…·ã€‚Java ç¨‹åºå‘˜éƒ½çŸ¥é“å¦‚ä½•ä½¿ç”¨ for-each å¾ªç¯ï¼Œç»ˆæ­¢æ“ä½œçš„ forEach ä¹Ÿä¸ä¹‹ç±»ä¼¼ã€‚ä½† forEach æ“ä½œæ˜¯ç»ˆæ­¢æ“ä½œä¸­æœ€æ²¡æœ‰å¨åŠ›çš„ï¼Œä¹Ÿæ˜¯å¯¹ Stream æœ€ä¸å‹å¥½çš„ã€‚å®ƒæ˜¯æ˜¾å¼è¿­ä»£ï¼Œå› è€Œä¸é€‚åˆå¹¶è¡Œã€‚**forEach æ“ä½œåº”è¯¥åªç”¨äºæŠ¥å‘Š Stream è®¡ç®—çš„ç»“æœï¼Œè€Œä¸æ˜¯æ‰§è¡Œè®¡ç®—ã€‚**æœ‰æ—¶å€™ï¼Œä¹Ÿå¯ä»¥å°† forEach ç”¨äºå…¶ä»–ç›®çš„ï¼Œæ¯”å¦‚å°† Stream è®¡ç®—çš„ç»“æœæ·»åŠ åˆ°ä¹‹å‰å·²ç»å­˜åœ¨çš„é›†åˆä¸­å»ã€‚

### Collectors æ¥å£

`Collectores` æœ‰ 39 ç§æ–¹æ³•ï¼Œå¯ä»¥æŠŠå®ƒå½“ä½œå°è£…ç¼©å‡ï¼ˆå°† Stream å…ƒç´ åˆå¹¶åˆ°å•ä¸ªå¯¹è±¡ä¸­ï¼‰ç­–ç•¥çš„é»‘ç›’å¯¹è±¡ã€‚

#### collect to Collection

è¿™ç§æ¯”è¾ƒç®€å•ï¼Œæœ‰ `toList()`ã€`toSet()` å’Œ `toCollection(collectionFactory)`ï¼Œæœ€åä¸€ä¸ªæ–¹æ³•è¿”å›æŒ‡å®šçš„é›†åˆç±»å‹ã€‚

ä¸‹é¢ä»£ç ä»é¢‘ç‡è¡¨ä¸­æå–æ’åå‰åçš„å•è¯ï¼š

// Pipeline to get a top-ten list of words from a frequency table  
List<String> topTen = freq.keySet().stream() 		  
    .sorted(comparing(freq::get).reversed())   
    .limit(10)  
    .collect(toList());

> è¿™é‡Œé™æ€å¯¼å…¥äº† Collectors çš„æ‰€æœ‰æˆå‘˜ï¼Œè¿™æ ·å¯ä»¥æå‡ Stream pipeline çš„å¯è¯»æ€§ã€‚

è¿™æ®µä»£ç æœ‰æŠ€å·§çš„éƒ¨åˆ†æ—¶ä¼ ç»™ `sorted` çš„æ¯”è¾ƒå™¨ `comparing(freq::get).reversed()`ï¼Œ`comparing()` å¸¦æœ‰ä¸€ä¸ªé”®æå–å‡½æ•°

#### å…¶ä»– 36 ç§æ–¹æ³•

å…¶ä»–æ–¹æ³•å¤§éƒ¨åˆ†æ˜¯å°† Stream é›†åˆåˆ° Map ä¸­ï¼Œè¿™ä¼šå¤æ‚å¾ˆå¤šï¼šæ¯ä¸ª Stream å…ƒç´ éƒ½æœ‰ä¸€ä¸ªå…³è”çš„é”®å’Œå€¼ï¼Œå¤šä¸ª Stream å…ƒç´ å¯ä»¥å…³è”åŒä¸€ä¸ªé”®ã€‚

##### toMap

###### toMap(keyMapper, valueMapper)

ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯ `Fuction`ï¼Œåˆ†åˆ«å°† Stream å…ƒç´ æ˜ å°„åˆ°é”®å’Œå€¼ã€‚é‡‡ç”¨ç¬¬ 34 æ¡ `fromString` å®ç°ä¸­çš„æ”¶é›†å™¨ï¼Œå°†æšä¸¾çš„å­—ç¬¦ä¸²å½¢å¼æ˜ å°„åˆ°æšä¸¾æœ¬èº«ï¼š

// Using a toMap collector to make a map from string to enum  
private static final Map<String, Operation> stringToEnum =  
    Stream.of(values()).collect(  
    	toMap(Object::toString, e -> e));

ä½†æ˜¯å¦‚æœå¤šä¸ª Stream å…ƒç´ æ˜ å°„åˆ°äº†åŒä¸€ä¸ªé”®ï¼Œpipeline å°±ä¼šæŠ›å‡ºä¸€ä¸ª `IllegalStateException` å¼‚å¸¸å°†å®ƒç»ˆæ­¢ã€‚

###### toMap(keyMapper, valueMapper, mergeFunction)

è¿™ç§å½¢å¼å¯ä»¥è§£å†³ä¸Šè¿°å†²çªã€‚

ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª merge functionã€‚è¿™ä¸ª Function æ˜¯ä¸€ä¸ª `BinaryOperator<V>`ï¼ŒV æ˜¯æ˜ å°„çš„å€¼ç±»ä¼¼ã€‚å½“ä¸åŒçš„å€¼æ˜ å°„åˆ°åŒä¸€ä¸ªé”®ä¸Šçš„æ—¶å€™ï¼Œmerge function å°±å¼€å§‹èµ·ä½œç”¨ã€‚

> ä¸è¦è¢« merge åå­—è¿·æƒ‘äº†ï¼Œè¦çŸ¥é“çš„åªæœ‰ï¼šè¿™æ˜¯ä¸€ä¸ª `BinaryOperator<V>`ã€‚
> 
> > `BinaryOperator<T> extends BiFunction<T, T, T>`ï¼Œä½†è¿™å¹¶ä¸é‡è¦ã€‚

ä¸å…¶è¯´å¯ä»¥è§£å†³å†²çªï¼Œå€’ä¸å¦‚è¯´æ˜¯è®©ç”¨æˆ·æœ‰æ›´å¤šçš„æ“ä½œã€‚å‡è®¾æœ‰ä¸€ä¸ª Streamï¼Œä»£è¡¨ä¸åŒæ­Œå”±å®¶çš„å”±ç‰‡ï¼Œä¸‹é¢çš„ä»£ç å¯ä»¥å¾—åˆ°ä¸€ä¸ªä»æ­Œå”±å®¶åˆ°æœ€ç•…é”€å”±ç‰‡ä¹‹é—´çš„æ˜ å°„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ç›®çš„æ ¹æœ¬ä¸æ˜¯è§£å†³å†²çªã€‚

// Collector to generate a map from key to chosen element for key  
Map<Artist, Album> topHits = albums.collect(   
    toMap(Album::artist, a->a, maxBy(comparing(Album::sales))));

è¿™ä¸ªæ¯”è¾ƒå™¨ä½¿ç”¨äº†é™æ€å·¥å‚æ–¹æ³• `maxBy`ï¼Œè¿™æ˜¯ä» `BinaryOperator` é™æ€å¯¼å…¥çš„ã€‚è¯¥æ–¹æ³•å°† `Comparator<T>` è½¬æ¢æˆä¸€ä¸ª `BinaryOperator<T>`ï¼Œç”¨äºè®¡ç®—æŒ‡å®šæ¯”è¾ƒå™¨äº§ç”Ÿçš„æœ€å¤§å€¼ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ¯”è¾ƒå™¨æ˜¯ç”±æ¯”è¾ƒå™¨æ„é€ å™¨æ–¹æ³• `comparing` è¿”å›çš„ï¼Œå®ƒæœ‰ä¸€ ä¸ªé”®æå–å‡½æ•° `Album::sales`ã€‚

è¿™ç§å½¢å¼è¿˜æœ‰ä¸€ç§ç”¨é€”ï¼šç”Ÿæˆä¸€ä¸ªæ”¶é›†å™¨ï¼Œå½“æœ‰å†²çªæ—¶å¼ºåˆ¶ä¿ç•™æœ€åæ›´æ–°ï¼ˆlast-write-winsï¼‰ï¼š

 // Collector to impose last-write-wins policy  
toMap(keyMapper, valueMapper, (v1, v2) -> v2)

###### toMap(keyMapper, valueMapper, mergeFunction, mapSupplier)

è¿™æ˜¯ `toMap` çš„æœ€åä¸€ç§å½¢å¼ï¼Œè¿™æ˜¯ä¸€ä¸ª Map å·¥å‚ï¼Œå¯ä»¥æŒ‡å®šç‰¹æ®Šçš„ Map å®ç°ï¼Œå¦‚ `EnumMap`ã€‚

è¿™ä¸‰ç§ `toMap` ç‰ˆæœ¬è¿˜æœ‰å¦å¤–çš„å˜æ¢å½¢å¼ï¼š`toConcurrentMap`ã€‚

##### groupingBy

å®ƒè¿”å›æ”¶é›†å™¨æ¥ç”Ÿæˆ mapï¼Œæ ¹æ®**åˆ†ç±»å‡½æ•°**å°†å…ƒç´ åˆ†ç±»ï¼Œåˆ†ç±»å‡½æ•°å¸¦æœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›å…¶æ‰€å±çš„ç±»åˆ«ã€‚è¿™ä¸ªç±»åˆ«å°±æ˜¯å…ƒç´ çš„æ˜ å°„é”®ã€‚

###### groupingBy(Function classifier)

åªæœ‰ä¸€ä¸ªåˆ†ç±»å™¨ï¼Œå¹¶è¿”å›ä¸€ä¸ª Mapï¼Œæ˜ å°„å€¼ä¸ºæ¯ä¸ªåˆ†ç±»ä¸­æ‰€æœ‰å…ƒç´ çš„åˆ—è¡¨ã€‚ä¸‹åˆ—ä»£ç å°±æ˜¯åœ¨ç¬¬ 45æ¡çš„ Anagram ç¨‹åºä¸­ç”¨äºç”Ÿæˆ Map çš„æ”¶é›†å™¨ï¼š

words.collect(groupingBy(word -> alphabetize(word)))

###### groupingBy(Function classifier, Collector downstream)

å¦‚æœè¦è®© `groupingBy` è¿”å›ä¸€ä¸ªæ”¶é›†å™¨ç”¨å®ƒç”Ÿæˆä¸€ä¸ªå€¼è€Œä¸æ˜¯åˆ—è¡¨çš„æ˜ å°„ï¼Œé™¤äº†åˆ†ç±»å™¨ä¹‹å¤–ï¼Œè¿˜å¯ä»¥æŒ‡å®š ä¸€ä¸ªä¸‹æ¸¸æ”¶é›†å™¨ï¼ˆdownstream collectorï¼‰ã€‚ä¸‹æ¸¸æ”¶é›†å™¨ä»åŒ…å«æŸä¸ªç±»åˆ«ä¸­æ‰€æœ‰å…ƒç´ çš„ Stream ä¸­ç”Ÿæˆä¸€ä¸ªå€¼ã€‚è¿™ä¸ªå‚æ•°æœ€ç®€å•çš„ç”¨æ³•æ˜¯ä¼ å…¥ `toSet()`ï¼Œç»“æœç”Ÿæˆä¸€ä¸ª Mapï¼Œè¿™ä¸ªæ˜ å°„å€¼ä¸ºå…ƒç´ é›†åˆè€Œéåˆ—è¡¨ã€‚

å¦ä¸€ç§æ–¹æ³•æ˜¯ä¼ å…¥ `toCollection(collectionFactory)`ï¼Œå…è®¸åˆ›å»ºå­˜æ”¾å„å…ƒç´ ç±»åˆ«çš„é›†åˆã€‚ è¿™æ ·å°±å¯ä»¥è‡ªç”±é€‰æ‹©è‡ªå·±æƒ³è¦çš„ä»»ä½•é›†åˆç±»å‹äº†ã€‚å¸¦ä¸¤ä¸ªå‚æ•°çš„ `groupingBy` ç‰ˆæœ¬çš„å¦ä¸€ç§ç®€å•ç”¨æ³•æ˜¯ï¼Œä¼ å…¥ `counting()` ä½œä¸ºä¸‹æ¸¸æ”¶é›†å™¨ã€‚è¿™æ ·ä¼šç”Ÿæˆä¸€ä¸ª mapï¼Œå®ƒå°†æ¯ä¸ªç±»åˆ«ä¸è¯¥ç±»åˆ«ä¸­çš„å…ƒç´ æ•°é‡å…³è”èµ·æ¥ï¼Œè€Œä¸æ˜¯åŒ…å«å…ƒç´ çš„é›†åˆã€‚ä¾‹å¦‚å®ç°å•è¯é¢‘ç‡è¡¨ï¼š

Map<String, Long> freq = words   
    .collect(groupingBy(String::toLowerCase, counting()));

###### groupingBy(Function classifier, Supplier mapFacotry, Collector downstream)

è¿™ä¸ªç‰ˆæœ¬å¯ä»¥æŒ‡å®šä¸€ä¸ª Map å·¥å‚ã€‚ groupingBy çš„è¿™ä¸ªç‰ˆæœ¬å¯ä»¥æ§åˆ¶ map çš„ç±»å‹ï¼Œä»¥åŠå†…éƒ¨å€¼ï¼ˆé›†åˆï¼‰çš„ç±»å‹ã€‚å› æ­¤ï¼Œæ¯”å¦‚å¯ä»¥å®šä¹‰ä¸€ä¸ªæ”¶é›†å™¨ï¼Œè®©å®ƒè¿”å›ä¸€ä¸ªå€¼ç±»å‹ä¸º TreeSet çš„ TreeMapã€‚

> è¿™ä¸ªæ–¹æ³•è¿èƒŒäº†æ ‡å‡†çš„å¯ä¼¸ç¼©å‚æ•°åˆ—è¡¨æ¨¡å¼ï¼šå‚æ•° `mapFactory` åœ¨ `downStream` å‚æ•°ä¹‹å‰ï¼Œè€Œä¸æ˜¯åœ¨å®ƒä¹‹åã€‚

###### groupingByConcurrent

å’Œ `toConcurrentMap` ä¸€æ ·ï¼Œ`groupingByConcurrent` æä¾›äº† `groupingBy` ä¸‰ç§é‡è½½çš„å˜ä½“ã€‚

###### partitioningBy

è¿™æ˜¯ `groupingBy` ç”¨çš„æ¯”è¾ƒå°‘çš„ä¸€ç§å˜ä½“ã€‚

æœ‰ä¸¤ä¸ªé‡è½½æ–¹æ³•ï¼š

-   å¸¦ä¸€ä¸ª `Predicate` å‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªé”®ä¸º Boolean çš„ Mapã€‚
    
-   é™¤äº† `Predicate` ä¹‹å¤–è¿˜å¸¦æœ‰ downstream collectorã€‚
    

##### ä¸‹æ¸¸æ”¶é›†å™¨

`counting` æ–¹æ³•è¿”å›çš„æ”¶é›†å™¨åªç”¨ä½œä¸‹æ¸¸æ”¶é›†å™¨ã€‚ä½†é€šè¿‡ Stream ä¸Šçš„ count æ–¹æ³•ï¼Œç›´æ¥å°±æœ‰ç›¸åŒçš„åŠŸèƒ½ï¼Œå› æ­¤å‹æ ¹æ²¡æœ‰ç†ç”±ä½¿ç”¨ `collect(counting())`ã€‚

Collector è¿˜æœ‰ 15 ç§æ–¹æ³•ï¼Œå…¶ä¸­æœ‰ 9 ç§æ–¹æ³•çš„åç§°éƒ½æ˜¯ä»¥ sumingã€averaging å’Œ summarizing å¼€å¤´ã€‚è¿˜åŒ…æ‹¬ mapingã€flatMapping å’Œ collectingAndThen æ–¹æ³•ã€‚

è¿™äº›æ”¶é›†å™¨è¯•å›¾éƒ¨åˆ†å¤åˆ¶æ”¶é›†å™¨ä¸­ Stream çš„åŠŸèƒ½ï¼Œä»¥ä¾¿ä¸‹æ¸¸æ”¶é›†å™¨å¯ä»¥æˆä¸º ministreamã€‚

##### æœ€åä¸‰ä¸ªæ–¹æ³•

è¿™ä¸‰ä¸ªæ–¹æ³•éƒ½åœ¨ `Collectors` ä¸­ï¼Œä½†æ˜¯å¹¶ä¸åŒ…å«é›†åˆã€‚

å‰ä¸¤ä¸ªæ˜¯ `minBy` å’Œ `maxBy`ï¼Œå®ƒä»¬æœ‰ä¸€ä¸ªæ¯”è¾ƒå™¨ï¼Œå¹¶è¿”å›ç”±æ¯”è¾ƒå™¨ç¡®å®šçš„ Stream ä¸­çš„æœ€å°‘å…ƒç´ æˆ–è€…æœ€å¤šå…ƒç´ ã€‚å®ƒä»¬æ˜¯ Stream æ¥å£ä¸­ `min` å’Œ `max` æ–¹æ³•çš„ç²—ç•¥æ¦‚æ‹¬ï¼Œä¹Ÿæ˜¯ `BinaryOperator` ä¸­åŒåæ–¹æ³•è¿”å›çš„äºŒå…ƒæ“ä½œç¬¦ï¼Œä¸æ”¶é›†å™¨ç›¸ç±»ä¼¼ã€‚

æœ€åä¸€ä¸ªæ–¹æ³•æ˜¯ `joining`ï¼Œå®ƒåªåœ¨ `CharSequence` å®ä¾‹çš„ Stream ä¸­æ“ä½œï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ã€‚å®ƒä»¥å‚æ•°çš„å½¢å¼è¿”å›ä¸€ä¸ªç®€å•åœ°åˆå¹¶å…ƒç´ çš„æ”¶é›†å™¨ã€‚å…¶ä¸­ä¸€ç§å‚æ•°å½¢å¼å¸¦æœ‰ä¸€ä¸ªåä¸º delimiterï¼ˆåˆ†ç•Œç¬¦ï¼‰çš„ `CharSequence` å‚æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ªè¿æ¥ Stream å…ƒç´ å¹¶åœ¨ç›¸é‚»å…ƒç´ ä¹‹é—´æ’å…¥åˆ†éš”ç¬¦çš„æ”¶é›†å™¨ï¼ˆæ³¨æ„ä¸è¦å¼•èµ·æ­§ä¹‰ï¼‰ã€‚è¿™ä¸‰ç§å‚æ•°å½¢å¼ï¼Œé™¤äº†åˆ†éš”ç¬¦ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå‰ç¼€å’Œä¸€ä¸ªåç¼€ã€‚

## 47. Stream è¦ä¼˜å…ˆä½¿ç”¨ Collection ä½œä¸ºè¿”å›ç±»å‹

### ä»‹ç»

å¾ˆå¤šæ–¹æ³•ä¼šè¿”å›å…ƒç´ åºåˆ—ï¼ŒJava 8 ä¹‹å‰ï¼Œè¿™äº›åºåˆ—å¯ä»¥æ˜¯ï¼šé›†åˆæ¥å£ Collectionã€Set å’Œ Listï¼›Iterableï¼›æ•°ç»„ï¼Œé€šå¸¸å¾ˆå®¹æ˜“å†³å®šåº”è¯¥è¿”å›å“ªç§åºåˆ—ç±»å‹ã€‚æ ‡å‡†æ˜¯ä¸€ä¸ªé›†åˆæ¥å£ã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•åªæ˜¯ä¸ºäº† for-each å¾ªç¯æˆ–è€…æ˜¯è¿”å›å…ƒç´ åºåˆ—ï¼Œæ— æ³•ç”¨å®ƒæ¥å®ç° Collection æ¥å£çš„ä¸€äº›æ–¹æ³•ï¼ˆé€šå¸¸æ˜¯ `contains(Object)`ï¼‰ï¼Œå°±å¯ä»¥ä½¿ç”¨ Iterable æ¥å£ã€‚å¦‚æœè¿”å›çš„å…ƒç´ æ˜¯åŸºæœ¬ç±»å‹ï¼Œæˆ–è€…æœ‰å¼ºçƒˆçš„æ€§èƒ½éœ€æ±‚çš„æ—¶å€™ï¼Œé€šå¸¸ä½¿ç”¨æ•°ç»„ã€‚åœ¨ Java 8 ä¸­æ·»åŠ äº† Streamï¼Œè¿™å°±ä½¿å¾—è¦è¿”å›å…ƒç´ åºåˆ—çš„æ–¹æ³•æ›´éš¾å»é€‰æ‹©è¿”å›ç±»å‹äº†ã€‚

æ­£å¦‚ 45 æ¡æ‰€è¿°çš„ Stream å’Œè¿­ä»£çš„é€‰æ‹©ï¼Œåœ¨è¿™é‡Œ Stream ä¹Ÿå¹¶ä¸æ€»æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚æœ‰å¯èƒ½ API è¿”å›äº† Streamï¼Œä½†ç”¨æˆ·æƒ³é€šè¿‡ for-each å¾ªç¯æ¥éå†ã€‚ç›®å‰ï¼ŒStream æ¥å£åœ¨ Iterable æ¥å£ä¸­åªåŒ…å«äº†ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼ŒStream å’Œ Iterable æ¥å£å¯¹è¿™ä¸ªæ–¹æ³•çš„è§„èŒƒæ˜¯å…¼å®¹çš„ã€‚å”¯ä¸€é˜»æ­¢ç¨‹åºå‘˜åœ¨ä½¿ç”¨ for-each å¾ªç¯éå† Stream çš„æ˜¯ Stream æ— æ³•å»ç»§æ‰¿ Iterable æ¥å£ã€‚

### Stream è¿˜æ˜¯ for-each

è¿™ç›´åˆ°ç›®å‰ä¹Ÿæ²¡æœ‰å¥½çš„è§£å†³åŠæ³•ã€‚ç¬¬ä¸€çœ¼ä¼šè§‰å¾—ä¼ ä¸€ä¸ªæ–¹æ³•å¼•ç”¨ç»™ Stream çš„è¿­ä»£å™¨æ–¹æ³•å°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†è¿™é€šè¿‡ä¸äº†ç¼–è¯‘ï¼š

// Won't compile, due to limitations on Java's type inference  
for (ProcessHandle ph : ProcessHandle.allProcesses()::iterator) {   
    // Process the process  
}  
  
Test.java:6: error: method reference not expected here  
for (ProcessHandle ph : ProcessHandle.allProcesses()::iterator) {  
						^

å¯ä»¥å°†æ–¹æ³•å¼•ç”¨è½¬æ¢æˆé€‚å½“å‚æ•°åŒ–çš„ Iterableï¼š

 // Hideous workaround to iterate over a stream  
for (ProcessHandle ph : (Iterable<ProcessHandle>)  
     					ProcessHandle.allProcesses()::iterator)

è¿™æ®µä»£ç è™½ç„¶å¯ä»¥è¿è¡Œï¼Œä½†è¿‡äºæ‚ä¹±å’Œä¸æ¸…æ™°ï¼Œæ›´å¥½çš„åšæ³•æ˜¯å®ç°ä¸€ä¸ªé€‚é…å™¨æ–¹æ³•ã€‚JDK å¹¶æ²¡æœ‰æä¾›ï¼Œä½†æ˜¯è¿™å¾ˆå®¹æ˜“ç¼–å†™ã€‚è¿™ä¸ªæ–¹æ³•ä¸­ä¸éœ€è¦è¿›è¡Œè½¬å‹ï¼Œå› ä¸º Java çš„ç±»å‹å¼•ç”¨åœ¨è¿™é‡Œæ´¾ä¸Šäº†ç”¨åœºï¼ˆTODOï¼šç±»å‹å¼•ç”¨ï¼‰ã€‚

// Adapter from  Stream<E> to Iterable<E>  
public static <E> Iterable<E> iterableOf(Stream<E> stream) {  
	return stream::iterator;  
}

ä½¿ç”¨è¿™ä¸ªé€‚é…å™¨ï¼Œå°±å¯ä»¥åœ¨ for-each é‡Œéå†ä»»ä½• Streamï¼š

for(ProcessHandle p:iterableOf(ProcessHandle.allProcesses())){   
    // Process the process  
}

æ³¨æ„ï¼š34 æ¡ä¸­çš„ Anagrams ç¨‹åºçš„ Stream ç‰ˆæœ¬ä½¿ç”¨äº† `Files.lines` æ–¹æ³•æ¥è¯»å–å­—å…¸ï¼Œè€Œè¿­ä»£ç‰ˆæœ¬ä½¿ç”¨äº† scannerã€‚å‰è€…æ¯” scanner æ›´å¥½ï¼Œå› ä¸º scanner ä¼šæ— å£°åæ‰è¯»æ–‡ä»¶ä¸­é‡åˆ°çš„æ‰€æœ‰å¼‚å¸¸ã€‚è¿™æ˜¯ä¸€ç§å¦¥åï¼Œå› ä¸º `Files.lines` æ‰æ˜¯æ­£ç¡®çš„åšæ³•ï¼Œä½†ç”¨æˆ·å¯èƒ½æƒ³é€šè¿‡ for-each æ¥éå†ã€‚

åè¿‡æ¥ä¹Ÿæˆç«‹ï¼Œä¹Ÿå¯ä»¥æä¾› Iterable åˆ° Stream çš„é€‚é…å™¨ï¼š

// Adapter from Iterable<E> to Stream<E>  
public static <E> Stream<E> streamOf(Iterable<E> iterable) {  
	return StreamSupport.stream(iterable.spliterator(), false);  
}

å¦‚æœç¼–å†™ä¸€ä¸ªæ–¹æ³•æ¥è¿”å›å…ƒç´ åºåˆ—ï¼Œå¹¶ä¸”æ¸…æ¥šçŸ¥é“å®ƒåªä¼šè¢«ç”¨åœ¨ stream pipeline ä¸­ï¼Œé‚£å°±åº”è¯¥è¿”å› Streamï¼Œè¿™åŒæ ·é€‚ç”¨ Iterableã€‚ä½†æ˜¯å½“ç¼–å†™ä¸€ä¸ªå…¬å…± API çš„æ—¶å€™ï¼Œåº”è¯¥ä¸ºç”¨æˆ·æä¾›è¿™ä¸¤ç§é€‰é¡¹ï¼Œé™¤éè‚¯å®šç»å¤§éƒ¨åˆ†ç”¨æˆ·åªä¼šé€‚ç”¨å…¶ä¸­ä¸€ç§æ–¹å¼ã€‚

### Collection æ¥å£

`Collection` æ¥å£æ˜¯ `Iterable` æ¥å£çš„å­ç±»å‹ï¼Œå®ƒæœ‰ä¸€ä¸ª `stream` æ–¹æ³•ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æä¾› Stream å’Œ for-each ä¸¤ç§è®¿é—®å…ƒç´ çš„æ–¹å¼ã€‚**å› æ­¤ï¼ŒCollection æˆ–è€…å…¶ä»–åˆé€‚çš„å­ç±»å‹é€šå¸¸æ˜¯ä¸€ä¸ªè¿”å›å…ƒç´ åºåˆ—çš„å…¬å…±æ–¹æ³•æœ€å¥½çš„è¿”å›å€¼ç±»å‹ã€‚**

æ•°ç»„ä¹Ÿæä¾›äº†è¿™ä¸¤ç§è®¿é—®æ–¹å¼ï¼š`Arrays.asList` å’Œ `Stream.of`ã€‚

å¦‚æœè¿”å›çš„åºåˆ—è¶³å¤Ÿå°ä¸”å®¹æ˜“å­˜å‚¨ï¼Œé‚£ä¹ˆæœ€å¥½è¿”å›æ ‡å‡†çš„é›†åˆå®ç°ï¼Œå¦‚ ArrayList æˆ–è¿™ HashSetã€‚ä½†æ˜¯**åƒä¸‡ä¸è¦ä¸ºäº†æŠŠå®ƒä»¬ä½œä¸ºä¸€ä¸ªé›†åˆè¿”å›ï¼Œè€Œåœ¨å†…å­˜ä¸­ä¿å­˜å·¨å¤§çš„åºåˆ—ã€‚**

<<<<<<< HEAD å¦‚æœè¿”å›çš„åºåˆ—å¾ˆå¤§ï¼Œä½†æ˜¯å¯ä»¥è¢«å‡†ç¡®å±•ç¤ºï¼Œå¯ä»¥è€ƒè™‘å®ç°ä¸€ä¸ªä¸“ç”¨çš„é›†åˆã€‚æ¯”å¦‚è¦è¿”å›ä¸€ä¸ªç»™å®šé›†åˆçš„å¹‚é›†ï¼ˆpower setï¼‰ï¼Œå®ƒç”±ç»™å®šé›†åˆçš„æ‰€æœ‰å­é›†ç»„æˆã€‚å¦‚æœç»™å®šé›†åˆçš„å¤§å°ä¸º nï¼Œé‚£ä¹ˆå¹‚é›†çš„å¤§å°å°±æ˜¯ 2^nã€‚æ‰€ä»¥ä¸åº”è¯¥å°†è¿™ä¸ªå¹‚é›†å­˜å‚¨åœ¨æ ‡å‡†é›†åˆå®ç°ä¸­ï¼Œå¯ä»¥å€ŸåŠ© `AbstracList` æ¥å®ç°ä¸€ä¸ªå®šåˆ¶é›†åˆã€‚

å¯ä»¥é‡‡ç”¨ä½å‘é‡ï¼ˆbit vectorï¼‰çš„æ–¹å¼ï¼š

// Returns the power set of an input set as custom collection  
public class PowerSet {  
    public static final <E> Collection<Set<E>> of(Set<E> s) {  
        List<E> src = new ArrayList<>(s);  
        if (src.size() > 30)  
            throw new IllegalArgumentException("Set too big " + s);   
          
        return new AbstractList<Set<E>>() {  
            @Override public int size() {  
                return 1 << src.size(); // 2 to the power srcSize  
            }  
            @Override public boolean contains(Object o) {  
                return o instanceof Set && src.containsAll((Set)o);  
            }  
            @Override public Set<E> get(int index) {  
                Set<E> result = new HashSet<>();  
                for (int i = 0; index != 0; i++, index >>= 1)  
                    if ((index & 1) == 1)  
                        result.add(src.get(i));  
                return result;  
            }  
        };   
    }  
}

> æ³¨æ„ PowerSet çš„ of æ–¹æ³•åœ¨ä¼ å…¥è¿›æ¥çš„ Set å¤§å°è¶…è¿‡ 30 æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚è¿™ä¹Ÿæ˜¯ `Collection` ä½œä¸ºè¿”å›å€¼ç±»å‹æ¯” Stream å’Œ Iterable ä¸è¶³çš„åœ°æ–¹ï¼šCollection çš„ size æ–¹æ³•è¿”å›çš„æ˜¯ int å€¼ï¼Œè¿™å°±é™åˆ¶äº†è¿”å›çš„å…ƒç´ åºåˆ—æœ€å¤šæœ‰ 2^31 - 1 ä¸ª

ä¸ºäº†åœ¨ `AbstracCollection` ä¸Šç¼–å†™å‡º `Collection` çš„ä¸€ä¸ªå®ç°ï¼Œé™¤äº† Iterable å¿…é¡»çš„æ–¹æ³•ä¹‹å¤–ï¼Œåªéœ€è¦å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼š`contains` å’Œ `size`ã€‚å¦‚æœè¿™ä¸¤ä¸ªæ–¹æ³•å®ç°ä¸äº†ï¼Œå¯èƒ½æ˜¯å› ä¸ºåœ¨è¿­ä»£ä¹‹å‰æ²¡æ³•ç¡®å®šå…ƒç´ åºåˆ—çš„å†…å®¹ï¼Œè¿™ç§æƒ…å†µå°±åº”è¯¥é€‰æ‹©è¿”å› Stream è¿˜æ˜¯ Iterableï¼Œæˆ–è€…æ˜¯éƒ½è¿”å›ã€‚

### å†è°ˆ Streamã€Iterable å’Œ Collection

åœ¨æœ‰äº›æ—¶å€™ï¼Œå¯ä»¥ä»…ä»…é€šè¿‡ Streamã€Iterable å’Œ Collection å“ªç§æ›´å®¹æ˜“å®ç°æ¥é€‰æ‹©ã€‚æ¯”å¦‚è¦è¿”å›ä¸€ä¸ªåˆ—è¡¨æ‰€æœ‰ç›¸é‚»çš„åˆ—è¡¨ï¼Œè¿™ä¸ªè¿”å›çš„åˆ—è¡¨å¤§å°ä¼šæ˜¯æºåˆ—è¡¨å¤§å°çš„å¹³æ–¹ã€‚è¿™ä¸ªå¤§å°æ˜¯ä¸å¯æ¥å—çš„ã€‚å¦‚æœè·Ÿä¹‹å‰çš„å¹‚é›†ä¸€æ ·å®šåˆ¶é›†åˆæ¥å®ç°ï¼Œä¼šæ›´åŠ éº»çƒ¦ã€‚

ä½†æ˜¯ç”¨ Stream å´å¾ˆç®€å•ã€‚å‡è®¾æºåˆ—è¡¨ä¸º [a, b, c]ï¼Œé‚£ä¹ˆè®¾ prefix ä¸º [a], [a, b], [a, b, c]ï¼Œsuffix ä¸º [a, b, c], [b, c], [c]ã€‚è¿™æ ·ï¼Œå­åˆ—è¡¨å°±å˜æˆäº† prefix çš„ suffix å†åŠ ä¸Šä¸€ä¸ªç©ºåˆ—è¡¨ï¼š

// Returns a stream of all the sublists of its input list  
public class SubLists {  
    public static <E> Stream<List<E>> of(List<E> list) {  
        return Stream.concat(Stream.of(Collections.emptyList()),  
                             prefixes(list).flatMap(SubLists::suffixes));  
    }  
    private static <E> Stream<List<E>> prefixes(List<E> list) {  
        return IntStream.rangeClosed(1, list.size())  
            .mapToObj(end -> list.subList(0, end));  
    }  
         
    private static <E> Stream<List<E>> suffixes(List<E> list) {  
        return IntStream.range(0, list.size())  
            .mapToObj(start -> list.subList(start, list.size()));  
    }   
}

è¿™æ®µä»£ç çš„å®ç°æœ¬è´¨ä¸Šå’Œ for-each ç±»ä¼¼ï¼š

for (int start = 0; start < src.size(); start++)  
    for (int end = start + 1; end <= src.size(); end++)  
        System.out.println(src.subList(start, end));

è¿™ä¸ª for å¾ªç¯ä¹Ÿå¯ä»¥ç›´æ¥ç¿»è¯‘æˆä¸€ä¸ª Streamã€‚è¿™æ ·å¾—åˆ°çš„ç»“æœæ¯”å‰ä¸€ä¸ª Stream å®ç°æ›´åŠ ç®€æ´ï¼Œä½†æ˜¯å¯è¯»æ€§ç¨å¾®å·®äº†ä¸€ç‚¹ã€‚ å®ƒæœ¬è´¨ä¸Šä¸ç¬¬ 45 æ¡ä¸­ç¬›å¡å°”ç§¯çš„ Stream ä»£ç ç›¸ç±»ä¼¼ :

// Returns a stream of all the sublists of its input list  
public static <E> Stream<List<E>> of(List<E> list) {  
    return IntStream.range(0, list.size())  
        .mapToObj(start ->  
            IntStream.rangeClosed(start + 1, list.size())  
            .mapToObj(end -> list.subList(start, end)))  
        .flatMap(x -> x);  
}

è¿™ä¸¤ä¸ª Stream çš„å®ç°éƒ½å¾ˆå¥½ï¼Œä½†ç”¨æˆ·è¦æƒ³é€‚ç”¨è¿­ä»£å°±å¿…é¡»è¦é€‚ç”¨é€‚é…å™¨ï¼Œè¿™å°±ä¼šæ˜æ˜¾å½±å“æ€§èƒ½ã€‚è¿˜æœ‰ï¼Œå¦‚æœå®ç°äº†å®šåˆ¶ Collectionï¼Œè¿™ä¼šå¾ˆéº»çƒ¦ä½†æ€§èƒ½ä¹Ÿä¼šæ˜æ˜¾æé«˜ã€‚

æ€»ç»“ï¼šå¦‚æœå¯ä»¥è¿”å›é›†åˆï¼Œå°±è¿”å›é›†åˆã€‚å¦‚æœé›†åˆä¸­å·²ç»æœ‰å…ƒç´ ï¼ˆTODOï¼šè¿™å¥çœ‹ä¸æ‡‚ï¼‰æˆ–è€…åºåˆ—ä¸­çš„å…ƒç´ æ•°é‡å¾ˆå°‘ï¼Œé‚£å°±è¿”å›ä¸€ä¸ªæ ‡å‡†çš„é›†åˆï¼Œå¦åˆ™å¯ä»¥è€ƒè™‘å®šåˆ¶çš„é›†åˆã€‚å¦‚æœæ— æ³•è¿”å›é›†åˆï¼Œå°±è¿”å› Stream æˆ–è€… Iterableï¼Œæˆ–è€…è¿”å›ä¸¤ä¸ªã€‚å¦‚æœå°†æ¥ Stream å®ç°äº† Iterable æ¥å£ï¼Œé‚£å°±å¯ä»¥æ”¾å¿ƒçš„è¿”å› Stream äº†ã€‚

## 48. è°¨æ…ä½¿ç”¨ Stream å¹¶è¡Œ

### é”™è¯¯ä½¿ç”¨ Stream å¹¶è¡Œ

å…¨æ€§å’Œæ´»æ€§å¤±è´¥ï¼ˆliveness failureï¼‰æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­éœ€è¦é¢å¯¹çš„é—®é¢˜ï¼Œ Stream pipeline å¹¶è¡Œä¹Ÿä¸ä¾‹å¤–ã€‚

ä¸‹é¢æ˜¯ç¬¬ 45 æ¡ä¸­çš„ç¨‹åºï¼š

// Stream-based program to generate the first 20 Mersenne primes  
   public static void main(String[] args) {  
       primes().map(p -> TWO.pow(p.intValueExact()).subtract(ONE))  
           .filter(mersenne -> mersenne.isProbablePrime(50))  
           .limit(20)  
           .forEach(System.out::println);  
}  
   static Stream<BigInteger> primes() {  
       return Stream.iterate(TWO, BigInteger::nextProbablePrime);  
}

åœ¨ pipeline ä¸­æ·»åŠ  `paralle()` åï¼Œä¸ä»…å¯èƒ½ä¼šæ…¢ä¸€ç‚¹ç‚¹ï¼Œè€Œä¸”å¾ˆå¯èƒ½ä¼šæ ¹æœ¬ä¸æ‰“å°å‡ºä»»ä½•å†…å®¹ï¼Œå¹¶æŒç»­æœ‰ç€æé«˜çš„ CPU ä½¿ç”¨ç‡ï¼ˆliveness failureï¼‰ã€‚

> è¿™æ®µç¨‹åºå¹¶è¡Œçš„æœ€åè™½ç„¶å¯èƒ½æ‰“å°å‡ºæ­£ç¡®ç­”æ¡ˆï¼Œä½†å¹¶ä¸æ˜¯æŒ‰å‡åºçš„ï¼Œå¿…é¡»ä½¿ç”¨ `forEachOrdered` æ¥ä»£æ›¿ `forEach`ã€‚

å¦‚æœæºå¤´æ˜¯æ¥è‡ª `Stream.iterate`ï¼Œæˆ–è€…ä½¿ç”¨äº† `limit` è¿™ä¸ªä¸­é—´æ“ä½œï¼Œé‚£ä¹ˆå¹¶è¡Œ pipeline æ˜¯ä¸ä¼šæå‡æ€§èƒ½çš„ã€‚å¤„ç† limit çš„é»˜è®¤å¹¶è¡Œç­–ç•¥æ˜¯è®¤ä¸º**ã€Œæ¯ä¸ªçº¿ç¨‹å¤šå¤„ç†ä¸€éƒ¨åˆ†é¢å¤–çš„å…ƒç´ ï¼Œå¹¶æ”¾å¼ƒä¸éœ€è¦çš„ç»“æœã€æ˜¯ä¸å½±å“æ€§èƒ½çš„**ã€‚åœ¨æ­¤ä¾‹ä¸­ï¼Œæ¯æŸ¥æ‰¾ä¸€ä¸ªæ¢…æ£®ç´ æ•°çš„æ—¶é—´å¤§æ¦‚æ˜¯ä¸Šä¸€ä¸ªæ¢…æ£®ç´ æ•°æŸ¥æ‰¾æ—¶é—´çš„ä¸¤å€ã€‚æ¢å¥è¯è¯´ï¼Œè®¡ç®—é¢å¤–ä¸€ä¸ªå…ƒç´ çš„æ—¶é—´è¿‘ä¼¼ç›¸ç­‰äºè®¡ç®—ä¹‹å‰æ‰€æœ‰å…ƒç´ çš„æ—¶é—´æ€»å’Œã€‚

### é€‚åˆ Stream å¹¶è¡Œçš„æ•°æ®ç»“æ„

è¦æƒ³é€šè¿‡ Stream å¹¶è¡Œæ¥è·å¾—æœ€å¥½çš„æ•ˆæœï¼Œåº”è¯¥é€šè¿‡ `ArrayList` `HashMap` `HashSet` `ConcurrentHashMap` å®ä¾‹ï¼›æ•°ç»„ï¼›int range å’Œ long rangeã€‚è¿™äº›æ•°æ®ç»“æ„éƒ½æœ‰ä¸‹é¢ä¸¤ä¸ªä¼˜ç‚¹ï¼š

-   å®ƒä»¬éƒ½å¯ä»¥å‡†ç¡®ä¸”è½»æ¾åœ°è¢«åˆ†å‰²æˆä»»ä½•å¤§å°çš„å­èŒƒå›´ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—å¹¶è¡Œçº¿ç¨‹åˆ†å·¥æ›´ç®€å•ã€‚Stream ç±»åº“ç”¨æ¥æ‰§è¡Œè¿™ä¸ªä»»åŠ¡çš„æŠ½è±¡æ˜¯åˆ†å‰²è¿­ä»£å™¨ï¼ˆ`spliterator`ï¼‰ï¼Œå®ƒæ˜¯ç”± Stream å’Œ Iterable ä¸­çš„ `spliterator` æ–¹æ³•è¿”å›çš„ã€‚
    
-   å®ƒä»¬åœ¨è¿›è¡Œé¡ºåºå¤„ç†æ—¶å®ƒä»¬æä¾›äº†ä¼˜å¼‚çš„å¼•ç”¨å±€éƒ¨æ€§ï¼ˆlocality of referenceï¼‰ï¼šé¡ºåºçš„å…ƒç´ å¼•ç”¨ä¸€èµ·ä¿å­˜åœ¨å†…å­˜ä¸­ï¼ˆæ³¨æ„ä¸Šé¢æ²¡æœ‰è¯´ `LinkedList` ç­‰å†…éƒ¨å…ƒç´ å¼•ç”¨å†…å­˜ä¸è¿ç»­çš„æ•°æ®ç»“æ„ï¼‰ã€‚ä½†æ˜¯è¿™äº›å¼•ç”¨æ‰€æŒ‡çš„å¯¹è±¡åœ¨å†…å­˜ä¸­å¯èƒ½å¹¶ä¸æ¥è¿‘ï¼Œè¿™å°±å½±å“äº†å¼•ç”¨çš„å±€éƒ¨æ€§ ã€‚**å¼•ç”¨å±€éƒ¨æ€§å¯¹äºå¹¶è¡Œæ‰¹å¤„ç†æ¥è¯´è‡³å…³é‡è¦**ï¼šæ²¡æœ‰å®ƒï¼Œæœ‰äº›çº¿ç¨‹å¯èƒ½ä¼šèŠ±è´¹å¾ˆå¤šæ—¶é—´ç­‰å¾…æ•°æ®ä»å†…å­˜è½¬ç§»åˆ°å¤„ç†å™¨çš„ç¼“å­˜ã€‚**å…·æœ‰æœ€ä½³å¼•ç”¨å±€éƒ¨æ€§çš„æ•°æ®ç»“æ„æ˜¯åŸºæœ¬ç±»å‹æ•°ç»„**ï¼Œå› ä¸ºæ•°æ®æœ¬èº«æ˜¯ç›¸é‚»åœ°ä¿å­˜åœ¨å†…å­˜ä¸­çš„ ã€‚
    

### Stream pipeline çš„ç»ˆæ­¢æ“ä½œ

å¦‚æœæ•´ä¸ª pipeline ä¸­æœ‰å¤§é‡å·¥ä½œåœ¨ç»ˆæ­¢æ“ä½œä¸­å®Œæˆï¼Œå¹¶ä¸”è¿™ä¸ªæ“ä½œæ˜¯å›ºå®šçš„é¡ºåºï¼Œé‚£ä¹ˆå¹¶è¡Œ pipeline çš„æ•ˆç‡å°±ä¼šå—åˆ°é™åˆ¶ï¼ˆæˆ‘ç†è§£çš„ï¼šç»ˆæ­¢æ“ä½œæ˜¯æ±‡é›†æ‰€æœ‰å¹¶å‘çº¿ç¨‹ç»“æœçš„å•çº¿ç¨‹ä»»åŠ¡ï¼‰ã€‚å¹¶è¡Œçš„æœ€ä½³ç»ˆæ­¢æ“ä½œæ˜¯åšå‡æ³•ï¼ˆreductionï¼‰ï¼Œç”¨ä¸€ä¸ª Stream çš„ `reduce` æ–¹æ³•ï¼Œæˆ–è€…å†…ç½®çš„åƒ `max`ã€`min`ã€`count` å’Œ `sum` ç­‰æ–¹æ³•ï¼Œå°†æ‰€æœ‰ä» pipeline äº§ç”Ÿçš„å…ƒç´ éƒ½åˆå¹¶åœ¨ä¸€èµ·ã€‚éª¤æ­»å¼æ“ä½œï¼ˆshort-circuiting operationï¼‰å¦‚ `anyMatch`ã€`allMatch` å’Œ `noneMatch` ä¹Ÿéƒ½å¯ä»¥å¹¶è¡Œã€‚ç”± Stream çš„ collect æ–¹æ³•æ‰§è¡Œçš„æ“ä½œéƒ½æ˜¯å¯å˜çš„å‡æ³•ï¼ˆmutable reductionï¼‰ä¸é€‚åˆå¹¶è¡Œï¼Œå› ä¸ºåˆå¹¶é›†åˆçš„æˆæœ¬éå¸¸é«˜ã€‚

### å†è®® Stream å¹¶è¡Œé£é™©

å¦‚æœè‡ªå·±ç¼–å†™ Streamã€Iterable æˆ–è€… Collection çš„å®ç°ï¼Œå¹¶ä¸”æƒ³è¦æœ‰è‰¯å¥½çš„å¹¶å‘æ•ˆç‡ï¼Œå°±å¿…é¡»é‡å†™ `spliterator` æ–¹æ³•ï¼Œå¹¶**éœ€è¦è¿›è¡Œå¤§é‡ç»“æœ Stream çš„æ€§èƒ½æµ‹è¯•**ã€‚ä½†ç¼–å†™é«˜è´¨é‡çš„ `spliterator` è¿‡äºå›°éš¾ã€‚

å¹¶è¡Œ Stream ä¸ä»…å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½å·®ï¼Œè¿˜åŒ…æ‹¬æ´»æ€§å¤±è´¥ï¼Œè€Œä¸”è¿˜å¯èƒ½å¯¼è‡´é”™è¯¯çš„ç»“æœå’Œä¸å¯é¢„æµ‹çš„è¡Œä¸ºï¼ˆå®‰å…¨æ€§å¤±è´¥ safety failuresï¼‰ã€‚å®‰å…¨æ€§å¤±è´¥å¯èƒ½æ˜¯å› ä¸ºå¹¶è¡Œçš„ pipeline ä½¿ç”¨äº† mapperã€filter æˆ–è€…ç¨‹åºå‘˜ç¼–å†™çš„å‡½æ•°å¯¹è±¡ï¼Œä½†æ²¡æœ‰å»éµå®ˆå®ƒä»¬çš„è§„èŒƒã€‚Stream è§„èŒƒå¯¹è¿™äº›å‡½æ•°å¯¹è±¡æœ‰ç€ä¸¥æ ¼è¦æ±‚ã€‚ä¾‹å¦‚ï¼Œä¼ åˆ° Stream reduce æ“ä½œçš„ accumulaotr å‡½æ•°å’Œ combiner å‡½æ•°ï¼Œå¿…é¡»æ˜¯æœ‰å…³è”ã€äº’ä¸å¹²æ‰°å’Œæ— çŠ¶æ€çš„ ã€‚ å¦‚æœä¸æ»¡è¶³è¿™äº›æ¡ä»¶ï¼ˆåœ¨ç¬¬ 46 æ¡ä¸­æåˆ°äº†ä¸€äº›ï¼‰ï¼Œä½†æ˜¯æŒ‰é¡ºåºè¿è¡Œ pipelineï¼Œå¯èƒ½ä¼šå¾—åˆ°æ­£ç¡®çš„ç»“æœï¼›å¦‚æœå¹¶å‘è¿è¡Œï¼Œåˆ™å¾ˆå¯èƒ½ä¼šå¤±è´¥ã€‚

å³ä½¿ä½¿ç”¨äº†ä¸€ä¸ªå¯ä»¥é«˜æ•ˆåˆ†å‰²çš„æº Streamï¼Œä¸€ä¸ªå¯å¹¶è¡Œçš„æˆ–è€…ç®€å•çš„ç»ˆæ­¢æ“ä½œï¼Œ ä»¥åŠäº’ä¸å¹²æ‰°çš„å‡½æ•°å¯¹è±¡ï¼Œé™¤é pipeline å®Œæˆäº†è¶³å¤Ÿçš„å®é™…å·¥ä½œæ¥æŠµæ¶ˆä¸å¹¶è¡Œç›¸å…³çš„æˆæœ¬ï¼Œä¸ç„¶ä¹Ÿæ— æ³•ä»å¹¶è¡Œä¸­è·å¾—æé€Ÿ ã€‚ æ®ä¸å®Œå…¨ä¼°è®¡ï¼ŒStream ä¸­çš„å…ƒç´ æ•°ä¹˜ä»¥æ¯ä¸ªå…ƒç´ æ‰€æ‰§è¡Œçš„ä»£ç è¡Œæ•°ï¼Œåº”è¯¥è‡³å°‘æœ‰åä¸‡è¡Œã€‚

å°½é‡ä¸è¦å¹¶è¡Œ Stream pipelineï¼Œé™¤éæœ‰å……åˆ†çš„ç†ç”±æ¥ä¿è¯æ­£ç¡®å’Œå¯ä»¥æå‡æ•ˆç‡ï¼Œå¹¶ä¸”è¦ç»è¿‡å¤§é‡çš„æµ‹è¯•ã€‚

### å…¶ä»–æœ‰æ•ˆçš„ Stream å¹¶è¡Œä¾‹å­

// Prime-counting stream pipeline - benefits from parallelization  
static long pi(long n) {  
    return LongStream.rangeClosed(2, n)  
        .mapToObj(BigInteger::valueOf)  
        .filter(i -> i.isProbablePrime(50))  
        .count();  
}

// Prime-counting stream pipeline - parallel version  
static long pi(long n) {  
    return LongStream.rangeClosed(2, n)  
        .parallel()  
        .mapToObj(BigInteger::valueOf)  
        .filter(i -> i.isProbablePrime(50))  
        .count();  
}

è¿™ä¸¤ä¸ªç‰ˆæœ¬åœ¨ä½œè€…çš„ç”µè„‘ä¸Šåˆ†åˆ«æ‰§è¡Œäº† 31 ç§’ å’Œ 9.2 ç§’ã€‚

æ ¹æ®ä¸Šæ–‡ï¼Œè¿™é‡Œå¹¶è¡Œèµ·æ•ˆæœçš„åŸå› æ˜¯ï¼Œæ¯ä¸ª pipeline éƒ½ä¸ä¼šç›¸äº’å¹²æ‰°ï¼Œå¹¶ä¸”éƒ½åšäº†å¤§é‡å·¥ä½œï¼Œç»ˆæ­¢æ“ä½œåªæ˜¯ç»Ÿè®¡ä¸ªæ•°ã€‚

å¦‚æœè¦å¹¶è¡Œä¸€ä¸ªéšæœºæ•° Streamï¼Œæœ€å¥½ä½¿ç”¨ `SplittableRandom` è€Œä¸æ˜¯ `ThreadLocalRandom` æˆ–æ˜¯å·²ç»è¿‡æ—¶çš„ `Random`ã€‚`SplittableRandom` å°±æ˜¯ä¸ºæ­¤è®¾è®¡çš„ï¼Œæœ‰ç€çº¿æ€§æé€Ÿçš„å¯èƒ½ã€‚è€Œ `ThreadLocalRandom` æ˜¯ä¸ºå•çº¿ç¨‹ä½¿ç”¨è€Œè®¾è®¡çš„ï¼Œå®ƒå¯ä»¥é€‚åº”è‡ªå·±ä½œä¸ºä¸€ä¸ªå¹¶è¡Œçš„ Stream æºï¼Œä½†ä¸ä¼šåƒ`SplittableRandom` é‚£æ ·å¿«ã€‚Random ä¼šåœ¨æ¯ä¸ªæ“ä½œä¸Šéƒ½è¿›è¡ŒåŒæ­¥ï¼Œå› æ­¤ä¼šä¸¥é‡å½±å“å¹¶å‘æ€§èƒ½ã€‚

# ä¸ƒ. æ–¹æ³•è®¾è®¡

## 49. æ£€æŸ¥å‚æ•°çš„æœ‰æ•ˆæ€§

å¦‚æœæ²¡æ£€æŸ¥å‚æ•°ï¼Œé‚£ä¹ˆå¯èƒ½åœ¨å¤„ç†çš„æ—¶å€™å¤±è´¥ï¼Œæˆ–è€…äº§ç”Ÿè´¹è§£çš„å¼‚å¸¸ï¼Œæˆ–è€…è¿”å›é”™è¯¯çš„è®¡ç®—ç»“æœï¼Œç”šè‡³å¯èƒ½æ‚„æ‚„ç ´åæŸä¸ªå¯¹è±¡çš„çŠ¶æ€ï¼Œå¹¶åœ¨å°†æ¥å¼•èµ·é”™è¯¯ã€‚æ²¡æœ‰éªŒè¯å‚æ•°çš„æœ‰æ•ˆæ€§ï¼Œå¯èƒ½ä¼šè¿èƒŒ**å¤±è´¥åŸå­æ€§ï¼ˆfailure atomicityï¼‰**ï¼Œè¯¦è§ç¬¬ 76 æ¡ã€‚

### public & protected

public å’Œ protected æ–¹æ³•ï¼Œè¦ä½¿ç”¨ Javadoc çš„ `@throw` æ ‡ç­¾ï¼ˆtagï¼‰åœ¨æ–‡æ¡£ä¸­è¯´æ˜è¿åå‚æ•°å€¼é™åˆ¶æ—¶ä¼šæŠ›å‡ºçš„å¼‚å¸¸ï¼ˆè¯¦è§ç¬¬ 74 æ¡ï¼‰ï¼Œé€šå¸¸ä¸º `IllegalArgumentException`ã€`IndexOutOfBoundsException` æˆ– `NullPointerException` ï¼ˆè¯¦è§ç¬¬ 72 æ¡ï¼‰ã€‚ä¸‹é¢æ˜¯ä¸ªä¾‹å­ï¼š

/**  
* Returns a BigInteger whose value is (this mod m). This method  
* differs from the remainder method in that it always returns a   
* non-negative BigInteger.  
*  
* @param m the modulus, which must be positive  
* @return this mod m  
* @throws ArithmeticException if m is less than or equal to 0 */  
public BigInteger mod(BigInteger m) {   
    if (m.signum() <= 0)  
        throw new ArithmeticException("Modulus <= 0: " + m);  
    ... // Do the computation  
}

ä¸Šé¢çš„ doc å¹¶æ²¡æœ‰è¯´ mod æ–¹æ³•ä¼šè¿”å› NPEï¼Œè™½ç„¶åœ¨è°ƒç”¨ m.signum æ—¶ä¼šå‘ç”Ÿã€‚ä½†è¿™ä¸ªå¼‚å¸¸å·²ç»åœ¨æ–¹æ³•æ‰€å±çš„ BigInteger ç±»ä¸Šæ³¨é‡Šäº†ï¼Œè€Œç±»çº§åˆ«çš„æ³¨é‡Šé€‚ç”¨äºç±» public æ–¹æ³•çš„æ‰€æœ‰å‚æ•°ã€‚è¿™æ ·å°±å¯ä»¥é¿å…åœ¨æ¯ä¸ªæ–¹æ³•ä¸Šéƒ½æ³¨é‡Šäº†ã€‚è¿™å¯ä»¥å’Œ `Nullable` æˆ–å…¶ä»–æ³¨è§£ç»“åˆä½¿ç”¨ï¼Œæ¥æé†’æŸä¸ªç‰¹å®šçš„å‚æ•°å¯èƒ½ä¼šç©ºã€‚

Java 7 æ–°å¢çš„ `Objects.requireNonNull` æ–¹æ³•ååˆ†çµæ´»å’Œæ–¹ä¾¿ï¼Œæ‰€ä»¥æ²¡å¿…è¦æ‰‹åŠ¨ç©ºå€¼æ£€æŸ¥äº†ã€‚è¿˜å¯ä»¥åœ¨å‚æ•°ä¸­å®šåˆ¶å¼‚å¸¸ä¿¡æ¯ã€‚

this.strategy = Objects.requireNonNull(strategy, "strategy");

Java 9 åœ¨ `Objects` ç±»æ–°å¢äº†ä¸‰ä¸ªèŒƒå›´æ£€æŸ¥çš„æ–¹æ³•ï¼š`checkFromIndexSize`ã€`checkFromToIndex` å’Œ `checkIndex`ã€‚è¿™å‡ ä¸ªæ–¹æ³•ä¸èƒ½å®šåˆ¶å¼‚å¸¸ä¿¡æ¯ï¼Œåªèƒ½ç”¨äº list å’Œ array ç´¢å¼•ï¼Œå¹¶ä¸”ä¸èƒ½å¤„ç†å·¦é—­å³é—­çš„æƒ…å†µã€‚

### unexported

å¯¹äºä¸å¯¼å‡ºï¼ˆunexportedï¼‰æ–¹æ³•ï¼ˆTODOï¼šprivate & defaultï¼Ÿï¼‰ï¼ŒåŒ…ä½œè€…å¯ä»¥æ§åˆ¶è¿™äº›æ–¹æ³•è¢«è°ƒç”¨çš„æƒ…å†µï¼Œæ‰€ä»¥åº”è¯¥ä¿è¯åªèƒ½ä¼ å…¥åˆæ³•å‚æ•°ã€‚å› æ­¤ï¼Œéå…¬å…±ï¼ˆnonpublicï¼‰æ–¹æ³•å¯ä»¥ç”¨æ–­è¨€ï¼ˆassertionï¼‰æ¥åˆ¤æ–­è¿™äº›å‚æ•°ï¼š

// Private helper function for a recursive sort  
private static void sort(long a[], int offset, int length) {  
	assert a != null;  
	assert offset >= 0 && offset <= a.length;  
	assert length >= 0 && length <= a.length - offset;   
    ... // Do the computation  
}

æœ¬è´¨ä¸Šï¼Œæ–­è¨€æ˜¯ç”¨æ¥å£°æ˜è¿™äº›æ¡ä»¶æ˜¯ trueï¼Œä¸ç”¨å»ç®¡æ‰€åœ¨çš„åŒ…å¦‚ä½•è¢«å®¢æˆ·ç«¯è°ƒç”¨ï¼ˆå› ä¸ºå®ƒä»¬æ˜¯ä¸å¯¼å‡ºçš„æ–¹æ³•ï¼‰ã€‚å’Œä¸€èˆ¬åˆæ³•æ€§æ£€æŸ¥ä¸ä¸€æ ·ï¼Œæ–­è¨€åœ¨å¤±è´¥æ—¶ä¼šæŠ›å‡º `AssertionError`ï¼›æ–­è¨€æ²¡æœ‰å½±å“å¹¶ä¸”æ²¡æœ‰æˆæœ¬ï¼Œé™¤éæ·»åŠ  JVM å‚æ•° -eaï¼ˆæˆ–è€… -enableassertionsï¼‰ã€‚

### ç‰¹æ®Šå‚æ•°

ä¸€å®šè¦æ³¨æ„æ£€æŸ¥**æ²¡æœ‰è¢«å½“å‰æ–¹æ³•ä½¿ç”¨ï¼Œä½†ä¼šè¢«å‚¨å­˜å¹¶åœ¨ä¹‹åä½¿ç”¨çš„å‚æ•°**ã€‚101 é¡µçš„é™æ€å·¥å‚æ–¹æ³•æ¥æ”¶ä¸€ä¸ª int arrayï¼Œç„¶åå°†è¿™ä¸ª array è½¬ä¸º List å¹¶è¿”å›ã€‚å‡è®¾å®¢æˆ·ç«¯ä¼ å…¥äº†å‚æ•° nullï¼Œå¹¶ä¸”è¿™ä¸ªé™æ€å·¥å‚æ–¹æ³•æ²¡æœ‰è¿›è¡Œéç©ºæ ¡éªŒï¼Œé‚£ä¹ˆè¿”å›ç»™å®¢æˆ·ç«¯çš„ List ä¸€ç»è°ƒç”¨å°±ä¼šæŠ›å‡º NPEã€‚

æ„é€ å™¨æ˜¯ä¸€ä¸ªå…¸å‹æƒ…å†µã€‚ä¸ä»…è¦æ£€æŸ¥ä¸Šè¿°å‚æ•°ï¼Œè¿˜è¦é¿å…æ„é€ å‡ºè¿åç±»ä¸å˜å¼ï¼ˆinvariantsï¼‰ï¼ˆæˆ–çº¦æŸæ¡ä»¶ï¼Ÿï¼‰çš„å¯¹è±¡ã€‚

### ä¾‹å¤–

å¹¶ä¸æ€»æ˜¯è¦åœ¨æ–¹æ³•è®¡ç®—å‰æ£€æŸ¥å‚æ•°ï¼Œä¸€ä¸ªé‡è¦çš„ä¾‹å¤–æ˜¯ï¼Œå‚æ•°åˆæ³•æ€§æ ¡éªŒä»£ä»·å¤§æˆ–è€…ä¸åˆæ³•çš„æƒ…å†µæ˜¯ä¸ç°å®ï¼Œå¹¶ä¸”åœ¨æ–¹æ³•å†…éƒ¨è®¡ç®—è¿‡ç¨‹ä¸­å·²ç»éšå¼æ£€æŸ¥è¿‡äº†ã€‚æ¯”å¦‚ Collections.sort(List) æ–¹æ³•ï¼Œlist ä¸­çš„å…ƒç´ éƒ½å¿…é¡»å®ç°äº† Comparable æ¥å£ï¼Œå¦åˆ™æŸä¸¤ä¸ªå¯¹è±¡æ¯”è¾ƒè¿‡ç¨‹ä¸­ä¼šæŠ›å‡º `ClassCastException`ã€‚å› æ­¤æå‰æ£€æŸ¥ list é‡Œçš„å…ƒç´ éƒ½å®ç° Comparable ä»£ä»·å¾ˆå¤§å¹¶ä¸”æ²¡æœ‰å¤šå¤§æ„ä¹‰ã€‚

ä½†ä¹Ÿè¦æ³¨æ„ï¼Œä¸åŠ åŒºåˆ†çš„ä¾èµ–è¿™ç§éšå¼å‚æ•°æ£€æŸ¥ä¼šå¯¼è‡´ä¸¢å¤±å¤±è´¥åŸå­æ€§ï¼ˆfailure atomicityï¼‰ã€‚

æœ‰æ—¶å€™éšå¼å‚æ•°æ£€æŸ¥å¤±è´¥åï¼Œä¼šæŠ›å‡ºä¸€ä¸ªéé¢„æœŸã€æ²¡æœ‰è®°å½•åœ¨æ³¨é‡Šä¸­çš„å¼‚å¸¸ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œåº”è¯¥ä½¿ç”¨ç¬¬ 73 æ¡è®²è¿°çš„å¼‚å¸¸è½¬æ¢ï¼ˆexception translationï¼‰æ–¹æ³•ï¼Œå°†è¿™ä¸ªå¼‚å¸¸è½¬æ¢ä¸ºæ­£ç¡®çš„å¼‚å¸¸ã€‚

### æ€»ç»“

å¹¶ä¸æ˜¯å¯¹å‚æ•°çš„ä»»ä½•é™åˆ¶éƒ½æ˜¯å¥½äº‹ï¼Œç›¸åï¼Œåº”è¯¥è®¾è®¡å°½å¯èƒ½é€šç”¨ä¸”ç¬¦åˆå®é™…éœ€è¦çš„æ–¹æ³•ã€‚å‡è®¾æ–¹æ³•å¯¹äºå®ƒæ¥æ”¶çš„æ‰€æœ‰å‚æ•°éƒ½èƒ½è¿”å›åˆç†çš„ç»“æœï¼Œé‚£ä¹ˆå‚æ•°çš„é™åˆ¶å°±è¶Šå°‘è¶Šå¥½ã€‚ä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œæœ‰äº›é™åˆ¶å¯¹äºè¢«å®ç°çš„æŠ½è±¡æ¥è¯´æ˜¯å›ºæœ‰çš„ã€‚

æ¯æ¬¡ç¼–å†™æ–¹æ³•æˆ–è€…æ„é€ å™¨çš„æ—¶å€™ï¼Œéƒ½åº”è¯¥è€ƒè™‘å‚æ•°è¦æœ‰å“ªäº›é™åˆ¶ï¼Œå¹¶ä¸”æŠŠè¿™äº›é™åˆ¶å†™è¿›æ–‡æ¡£ã€åœ¨æ–¹æ³•ä½“å¼€å¤´è¿›è¡Œæ˜¾å¼æ£€æŸ¥ã€‚

## 50. å¿…è¦æ—¶è¿›è¡Œä¿æŠ¤æ€§æ‹·è´

### ä¸ºä»€ä¹ˆè¦è¿›è¡Œä¿æŠ¤æ€§ï¼ˆdefensiveï¼‰æ‹·è´

æ²¡æœ‰å¯¹è±¡çš„å¸®åŠ©ï¼Œå¦ä¸€ä¸ªç±»ä¸å¯èƒ½ä¿®æ”¹å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œä½†æ˜¯å¯¹è±¡å¾ˆå®¹æ˜“åœ¨æ— æ„è¯†çš„æƒ…å†µä¸‹æä¾›è¿™ç§å¸®åŠ©ã€‚å‡è®¾éœ€è¦å®ç°ä¸€ä¸ª immutable ç±» Periodï¼š

// Broken "immutable" time period class  
public final class Period {  
    private final Date start;  
    private final Date end;  
    /**  
    * @param start the beginning of the period  
    * @param end the end of the period; must not precede start   
    * @throws IllegalArgumentException if start is after end  
    * @throws NullPointerException if start or end is null  
    */  
    public Period(Date start, Date end) {  
        if (start.compareTo(end) > 0)  
            throw new IllegalArgumentException(  
            start + " after " + end);  
        this.start = start;  
        this.end   = end;  
    }  
    public Date start() {  
        return start;  
    }  
    public Date end() {  
        return end;  
    }  
    ...  // Remainder omitted  
}

ç¬¬ä¸€çœ¼å¯èƒ½ä¼šè§‰å¾—è¿™ä¸ªç±»å¯ä»¥å®ç° immutableï¼Œå¹¶ä¸”æœ‰ start åœ¨ end ä¹‹å‰çš„é™åˆ¶ã€‚ä½†æ˜¯å› ä¸º Date ç±»æœ¬èº«æ˜¯ mutableï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“**è¿åè¿™ä¸ªç±»çš„çº¦æŸ**ï¼š

// Attack the internals of a Period instance  
Date start = new Date();  
Date end = new Date();  
Period p = new Period(start, end);   
end.setYear(78); // Modifies internals of p!

Java 8 ä¸­å¯ä»¥é€šè¿‡ä½¿ç”¨ `Instant`ï¼ˆæˆ– `LocalDateTime`ã€`ZonedDateTIme`ï¼‰ä»£æ›¿ Date æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸º `Instant` å’Œå…¶ä»– `java.time` åŒ…ä¸‹çš„ç±»éƒ½æ˜¯ immutableï¼ˆç¬¬ 17 æ¡ï¼‰ã€‚è€Œ Date å·²ç»è¿‡æ—¶äº†ï¼Œä¸”ä¸åº”è¯¥å†ä½¿ç”¨äº†ã€‚ä½†æ˜¯ API å’Œå†…éƒ¨è¡¨è¾¾å¼ä¸­æ€»ä¼šéœ€è¦ä½¿ç”¨ä¸€äº› mutable å€¼ç±»å‹ã€‚

### Immutable ç±»éœ€è¦è¿›è¡Œé˜²å¾¡æ€§æ‹·è´

#### åœ¨æ„é€ æ–¹æ³•ä¸­è¿›è¡Œä¿æŠ¤æ€§æ‹·è´

é¦–å…ˆè¯¥æ„é€ å™¨ä¸­çš„ mutable å‚æ•°è¿›è¡Œä¿æŠ¤æ€§æ‹·è´ï¼Œè¿™æ ·å°±èƒ½é¿å…ä¸Šé¢çš„æ”»å‡»ï¼š

// Repaired constructor - makes defensive copies of parameters  
public Period(Date start, Date end) {  
    this.start = new Date(start.getTime());  
    this.end   = new Date(end.getTime());  
    if (this.start.compareTo(this.end) > 0)  
        throw new IllegalArgumentException(  
        this.start + " after " + this.end);  
}

æ³¨æ„åˆ°ï¼šä¿æŠ¤æ€§æ‹·è´å‘ç”Ÿåœ¨å‚æ•°æ£€æŸ¥ï¼ˆç¬¬ 49 æ¡ï¼‰ä¹‹å‰ï¼Œå¹¶ä¸”å‚æ•°æ£€æŸ¥è¿›è¡Œåœ¨æ‹·è´åçš„å‚æ•°ä¸Šã€‚è¿™çœ‹èµ·æ¥ä¸æ­£å¸¸ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…è¿™æ ·çš„æƒ…å†µï¼šå‚æ•°é€šè¿‡äº†æ ¡éªŒä¹‹åè¢«å¦ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹ä¸ºéæ³•çš„ï¼Œç„¶åè¢«æ‹·è´è¿›ç±»ä¸­ã€‚è¿™è¢«ç§°ä½œ Time-Of-Check/Time-Of-Use æˆ–è€… TOCTOU æ”»å‡»ã€‚

##### åœ¨æ„é€ å™¨ä¸­ï¼Œå¯¹äºä¸å¯ä¿¡çš„å¯è¢«ç»§æ‰¿ç±»å‚æ•°ä¸è¦ä½¿ç”¨ clone æ–¹æ³•

å¹¶ä¸”ä¸Šé¢ä»£ç ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨ Date ç±»çš„ `clone` æ–¹æ³•æ¥å®ç°ä¿æŠ¤æ€§æ‹·è´ã€‚å› ä¸º Date ç±»ä¸æ˜¯ final çš„ï¼Œ`clone` æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯è¿”å› java.util.Date ç±»å¯¹è±¡ï¼Œç”šè‡³å¯èƒ½è¿”å›ä¸€ä¸ªä¸“é—¨å‡ºäºæ¶æ„ç›®çš„è®¾è®¡çš„ä¸å¯ä¿¡å­ç±»çš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œè¿™äº›å­ç±»å¯ä»¥åœ¨åˆ›å»ºæ¯ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œéƒ½æŠŠè¿™ä¸ªå¯¹è±¡å¼•ç”¨è®°å½•åˆ° private static åˆ—è¡¨ä¸­ï¼Œä½¿å¾—æ”»å‡»è€…å¯ä»¥æ§åˆ¶æ‰€æœ‰å®ä¾‹ã€‚

#### è®¿é—®æ–¹æ³•ä½¿ç”¨é˜²å¾¡æ€§æ‹·è´

Period å®ä¾‹ä¾ç„¶å¯èƒ½è¢«æ”»å‡»ï¼š

// Second attack on the internals of a Period instance  
Date start = new Date();  
Date end = new Date();  
Period p = new Period(start, end);   
p.end().setYear(78); // Modifies internals of p!

é€šè¿‡ä¿®æ”¹è®¿é—®æ–¹æ³•æ¥é˜²å¾¡ç¬¬äºŒç§æ”»å‡»ï¼š

// Repaired accessors - make defensive copies of internal fields  
public Date start() {  
    return new Date(start.getTime());  
}  
public Date end() {  
    return new Date(end.getTime());  
}

ç°åœ¨ï¼ŒPeriod ç±»æ˜¯çœŸæ­£çš„ immutable äº†ï¼Œå¹¶ä¸” start ä¼šæ°¸è¿œåœ¨ end ä¹‹å‰ï¼Œå› ä¸ºæ­¤æ—¶æ²¡æœ‰ä»»ä½•ç±»å¯ä»¥æ¥è§¦åˆ° Period çš„ mutable å±æ€§ï¼Œè¿™äº›å±æ€§å®Œå…¨è¢«å¯¹è±¡å°è£…èµ·æ¥äº†ã€‚

##### åœ¨è®¿é—®æ–¹æ³•ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ clone æ–¹æ³•

è¿™å’Œæ„é€ å™¨ä¸åŒï¼Œå› ä¸ºæ­¤æ—¶çš„å±æ€§æ˜¯åœ¨æ„é€ å™¨ä¸­é€šè¿‡é˜²å¾¡æ€§æ‹·è´ç”Ÿæˆçš„ï¼Œæˆ‘ä»¬èƒ½æ§åˆ¶å®ƒåˆ°åº•æ˜¯ä»€ä¹ˆç±»ï¼Œæ¯”å¦‚æ­¤ä¾‹ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ start ä¸€å®šæ˜¯ä¸€ä¸ª java.util.Date ç±»å¯¹è±¡ã€‚è¿™è¯´æ˜äº†ï¼Œæœ€å¥½ä½¿ç”¨æ„é€ å™¨å’Œé™æ€å·¥å‚æ¥å¤åˆ¶å¯¹è±¡ï¼ŒåŸå› åœ¨ç¬¬ 13 æ¡ã€‚

### ä¸æ­¢æ˜¯ Immutable ç±»éœ€è¦é˜²å¾¡æ€§æ‹·è´

åœ¨ä»»ä½•æ—¶å€™ï¼Œæ–¹æ³•æˆ–è€…æ„é€ å™¨åœ¨**å†…éƒ¨æ•°æ®ç»“æ„**ä¸­å­˜å‚¨äº†ä¸€ä¸ªå¼•ç”¨ï¼ŒæŒ‡å‘å®¢æˆ·ç«¯æä¾›çš„å¯¹è±¡ã€‚å¦‚æœè¿™ä¸ªå®¢æˆ·ç«¯æä¾›çš„å¯¹è±¡æ˜¯ mutableï¼Œå¹¶ä¸”æ–¹æ³•æˆ–è€…æ„é€ å™¨æ‰€åœ¨çš„ç±»ä¸èƒ½åº”å¯¹è¿™ä¸ªå¯¹è±¡è¿›å…¥æ•°æ®ç»“æ„ä¹‹åå‘ç”Ÿçš„å˜åŒ–ï¼Œé‚£ä¹ˆå°±å¿…é¡»è¦å¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡Œä¿æŠ¤æ€§æ‹·è´ï¼Œè®©æ‹·è´åçš„å¯¹è±¡è¿›å…¥æ•°æ®ç»“æ„ä¸­ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨å®¢æˆ·ç«¯çš„å¯¹è±¡ä½œä¸ºå†…éƒ¨ Set æˆ–è€… Map çš„ keyï¼Œå¦‚æœè¿™ä¸ªå¯¹è±¡æ’å…¥ Set æˆ–è€… Map ä¹‹åå‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆ Set æˆ–è€… Map çš„çº¦æŸæ¡ä»¶å°±å¯èƒ½ä¼šé­åˆ°ç ´åã€‚

> æ¯”å¦‚ Map çš„ Key æ˜¯å®¢æˆ·ç«¯æä¾›çš„ Personï¼Œå¦‚æœ Person çš„ name ç›¸åŒï¼Œåˆ™ equals è¿”å› trueã€‚è¿™æ ·å¯èƒ½ä¸¤ä¸ª name ä¸åŒçš„ Person éƒ½èƒ½è¿›å…¥ Mapï¼Œä½†å…¶ä¸­ä¸€ä¸ª Person çš„ name è¢«ä¿®æ”¹æˆå¦ä¸€ä¸ª Person çš„ nameï¼Œè¿™æ—¶å€™ Map å°±å­˜å‚¨äº†ä¸¤ä¸ªç›¸åŒçš„ keyã€‚

### è¿”å›å†…éƒ¨ mutable ç»„ä»¶æ—¶å¯èƒ½éœ€è¦é˜²å¾¡æ€§æ‹·è´

å½“è¿”å›å†…éƒ¨ mutable ç»„ä»¶ç»™å®¢æˆ·ç«¯ä¹‹å‰ï¼Œæ— è®ºè¿™ä¸ªç±»æ˜¯å¦æ˜¯ immutableï¼Œéƒ½è¦è€ƒè™‘æ˜¯å¦è¦å¯¹è¿™ä¸ª mutable ç»„ä»¶åšé˜²å¾¡æ€§æ‹·è´ã€‚ä¾‹å¦‚é’ˆå¯¹æ•°ç»„ï¼Œåªè¦å®ƒçš„é•¿åº¦éé›¶ï¼Œé‚£ä¹ˆå®ƒå°±æ€»æ˜¯ mutableã€‚åœ¨è¿”å›å†…éƒ¨æ•°ç»„æ—¶ï¼Œä¸€å®šè¦è¿›è¡Œä¿æŠ¤æ€§æ‹·è´ï¼Œæˆ–è€…è¿”å›è¯¥æ•°ç»„çš„ immutable viewï¼ˆè¿™ä¸¤ç§æ–¹æ³•è¯¦è§ç¬¬ 15 æ¡ï¼‰ã€‚

### ä¾‹å¤–æƒ…å†µ

1.  å¦‚æœç±»ä¿¡ä»»è°ƒç”¨å®ƒçš„å®¢æˆ·ç«¯ä¸ä¼šä¿®æ”¹å†…éƒ¨ç»„ä»¶ï¼ˆå¯èƒ½å› ä¸ºå®ƒä»¬æ˜¯åŒä¸€ä¸ªåŒ…ä¸‹çš„ï¼‰ï¼Œå¯ä»¥ä¸é‡‡ç”¨ä¿æŠ¤æ€§æ‹·è´ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œç±»çš„æ–‡æ¡£å¿…é¡»è¯´æ¸…æ¥šè°ƒç”¨è€…å¿…é¡»ä¸èƒ½ä¿®æ”¹å—åˆ°å½±å“çš„å‚æ•°å’Œè¿”å›å€¼ï¼›
    
2.  ä¸åœ¨åŒä¸€ä¸ªåŒ…ä¸‹ä¹Ÿæœ‰å¯èƒ½å‡ºç°ä¾‹å¤–æƒ…å†µã€‚æœ‰ä¸€äº›æ–¹æ³•å’Œæ„é€ å™¨ï¼Œå¯èƒ½ä¼šæ¥æ”¶å®¢æˆ·ç«¯ä¼ æ¥çš„å¯¹è±¡ï¼Œå¹¶è¦è·å¾—è¿™ä¸ªå¯¹è±¡çš„æ§åˆ¶æƒã€‚è¿™ç§æ–¹æ³•å’Œæ„é€ å™¨å¿…é¡»åœ¨æ–‡æ¡£ä¸­æ¸…æ¥šè¯´æ˜ï¼Œå®¢æˆ·ç«¯å¿…é¡»ä¿è¯ä¸ä¼šåœ¨ä»¥åä¿®æ”¹æ‰€ä¼ çš„å‚æ•°ï¼ˆå½¢å¼ä¸Šæœ‰ç‚¹ç±»ä¼¼ 18 æ¡çš„åŒ…è£…è€…æ¨¡å¼ï¼‰ã€‚
    

### æ€»ç»“

1.  å°½å¯èƒ½åœ¨ç±»ä¸­ä½¿ç”¨ immutable å¯¹è±¡æ¥ä½œä¸ºç»„ä»¶ï¼Œå¦‚ç”¨ Instant ä»£æ›¿ Dateï¼Œæˆ–è€…ç”¨ Date.getTime() è¿”å›çš„ long æ¥åšä¸ºç»„ä»¶ã€‚
    
2.  å¦‚æœç±»åŒ…å«ä»å®¢æˆ·ç«¯ä¼ æ¥æˆ–è¿”å›ç»™å®¢æˆ·ç«¯çš„ mutable å¯¹è±¡ï¼Œä¸€å®šè¦è¿›è¡Œä¿æŠ¤æ€§æ‹·è´ã€‚åªæœ‰åœ¨è€ƒè™‘åˆ°æ€§èƒ½ã€å®¢æˆ·ç«¯å¯ä¿¡ã€æœ‰æ˜ç¡®æ–‡æ¡£è¯´æ˜çš„æƒ…å†µä¸‹ï¼Œæ‰å¯ä»¥ä¸ç”¨ä¿æŠ¤æ€§æ‹·è´ã€‚
    

## 51. è°¨æ…è®¾è®¡æ–¹æ³•ç­¾å

æœ¬æ¡ç›®æ˜¯è‹¥å¹² API è®¾è®¡æŠ€å·§çš„æ€»ç»“ã€‚

### è°¨æ…é€‰æ‹©æ–¹æ³•å

å‘½åè¦å§‹ç»ˆéµå®ˆæ ‡å‡†å‘½åä¹ æƒ¯ï¼ˆè¯¦è§ç¬¬ 68 æ¡ï¼‰ã€‚é¦–å…ˆå‘½åè¦æ˜“äºç†è§£ï¼Œä¸”å’ŒåŒä¸€ä¸ªåŒ…ä¸­çš„å…¶ä»–å‘½åé£æ ¼ä¸€è‡´ã€‚å…¶æ¬¡è¦ç¬¦åˆå¹¿æ³›å…±è¯†ã€‚å°½é‡é¿å…é•¿å‘½åã€‚

å¦‚æœè¿˜æœ‰ç–‘é—®çš„è¯ï¼Œå¯ä»¥å»å‚è€ƒ Java ç±»åº“ä¸­çš„ APIã€‚

### ä¸è¦è¿‡äºè¿½æ±‚æä¾›ä¾¿åˆ©çš„æ–¹æ³•

æ¯ä¸ªæ–¹æ³•éƒ½åº”è¯¥å°½å…¶æ‰€èƒ½ã€‚æ–¹æ³•å¤ªå¤šä¼šä½¿ç±»éš¾ä»¥ç†è§£ã€ä½¿ç”¨ã€æ–‡æ¡£åŒ–ã€æµ‹è¯•å’Œç»´æŠ¤ã€‚è¿™å¯¹æ¥å£æ¥è¯´æ›´æ˜¯å¦‚æ­¤ï¼Œå¤ªå¤šçš„æ–¹æ³•ä¼šè®©å®ç°è€…å’Œä½¿ç”¨è€…éƒ½ååˆ†è´¹è§£ã€‚å¯¹äºä½ çš„ç±»æˆ–æ¥å£æ‰€æ”¯æŒçš„æ¯ä¸ªè¡Œä¸ºï¼Œéƒ½æä¾›ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„æ–¹æ³•ã€‚åªæœ‰åœ¨ç»å¸¸ä½¿ç”¨çš„æƒ…å†µä¸‹æ‰è€ƒè™‘æä¾›ä¸€ä¸ª "é€Ÿè®°ï¼ˆshorthandï¼‰"ï¼Œä½†å¦‚æœæœ‰ç–‘é—®çš„è¯ï¼Œå°±ä¸è¦æä¾›ã€‚

> åŠŸèƒ½é½å…¨çš„æ–¹æ³•å’Œé€Ÿè®°åº”è¯¥æ˜¯è¿™æ ·å§ï¼šå‰è€…æ˜¯å‚æ•°å¾ˆå¤šçš„æ–¹æ³•ï¼Œè€Œåè€…æ˜¯å‚æ•°å¾ˆå°‘çš„æ–¹æ³•ï¼Œä½†å†…éƒ¨è°ƒç”¨å‰è€…å¹¶ä¸ºç¼ºå°‘çš„å‚æ•°æä¾›é»˜è®¤å€¼ã€‚

### é¿å…è¿‡é•¿çš„å‚æ•°åˆ—è¡¨

å››ä¸ªå‚æ•°æˆ–è€…æ›´å°‘æ˜¯æœ€å¥½çš„ã€‚å¦‚æœä½ çš„è®¸å¤š API å‚æ•°éƒ½è¿‡é•¿ï¼Œç”¨æˆ·è®°ä¸äº†è¿™ä¹ˆå¤šå°±ä¼šä¸åœå»æŸ¥çœ‹æ–‡æ¡£ã€‚

**è€Œç›¸åŒç±»å‹çš„é•¿å‚æ•°åˆ—è¡¨å°¤å…¶æœ‰å®³ã€‚**ç”¨æˆ·ä¸ä»…å¯èƒ½ä¼šè®°ä¸æ¸…å‚æ•°é¡ºåºï¼Œä»è€Œå¯¼è‡´å¼„é”™å‚æ•°é¡ºåºä½†ç¨‹åºä¾ç„¶é€šè¿‡äº†ç¼–è¯‘ã€‚

è§£å†³åŠæ³•æœ‰ ç§ï¼š

1.  å°†é•¿å‚æ•°æ–¹æ³•æ‹†åˆ†æˆå¤šä¸ªæ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•éœ€è¦ä¹‹å‰æ–¹æ³•å‚æ•°çš„ä¸€ä¸ªå­é›†ã€‚ä½†è¿™æ ·å¯èƒ½ä¼šå¯¼è‡´æ–¹æ³•è¿‡å¤šã€‚æ–¹æ³•è¿‡å¤šçš„é—®é¢˜å¯ä»¥é€šè¿‡æå‡æ–¹æ³•çš„æ­£äº¤æ€§ï¼ˆorthogonalityï¼‰æ¥è§£å†³ã€‚
    
    > æå‡æ–¹æ³•æ­£äº¤æ€§ï¼šå¦‚ java.util.Listï¼Œå¹¶æ²¡æœ‰æä¾›ã€Œåœ¨æŸä¸ªå­åˆ—è¡¨ï¼ˆsublistï¼‰ä¸­æŸ¥æ‰¾æŸä¸ªå…ƒç´ ç¬¬ä¸€æ¬¡æˆ–æœ€åä¸€æ¬¡å‡ºç°çš„ä½ç½®ã€çš„æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªçš„æ–¹æ³•éƒ½ä¼šéœ€è¦ä¸‰ä¸ªå‚æ•°ã€‚List æä¾›äº† `subList` æ–¹æ³•è¿”å›å­åˆ—è¡¨çš„è§†å›¾ï¼ˆviewï¼‰ï¼Œå¯ä»¥é…åˆ `indexOf` å’Œ `lastIndexOf` æ¥å®ç°ä¸Šè¿°éœ€æ±‚ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åªéœ€è¦ä¸€ä¸ªå‚æ•°ã€‚è€Œä¸”å­åˆ—è¡¨è¿˜å¯ä»¥å’Œå…¶ä»– List æ“ä½œç»“åˆï¼Œè¿™æ ·çš„ API å°±ä¼šæœ‰å¾ˆé«˜çš„åŠŸèƒ½-æƒé‡ï¼ˆpower-to- weightï¼‰æ¯”ã€‚
    
2.  å¦‚æœæ–¹æ³•çš„ä¸€äº›å‚æ•°å¯ä»¥ä»£è¡¨ä¸€ä¸ªç±»ï¼Œå¯ä»¥åˆ›å»ºè¾…åŠ©ç±»æˆ–ä½¿ç”¨ç°æœ‰çš„ç±»æ¥ä»£æ›¿ä¸€è¿ä¸²å‚æ•°ã€‚
    
3.  ç¬¬ä¸‰ç§æ–¹æ³•ç»“åˆå‰ä¸¤ç§çš„ä¼˜ç‚¹ï¼šä»**æ„é€ å¯¹è±¡åˆ°æ‰§è¡Œæ–¹æ³•**ï¼Œéƒ½ä½¿ç”¨ Builder æ¨¡å¼ï¼ˆè¯¦è§ç¬¬ 2 æ¡ï¼‰ã€‚
    

### å‚æ•°ç±»å‹æœ€å¥½æ˜¯æ¥å£è€Œä¸æ˜¯ç±»

è¯¦è§ç¬¬ 64 æ¡ã€‚

### æœ€å¥½ä½¿ç”¨ä¸¤å…ƒç´ æšä¸¾ç±»å‹è€Œä¸æ˜¯ Boolean

é™¤éæ–¹æ³•åä¸­å¯ä»¥æ¸…æ¥šçš„äº†è§£åˆ°è¿™ä¸ª boolean çš„æ„ä¹‰ã€‚

æšä¸¾ä¼šä½¿ä»£ç æ›´å¥½ç¼–å†™å’Œé˜…è¯»ï¼Œå¹¶ä¸”å®ƒä»¬åœ¨ä»¥åå¯ä»¥å¾ˆå®¹æ˜“åœ°æ‹“å±•å…¶ä»–é€‰æ‹©ã€‚

ä¾‹å¦‚æœ‰ä¸ªä½¿ç”¨é™æ€å·¥å‚åˆ›å»ºçš„ Thermometer ç±»ï¼š

// 1. boolean å‚æ•°  
Thermometer.newInstance(true);  
  
// 2. ä¸¤å…ƒç´ æšä¸¾  
public enum TemperatureScale { FAHRENHEIT, CELSIUS }  
Thermometer.newInstance(TemperatureScale.CELSIUS)

ä¸Šä¾‹ä½¿ç”¨æšä¸¾ï¼Œåœ¨ä»¥åè¿˜å¯ä»¥æ·»åŠ æ›´å¤šä¿¡æ¯ï¼Œå¦‚ç»™æ¯ä¸ªæšä¸¾æ·»åŠ æ‘„æ°åº¦èŒƒå›´ç­‰ã€å°†æ‘„æ°åº¦è½¬ä¸ºåæ°åº¦ç­‰ã€‚

## 52. æ…ç”¨é‡è½½

### åé¢ä¾‹å­

public class CollectionClassifier {  
    public static String classify(Set<?> s) {  
        return "Set";  
    }  
    public static String classify(List<?> lst) {  
        return "List";  
    }  
    public static String classify(Collection<?> c) {  
        return "Unknown Collection";  
    }  
       
    public static void main(String[] args) {  
        Collection<?>[] collections = {  
            new HashSet<String>(),  
            new ArrayList<BigInteger>(),  
            new HashMap<String, String>().values()  
        };  
        for (Collection<?> c : collections)  
            System.out.println(classify(c));  
    }   
}

ç¨‹åºä¼šè¾“å‡ºä¸‰ä¸ª â€œUnknown Collectionâ€œã€‚

å› ä¸ºä¸‰æ¬¡å¾ªç¯ä¸­ï¼Œclassify çš„å‚æ•° `c` åœ¨ç¼–è¯‘æœŸé—´ç±»å‹éƒ½æ˜¯ `Collection<?>`ï¼Œè¿è¡Œæ—¶ç±»å‹æ¯ä¸ª `c` éƒ½ä¸åŒã€‚è€Œè°ƒç”¨å“ªä¸ªé‡è½½æ–¹æ³•æ˜¯åœ¨ç¼–è¯‘æœŸé—´æ ¹æ®å‚æ•°ç¼–è¯‘æœŸé—´ç±»å‹ç¡®å®šçš„ï¼Œæ‰€ä»¥ä¸‰æ¬¡å¾ªç¯éƒ½è°ƒç”¨äº†ç¬¬ä¸‰ä¸ªæ–¹æ³•ã€‚ï¼ˆå› ä¸º collections æ•°ç»„çš„ç±»å‹æ˜¯ Collectionï¼Œå…·ä½“ç±»å‹åœ¨è¿è¡ŒæœŸæ‰çŸ¥é“ï¼‰

> è€Œè¦†ç›–ä¸åŒï¼Œè¦†ç›–æ–¹æ³•æ˜¯åœ¨è¿è¡Œæ—¶æ ¹æ®æ–¹æ³•æ‰€åœ¨å¯¹è±¡çš„è¿è¡Œæ—¶ç±»å‹æ¥åŠ¨æ€é€‰æ‹©çš„ã€‚

æœ€å¥½çš„æ–¹æ³•æ˜¯ä¸‹é¢è¿™æ ·ï¼š

public static String classify(Collection<?> c) {  
    return c instanceof Set  ? "Set" :  
	       c instanceof List ? "List" : "Unknown Collection";  
}

### å®‰å…¨ä¿å®ˆçš„åšæ³•

1.  æ°¸è¿œä¸è¦å¯¼å‡ºä¸¤ä¸ªå‚æ•°æ•°é‡ç›¸åŒçš„æ–¹æ³•ï¼›
    
2.  å¦‚æœæ–¹æ³•ä½¿ç”¨å¯å˜å‚æ•°ï¼Œä¸è¦é‡è½½å®ƒï¼ˆé™¤äº†ç¬¬ 53 æ¡æè¿°çš„æƒ…å½¢å¤–ï¼‰ï¼›
    

å¦‚æœä¸Šé¢ä¸¤æ¡åšä¸åˆ°ï¼Œå¯ä»¥æ–°å»ºä¸€ä¸ªåå­—ä¸åŒçš„æ–¹æ³•ã€‚ä¾‹å¦‚ `ObjectOutputStream` ç±»ï¼Œå®ƒå¹¶æ²¡æœ‰é‡‡ç”¨ä¸º primitive ç±»å‹å’Œ reference ç±»å‹éƒ½é‡è½½ä¸€ä¸ª `write` æ–¹æ³•ï¼Œè€Œæ˜¯ä¸ºæ¯ç§ç±»å‹å•ç‹¬ç¼–å†™ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚ `writeBoolean`ã€`writeInt` ç­‰ã€‚å¹¶ä¸” `ObjectInputStream` è¿˜æä¾›äº†å¯¹åº”çš„ `read` æ–¹æ³•ã€‚

### æ„é€ å™¨

åŒä¸€ä¸ªç±»çš„å¤šä¸ªæ„é€ å™¨å¿…ç„¶æ˜¯é‡è½½çš„ã€‚å¦‚ç¬¬ 1 æ¡æ‰€è¯´ï¼Œå¾ˆå¤šæƒ…å†µä¸‹å¯ä»¥å¯¼å‡ºé™æ€å·¥å‚è€Œä¸æ˜¯æ„é€ å™¨ã€‚

å½“å¯¼å‡ºäº†ç›¸åŒå‚æ•°æ•°ç›®çš„æ„é€ å™¨æ—¶è¦å°¤å…¶æ³¨æ„ï¼Œä½¿ç”¨ä¸‹é¢ä¸€å°èŠ‚çš„æ–¹æ³•ã€‚

### å½“é‡è½½æ–¹æ³•å‚æ•°æ•°é‡ç›¸åŒæ—¶

å¦‚æœå¿…é¡»è¦è¿™æ ·ï¼Œé‚£ä¹ˆæ¯ä¸€å¯¹é‡è½½æ–¹æ³•éƒ½å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªä½ç½®ç›¸åŒçš„å‚æ•°çš„ç±»å‹å®Œå…¨ä¸åŒã€‚å¦‚æœä¸¤ä¸ªç±»éƒ½ä¸æ˜¯å¯¹æ–¹çš„å­ç±»ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªç±»å°±æ˜¯ä¸åŒçš„ã€‚ä¸ºäº†ä¿è¯è¿™ç‚¹ï¼Œè¦æ³¨æ„è‡ªåŠ¨è£…ç®±ã€Lambda å’Œæ•°ç»„ã€‚

#### è‡ªåŠ¨è£…ç®±

åœ¨ Java 5 ä¹‹å‰ï¼Œæ‰€æœ‰ primitive ç±»å‹éƒ½ä¸åŒäºæ‰€æœ‰çš„å¼•ç”¨ç±»å‹ï¼Œä½†ä¹‹åå‡ºç°è‡ªåŠ¨è£…ç®±ï¼š

public class SetList {  
    public static void main(String[] args) {  
        Set<Integer> set = new TreeSet<>();  
        List<Integer> list = new ArrayList<>();  
        for (int i = -3; i < 3; i++) {  
            set.add(i);  
            list.add(i);  
        }  
        for (int i = 0; i < 3; i++) {  
            set.remove(i);  
            list.remove(i);  
        }  
        System.out.println(set + " " + list);  
    }  
}

æœŸæœ›çš„ç»“æœæ˜¯åœ¨ set å’Œ list ä¸­åˆ é™¤éè´Ÿæ•°ï¼Œå¹¶è¾“å‡º [-3, -2, -1] [-3, -2, -1]ï¼Œä½†å®é™…ä¸Šè¾“å‡º [-3, -2, -1] [-2, 0, 2]ã€‚

`set.remove(i)` è°ƒç”¨é‡è½½æ–¹æ³• `remove(E)`ï¼Œè¿™é‡Œçš„ E æ˜¯ ï¼ˆIntegerï¼‰Set çš„å…ƒç´ ç±»å‹ï¼Œå°† i ä» int è‡ªåŠ¨è£…ç®±åˆ° Integerï¼Œå› æ­¤ç¨‹åºèƒ½æ­£å¸¸æ‰§è¡Œã€‚

è€Œ `list.remove(i)` è°ƒç”¨é€‰æ‹©é‡è½½æ–¹æ³• `remove(int i)`ï¼Œåˆ é™¤ list æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚ä¸ºäº†ä½¿èƒ½è¾“å‡ºæœŸæœ›ç»“æœï¼Œå¿…é¡» `list.remove((Integer) i)` æˆ– `list.remove(Integer.valueOf(i))`ã€‚

> å› ä¸º List<E> æ¥å£æœ‰ä¸¤ä¸ªé‡è½½çš„ remove æ–¹æ³•ï¼šremove(E) å’Œ remove(int)ã€‚å½“å®ƒåœ¨ Java 5 å‘è¡Œç‰ˆæœ¬ä¸­è¢«æ³›å‹åŒ–ä¹‹å‰ï¼ŒList æ¥å£æœ‰ä¸€ä¸ª remove(Object) è€Œä¸æ˜¯ remove(E)ï¼Œè€Œ Object å’Œ int æ ¹æœ¬ä¸åŒã€‚ä½†æ˜¯è‡ªä»æœ‰äº†æ³›å‹å’Œè‡ªåŠ¨è£…ç®±ä¹‹åï¼Œè¿™ä¸¤ç§å‚æ•°ç±»å‹å°±ä¸å†æ ¹æœ¬ä¸åŒäº†ã€‚ Javaè¯­è¨€ä¸­æ·»åŠ äº†æ³›å‹å’Œè‡ªåŠ¨è£…ç®±ä¹‹åï¼Œç ´åäº† List æ¥å£ã€‚

#### Lambda

TODOï¼šçœ‹ä¸æ‡‚ï¼Œ242é¡µï¼ŒThe addition of lambdas ... switch -Xlint:overloads.ã€‚

#### æ•°ç»„

1.  æ•°ç»„ç±»å‹å’Œ Object ç±»ä»¥å¤–çš„æ‰€æœ‰ç±»éƒ½ä¸åŒï¼›
    
2.  æ•°ç»„ç±»å‹å’Œ Serializableã€Clonable æ¥å£ä»¥å¤–çš„æ‰€æœ‰æ¥å£éƒ½ä¸åŒã€‚
    

#### å¯ä»¥è¿åçš„æƒ…å†µ

åœ¨æ›´æ–°ç°æœ‰ç±»çš„æ—¶å€™ï¼Œå¾ˆå¯èƒ½ä¼šè¿åè¦ã€Œå‚æ•°ç±»å‹å®Œå…¨ä¸åŒã€çš„è§„åˆ™ã€‚

å¦‚ Java4 ä»¥æ¥ï¼ŒString ç±»ä¸€ç›´æœ‰ä¸ª contentEquals(String buffer) æ–¹æ³•ã€‚Java 5 æ–°å¢äº†ä¸€ä¸ª `CharSequence` æ¥å£ï¼Œç”¨æ¥ä¸º StringBuilderã€StringBufferã€Stringã€CharBuffer ç­‰æä¾›å…¬å…±æ¥å£ã€‚åŒæ—¶ï¼Œä¹Ÿé‡è½½äº† contentEquals æ–¹æ³•ï¼Œå³ contetnEquals(CharSequence)ã€‚

è™½ç„¶ï¼Œè¿™è¿åäº†æœ¬æ¡åŸåˆ™ï¼Œä½†æ˜¯åªè¦å½“è¿™ä¸¤ä¸ªé‡è½½æ–¹æ³•åœ¨åŒæ ·çš„å‚æ•°ä¸Šè¢«è°ƒç”¨æ—¶ï¼Œå®ƒä»¬æ‰§è¡Œçš„æ˜¯ç›¸åŒçš„åŠŸèƒ½ï¼Œé‡è½½å°±ä¸ä¼šå¸¦æ¥å±å®³ã€‚ ç¨‹åºå‘˜å¯èƒ½å¹¶ä¸çŸ¥é“å“ªä¸ªé‡è½½å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œä½†åªè¦è¿™ä¸¤ä¸ªæ–¹æ³•è¿”å›ç›¸åŒçš„ç»“æœå°±è¡Œã€‚ç¡®ä¿è¿™ç§è¡Œä¸ºçš„æ ‡å‡†åšæ³•æ˜¯ï¼Œè®©æ›´å…·ä½“åŒ–çš„é‡è½½æ–¹æ³•æŠŠè°ƒç”¨è½¬å‘ç»™æ›´ä¸€èˆ¬åŒ–çš„é‡è½½æ–¹æ³•ï¼š

// Ensuring that 2 methods have identical behavior by forwarding  
public boolean contentEquals(StringBuffer sb) {  
    return contentEquals((CharSequence) sb);  
}

> ä½† Java ç±»åº“ä¹Ÿæœ‰å¾ˆå¤šç±»çœŸæ­£çš„è¿åäº†æœ¬æ¡ç›®çš„è§„åˆ™ã€‚æ¯”å¦‚ String ç±»å¯¼å‡ºä¸¤ä¸ªé‡è½½çš„é™æ€å·¥å‚æ–¹æ³•ï¼švalueOf(char []) å’Œ valueOf(Object)ï¼Œå®ƒä»¬ä¸¤ä¸ªè¢«ä¼ é€’åŒæ ·çš„å¯¹è±¡å¼•ç”¨æ—¶åšäº†å®Œå…¨ä¸åŒçš„äº‹ï¼ˆTODOï¼šåŒæ ·çš„å¯¹è±¡å¼•ç”¨æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿï¼‰ã€‚

### æ€»ç»“

-   é‡è½½æ–¹æ³•çš„é€‰æ‹©æ˜¯åœ¨ç¼–è¯‘æœŸæ ¹æ®ç¼–è¯‘ç±»å‹é€‰æ‹©çš„ï¼›
    
-   é‡è½½æ–¹æ³•æ—¶ï¼š
    
    -   ä¸è¦é‡è½½å‡ºä¸¤ä¸ªå‚æ•°æ•°ç›®ç›¸åŒçš„æ–¹æ³•å’Œæ„é€ å™¨ï¼›
        
        -   å¦‚æœæ–¹æ³•æˆ–æ„é€ å™¨å‚æ•°æ•°ç›®ç›¸åŒï¼Œå°±è¦ä¿è¯è‡³å°‘ä¸€å¯¹ç›¸åŒä½ç½®çš„å‚æ•°ç±»å‹ä¸åŒï¼›
            
            -   å¦‚æœè¿˜æ˜¯åšä¸åˆ°ï¼Œå°±åº”è¯¥ä¿è¯ä¼ é€’åŒæ ·å‚æ•°æ—¶ï¼Œæ‰€æœ‰é‡è½½æ–¹æ³•çš„è¡Œä¸ºå¿…é¡»ä¸€è‡´ï¼›
                
    -   å¦‚æœæ–¹æ³•ä½¿ç”¨å¯å˜å‚æ•°ï¼Œä¸è¦é‡è½½å®ƒï¼ˆé™¤äº†ç¬¬ 53 æ¡æè¿°çš„æƒ…å½¢å¤–ï¼‰ï¼›
        
    -   å¦‚æœä¸Šé¢ä¸¤æ¡éƒ½åšä¸åˆ°ï¼Œå¯ä»¥è€ƒè™‘ç»™æ–¹æ³•ä¸€ä¸ªæ–°å‘½åã€‚
        

## 53. æ…ç”¨å¯å˜å‚æ•°

### ä»‹ç»

å¯å˜å‚æ•°ï¼ˆvarargsï¼‰æ–¹æ³•ä¸€èˆ¬è¢«ç§°ä½œ variable arity methodsï¼ˆå¯åŒ¹é…ä¸åŒé•¿åº¦å˜é‡çš„æ–¹æ³•ï¼‰ï¼Œå®ƒæ¥å—é›¶ä¸ªæ´»å¤šä¸ªæŒ‡å®šç±»å‹çš„å‚æ•°ã€‚å¯å˜å‚æ•°æœºåˆ¶é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„å¤§å°ä¸ºåœ¨è°ƒç”¨ä½ç½®æ‰€ä¼ é€’çš„å‚æ•°æ•°é‡ï¼Œç„¶åå°†å‚æ•°å€¼ä¼ åˆ°æ•°ç»„ä¸­ï¼Œæœ€åå°†æ•°ç»„ä¼ é€’ç»™æ–¹æ³•ã€‚

Varargs æ˜¯ä¸º printfï¼ˆå’Œå¯å˜å‚æ•°ä¸€èµ·è¢«æ·»åŠ åˆ° Java ä¸­ï¼‰å’Œæ ¸å¿ƒåå°„æœºåˆ¶ï¼ˆè¯¦è§ç¬¬ 65 æ¡ï¼‰è®¾è®¡çš„ï¼Œå®ƒä»¬éƒ½ä» varargs ä¸­å—ç›Šå¾ˆå¤šã€‚

### æ­£ç¡®ä½¿ç”¨

å‡è®¾æœ‰ä¸‹é¢çš„æ–¹æ³•ï¼š

// Simple use of varargs  
static int sum(int... args) {  
    int sum = 0;  
    for (int arg : args)  
        sum += arg;  
    return sum;   
}

è¿™ç§æ–¹æ³•çš„å¯å˜å‚æ•°å¯ä»¥ä¸ºé›¶ä¸ªæˆ–è€…å¤šä¸ªï¼Œä½†æœ‰æ—¶å€™ä¼šå¸Œæœ›å¯å˜å‚æ•°è‡³å°‘ä¸ºä¸€ä¸ªï¼š

// The WRONG way to use varargs to pass one or more arguments!  
static int min(int... args) {  
    if (args.length == 0)  
        throw new IllegalArgumentException("Too few arguments");   
    int min = args[0];  
    for (int i = 1; i < args.length; i++)  
        if (args[i] < min)  
            min = args[i];  
    return min;   
}

ä¸Šé¢çš„ä»£ç æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š

1.  å®¢æˆ·ç«¯åœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œå¾ˆå¯èƒ½å› ä¸ºæ²¡æœ‰ä¼ å‚æ•°è€Œå¯¼è‡´è¿è¡Œæ—¶å¼‚å¸¸ï¼Œè€Œæ›´å¥½çš„æ–¹æ³•æ˜¯ç¼–è¯‘å¤±è´¥ã€‚
    
2.  ä¸Šé¢çš„ä»£ç é€šè¿‡æ˜¾å¼åˆ¤æ–­ args é•¿åº¦æ¥è¿›è¡Œåˆæ³•æ€§æ ¡éªŒï¼Œå¾ˆä¸ç¾è§‚ã€‚æˆ–è€…å°† min åˆå§‹åŒ–ä¸º Integer.MIN_VALUEï¼ŒåŒæ ·ä¹Ÿå¾ˆä¸ç¾è§‚ã€‚
    

æ­£ç¡®çš„æ–¹æ³•åº”è¯¥æ˜¯ï¼š

// The right way to use varargs to pass one or more arguments  
static int min(int firstArg, int... remainingArgs) {  
    int min = firstArg;  
    for (int arg : remainingArgs)  
        if (arg < min)  
            min = arg;  
    return min;   
}

### æ€§èƒ½é—®é¢˜

åœ¨é‡è§†æ€§èƒ½çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å¯å˜å‚æ•°æœºåˆ¶è¦ååˆ†å°å¿ƒï¼Œå› ä¸ºæ¯æ¬¡è°ƒç”¨å¯å˜å‚æ•°æ–¹æ³•éƒ½ä¼šå¯¼è‡´ä¸€æ¬¡æ•°ç»„åˆå§‹åŒ–å’Œåˆ†é…ã€‚å‡è®¾ç¡®å®šå¯¹æŸä¸ªæ–¹æ³• 95% çš„è°ƒç”¨ä¼šæœ‰ 3 ä¸ªæˆ–è€…æ›´å°‘çš„å‚æ•°ï¼Œå°±å£°æ˜è¯¥æ–¹æ³•çš„ 5 ä¸ªé‡è½½ï¼Œæ¯ä¸ªé‡è½½æ–¹æ³•å¸¦æœ‰ 0 è‡³ 3 ä¸ªæ™®é€šå‚æ•°ï¼Œå½“å‚æ•°çš„æ•°ç›®è¶…è¿‡ 3 ä¸ªæ—¶ï¼Œå°±ä½¿ç”¨ä¸€ä¸ªå¯å˜å‚æ•°æ–¹æ³•ï¼š

public void foo() { }  
public void foo(int a1) { }  
public void foo(int a1, int a2) { }  
public void foo(int a1, int a2, int a3) { }  
public void foo(int a1, int a2, int a3, int... rest) { }

æ­¤æ—¶ï¼Œåªæœ‰ 5% çš„æƒ…å†µä¸‹ï¼Œæ‰éœ€è¦å¯å˜å‚æ•°æœºåˆ¶ã€‚

> `EnumSet` ç±»å¯¹å®ƒçš„é™æ€å·¥å‚ä½¿ç”¨äº†è¿™ç§æ–¹æ³•ï¼Œæœ€å¤§é™åº¦åœ°å‡å°‘åˆ›å»ºæšä¸¾é›†åˆçš„æˆæœ¬ã€‚å½“æ—¶è¿™ä¹ˆåšæ˜¯æœ‰å¿…è¦çš„ï¼Œå› ä¸ºæšä¸¾é›†åˆä¸ºä½åŸŸï¼ˆbit fieldsï¼‰æä¾›äº†åœ¨æ€§èƒ½æ–¹é¢æœ‰ç«äº‰åŠ›çš„æ›¿ä»£æ–¹æ³•ï¼ˆè¯¦è§ç¬¬ 36æ¡ï¼‰ã€‚

### æ€»ç»“

ç®€è€Œè¨€ä¹‹ï¼Œåœ¨å®šä¹‰å‚æ•°æ•°ç›®ä¸å®šçš„æ–¹æ³•æ—¶ï¼Œå¯å˜å‚æ•°æ–¹æ³•æ˜¯ä¸€ç§å¾ˆæ–¹ä¾¿çš„æ–¹å¼ã€‚åœ¨ä½¿ç”¨å¯å˜å‚æ•°ä¹‹å‰ï¼Œè¦å…ˆåŒ…å«æ‰€æœ‰å¿…è¦çš„å‚æ•°ï¼Œå¹¶ä¸”è¦å…³æ³¨ä½¿ç”¨å¯å˜å‚æ•°æ‰€å¸¦æ¥çš„æ€§èƒ½å½±å“ã€‚

## 54. è¿”å›ç©ºæ•°ç»„æˆ–é›†åˆï¼Œè€Œä¸æ˜¯ null

### è¿”å› null çš„å±å®³

ä¸‹é¢çš„ä»£ç æ˜¯å¾ˆå¸¸è§çš„ï¼š

public List<Cheese> getCheeses() {  
       return cheesesInStock.isEmpty() ? null : new ArrayList<>(cheesesInStock);  
}

æŠŠæ²¡æœ‰å¥¶é…·å¯ä¹°çš„æƒ…å†µå½“ä½œæ˜¯ä¸€ç§ç‰¹ä¾‹ï¼Œè¿™æ˜¯ä¸åˆå¸¸ç†çš„ã€‚è¿™æ ·åšä¼šè¦æ±‚å®¢æˆ·ç«¯ä¸­å¿…é¡»æœ‰é¢å¤–çš„ä»£ç æ¥å¤„ç† null è¿”å›å€¼ï¼Œå¦‚æœå¿˜è®°äº†ï¼Œå¯èƒ½å¾ˆä¹…ä¹‹åæ‰ä¼šå‘ç”Ÿé”™è¯¯ã€‚

### ä¸ºä»€ä¹ˆè¦è¿”å›ç©ºæ•°ç»„æˆ–è€…é›†åˆ

å¯èƒ½æœ‰äººä¼šè®¤ä¸ºåˆ†é…é•¿åº¦ä¸º 0 çš„æ•°ç»„æˆ–è€…é›†åˆä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ï¼Œæ‰€ä»¥åº”è¯¥è¿”å› nullï¼Œä½†è¿™ç«™ä¸ä½è„šï¼ŒåŸå› æœ‰ä¸‹é¢ä¸¤ç‚¹ã€‚

-   åœ¨è¿™ç§çº§åˆ«çš„ä¸Šå¹¶ä¸åº”è¯¥æ‹…å¿ƒæ€§èƒ½ï¼Œé™¤éå¯ä»¥åˆ†æå‡ºæ¥è¿™ä¸ªåˆ†é…æ˜¯å¯¼è‡´æ€§èƒ½é—®é¢˜çš„åŸå› ï¼ˆè¯¦è§ç¬¬ 67 æ¡ï¼‰ã€‚
    
-   å¯ä»¥é€šè¿‡ä¸åˆ†é…ç©ºæ•°ç»„æˆ–è€…é›†åˆæ¥è¿”å›å®ƒä»¬ï¼Œå…¸å‹ç”¨æ³•å¦‚ä¸‹ï¼š
    
     //The right way to return a possibly empty collection  
    public List<Cheese> getCheeses() {  
           return new ArrayList<>(cheesesInStock);  
    }  
      
    //The right way to return a possibly empty array  
    public Cheese[] getCheeses() {  
        return cheesesInStock.toArray(new Cheese[0]);  
    }
    
    > TODOï¼šä»€ä¹ˆå«ä¸åˆ†é…è¿”å›ï¼Ÿè€Œä¸”ä¸Šé¢ä¸¤ç§ä»£ç çš„æ–¹å¼ï¼Œåœ¨å†…éƒ¨å®ç°ä¸Šå’Œä¸‹é¢è¦è®²çš„é‡å¤è¿”å›åŒä¸€ä¸ªç©ºé›†åˆæˆ–æ•°ç»„æ—¶ä¸€æ ·çš„ã€‚ä½†æœ‰ä¸¤ç‚¹åŒºåˆ«ï¼š
    > 
    > 1.  é›†åˆã€‚
    >     
    >     -   ä¸Šé¢çš„æ²¡åš cheesesInStock éç©ºåˆ¤æ–­ï¼Œåœ¨ ArrayList æ„é€ æ–¹æ³•ä¸­ä¼šåˆ¤æ–­ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆå§‹åŒ–å†…éƒ¨æ•°ç»„ä¸ºç©ºã€‚ä½†æ­¤æ—¶è¿”å›çš„ç©º ArrayList ä»æ˜¯å¯å˜å¯¹è±¡ï¼›
    >         
    >     -   ä¸‹é¢çš„ä»£ç åˆ¤æ–­ cheesesInStock ä¸ºç©ºåç›´æ¥è¿”å›äº†ä¸å¯å˜ç©ºé›†åˆã€‚
    >         
    > 2.  æ•°ç»„ã€‚
    >     
    >     -   ä¸Šé¢æ²¡åšéç©ºåˆ¤æ–­ï¼Œæ¯æ¬¡éƒ½ä¼ å…¥ä¸€ä¸ªæ–°çš„ç©ºæ•°ç»„ï¼Œåœ¨ toArray å†…éƒ¨å°†è¿™ä¸ªç©ºæ•°ç»„æ‰©å®¹è‡³åˆé€‚å¤§å°ï¼Œæˆ–è€…åŸæ ·è¿”å›ï¼›
    >         
    >     -   ä¸‹é¢æ¯æ¬¡éƒ½ä¼ å…¥åŒæ ·çš„ç©ºæ•°ç»„ã€‚
    >         
    >     -   æ³¨æ„ï¼Œç©ºæ•°ç»„æ°¸è¿œæ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸¤ç§æ–¹å¼éƒ½è¿”å›äº†ä¸å¯å˜ç©ºæ•°ç»„ã€‚
    >         
    

### æ€§èƒ½æå‡

å¦‚æœçœŸçš„è¯æ˜è¿”å›ç©ºé›†åˆæˆ–è€…æ•°ç»„é™ä½äº†ç¨‹åºæ€§èƒ½ï¼Œå¯ä»¥ç”¨ä¸‹é¢ä¸¤ç§åšæ³•æ¥ä¼˜åŒ–ï¼ˆåœ¨ä½¿ç”¨åè¦å†æ¬¡æµ‹é‡æ€§èƒ½ï¼Œä»¥ç¡®ä¿çœŸçš„èƒ½æå‡æ€§èƒ½ï¼‰ï¼š

-   å¯ä»¥é‡å¤è¿”å›åŒä¸€ä¸ªä¸å¯å˜çš„ç©ºé›†åˆï¼Œå› ä¸ºä¸å¯å˜å¯¹è±¡å¯ä»¥è¢«è‡ªç”±å…±äº«ï¼ˆè¯¦è§ç¬¬ 17 æ¡ï¼‰ã€‚å¸¸è§æ–¹æ³•æœ‰ï¼š`Collections.emptyList()`ã€`Collections.emptySet()`ã€`Collections.emptyMap()` ç­‰ï¼Œè¿™äº›æ–¹æ³•éƒ½è¿”å›äº†ä¸å¯å˜å¯¹è±¡ï¼Œåœ¨ç”¨æˆ·å°è¯•æ·»åŠ çš„å…ƒç´ çš„æ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚è‡ªå·±å®ç°çš„æ—¶å€™è¦æ³¨æ„ä¸å¯å˜æ€§ï¼Œå¦åˆ™é‡å¤è¿”å›çš„å¯¹è±¡å°†å¯èƒ½ä¸å†æ˜¯ç©ºé›†åˆã€‚
    
    // Optimization - avoids allocating empty collections  
    public List<Cheese> getCheeses() {  
        return cheesesInStock.isEmpty() ? Collections.emptyList()  
            : new ArrayList<>(cheesesInStock);  
    }
    
-   å¯ä»¥é‡å¤è¿”å›åŒä¸€ä¸ªé›¶é•¿åº¦çš„æ•°ç»„ï¼Œå› ä¸º**æ‰€æœ‰é›¶é•¿åº¦çš„æ•°ç»„éƒ½æ˜¯ä¸å¯å˜çš„**ï¼š
    
    // Optimization - avoids allocating empty arrays  
    private static final Cheese[] EMPTY_CHEESE_ARRAY = new Cheese[0];  
    public Cheese[] getCheeses() {  
        return cheesesInStock.toArray(EMPTY_CHEESE_ARRAY);  
    }
    
    å°†åŒä¸€ä¸ªé›¶é•¿åº¦çš„æ•°ç»„ä¼ è¿›äº†æ¯ä¸€æ¬¡çš„ `toArray` è°ƒç”¨ï¼Œæ¯å½“ cheesesInStock ä¸ºç©ºæ—¶ï¼Œå°±ä¼šä» getCheese è¿”å›è¿™ä¸ªæ•°ç»„ã€‚
    
    > çœ‹ä¸€ä¸‹ ArrayList çš„ toArray æºç ï¼š
    > 
    > public <T> T[] toArray(T[] a) {  
    >  if (a.length < size)  
    >      // Make a new array of a's runtime type, but my contents:  
    >      return (T[]) Arrays.copyOf(elementData, size, a.getClass());  
    >  System.arraycopy(elementData, 0, a, 0, size);  
    >  if (a.length > size)  
    >      a[size] = null;  
    >  return a;  
    > }
    > 
    > å¦‚æœ cheesesInStock ä¸ºç©ºæ—¶ï¼Œæœ€ç»ˆä¼šç›´æ¥è¿”å› aã€‚
    
    åƒä¸‡ä¸è¦æŒ‡æœ›é€šè¿‡é¢„å…ˆåˆ†é…ä¼ å…¥ toArray çš„æ•°ç»„ï¼ˆæŒ‡çš„æ˜¯åˆå§‹åŒ–æ•°ç»„çš„é•¿åº¦ï¼‰æ¥æå‡æ€§èƒ½ï¼Œè¿™æ ·åªä¼šé€‚å¾—å…¶åï¼š
    
    // Donâ€™t do this - preallocating the array harms performance!  
    return cheesesInStock.toArray(new Cheese[cheesesInStock.size()]);
    
    ### æ€»ç»“
    
    åœ¨å¯ä»¥è¿”å›ç©ºæ•°ç»„æˆ–é›†åˆçš„æ—¶å€™ï¼Œæ°¸è¿œä¸è¦è¿”å› nullã€‚
    

## 55. è°¨æ…è¿”å› optional

### ä»‹ç»

Java 8 ä¹‹å‰ï¼Œè¦ç¼–å†™ä¸€ä¸ªåœ¨ç‰¹å®šç¯å¢ƒä¸‹æ— æ³•è¿”å›ä»»ä½•å€¼çš„æ–¹æ³•æ—¶ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼šè¦ä¹ˆæŠ›å‡ºå¼‚å¸¸ï¼Œè¦ä¹ˆè¿”å› nullï¼ˆå‡è®¾è¿”å›ç±»å‹æ˜¯ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ç±»å‹ï¼‰ã€‚ä½†è¿™éƒ½ä¸æ˜¯å¥½åŠæ³•ã€‚å¼‚å¸¸åº”è¯¥ä¸ºå¼‚å¸¸æ¡ä»¶ä¿ç•™ï¼ˆè¯¦è§ç¬¬ 69 æ¡ï¼‰ï¼Œå¹¶ä¸”æŠ›å‡ºå¼‚å¸¸æ˜¯å¾ˆæ˜‚è´µçš„ï¼Œå› ä¸ºè¦æ•æ‰æ•´ä¸ª stack traceã€‚è¿”å› null æ²¡æœ‰è¿™äº›ç¼ºç‚¹ï¼Œä½†æ˜¯å®¢æˆ·ç«¯å¿…é¡»å¯¹å¯èƒ½çš„ null å€¼ä½œç‰¹æ®Šå¤„ç†ï¼Œå¦åˆ™å¯èƒ½ä¼šå¼•å‘ NPEã€‚

ä» Java 8 å¼€å§‹ï¼Œæœ‰äº†ä¸€ç§æ–°çš„æ–¹å¼æ¥ç¼–å†™å¯èƒ½ä¸ä¼šæœ‰è¿”å›å€¼çš„æ–¹æ³•ã€‚`Optional<T>` ç±»ä»£è¡¨äº†ä¸€ä¸ª immutable å®¹å™¨ï¼Œå®ƒå¯ä»¥å­˜æ”¾ä¸€ä¸ªé null çš„ T å¼•ç”¨æˆ–è€…ä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚ä¸åŒ…å«ä»»ä½•å†…å®¹çš„ optional è¢«ç§°ä¸º emptyï¼ŒåŒ…å«ä¸€ä¸ªå€¼ï¼ˆç§°ä¸º value is presentï¼‰çš„ optional è¢«ç§°ä¸º not emptyã€‚ä¸€ä¸ª optional æœ¬è´¨æ˜¯ä¸€ä¸ªæœ€å¤šä¿æŠ¤ä¸€ä¸ªå…ƒç´ çš„ immutable é›†åˆã€‚`Optional<T>` è™½ç„¶æ²¡æœ‰å®ç° `Collection<T>`ï¼Œä½†åŸåˆ™ä¸Šæ˜¯å¯ä»¥çš„ã€‚

å½“ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥è¿”å›ä¸€ä¸ª Tï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ä¸èƒ½è¿”å›ï¼Œè¿™æ—¶å€™å¯ä»¥ç”¨ `Optional<T>` æ¥ä½œä¸ºè¯¥æ–¹æ³•çš„è¿”å›å€¼ã€‚è¿™å¯ä»¥è®©æ–¹æ³•è¿”å›ä¸€ä¸ª empty result æ¥è¡¨æ˜å½“å‰ä¸èƒ½è¿”å›ä¸€ä¸ª valid resultã€‚è¿™ç§æ–¹å¼æ¯”æŠ›å¼‚å¸¸æ›´çµæ´»ä¸”ä½¿ç”¨ç®€å•ï¼Œæ¯”è¿”å› null æ›´ä¸å®¹æ˜“å‡ºé”™ã€‚

### ç”¨æ³•

åœ¨ç¬¬ 30 æ¡ä¸­ï¼Œæœ‰ä¸€ä¸ªè®¡ç®—é›†åˆä¸­æœ€å¤§å…ƒç´ çš„æ–¹æ³•ï¼š

// Returns maximum value in collection - throws exception if empty  
public static <E extends Comparable<E>> E max(Collection<E> c) {   
    if (c.isEmpty())  
        throw new IllegalArgumentException("Empty collection");  
    E result = null;  
    for (E e : c)  
        if (result == null || e.compareTo(result) > 0)  
            result = Objects.requireNonNull(e);  
    return result;  
  
}

å¯ä»¥ä¿®æ”¹ä¸ºï¼š

// Returns maximum value in collection as an Optional<E>  
public static <E extends Comparable<E>> Optional<E> max(Collection<E> c) {  
    if (c.isEmpty())  
        return Optional.empty();  
    E result = null;  
    for (E e : c)  
        if (result == null || e.compareTo(result) > 0)  
            result = Objects.requireNonNull(e);  
    return Optional.of(result);   
}

> ä¸è¦ä¼  null ç»™ Option.of(value)ï¼Œä¼šæŠ›å‡º NPEï¼Œå¯ä»¥ç”¨ Option.ofNullable(value)ã€‚

è®¸å¤š Stream çš„ç»ˆæ­¢æ“ä½œéƒ½è¿”å› optionalï¼Œå¯ä»¥å°† max æ–¹æ³•ç”¨ Stream é‡å†™ï¼š

// Returns max val in collection as Optional<E> - uses stream  
public static <E extends Comparable<E>> Optional<E> max(Collection<E> c) {  
    return c.stream().max(Comparator.naturalOrder());  
}

### ä½•æ—¶è¯¥ç”¨ optional ä»£æ›¿æŠ›å¼‚å¸¸æˆ–è¿”å› null

Optional æœ¬è´¨ä¸Šå’Œ checked exceptions ç±»ä¼¼ï¼Œå®ƒå¼ºè¿« API çš„ç”¨æˆ·è¦å»å¤„ç†å¯èƒ½æ²¡æœ‰è¿”å›å€¼çš„æƒ…å†µã€‚ä½†æ˜¯æŠ›å‡º unchecked exceptions æˆ–è¿”å› null å¯èƒ½ä¼šè®©ç”¨æˆ·å¿½ç•¥äº†è¿™ä¸ªå¯èƒ½å‘ç”Ÿçš„äº‹æƒ…ã€‚ä½†æ˜¯æŠ›å‡º checked exceptions ä¼šéœ€è¦é¢å¤–çš„æ ·æ¿ä»£ç ã€‚

å¦‚æœä½¿ç”¨äº† optionalï¼Œå®¢æˆ·ç«¯å¿…é¡»å»é€‰æ‹©å¦‚æœæ–¹æ³•æ²¡æœ‰è¿”å›å€¼çš„æ—¶å€™è¯¥æ€ä¹ˆåšã€‚

#### å¯ä»¥æŒ‡å®šé»˜è®¤å€¼

// Using an optional to provide a chosen default value   
String lastWordInLexicon = max(words).orElse("No words...");

#### å¯ä»¥æŠ›å‡ºå¼‚å¸¸

// Using an optional to throw a chosen exception  
Toy myToy = max(toys).orElseThrow(TemperTantrumException::new);

> æ³¨æ„è¿™é‡Œä¼ å…¥çš„æ˜¯ä¸€ä¸ª exception factory è€Œä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„ exceptionã€‚åªæœ‰å½“çœŸæ­£æŠ›å‡ºçš„æ—¶å€™æ‰åˆ›å»ºå¼‚å¸¸ï¼Œé¿å…äº†é¢å¤–çš„å¼€é”€ã€‚

#### å¯ä»¥ç›´æ¥è·å–å€¼

å¦‚æœå¯ä»¥è¯æ˜ optional éç©ºï¼Œå¯ä»¥ä¸æŒ‡å®šå½“ optional ä¸ºç©ºæ—¶çš„åšæ³•ï¼Œè€Œç›´æ¥ä» optional è·å–å€¼ã€‚ä½†æ˜¯å¦‚æœ optional çœŸçš„ä¸ºç©ºçš„æ—¶å€™ï¼Œä¼šæŠ›å‡º `NoSuchElementException`ï¼š

// Using optional when you know thereâ€™s a return value   
Element lastNobleGas = max(Elements.NOBLE_GASES).get();

### ä¸€äº›æ–¹æ³•çš„ä½¿ç”¨

#### orElse å’Œ orElseGet

å¦‚æœè§‰å¾—é€šè¿‡ `orElse` æ–¹å¼è·å–é»˜è®¤å€¼å¼€é”€å¤§ï¼Œå¯ä»¥ä½¿ç”¨ `orElseGet(Supplier<? extends T>)` æ–¹æ³•ã€‚ä½†è¿™ä¸ªæ–¹æ³•ä¼¼ä¹åº”è¯¥å«åš orElseComputeï¼Œå› ä¸ºå¾ˆæ¥è¿‘ Map ä¸­ä»¥ compute å¼€å¤´çš„ä¸‰ä¸ªæ–¹æ³•ã€‚

> public T orElse(T other) {  
>  return value != null ? value : other;  
> }  
>   
> public T orElseGet(Supplier<? extends T> other) {  
>  return value != null ? value : other.get();  
> }
> 
> `orElse` å’Œ `orElseGet` æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼Œå‰è€…ç«‹å³è®¡ç®—ï¼Œåè€…æ˜¯å»¶è¿Ÿè®¡ç®—ã€‚æ‰€ä»¥å¦‚æœå¤‡é€‰å€¼æ˜¯æ— éœ€è®¡ç®—çš„ã€ç°åœ¨å·²æœ‰çš„ï¼Œé‚£å°±ç”¨ `orElse`ã€‚å¦‚æœå€¼è¿˜æ²¡å¾—åˆ°ï¼Œé‚£æœ€å¥½ç”¨`orElseGet` å»¶è¿Ÿæ‰§è¡Œã€‚ä¸€èˆ¬æœ€å¤šçš„æƒ…å†µæ˜¯ç±»ä¼¼å­—ç¬¦ä¸²æ‹¼è£…ã€åˆ›å»ºæ–°å¯¹è±¡è¿™æ ·çš„ï¼Œéƒ½åº”è¯¥ç”¨ `orElseGet`ã€‚å‡è®¾é»˜è®¤å€¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ‹¼æ¥ï¼Œæ¯æ¬¡è°ƒç”¨ `orElse` éƒ½ä¼šæå‰è®¡ç®—æ‹¼æ¥åçš„ç»“æœå†å»åˆ¤æ–­ optional æ˜¯å¦ä¸º emptyã€‚è€Œ `orElseGet` ä¼šå…ˆåˆ¤æ–­ optional æ˜¯å¦ä¸º emptyï¼Œå¦‚æœæ˜¯ï¼Œå†å»æ‹¼æ¥å­—ç¬¦ä¸²ã€‚

#### å…¶ä»–æ–¹æ³•

Optional è¿˜æœ‰ä¸€äº›æ–¹æ³•å¯ä»¥å¤„ç†æ›´ç‰¹æ®Šçš„åœºæ™¯ï¼š`filter`ã€`map`ã€`flatMap`ã€`ifPresent`ï¼Œä»¥åŠ Java 9 æ–°å¢çš„ `or` å’Œ `ifPresentOrElse`ã€‚ä½†è¦æ³¨æ„ä½¿ç”¨ `ifPresent` çš„æ–¹æ³•ï¼Œè®¸å¤šç”¨ä½¿ç”¨å®ƒçš„ä»£ç éƒ½å¯ä»¥è¢«å…¶ä»–æ–¹æ³•ä»£æ›¿ï¼Œå¹¶ä¸”æ•ˆç‡æ›´é«˜ä¸”ä»£ç æ›´çŸ­ä¸”æ¸…æ™°ã€‚

ä¸‹é¢è¿™æ®µä»£ç æ‰“å°å‡ºäº†ä¸€ä¸ªè¿›ç¨‹çš„çˆ¶è¿›ç¨‹ PIDï¼Œå¦‚æœæ²¡è¿›ç¨‹åˆ™æ‰“å°å‡º N/Aã€‚ä»£ç ä½¿ç”¨çš„ ProcessHandle ç±»æ˜¯ Java 9 ä¸­å¼•è¿›çš„ã€‚

Optional<ProcessHandle> parentProcess = ph.parent();   
System.out.println("Parent PID: " + (parentProcess.isPresent() ?  
		String.valueOf(parentProcess.get().pid()) : "N/A"));

è¿™æ®µä»£ç å¯ä»¥ä½¿ç”¨ map æ¥æ”¹å†™ï¼š

System.out.println("Parent PID: " +  
		ph.parent().map(h -> String.valueOf(h.pid())).orElse("N/A"));

åœ¨ `Stream<Options<T>` å–å‡ºæ‰€æœ‰ nonempty optionals ä¸­çš„å…ƒç´ æ¥ç»„æˆ `Stream<T>`ï¼Œåœ¨ Java 8 ä¸­å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼ï¼š

streamOfOptionals  
    .filter(Optional::isPresent)  
    .map(Optional::get)

Java 9 ä¸­ Optional æœ‰äº†ä¸€ä¸ª `stream()` æ–¹æ³•ï¼Œæ¥å°† Optional è½¬æˆä¸€ä¸ª Streamï¼Œå¦‚æœ Optional not emptyï¼Œé‚£ä¹ˆ Stream åŒ…å«ä¸€ä¸ªå…ƒç´ ï¼Œå¦åˆ™ä¸ºç©ºã€‚é…åˆ Stream çš„ flatMap æ–¹æ³•ï¼Œå¯ä»¥å°†ä¸Šé¢ä»£ç æ”¹å†™ä¸ºï¼š

streamOfOptionals.  
    .flatMap(Optional::stream)

### ä¸é€‚åˆä½¿ç”¨ Optional çš„è¿”å›å€¼

optionals ä¸åº”è¯¥å°†å®¹å™¨ç±»å‹å¦‚ collectionsã€mapsã€streamsã€arrays å’Œ optionals ç­‰ wrapper èµ·æ¥ã€‚æ¯”èµ·è¿”å›ä¸€ä¸ª empty `Optional<List<T>>` ï¼Œå¯ä»¥ç®€å•è¿”å›ä¸€ä¸ª empty `List<T>` ï¼ˆè¯¦è§ç¬¬ 54 æ¡ï¼‰ã€‚ç›´æ¥è¿”å›ç©ºå®¹å™¨ä¼šè®©å®¢æˆ·ç«¯å…äºå¤šå¤„ç†ä¸€ä¸ª optionalã€‚

> `ProcessHandle` ç±»æœ‰ä¸€ä¸ªè¿”å› `Optional<Stirng[]>` çš„æ–¹æ³•ï¼Œè¿™æ˜¯ä¸åº”è¯¥çš„ã€‚

### ä½•æ—¶è¿”å› Optional<T> è€Œä¸æ˜¯ T

ä¸€ä¸ªå‡†åˆ™ï¼šå¦‚æœå¯èƒ½æ— æ³•è¿”å›ç»“æœå¹¶ä¸”å½“æ²¡æœ‰è¿”å›ç»“æœæ—¶å®¢æˆ·ç«¯å¿…é¡»æ‰§è¡Œç‰¹æ®Šçš„å¤„ç†ï¼Œé‚£ä¹ˆå°±åº”è¯¥å£°æ˜è¯¥æ–¹æ³•è¿”å› Optional<T>ã€‚

è¿”å› Optional<T> çš„æ—¶å€™éœ€è¦é¢å¤–çš„æˆæœ¬ï¼Œå› ä¸º Optional æ˜¯ä¸€ä¸ªå¿…é¡»åˆ†é…å’Œåˆå§‹åŒ–çš„å¯¹è±¡ï¼Œå¹¶ä¸”ä» Optional ä¸­è¯»å–å€¼éœ€è¦é¢å¤–çš„å¼€é”€ã€‚è¿™å°±å¯¼è‡´äº† Optional ä¸é€‚åˆæ³¨é‡æ€§èƒ½çš„åœºåˆï¼ˆç¡®å®šä½¿ç”¨ Optional çš„æ–¹æ³•æ˜¯å¦å½±å“æ€§èƒ½ï¼Œå¿…é¡»ç»è¿‡æµ‹è¯•ï¼‰ã€‚

### ä¸è¦ä½¿ç”¨åŒ…è£…è£…ç®±ç±»å‹çš„ Optional<T>

è¿™æ ·æ¯”ç›´æ¥è¿”å› primitive ç±»å‹å¼€é”€å¤§çš„å¤šï¼Œå› ä¸ºè¿™æ ·çš„è¯ Optional ä¼šæœ‰ä¸¤å±‚åŒ…è£…ã€‚å› æ­¤ï¼Œåº”è¯¥ä½¿ç”¨ä¸“é—¨ä¸º primitive è®¾è®¡çš„ `OptionalInt`ã€`OptionalLong` å’Œ `OptionalDouble`ï¼Œå®ƒä»¬åŒ…å«äº† Optional<T> ä¸­çš„å¤§éƒ¨åˆ†æ–¹æ³•ã€‚

> å°çš„åŸºæœ¬ç±»å‹å¯ä»¥ä½¿ç”¨ Optional<T> ï¼Œæ¯”å¦‚ Booleanã€Byteã€Characterã€Short å’Œ Floatã€‚

### Optional ä¸åº”è¯¥ä½œä¸º keyã€value å’Œé›†åˆæˆ–æ•°ç»„é‡Œçš„å…ƒç´ 

ä¾‹å¦‚å°† Optional ä½œä¸º map çš„ valueï¼Œé‚£ä¹ˆå°±æœ‰ä¸¤ç§æ–¹å¼æ¥è¡¨è¾¾ä¸€ä¸ª key çš„ logic absenceï¼š

1.  key ä¸å­˜åœ¨ map ä¸­ï¼›
    
2.  key å­˜åœ¨ map ä¸­ï¼Œä½†æ˜ å°„çš„ value æ˜¯ä¸€ä¸ª empty optionalã€‚
    

### è°¨æ…é€‰æ‹© Optioanl ä½œä¸ºå®ä¾‹åŸŸ

æœ‰æ—¶å€™ä½¿ç”¨åŒ…å« Optional åŸŸçš„å­ç±»æ˜¯åˆç†çš„ã€‚ï¼ˆè¿™ä¸ªã€Œå­ç±»ã€æ˜¯ä»€ä¹ˆæ„æ€ï¼‰

ç¬¬ 2 æ¡ç¬¬ NutirionFacts ç±»åŒ…å«äº†è®¸å¤šä¸æ˜¯å¿…é¡»éœ€è¦çš„åŸŸï¼š

1.  ä¸å¯èƒ½ç»™æ¯ç§åŸŸçš„ç»„åˆéƒ½æä¾›ä¸€ä¸ªå­ç±»ï¼›
    
2.  æœ‰ primitive åŸŸï¼Œå¦‚æœä¸ç”¨ä¸Šé¢çš„åŠæ³•ï¼Œä¹Ÿä¸æ–¹ä¾¿è¡¨è¾¾è¿™äº›åŸŸçš„ç¼ºå¤±
    

æ‰€ä»¥ NutritionFacts çš„ getter åº”è¯¥ä¸ºæ¯ä¸ªå¯é€‰çš„åŸŸè¿”å›ä¸€ä¸ª Optionalï¼Œå› æ­¤å¯ä»¥ç›´æ¥å°†è¿™äº› Optioanl ä½œä¸ºåŸŸä¿å­˜åœ¨å¯¹è±¡ä¸­ï¼ˆä»£æ›¿ä»¥å‰çš„å¯é€‰åŸŸï¼‰ã€‚

### æ€»ç»“

1.  å¦‚æœæ–¹æ³•æœ‰æ—¶å¯èƒ½æ²¡æœ‰è¿”å›å€¼ï¼Œå¹¶ä¸”éœ€è¦ä½¿ç”¨è€…æ¥è€ƒè™‘æ²¡æœ‰è¿”å›å€¼çš„æƒ…å†µï¼Œé‚£ä¹ˆå°±åº”è¯¥è€ƒè™‘è¿”å›ä¸€ä¸ª Optionalï¼›
    
2.  è¿”å› Optioanl ç¡®å®ä¼šå½±å“æ€§èƒ½ï¼Œå¦‚æœçœŸçš„å¾ˆä¸¥é‡ï¼Œå¯èƒ½è¿”å› null æˆ–æŠ›å‡ºå¼‚å¸¸æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼›
    
3.  ä¸è¦å°† Optional ç”¨ä½œè¿”å›å€¼ä»¥å¤–çš„ç”¨é€”ï¼ˆä½œä¸ºå®ä¾‹åŸŸä¹Ÿæ˜¯ä¸ºäº†ç®€åŒ–åœ¨éœ€è¦çš„ getter æ–¹æ³•ä¸­åˆ›å»º Optionalï¼‰ã€‚
    

## 56. ä¸ºæ‰€æœ‰å¯¼å‡ºçš„ API å…ƒç´ ç¼–å†™æ–‡æ¡£æ³¨é‡Š

Javadoc çš„å…·ä½“ç”¨æ³•åœ¨ _How to Write Doc Comments_ web page [Javadoc- guide]ï¼Œè™½ç„¶ Java 4 ä¹‹åå°±å†ä¹Ÿæ²¡æœ‰æ›´æ–°è¿‡äº†ï¼Œä½†ä¾ç„¶å¾ˆæœ‰ä»·å€¼ã€‚Java 5 æ·»åŠ äº† {@literal} å’Œ {@code}ï¼›Java 8 æ·»åŠ äº† {@implSepc}ï¼›Java 9 æ·»åŠ äº† {@index}ã€‚

ä¸ºäº†æ­£ç¡®ç¼–å†™ API æ–‡æ¡£ï¼Œåº”è¯¥åœ¨æ¯ä¸ªè¢«å¯¼å‡ºçš„ç±»ã€æ¥å£ã€æ„é€ å™¨ã€æ–¹æ³•å’ŒåŸŸçš„å£°æ˜ä¹‹å‰å¢åŠ æ–‡æ¡£æ³¨é‡Šã€‚å¦‚æœç±»æ˜¯ serializableï¼Œåº”è¯¥æ³¨é‡Šå®ƒçš„åºåˆ—åŒ–å½¢å¼ã€‚ä¸ºäº†ä»£ç å¯ç»´æŠ¤ï¼Œè¿˜åº”è¯¥ä¸ºä¸€äº›æ²¡è¢«å¯¼å‡ºçš„ç±»ã€æ¥å£ã€æ„é€ å™¨ã€æ–¹æ³•å’Œä¸åŸŸåç¼–å†™æ–‡æ¡£æ³¨é‡Šã€‚

æ–¹æ³•çš„æ–‡æ¡£æ³¨é‡Šåº”è¯¥ç®€æ´åœ°æè¿°å‡ºå®ƒå’Œå®¢æˆ·ç«¯ä¹‹é—´çš„çº¦å®šã€‚é™¤äº†ä¸“é—¨ä¸ºç»§æ‰¿è®¾è®¡çš„æ–¹æ³•å¤–ï¼ˆè¯¦è§ç¬¬ 19 æ¡ï¼‰ï¼Œè¿™ä¸ªçº¦å®šåº”è¯¥è¯´æ˜è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆï¼Œè€Œä¸æ˜¯æ€æ ·åšã€‚æ–‡æ¡£æ³¨é‡Šåº”è¯¥åˆ—ä¸¾å‡ºæ–¹æ³•æ‰€æœ‰çš„ preconditionsï¼ˆè°ƒç”¨æ–¹æ³•å‰å¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼‰å’Œ postconditionsï¼ˆæˆåŠŸè°ƒç”¨æ–¹æ³•åå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œpreconditions æ˜¯ç”±é’ˆå¯¹ unchecked exception çš„ `@throws` æ ‡ç­¾æ¥éšå¼æè¿°çš„ï¼Œæ¯ä¸ª unchecked exception å¯¹åº”ä¸€ä¸ª precondition violationï¼ˆè¿åå‰ç½®æ¡ä»¶ï¼‰ã€‚ä¹Ÿå¯ä»¥åœ¨ä¸€äº›å—å½±å“çš„å‚æ•°çš„ `@param` æ ‡ç­¾ä¸ŠæŒ‡å®š preconditionsã€‚

é™¤äº† precondition å’Œ postcondition å¤–ï¼Œè¿˜åº”è¯¥æ³¨æ˜æ–¹æ³•çš„å‰¯ä½œç”¨ï¼ˆside effectï¼‰ã€‚è¿™ä¸ªå‰¯ä½œç”¨æ˜¯æŒ‡ç³»ç»ŸçŠ¶æ€ä¸­å¯è§‚æµ‹åˆ°çš„å˜åŒ–ï¼Œä½†è¿™ä¸ªå˜åŒ–ä¸æ˜¯ä¸ºäº†å®ç° postcondition è€Œæ˜ç¡®è¦æ±‚çš„ã€‚æ¯”å¦‚ï¼Œå¦‚æœæ–¹æ³•å¯åŠ¨äº†åå°çº¿ç¨‹ï¼Œï¼Œæ–‡æ¡£æ³¨é‡Šä¸­å°±åº”è¯¥è¯´æ˜è¿™ä¸€ç‚¹ã€‚

ä¸ºäº†å®Œæ•´æè¿°æ–¹æ³•çš„çº¦å®šï¼Œåº”è¯¥åœ¨æ–‡æ¡£æ³¨é‡Šä¸Šä¸ºæ¯ä¸ªå‚æ•°æ·»åŠ ä¸€ä¸ª `@param` æ ‡ç­¾ã€ä¸ºé void æ–¹æ³•æ·»åŠ ä¸€ä¸ª `@return` æ ‡ç­¾ã€ä¸ºæ–¹æ³•æŠ›å‡ºçš„æ¯ä¸€ä¸ª checked or unchecked exception æ·»åŠ ä¸€ä¸ª `@throws` æ ‡ç­¾ã€‚å¦‚æœ `@return` æ ‡ç­¾ä¸­çš„æè¿°å’Œæ–¹æ³•æè¿°å®Œå…¨ç›¸åŒï¼Œé‚£ä¹ˆå°±å¯ä»¥çœç•¥å®ƒï¼ˆTODOï¼šè¿™ä¸ªå®ƒæŒ‡æ–¹æ³•æè¿°è¿˜æ˜¯ `@return`ï¼Ÿï¼‰ã€‚

æŒ‰ç…§æƒ¯ä¾‹ï¼Œ`@param` å’Œ `@return` æ ‡ç­¾åçš„æ–‡å­—åº”è¯¥æ˜¯ä¸€ä¸ªåè¯çŸ­è¯­ï¼Œç”¨æ¥æè¿°å‚æ•°å’Œè¿”å›å€¼æ‰€ä»£è¡¨çš„å€¼ã€‚åœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼Œä¹Ÿä¼šç”¨ç®—æœ¯è¡¨è¾¾å¼æ¥ä»£æ›¿è¿™ä¸ªåè¯çŸ­è¯­ï¼Œå¦‚ `BigInteger`ã€‚`@throws` æ ‡ç­¾åçš„æ–‡å­—åº”è¯¥ä»¥ â€œifâ€ å¼€å¤´çš„å¥å­ï¼Œæ¥æè¿°åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æŒ‰ç…§æƒ¯ä¾‹ï¼Œ`@param`ã€`@return` å’Œ `@throws` æ ‡ç­¾åé¢çš„åè¯çŸ­è¯­æˆ–å­å¥éƒ½ä¸éœ€è¦ä»¥å¥å·ç»“å°¾ã€‚ä¸‹é¢æœ‰ä¸ªä¾‹å­ï¼š

/**  
* Returns the element at the specified position in this list.   
*  
* <p>This method is <i>not</i> guaranteed to run in constant  
* time. In some implementations it may run in time proportional   
* to the element position.  
*  
* @param index index of element to return; must be  
* 		 non-negative and less than the size of this list  
* @return the element at the specified position in this list  
* @throws IndexOutOfBoundsException if the index is out of range  
*		  ({@code index < 0 || index >= this.size()})  
*/  
E get(int index);

TODOï¼šè¿™ç« çœ‹çš„æ²¡æ„æ€ã€‚ã€‚

# å…«. é€šç”¨ç¼–ç¨‹

## 57. æœ€å°åŒ–å±€éƒ¨å˜é‡ä½œç”¨åŸŸ

æœ€å°åŒ–å±€éƒ¨å˜é‡ä½œç”¨åŸŸå¯ä»¥æå‡ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œå¹¶ä¸”å‡å°‘äº†å‡ºé”™çš„æ¦‚ç‡ã€‚

**æœ€å¥½çš„åŠæ³•å°±æ˜¯åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨å±€éƒ¨å˜é‡ä¹‹å‰å£°æ˜å®ƒ**ï¼Œå¦‚æœæå‰å£°æ˜å¾ˆå¯èƒ½ä¼šä½¿è¯»è€…åˆ†å¿ƒï¼Œå¹¶ä¸”ç­‰åˆ°çœŸæ­£ç”¨åˆ°çš„æ—¶å€™ï¼Œè¯»è€…å¯èƒ½ä»¥åŠå¿˜äº†è¿™ä¸ªå˜é‡çš„ç±»å‹å’Œåˆå§‹å€¼ã€‚

å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸä»å£°æ˜å¼€å§‹ï¼Œæ‹“å±•åˆ°åŒ…å›´å®ƒçš„ä»£ç å—ç»“æŸã€‚è¿‡æ—©å£°æ˜å±€éƒ¨å˜é‡ï¼Œä¼šä½¿å¾—å®ƒçš„ä½œç”¨åŸŸæ—©å¼€å§‹ä¸”æ™šç»“æŸã€‚å¦‚æœå±€éƒ¨å˜é‡åœ¨å®ƒè¢«ä½¿ç”¨åˆ°çš„ä»£ç å—ä¹‹å¤–å£°æ˜ï¼Œé‚£ä¹ˆç¨‹åºé€€å‡ºè¿™ä¸ªä»£ç å—åï¼Œå®ƒä»ç„¶æ˜¯å¯è§çš„ã€‚è¿™æ ·å°±å¯èƒ½å¯¼è‡´è¿™ä¸ªå˜é‡åœ¨ç›®æ ‡ä½œç”¨åŒºåŸŸä¹‹å¤–è¢«ä¸å°å¿ƒä½¿ç”¨ï¼Œä»è€Œå¸¦æ¥ä¸å¥½çš„åæœã€‚

### try-catch

å‡ ä¹æ¯ä¸ªå±€éƒ¨å˜é‡çš„å£°æ˜éƒ½éœ€è¦åˆå§‹åŒ–ï¼Œå¦‚æœè¿˜ä¸èƒ½è¿›è¡Œæœ‰æ„ä¹‰åœ°åˆå§‹åŒ–ï¼Œå°±åº”è¯¥æ¨è¿Ÿå£°æ˜ã€‚try-catch æ˜¯ä¸€ä¸ªä¾‹å¤–ã€‚å¦‚æœä¸€ä¸ªå˜é‡é€šè¿‡ä¸€ä¸ªå¯èƒ½æŠ›å‡º checked exception çš„è¡¨è¾¾å¼æˆ–æ–¹æ³•åˆå§‹åŒ–ï¼Œé‚£ä¹ˆè¿™ä¸ªå˜é‡å°±å¿…é¡»åœ¨ try å—é‡Œåˆå§‹åŒ–ï¼ˆé™¤éå½“å‰çš„æ–¹æ³•å¯ä»¥ propagete è¿™ä¸ª exceptionï¼‰ã€‚å¦‚æœè¿™ä¸ªå˜é‡éœ€è¦åœ¨ try å—å¤–è¢«ä½¿ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±è¦åœ¨ try å—å‰å£°æ˜ï¼Œè™½ç„¶æ­¤æ—¶å®ƒå¯èƒ½è¿˜ä¸èƒ½è¢«æœ‰æ„ä¹‰åœ°åˆå§‹åŒ–ï¼ˆå¯ä»¥å‚ç…§ 283 é¡µç¬¬ 65 æ¡çš„ä¾‹å­ï¼‰ã€‚

### loop variable

å¾ªç¯æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„æ–¹å¼æ¥æœ€å°åŒ–å˜é‡ä½œç”¨åŸŸã€‚ä¼ ç»Ÿ for å¾ªç¯å’Œ for-each éƒ½å…è®¸å£°æ˜ loop variablesï¼Œè¿™æ ·å®ƒä»¬çš„ä½œç”¨åŸŸå°±è¢«é™åˆ¶åœ¨ for å¾ªç¯é‡Œã€‚**å› æ­¤ï¼Œå¦‚æœå˜é‡åªç”¨åœ¨å¾ªç¯é‡Œï¼Œé‚£ä¹ˆ for å°±ä¼˜äº whileã€‚**

éå†é›†åˆæˆ–æ•°ç»„çš„é¦–é€‰æ–¹å¼ï¼š

// Preferred idiom for iterating over a collection or array  
for (Element e : c) {  
    ... // Do Something with e  
}

å¦‚æœéœ€è¦ç”¨åˆ° iteratorï¼Œæ¯”å¦‚éœ€è¦è°ƒç”¨å®ƒçš„ `remove` æ–¹æ³•ï¼Œå°±å¯ä»¥ä½¿ç”¨ä¼ ç»Ÿ for å¾ªç¯ä»£æ›¿ for-each å¾ªç¯ï¼š

// Idiom for iterating when you need the iterator  
for (Iterator<Element> i = c.iterator(); i.hasNext(); ) {  
    Element e = i.next();  
    ... // Do something with e and i  
}

ä¸‹é¢è¿™æ®µä»£ç å¯ä»¥è¯æ˜åœ¨ä¸Šé¢çš„æƒ…å†µä¸‹ï¼Œfor æ¯” while æ›´å¥½ï¼š

Iterator<Element> i = c.iterator();  
while (i.hasNext()) {  
    doSomething(i.next());  
}  
...  
Iterator<Element> i2 = c2.iterator(); while (i.hasNext()) { // BUG!  
    doSomethingElse(i2.next());  
}

ç¬¬ä¸€ä¸ªè¿­ä»£å™¨ i åœ¨ä½¿ç”¨å®Œåè¿˜æ˜¯ visiableï¼Œæ‰€ä»¥å¯èƒ½ä¼šçŠ¯è¿™ç§é”™è¯¯ã€‚è¿™ç§é”™è¯¯èƒ½é€šè¿‡ç¼–è¯‘ï¼Œå¹¶ä¸”åœ¨è¿è¡Œæ—¶ä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚for å¾ªç¯ä¸ä¼šæœ‰è¿™ç§é”™è¯¯ï¼Œå¹¶ä¸”åœ¨ä¸åŒçš„ for å¾ªç¯ä¸­è¿˜å¯ä»¥é‡ç”¨ loop variables çš„åå­—ã€‚for å¾ªç¯çš„å¦ä¸€ä¸ªä¼˜åŠ¿å°±æ˜¯ä»£ç æ›´çŸ­æ›´å¯è¯»ã€‚

ä¸‹é¢æ˜¯å¦ä¸€ç§æœ€å°åŒ– loop variables çš„æ–¹å¼ï¼š

for (int i = 0, n = expensiveComputation(); i < n; i++) {  
    ... // Do something with i;  
}

è¿™ä¸ª for å¾ªç¯æœ‰ä¸¤ä¸ª loop variableï¼Œn å­˜å‚¨äº† i çš„é™åˆ¶ï¼Œå¯ä»¥é¿å…æ¯æ¬¡è¿­ä»£çš„é‡å¤è®¡ç®—ã€‚é€šå¸¸ï¼Œå¦‚æœå¾ªç¯æµ‹è¯•ä¸­æ¶‰åŠæ–¹æ³•è°ƒç”¨ï¼Œå¹¶ä¸”å¯ä»¥ä¿è¯åœ¨æ¯æ¬¡è¿­ä»£ä¸­éƒ½ä¼šè¿”å›åŒæ ·çš„ç»“æœï¼Œå°±åº”è¯¥ä½¿ç”¨è¿™ç§åšæ³•ã€‚

### è®©æ–¹æ³•å°è€Œé›†ä¸­

æœ€åä¸€ç§æœ€å°åŒ–å±€éƒ¨å˜é‡ä½œç”¨åŸŸçš„æ–¹æ³•å°±æ˜¯è®©**æ–¹æ³•å°è€Œé›†ä¸­**ã€‚ å¦‚æœæŠŠä¸¤ä¸ªæ“ä½œï¼ˆactivityï¼‰åˆå¹¶åˆ°åŒä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œä¸å…¶ä¸­ ä¸€ä¸ªæ“ä½œç›¸å…³çš„å±€éƒ¨å˜é‡å°±æœ‰å¯èƒ½ä¼šå‡ºç°åœ¨æ‰§è¡Œå¦ä¸€ä¸ªæ“ä½œçš„ä»£ç èŒƒå›´ä¹‹å†…ã€‚ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œåªéœ€å°†è¿™ä¸ªæ–¹æ³•åˆ†æˆä¸¤ä¸ªï¼Œæ¯ä¸ªæ“ä½œç”¨ä¸€ä¸ªæ–¹æ³•æ¥å®Œæˆã€‚

## 58. for-each ä¼˜äºä¼ ç»Ÿ for

### å•å±‚è¿­ä»£

#### ä¼ ç»Ÿ for

// Not the best way to iterate over a collection!  
for (Iterator<Element> i = c.iterator(); i.hasNext(); ) {  
    Element e = i.next();  
    ... // Do something with e  
}  
  
// Not the best way to iterate over an array!  
for (int i = 0; i < a.length; i++) {  
    ... // Do something with a[i]  
}  

è¿™ä¸¤ä¸ªä¼ ç»Ÿ for å¾ªç¯è™½ç„¶ä¼˜äº while å¾ªç¯ï¼ˆè¯¦è§ç¬¬ 57 æ¡ï¼‰ï¼Œä½†æ˜¯ä¸å¤Ÿå®Œç¾ã€‚è¿™ä¸¤ä¸ª for å¾ªç¯ä¸­çš„è¿­ä»£å™¨å’Œç´¢å¼•å˜é‡éƒ½æ˜¯æ²¡ç”¨çš„ï¼ˆclutterï¼‰ï¼Œæˆ‘ä»¬éœ€è¦çš„åªæ˜¯é›†åˆæˆ–æ•°ç»„ä¸­çš„å…ƒç´ ã€‚ç¬¬ä¸€ä¸ªå¾ªç¯ä¸­è¿­ä»£å™¨å‡ºç°äº†ä¸‰æ¬¡ï¼Œç¬¬äºŒå¾ªç¯ä¸­ç´¢å¼•å‡ºç°äº†å››æ¬¡ï¼Œå¸å¼•äº†ä¸å¿…è¦çš„æ³¨æ„ä¸”å®¹æ˜“å‘ç”Ÿé”™è¯¯ï¼Œè€Œç¼–è¯‘æœŸé—´ä¸ä¸€å®šèƒ½æ•æ‰åˆ°è¿™ä¸ªé”™è¯¯ã€‚

#### for-each

for-each é€šè¿‡éšè—è¿­ä»£å™¨æˆ–ç´¢å¼•å˜é‡æ¥è§£å†³ä¼ ç»Ÿ for å¾ªç¯å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼Œå®ƒä¹Ÿè¢«ç§°ä½œ ehanced for statementã€‚

// The preferred idiom for iterating over collections and arrays  
for (Element e : elements) {  
    ... // Do something with e  
}

":" çš„æ„æ€æ˜¯ â€inâ€œã€‚ä½¿ç”¨ for-each å®Œå…¨ä¸ä¼šå½±å“æ€§èƒ½ï¼ŒJVM ä¸º for-each ç”Ÿæˆçš„ä»£ç å’Œæ‰‹å†™çš„ä¸€æ¨¡ä¸€æ ·ã€‚

### åµŒå¥—è¿­ä»£

#### ä¼ ç»Ÿ for

ä¸‹é¢å°±æ˜¯ä½¿ç”¨ for å¾ªç¯çš„ä¸€ä¸ªå¸¸è§é”™è¯¯ï¼š

// Can you spot the bug?  
enum Suit { CLUB, DIAMOND, HEART, SPADE }  
enum Rank { ACE, DEUCE, THREE, FOUR, FIVE, SIX, SEVEN, EIGHT,  
           NINE, TEN, JACK, QUEEN, KING }  
...  
static Collection<Suit> suits = Arrays.asList(Suit.values());  
static Collection<Rank> ranks = Arrays.asList(Rank.values());  
List<Card> deck = new ArrayList<>();  
for (Iterator<Suit> i = suits.iterator(); i.hasNext(); )  
    for (Iterator<Rank> j = ranks.iterator(); j.hasNext(); )  
        deck.add(new Card(i.next(), j.next()));

é”™è¯¯åœ¨äºå¤–å±‚å¾ªç¯è¿­ä»£å™¨çš„ next æ–¹æ³•ä¼šåœ¨å†…å±‚å¾ªç¯è°ƒç”¨å¾ˆå¤šæ¬¡ï¼Œå®ƒåº”è¯¥åœ¨å¤–å±‚å¾ªç¯ä¸­è°ƒç”¨ã€‚å¦‚æœ suits çš„å¤§å°å¤§äºç­‰äºï¼Œæˆ–è€…å†…å¤–å±‚éƒ½æ˜¯åŒä¸€ä¸ªé›†åˆï¼Œè¿™æ ·ç¨‹åºå°±ä¼šæ­£å¸¸ç»“æŸï¼ˆä½†è¿™ä»ç„¶æ˜¯é”™è¯¯çš„ï¼‰ï¼Œå¦åˆ™å°±å¿…ç„¶ä¼šæŠ›å‡º `NoSuchElementException`ã€‚æ¯”å¦‚ï¼š

// Same bug, different symptom!  
enum Face { ONE, TWO, THREE, FOUR, FIVE, SIX }  
...  
Collection<Face> faces = EnumSet.allOf(Face.class);  
for (Iterator<Face> i = faces.iterator(); i.hasNext(); )  
    for (Iterator<Face> j = faces.iterator(); j.hasNext(); )  
        System.out.println(i.next() + " " + j.next());

è¿™æ®µä»£ç ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯ä¼šè¾“å‡ºï¼š

ONE ONE  
TWO TWO  
THREE THREE  
FOUR FOUR  
FIVE FIVE  
SIX SIX

ä¸ºäº†ä¿®å¤è¿™ä¸ª bugï¼Œå¿…é¡»è¦åœ¨å¤–å±‚å¾ªç¯ä¸­ä¿å­˜ä¸€ä¸ªå¤–éƒ¨å…ƒç´ ï¼Œä½†è¿™æ ·å¾ˆä¸ç¾è§‚ï¼š

// Fixed, but ugly - you can do better!  
for (Iterator<Suit> i = suits.iterator(); i.hasNext(); ) {  
    Suit suit = i.next();  
    for (Iterator<Rank> j = ranks.iterator(); j.hasNext(); )  
        deck.add(new Card(suit, j.next()));  
}

#### for-each

for-each å¾ªç¯åœ¨åµŒå¥—è¿­ä»£çš„æ—¶å€™ä¼˜åŠ¿å°¤å…¶æ˜¾è‘—ã€‚

å¦‚æœä½¿ç”¨ for-each å¾ªç¯ï¼Œé‚£ä¹ˆè¿™ä¸ªé—®é¢˜è‡ªç„¶å°±æ¶ˆå¤±äº†ï¼š

// Preferred idiom for nested iteration on collections and arrays  
for (Suit suit : suits)  
    for (Rank rank : ranks)  
        deck.add(new Card(suit, rank));

### for-each ä¸èƒ½ä½¿ç”¨çš„æƒ…å†µ

#### Filtering

å¦‚æœéœ€è¦éå†**é›†åˆ**å¹¶ä¸”åˆ é™¤æŸäº›å…ƒç´ ï¼Œé‚£ä¹ˆå°±å¾—ä½¿ç”¨æ˜¾å¼çš„è¿­ä»£å™¨ï¼Œå¹¶ä¸”ä½¿ç”¨å®ƒçš„ `remove` æ–¹æ³•ã€‚

åŒæ ·ï¼Œå¯ä»¥ä½¿ç”¨ `Collection` æ¥å£çš„ `removeIf` æ–¹æ³•æ¥é¿å…æ˜¾å¼éå†ã€‚

#### Transforming

å¦‚æœéœ€è¦éå† **list æˆ–æ•°ç»„**å¹¶ä¸”æ›¿æ¢æŸäº›å…ƒç´ çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ list iterator æˆ–è€…æ•°ç»„ç´¢å¼•çš„æ–¹å¼ã€‚

#### Parallel iteration

å¦‚æœéœ€è¦å¹¶è¡Œåœ°éå†å¤šä¸ªé›†åˆï¼ˆè¿™é‡Œå¹¶è¡Œæ˜¯æŒ‡åŒæ—¶éå†å¤šä¸ªé›†åˆï¼Œè€Œä¸æ˜¯å¤šçº¿ç¨‹ï¼‰ï¼Œé‚£ä¹ˆå°±éœ€è¦æ˜¾å¼æ§åˆ¶è¿­ä»£å™¨æˆ–ç´¢å¼•å˜é‡ï¼Œä»¥ä½¿å®ƒä»¬åŒæ­¥ç§»åŠ¨ã€‚

### Iterable

å®ç°äº† `Iterable` æ¥å£çš„å¯¹è±¡ä¹Ÿå¯ä»¥é€šè¿‡ for-each éå†ã€‚

public interface Iterable<E> {  
    // Returns an iterator over the elements in this iterable  
    Iterator<E> iterator();  
}

å¦‚æœè¦ç¼–å†™çš„ç±»è¡¨ç¤ºä¸€ç»„å…ƒç´ ï¼Œå³ä½¿åœ¨æ²¡æœ‰å®ç° Collection æ¥å£çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥å»è€ƒè™‘å®ç° Iterable æ¥å£ã€‚

## 59. äº†è§£å’Œä½¿ç”¨ç±»åº“

### éšæœºæ•°çš„ä¾‹å­

å¯èƒ½ä¼šç¼–å†™ä¸‹é¢çš„æ–¹æ³•æ¥è¿”å› 0 åˆ° n ä¸­é—´çš„ä¸€ä¸ªéšæœºæ•°ï¼š

// Common but deeply flawed!  
static Random rnd = new Random();  
static int random(int n) {  
    return Math.abs(rnd.nextInt()) % n;  
}

è¿™æ®µæ–¹æ³•æœ‰ä¸‰ä¸ªç¼ºé™·ã€‚

1.  å¦‚æœ n æ˜¯ 2 çš„ä¸€ä¸ªè¾ƒå°æ¬¡æ–¹ï¼Œäº§ç”Ÿçš„éšæœºæ•°åºåˆ—å°†ä¼šå‡ºç°çŸ­å‘¨æœŸæ€§é‡å¤ï¼›
    
2.  å¦‚æœ n ä¸æ˜¯ 2 çš„æ¬¡æ–¹ï¼Œé‚£ä¹ˆéšæœºæ•°åºåˆ—ä¸­æœ‰äº›æ•°ä¼šæ¯”å…¶å®ƒæ•°å‡ºç°çš„æ›´é¢‘ç¹ã€‚å¦‚æœ n å¾ˆå¤§ï¼Œè¿™ä¸ªå·®è·ä¼šæ›´æ˜æ˜¾ï¼›
    
3.  è¿™ä¸ª random æ–¹æ³•åœ¨æå°‘æ•°æƒ…å†µä¸‹ä¼šè¿è¡Œå¤±è´¥ï¼Œè¿™æ˜¯å› ä¸ºä½¿ç”¨äº† `Math.abs` æ–¹æ³•ã€‚å¦‚æœ `nextInt()` è¿”å›äº† `Integer.MIN_VALUE`ï¼Œé‚£ä¹ˆ `Math.abs` æ–¹æ³•ä¹Ÿä¼šè¿”å› `Integer.MIN_VALUE`ã€‚å¦‚æœ n ä¸æ˜¯ 2 çš„æ¬¡æ–¹ï¼Œé‚£ä¹ˆå’Œ n å–ä½™åä¼šè¿”å›è´Ÿå€¼ã€‚è¿™å°±å¯èƒ½å¯¼è‡´è¿è¡Œé”™è¯¯ï¼Œå¹¶ä¸”è¿™ä¸ªé”™è¯¯å¾ˆéš¾é‡ç°ã€‚
    

å¦‚æœè¦è‡ªå·±ä¿®æ­£ä¸Šé¢çš„é”™è¯¯ï¼Œéœ€è¦å­¦ä¹ ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ã€æ•°è®ºã€2 çš„æ±‚è¡¥ç®—æ³•ã€‚ä½† Java ç±»åº“å·²ç»æä¾›äº†è¿™ä¸ªæ–¹æ³•ï¼š`Random.nextInt(int)`ã€‚

Java 7 ä¹‹åï¼Œå°±ä¸åº”è¯¥å†ä½¿ç”¨ `Random` ç±»äº†ï¼Œæ›´å¥½çš„éšæœºæ•°ç”Ÿæˆå™¨æ˜¯ `ThreadLocalRandom`ã€‚å®ƒäº§ç”Ÿçš„éšæœºæ•°è´¨é‡æ›´é«˜ä¸”æ›´å¿«ã€‚å¯¹äº fork join poolï¼ˆTODOï¼šè¿™æ˜¯ä»€ä¹ˆï¼Ÿï¼‰å’Œå¹¶è¡Œ Streamï¼Œå°±åº”è¯¥ä½¿ç”¨ `SplittableRandom`ã€‚

### ä½¿ç”¨ç±»åº“çš„å¥½å¤„

1.  å¯ä»¥å……åˆ†åˆ©ç”¨ä¸“å®¶çš„çŸ¥è¯†å’Œå‰äººçš„ç»éªŒï¼›
    
2.  å¯ä»¥ä½¿æˆ‘ä»¬ä¸å¿…å»ä¸ºé‚£äº›ä¸å·¥ä½œä¸ç›¸å¹²çš„é—®é¢˜æä¾›ç‰¹åˆ«è§£å†³æ–¹æ¡ˆï¼›
    
3.  ç±»åº“æä¾›çš„æ–¹æ³•ä¼šä¸€ç›´åœ¨æ”¹å–„ï¼Œå¹¶ä¸”ä¸ä¼šå½±å“åˆ°æˆ‘ä»¬çš„ä»£ç ï¼›
    
4.  ç±»åº“æ€»æ˜¯ä¼šæ·»åŠ æ–°çš„æ–¹æ³•æ¥æ»¡è¶³æ›´å¤šéœ€æ±‚ï¼›
    
5.  å¯ä»¥ä½¿æˆ‘ä»¬çš„ä»£ç ä¸»å¯¼ç¨‹åºï¼Œå¹¶ä¸”è¿™æ ·çš„ä»£ç æ›´æ˜“è¯»ã€æ˜“ç»´æŠ¤å’Œæ˜“é‡ç”¨ã€‚
    

### å­¦ä¹ ç±»åº“

#### å­¦ä¹ æ–°ç‰¹æ€§

æ¯ä¸ªé‡è¦çš„ç‰ˆæœ¬ï¼Œç±»åº“éƒ½ä¼šæ·»åŠ è®¸å¤šé‡è¦çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä¿æŒä¸è¿™äº›æ–°ç‰¹æ€§åŒæ­¥ã€‚æ¯”å¦‚ï¼Œåœ¨ Java 9 ä¹‹å‰ï¼Œè¦æƒ³å®ç°ç±»ä¼¼ Linux çš„ curl å‘½ä»¤çš„æ•ˆæœæ˜¯ååˆ†æ¯ç‡¥çš„ï¼Œä½† Java 9 åœ¨ `InputStream` ä¸­æ·»åŠ äº† `transferTo` æ–¹æ³•ï¼š

// Printing the contents of a URL with transferTo, added in Java 9  
public static void main(String[] args) throws IOException {  
    try (InputStream in = new URL(args[0]).openStream()) {  
        in.transferTo(System.out);  
    }  
}

#### å­¦ä¹ åŸºç¡€

ç±»åº“æ˜¯ååˆ†åºå¤§çš„ï¼Œå¾ˆéš¾å…¨éƒ¨å­¦ä¹ å®Œã€‚ä½†æ¯ä¸ªç¨‹åºå‘˜éƒ½åº”è¯¥å»ç†Ÿæ‚‰ `java.lang`ã€`java.util`ã€`java.io` å’Œå®ƒä»¬çš„å­åŒ…ï¼Œå…¶ä»–ç±»åº“å¯ä»¥æ ¹æ®éœ€è¦å­¦ä¹ ã€‚

æ¯ä¸ªç¨‹åºå‘˜éƒ½åº”è¯¥ä¼šä½¿ç”¨ collections framwork å’Œ streams libraryï¼ˆè¯¦è§ 45-48 æ¡ï¼‰ï¼ŒåŒæ ·è¿˜åº”è¯¥ä¼šä½¿ç”¨ `java.util.concurrent` ä¸­çš„éƒ¨åˆ†å¹¶å‘å·¥å…·ã€‚è¿™ä¸ªåŒ…æ—¢åŒ…å«äº†é«˜çº§çš„å¹¶å‘å·¥å…·ï¼ˆè¯¦è§ç¬¬ 81 82 æ¡ï¼‰æ¥ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œä¹ŸåŒ…å«äº†ä½çº§çš„å¹¶å‘åŸºæœ¬ç±»å‹ï¼ˆå¹¶å‘åŸºæœ¬ç±»å‹çš„åŸæ–‡æ˜¯ primitiveï¼Œåœ¨è¿™é‡Œä¸æ˜¯æŒ‡åŸºæœ¬ç±»å‹ï¼Œæ˜¯æŒ‡å¹¶å‘ç¼–ç¨‹ä¸­å’Œ intã€long ç­‰ç±»ä¼¼çš„å¹¶å‘åŸºæœ¬ç±»å‹ï¼‰ï¼Œæ¥è®©ä¸“å®¶ç¼–å†™ä»–ä»¬è‡ªå·±æ›´é«˜çº§åˆ«çš„å¹¶å‘æŠ½è±¡ã€‚

### å½“æ ‡å‡†ç±»åº“æ— æ³•æ»¡è¶³éœ€è¦æ—¶

ç¼–å†™ä»£ç çš„ç¬¬ä¸€æƒ³æ³•æ˜¯ä½¿ç”¨æ ‡å‡†ç±»åº“ï¼Œå¦‚æœä¸èƒ½æ»¡è¶³éœ€è¦ï¼Œå¯ä»¥å»å¯»æ‰¾é«˜è´¨é‡çš„ç¬¬ä¸‰æ–¹ç±»åº“ï¼Œå¦‚ Google çš„ Guavaã€‚å¦‚æœè¿™äº›ç±»åº“éƒ½æ²¡æœ‰çš„æ—¶å€™ï¼Œå†å»è‡ªå·±å®ç°ã€‚

## 60. å¦‚æœéœ€è¦ç²¾ç¡®ç­”æ¡ˆï¼Œå°±é¿å…ä½¿ç”¨ float å’Œ double

### float å’Œ double çš„å±å®³

float å’Œ double ç±»å‹ä¸»è¦æ˜¯ä¸ºäº†ç§‘å­¦è®¡ç®—å’Œå·¥ç¨‹è®¡ç®—è€Œè®¾è®¡çš„ã€‚å®ƒä»¬æ‰§è¡ŒäºŒè¿›åˆ¶æµ®ç‚¹è¿ç®—ï¼ˆbinary floating-point arithmeticï¼‰ï¼Œè¿™æ˜¯ä¸ºäº†åœ¨å¹¿æ³›çš„æ•°å€¼èŒƒå›´ä¸Šæä¾›**è¾ƒä¸ºç²¾ç¡®çš„å¿«é€Ÿè¿‘ä¼¼è®¡ç®—**è€Œç²¾å¿ƒè®¾è®¡çš„ã€‚æ‰€ä»¥ï¼Œå®ƒä»¬å¹¶æ²¡æœ‰æä¾›å®Œå…¨ç²¾ç¡®çš„ç»“æœï¼Œä¸åº”è¯¥è¢«ç”¨äºéœ€è¦ç²¾ç¡®ç»“æœçš„åœºåˆã€‚å®ƒä»¬å°¤å…¶ä¸é€‚åˆç”¨äºè´§å¸è®¡ç®—ï¼Œå› ä¸ºè¦è®©ä¸€ä¸ª float æˆ–è€… double ä¸å¯èƒ½ç²¾ç¡®åœ°è¡¨ç¤º 10 çš„ä»»ä½•è´Ÿæ•°æ¬¡æ–¹å€¼ã€‚

System.out.println(1.03 - 0.42);			// 0.6100000000000001  
System.out.println(1.00 - 9 * 0.10);		// 0.09999999999999998  
  
public static void main(String[] args) {  
    double funds = 1.00;  
    int itemsBought = 0;  
    for (double price = 0.10; funds >= price; price += 0.10) {  
        funds -= price;  
        itemsBought++;  
    }  
    System.out.println(itemsBought + " items bought.");  
    System.out.println("Change: $" + funds);		// Â¥0.3999999999999999  
}

### ç²¾ç¡®è®¡ç®—çš„æ­£ç¡®æ–¹å¼

#### BigDecimal

public static void main(String[] args) {  
    final BigDecimal TEN_CENTS = new BigDecimal(".10");  
    int itemsBought = 0;  
    BigDecimal funds = new BigDecimal("1.00");   
    for (BigDecimal price = TEN_CENTS; funds.compareTo(price) >= 0;  
         									price = price.add(TEN_CENTS)) {  
        funds = funds.subtract(price);  
        itemsBought++;  
    }  
    System.out.println(itemsBought + " items bought.");  
    System.out.println("Money left over: $" + funds);		// Â¥0.00  
}

æ³¨æ„åˆ° `BigDecimal` æ„é€ æ–¹æ³•çš„å‚æ•°ä½¿ç”¨äº† String è€Œä¸æ˜¯ doubleã€‚

ä½†ä½¿ç”¨ `BigDecimal` ä¹Ÿæœ‰ç¼ºç‚¹ï¼šæ¯”ä½¿ç”¨ primitive éº»çƒ¦å¾ˆå¤šï¼Œä¸”æ…¢å¾ˆå¤šã€‚

#### int æˆ– long

å¯ä»¥ä½¿ç”¨ int æˆ– long æ¥ä»£æ›¿ `BigDecimal`ï¼Œä½†éœ€è¦è‡ªå·±å¤„ç†åè¿›åˆ¶ï¼ˆdecimalï¼‰å°æ•°ç‚¹ã€‚

public static void main(String[] args) {  
    int itemsBought = 0;  
    int funds = 100;  
    for (int price = 10; funds >= price; price += 10) {  
        funds -= price;  
        itemsBought++;  
    }  
    System.out.println(itemsBought + " items bought.");  
    System.out.println("Cash left over: " + funds + " cents");  
}

è¿™ç§æ–¹å¼é€‚åˆæ•°å€¼ä¸å¤§çš„æƒ…å†µã€‚å¦‚æœä¸è¶…è¿‡ 9 ä½åè¿›åˆ¶æ•°å­—ï¼Œå°±å¯ä»¥ä½¿ç”¨ intï¼›å¦‚æœä¸è¶…è¿‡ 18 ä½æ•°å­—ï¼Œå°±å¯ä»¥ä½¿ç”¨ longï¼›å¦åˆ™å¿…é¡»ä½¿ç”¨ `BigDecimal`ã€‚

## 61. åŸºæœ¬ç±»å‹ä¼˜å…ˆäºè£…ç®±åŸºæœ¬ç±»å‹

### ä¸»è¦åŒºåˆ«

1.  primitives åªæœ‰å€¼ï¼Œè€Œ boxed primitives æœ‰å€¼å’Œèº«ä»½ï¼ˆidentityï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸¤ä¸ª boxed primitives å¯èƒ½å€¼ç›¸åŒä½†èº«ä»½ä¸åŒã€‚
    
2.  primitives åªæœ‰ fully functional valueï¼Œä½†æ¯ä¸ª boxed primitive é™¤äº†æœ‰å¯¹åº”çš„ functional value å¤–è¿˜æœ‰ä¸€ä¸ª nonfunctional value â€”â€” nullã€‚
    
3.  primitives åœ¨æ—¶é—´å’Œç©ºé—´ä¸Šéƒ½ä¼˜äº boxed primitivesã€‚
    

### ä½¿ç”¨ boxed-primitives å¯èƒ½å¸¦æ¥çš„é—®é¢˜

#### ä½¿ç”¨ == æ“ä½œç¬¦

å‡è®¾å†™äº†ä¸€ä¸ª comparator æ¥è¡¨ç¤º Integer å€¼çš„å‡åºï¼š

// Broken comparator - can you spot the flaw?  
Comparator<Integer> naturalOrder =  
    (i, j) -> (i < j) ? -1 : (i == j ? 0 : 1);

è¿™ä¸ª Comparator åœ¨å¾ˆå¤šæƒ…å†µä¸‹éƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†æœ‰ä¸€ä¸ªä¸¥é‡çš„ç¼ºé™·ï¼š`naturalOrder.compare(new Integer(42), new Integer(42))` ä¼šè¿”å› 1ã€‚

åŸå› æ˜¯ï¼š

1.  ç¬¬ä¸€æ­¥ i < jï¼ŒInteger ä¼š auto-unboxedï¼Œæ‰€ä»¥ä¼šè¿”å› trueï¼›
    
2.  ç¬¬äºŒæ­¥ i == jï¼Œè¿™ä¼šå¯¹ä¸¤ä¸ª Integer å¯¹è±¡å¼•ç”¨è¿›è¡Œèº«ä»½å¯¹æ¯”ï¼ˆidentity comparisonï¼‰ï¼Œæ‰€ä»¥ä¼šè¿”å› falseï¼›
    
3.  ç¬¬ä¸‰æ­¥ï¼Œè¿”å› 1ã€‚
    

**åœ¨ boxed-primitives ä¹‹é—´ä½¿ç”¨ == æ“ä½œç¬¦å‡ ä¹æ°¸è¿œæ˜¯é”™çš„ã€‚**

> å¦‚æœéœ€è¦ Comparator æè¿°ä¸€ä¸ªç±»å‹çš„ natural orderï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ `Comparator.natualOrder()`ã€‚å¦‚æœè¦è‡ªå·±ç¼–å†™ Comparatorï¼Œå°±éœ€è¦ä½¿ç”¨ Comparator çš„æ„é€ æ–¹æ³•æˆ–è€…åœ¨ primitive ç±»å‹ä¸Šä½¿ç”¨é™æ€ compare æ–¹æ³•ï¼ˆè¯¦è§ç¬¬ 14 æ¡ï¼‰

å¯ä»¥æ·»åŠ ä¸¤ä¸ªå±€éƒ¨å˜é‡æ¥é¿å…è¿™ä¸ªé—®é¢˜ï¼š

Comparator<Integer> naturalOrder = (iBoxed, jBoxed) -> {  
    int i = iBoxed, j = jBoxed; // Auto-unboxing  
    return i < j ? -1 : (i == j ? 0 : 1);  
};

#### åˆå§‹åŒ–

public class Unbelievable {  
    static Integer i;  
    public static void main(String[] args) {  
        if (i == 42)  
            System.out.println("Unbelievable");  
    }   
}

è¿™æ®µç¨‹åºä¼šæŠ›å‡º NPEï¼Œå› ä¸º i æ˜¯ä¸€ä¸ª Integer è€Œä¸æ˜¯ intï¼Œæ‰€ä»¥å®ƒçš„åˆå§‹å€¼ä¸º nullã€‚ç„¶ååœ¨ i == 4 ä¸­ï¼Œi ä¼šè¢« auto-unboxedï¼Œå› æ­¤æŠ›å‡º NPEã€‚

#### æ€§èƒ½

// Hideously slow program! Can you spot the object creation?  
public static void main(String[] args) {  
    Long sum = 0L;  
    for (long i = 0; i < Integer.MAX_VALUE; i++) {  
           sum += i;  
    }  
    System.out.println(sum);  
}

è¿™æ®µç¬¬ 6 æ¡ä¸­çš„ç¨‹åºæ²¡æœ‰é—®é¢˜ï¼Œä½†æ€§èƒ½å¾ˆå·®ã€‚å› ä¸º sum æ˜¯ boxed primitiveï¼ˆåŒ…å«äº†ä¸€æ¬¡å¯¹è±¡åˆ›å»ºï¼‰ï¼Œåœ¨å¾ªç¯ä¸­ä¼šé‡å¤è¿›è¡Œ boxing å’Œ unboxingã€‚

### ä½•æ—¶è¯¥ç”¨ boxed primitives

1.  å¯ä»¥ç”¨äºé›†åˆä¸­çš„ elementã€key å’Œ valueï¼Œå› ä¸ºä¸èƒ½å°† primitive æ”¾å…¥é›†åˆä¸­ï¼›
    
2.  å¯ä»¥ç”¨äºå‚æ•°åŒ–ç±»å‹å’Œæ–¹æ³•ä¸­çš„ç±»å‹å‚æ•°ï¼ˆè¯¦è§ç¬¬ 5 ç« ï¼‰ï¼ŒåŸå› åŒä¸Šï¼›
    
3.  å¯ä»¥ç”¨äºåå°„æ–¹æ³•è°ƒç”¨ï¼ˆè¯¦è§ç¬¬ 65 æ¡ï¼‰ï¼ŒåŸå› åŒä¸Šã€‚
    

## 62. åœ¨æœ‰å…¶ä»–é€‰æ‹©çš„æ—¶å€™ä¸è¦ä½¿ç”¨ String

### String ä¸é€‚åˆä»£æ›¿å…¶ä»–å€¼ç±»å‹

åªæœ‰åœ¨å€¼æ˜¯æ–‡æœ¬ä¿¡æ¯çš„æ—¶å€™æ‰ä½¿ç”¨ Stringã€‚å¦‚æœæœ‰å…¶ä»–åˆé€‚çš„å€¼ç±»å‹ï¼Œæ— è®ºæ˜¯ primitive è¿˜æ˜¯å¯¹è±¡å¼•ç”¨ï¼Œéƒ½åº”è¯¥ä½¿ç”¨å®ƒï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±å†™ä¸€ä¸ªæ–°çš„ç±»å‹ã€‚

### String ä¸é€‚åˆä»£æ›¿æšä¸¾ç±»å‹

æšä¸¾ç±»å‹æ¯” String æ›´åŠ é€‚åˆç”¨æ¥è¡¨ç¤ºæšä¸¾ç±»å‹çš„å¸¸é‡ï¼Œè¯¦è§ç¬¬ 34 æ¡ã€‚

### String ä¸é€‚åˆä»£æ›¿èšåˆç±»å‹

å¦‚æœä¸€ä¸ªå®ä½“æœ‰å¤šä¸ªç»„ä»¶ï¼Œæœ€å¥½åˆ«ç”¨ä¸€ä¸ª String æ¥è¡¨ç¤ºå®ƒã€‚å¦‚æœè¿™æ ·ï¼Œé‚£ä¹ˆåœ¨è®¿é—®æŸä¸ªå¯¹è±¡åŸŸçš„æ—¶å€™ï¼Œå°±éœ€è¦è§£æ Stringï¼Œè¿™ä¼šå¾ˆæ…¢ã€å¾ˆç¹çå¹¶ä¸”å®¹æ˜“å‡ºé”™ã€‚You canâ€™t provide equals, toString, or compareTo methods but are forced to accept the behavior that String providesï¼ˆTODOï¼šæ²¡æ˜ç™½ä»€ä¹ˆæ„æ€ï¼‰ã€‚æ›´å¥½çš„åŠæ³•æ˜¯ç¼–å†™ä¸€ä¸ªç±»æ¥è¡¨ç¤ºè¿™ä¸ªèšåˆï¼Œé€šå¸¸æ˜¯ä¸€ä¸ª private static ç±»ï¼ˆè¯¦è§ç¬¬ 24 æ¡ï¼‰ã€‚

### String ä¸é€‚åˆæ›¿ä»£ capabilites

åœ¨ Java æœ‰ ThreadLocal ä¹‹å‰ï¼Œå¯èƒ½ä¼šé€šè¿‡ä¸‹é¢çš„ä»£ç æ¥å®ç°ï¼š

// Broken - inappropriate use of string as capability!  
public class ThreadLocal {  
    private ThreadLocal() { } // Noninstantiable  
    // Sets the current thread's value for the named variable.  
    public static void set(String key, Object value);  
    // Returns the current thread's value for the named variable.  
    public static Object get(String key);  
}

è¿™ç§æ–¹æ³•çš„é—®é¢˜æ˜¯ï¼Œä½œä¸º key çš„ string ä»£è¡¨äº†ä¸€ä¸ª thread-local å˜é‡å…±äº«çš„å…¨å±€å‘½åç©ºé—´ã€‚å½“ä¸¤ä¸ªå®¢æˆ·ç«¯ç¢°å·§ä½¿ç”¨äº†åŒæ ·çš„ string ä½œä¸º key çš„æ—¶å€™ï¼Œå®ƒä»¬å°±ä¼šå…±äº«ä¸€ä¸ª thread-local éå†ã€‚å¹¶ä¸”è¿™ä¸ªç¼ºé™·å¯èƒ½è¢«æ¶æ„å®¢æˆ·ç«¯åˆ©ç”¨ï¼Œæ¥éæ³•è®¿é—®å…¶ä»–å®¢æˆ·ç«¯çš„æ•°æ®ã€‚

è§£å†³åŠæ³•å¾ˆç®€å•ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ä¸€ä¸ªä¸å¯ä¼ªé€ ï¼ˆunforgeableï¼‰çš„ key æ¥ä»£æ›¿ stringï¼Œè¿™ç§ key å«åš capabilityï¼š

public class ThreadLocal {  
    private ThreadLocal() { }  // Noninstantiable  
     
    public static class Key {  // (Capability)  
        Key() { }  
    }  
      
    // Generates a unique, unforgeable key  
    public static Key getKey() {  
        return new Key();  
    }  
    public static void set(Key key, Object value);  
    public static Object get(Key key);  
}

å…¶å®å¹¶ä¸éœ€è¦é™æ€æ–¹æ³•ï¼Œå®ƒä»¬å¯ä»¥æˆä¸º `Key` çš„å®ä¾‹æ–¹æ³•ï¼Œè¿™æ ·ä¹Ÿå°±è¡¨ç¤º `Key` ä¸å†æ˜¯æ˜ å°„åˆ° thread-local å˜é‡çš„ keyï¼Œè€Œå®ƒè‡ªå·±å°±æ˜¯ä¸€ä¸ª thread-local å˜é‡ã€‚ä»è€Œï¼Œ`Key` çš„å¤–éƒ¨ç±» `ThreadLocal` ä¹Ÿå°±æ²¡ç”¨äº†ï¼Œå¯ä»¥åˆ é™¤å®ƒï¼Œå¹¶å°† `Key` é‡å‘½åä¸º `ThreadLocal`ã€‚

> Key ä»£è¡¨ Key ç±»ï¼Œkey ä»£è¡¨æ˜ å°„ä¸­çš„ keyã€‚

 public final class ThreadLocal {  
    public ThreadLocal();  
    public void set(Object value);  
    public Object get();  
}

è¿™ä¸ª API ä¸æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå› ä¸ºå¿…é¡»å°† get å¾—åˆ°çš„ Object è½¬å‹ä¸ºçœŸæ­£çš„ç±»å‹ã€‚ä¸å¯èƒ½ä½¿æœ€å¼€å§‹åŸºäº String çš„ API ä¸ºç±»å‹å®‰å…¨çš„ï¼Œè¦ä½¿åŸºäº `Key` çš„ API ä¸ºç±»å‹å®‰å…¨çš„ä¹Ÿå¾ˆå›°éš¾ï¼Œä½†æ˜¯é€šè¿‡å°† ThreadLocal ç±»æ³›å‹åŒ–ï¼ˆè¯¦è§ç¬¬ 29 æ¡ï¼‰ï¼Œä½¿è¿™ä¸ª API å˜æˆç±»å‹å®‰å…¨çš„å°±æ˜¯å¾ˆç®€å•çš„äº‹æƒ…äº†ï¼š

public final class ThreadLocal<T> {  
    public ThreadLocal();  
    public void set(T value);  
    public T get();  
}

æ­¤æ—¶ï¼Œæ—¢è§£å†³äº†åŸºäº String çš„ API å¸¦æ¥çš„é—®é¢˜ï¼Œä¹Ÿæ¯”åŸºäº `Key` çš„ API æ€§èƒ½å¥½ä¸”æ›´ä¼˜é›…ã€‚

## 63. äº†è§£ String è¿æ¥çš„æ€§èƒ½

ä¸ºè¿æ¥ n ä¸ªå­—ç¬¦ä¸²è€Œé‡å¤åœ°ä½¿ç”¨å­—ç¬¦ä¸² è¿æ¥æ“ä½œç¬¦ï¼Œæ—¶é—´å¤åˆ¶åº¦æ˜¯ O(n^2)ã€‚è¿™æ˜¯å› ä¸ºå­—ç¬¦ä¸²æ˜¯ immutableï¼ˆè¯¦è§ç¬¬ 17 æ¡ï¼‰è€Œå¯¼è‡´çš„ã€‚è€Œä½¿ç”¨ `StringBuilder` çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ã€‚

// Inappropriate use of string concatenation - Performs poorly!  
   public String statement() {  
       String result = "";  
       for (int i = 0; i < numItems(); i++)  
           result += lineForItem(i);  // String concatenation  
       return result;  
}  
  
  
public String statement() {  
    StringBuilder b = new StringBuilder(numItems() * LINE_WIDTH);   
    for (int i = 0; i < numItems(); i++)  
        b.append(lineForItem(i)); return b.toString();  
}

åœ¨ä½œè€…æœºå™¨ä¸Šï¼Œå…¥è‚¡å“¦numItesm è¿”å› 100 ä¸” lineForItem è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º 80 çš„ Stringï¼Œé‚£ä¹ˆä¸‹é¢çš„æ–¹æ³•ä¼šæ¯”ä¸Šé¢å¿« 6.5 å€ï¼Œå³ä½¿ä¸é¢„å…ˆåˆ†é… StringBuilderï¼Œä¹Ÿä¼šæ¯”ä¸Šé¢å¿« 5.5 å€ã€‚

æ‰€ä»¥ï¼Œåªæœ‰æ€§èƒ½ä¸é‡è¦çš„æ—¶å€™ä½¿ç”¨ + æ¥è¿æ¥ Stringï¼Œå¦åˆ™ç”¨ StringBuilderã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å­—ç¬¦æ•°ç»„ï¼Œæˆ–è€…æ¯æ¬¡å¤„ç†ä¸€ä¸ª Stringï¼Œè€Œä¸æ˜¯å°†å®ƒä»¬åˆå¹¶èµ·æ¥ã€‚

## 64. å¤šè€ƒè™‘ç”¨æ¥å£å¼•ç”¨å¯¹è±¡

### ä½¿ç”¨æ¥å£

ç¬¬ 51 æ¡è¯´åº”è¯¥ä½¿ç”¨æ¥å£è€Œä¸æ˜¯ç±»ä½œä¸ºå‚æ•°çš„ç±»å‹ï¼Œæ›´ä¸€èˆ¬çš„æ¥è¯´å°±æ˜¯ï¼Œä¼˜å…ˆä½¿ç”¨æ¥å£è€Œä¸æ˜¯ç±»æ¥å¼•ç”¨å¯¹è±¡ã€‚å¦‚æœæœ‰åˆé€‚çš„æ¥å£å­˜åœ¨ï¼Œé‚£ä¹ˆå‚æ•°ã€è¿”å›å€¼ã€å˜é‡å’ŒåŸŸéƒ½åº”è¯¥ç”¨æ¥å£ç±»å‹å£°æ˜ã€‚å”¯ä¸€éœ€è¦ç”¨ç±»å»å¼•ç”¨å¯¹è±¡çš„æ—¶å€™å°±æ˜¯åˆ›å»ºå®ƒä»¬çš„æ—¶å€™ã€‚

ä½¿ç”¨æ¥å£ç±»å‹ä¼šè®©ä»£ç æ›´çµæ´»ï¼Œå¦‚æœè¦åˆ‡æ¢å®ç°ç±»ï¼Œåªéœ€è¦åœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™æ”¹å˜ç±»åã€‚è€Œä¸”è¿™æ ·å®Œå…¨ä¸ä¼šå½±å“å…¶ä»–ä»£ç èƒ½è¿è¡Œã€‚

ä½†æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œå¦‚æœåŸå…ˆçš„å®ç°æä¾›äº†ä¸€äº›ç‰¹æ®Šçš„åŠŸèƒ½ï¼Œè€Œè¿™ä¸ªåŠŸèƒ½ä¸æ˜¯è¿™ä¸ªæ¥å£é€šç”¨åˆçº¦æ‰€è¦æ±‚çš„ï¼Œå¹¶ä¸”ä»£ç ä¾èµ–è¿™ä¸ªåŠŸèƒ½ã€‚é‚£ä¹ˆåœ¨åˆ‡æ¢åçš„å®ç°ç±»çš„æ—¶å€™å°±å¿…é¡»å…·æœ‰ç›¸åŒçš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä»£ç ä¾èµ– LinkedHashSet çš„æœ‰åºæ€§ï¼Œé‚£ä¹ˆå°±ä¸èƒ½ç”¨ HashSet æ¥ä»£æ›¿å®ƒã€‚

å¦‚æœä½¿ç”¨å®ç°ç±»çš„ç±»å‹æ¥å£°æ˜ä¸€ä¸ªå˜é‡ï¼Œè™½ç„¶åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­å¯ä»¥é€šè¿‡åŒæ—¶ä¿®æ”¹å£°æ˜ç±»å‹å’Œå®ç°ç±»å‹ï¼Œä½†æ”¹å˜ä¹‹åå¯èƒ½ä¼šå¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚å› ä¸ºå¯èƒ½å®¢æˆ·ç«¯ä½¿ç”¨äº†åŸå…ˆå®ç°ç±»å‹çš„æ–¹æ³•ï¼Œä½†è¿™ä¸ªæ–¹æ³•å¯èƒ½åœ¨æ–°çš„å®ç°ç±»å‹ä¸Šä¸å­˜åœ¨ï¼›ä¹Ÿæœ‰å¯èƒ½å®¢æˆ·ç«¯å°†åŸæ¥çš„å®ä¾‹ä¼ é€’ç»™äº†æ¥å—è¿™ä¸ªåŸæ¥çš„å®ç°ç±»å‹çš„æ–¹æ³•ã€‚

### ä½¿ç”¨ç±»

å¦‚æœæ²¡æœ‰åˆé€‚çš„æ¥å£å­˜åœ¨ï¼Œé‚£ä¹ˆå°±å®Œå…¨å¯ä»¥ä½¿ç”¨ç±»æ¥å¼•ç”¨å¯¹è±¡ã€‚æ²¡æœ‰åˆé€‚æ¥å£çš„æƒ…å†µå¤§æ¦‚æœ‰ä¸‰ç‚¹ã€‚

#### å€¼ç±»

ä»¥å€¼ç±»ï¼ˆvalue classesï¼‰ä¸ºä¾‹ï¼Œæ¯”å¦‚ String å’Œ BigIntegerã€‚å€¼ç±»åœ¨ç¼–å†™çš„æ—¶å€™å¾ˆå°‘è€ƒè™‘åˆ°å¤šç§å®ç°ã€‚å®ƒä»¬é€šå¸¸æ˜¯ final çš„ï¼Œå¹¶ä¸”å¾ˆå°‘æœ‰å¯¹åº”çš„æ¥å£ã€‚æ‰€ä»¥ä½¿ç”¨è¿™æ ·çš„å€¼ç±»ä½œä¸ºå‚æ•°ã€å˜é‡ã€åŸŸå’Œè¿”å›å€¼çš„ç±»å‹æ˜¯ååˆ†åˆé€‚çš„ã€‚

#### æŠ½è±¡ç±»

å¯¹è±¡å±äºä¸€ä¸ªæ¡†æ¶ï¼Œè¿™ä¸ªæ¡†æ¶çš„åŸºæœ¬ï¼ˆfundamentalï¼‰ç±»å‹æ˜¯ç±»è€Œä¸æ˜¯æ¥å£ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡å±äºè¿™æ ·ä¸€ä¸ªåŸºäºç±»çš„æ¡†æ¶ï¼Œæœ€å¥½ç”¨ç›¸å…³çš„åŸºç±»ï¼ˆbase classï¼Œé€šå¸¸æ˜¯æŠ½è±¡çš„ï¼‰æ¥æŒ‡ä»£å®ƒï¼Œè€Œä¸æ˜¯ç”¨å…¶å®ç°ç±»ã€‚è®¸å¤š java.io ç±»ï¼Œå¦‚`OutputStream` å°±å±äºè¿™ä¸€ç±»ã€‚

#### å®ç°ç±»æœ‰æ¥å£æ²¡æœ‰çš„æ–¹æ³•

åªæœ‰å½“ç¨‹åºä¾èµ–è¿™äº›é¢å¤–çš„æ–¹æ³•ï¼Œæ‰åº”è¯¥ä½¿ç”¨è¿™ä¸ªå®ç°ç±»æ¥å¼•ç”¨å¯¹è±¡ã€‚ä¾‹å¦‚ `PriorityQueue` æœ‰ä¸€ä¸ª comparator æ–¹æ³•ï¼Œä½†å®ƒå®ç°çš„æ¥å£ `Queue` æ²¡æœ‰ã€‚

## 65. æ¥å£ä¼˜äºåå°„

æ ¸å¿ƒåå°„æœºåˆ¶ï¼Œjava.core.reflectï¼Œæä¾›äº†å¯¹ä»»æ„ç±»çš„ç¨‹åºåŒ–è®¿é—®ã€‚ç»™å®šä¸€ä¸ª Class å¯¹è±¡ï¼Œå¯ä»¥è·å¾—`Constructor`ã€ `Method` å’Œ `Field` å®ä¾‹ï¼Œåˆ†åˆ«ä»£è¡¨äº† **Class å®ä¾‹æ‰€ä»£è¡¨çš„ç±»**çš„æ„é€ å™¨ã€æ–¹æ³•å’ŒåŸŸã€‚

TODOï¼šæ²¡çœ‹å®Œã€‚ã€‚

## 66. è°¨æ…ä½¿ç”¨ native æ–¹æ³•

JNIï¼ˆJava Native Interfaceï¼‰ä½¿ Java ç¨‹åºå‘˜å¯ä»¥è°ƒç”¨æœ¬åœ°æ–¹æ³•ï¼Œæœ¬åœ°æ–¹æ³•æ˜¯æŒ‡ native programming languagesï¼Œå¦‚ C å’Œ C++ã€‚å®ƒä»¬æä¾›å¯¹å¹³å°ç‰¹å®šè®¾æ–½ï¼ˆplatform-specific facilitesï¼‰çš„è®¿é—®ï¼Œå¦‚æ³¨å†Œè¡¨ï¼ˆregistriesï¼‰ã€‚å®ƒä»¬æä¾›å¯¹ç°æœ‰æœ¬åœ°ä»£ç åº“çš„è®¿é—®ï¼ŒåŒ…æ‹¬é—ç•™ä»£ç åº“ï¼ˆå®ƒå¯ä»¥æä¾›å¯¹é—ç•™æ•°æ®çš„è®¿é—®ï¼‰ã€‚æœ€åï¼Œæœ¬åœ°æ–¹æ³•å¯ä»¥åŒè¿‡ç”¨æœ¬åœ°è¯­è¨€ï¼Œç¼–å†™åº”ç”¨ç¨‹åºä¸­æ³¨é‡æ€§èƒ½çš„éƒ¨åˆ†ã€‚ ä½¿ç”¨æœ¬åœ°æ–¹æ³•æ¥è®¿é—®å¹³å°ç‰¹å®šçš„è®¾æ–½æ˜¯åˆæ³•çš„ï¼Œä½†å¾ˆå°‘æœ‰å¿…è¦ï¼šéšç€ Java å¹³å°çš„æˆç†Ÿï¼Œå®ƒæä¾›äº†å¯¹è®¸å¤šä»¥å‰åªå­˜åœ¨åœ¨ host platformsï¼ˆå®¿ä¸»å¹³å°ï¼Ÿï¼‰ä¸Šç‰¹æ€§çš„è®¿é—®ã€‚ä¾‹å¦‚ï¼ŒJava 9 ä¸­å¢åŠ çš„è¿›ç¨‹ API æä¾›äº†å¯¹æ“ä½œç³»ç»Ÿè¿›ç¨‹çš„è®¿é—®ã€‚å½“ Javaä¸­æ²¡æœ‰ç›¸åº”çš„åº“æ—¶ï¼Œé€šè¿‡ä½¿ç”¨æœ¬åœ°æ–¹æ³•æ¥ä½¿ç”¨æœ¬åœ°åº“ä¹Ÿæ˜¯åˆæ³•çš„ã€‚ **ä¸ºäº†æé«˜æ€§èƒ½è€Œä½¿ç”¨æœ¬åœ°æ–¹æ³•å¾ˆå°‘æ˜¯å¯å–çš„ã€‚**åœ¨ Java 3 ä¹‹å‰ï¼Œè¿™å¾€å¾€æ˜¯å¿…è¦çš„ï¼Œä½†ä»é‚£ä»¥å JVM å˜å¾—æ›´å¿«ã€‚å¯¹äºå¤§å¤šæ•°ä»»åŠ¡ï¼Œç°åœ¨å¯ä»¥åœ¨ Java ä¸­è·å¾—ä¸æœ¬åœ°æ–¹æ³•å‡ ä¹ç›¸åŒçš„æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œå½“ java.math åœ¨ 1.1 ç‰ˆä¸­è¢«æ·»åŠ æ—¶ï¼ŒBigInteger ä¾èµ–äºå½“æ—¶ç”¨ C è¯­è¨€ç¼–å†™çš„å¿«é€Ÿå¤šç²¾åº¦ç®—æœ¯åº“ã€‚åœ¨ Java 3 ä¸­ï¼ŒBigInteger è¢«é‡æ–°ç”¨ Java å®ç°ï¼Œå¹¶è¢«è°ƒæ•™åˆ°æ¯”åŸæ¥çš„æœ¬åœ°å®ç°æ›´å¿«ã€‚

> è¿™ä¸ªæ•…äº‹æœ‰ä¸€ä¸ªæ‚²ä¼¤çš„ç»“å±€ï¼šBigInteger ä»é‚£æ—¶èµ·å°±æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œé™¤äº†åœ¨ Java 8 ä¸­åŠ å¿«äº†å¤§æ•°çš„ä¹˜æ³•è¿ç®—ã€‚åœ¨é‚£æ®µæ—¶é—´é‡Œï¼Œæœ¬åœ°åº“çš„å·¥ä½œç»§ç»­å¿«é€Ÿè¿›è¡Œï¼Œç‰¹åˆ«æ˜¯ GNU å¤šç²¾åº¦ç®—æœ¯åº“ï¼ˆGMPï¼‰ã€‚éœ€è¦çœŸæ­£é«˜æ€§èƒ½å¤šç²¾åº¦ç®—æœ¯çš„ Javaç¨‹åºå‘˜ç°åœ¨æœ‰ç†ç”±é€šè¿‡æœ¬åœ°æ–¹æ³•ä½¿ç”¨ GMPã€‚

ä½¿ç”¨æœ¬åœ°æ–¹æ³•æœ‰ä¸¥é‡çš„ç¼ºç‚¹ã€‚å› ä¸º**æœ¬åœ°è¯­è¨€å¹¶ä¸å®‰å…¨**ï¼ˆè¯¦è§ç¬¬ 50 æ¡ï¼‰ï¼Œæ‰€ä»¥ä½¿ç”¨æœ¬åœ°æ–¹æ³•çš„åº”ç”¨ç¨‹åºä¸èƒ½å…å—å†…å­˜æŸåé”™è¯¯çš„å½±å“ã€‚å› ä¸ºæœ¬åœ°è¯­è¨€æ¯” Java æ›´ä¾èµ–å¹³å°ï¼Œä½¿ç”¨æœ¬åœ°æ–¹æ³•çš„ç¨‹åºçš„å¯ç§»æ¤æ€§æ›´å·®ã€‚å®ƒä»¬ä¹Ÿæ›´éš¾è°ƒè¯•ã€‚å¦‚æœä½ ä¸å°å¿ƒï¼Œæœ¬åœ°æ–¹æ³•ä¼šé™ä½æ€§èƒ½ï¼Œå› ä¸ºåƒåœ¾æ”¶é›†å™¨ä¸èƒ½è‡ªåŠ¨åŒ–ã€ç”šè‡³ä¸èƒ½è·Ÿè¸ªæœ¬åœ°å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼ˆè¯¦è§ç¬¬ 8 æ¡ï¼‰ï¼Œè€Œä¸”è¿›å…¥å’Œé€€å‡ºæœ¬åœ°ä»£ç ä¹Ÿæœ‰ä¸€å®šæˆæœ¬ã€‚æœ€åï¼Œæœ¬åœ°æ–¹æ³•éœ€è¦ "èƒ¶æ°´ä»£ç ï¼ˆglue codeï¼‰"ï¼Œè€Œè¿™äº›ä»£ç å¾ˆéš¾é˜…è¯»ï¼Œç¼–å†™èµ·æ¥ä¹Ÿå¾ˆç¹çã€‚

æ€»ä¹‹ï¼Œåœ¨ä½¿ç”¨æœ¬åœ°æ–¹æ³•ä¹‹å‰è¯·ä¸‰æ€ã€‚ä½ å¾ˆå°‘éœ€è¦ä½¿ç”¨å®ƒä»¬æ¥æé«˜æ€§èƒ½ã€‚å¦‚æœä½ å¿…é¡»ä½¿ç”¨æœ¬åœ°æ–¹æ³•æ¥è®¿é—®ä½çº§åˆ«çš„èµ„æºæˆ–æœ¬åœ°åº“ï¼Œè¯·å°½é‡å°‘ç”¨æœ¬åœ°ä»£ç ï¼Œå¹¶å¯¹å…¶è¿›è¡Œå½»åº•æµ‹è¯•ã€‚æœ¬æœºä»£ç ä¸­çš„ä¸€ä¸ªé”™è¯¯å°±å¯ä»¥ç ´åæ•´ä¸ªåº”ç”¨ç¨‹åºã€‚

> è¿™ç« å‡ ä¹å…¨æ˜¯ç¿»è¯‘çš„ï¼ŒæŒºéš¾è¯»çš„ã€‚

## 67. è°¨æ…åœ°ä¼˜åŒ–

æœ‰ä¸‰å¥å…³äºä¼˜åŒ–çš„åè¨€ï¼š

-   ä»¥æ•ˆç‡çš„åä¹‰ï¼ˆä¸ä¸€å®šèƒ½å®ç°ï¼‰çŠ¯ä¸‹çš„è®¡ç®—è¿‡å¤±æ¯”ä»»ä½•å…¶ä»–åŸå› ï¼ˆåŒ…æ‹¬ç›²ç›®çš„æ„šè ¢ï¼‰éƒ½å¤šã€‚
    
-   ä¸è¦å»è®¡è¾ƒæ•ˆç‡ä¸Šä¸€äº›å°çš„å¾—å¤±ï¼Œåœ¨ 97% çš„æƒ…å†µä¸‹ï¼Œpremature optimization æ‰æ˜¯ä¸€åˆ‡é—®é¢˜çš„æ ¹æºã€‚
    
    > ä¸çŸ¥é“è¿™é‡Œçš„ premature çš„æ„æ€æ˜¯è¿‡æ—©çš„è¿˜æ˜¯ä¸æˆç†Ÿçš„ã€‚
    
-   åœ¨ä¼˜åŒ–æ–¹é¢åº”è¯¥éµå®ˆä¸¤æ¡è§„åˆ™ï¼š
    
    1.  ä¸è¦è¿›è¡Œä¼˜åŒ–ï¼›
        
    2.  ï¼ˆä»…é€‚ç”¨äºä¸“å®¶ï¼‰æš‚æ—¶ä¸è¦è¿™æ ·åšï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä½ æœ‰ä¸€ä¸ªå®Œç¾çš„ã€æœªç»ä¼˜åŒ–çš„è§£å†³æ–¹æ¡ˆä¹‹å‰ï¼Œä¸è¦è¿™æ ·åšã€‚
        
        > åŸæ–‡ï¼šDonâ€™t do it yetâ€”that is, not until you have a perfectly clear and unoptimized solution.
        

è¿™ä¸‰å¥åè¨€æ¯” Java æ—©äº† 20 å¹´ï¼Œå®ƒä»¬éƒ½è®²è¿°äº†ä¸€ä¸ªå…³äºä¼˜åŒ–çš„æ·±åˆ»çœŸç†ï¼šä¼˜åŒ–æ—¶å¾ˆå®¹æ˜“é€ æˆå¼Šå¤§äºåˆ©çš„æƒ…å†µï¼Œå°¤å…¶æ˜¯ä¸æˆç†Ÿçš„ä¼˜åŒ–ã€‚ä»¥è‡³äºå¯èƒ½æœ€ç»ˆäº§ç”Ÿçš„è½¯ä»¶æ—¢ä¸å¿«ä¹Ÿä¸æ­£ç¡®ï¼Œä¸”è¿˜ä¸å®¹æ˜“ä¿®æ­£ã€‚

ä¸è¦ä¸ºäº†æ€§èƒ½è€Œæ”¾å¼ƒåˆç†çš„æ¶æ„åŸåˆ™ï¼Œè¦åŠªåŠ›ç¼–å†™å¥½ç¨‹åºè€Œä¸æ˜¯è¿è¡Œå¿«çš„ç¨‹åºã€‚å¦‚æœä¸€ä¸ªå¥½ç¨‹åºè¿è¡Œå¾—ä¸å¤Ÿå¿«ï¼Œé‚£ä¹ˆå®ƒçš„æ¶æ„ä¼šå®¹è®¸å®ƒè¿›è¡Œä¼˜åŒ–ã€‚

TODOï¼šæ²¡çœ‹å®Œã€‚ã€‚

## 68. éµå®ˆæ™®éæ¥å—çš„å‘½åæƒ¯ä¾‹

Java æœ‰ä¸€å¥—å¾ˆå¥½çš„å‘½åç®¡ç†ï¼ˆnaming conventionsï¼‰ï¼Œå…¶ä¸­æœ‰è®¸å¤šéƒ½è¢«åŒ…å«åœ¨ã€ŠThe Java Language Specificationã€‹ä¸­ã€‚å‘½åæƒ¯ä¾‹å¤§è‡´åˆ†ä¸ºä¸¤ç±»ï¼štypographicalï¼ˆæ’ç‰ˆçš„ï¼‰å’Œ grammaticï¼ˆè¯­æ³•çš„ï¼‰ã€‚

### æ’ç‰ˆæƒ¯ä¾‹

è¿™ç§æƒ¯ä¾‹æ¯”è¾ƒå°‘ï¼Œä½†ä¹Ÿæ¶‰åŠäº†åŒ…ã€ç±»ã€æ¥å£ã€æ–¹æ³•ã€åŸŸå’Œç±»å‹å˜é‡ï¼Œå°½é‡ä¸è¦è¿åè¿™ä¸ªæƒ¯ä¾‹ã€‚

#### åŒ…å’Œæ¨¡å—

åŒ…å’Œæ¨¡å—çš„åç§°åº”è¯¥æ˜¯å±‚æ¬¡çŠ¶çš„ï¼Œç”¨å¥å·åˆ†éš”æ¯éƒ¨åˆ†ã€‚æ¯ä¸ªéƒ¨åˆ†éƒ½åº”è¯¥ç”±å°å†™å­—æ¯ç»„æˆï¼Œå¾ˆå°‘ä¼šæœ‰æ•°å­—ã€‚

åŒ…åç§°çš„å¼€å¤´éƒ¨åˆ†åº”è¯¥æ˜¯æ‰€åœ¨çš„ç»„ç»‡çš„ Internet åŸŸåï¼Œè€Œä¸”è¿™ä¸ªåŸŸåæ˜¯åè¿‡æ¥çš„ã€‚å¦‚ edu.cmuã€com.googleã€org.effã€‚æ ‡å‡†ç±»åº“å’Œä¸€äº›åŒ…çš„åç§°ä»¥ java å’Œ javax å¼€å¤´ï¼Œè¿™æ˜¯ä¸€ç§ä¾‹å¤–ï¼Œç”¨æˆ·åƒä¸‡ä¸èƒ½ä»¥ java æˆ– javax å¼€å¤´ã€‚

åŒ…åç§°çš„å‰©ä¸‹éƒ¨åˆ†åº”è¯¥ç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªæè¿°è¯¥åŒ…çš„éƒ¨åˆ†ç»„æˆã€‚æ¯éƒ¨åˆ†éƒ½åº”è¯¥å°½å°‘äº 8 ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”é€šå¸¸æ¥è¯´æ˜¯ä¸€ä¸ªå•è¯æˆ–è€…ç¼©å†™ã€‚å¦‚æœä½¿ç”¨ç¼©å†™ï¼Œè¦æœ‰æ„ä¹‰ï¼Œå¦‚ä½¿ç”¨ util è€Œä¸æ˜¯ utilitiesã€‚é¦–å­—æ¯ç¼©å†™ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ï¼Œå¦‚ awtã€‚

åŒ…åç§°é€šå¸¸é™¤äº† Internet åŸŸåå¤–åªæœ‰ä¸€ä¸ªéƒ¨åˆ†ï¼Œå¦‚æœè¿™ä¸ªåŒ…ç‰¹åˆ«å¤§ï¼Œå¯ä»¥å°†å®ƒä»¬åˆ†å‰²æˆéæ­£å¼çš„å±‚æ¬¡ç»“æ„ã€‚å¦‚ javax.util åŒ…ä¸­æœ‰ javax.util.concurrent.atomicã€‚è¿™é€šå¸¸ç§°ä¸ºå­åŒ…ï¼Œä½† Java è¯­è¨€å±‚é¢ä¸Šå¹¶æ²¡æœ‰å¯¹è¿™ç§å±‚çº§æä¾›æ”¯æŒã€‚

#### ç±»å’Œæ¥å£

ç±»å’Œæ¥å£ï¼ŒåŒ…æ‹¬æšä¸¾å’Œæ³¨é‡Šç±»å‹çš„å‘½ååº”è¯¥ç”±è‹¥å¹²å•è¯ç»„æˆã€‚å°½é‡ä¸è¦ä½¿ç”¨ç¼©å†™ï¼Œé™¤éæ˜¯é¦–å­—æ¯ç¼©å†™æˆ–å¸¸è§ç¼©å†™ï¼Œå¦‚ max å’Œ minã€‚ä½†å¯¹äºé¦–å­—æ¯ç¼©å†™æ¥è¯´ï¼Œåˆ°åº•åº”è¯¥å…¨éƒ¨å¤§å†™è¿˜æ˜¯åªæœ‰ç¬¬ä¸€ä¸ªå¤§å†™ï¼Œæ²¡æœ‰ç»Ÿä¸€å®šè®ºã€‚ä¸€äº›è®¤ä¸ºåªæœ‰ç¬¬ä¸€ä¸ªè¦å¤§å†™çš„äººè®¤ä¸ºï¼Œå¦‚æœè¿ç»­å‡ºç°å¤šä¸ªé¦–å­—æ¯ç¼©å†™çš„å½¢å¼ï¼Œå°±å¾ˆéš¾åŒºåˆ†ä¸€ä¸ªå•è¯çš„èµ·å§‹å’Œç»“å°¾ï¼Œå¦‚ç±»å HttpUrl æ˜æ˜¾æ¯” HTTPURL æ›´æ¸…æ™°ã€‚

#### æ–¹æ³•å’ŒåŸŸ

æ–¹æ³•å’ŒåŸŸå‘½åä¸ç±»å’Œæ¥å£å‘½åçš„ typographical æƒ¯ä¾‹ç›¸åŒï¼Œé™¤äº†é¦–å­—æ¯å°å†™ã€‚å¦‚æœæ–¹æ³•å’ŒåŸŸåç§°çš„ç¬¬ä¸€ä¸ªå•è¯æ­£å¥½æ˜¯é¦–å­—æ¯çš„ç¼©å†™ï¼Œé‚£ä¹ˆä¹Ÿè¦å°å†™ã€‚

å”¯ä¸€çš„ä¾‹å¤–æ˜¯å¸¸é‡åŸŸï¼Œå®ƒçš„å‘½ååº”è¯¥åŒ…æ‹¬ä¸€ä¸ªå¤§å†™å•è¯æˆ–å¤šä¸ªè¢« â€œ_â€ åˆ†éš”çš„å¤§å†™å•è¯ã€‚å¸¸é‡åŸŸæ˜¯ä¸€ä¸ªå€¼ä¸å¯å˜çš„ static final åŸŸã€‚å¦‚æœä¸€ä¸ª static final åŸŸæœ‰ä¸€ä¸ª primitive ç±»å‹æˆ–è€…ä¸å¯å˜çš„å¼•ç”¨ç±»å‹ï¼ˆè¯¦è§ç¬¬ 17 æ¡ï¼‰ï¼Œé‚£å®ƒå°±æ˜¯ä¸€ä¸ªå¸¸é‡åŸŸï¼›å¦‚æœ static final åŸŸæœ‰ä¸€ä¸ªå¯å˜çš„å¼•ç”¨ç±»å‹ï¼Œä½†å¼•ç”¨çš„å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œé‚£ä¹ˆå®ƒä»ç„¶æ˜¯ä¸€ä¸ªå¸¸é‡åŸŸã€‚

#### å±€éƒ¨å˜é‡

å±€éƒ¨å˜é‡å‘½åä¸ memberï¼ˆæ–¹æ³•å’Œä¸åŸŸï¼‰å‘½åçš„ typographical æƒ¯ä¾‹ç›¸åŒï¼Œä½†å®ƒå…è®¸ç¼©å†™ï¼Œä¹Ÿå…è®¸ç”¨å•ä¸ªå­—ç¬¦æˆ–çŸ­å­—ç¬¦åºåˆ—æ¥å‘½åï¼Œå› ä¸ºå®ƒçš„å«ä¹‰å–å†³äºå®ƒä»¬å‡ºç°çš„ä¸Šä¸‹æ–‡ã€‚

è¾“å…¥å‚æ•°æ˜¯ä¸€ç§ç‰¹æ®Šçš„å±€éƒ¨å˜é‡ï¼Œåº”è¯¥ä»”ç»†å‘½åï¼Œå› ä¸ºå®ƒä»¬çš„å‘½åæ˜¯æ‰€åœ¨æ–¹æ³•çš„æ–‡æ¡£çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ã€‚

#### ç±»å‹å‚æ•°

ç±»å‹å‚æ•°çš„å‘½åé€šå¸¸æ˜¯å•ä¸ªå­—ç¬¦ï¼Œæœ€å¸¸è§çš„æœ‰ä¸‹é¢äº”ç§ï¼š

-   T è¡¨ç¤ºä»»æ„ç±»å‹ï¼Œå¦‚æœè¦è¡¨ç¤ºå¤šä¸ªä»»æ„ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ Tã€Uã€V æˆ– T1ã€T2ã€T3ï¼›
    
-   E è¡¨ç¤ºé›†åˆä¸­çš„å…ƒç´ çš„ç±»å‹ï¼›
    
-   K å’Œ V è¡¨ç¤º map ä¸­çš„ key å’Œ value çš„ç±»å‹ï¼›
    
-   X è¡¨ç¤ºå¼‚å¸¸ï¼›
    
-   R è¡¨ç¤ºå‡½æ•°çš„è¿”å›ç±»å‹ã€‚
    

### è¯­æ³•æƒ¯ä¾‹

è¯­æ³•æƒ¯ä¾‹æ¯”æ’ç‰ˆæƒ¯ä¾‹æ›´çµæ´»ï¼Œä½†ä¹Ÿæ›´æœ‰äº‰è®®ã€‚

æ²¡æœ‰ç»™åŒ…å‘½åçš„è¯­æ³•æƒ¯ä¾‹ã€‚

#### ç±»å’Œæ¥å£

å¯å®ä¾‹åŒ–çš„ç±»ï¼ŒåŒ…æ‹¬æšä¸¾ç±»ï¼Œé€šå¸¸ç”¨ä¸€ä¸ªåè¯æˆ–è€…åè¯çŸ­è¯­å‘½åï¼Œå¦‚ Thread æˆ– PriorityQueueï¼›ä¸å¯å®ä¾‹åŒ–çš„å·¥å…·ç±»ï¼ˆè¯¦è§ç¬¬ 4 æ¡ï¼‰é€šå¸¸ç”¨å¤æ•°åè¯å‘½åï¼Œå¦‚ Collectors æˆ– Collectionsã€‚

æ¥å£çš„å‘½åå’Œç±»ç›¸ä¼¼ï¼Œå¦‚ Collection æˆ– Comparatorï¼›æˆ–è€…ä½¿ç”¨ä¸€ä¸ªä»¥ **able** æˆ– **ible** ç»“å°¾çš„å½¢å®¹è¯å‘½åï¼Œå¦‚ Runnableã€Iterable æˆ– Accessibleã€‚

æ³¨é‡Šç±»å‹ç”±å¤ªå¤šç”¨å¤„ï¼Œæ²¡æœ‰ä¸€ç§ä¸»å¯¼çš„å‘½åæ–¹å¼ã€‚åè¯ã€åŠ¨è¯ã€ä»‹è¯å’Œå½¢å®¹è¯éƒ½å¾ˆå¸¸è§ï¼Œå¦‚ BindingAnnotationã€Injectã€InplementedBy æˆ– Singletonã€‚

#### æ–¹æ³•

-   å®ŒæˆæŸä¸ªåŠ¨ä½œçš„æ–¹æ³•é€šå¸¸ç”¨åŠ¨è¯æˆ–åŠ¨è¯çŸ­è¯­ï¼ˆåŒ…æ‹¬å®¾è¯­ï¼‰ï¼Œå¦‚ append æˆ– drawImageï¼›
    
-   è¿”å› boolean çš„æ–¹æ³•çš„åç§°é€šå¸¸ä»¥ is æˆ– hasï¼ˆæ¯”å‰è€…å°‘è§ï¼‰å¼€å¤´ï¼Œåé¢æ¥ç€ä¸€ä¸ªåè¯ã€åè¯çŸ­è¯­æˆ–è€…ä»»ä½•èƒ½ä½œä¸ºå½¢å®¹è¯çš„å•è¯æˆ–çŸ­è¯­ï¼Œå¦‚ isDigitã€isProbablePrimeã€isEmptyã€isEnabled æˆ– hasSiblings
    
-   è¿”å›è¢«è°ƒç”¨å¯¹è±¡ä¸­é boolean çš„ function æˆ–å±æ€§çš„æ–¹æ³•ï¼Œé€šå¸¸è¢«å‘½åæˆä¸€ä¸ªåè¯ã€åè¯çŸ­è¯­æˆ–è€…æ˜¯ä¸€ä¸ªä»¥ get å¼€å¤´çš„åŠ¨è¯çŸ­è¯­ï¼Œå¦‚ sizeã€hashCode æˆ– getTimeã€‚
    
-   è¿˜æœ‰äº›æ–¹æ³•çš„å‘½åä¼˜ç‚¹ç‰¹æ®Šï¼š
    
    -   è½¬æ¢å¯¹è±¡ç±»å‹çš„å®ä¾‹æ–¹æ³•é€šå¸¸è¢«å‘½åä¸º toTypeï¼Œå¦‚ toString æˆ– toArrayï¼›
        
    -   è¿”å›ä¸€ä¸ªè§†å›¾ï¼ˆè¯¦è§ç¬¬ 6 æ¡ï¼‰çš„æ–¹æ³•ï¼Œå¹¶ä¸”è¿™ä¸ªè§†å›¾çš„ç±»å‹ä¸åŒä¸æ¥æ”¶å¯¹è±¡çš„ç±»å‹ï¼Œè¿™ç§æ–¹æ³•é€šå¸¸è¢«å‘½åä¸º asTypeï¼Œå¦‚ asListï¼›
        
    -   è¿”å›ä¸€ä¸ªä¸è¢«è°ƒç”¨å¯¹è±¡çš„å€¼ç›¸åŒçš„ primitive çš„æ–¹æ³•é€šå¸¸è¢«å‘½åä¸º typeValueï¼Œå¦‚ intValueï¼›
        
    -   é™æ€å·¥å‚çš„å¸¸ç”¨å‘½åæœ‰ï¼šfromã€ofã€valueOfã€instanceã€newInstanceã€getType å’Œ newTypeï¼ˆè¯¦è§ç¬¬ 1 æ¡ï¼‰ã€‚
        

#### åŸŸå’Œå±€éƒ¨å˜é‡

ä¸ç±»ã€æ¥å£å’Œæ–¹æ³•çš„å‘½åç›¸æ¯”ï¼ŒåŸŸå‘½åçš„è¯­æ³•æƒ¯ä¾‹ä¸å¤ªå®Œå–„ï¼Œä¹Ÿä¸å¤ªé‡è¦ï¼Œå› ä¸ºè®¾è®¡è‰¯å¥½çš„ API å‡ ä¹ä¸åŒ…å«ä»»ä½•æš´éœ²çš„å­—æ®µã€‚boolean ç±»å‹çš„å­—æ®µé€šå¸¸åƒ boolean è®¿é—®å™¨æ–¹æ³•ä¸€æ ·å‘½åï¼Œçœç•¥äº†é¦–å­—æ¯ï¼Œä¾‹å¦‚ï¼Œinitialized å’Œ compositeã€‚å…¶ä»–ç±»å‹çš„å­—æ®µé€šå¸¸ç”¨åè¯æˆ–åè¯çŸ­è¯­æ¥å‘½åï¼Œå¦‚ heightã€digits æˆ– bodyStyleã€‚

å±€éƒ¨å˜é‡å‘½åçš„è¯­æ³•æƒ¯ä¾‹ä¸åŸŸå‘½åçš„è¯­æ³•æƒ¯ä¾‹ç›¸ä¼¼ï¼Œä½†æ›´å¼±ä¸€äº›ã€‚

# ä¹. å¼‚å¸¸

å½“å……åˆ†å‘æŒ¥å¼‚å¸¸çš„ä¼˜ç‚¹ï¼Œå¯ä»¥æé«˜ç¨‹åºçš„å¯è¯»æ€§ã€å¯é æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚å¦‚æœä½¿ç”¨ä¸å½“ï¼Œå®ƒä»¬ä¹Ÿä¼šäº§ç”Ÿè´Ÿé¢å½±å“ã€‚

TODOï¼šè¿™ç« çœ‹çš„ä¸å¤ªæ˜ç™½ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯çº¯ç¿»è¯‘ã€‚

## 69. åªåœ¨å¼‚å¸¸æƒ…å†µä¸‹ä½¿ç”¨å¼‚å¸¸

### å¼‚å¸¸ä¸èƒ½ç”¨äºæ§åˆ¶æµç¨‹

// Horrible abuse of exceptions. Don't ever do this!  
try {  
    int i = 0;  
    while(true)  
        range[i++].climb();  
} catch (ArrayIndexOutOfBoundsException e) {  
}

å¦‚æœçœ‹åˆ°ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬ä¼šæ ¹æœ¬ä¸çŸ¥é“å®ƒåœ¨å¹²ä»€ä¹ˆï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ä½¿ç”¨å®ƒçš„åŸå› ï¼ˆè¯¦è§ç¬¬ 67 æ¡ï¼‰ã€‚è¿™ä¸ªæ— é™å¾ªç¯ä¼šåœ¨æ•°ç»„ç¬¬ä¸€æ¬¡è¶Šç•Œçš„æ—¶å€™ï¼Œé€šè¿‡æŠ›å‡ºã€æ•æ‰å’Œå¿½ç•¥ ArrayIndexOutOfBoundsException æ¥è¢«ç»ˆæ­¢ã€‚å†™å‡ºè¿™ç§ä»£ç çš„åŸå› å¯èƒ½æ˜¯æœ‰äººè®¤ä¸ºï¼Œå¦‚æœåœ¨ try-catch ä¸­è®¿é—®æ•°ç»„ï¼ŒJVM å°±ä¸ä¼šæ¯æ¬¡éƒ½è¦æ£€æŸ¥è¶Šç•Œæƒ…å†µï¼Œè€Œ for-each æ¯è½®éƒ½è¦åšè¿™ä¸ªæ£€æŸ¥ã€‚è¿™ä¸ªæƒ³æ³•æ˜æ˜¾æ˜¯é”™çš„ï¼š

-   å¼‚å¸¸æœºåˆ¶æ˜¯ä¸ºäº†ç‰¹æ®Šçš„æƒ…å†µè®¾è®¡çš„ï¼›
    
-   æŠŠä»£ç æ”¾è¿› try-catch å—é‡Œä¼šæŠ‘åˆ¶ JVM å¯èƒ½ä¼šè¿›è¡Œçš„ä¼˜åŒ–ï¼›
    
-   æ ‡å‡†éå†æ•°ç»„ä¸ä¸€å®šä¼šåšå†—ä½™çš„è¶Šç•Œæ£€æŸ¥ï¼Œè®¸å¤š JVM çš„å®ç°éƒ½å¯¹è¿™ä¸ªåšäº†ä¼˜åŒ–ã€‚
    

è¿™ç§åŸºäºå¼‚å¸¸çš„æ•°ç»„éå†æ–¹å¼ï¼Œä¸ä»…æ¨¡ç³Šäº†ä»£ç çš„æ„å›¾ã€é™ä½äº†å®ƒçš„æ€§èƒ½ï¼Œè€Œä¸”å®ƒä¸ä¸€å®šèƒ½æ­£å¸¸å·¥ä½œã€‚å‡è®¾è¿™ä¸ªå¾ªç¯ä¸­è°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè®¿é—®å¦ä¸€ä¸ªæ•°ç»„ï¼Œæ­¤æ—¶å¦‚æœè¶Šç•Œäº†ï¼Œé‚£ä¹ˆå°±ä¼šè¢«è¿™ä¸ªå¾ªç¯å¤–çš„ catch è¯­å¥æ•æ‰åˆ°å¹¶å¿½ç•¥ï¼Œè¿™å°±å¥½åƒæ˜¯æ­£å¸¸çš„æ•°ç»„éå†ç»“æŸã€‚

**å¼‚å¸¸åªåº”è¯¥åœ¨ç‰¹æ®Šæƒ…å†µä¸­ä½¿ç”¨ï¼Œå®ƒä»¬ç»å¯¹ä¸èƒ½ç”¨äºæ§åˆ¶æµç¨‹ä¸­ã€‚**

### API è®¾è®¡

ä¸Šé¢è¿™æ¡åŸåˆ™å¯¹ API ä¹Ÿä½¿ç”¨ã€‚æœ‰ä¸€ä¸ª state-dependent æ–¹æ³•çš„ç±»ï¼ˆè¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨ç‰¹å®šæ¡ä»¶ä¸‹æ‰èƒ½è¢«è°ƒç”¨ï¼‰ï¼Œå¦‚ä½•è®©ç”¨æˆ·ä¸é€šè¿‡å¼‚å¸¸çš„æ–¹å¼æ¥è¿›è¡Œæµç¨‹æ§åˆ¶ã€‚

#### æ–¹å¼ä¸€

æä¾›æœ‰ä¸€ä¸ª state-testing æ–¹æ³•ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯å¦å¯ä»¥è°ƒç”¨ state-dependent æ–¹æ³•ã€‚ä¾‹å¦‚ï¼ŒIterator æ¥å£æœ‰ä¸€ä¸ª state-dependent æ–¹æ³•ï¼šnextï¼Œå’Œå¯¹åº”çš„ state-testing æ–¹æ³•ï¼šhashNextã€‚è¿™å°±é¿å…äº†åœ¨ä½¿ç”¨è¿­ä»£å™¨çš„æ—¶å€™ä¸éœ€è¦é€šè¿‡å¼‚å¸¸æ¥ç»“æŸè¿­ä»£ï¼Œä¾‹å¦‚ä¸‹é¢è¿™æ ·ï¼š

// Do not use this hideous code for iteration over a collection!  
try {  
    Iterator<Foo> i = collection.iterator();  
    while(true) {  
        Foo foo = i.next();  
        ...   
    }  
} catch (NoSuchElementException e) {  
}

#### æ–¹å¼äºŒ

è¿˜æœ‰ä¸€ç§ä¸éœ€è¦ state-testing æ–¹æ³•çš„ API è®¾è®¡æ–¹å¼ï¼šå¦‚æœ state-dependent æ–¹æ³•æ— æ³•æ‰§è¡Œï¼Œå°±è¿”å›ä¸€ä¸ª empty optional æˆ–ä¸€ä¸ªå¯è¯†åˆ«çš„å€¼ï¼Œå¦‚ nullã€‚

#### å¦‚ä½•é€‰æ‹©

-   å¦‚æœä¸€ä¸ªå¯¹è±¡ä¼šè¢«å¼‚æ­¥å¹¶å‘è®¿é—®ï¼Œé‚£å°±å¿…é¡»ç¬¬äºŒç§æ–¹å¼ã€‚å› ä¸ºå¯¹è±¡çš„çŠ¶æ€å¯èƒ½åœ¨ state-testing å’Œ state-dependent è¢«è°ƒç”¨çš„æœŸé—´æ”¹å˜ã€‚
    
-   å¦‚æœç¬¬ä¸€ç§æ–¹å¼çš„ state-testing æ–¹æ³•ä¼šé‡å¤åšäº† state-dependent æ–¹æ³•çš„å·¥ä½œï¼Œå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œä½¿ç”¨ç¬¬äºŒç§æ–¹å¼ã€‚
    
-   å¦‚æœå…¶ä»–æ¡ä»¶éƒ½ç›¸åŒï¼Œé‚£ä¹ˆç¬¬ä¸€ç§æ–¹å¼ä¼šç•¥å¥½ä¸è¿”å›å¯è¯†åˆ«çš„å€¼ï¼ˆæ²¡è¯´ Optionalï¼‰ã€‚å› ä¸ºå®ƒæä¾›äº†ç¨å¾®æ›´å¥½çš„å¯è¯»æ€§ï¼Œå¹¶ä¸”å¯èƒ½æ›´å®¹æ˜“æ£€æµ‹åˆ°é”™è¯¯ï¼šå¦‚æœå¿˜è®°è°ƒç”¨ state-testingï¼Œé‚£ä¹ˆ state-dependent æ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸æ¥è¯´æ˜åŸå› ï¼›ä½†å¦‚æœå¿˜è®°å»æ£€æŸ¥è¿™ä¸ªå¯è¯†åˆ«çš„å€¼ï¼Œå¯èƒ½å°±å¾ˆéš¾æ‰¾åˆ°é”™è¯¯ï¼ˆè¿”å› optional ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼‰ã€‚
    

## 70. å¯¹å¯æ¢å¤çš„æƒ…å†µä½¿ç”¨ checked exceptionï¼Œå¯¹ç¼–ç¨‹é”™è¯¯ä½¿ç”¨ runtime exceptions

Java æä¾›äº†ä¸‰ç§ throwableï¼šchecked exceptionsã€runtime exceptions å’Œ errorsã€‚

æŠ›å‡ºä¸€ä¸ª checked exception è¿˜æ˜¯ä¸€ä¸ª unchecked exception çš„è§„åˆ™å¦‚ä¸‹ï¼šå¦‚æœæœŸæœ›è°ƒç”¨è€…å¯ä»¥é€‚å½“çš„æ¢å¤ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨ checked exceptionã€‚æŠ›å‡º checked exception å°±æ˜¯å¼ºåˆ¶è°ƒç”¨è€…åœ¨ catch è¯­å¥ä¸­å¤„ç†æˆ–ç»§ç»­å‘å¤–æŠ›å‡ºï¼ˆpropageteï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨ catch è¯­å¥ä¸­å¿½ç•¥å¼‚å¸¸ï¼Œä½†è¿™ä¸æ˜¯ä¸€ä¸ªå¥½çš„åšæ³•ï¼ˆè¯¦è§ç¬¬ 77 æ¡ï¼‰ã€‚

unchecked throwable æœ‰ä¸¤ç§ï¼šruntime exceptions å’Œ errorsã€‚å®ƒä»¬çš„è¡Œä¸ºå®Œå…¨ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸åº”è¯¥è¢«æ•æ‰åˆ°ã€‚å¦‚æœç¨‹åºæŠ›å‡ºäº†ä¸€ä¸ª uncheced exception æˆ–è€… errorï¼Œå°±è¯´æ˜å‡ ä¹ä¸å¯èƒ½ä»ä¸­æ¢å¤ï¼Œå¹¶ä¸”ç»§ç»­æ‰§è¡Œå¼Šå¤§äºåˆ©ã€‚

ä½¿ç”¨ runtime exceptions æ¥è¡¨æ˜ç¼–ç¨‹é”™è¯¯ã€‚å¤§éƒ¨åˆ† runtime exception éƒ½è¡¨ç¤ºè¿åå‰ç½®æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯æŒ‡è¿å API çš„çº¦å®šã€‚ä¾‹å¦‚ï¼Œæ•°ç»„è®¿é—®çš„çº¦å®šæŒ‡æ˜äº†ä¸‹æ ‡å¿…é¡»åœ¨ 0 å’Œæ•°ç»„é•¿åº¦ - 1 ä¹‹é—´ï¼ŒArrayIndexOutOfBoundsException è¡¨æ˜è¿åäº†è¿™ä¸ªå‰ç½®æ¡ä»¶ã€‚

ä½†å¯æ¢å¤çš„æƒ…å†µå’Œç¼–ç¨‹é”™è¯¯çš„ç•Œé™å¾ˆæ¨¡ç³Šã€‚æ¯”å¦‚ï¼Œå¦‚æœèµ„æºä¸å¤Ÿï¼Œæ—¢å¯èƒ½æ˜¯ç¼–ç¨‹é”™è¯¯å¼•èµ·çš„ï¼Œæ¯”å¦‚åˆ†é…äº†ä¸€ä¸ªä¸åˆç†çš„è¿‡å¤§çš„æ•°ç»„ï¼›ä¹Ÿæœ‰å¯èƒ½æ˜¯çŸ­æš‚çš„èµ„æºçŸ­ç¼ºï¼Œè¿™ç§æƒ…å†µå°±æ˜¯å¯æ¢å¤çš„ã€‚API çš„è®¾è®¡è€…éœ€è¦åˆ¤æ–­è¿™æ ·çš„èµ„æºä¸å¤Ÿæ˜¯å¦å¯ä»¥æ¢å¤ã€‚å¦‚æœç›¸ä¿¡å¯ä»¥æ¢å¤ï¼Œé‚£å°±ä½¿ç”¨ checked exceptionï¼›å¦åˆ™å°±ä½¿ç”¨ runtime exceptionã€‚å¦‚æœåˆ¤æ–­ä¸äº†æ˜¯å¦å¯æ¢å¤ï¼Œé‚£ä¹ˆæœ€å¥½æŠ›å‡ºä¸€ä¸ª unchecked exceptionï¼ŒåŸå› è¯¦è§ç¬¬ 71 æ¡ã€‚

æŒ‰ç…§æƒ¯ä¾‹ï¼Œerrors é€šå¸¸è¢« JVM ä¿ç•™ä½¿ç”¨ï¼Œç”¨æ¥è¡¨ç¤ºèµ„æºçŸ­ç¼ºã€çº¦æŸå¤±è´¥ï¼ˆinvariant failureï¼‰æˆ–è€…å…¶ä»–ä½¿ç¨‹åºæ— æ³•ç»§ç»­è¿è¡Œçš„æƒ…å†µã€‚æ‰€ä»¥æœ€å¥½ä¸è¦å»å®ç°ä»»ä½•æ–°çš„ Error å­ç±»ã€‚å› æ­¤ï¼Œ æ‰€å®ç°çš„æ‰€æœ‰ unchecked throwables éƒ½åº”è¯¥æ˜¯ RuntimeException çš„å­ç±»ã€‚ ä¸ä»…ä¸åº”è¯¥å®šä¹‰ Error å­ç±»ï¼Œç”šè‡³ä¹Ÿä¸åº”è¯¥æŠ›å‡º AssertionError å¼‚å¸¸ã€‚

è¦æƒ³å®šä¹‰ä¸€ä¸ª throwableï¼Œä½¿å®ƒä¸æ˜¯ Exceptionã€RuntimeException æˆ– Error çš„å­ç±»ï¼Œè¿™ä¹Ÿæ˜¯å¯èƒ½çš„ã€‚JLS å¹¶æ²¡æœ‰ç›´æ¥è§„å®šè¿™æ ·çš„ throwableï¼Œè€Œæ˜¯éšå¼åœ°æŒ‡å®šäº†å®ƒä»¬çš„è¡Œä¸ºç­‰åŒäºæ™®é€šçš„ checked exceptionsï¼ˆå³ Exception çš„å­ç±»ã€‚é‚£ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨è¿™æ ·çš„ throwable å‘¢ï¼Ÿä¸€å¥è¯ï¼šæ°¸è¿œä¹Ÿä¸ä¼šç”¨åˆ°ã€‚å®ƒä¸æ™®é€šçš„ checked exceptions ç›¸æ¯”æ²¡æœ‰ä»»ä½•ç›Šå¤„ï¼Œåªä¼šå›°æ‰° API çš„ç”¨æˆ·ã€‚

API çš„è®¾è®¡è€…å¾€å¾€ä¼šå¿˜è®°ï¼Œå¼‚å¸¸ä¹Ÿæ˜¯ä¸ªå®Œå…¨æ„ä¹‰ä¸Šçš„å¯¹è±¡ï¼Œå¯ä»¥åœ¨å®ƒä¸Šé¢å®šä¹‰ä»»æ„çš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•çš„ä¸»è¦ç”¨é€”æ˜¯ä¸ºæ•è·å¼‚å¸¸çš„ä»£ç è€Œæä¾›é¢å¤–çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å…³äºå¼•å‘è¿™ä¸ªå¼‚å¸¸çš„æƒ…å†µçš„ä¿¡æ¯ã€‚å¦‚æœæ²¡æœ‰è¿™æ ·çš„æ–¹æ³•ï¼Œç¨‹åºå‘˜å¿…é¡»è¦æ‡‚å¾—å¦‚ä½•è§£æ â€œè¯¥å¼‚å¸¸çš„å­—ç¬¦ä¸²è¡¨ç¤ºæ³•â€ï¼Œä»¥ä¾¿è·å¾—è¿™äº›é¢å¤–ä¿¡æ¯ã€‚è¿™æ˜¯æä¸ºä¸å¥½çš„åšæ³•ï¼ˆè¯¦è§ç¬¬ 12 æ¡ï¼‰ã€‚ç±»å¾ˆå°‘ä¼šæŒ‡å®šå®ƒä»¬çš„å­—ç¬¦ä¸²è¡¨ç¤ºæ³•ä¸­çš„ç»†èŠ‚ï¼Œå› æ­¤ï¼Œå¯¹äºä¸åŒçš„å®ç°åŠä¸åŒçš„ç‰ˆæœ¬ï¼Œå­—ç¬¦ä¸²è¡¨ç¤ºæ³•ä¼šå¤§ç›¸å¾„åº­ã€‚ç”±æ­¤å¯è§ï¼Œâ€œè§£æå¼‚å¸¸çš„å­—ç¬¦ä¸²è¡¨ç¤ºæ³•â€ çš„ä»£ç å¯èƒ½æ˜¯ä¸å¯ç§»æ¤çš„ï¼Œä¹Ÿæ˜¯éå¸¸è„†å¼±çš„ã€‚

å› ä¸º checked exceptions **å¾€å¾€æŒ‡æ˜äº†å¯æ¢å¤çš„æ¡ä»¶**ï¼Œæ‰€ä»¥ï¼Œå¯¹äºè¿™æ ·çš„å¼‚å¸¸ï¼Œæä¾›ä¸€äº›è¾…åŠ©æ–¹æ³•å°¤å…¶é‡è¦ï¼Œé€šè¿‡è¿™äº›æ–¹æ³•ï¼Œè°ƒç”¨è€…å¯ä»¥è·å¾—ä¸€äº›æœ‰åŠ©äºæ¢å¤çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå‡è®¾å› ä¸ºç”¨æˆ·èµ„é‡‘ä¸è¶³ï¼Œå½“ä»–ä¼å›¾è´­ä¹°ä¸€å¼ ç¤¼å“å¡æ—¶å¯¼è‡´å¤±è´¥ï¼Œäºæ˜¯æŠ›å‡ºä¸€ä¸ªå—æ£€çš„å¼‚å¸¸ã€‚è¿™ä¸ªå¼‚å¸¸åº”è¯¥æä¾›ä¸€ä¸ªè®¿é—®æ–¹æ³•ï¼Œä»¥ä¾¿å…è®¸å®¢æˆ·æŸ¥è¯¢æ‰€ç¼ºçš„è´¹ç”¨é‡‘é¢ï¼Œä½¿å¾—è°ƒç”¨è€…å¯ä»¥å°†è¿™ä¸ªæ•°å€¼ä¼ é€’ç»™ç”¨æˆ·ã€‚å…³äºè¿™ä¸ªä¸»é¢˜çš„æ›´å¤šè¯¦æƒ…ï¼Œè¯·å‚é˜…ç¬¬ 75 æ¡ ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œå¯¹äºå¯æ¢å¤çš„æƒ…å†µ ï¼Œè¦æŠ›å‡º checked exceptionsï¼›å¯¹äºç¨‹åºé”™è¯¯ï¼Œè¦æŠ›å‡º runtime exceptionsã€‚ä¸ç¡®å®šæ˜¯å¦å¯æ¢å¤ï¼Œåˆ™æŠ›å‡º unchecked exceptionsã€‚ä¸è¦å®šä¹‰ä»»ä½•æ—¢ä¸æ˜¯å—æ£€å¼‚å¸¸ä¹Ÿä¸æ˜¯è¿è¡Œæ—¶å¼‚å¸¸çš„ throwableã€‚è¦åœ¨ checked exceptions ä¸Šæä¾›æ–¹æ³•ï¼Œä»¥ä¾¿ååŠ©æ¢å¤ã€‚

## 71. é¿å…æ»¥ç”¨ checked exceptions

### checked exceptions å¸¦æ¥çš„è´Ÿæ‹…

> è´Ÿæ‹…æŒ‡çš„æ˜¯å¿…é¡»ç¼–å†™çš„ try-catch å—ã€‚

æ­£ç¡®ä½¿ç”¨ checked exceptions å¯ä»¥æ”¹å–„ API å’Œç¨‹åºã€‚å®ƒä»¬å¼ºè¿«ç¨‹åºå‘˜å»å¤„ç†å¼‚å¸¸ï¼Œå¢åŠ å¯é æ€§ã€‚ä½†å¦‚æœè¿‡åˆ†ä½¿ç”¨å°±ä¼šä½¿ API ä½¿ç”¨èµ·æ¥å¾ˆä¸æ–¹ä¾¿ã€‚å¦‚æœæ–¹æ³•æŠ›å‡ºäº† checked excetpionsï¼Œé‚£ä¹ˆè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„ä»£ç å°±å¿…é¡»å¤„ç†ä»–ä»¬ï¼Œè¦ä¹ˆä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ª catch å—ï¼Œè¦ä¹ˆå°†å®ƒä»¬ä¼ æ’­å‡ºå»ã€‚è¿™ä¸ªè´Ÿæ‹…åœ¨ Java 8 ä¹‹åä¼šåŠ é‡ï¼Œå› ä¸ºæŠ›å‡º checked exception çš„æ–¹æ³•ä¸èƒ½ç›´æ¥åœ¨ Stream ä¸­ä½¿ç”¨ï¼ˆè¯¦è§ 45-48 æ¡ï¼‰ã€‚

å¦‚æœæ­£ç¡®åœ°ä½¿ç”¨ API ä¸èƒ½é˜²æ­¢è¿™ç§ç‰¹æ®Šæƒ…å†µçš„å‘ç”Ÿï¼Œè€Œä¸”ä½¿ç”¨ API çš„ç¨‹åºå‘˜åœ¨é‡åˆ°è¿™ç§å¼‚å¸¸æ—¶å¯ä»¥é‡‡å–ä¸€äº›æœ‰ç”¨çš„æªæ–½ï¼Œé‚£ä¹ˆè¿™ç§è´Ÿæ‹…å¯èƒ½æ˜¯åˆç†çš„ã€‚é™¤éè¿™ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ï¼Œå¦åˆ™å¯ä»¥ä½¿ç”¨ unchecked exceptionã€‚

å¦‚æœåªæ˜¯åƒä¸‹é¢è¿™æ ·å¤„ç†ï¼Œé‚£ä¹ˆæœ€å¥½ä½¿ç”¨ unchecked exceptionï¼š

} catch (TheCheckedException e) {  
    throw new AssertionError(); // Can't happen!  
}  
  
  
} catch (TheCheckedException e) {  
    e.printStackTrace();        // Oh well, we lose.  
    System.exit(1);  
}

å¦‚æœè¿™æ˜¯ä¸€ä¸ªæ–¹æ³•æŠ›å‡ºçš„å”¯ä¸€ä¸€ä¸ªè¢« checked exceptionï¼Œé‚£ä¹ˆç¨‹åºå‘˜æ‰€æ‰¿å—çš„é¢å¤–è´Ÿæ‹…å°±ä¼šå¤§å¤§å¢åŠ ï¼Œå¿…é¡»ä¸ºè¿™å”¯ä¸€ä¸€ä¸ªå¼‚å¸¸ç¼–å†™ try-catch å—ã€‚å¦‚æœè¯¥æ–¹æ³•è¿˜æœ‰å…¶ä»–çš„å¼‚å¸¸ï¼Œé‚£ä¹ˆè¿™ä¸ªå¼‚å¸¸æœ€å¤šåªéœ€è¦æ·»åŠ ä¸€ä¸ª catch å—å³å¯ã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•åªæŠ›å‡ºäº†ä¸€ä¸ª checked exceptionï¼Œé‚£ä¹ˆè¿™ä¸ªå¼‚å¸¸å°±æ˜¯å¿…é¡»ä½¿ç”¨ try-catch å—è°ƒç”¨è¯¥æ–¹æ³•çš„å”¯ä¸€åŸå› ï¼Œä¹Ÿæ˜¯ä¸èƒ½ç›´æ¥ç”¨äº Stream ä¸­çš„å”¯ä¸€åŸå› ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦é—®è‡ªå·±æ˜¯å¦æœ‰åŠæ³•é¿å…è¿™ä¸ª checked exceptionã€‚

### æ¶ˆé™¤ check exception

#### è¿”å› Optional

æœ€ç®€å•çš„æ–¹æ³•æ˜¯è¿”å›ä¸€ä¸ª `Optional`ï¼ˆè¯¦è§ç¬¬ 55 æ¡ï¼‰ã€‚è¯¥æ–¹æ³•æ²¡æœ‰æŠ›å‡ºä¸€ä¸ª checked exceptionï¼Œè€Œæ˜¯ç®€å•åœ°è¿”å›ä¸€ä¸ª empty optioanlã€‚è¿™ç§æŠ€æœ¯çš„ç¼ºç‚¹æ˜¯ï¼Œè¯¥æ–¹æ³•ä¸èƒ½è¿”å›ä»»ä½•é¢å¤–çš„ä¿¡æ¯æ¥è¯¦ç»†è¯´æ˜å®ƒæ‰€ä¸èƒ½æ‰§è¡Œæ‰€éœ€çš„è®¡ç®—ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¼‚å¸¸æœ‰æè¿°æ€§çš„ç±»å‹ï¼Œå¹¶ä¸”å¯ä»¥å¯¼å‡ºæ–¹æ³•æ¥æä¾›é¢å¤–çš„ä¿¡æ¯ï¼ˆè¯¦è§ç¬¬ 70 æ¡ï¼‰ã€‚

### é‡æ„æ–¹æ³•

é€šè¿‡å°†ä¸€ä¸ªæ–¹æ³•æ‹†åˆ†æˆä¸¤ä¸ªæ–¹æ³•ï¼Œä»è€Œå°† checked exception è½¬åŒ–ä¸º unchecked exceptionï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•è¿”å› boolean æ¥è¯´æ˜æ˜¯å¦è¯¥æŠ›å‡ºå¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œå°†ä¸‹é¢çš„ä»£ç 

// Invocation with checked exception  
try {  
    obj.action(args);  
} catch (TheCheckedException e) {  
    ... // Handle exceptional condition  
}

é‡æ„ä¸ºï¼š

// Invocation with state-testing method and unchecked exception  
if (obj.actionPermitted(args)) {  
    obj.action(args);  
} else {  
    ... // Handle exceptional condition  
}

è¿™ç§é‡æ„å¹¶ä¸æ€»æ˜¯åˆé€‚çš„ï¼Œä½†åœ¨åˆé€‚çš„æƒ…å†µä¸‹ï¼Œå®ƒå¯ä»¥ä½¿ä¸€ä¸ª API æ›´å®¹æ˜“ä½¿ç”¨ã€‚è™½ç„¶åè€…çš„è°ƒç”¨åºåˆ—å¹¶ä¸æ¯”å‰è€…æ›´æ¼‚äº®ï¼Œä½†é‡æ„åçš„ API æ›´åŠ çµæ´»ã€‚å¦‚æœç¨‹åºå‘˜çŸ¥é“è°ƒç”¨ä¼šæˆåŠŸï¼Œæˆ–è€…æ»¡è¶³äºè®©çº¿ç¨‹åœ¨å¤±è´¥æ—¶ç»ˆæ­¢ï¼Œé‡æ„ä¹Ÿå…è®¸è¿™ç§çç¢çš„è°ƒç”¨åºåˆ—ï¼š

obj.action(args);

å¦‚æœä½ è®¤ä¸ºè¿™ç§çç¢çš„è°ƒç”¨åºåˆ—ä¼šæ˜¯æ ‡å‡†æ–¹å¼ï¼ˆTODOï¼šè¿™å¥è¯æ²¡æ˜ç™½ï¼Œçç¢åˆ°åº•æŒ‡çš„æ˜¯ä»€ä¹ˆï¼‰ï¼Œé‚£ä¹ˆ API é‡æ„å°±å¯èƒ½æ˜¯åˆé€‚çš„ã€‚è¿™ç§æ–¹å¼çš„ API æœ¬è´¨ä¸Šæ˜¯ç¬¬ 69 æ¡ä¸­çš„ state-testing æ–¹æ³• APIï¼ŒåŒæ ·çš„æ³¨æ„äº‹é¡¹ä¹Ÿé€‚ç”¨ï¼š

1.  å¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨æ²¡æœ‰å¤–éƒ¨åŒæ­¥çš„æƒ…å†µä¸‹è¢«å¹¶å‘è®¿é—®ï¼Œæˆ–è€…å®ƒå—åˆ°å¤–éƒ¨å¼•èµ·çš„çŠ¶æ€è½¬æ¢çš„å½±å“ï¼Œè¿™ç§é‡æ„æ˜¯ä¸åˆé€‚çš„ï¼Œå› ä¸ºå¯¹è±¡çš„çŠ¶æ€å¯èƒ½åœ¨è°ƒç”¨ `actionPermitted` å’Œ `action` ä¹‹é—´å‘ç”Ÿå˜åŒ–ã€‚
    
2.  å¦‚æœä¸€ä¸ªå•ç‹¬çš„ `actionPermitted` æ–¹æ³•ä¼šé‡å¤ `action` æ–¹æ³•çš„å·¥ä½œï¼Œé‚£ä¹ˆåŸºäºæ€§èƒ½åŸå› ï¼Œè¿™ç§é‡æ„å¯èƒ½ä¼šè¢«æ’é™¤ã€‚
    

### æ€»ç»“

æ€»è€Œè¨€ä¹‹ï¼Œå½“å°‘ç”¨ checked exceptions æ—¶å¯ä»¥æé«˜ç¨‹åºçš„å¯é æ€§ï¼›å½“è¿‡åº¦ä½¿ç”¨æ—¶ï¼Œå®ƒä»¬ä¼šä½¿ API çš„ä½¿ç”¨å˜å¾—å¾ˆç—›è‹¦ã€‚å¦‚æœè°ƒç”¨è€…æ— æ³•ä»å¤±è´¥ä¸­æ¢å¤ï¼Œé‚£ä¹ˆå°±æŠ›å‡º unchecked exceptionã€‚å¦‚æœæ¢å¤æ˜¯å¯èƒ½çš„ï¼Œå¹¶ä¸”ä½ æƒ³å¼ºè¿«è°ƒç”¨è€…å¤„ç†å¼‚å¸¸æƒ…å†µï¼Œé¦–å…ˆè€ƒè™‘è¿”å›ä¸€ä¸ª `Optional`ã€‚åªæœ‰å½“è¿™åœ¨å¤±è´¥çš„æƒ…å†µä¸‹æä¾›çš„ä¿¡æ¯ä¸è¶³æ—¶ï¼Œä½ æ‰åº”è¯¥æŠ›å‡ºä¸€ä¸ªæ£€ checked exceptionsã€‚

## 72. ä¼˜å…ˆä½¿ç”¨æ ‡å‡†å¼‚å¸¸

### é‡ç”¨æ ‡å‡†å¼‚å¸¸çš„å¥½å¤„

ä¸“ä¸šçš„ç¨‹åºå‘˜å’Œæ™®é€šç¨‹åºå‘˜ä¸€ä¸ªå¾ˆå¤§çš„åŒºåˆ«å°±æ˜¯å‰è€…èƒ½å®Œæˆé«˜æ°´å¹³çš„ä»£ç é‡ç”¨ï¼Œå¼‚å¸¸ä¹Ÿåœ¨è¿™ä¸ªé‡ç”¨èŒƒå›´å†…ã€‚Java ç±»åº“æä¾›äº†æä¾›äº†è®¸å¤šå¼‚å¸¸ç±»ï¼Œè¦†ç›–äº†ç»å¤§éƒ¨åˆ† API çš„æŠ›å‡ºå¼‚å¸¸éœ€æ±‚ã€‚å¥½å¤„æœ‰ä¸‰ä¸ªï¼Œä»å¤§åˆ°å°ï¼š

1.  å¯ä»¥ä½¿ API æ›´å®¹æ˜“å­¦ä¹ ï¼Œå› ä¸ºå®ƒä¸ç¨‹åºå‘˜å·²ç»ç†Ÿæ‚‰çš„ä¹ æƒ¯ç”¨æ³•ä¸€è‡´ï¼›
    
2.  å¯è¯»æ€§æ›´å¥½ï¼Œå› ä¸ºä¸ä¼šå‡ºç°ç¨‹åºå‘˜ä¸ç†Ÿæ‚‰çš„å¼‚å¸¸ï¼›
    
3.  å¼‚å¸¸ç±»è¶Šå°‘ï¼Œæ„å‘³ç€æ›´å°‘çš„å†…å­˜å ç”¨ï¼ˆfootpritnï¼‰å’Œæ›´å°‘çš„ç±»åŠ è½½æ—¶é—´ã€‚
    

### å¸¸è§çš„å¯ä»¥è¢«é‡ç”¨çš„å¼‚å¸¸

![Screen Shot 2021-06-21 at 23.10.18](https://chp-image-hosting.oss-cn-hangzhou.aliyuncs.com/uPic/Screen%20Shot%202021-06-21%20at%2023.10.18.png)

æœ€å¸¸ç”¨çš„å¼‚å¸¸ä¾¿æ˜¯ `IllegalArgumentException`ï¼ˆè¯¦è§ç¬¬ 49 æ¡ï¼‰ã€‚å½“è°ƒç”¨è€…ä¼ çš„å‚æ•°ä¸åˆé€‚çš„æ—¶å€™ï¼Œå¾€å¾€å¯ä»¥æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚

å¦ä¸€ä¸ªå¸¸ç”¨çš„å¼‚å¸¸æ˜¯ `IllegalStateException`ã€‚å› ä¸ºä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€ï¼Œå¯¼è‡´å½“å‰è°ƒç”¨çš„æ–¹æ³•æ˜¯éæ³•çš„ï¼Œè¿™ç§æƒ…å†µä¸‹å¾€å¾€æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè°ƒç”¨è€…åœ¨æŸä¸ªå¯¹è±¡æœªæ­£ç¡®åˆå§‹åŒ–ä¹‹å‰ï¼Œè¯•å›¾å»ä½¿ç”¨è¿™ä¸ªå¯¹è±¡ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´è¿™ä¸ªå¼‚å¸¸ã€‚

æ¯ä¸ªå‘ç”Ÿé”™è¯¯çš„æ–¹æ³•éƒ½å¯ä»¥å½’ç»“ä¼š illegal arugument æˆ– illegal stateï¼Œä½†æœ‰äº›å¼‚å¸¸ä¸“é—¨ç”¨äºå¯¼è‡´ illegal arugument æˆ– illegal state åŸå› ä¸­çš„æŸä¸€ç§ã€‚å¦‚æœè°ƒç”¨è€…ä¼ çš„å‚æ•°ä¸­æœ‰ nullï¼Œä½†è¢«è°ƒç”¨æ–¹æ³•ä¸èƒ½æ¥æ”¶ nullï¼ŒæŒ‰ç…§ä¹ æƒ¯åº”è¯¥æŠ›å‡º `NullPointerException` è€Œä¸æ˜¯ `IllegalArgumentException`ï¼›ç±»ä¼¼çš„ï¼Œæ•°ç»„æˆ– List è¶Šç•Œçš„æ—¶å€™ï¼Œä¹ æƒ¯æŠ›å‡º `IndexOutOfBoundsException` è€Œä¸æ˜¯ `IllegalArgumentException`ã€‚

å¦ä¸€ä¸ªå¯é‡ç”¨çš„å¼‚å¸¸æ˜¯ `ConcurrentModificationException`ã€‚å¦‚æœä¸€ä¸ªä¸“ä¸ºå•çº¿ç¨‹ï¼ˆæˆ–æœ‰å¤–éƒ¨åŒæ­¥æœºåˆ¶ï¼‰è®¾è®¡çš„å¯¹è±¡è¢«å¹¶å‘ä¿®æ”¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚è¿™ä¸ªå¼‚å¸¸æœ€å¤šå°±æ˜¯ä¸ªæå‡ï¼Œå› ä¸ºä¸å¯èƒ½å¯é åœ°æ£€æµ‹åˆ°å¹¶å‘ä¿®æ”¹ã€‚

æœ€åä¸€ä¸ªå€¼å¾—æ³¨æ„çš„æ ‡å‡†å¼‚å¸¸æ˜¯ `UnsupportedOperationException`ã€‚å½“æŸä¸ªå¯¹è±¡ä¸æ”¯æŒæŸä¸ªæ“ä½œæ—¶ï¼Œå°±å¯ä»¥æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚è¿™ä¸ªå¼‚å¸¸ç”¨çš„å¾ˆå°‘ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å¯¹è±¡éƒ½èƒ½æ”¯æŒå®ƒä»¬æ‰€æœ‰çš„æ–¹æ³•ã€‚ä¸€èˆ¬åœ¨è¿™ç§æƒ…å†µä¼šç”¨åˆ°ï¼šä¸€äº›ç±»å®ç°äº†ä¸€ä¸ªæ¥å£ï¼Œä½†æ˜¯æ¥å£ä¸­æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå¯é€‰æ–¹æ³•ï¼Œè¿™äº›ç±»æ— æ³•å®ç°ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªåªæ”¯æŒæ·»åŠ çš„ List å®ç°ç±»ï¼Œåœ¨è¢«è°ƒç”¨åˆ é™¤å…ƒç´ çš„æ–¹æ³•æ—¶ï¼Œå¯ä»¥æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚

> é€‰æ‹©é‡ç”¨å“ªç§å¼‚å¸¸å¹¶éæ€»æ˜¯é‚£ä¹ˆç²¾ç¡®ï¼Œå› ä¸ºè¿™äº›å¼‚å¸¸çš„ä½¿ç”¨åœºåˆå¹¶ä¸æ˜¯ç›¸äº’æ’æ–¥çš„ã€‚
> 
> ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªæ–¹æ³•æ¥å—ä¸€ä¸ª handSize å‚æ•°æ¥ä»ä¸€å‰¯ç‰Œä¸­æ‹¿å» handSize å¼ ç‰Œã€‚å¦‚æœ handSize è¶…è¿‡äº†ç‰Œçš„æ•°é‡ï¼Œæ—¢å¯ä»¥è¢«è§£é‡Šæˆ `IllegalArgumentException`ï¼ˆhandSize å¤ªå¤§ï¼‰ï¼Œä¹Ÿå¯ä»¥è¢«è§£é‡Šæˆ `IllegalStateException` ï¼ˆç‰Œå¤ªå°‘ï¼‰ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œ**throw IllegalStateException if no argument values would have worked, otherwise throw IllegalArgumentException**ã€‚

### ç‰¹æ®Šæƒ…å†µä¸‹ä¹Ÿå¯ä»¥é‡ç”¨å¼‚å¸¸

æœ‰äº›å¼‚å¸¸ä¸€èˆ¬åœ¨ç‰¹æ®Šæƒ…å†µä¸‹é‡ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨å®ç°å¦‚å¤æ•°æˆ–åˆ†æ•°ç­‰çš„ç®—æœ¯å¯¹è±¡æ—¶ï¼Œå¯ä»¥é‡ç”¨ `ArithmeticExceptio` å’Œ `NumberFormatException`ï¼›

å¦‚æœè§‰å¾—ä¸€ä¸ªå¼‚å¸¸ç¬¦åˆéœ€è¦ï¼Œå¹¶ä¸”æŠ›å‡ºçš„æ¡ä»¶ä¸å¼‚å¸¸æ–‡æ¡£æè¿°ä¸€è‡´ï¼Œé‚£ä¹ˆå°±æ”¾å¿ƒåœ°ä½¿ç”¨å®ƒã€‚å¦‚æœéœ€è¦åœ¨å¼‚å¸¸ä¸­æ·»åŠ æ›´å¤šä¿¡æ¯ï¼ˆè¯¦è§ç¬¬ 75 æ¡ï¼‰ï¼Œä¹Ÿå¯ä»¥æ”¾å¿ƒåœ°å»ç»§æ‰¿æ ‡å‡†å¼‚å¸¸ï¼Œä½†è¦è®°ä½ï¼Œå¼‚å¸¸éƒ½æ˜¯å¯åºåˆ—åŒ–çš„ï¼ˆè¯¦è§ç¬¬ 12 ç« ï¼‰ã€‚åŒæ ·ï¼Œè¿™ä¹Ÿæ­£æ˜¯ã€Œæ²¡æœ‰å¥½çš„ç†ç”±å°±ä¸è¦ç¼–å†™è‡ªå·±çš„å¼‚å¸¸ç±»ã€çš„åŸå› ã€‚

### ä¸èƒ½ç›´æ¥é‡ç”¨çš„å¼‚å¸¸

ä¸è¦ç›´æ¥é‡ç”¨ `Exception`ã€`RuntimeException`ã€`Throwable` å’Œ `Error`ã€‚æŠŠè¿™äº›ç±»å½“ä½œæ˜¯æŠ½è±¡çš„ã€‚ä½ ä¸èƒ½å¯é åœ°æµ‹è¯•è¿™äº›å¼‚å¸¸ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ä¸€ä¸ªæ–¹æ³•å¯èƒ½æŠ›å‡ºçš„å…¶ä»–å¼‚å¸¸çš„è¶…ç±»ã€‚ï¼ˆTODOï¼šè¿™æ®µè¯ä¸æ˜ç™½ï¼‰

## 73. æŠ›å‡ºé€‚åˆæŠ½è±¡çš„å¼‚å¸¸

å¦‚æœæ–¹æ³•æŠ›å‡ºäº†ä¸€ä¸ªä¸æ–¹æ³•æ‰§è¡Œçš„ä»»åŠ¡å®Œå…¨æ— å…³çš„å¼‚å¸¸æ—¶ï¼Œä¼šä½¿äººå¾ˆè¿·æƒ‘ã€‚å½“ä¸€ä¸ªæ–¹æ³•ä¼ æ’­ä¸€ä¸ªç”±ä½å±‚æŠ½è±¡æŠ›å‡ºçš„å¼‚å¸¸æ—¶ï¼Œè¿™ç§æƒ…å†µç»å¸¸å‘ç”Ÿã€‚è¿™ä¸ä»…ä»¤äººå›°æƒ‘ï¼Œè€Œä¸”ä¼šä½¿ä¸Šå±‚çš„ API å—åˆ°å®ç°ç»†èŠ‚çš„æ±¡æŸ“ã€‚å¦‚æœä¸Šå±‚çš„å®ç°åœ¨ä»¥åçš„ç‰ˆæœ¬ä¸­å‘ç”Ÿå˜åŒ–ï¼Œå®ƒæŠ›å‡ºçš„å¼‚å¸¸ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œæœ‰å¯èƒ½ä¼šç ´åç°æœ‰çš„å®¢æˆ·ç«¯ç¨‹åºã€‚

### å¼‚å¸¸è½¬è¯‘

#### ä»‹ç»

ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œé«˜å±‚åœ¨æ•æ‰åˆ°åº•å±‚æŠ›å‡ºçš„å¼‚å¸¸æ—¶ï¼Œåº”è¯¥æŠ›å‡ºå¯ä»¥æŒ‰æ›´é«˜å±‚æŠ½è±¡æ¥è§£é‡Šçš„å¼‚å¸¸ã€‚è¿™ç§åšæ³•å«åšå¼‚å¸¸è½¬è¯‘ï¼ˆexception translationï¼‰ï¼š

// Exception Translation  
try {  
    ... // Use lower-level abstraction to do our bidding  
} catch (LowerLevelException e) {  
    throw new HigherLevelException(...);  
}

è¿˜æœ‰ä¸€ä¸ª `AbstractSequentialList` çš„ä¾‹å­ï¼Œå®ƒæ˜¯ `List` æ¥å£çš„ä¸€ä¸ªéª¨æ¶å®ç°ï¼ˆskeletal implementationï¼Œè¯¦è§ç¬¬ 20 æ¡ï¼‰ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒæŒ‰ç…§ `List<E>` æ¥å£ ä¸­ `get` æ–¹æ³•çš„è§„èŒƒè¦æ±‚ï¼Œå¼‚å¸¸è½¬è¯‘æ˜¯å¿…éœ€çš„ï¼š

/**  
* Returns the element at the specified position in this list. * @throws IndexOutOfBoundsException if the index is out of range * ({@code index < 0 || index >= size()}).  
*/  
   
public E get(int index) {  
    ListIterator<E> i = listIterator(index);  
    try {  
        return i.next();  
    } catch (NoSuchElementException e) {  
        throw new IndexOutOfBoundsException("Index: " + index);  
    }  
}

#### å¼‚å¸¸é“¾

ä¸€ç§ç‰¹æ®Šçš„å¼‚å¸¸è½¬è¯‘å½¢å¼ç§°ä¸ºå¼‚å¸¸é“¾ï¼ˆexception chainingï¼‰ï¼Œå¦‚æœä½å±‚çš„å¼‚å¸¸å¯¹äºè°ƒè¯•å¯¼è‡´é«˜å±‚å¼‚å¸¸çš„é—®é¢˜éå¸¸æœ‰å¸®åŠ©ï¼Œä½¿ç”¨å¼‚å¸¸é“¾å°±å¾ˆåˆé€‚ã€‚ä½å±‚çš„å¼‚å¸¸ï¼ˆcauseï¼‰è¢«ä¼ åˆ°é«˜å±‚çš„å¼‚å¸¸ï¼Œé«˜å±‚çš„å¼‚å¸¸æä¾›è®¿é—®æ–¹æ³•ï¼ˆThrowable çš„ `getCause` æ–¹æ³•ï¼‰æ¥è·å¾—ä½å±‚çš„å¼‚å¸¸ï¼š

// Exception Chaining  
try {  
    ... // Use lower-level abstraction to do our bidding  
} catch (LowerLevelException cause) {   
    throw new HigherLevelException(cause);  
}

é«˜å±‚å¼‚å¸¸çš„æ„é€ å™¨å°† cause ä¼ é€’ç»™èƒ½è¯†åˆ«å¼‚å¸¸é“¾ï¼ˆchaining-awareï¼‰çš„è¶…ç±»æ„é€ å™¨ï¼Œæ‰€ä»¥å®ƒæœ€ç»ˆè¢«ä¼ é€’ç»™ Throwable çš„ä¸€ä¸ªèƒ½è¯†åˆ«å¼‚å¸¸é“¾çš„æ„é€ å™¨ï¼Œæ¯”å¦‚ `Throwable(Throwable)`ï¼š

// Exception with chaining-aware constructor  
class HigherLevelException extends Exception {  
    HigherLevelException(Throwable cause) {  
        super(cause);  
    }  
}

ç»å¤§å¤šæ•°æ ‡å‡†å¼‚å¸¸éƒ½æœ‰è¿™ç§èƒ½è¯†åˆ«å¼‚å¸¸é“¾çš„æ„é€ å™¨ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨ `Throwable` çš„ `initCause` æ–¹æ³•æ¥è®¾ç½® casueã€‚å¼‚å¸¸é“¾ä¸ä»…å¯ä»¥é€šè¿‡ç¨‹åºï¼ˆä½¿ç”¨ `getCause` æ–¹æ³•ï¼‰æ¥å¾—åˆ°åŸå› ï¼Œå¹¶ä¸”è¿˜å¯ä»¥å°† cause çš„ stack trace é›†æˆåˆ°é«˜å±‚å¼‚å¸¸ä¸­ã€‚

### ä¸è¦è¿‡åº¦ä½¿ç”¨å¼‚å¸¸è½¬è¯‘

è™½ç„¶å¼‚å¸¸è½¬è¯‘æ¯”æ— æ„è¯†åœ°ä¼ æ’­æ¥è‡ªä¸‹å±‚çš„å¼‚å¸¸è¦å¥½ï¼Œä½†ä¹Ÿä¸åº”è¯¥è¿‡åº¦ä½¿ç”¨å®ƒã€‚åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œ**å¤„ç†æ¥è‡ªä¸‹å±‚çš„å¼‚å¸¸çš„æœ€å¥½æ–¹æ³•æ˜¯é¿å…å®ƒä»¬ï¼Œç¡®ä¿ä¸‹å±‚æ–¹æ³•æˆåŠŸ**ã€‚æœ‰æ—¶å¯ä»¥é€šè¿‡åœ¨ä¼ é€’ç»™ä¸‹å±‚ä¹‹å‰æ£€æŸ¥ä¸Šå±‚æ–¹æ³•çš„å‚æ•°çš„æœ‰æ•ˆæ€§æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚

å¦‚æœä¸å¯èƒ½é˜²æ­¢æ¥è‡ªä¸‹å±‚çš„å¼‚å¸¸ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªæœ€å¥½çš„åŠæ³•å°±æ˜¯**è®©ä¸Šå±‚é»˜é»˜åœ°ç»•è¿‡è¿™äº›å¼‚å¸¸ï¼Œä½¿ä¸Šå±‚æ–¹æ³•çš„è°ƒç”¨è€…ä¸ä¸‹å±‚é—®é¢˜éš”ç»**ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨ä¸€äº›é€‚å½“çš„æ—¥å¿—è®¾æ–½æ¥è®°å½•å¼‚å¸¸å¯èƒ½æ˜¯åˆé€‚çš„ã€‚è¿™ä½¿å¾—ç¨‹åºå‘˜å¯ä»¥è°ƒæŸ¥é—®é¢˜ï¼ŒåŒæ—¶å°†å®¢æˆ·ä»£ç å’Œç”¨æˆ·ä¸ä¹‹éš”ç»ã€‚

### æ€»ç»“

æ€»ä¹‹ï¼Œå¦‚æœé˜²æ­¢æˆ–å¤„ç†æ¥è‡ªä¸‹å±‚çš„å¼‚å¸¸æ˜¯ä¸å¯è¡Œçš„ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨å¼‚å¸¸è½¬æ¢ï¼Œé™¤éä¸‹å±‚æ–¹æ³•åˆšå¥½èƒ½ä¿è¯å®ƒçš„æ‰€æœ‰å¼‚å¸¸éƒ½é€‚åˆäºä¸Šå±‚ã€‚å¼‚å¸¸é“¾æä¾›äº†ä¸¤å…¨å…¶ç¾çš„æ–¹æ³•ï¼šå®ƒå…è®¸ä½ æŠ›å‡ºä¸€ä¸ªé€‚å½“çš„é«˜å±‚å¼‚å¸¸ï¼ŒåŒæ—¶ä¸ºæ•…éšœåˆ†ææ•è·æ ¹æœ¬åŸå› ï¼ˆè¯¦è§ç¬¬ 75 æ¡ï¼‰ã€‚

### ä¸ªäººç†è§£

å¼‚å¸¸è½¬è¯‘å¾ˆåƒè¿ªç±³ç‰¹æ³•åˆ™ï¼šå‡è®¾æœ‰ä»£ç åˆ† Aã€Bã€C ä¸‰å±‚ï¼ŒA æ˜¯æœ€é«˜ï¼ŒC æ˜¯æœ€åº•å±‚ã€‚å¼‚å¸¸è½¬è¯‘å°±æ˜¯ï¼Œå¦‚æœ B æ•æ‰åˆ°äº† C æŠ›å‡ºçš„å¼‚å¸¸ï¼Œåº”è¯¥ä»¥ B çš„è¯­è¨€æè¿°æˆ A èƒ½ç†è§£çš„å†æŠ›å‡ºï¼Œè¿™æ · A æ•æ‰åˆ°çš„å°±æ˜¯ B æŠ›å‡ºçš„ï¼Œè€Œ A æ˜¯ B çš„ç›´æ¥é«˜å±‚ï¼ŒA å¯ä»¥è¯†åˆ« Bã€‚å¦‚æœä¸ç»è¿‡å¼‚å¸¸è½¬è¯‘ï¼Œé‚£ä¹ˆ A å°±ä¼šç›´æ¥æ•æ‰åˆ° C æŠ›å‡ºçš„å¼‚å¸¸ï¼Œè€Œ A å’Œ C ä¸­é—´éš”äº†ä¸ª Bï¼Œä½† A å’Œä¸åº”è¯¥äº†è§£éç›´æ¥ä¸‹å±‚çš„å†…å®¹ã€‚

å¼‚å¸¸è½¬è¯‘æœ‰ä¸¤ç§ï¼š

1.  é«˜å±‚ä»¥è‡ªå·±çš„è¯­è¨€æè¿°ï¼Œå†æŠ›å‡ºç»™æ›´é«˜å±‚ï¼›
    
2.  é«˜å±‚æŠ›å‡ºæ–°çš„å¼‚å¸¸ï¼Œè¿™ä¸ªå¼‚å¸¸æºå¸¦ç€æ•æ‰åˆ°çš„ä½å±‚å¼‚å¸¸ã€‚ä¼¼ä¹ä¹Ÿå°±æ˜¯åœ¨ç¬¬ä¸€æ¡çš„åŸºç¡€ä¸Šï¼Œæºå¸¦ç€ä½å±‚å¼‚å¸¸ã€‚
    

## 74. è®°å½•æ¯ä¸ªæ–¹æ³•æŠ›å‡ºçš„æ‰€æœ‰å¼‚å¸¸

å§‹ç»ˆè¦å•ç‹¬å£°æ˜æ¯ä¸ª checked exceptionï¼Œå¹¶ç”¨ @throw è¯´æ˜å¼‚å¸¸è¢«æŠ›å‡ºçš„æ¡ä»¶ã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•æŠ›å‡ºå¤šä¸ªå¼‚å¸¸ï¼Œä¸è¦ä¸ºäº†æ–¹ä¾¿è€ŒæŠ›å‡ºè¿™äº›ä¸€ä¸ªå¼‚å¸¸çš„å…±åŒçˆ¶ç±»ã€‚æç«¯çš„ä¾‹å­å°±æ˜¯æŠ›å‡º Exceptionï¼Œæˆ–è€…æ›´æç«¯çš„ Throwableã€‚æŠ›å‡ºè¿™ä¸¤ä¸ªå¼‚å¸¸ï¼Œä¸ä¼šç»™ç”¨æˆ·æä¾›å…³äºã€Œè¿™ä¸ªæ–¹æ³•èƒ½å¤ŸæŠ›å‡ºå“ªäº›å¼‚å¸¸ã€çš„ä¿¡æ¯ï¼Œè€Œä¸”å®ƒè¿˜ä¼šæ©ç›–è¯¥æ–¹æ³•åœ¨ç›¸åŒæ¡ä»¶ä¸‹æŠ›å‡ºçš„å…¶ä»–å¼‚å¸¸ã€‚ä¾‹å¤–å°±æ˜¯ main æ–¹æ³•ï¼Œå®ƒå¯ä»¥å®‰å…¨åœ°è¢«å£°æ˜æŠ›å‡º Exceptionï¼Œå› ä¸ºå®ƒåªé€šè¿‡è™šæ‹Ÿæœºè°ƒç”¨ã€‚

è™½ç„¶ Java è¯­è¨€å±‚é¢æ²¡æœ‰è¦æ±‚å£°æ˜æ–¹æ³•æŠ›å‡ºçš„ unchecked exceptionsï¼Œä½†å´ååˆ†å€¼å¾—åšã€‚Unchecked exceptions ä»£è¡¨äº†ç¼–ç¨‹ä¸Šçš„é”™è¯¯ï¼ˆè¯¦è§ç¬¬ 70 æ¡ï¼‰ï¼Œæ‰€ä»¥å£°æ˜å®ƒä»¬å¯ä»¥è®©ç¨‹åºå‘˜äº†è§£è¿™äº›é”™è¯¯ï¼Œå¹¶å¸®åŠ©ä»–ä»¬é¿å…ã€‚å¯¹äºæ–¹æ³•å¯èƒ½æŠ›å‡ºçš„ unchecked exceptionsï¼Œå¦‚æœå°†è¿™äº›å¼‚å¸¸ä¿¡æ¯å¾ˆå¥½åœ°ç»„ç»‡æˆåˆ—è¡¨æ–‡æ¡£ï¼Œå°±å¯ä»¥æœ‰æ•ˆåœ°æè¿°å‡ºè¿™ä¸ªæ–¹æ³•è¢«æˆåŠŸæ‰§è¡Œçš„ preconditionsã€‚æ¯ä¸ªæ–¹æ³•çš„æ–‡æ¡£åº”è¯¥æè¿°å®ƒçš„ preconditionsï¼ˆè¯¦è§ç¬¬ 56 æ¡ï¼‰ï¼Œè¿™æ˜¯å¾ˆé‡è¦çš„ï¼Œåœ¨æ–‡æ¡£ä¸­è®°å½•ä¸‹ unchecked exceptions æ˜¯æ»¡è¶³å‰ææ¡ä»¶çš„æœ€ä½³åšæ³•ã€‚

åœ¨æ¥å£æ–‡æ¡£ä¸­è®°å½•å¯èƒ½æŠ›å‡ºçš„ unchecked exceptions å°¤å…¶é‡è¦ï¼Œè¿™ä¸ªæ–‡æ¡£æ„æˆäº†æ¥å£é€šç”¨çº¦å®šï¼ˆgeneral contractï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä½¿æ¥å£çš„å¤šä¸ªå®ç°ä¹‹é—´æœ‰å…±åŒçš„è¡Œä¸ºã€‚

ä½¿ç”¨ @throws è®°å½•æ–¹æ³•å¯èƒ½æŠ›å‡ºçš„æ¯ä¸ªå¼‚å¸¸ï¼Œä½†ä¸è¦ç”¨ @throw è®°å½• unchecked exceptionã€‚å› ä¸ºä½¿ç”¨è€…è¦çŸ¥é“å“ªäº›æ˜¯ checked exceptionsï¼Œå“ªäº›æ˜¯ unchecked exceptionsï¼Œå› ä¸ºåœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œç¨‹åºå‘˜çš„è´£ä»»æ˜¯ä¸ä¸€æ ·çš„ã€‚@throws æ ‡ç­¾ç”Ÿæˆçš„æ–‡æ¡£ï¼Œåœ¨æ–¹æ³•å£°æ˜ä¸­æ²¡æœ‰ç›¸åº”çš„ throws å­å¥ï¼Œä¸ºç¨‹åºå‘˜æä¾›äº†ä¸€ä¸ªå¼ºçƒˆçš„è§†è§‰æç¤ºï¼Œå³å¼‚å¸¸æ˜¯æœªè¢«æ£€æŸ¥çš„ã€‚

åº”è¯¥æ³¨æ„çš„æ˜¯ï¼Œè®°å½•æ¯ä¸ªæ–¹æ³•å¯ä»¥æŠ›å‡ºçš„æ‰€æœ‰ unchecked exceptions æ˜¯ä¸€ç§ç†æƒ³ï¼Œåœ¨ç°å®ä¸–ç•Œä¸­å¹¶ä¸æ€»æ˜¯å¯ä»¥å®ç°ã€‚å½“ä¸€ä¸ªç±»è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå¦‚æœä¸€ä¸ªå¯¼å‡ºçš„æ–¹æ³•è¢«ä¿®æ”¹æˆæŠ›å‡ºé¢å¤–çš„ unchecked exceptionsï¼Œè¿™å¹¶ä¸è¿åæºç æˆ–äºŒè¿›åˆ¶å…¼å®¹æ€§ã€‚å‡è®¾ä¸€ä¸ªç±»è°ƒç”¨äº†å¦ä¸€ä¸ªç‹¬ç«‹ç¼–å†™çš„ç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•ã€‚å‰ä¸€ä¸ªç±»çš„ä½œè€…å¯èƒ½ä¼šä»”ç»†åœ°è®°å½•æ¯ä¸ªæ–¹æ³•æŠ›å‡ºçš„æ‰€æœ‰æœªæ£€æŸ¥çš„å¼‚å¸¸ï¼Œä½†æ˜¯å¦‚æœåä¸€ä¸ªç±»è¢«ä¿®æ”¹ä¸ºæŠ›å‡ºé¢å¤–çš„ unchecked exceptionsï¼Œé‚£ä¹ˆå‰ä¸€ä¸ªç±»ï¼ˆæ²¡æœ‰ç»è¿‡ä¿®æ”¹ï¼‰å¾ˆå¯èƒ½ä¼šä¼ æ’­æ–°çš„æœªæ£€æŸ¥çš„å¼‚å¸¸ï¼Œå°½ç®¡å®ƒæ²¡æœ‰è®°å½•è¿™äº›å¼‚å¸¸ã€‚

å¦‚æœä¸€ä¸ªç±»ä¸­çš„è®¸å¤šæ–¹æ³•å› ä¸ºåŒæ ·çš„åŸå› æŠ›å‡ºäº†ä¸€ä¸ªå¼‚å¸¸ï¼Œä½ å¯ä»¥åœ¨è¯¥ç±»çš„æ–‡æ¡£æ³¨é‡Šä¸­è®°å½•è¿™ä¸ªå¼‚å¸¸ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªæ–¹æ³•å•ç‹¬è®°å½•å®ƒã€‚ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯ `NullPointerException`ã€‚ä¸€ä¸ªç±»çš„æ–‡æ¡£æ³¨é‡Šå¯ä»¥ï¼šâ€œå¦‚æœä»»ä½•å‚æ•°ä¸­ä¼ é€’äº†ä¸€ä¸ªç©ºçš„å¯¹è±¡å¼•ç”¨ï¼Œè¿™ä¸ªç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šæŠ›å‡ºä¸€ä¸ª `NullPointerException`"ï¼Œæˆ–è€…ç±»ä¼¼çš„æ–‡å­—ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œè®°å½•ä¸‹ä½ æ‰€å†™çš„æ¯ä¸ªæ–¹æ³•å¯èƒ½æŠ›å‡ºçš„æ¯ä¸€ä¸ªå¼‚å¸¸ã€‚å¯¹äº unchecked and checked exceptions éƒ½æ˜¯å¦‚æ­¤ï¼Œå¯¹äºæŠ½è±¡çš„å’Œå…·ä½“çš„æ–¹æ³•ä¹Ÿæ˜¯å¦‚æ­¤ã€‚è¿™ä¸ªæ–‡æ¡£åº”è¯¥é‡‡ç”¨ doc æ³¨é‡Šä¸­çš„ @throws æ ‡ç­¾çš„å½¢å¼ã€‚åœ¨æ–¹æ³•çš„ throws å­å¥ä¸­å•ç‹¬å£°æ˜æ¯ä¸ª checked exceptionsï¼Œä½†ä¸è¦å£°æ˜ unchecked exceptionsã€‚å¦‚æœä½ æ²¡æœ‰è®°å½•ä½ çš„æ–¹æ³•å¯ä»¥æŠ›å‡ºçš„å¼‚å¸¸ï¼Œé‚£ä¹ˆå…¶ä»–äººå°±å¾ˆéš¾ç”šè‡³ä¸å¯èƒ½æœ‰æ•ˆåœ°ä½¿ç”¨ä½ çš„ç±»å’Œæ¥å£ã€‚

## 75. åœ¨è¯¦ç»†æ¶ˆæ¯ä¸­åŒ…å«å¤±è´¥-æ•è·ä¿¡æ¯

å½“ç¨‹åºç”±äºæœªæ•è·çš„å¼‚å¸¸è€Œå¤±è´¥æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ‰“å°å‡ºè¯¥å¼‚å¸¸çš„å †æ ˆè½¨è¿¹ã€‚è¿™ä¸ªå †æ ˆè½¨è¿¹åŒ…æ‹¬äº†è¿™ä¸ªå¼‚å¸¸çš„å­—ç¬¦ä¸²è¡¨ç¤ºæ³•ï¼Œå³å®ƒçš„ `toString`ã€‚å®ƒé€šå¸¸åŒ…å«è¯¥å¼‚å¸¸çš„ç±»åï¼Œåé¢æ˜¯è¯¦ç»†æ¶ˆæ¯ï¼ˆdetail messageï¼‰ã€‚è¿™é€šå¸¸æ˜¯ç¨‹åºå‘˜æ‰¾é”™è¯¯åŸå› æ—¶å€™çš„å”¯ä¸€ä¿¡æ¯ã€‚æ‰€ä»¥ï¼Œåœ¨å¼‚å¸¸çš„ `toString` æ–¹æ³•ä¸­åº”è¯¥å°½å¯èƒ½å¤šçš„è¿”å›æœ‰å…³å¤±è´¥åŸå› çš„ä¿¡æ¯ã€‚

ä¸ºäº†æ•è·å¤±è´¥ï¼Œåœ¨å¼‚å¸¸çš„è¯¦ç»†ä¿¡æ¯ä¸­åº”è¯¥åŒ…æ‹¬æ‰€æœ‰å‚æ•°å’Œå¯¼è‡´å¼‚å¸¸çš„åŸŸçš„å€¼ã€‚ä¾‹å¦‚ï¼Œ`IndexOutOfBoundsException` çš„è¯¦ç»†ä¿¡æ¯ä¸­åº”è¯¥åŒ…æ‹¬ä¸‹ç•Œã€ä¸Šç•Œå’Œç´¢å¼•å€¼ï¼Œè¿™ä¸‰ä¸ªå€¼éƒ½æœ‰å¯èƒ½æ˜¯å‡ºé”™çš„åŸå› ï¼Œå¦‚ï¼šç´¢å¼•å¯èƒ½è¶Šç•Œä¹Ÿå¯èƒ½æ˜¯ä¸ªæ— æ•ˆå€¼ï¼Œä¸‹ç•Œå¯èƒ½å¤§äºä¸Šç•Œï¼ˆå¾ˆä¸¥é‡çš„é”™è¯¯ï¼‰ã€‚æ¯ç§æƒ…å†µéƒ½è¯´æ˜äº†ä¸€ä¸ªä¸åŒçš„é—®é¢˜ï¼Œå¯ä»¥è®©ç¨‹åºå‘˜åŠ å¿«ä¿®å¤é—®é¢˜ã€‚

å¯¹å®‰å…¨æ•æ„Ÿçš„ä¿¡æ¯ä¸è¦æ”¾åˆ°å¼‚å¸¸çš„è¯¦ç»†ä¿¡æ¯ä¸­ï¼Œå¦‚å¯†ç ã€å¯†é’¥ç­‰ã€‚å› ä¸ºè®¸å¤šäººéƒ½å¯ä»¥çœ‹è§å †æ ˆè½¨è¿¹ã€‚

è™½ç„¶éœ€è¦åœ¨å¼‚å¸¸ç­‰è¯¦ç»†ä¿¡æ¯ä¸­å°½å¯èƒ½åŒ…å«æ‰€æœ‰æœ‰ç”¨çš„æ•°æ®ï¼Œä½†åŒ…å«å¤§é‡çš„æè¿°ç™½è¯æ–‡æ˜¯æ²¡æ„ä¹‰çš„ã€‚å› ä¸ºå †æ ˆè½¨è¿¹ä¸€èˆ¬éƒ½ä¼šå’Œæ–‡æ¡£æˆ–æºæ–‡ä»¶ä¸€èµ·åˆ†æï¼Œå®ƒé€šå¸¸åŒ…å«æŠ›å‡ºè¯¥å¼‚å¸¸å †æ ˆä¸Šæ‰€æœ‰æ–¹æ³•è°ƒç”¨æ‰€åœ¨çš„ç¡®åˆ‡æ–‡ä»¶å’Œè¡Œå·ã€‚

å¼‚å¸¸çš„è¯¦ç»†æ¶ˆæ¯å’Œæä¾›ç»™ç”¨æˆ·çš„é”™è¯¯ä¿¡æ¯ä¸åŒï¼Œå‰è€…æ˜¯æä¾›ç»™ç¨‹åºå‘˜æ¥åˆ†æé”™è¯¯çš„ï¼Œå†…å®¹æ¯”å¯è¯»æ€§æ›´é‡è¦ã€‚

ç¡®ä¿å¼‚å¸¸åœ¨å…¶è¯¦ç»†ä¿¡æ¯ä¸­åŒ…å«è¶³å¤Ÿçš„å¤±è´¥-æ•è·ï¼ˆfailure-captureï¼‰ä¿¡æ¯çš„ä¸€ç§æ–¹æ³•æ˜¯åœ¨å…¶æ„é€ å™¨ä¸­è¦æ±‚è¿™äº›ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ç”¨å­—ç¬¦ä¸²çš„ç»†èŠ‚ä¿¡æ¯ã€‚ç„¶åç»†èŠ‚ä¿¡æ¯å¯ä»¥è‡ªåŠ¨ç”Ÿæˆï¼Œä»¥åŒ…æ‹¬è¿™äº›ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œ`IndexOutOfBoundsException` çš„æ„é€ å‡½æ•°å¯ä»¥æ˜¯è¿™æ ·çš„ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªåªæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ„é€ å‡½æ•°ï¼š

/**  
* Constructs an IndexOutOfBoundsException.  
*  
* @param lowerBound the lowest legal index value  
* @param upperBound the highest legal index value plus one  
* @param index      the actual index value  
*/  
  
public IndexOutOfBoundsException(int lowerBound, int upperBound, int index) {  
    // Generate a detail message that captures the failure  
    super(String.format(  
        "Lower bound: %d, Upper bound: %d, Index: %d",  
        lowerBound, upperBound, index));  
    // Save failure information for programmatic access  
    this.lowerBound = lowerBound;  
    this.upperBound = upperBound;  
    this.index = index;  
}

ä½†æ˜¯ç›´åˆ° Java 9ï¼Œ`IndexOutOfBoundsException` æ‰æä¾›äº†ä¸€ä¸ªå¸¦æœ‰ä¸€ä¸ªå€¼ä¸ºç´¢å¼•çš„ int å‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œä½†çœç•¥äº† `lowerBound` å’Œ `upperBound` å‚æ•°ã€‚å…¶å®ï¼ŒJava ç±»åº“ä¸­å¾ˆå°‘é‡‡ç”¨ä¸Šé¢æ‰€è¯´çš„åŠæ³•ï¼Œä½†è¿™å¾ˆå€¼å¾—ä½¿ç”¨ã€‚è¿™ç§åšæ³•æŠŠç”Ÿæˆé«˜è´¨é‡ç»†èŠ‚ä¿¡æ¯çš„ä»£ç é›†ä¸­åœ¨å¼‚å¸¸ç±»ä¸­ï¼Œè€Œä¸æ˜¯è¦æ±‚ç±»çš„æ¯ä¸ªç”¨æˆ·éƒ½å»ç”Ÿæˆå¤šä½™çš„ç»†èŠ‚ä¿¡æ¯ã€‚

æ­£å¦‚åœ¨ç¬¬ 70 æ¡ä¸­æ‰€å»ºè®®çš„ï¼Œå¼‚å¸¸å¯ä»¥ä¸ºå…¶é”™è¯¯-æ•è·çš„ä¿¡æ¯æä¾›è®¿é—®å™¨æ–¹æ³•ï¼ˆä¸Šé¢çš„ä¾‹å­ä¸­çš„ `lowerBound` ã€`upperBound` å’Œ `index`ï¼‰ã€‚åœ¨ checked exceptions ä¸Šæä¾›è¿™æ ·çš„è®¿é—®å™¨æ–¹æ³•æ¯”åœ¨ unchecked exceptions ä¸Šæä¾›è¿™æ ·çš„è®¿é—®å™¨æ–¹æ³•æ›´é‡è¦ï¼Œå› ä¸ºé”™è¯¯-æ•è·çš„ä¿¡æ¯åœ¨ä»é”™è¯¯ä¸­æ¢å¤æ—¶å¯èƒ½å¾ˆæœ‰ç”¨ï¼Œä½†ç¨‹åºå‘˜æƒ³è¦ä»¥ç¼–ç¨‹æ–¹å¼è®¿é—® unchecked exceptions ç»†èŠ‚ï¼Œè¿™æ˜¯å¾ˆç½•è§çš„ã€‚ç„¶è€Œï¼Œå³ä½¿å¯¹äº unchecked exceptionsï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæä¾›è¿™äº›è®¿é—®å™¨ä¼¼ä¹ä¹Ÿæ˜¯æ˜æ™ºçš„ï¼ˆè¯¦è§ç¬¬ 12 é¡¹ï¼Œç¬¬ 57 é¡µï¼‰ã€‚

## 76. åŠªåŠ›å®ç°å¤±è´¥çš„åŸå­æ€§

å½“ä¸€ä¸ªå¯¹è±¡æŠ›å‡ºäº†å¼‚å¸¸ï¼Œé€šå¸¸æœŸæœ›è¿™ä¸ªå¯¹è±¡ä»ç„¶ä¿æŒåœ¨ä¸€ä¸ªè‰¯å¥½å®šä¹‰ã€å¯ç”¨çš„çŠ¶æ€ï¼Œå³ä½¿è¿™ä¸ªå¤±è´¥æ˜¯å‘ç”Ÿåœ¨æ‰§è¡ŒæŸä¸ªæ“ä½œçš„è¿‡ç¨‹ä¸­ã€‚å¯¹äº checked exceptions æ¥è¯´ï¼Œè¿™å°¤å…¶é‡è¦ï¼Œå› ä¸ºè°ƒç”¨è€…æœŸæœ›èƒ½å¤Ÿä»ä¸­æ¢å¤ã€‚**ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªå¤±è´¥çš„æ–¹æ³•è°ƒç”¨åº”è¯¥è®©å¯¹è±¡å¤„äºè°ƒç”¨å‰çš„çŠ¶æ€ã€‚**ä¸€ä¸ªå…·æœ‰è¿™ç§å±æ€§çš„æ–¹æ³•è¢«ç§°ä¸ºå…·æœ‰å¤±è´¥çš„åŸå­æ€§ï¼ˆfailure atomicï¼‰ã€‚

### å®ç°å¤±è´¥åŸå­æ€§

#### å¯å˜æˆ–ä¸å¯å˜çš„å¯¹è±¡

è®¾è®¡ä¸€ä¸ªä¸å¯å˜çš„å¯¹è±¡ï¼ˆè¯¦è§ç¬¬ 17 æ¡ï¼‰ã€‚å¦‚æœå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œæ–¹æ³•å°±å¿…ç„¶æœ‰å¤±è´¥çš„åŸå­æ€§ã€‚å¦‚æœä¸€ä¸ªæ“ä½œå¤±è´¥äº†ï¼Œä½†å®ƒæ°¸è¿œæ”¹å˜ä¸äº†å·²æœ‰å¯¹è±¡çš„çŠ¶æ€ã€‚

å¦‚æœæ–¹æ³•åœ¨å¯å˜å¯¹è±¡ä¸Šæ“ä½œï¼Œæœ€å¸¸è§çš„å®ç°å¤±è´¥åŸå­æ€§çš„æ–¹æ³•å°±æ˜¯åœ¨æ“ä½œå‰è¿›è¡Œå‚æ•°æ ¡éªŒï¼ˆè¯¦è§ç¬¬ 49 æ¡ï¼‰ï¼Œè¿™å¯ä»¥ä½¿å¾—å¯¹è±¡çŠ¶æ€è¢«ä¿®æ”¹å‰å°±æŠ›å‡ºå¼‚å¸¸ï¼š

public Object pop() {  
    if (size == 0)  
        throw new EmptyStackException();  
    Object result = elements[--size];  
    elements[size] = null; // Eliminate obsolete reference  
    return result;  
}

å¦‚æœä¸å…ˆæ£€æŸ¥ sizeï¼Œå¹¶ä¸” size åˆšå¥½ä¸º 0 çš„æ—¶å€™ï¼šé¦–å…ˆä¼šä½¿å¾— size åŸŸä¿æŒåœ¨ä¸ä¸€è‡´çš„çŠ¶æ€ï¼ˆè´Ÿæ•°ï¼‰ä¸­ï¼Œä»è€Œå¯¼è‡´è¯¥å¯¹è±¡çš„ä»»ä½•æ–¹æ³•è°ƒç”¨éƒ½ä¼šå¤±è´¥ï¼›å…¶æ¬¡ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæŠ›å‡ºå¦ä¸€ä¸ªå¼‚å¸¸ï¼šArrayIndexOutBoundsExceptionï¼Œè¿™ä¸ªå¼‚å¸¸å¯¹äºè¯¥æŠ½è±¡æ¥è¯´æ˜æ˜¾ä¸æ°å½“ï¼ˆè¯¦è§ç¬¬ 73 æ¡ï¼‰ã€‚

#### è°ƒæ•´è®¡ç®—è¿‡ç¨‹çš„é¡ºåº

ä½¿ä»»ä½•å¯èƒ½ä¼šå¤±è´¥çš„è®¡ç®—éƒ¨åˆ†éƒ½åœ¨å¯¹è±¡çŠ¶æ€è¢«ä¿®æ”¹å‰å‘ç”Ÿã€‚å¦‚æœå¯¹å‚æ•°çš„æ£€æŸ¥åªæœ‰åœ¨æ‰§è¡Œäº†éƒ¨åˆ†è®¡ç®—ä¹‹åæ‰èƒ½è¿›è¡Œï¼Œé‚£è¿™ç§åŠæ³•å®é™…ä¸Šå°±æ˜¯ä¸Šä¸€ç§åŠæ³•çš„è‡ªç„¶æ‰©å±•ã€‚æ¯”å¦‚ï¼Œä»¥ `TreeMap` çš„æƒ…å½¢ä¸ºä¾‹ï¼Œä¸ºäº†å‘ TreeMap ä¸­æ·»åŠ å…ƒç´ ï¼Œè¯¥å…ƒç´ çš„ç±»å‹å°±å¿…é¡»æ˜¯å¯ä»¥åˆ©ç”¨ TreeMap çš„æ’åºå‡†åˆ™ä¸å…¶ä»–å…ƒç´ è¿›è¡Œæ¯”è¾ƒçš„ã€‚å¦‚æœä¼å›¾å¢åŠ ç±»å‹ä¸æ­£ç¡®çš„å…ƒç´ ï¼Œåœ¨ tree ä»¥ä»»ä½•æ–¹å¼è¢«ä¿®æ”¹ä¹‹å‰ï¼Œè‡ªç„¶ä¼šå¯¼è‡´ `ClassCastException` å¼‚å¸¸ã€‚

#### ä¸´æ—¶æ‹·è´

å°†æ“ä½œéƒ½æ”¾åœ¨å¯¹è±¡çš„ä¸´æ—¶æ‹·è´ä¸Šè¿›è¡Œï¼Œå®Œæˆåå†ç”¨ä¸´æ—¶æ‹·è´ä¸­çš„å†…å®¹æ›¿æ¢åŸæ¥çš„å¯¹è±¡ã€‚å¦‚æœå°†å¯¹è±¡çš„å†…å®¹æ‹·è´åˆ°åˆé€‚çš„æ•°æ®ç»“æ„ä¸­ï¼Œé‚£ä¹ˆæ“ä½œè¿‡ç¨‹ä¼šæ›´å¿«ã€‚ä¾‹å¦‚ï¼Œæœ‰äº› List çš„æ’åºå‡½æ•°åœ¨æ’åºå‰ï¼Œä¼šå…ˆå°†å†…å®¹å¤åˆ¶åˆ°æ•°ç»„ä¸­ï¼Œæ¥é™ä½åœ¨æ’åºè¿‡ç¨‹ä¸­è®¿é—®å…ƒç´ æ‰€å¸¦æ¥çš„å¼€é”€ã€‚å¹¶ä¸”ï¼Œå®ƒè¿˜èƒ½ä¿è¯è¾“å…¥åˆ—è¡¨ä¿æŒåŸæ ·ã€‚

#### æ¢å¤ä»£ç 

è¿™ç§æ–¹å¼å¾ˆä¸å¸¸ç”¨ï¼Œç¼–å†™ä¸€æ®µæ¢å¤ä»£ç ï¼Œç”±å®ƒæ¥æ‹¦æˆªæ“ä½œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„å¤±è´¥ï¼Œç„¶åå°†å¯¹è±¡å›æ»šåˆ°æ“ä½œå¼€å§‹ä¹‹å‰åˆ°çŠ¶æ€ä¸Šã€‚è¿™ç§æ–¹æ³•ä¸»è¦ç”¨äºæ°¸ä¹…æ€§çš„ï¼ˆåŸºäºç£ç›˜çš„ï¼‰æ•°æ®ç»“æ„ã€‚

### å¤±è´¥åŸå­æ€§å¹¶éæ€»æ˜¯å¯ä»¥ä¿æŒ

ä¾‹å¦‚ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹å¹¶å‘ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±å¯èƒ½ç•™åœ¨ä¸ä¸€è‡´çš„çŠ¶æ€ä¹‹ä¸­ã€‚å› æ­¤ï¼Œå³ä½¿åœ¨æ•è·äº† `ConcurrentModificationException` ä¹‹åï¼Œè¯¥å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯ç”¨çš„ã€‚

`Errors` æ˜¯ä¸å¯æ¢å¤çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦åœ¨æŠ›å‡º `AssertionError` åå°è¯•ä¿æŒå¤±è´¥åŸå­æ€§ã€‚

å¦‚æœæœ‰äº›æ“ä½œä¼šæ˜¾è‘—åœ°æé«˜å¼€é”€æˆ–å¤æ‚åº¦ï¼Œè¿™æ—¶å€™å¯èƒ½å¤±è´¥åŸå­æ€§å°±å¹¶ä¸éœ€è¦ä¿æŒäº†ã€‚

### æ€»ç»“

æ€»ä¹‹ï¼Œä½œä¸ºä¸€é¡¹è§„åˆ™ï¼Œä»»ä½•ä½œä¸ºæ–¹æ³•çš„ä¸€éƒ¨åˆ†è€Œäº§ç”Ÿçš„å¼‚å¸¸ çš„ä¸€éƒ¨åˆ†ï¼Œåº”è¯¥è®©å¯¹è±¡å¤„äºæ–¹æ³•è°ƒç”¨å‰çš„çŠ¶æ€ã€‚å¦‚æœè¿åäº†è¿™ä¸€è§„åˆ™ï¼ŒAPIæ–‡æ¡£åº”è¯¥æ¸…æ¥šåœ°æŒ‡å‡ºå¯¹è±¡å°†è¢«ç•™åœ¨ä»€ä¹ˆçŠ¶æ€ã€‚ä¸å¹¸çš„æ˜¯ï¼Œå¾ˆå¤šç°æœ‰çš„APIæ–‡æ¡£éƒ½æ²¡æœ‰è¾¾åˆ°è¿™ä¸ªç†æƒ³ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œä»»ä½•äº§ç”Ÿçš„å¼‚å¸¸ï¼ˆæ˜¯ method specification çš„ä¸€éƒ¨åˆ†ï¼‰åº”è¯¥è®©å¯¹è±¡ä¿æŒå’Œè°ƒç”¨æ–¹æ³•å‰ç›¸åŒçš„çŠ¶æ€ã€‚å½“è¿åæ—¶ï¼ŒAPI æ–‡æ¡£åº”è¯¥æ¸…æ¥šè¯´æ˜å¯¹è±¡åº”è¯¥å¤„äºä»€ä¹ˆçŠ¶æ€ï¼ˆä½†ç›®å‰å¾ˆå¤š API æ–‡æ¡£éƒ½æ²¡æœ‰åšåˆ°è¿™ä¸€ç‚¹ï¼‰ã€‚

## 77. ä¸è¦å¿½ç•¥å¼‚å¸¸

ä¸è¦å‡ºç°ç©ºçš„ catch å—ï¼Œè¿™æ ·å¯¼è‡´ç¨‹åºåœ¨å¯èƒ½é‡åˆ°å¼‚å¸¸æ—¶ç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œå¹¶ä¸”åœ¨æœªæ¥å‘ç”Ÿé”™è¯¯ã€‚å°±ç®—ä¼ æ’­å¼‚å¸¸ï¼Œä¹Ÿè‡³å°‘ä¼šå¯¼è‡´ç¨‹åºå¿«é€Ÿå¤±è´¥ï¼Œå¹¶æä¾›äº†æœ‰å¸®åŠ©çš„ä¿¡æ¯ã€‚

åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œå¿½ç•¥ä¸€ä¸ªå¼‚å¸¸æ˜¯åˆé€‚çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨å…³é—­ä¸€ä¸ª `FileInputStream` æ—¶ï¼Œæ²¡æœ‰æ”¹å˜æ–‡ä»¶çš„çŠ¶æ€ï¼Œæ‰€ä»¥æ²¡æœ‰å¿…è¦æ‰§è¡Œä»»ä½•æ¢å¤åŠ¨ä½œï¼Œè€Œä¸”ä½ å·²ç»ä»æ–‡ä»¶ä¸­è¯»å–äº†ä½ éœ€è¦çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æ²¡æœ‰ç†ç”±ä¸­æ­¢æ­£åœ¨è¿›è¡Œçš„æ“ä½œã€‚è®°å½•è¿™ä¸ªå¼‚å¸¸å¯èƒ½æ˜¯æ˜æ™ºçš„ï¼Œå¦‚æœè¿™äº›å¼‚å¸¸ç»å¸¸å‘ç”Ÿï¼Œä½ å°±å¯ä»¥è°ƒæŸ¥è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœä½ é€‰æ‹©å¿½ç•¥ä¸€ä¸ªå¼‚å¸¸ï¼Œé‚£ä¹ˆcatch å—åº”è¯¥åŒ…å«ä¸€ä¸ªæ³¨é‡Šï¼Œè§£é‡Šä¸ºä»€ä¹ˆè¿™æ ·åšæ˜¯åˆé€‚çš„ï¼Œå¹¶ä¸”è¿™ä¸ªå˜é‡åº”è¯¥è¢«å‘½åä¸º `ignored`ï¼š

Future<Integer> f = exec.submit(planarMap::chromaticNumber);   
int numColors = 4; // Default; guaranteed sufficient for any map   
try {  
    numColors = f.get(1L, TimeUnit.SECONDS);  
} catch (TimeoutException | ExecutionException ignored) {  
    // Use default: minimal coloring is desirable, not required  
}

è¿™æ¡å»ºè®®åŒæ ·é€‚ç”¨äº checked and unchecked exceptionã€‚

# å. å¹¶å‘

## 78. åŒæ­¥è®¿é—®å…±äº«çš„å¯å˜æ•°æ®

### ä¸ºä»€ä¹ˆè¦åŒæ­¥

#### åŒæ­¥çš„æ„ä¹‰

åŒæ­¥ï¼š1. äº’æ–¥ï¼ˆé˜²æ­¢å¤šä¸ªçº¿ç¨‹ä¸­å¯¹è±¡çš„çŠ¶æ€ä¸ä¸€è‡´ï¼‰ï¼›2. ä¿è¯è¿›å…¥åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥ä»£ç å—çš„æ¯ä¸ªçº¿ç¨‹ï¼Œéƒ½èƒ½çœ‹åˆ°ç”±åŒä¸€ä¸ªé”ä¿æŠ¤çš„ä¹‹å‰æ‰€æœ‰çš„ä¿®æ”¹æ•ˆæœã€‚

Java è¯­è¨€è§„èŒƒä¿è¯è¯»æˆ–å†™ä¸€ä¸ªå˜é‡æ˜¯åŸå­çš„ï¼Œé™¤äº† long å’Œ double ä»¥å¤–ã€‚ä¹Ÿå°±æ˜¯è¯´è¯»ä¸€ä¸ªå˜é‡ï¼ˆé™¤äº† long å’Œ doubleï¼‰ï¼Œå¿…å®šä¼šè¿”å›ä¸€ä¸ªå‚¨å­˜åœ¨æŸä¸ªçº¿ç¨‹ä¸­çš„å˜é‡ã€‚ä½†è¯­è¨€è§„èŒƒå¹¶æ²¡æœ‰ä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹çš„å€¼å¯¹å¦ä¸€ä¸ªçº¿ç¨‹æ˜¯å¯è§çš„ã€‚**ä¸ºäº†åœ¨çº¿ç¨‹ä¹‹é—´è¿›è¡Œå¯é çš„é€šä¿¡ï¼Œä¹Ÿä¸ºäº†äº’æ–¥è®¿é—®ï¼ŒåŒæ­¥æ˜¯å¿…è¦çš„ã€‚**

> è¿™é‡Œè¯´çš„åŸå­å†™åº”è¯¥æŒ‡æ˜¯æ²¡æœ‰è¿ç®—çš„å¤åˆ¶ï¼Œæ¯”å¦‚ a = 2; b = SomeReferenceï¼Œè€Œä¸æ˜¯ a = b + 1ï¼›ã€‚

#### æ²¡æœ‰åŒæ­¥çš„åæœ

å¦‚æœå¯¹å…±äº«çš„å¯å˜æ•°æ®çš„è®¿é—®ä¸èƒ½åŒæ­¥ï¼Œå…¶åæœå°†éå¸¸å¯æ€•ï¼Œå³ä½¿è¿™ä¸ªå˜é‡çš„è¯»å†™éƒ½æ˜¯åŸå­æ€§çš„ã€‚

ä¸‹é¢è¿™ä¸ªç¨‹åºçš„æ„æ€ï¼šä¸€ä¸ªçº¿ç¨‹æƒ³ç»“æŸå¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œã€‚ç”±äº boolean åŸŸçš„è¯»å’Œå†™æ“ä½œéƒ½æ˜¯åŸå­çš„ï¼Œç¨‹åºå‘˜åœ¨è®¿é—®è¿™ä¸ªåŸŸçš„æ—¶å€™ä¸å†éœ€è¦ä½¿ç”¨åŒæ­¥ï¼š

> Java çš„ç±»åº“ä¸­æä¾›äº† `Thread.stop` æ–¹æ³•ï¼Œä½†æ˜¯åœ¨å¾ˆä¹…ä»¥å‰å°±ä¸æå€¡ä½¿ç”¨è¯¥æ–¹æ³•äº†ï¼Œå› ä¸ºå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸å®‰å…¨çš„ä¸€ä¸€ä½¿ç”¨å®ƒä¼šå¯¼è‡´æ•°æ®é­åˆ°ç ´åã€‚è¦é˜»æ­¢ä¸€ä¸ªçº¿ç¨‹å¦¨ç¢å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå»ºè®®çš„åšæ³•æ˜¯è®©ç¬¬ä¸€ä¸ªçº¿ç¨‹è½®è¯¢ï¼ˆpollï¼‰ä¸€ä¸ª boolean åŸŸï¼Œè¿™ä¸ªåŸŸä¸€å¼€ å§‹ä¸º falseï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ç¬¬äºŒä¸ªçº¿ç¨‹è®¾ç½®ä¸º trueï¼Œä»¥è¡¨ç¤ºç¬¬ä¸€ä¸ªçº¿ç¨‹å°†ç»ˆæ­¢è‡ªå·±ã€‚

// Broken! - How long would you expect this program to run?  
public class StopThread {  
    private static boolean stopRequested;  
      
    public static void main(String[] args)  
        throws InterruptedException {  
        Thread backgroundThread = new Thread(() -> {  
            int i = 0;  
            while (!stopRequested)  
                i++;  
        });  
        backgroundThread.start();  
        TimeUnit.SECONDS.sleep(1);  
        stopRequested = true;  
    }  
}

ç¨‹åºè¿è¡Œçš„ç»“æœæ˜¯ï¼Œ`backgroundThread` ä¸€ç›´åœ¨å¾ªç¯ä¸­ã€‚é—®é¢˜åœ¨äºï¼Œç”±äºæ²¡æœ‰åŒæ­¥ï¼Œå°±ä¸èƒ½ä¿è¯åå°çº¿ç¨‹ä½•æ—¶ â€çœ‹åˆ°â€œ ä¸»çº¿ç¨‹å¯¹ `stopRequested` çš„å€¼æ‰€åšçš„æ”¹å˜ã€‚æ²¡æœ‰åŒæ­¥ï¼Œè™šæ‹Ÿæœºå°†ä»¥ä¸‹ä»£ç ï¼š

while (!stopRequested)  
    i++;

è½¬å˜æˆè¿™æ ·ï¼š

if (!stopRequested)  
    while (true)  
        i++;

è¿™ç§ä¼˜åŒ–ç§°ä½œæ˜¯**æå‡**ï¼ˆhoistingï¼‰ï¼Œæ­£æ˜¯ OpenJDK Server VM çš„å·¥ä½œï¼Œä½†ç»“æœåè€Œæ˜¯ä¸€ä¸ªæ´»æ€§å¤±è´¥ï¼ˆliveness failureï¼‰ã€‚

### æ€ä¹ˆåŒæ­¥

#### synchronized

ä¿®æ­£è¿™ä¸ªé—®é¢˜çš„ä¸€ç§æ–¹å¼æ˜¯åŒæ­¥è®¿é—® `stopÂ­Requested` åŸŸï¼š

// Properly synchronized cooperative thread termination  
public class StopThread {  
    private static boolean stopRequested;  
    private static synchronized void requestStop() {  
        stopRequested = true;  
    }  
    private static synchronized boolean stopRequested() {  
        return stopRequested;  
    }  
      
    public static void main(String[] args)  
        throws InterruptedException {  
        Thread backgroundThread = new Thread(() -> {  
            int i = 0;  
            while (!stopRequested()) i++;  
        });  
        backgroundThread.start();  
        TimeUnit.SECONDS.sleep(1);  
        requestStop(); }  
}

æ³¨æ„å†™æ–¹æ³•ï¼ˆ`requestStop`ï¼‰å’Œè¯»æ–¹æ³•ï¼ˆ`stopRequested`ï¼‰éƒ½è¢«åŒæ­¥äº†ã€‚åªåŒæ­¥å†™æ–¹æ³•è¿˜ä¸å¤Ÿï¼é™¤éè¯»å’Œå†™æ“ä½œéƒ½è¢«åŒæ­¥ï¼Œå¦åˆ™æ— æ³•ä¿è¯åŒæ­¥èƒ½èµ·ä½œç”¨ã€‚

> æœ‰æ—¶å€™ï¼Œä¼šåœ¨æŸäº›æœºå™¨ä¸Šçœ‹åˆ°åªåŒæ­¥äº†å†™ï¼ˆæˆ–è¯»ï¼‰æ“ä½œçš„ç¨‹åºçœ‹èµ·æ¥ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¡¨è±¡å…·æœ‰å¾ˆå¤§çš„æ¬ºéª—æ€§ã€‚

`StopThread` ä¸­è¢«åŒæ­¥æ–¹æ³•çš„åŠ¨ä½œå³ä½¿æ²¡æœ‰åŒæ­¥ä¹Ÿæ˜¯åŸå­çš„ã€‚æ¢å¥è¯è¯´ï¼Œè¿™äº›æ–¹æ³•çš„åŒæ­¥åªæ˜¯ä¸ºäº†å®ƒçš„é€šä¿¡æ•ˆæœï¼Œè€Œä¸æ˜¯ä¸ºäº†äº’æ–¥è®¿é—®ã€‚

> åˆ°è¿™é‡Œå°±èƒ½æ˜ç™½è¿™èŠ‚è¯´çš„åŸå­æ˜¯ä»€ä¹ˆæ„æ€äº†ï¼šè¯»å†™æ˜¯åŸå­çš„ï¼Œåªèƒ½ä¿è¯ä¼šä»æŸä¸ªçº¿ç¨‹ä¸­æ‹¿åˆ°å®ƒå‚¨å­˜çš„å˜é‡ä½†å€¼ã€‚ä½†åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæä¾›å˜é‡çš„çº¿ç¨‹ä¸­çš„å˜é‡å€¼å¯èƒ½å¹¶ä¸æ˜¯æœ€æ–°å†™å…¥çš„ã€‚

#### volatile

å¦‚æœ stopRequested è¢«å£°æ˜ä¸º `volatile`ï¼Œç¬¬äºŒç§ç‰ˆæœ¬çš„ `StopThread` ä¸­çš„é”å°±å¯ä»¥çœç•¥ã€‚`volatile` ä¿®é¥°ç¬¦ä¸æ‰§è¡Œäº’æ–¥è®¿é—®ï¼Œä½†å®ƒå¯ä»¥ä¿è¯ä»»ä½•ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»å–è¯¥åŸŸçš„æ—¶å€™éƒ½å°†çœ‹åˆ°æœ€è¿‘åˆšåˆšè¢«å†™å…¥çš„å€¼ï¼š

 // Cooperative thread termination with a volatile field  
public class StopThread {  
    private static volatile boolean stopRequested;  
      
    public static void main(String[] args)  
        throws InterruptedException {  
        Thread backgroundThread = new Thread(() -> {  
            int i = 0;  
            while (!stopRequested)  
                i++;  
        });  
        backgroundThread.start();  
        TimeUnit.SECONDS.sleep(1);  
        stopRequested = true;  
    }  
}

åœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨ volatile æ›´æ­£ç¡®ï¼Œä¸”æ›´åŠ ç®€æ´ï¼Œæ€§èƒ½ä¹Ÿå¯èƒ½æ›´å¥½ã€‚

> è¿™é‡Œè¯´äº† volatile æ‹¿åˆ°çš„æ˜¯æœ€è¿‘è¢«å†™å…¥çš„å€¼ï¼Œè§£å†³äº†ä¸Šé¢çš„é—®é¢˜ï¼Œä½† volatile å¹¶ä¸èƒ½ä¿è¯äº’æ–¥è®¿é—®ï¼Œä¹Ÿå°±é€ æˆäº†ï¼šå¹¶å‘æƒ…å†µä¸‹é’ˆå¯¹åŒä¸€ä¸ªå˜é‡ï¼ŒA æ–¹æ³•å†™å…¥äº†æŸä¸ªå€¼ï¼ŒB æ–¹æ³•æ­£å‡†å¤‡å†™å…¥å€¼ï¼ŒC æ­£å‡†å¤‡è¯»å˜é‡å€¼ï¼ŒC åœ¨ B åæ‰§è¡Œã€‚å¦‚æœ C åœ¨ B å†™å…¥å‰å…ˆè¯»ï¼Œé‚£ä¹ˆè¯»åˆ°çš„è™½ç„¶æ˜¯æœ€è¿‘å†™å…¥çš„å€¼ï¼Œä½†å´ä¸æ˜¯æ­£ç¡®çš„ã€‚æ­£ç¡®çš„åº”è¯¥ç­‰ B å†™å…¥ä¹‹åï¼ŒC æ‰å¼€å§‹è¯»ã€‚ä¸‹é¢æ˜¯ä¾‹å­ã€‚

> volatile é€‚ç”¨çš„åœºåˆå¥½åƒæ¯”è¾ƒå°‘ï¼Œä¸€èˆ¬å°±å°±æ˜¯ä¸Šé¢çš„ã€Œå¤šä»»åŠ¡ç¯å¢ƒä¸‹å„ä»»åŠ¡é—´å…±äº«çš„æ ‡å¿—ã€ã€‚è¿™ç§åªæ˜¯ä¸ºäº†èƒ½çœ‹åˆ°å˜é‡çš„æœ€è¿‘å†™å…¥çš„å€¼ï¼ˆé˜²æ­¢å‡ºç°æœ¬æ¡å¼€å¤´çš„æƒ…å†µï¼‰ï¼Œè€Œä¸æ˜¯ä¸ºäº†åœ¨å¹¶å‘æƒ…å†µä¸‹ä¿è¯äº’æ–¥ã€‚

##### volatile ä¹Ÿä¼šå¸¦æ¥é—®é¢˜

ä»¥ä¸‹é¢çš„æ–¹æ³•ä¸ºä¾‹ï¼Œå‡è®¾å®ƒè¦äº§ç”Ÿåºåˆ—å·ï¼š

// Broken - requires synchronization!  
private static volatile int nextSerialNumber = 0;  
  
public static int generateSerialNumber() {  
    return nextSerialNumber++;  
}

é—®é¢˜åœ¨äºï¼Œå¢é‡æ“ä½œç¬¦ï¼ˆ++ï¼‰ä¸æ˜¯åŸå­çš„ã€‚å®ƒåœ¨ `nextSerialNumber` åŸŸä¸­æ‰§è¡Œä¸¤é¡¹æ“ä½œï¼šé¦–å…ˆå®ƒè¯»å–å€¼ï¼Œç„¶åå†™å›ä¸€ä¸ªæ–°å€¼ï¼Œç›¸å½“äºåŸæ¥çš„å€¼å†åŠ ä¸Š 1ã€‚å¦‚æœç¬¬äºŒä¸ªçº¿ç¨‹åœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹è¯»å–æ—§å€¼å’Œå†™å›æ–°å€¼æœŸé—´è¯»å–è¿™ä¸ªåŸŸ ç¬¬äºŒä¸ªçº¿ç¨‹å°±ä¼šä¸ç¬¬ä¸€ä¸ªçº¿ç¨‹ä¸€èµ·çœ‹åˆ°åŒä¸€ ä¸ªå€¼ï¼Œå¹¶è¿”å›ç›¸åŒçš„åºåˆ—å·ã€‚ è¿™å°±æ˜¯å®‰å…¨æ€§å¤±è´¥ï¼ˆsafety failureï¼‰ï¼šè¿™ä¸ªç¨‹åºä¼šè®¡ç®—å‡ºé”™è¯¯çš„ç»“æœã€‚

ä¸€ç§è§£å†³åŠæ³•å°±æ˜¯å°† `generateSerialNumber` å£°æ˜ä¸º `synchronized`ï¼Œå¹¶ä¸”åˆ é™¤ `nextSerialNumber` çš„ `volatile` ä¿®é¥°ç¬¦ã€‚ä¸ºäº†ä¿æŠ¤è¿™ä¸ªæ–¹æ³•ï¼Œè¦ç”¨ long ä»£æ›¿ intï¼Œæˆ–è€…åœ¨ `nextSerialNumber` è¦è¿›è¡ŒåŒ…è£…æ—¶æŠ›å‡ºå¼‚å¸¸ï¼ˆTODOï¼šã€ŒåŸæ–‡ï¼šTo bulletproof the method, use long instead of int, or throw an exception if nextSerialNumber is about to wrap.ã€ï¼Œæ²¡çœ‹æ˜ç™½ï¼‰ã€‚

æœ€å¥½è¿˜æ˜¯éµå¾ªç¬¬ 59 æ¡ä¸­çš„å»ºè®®ï¼Œä½¿ç”¨ `AtomicLong` ç±»ã€‚`volatile` åªæä¾›äº†åŒæ­¥çš„é€šä¿¡æ•ˆæœï¼Œä½†è¿™ä¸ªåŒ…è¿˜é¢å¤–æä¾›äº†åŸå­æ€§ï¼š

// Lock-free synchronization with java.util.concurrent.atomic  
private static final AtomicLong nextSerialNum = new AtomicLong();  
  
public static long generateSerialNumber() {  
    return nextSerialNum.getAndIncrement();  
}

### æ€»ç»“

é¿å…æœ¬æ¡ç›®ä¸­æ‰€è®¨è®ºåˆ°çš„é—®é¢˜çš„æœ€ä½³åŠæ³•æ˜¯ä¸å…±äº«å¯å˜çš„æ•°æ®ã€‚è¦ä¹ˆå…±äº«ä¸å¯å˜çš„æ•°æ®ï¼ˆè¯¦è§ç¬¬ 17 æ¡ï¼‰ï¼Œè¦ä¹ˆå‹æ ¹ä¸å…±äº«ã€‚æ¢å¥è¯è¯´ï¼Œå°†å¯å˜æ•°æ®é™åˆ¶åœ¨å•ä¸ªçº¿ç¨‹ä¸­ã€‚å¦‚æœé‡‡ç”¨è¿™ä¸€ç­–ç•¥ï¼Œå°±è¦ä¸ºå®ƒå»ºç«‹æ–‡æ¡£ï¼Œä»¥ä¾¿å®ƒå¯ä»¥éšç€ç¨‹åºçš„å‘å±•å¾—åˆ°ç»´æŠ¤ã€‚

æ·±åˆ»åœ°ç†è§£æ­£åœ¨ä½¿ç”¨çš„æ¡†æ¶å’Œç±»åº“ä¹Ÿå¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒä»¬å¼•å…¥äº†ä½ ä¸çŸ¥é“çš„çº¿ç¨‹ã€‚

ä¸€ä¸ªçº¿ç¨‹æš‚æ—¶ä¿®æ”¹ä¸€ä¸ªæ•°æ®å¯¹è±¡ï¼Œç„¶åä¸å…¶ä»–çº¿ç¨‹å…±äº«ï¼ŒåªåŒæ­¥å…±äº«å¯¹è±¡å¼•ç”¨çš„è¡Œä¸ºï¼Œè¿™æ˜¯å¯ä»¥æ¥å—çš„ã€‚ä¹‹åï¼Œå…¶ä»–çº¿ç¨‹ä¸éœ€è¦åŒæ­¥ä¹Ÿå¯ä»¥è¯»å–å¯¹è±¡ï¼Œåªè¦è¿™ä¸ªå¯¹è±¡æ²¡æœ‰å†è¢«ä¿®æ”¹ã€‚ è¿™æ ·çš„å¯¹è±¡è¢«è®¤ä¸ºæ˜¯æœ‰æ•ˆçš„ä¸å¯å˜ï¼ˆeffectively immutableï¼‰ã€‚å°†è¿™æ ·çš„å¯¹è±¡å¼•ç”¨ä»ä¸€ä¸ªçº¿ç¨‹è½¬ç§»åˆ°å…¶ä»–çº¿ç¨‹è¢«ç§°ä¸ºå®‰å…¨å‘å¸ƒï¼ˆsafe publishï¼‰ã€‚æœ‰è®¸å¤šæ–¹æ³•å¯ä»¥å®‰å…¨åœ°å‘å¸ƒå¯¹è±¡å¼•ç”¨ï¼šå¯ä»¥æŠŠå®ƒå­˜å‚¨åœ¨ static åŸŸä¸­ï¼Œä½œä¸ºç±»åˆå§‹åŒ–çš„ä¸€éƒ¨åˆ†ï¼›å¯ä»¥æŠŠå®ƒä¿å­˜åœ¨volitale åŸŸã€final åŸŸæˆ–è€…ä¸€ä¸ªé€šè¿‡é”æ¥è®¿é—®çš„åŸŸï¼›æˆ–è€…ä½ å¯ä»¥æŠŠå®ƒæ”¾åˆ°å¹¶å‘é›†åˆä¸­ï¼ˆç¬¬ 81 é¡¹ï¼‰ã€‚ï¼ˆTODOï¼šæœ€åä¸€å¥è¯æ²¡çœ‹æ˜ç™½ã€‚ï¼‰

æ€»ä¹‹ï¼Œå½“å¤šä¸ªçº¿ç¨‹å…±äº«å¯å˜æ•°æ®æ—¶ï¼Œæ¯ä¸ªè¯»å–æˆ–å†™å…¥æ•°æ®çš„çº¿ç¨‹å¿…é¡»æ‰§è¡ŒåŒæ­¥ã€‚åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹çš„æ”¹å˜å¯¹å¦ä¸€ä¸ªçº¿ç¨‹æ˜¯å¯è§çš„ã€‚æœªèƒ½åŒæ­¥å…±äº«çš„å¯å˜æ•°æ®å¯èƒ½é€ æˆæ´»æ€§å¤±è´¥å’Œå®‰å…¨æ€§å¤±è´¥ã€‚è¿™äº›æ•…éšœæ˜¯æœ€éš¾è°ƒè¯•çš„æ•…éšœä¹‹ä¸€ã€‚å®ƒä»¬å¯èƒ½æ˜¯é—´æ­‡æ€§çš„ï¼Œä¸”ä¸æ—¶é—´ç›¸å…³ï¼Œç¨‹åºçš„è¡Œä¸ºåœ¨ä¸åŒçš„è™šæ‹Ÿæœºä¸Šå¯èƒ½æ ¹æœ¬ä¸åŒã€‚å¦‚æœåªéœ€è¦çº¿ç¨‹ä¹‹é—´çš„äº¤äº’é€šä¿¡ï¼Œè€Œä¸éœ€è¦äº’æ–¥ï¼Œ volatile ä¿®é¥°ç¬¦å°±æ˜¯ä¸€ç§å¯ä»¥æ¥å—çš„åŒæ­¥å½¢å¼ï¼Œä½†è¦æ­£ç¡®åœ°ä½¿ç”¨å®ƒå¯èƒ½éœ€è¦ä¸€äº›æŠ€å·§ã€‚

## 79. é¿å…è¿‡åº¦åŒæ­¥

### ä¸è¦åœ¨åŒæ­¥åŒºåŸŸè°ƒç”¨å¤–æ¥æ–¹æ³•

#### ä»€ä¹ˆæ˜¯å¤–æ¥æ–¹æ³•

åœ¨åŒæ­¥åŒºåŸŸå†…ï¼Œä¸è¦è°ƒç”¨è¢«è®¾è®¡æˆç»§æ‰¿çš„æ–¹æ³•ï¼Œæˆ–è€…æ˜¯å®¢æˆ·ç«¯ä»¥å‡½æ•°å¯¹è±¡å½¢å¼æä¾›çš„æ–¹æ³•ï¼ˆè¯¦è§ç¬¬ 24 æ¡ï¼‰ã€‚è¿™äº›æ–¹æ³•å¯¹äºæœ‰åŒæ­¥åŒºåŸŸçš„ç±»æ¥è¯´æ˜¯å¤–æ¥æ–¹æ³•ï¼ˆalien methodï¼‰ã€‚è¿™ä¸ªç±»å¯¹äºè¿™äº›æ–¹æ³•ä¸€æ— æ‰€çŸ¥ï¼Œå¹¶ä¸”ä¸èƒ½æ§åˆ¶è¿™äº›æ–¹æ³•ã€‚å¦‚æœåœ¨åŒæ­¥åŒºåŸŸè°ƒç”¨å¤–æ¥æ–¹æ³•ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¼‚å¸¸ã€æ­»é”æˆ–æ•°æ®æŸåã€‚

> å¤–æ¥æ–¹æ³•å°±ç›¸å½“äºæŠŠåœ¨åŒæ­¥åŒºåŸŸå…·ä½“åšçš„éƒ¨åˆ†äº‹æƒ…äº¤ç»™å®¢æˆ·ç«¯æ¥å®ç°ã€‚

#### å¤–æ¥æ–¹æ³•å¯èƒ½çš„å±å®³

ä¸‹é¢è¿™ä¸ªç±»å®ç°äº†ä¸€ä¸ª observable set åŒ…è£…ç±»ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯åœ¨å…ƒç´ è¢«æ·»åŠ åˆ°é›†åˆä¸­æ—¶è®¢é˜…é€šçŸ¥ã€‚ä¸ºäº†ç®€æ´èµ·è§ï¼Œè¯¥ç±»ä¸æä¾›å…ƒç´ ä»é›†åˆä¸­ç§»é™¤æ—¶çš„é€šçŸ¥ã€‚è¿™ä¸ªç±»æ˜¯åœ¨ç¬¬ 18 æ¡ä¸­çš„ ForwardingSet ä¹‹ä¸Šå®ç°çš„ã€‚

// Broken - invokes alien method from synchronized block!  
public class ObservableSet<E> extends ForwardingSet<E> {  
    public ObservableSet(Set<E> set) { super(set); }  
      
    private final List<SetObserver<E>> observers = new ArrayList<>();  
      
    public void addObserver(SetObserver<E> observer) {  
        synchronized(observers) {  
            observers.add(observer);  
        }  
    }  
      
    public boolean removeObserver(SetObserver<E> observer) {  
        synchronized(observers) {  
            return observers.remove(observer);  
        }  
    }  
      
    private void notifyElementAdded(E element) {  
        synchronized(observers) {  
            for (SetObserver<E> observer : observers)  
                observer.added(this, element);  
        }  
    }  
  
    @Override   
    public boolean add(E element) {  
        boolean added = super.add(element);  
        if (added)  
            notifyElementAdded(element);  
        return added;  
  
    }  
  
    @Override   
    public boolean addAll(Collection<? extends E> c) {   
        boolean result = false;  
        for (E element : c)  
            result |= add(element); //CallsnotifyElementAdded return result;  
    }   
    return result;  
}

è§‚å¯Ÿè€…å¯ä»¥é€šè¿‡ `addObserver` è®¢é˜…é€šçŸ¥ï¼Œæˆ–è€…é€šè¿‡ `removeObserver` å–æ¶ˆè®¢é˜…ã€‚è¿™ä¸¤ç§æ–¹å¼ï¼Œè¿™ä¸ªå›è°ƒ(callbackï¼‰æ¥å£çš„ä¸€ä¸ªå®ä¾‹éƒ½ä¼šè¢«ä¼ é€’ç»™æ–¹æ³•ï¼š

@FunctionalInterface   
public interface SetObserver<E> {  
    // Invoked when an element is added to the observable set  
    void added(ObservableSet<E> set, E element);  
}

> è¿™ä¸ªæ¥å£çš„ç»“æ„å’Œ `BiConsumer<ObservaleSet<E>, E>` ç›¸åŒï¼Œä½†æ²¡ç”¨å®ƒçš„åŸå› æ˜¯ï¼Œ`SetObserver` å’Œ `added` çš„åç§°éƒ½å…·æœ‰æ›´å¥½çš„å¯è¯»æ€§ï¼Œå¹¶ä¸”è¿™ä¸ªæ¥å£å¯ä»¥å‘å±•æ•´åˆå¤šä¸ªå›è°ƒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿˜å¯ä»¥è®¾ç½®åˆç†çš„å‚æ•°æ¥ä½¿ç”¨ `BiConsumer`ï¼ˆTODOï¼šæ²¡çœ‹æ˜ç™½ï¼‰ã€‚

å¦‚æœåªæ˜¯åƒä¸‹é¢è¿™æ ·ç®€å•ä½¿ç”¨ `ObservableSet`ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå‡ºé”™ã€‚

public static void main(String[] args) {  
    ObservableSet<Integer> set = new ObservableSet<>(new HashSet<>());  
    set.addObserver((s, e) -> System.out.println(e));  
    for (int i = 0; i < 100; i++)  
        set.add(i);  
}

##### å¯¼è‡´å¼‚å¸¸

ä½†å¦‚æœå¤æ‚ç‚¹ï¼Œå‡è®¾ä¼ é€’ä¸€ä¸ªè§‚å¯Ÿè€…ç»™ `addObserver`ï¼Œè¿™ä¸ªè§‚å¯Ÿè€…åœ¨ 23 è¢«æ·»åŠ åˆ°é›†åˆåˆ°æ—¶å€™ï¼Œä¼šå–æ¶ˆè®¢é˜…ï¼š

set.addObserver(new SetObserver<>() {  
    public void added(ObservableSet<Integer> s, Integer e) {  
        System.out.println(e);  
        if (e == 23)  
            s.removeObserver(this);  
    }   
});

> è¿™ä¸ªè§‚å¯Ÿè€…ä½¿ç”¨åŒ¿åç±»æ¥å®ç°çš„ï¼Œå› ä¸ºå®ƒéœ€è¦å°†è‡ªèº«ä¼ é€’ç»™ `removeObserver` æ–¹æ³•ï¼Œè€Œåœ¨ lambda è¡¨è¾¾å¼ä¸­ä¸èƒ½è·å–è‡ªèº«ã€‚

è¿™ä¸ªç¨‹åºä¼šåœ¨é›†åˆæ·»åŠ  23 åï¼ŒæŠ›å‡º `ConcurrentModificationException`ã€‚åŸå› åœ¨äºï¼Œå½“ `notifyElementAdded` è°ƒç”¨è§‚å¯Ÿè€…çš„ `added` æ–¹æ³•æ—¶ï¼Œå®ƒæ­£å¤„äºå¯¹ `observers` åˆ—è¡¨çš„è¿­ä»£ä¸­ã€‚è€Œåœ¨ `added` æ–¹æ³•ä¸­è°ƒç”¨äº† `ObservableSet` çš„ `removeObserver` æ–¹æ³•ï¼Œåè€…åˆè°ƒç”¨äº† `observers.remove` æ–¹æ³•ã€‚åœ¨åˆ—è¡¨çš„è¿­ä»£è¿‡ç¨‹ä¸­ä»åˆ—è¡¨ä¸­åˆ é™¤ä¸€ä¸ªå…ƒç´ ï¼Œè¿™æ˜¯ä¸åˆæ³•çš„ã€‚`notifyElementAdded` æ–¹æ³•ä¸­çš„è¿­ä»£æ˜¯åœ¨ä¸€ä¸ªåŒæ­¥å—ä¸­è¿›è¡Œçš„ï¼Œä»¥é˜²æ­¢å¹¶å‘ä¿®æ”¹ï¼Œä½†è¿™å¹¶ä¸èƒ½é˜»æ­¢è¿­ä»£çº¿ç¨‹æœ¬èº«å›è°ƒåˆ°å¯è§‚å¯Ÿé›†å¹¶ä¿®æ”¹å…¶è§‚å¯Ÿå‘˜åˆ—è¡¨ã€‚

> è¿™ä¸ªé—®é¢˜æ˜¯ç”±äºåœ¨è¿­ä»£é›†åˆçš„è¿‡ç¨‹ä¸­ï¼Œåˆ é™¤äº†é›†åˆçš„å…ƒç´ é€ æˆçš„ã€‚å¹¶ä¸æ˜¯å› ä¸ºåœ¨åŒæ­¥ä¸­åˆ é™¤å…ƒç´ ï¼Œå› ä¸º `removeObserver` æ–¹æ³•ä¾ç„¶å’Œé›†åˆè¿­ä»£åœ¨åŒä¸€ä¸ªåŒæ­¥åŒºåŸŸä¸­ã€‚è¿™ä¸ªé—®é¢˜ä¸»è¦å°±æ˜¯æƒ³è¯´æ˜åœ¨åŒæ­¥åŒºåŸŸä¸­ä¸è¦è°ƒç”¨å¤–éƒ¨æ–¹æ³•ï¼Œå¯èƒ½å¯¼è‡´å‡ºç°å¼‚å¸¸ã€æ­»é”å’Œæ•°æ®æŸåã€‚è¯•æƒ³ï¼Œä¸Šé¢å®¢æˆ·ç«¯è‡ªå®šä¹‰çš„è§‚å¯Ÿè€…åœ¨å†…éƒ¨æ— é™å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯æ— é™å æœ‰é”ï¼Œé‚£å°±ä¼šå¯¼è‡´æ•´ä¸ª `ObservableSet` å®ä¾‹éƒ½ä¸å¯ç”¨äº†ã€‚

##### æ­»é”

ä¸‹é¢å°è¯•ä¸€ä¸ªå¥‡æ€ªçš„åšæ³•ï¼šç¼–å†™ä¸€ä¸ªè§‚å¯Ÿè€…ï¼Œå®ƒåŒæ ·å°è¯•å–æ¶ˆè‡ªå·±çš„è®¢é˜…ï¼Œä½†ä¸é€šè¿‡ç›´æ¥è°ƒç”¨ `removeObserver` æ–¹æ³•ï¼Œè€Œæ˜¯é€šè¿‡ä½¿ç”¨ `ExecutorService` æ¥è®©å¦ä¸€ä¸ªçº¿ç¨‹ä»£æ›¿è‡ªå·±å®Œæˆä»»åŠ¡ã€‚

// Observer that uses a background thread needlessly  
set.addObserver(new SetObserver<>() {  
    public void added(ObservableSet<Integer> s, Integer e) {  
        System.out.println(e);  
        if (e == 23) {  
            ExecutorService exec = Executors.newSingleThreadExecutor();  
            try {  
                exec.submit(() -> s.removeObserver(this)).get();  
            } catch (ExecutionException | InterruptedException ex) {   
                throw new AssertionError(ex);  
            } finally {  
                exec.shutdown();  
            }   
        }  
    }   
});

> catch å­å¥ä¸­ä½¿ç”¨äº† Java 7 ä¸­æ–°å¢çš„å¤šé‡æ•è·ï¼ˆmulti-catchï¼‰æœºåˆ¶ï¼Œå®ƒèƒ½èƒ½æå¤§æé«˜ä»£ç çš„æ¸…æ™°åº¦ï¼Œå¹¶ä¸”åœ¨ç¨‹åºå¯¹å¤šç§å¼‚å¸¸åšå‡ºçš„è¡Œä¸ºç›¸åŒæ—¶ï¼Œèƒ½å‡å°‘ä»£ç çš„ç¯‡å¹…ã€‚

ç¨‹åºè¿è¡Œåï¼Œä¸ä¼šå‡ºç°å¼‚å¸¸ï¼Œä½†ä¼šè¿›å…¥æ­»é”ã€‚åŸå› æ˜¯ï¼Œåå°çº¿ç¨‹è°ƒç”¨ `s.removeObserver` ä¼šå°è¯•è·å¾— `observers` çš„é”ï¼Œä½†ä¸»çº¿ç¨‹æŒæœ‰é”ä¸”æ²¡æœ‰é‡Šæ”¾é”ã€‚

è¿™ç§å†™æ³•è™½ç„¶å¾ˆå¥‡æ€ªï¼Œä½†å‡ºç°çš„é—®é¢˜å´å¾ˆå¸¸è§ã€‚åœ¨åŒæ­¥åŒºåŸŸå†…è°ƒç”¨å¤–æ¥æ–¹æ³•åœ¨å¾ˆå¤šçœŸå®ç³»ç»Ÿä¸­é€ æˆäº†è®¸å¤šæ­»é”ï¼Œæ¯”å¦‚ GUI å·¥å…·ç®±ã€‚

#### æ•°æ®æŸå

å½“å¤–æ¥æ–¹æ³•ï¼ˆ`added`ï¼‰è¢«è°ƒç”¨æ—¶ï¼ŒåŒæ­¥åŒºåŸŸæ‰€ä¿æŠ¤çš„èµ„æºï¼ˆ`observers`ï¼‰å¤„äºä¸€è‡´çš„çŠ¶æ€ã€‚å‡è®¾ä½ ä»åŒæ­¥åŒºåŸŸè°ƒç”¨ä¸€ä¸ªå¤–æ¥æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•ä¼šå¯¹è¢«ä¿æŠ¤çš„èµ„æºè¿›è¡Œä¿®æ”¹ï¼ˆå› ä¸º synchronized æ˜¯å¯é‡å…¥é”ï¼Œæ‰€ä»¥ä¸ä¼šæŠ›å¼‚å¸¸ï¼‰ã€‚é‚£ä¹ˆè¿™ä¸ªèµ„æºä¸Šçš„é”å°±å¹¶æ²¡æœ‰æˆåŠŸä¿æŠ¤è¿™ä¸ªèµ„æºã€‚

å¯é‡å…¥é”ç®€åŒ–äº†å¹¶å‘é¢å‘å¯¹è±¡ç¨‹åºçš„ç¼–ç¨‹ï¼Œä½†å®ƒä»¬ä¹Ÿå¯ä»¥å°†æ´»æ€§å¤±è´¥è½¬ä¸ºå®‰å…¨æ€§å¤±è´¥ã€‚

### å°†å¤–æ¥æ–¹æ³•ç§»å‡ºåŒæ­¥åŒºåŸŸ

#### å¯¹ä¿æŠ¤æ•°æ®æ‹å¿«ç…§

å¯¹äº `notifyElementAdded` æ–¹æ³•ï¼Œå¯ä»¥ç»™ `observers` æ‹å¿«ç…§ï¼Œé‚£ä¹ˆå³ä½¿æ²¡æœ‰é”ï¼Œä¹Ÿå¯ä»¥å®‰å…¨éå†è¿™ä¸ªåˆ—è¡¨äº†ï¼š

// Alien method moved outside of synchronized block - open calls  
private void notifyElementAdded(E element) {  
    List<SetObserver<E>> snapshot = null;  
    synchronized(observers) {  
        snapshot = new ArrayList<>(observers);  
    }  
    for (SetObserver<E> observer : snapshot)  
        observer.added(this, element);  
}

è¿™æ ·ï¼Œå‰é¢çš„é—®é¢˜å°±ä¸ä¼šå†å‘ç”Ÿäº†ã€‚

#### å¹¶å‘é›†åˆ

é’ˆå¯¹è¿™ä¸ªä¾‹å­ï¼Œæ›´å¥½çš„ã€Œå°†å¤–æ¥æ–¹æ³•ç§»å‡ºåŒæ­¥åŒºåŸŸã€æ–¹å¼æ˜¯ä½¿ç”¨å¹¶å‘é›†åˆä¸­çš„ `CopyOnWriteArrayList`ï¼Œå®ƒå‡ ä¹å°±æ˜¯ä¸ºè¿™ä¸ªéœ€æ±‚ä¸“é—¨å®šåˆ¶çš„ã€‚å®ƒæ‰€æœ‰çš„å†™æ“ä½œéƒ½æ˜¯åœ¨åº•å±‚æ•°ç»„çš„æœ€æ–°å‰¯æœ¬ä¸Šå®ç°çš„ã€‚å› ä¸ºåº•å±‚æ•°ç»„æ°¸è¿œä¸ä¼šè¢«ä¿®æ”¹ï¼Œæ‰€ä»¥è¿­ä»£ä¸éœ€è¦åŠ é”ï¼Œå› æ­¤é€Ÿåº¦å¾ˆå¿«ã€‚å¯¹äºå¤§å¤šæ•°ç”¨é€”æ¥è¯´ï¼Œ`CopyOnWriteArrayList` çš„æ€§èƒ½æ˜¯éå¸¸ç³Ÿç³•çš„ï¼Œä½†æ˜¯å¯¹äº `observers` æ¥è¯´ï¼Œå®ƒæ˜¯å®Œç¾çš„ï¼Œå› ä¸ºå®ƒå¾ˆå°‘è¢«ä¿®æ”¹ï¼Œè€Œä¸”ç»å¸¸è¢«éå†ã€‚

`add` å’Œ `addAll` æ–¹æ³•ä¸éœ€è¦æ”¹åŠ¨ï¼Œæ­¤æ—¶æ²¡æœ‰ä»»ä½•æ˜¾å¼çš„åŒæ­¥ï¼š

// Thread-safe observable set with CopyOnWriteArrayList  
private final List<SetObserver<E>> observers = new CopyOnWriteArrayList<>();  
  
public void addObserver(SetObserver<E> observer) {  
    observers.add(observer);  
}  
  
public boolean removeObserver(SetObserver<E> observer) {  
    return observers.remove(observer);  
}  
  
private void notifyElementAdded(E element) {  
    for (SetObserver<E> observer : observers)  
        observer.added(this, element);  
}

### åŒæ­¥å¸¦æ¥çš„æ€§èƒ½é—®é¢˜

åœ¨ Java æ—©æœŸï¼ŒåŒæ­¥çš„æˆæœ¬å°±å·²ç»ä¸‹é™äº†ï¼Œä½†ä»ç„¶ä¸è¦è¿‡åº¦åŒæ­¥ã€‚åœ¨å¤šæ ¸æ—¶ä»£ï¼Œè¿‡åº¦åŒæ­¥çš„çœŸæ­£æˆæœ¬ä¸æ˜¯ CPU èŠ±åœ¨è·å–é”ä¸Šçš„æ—¶é—´ï¼›è€Œæ˜¯ contentionï¼šå¤±å»å¹¶è¡Œçš„æœºä¼šï¼Œä»¥åŠç”±äºéœ€è¦ç¡®ä¿æ¯ä¸ªæ ¸å¯¹å†…å­˜æœ‰ä¸€ä¸ªä¸€è‡´çš„è§†å›¾è€Œé€ æˆçš„å»¶è¿Ÿã€‚è¿‡åº¦åŒæ­¥çš„å¦ä¸€ä¸ªéšè—æˆæœ¬æ˜¯ï¼Œå®ƒå¯ä»¥é™åˆ¶è™šæ‹Ÿæœºä¼˜åŒ–ä»£ç æ‰§è¡Œçš„èƒ½åŠ›ã€‚

#### è§£å†³åŠæ³•

å¦‚æœæ­£åœ¨ç¼–å†™ä¸€ä¸ªå¯å˜çš„ç±»ï¼Œæœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š

1.  å¿½ç•¥æ‰€æœ‰çš„åŒæ­¥ï¼Œè®©å®¢æˆ·ç«¯åœ¨æœ‰å¹¶å‘éœ€æ±‚çš„æ—¶å€™è‡ªè¡ŒåŒæ­¥ï¼›
    
2.  åœ¨ç±»ä¸­å®ç°å†…éƒ¨åŒæ­¥ï¼Œä½¿è¿™ä¸ªç±»æˆä¸ºçº¿ç¨‹å®‰å…¨çš„ï¼ˆè¯¦è§ç¬¬ 82 æ¡ï¼‰ã€‚
    

åªæœ‰å½“ä½ ç”¨å†…éƒ¨åŒæ­¥å®ç°çš„å¹¶å‘æ€§æ˜æ˜¾é«˜äºè®©å®¢æˆ·åœ¨å¤–éƒ¨é”å®šæ•´ä¸ªç±»å®ä¾‹æ—¶ï¼Œä½ æ‰åº”è¯¥é€‰æ‹©ç¬¬äºŒç§æ–¹æ¡ˆã€‚java.util ä¸­çš„é›†åˆï¼ˆé™¤äº†è¿‡æ—¶çš„ Vector å’Œ Hashtable ä¹‹å¤–ï¼‰é‡‡ç”¨å‰è€…ï¼Œè€Œ java.util.concurrent ä¸­çš„é›†åˆåˆ™é‡‡ç”¨åè€…ï¼ˆè¯¦è§ç¬¬ 81 æ¡ï¼‰ã€‚å½“ä½ ä¸ç¡®å®šçš„æ—¶å€™ï¼Œå°±ä¸è¦ä½¿ç”¨å†…éƒ¨åŒæ­¥ï¼Œè€Œåº”è¯¥å»ºç«‹æ–‡æ¡£ï¼Œæ³¨æ˜å®ƒä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ ã€‚

> åœ¨ Java æ—©æœŸï¼Œè®¸å¤šç±»è¿æ³•äº†è¿™äº›æ–¹é’ˆã€‚å¦‚ `StringBuffer` æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†å®ƒå‡ ä¹æ€»æ˜¯è¢«ç”¨åœ¨å•çº¿ç¨‹ç§ã€‚æ‰€ä»¥ `StringBuilder` å–ä»£äº†å®ƒï¼Œ`StringBuilder` å°±æ˜¯ä¸€ä¸ªéåŒæ­¥çš„ `StringBuffer`ã€‚ç±»ä¼¼çš„ï¼Œ java.util.Random ä¸­çº¿ç¨‹å®‰å…¨çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼Œè¢« java.util.concurrent.ThreadLocalRandom ä¸­éåŒæ­¥çš„å®ç°å–ä»£ã€‚

æœ‰ä¸€ç§æƒ…å†µå¿…é¡»ä½¿ç”¨å†…éƒ¨åŒæ­¥ï¼šå¦‚æœä¸€ä¸ªæ–¹æ³•ä¿®æ”¹äº† static çš„åŸŸï¼Œå¹¶ä¸”è¯¥æ–¹æ³•å¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨ï¼Œé‚£ä¹ˆå°±å¿…é¡»åœ¨å†…éƒ¨å¯¹è¯¥åŸŸçš„è®¿é—®åšåŒæ­¥ï¼ˆé™¤éè¿™ä¸ªç±»å¯ä»¥å®¹å¿ä¸ç¡®å®šçš„è¡Œä¸ºï¼‰ã€‚å› ä¸ºå¦‚æœåœ¨è¯¥æ–¹æ³•ä¸­æ²¡æœ‰å¯¹è¢«ä¿®æ”¹çš„ static åŸŸåŒæ­¥ï¼Œå½“æ–¹æ³•è¢«å¤šçº¿ç¨‹è°ƒç”¨åï¼Œå³ä½¿æ–¹æ³•è¢«åŒæ­¥äº†ï¼Œä¹Ÿä¿æŠ¤ä¸åˆ° static åŸŸï¼ˆå› ä¸ºå®ƒæ˜¯å±äºç±»çš„ï¼Œéœ€è¦å¯¹ç±»åŒæ­¥ï¼‰ã€‚

> TODOï¼šè¿™ä¸€æ®µçš„åŸæ–‡åœ¨ä¸‹é¢ï¼Œè¿˜æ˜¯ä¸æ˜¯å¾ˆæ˜ç™½ï¼š
> 
> If a method modifies a static field and there is any possibility that the method will be called from multiple threads, you _must_ synchronize access to the field internally (unless the class can tolerate nondeterministic behavior). It is not possible for a multithreaded client to perform external synchronization on such a method, because unrelated clients can invoke the method without synchronization. The field is essentially a global variable even if it is private because it can be read and modified by unrelated clients. The nextSerialNumber field used by the method generateSerialNumber in Item 78 exemplifies this situation.

### æ€»ç»“

æœ¬èŠ‚è¯´çš„è¿‡åº¦åŒæ­¥ï¼Œä¸æ˜¯æŒ‡å°‘ç”¨é”ï¼Œè€Œæ˜¯æŒ‡åŒæ­¥åŒºåŸŸå°½å¯èƒ½å°ã€‚é€šå¸¸æ¥è¯´ï¼Œåº”è¯¥åœ¨åŒæ­¥åŒºåŸŸå†…åšå°½å¯èƒ½å°‘çš„å·¥ä½œï¼šè·å¾—é”ï¼Œæ£€æŸ¥å…±äº«æ•°æ®ï¼Œæ ¹æ®éœ€è¦è½¬æ¢æ•°æ®ï¼Œç„¶åé‡Šæ”¾é”ã€‚ å¦‚æœä½ å¿…é¡»è¦æ‰§è¡ŒæŸä¸ªå¾ˆè€—æ—¶çš„åŠ¨ä½œï¼Œåˆ™åº”è¯¥è®¾æ³•æŠŠè¿™ä¸ªåŠ¨ä½œç§»åˆ°åŒæ­¥åŒºåŸŸçš„å¤–é¢ï¼Œè€Œä¸è¿èƒŒç¬¬ 78 æ¡ä¸­çš„æŒ‡å¯¼æ–¹é’ˆã€‚å¹¶ä¸”ï¼ŒåŒæ­¥åŒºåŸŸè¶Šå°ï¼Œå¹¶å‘æ€§è¶Šé«˜ã€‚è¿˜æœ‰ï¼Œåƒä¸‡ä¸è¦åœ¨åŒæ­¥åŒºåŸŸå†…è°ƒç”¨å¤–éƒ¨æ–¹æ³•ã€‚

å½“ä½ åœ¨è®¾è®¡ä¸€ä¸ªå¯å˜ç±»çš„æ—¶å€™ï¼Œè¦è€ƒè™‘ä¸€ä¸‹å®ƒä»¬æ˜¯å¦åº”è¯¥è‡ªå·±å®ŒæˆåŒæ­¥æ“ä½œã€‚åœ¨å¤šæ ¸æ—¶ä»£ï¼Œè¿™æ¯”æ°¸è¿œä¸è¦è¿‡åº¦åŒæ­¥æ¥å¾—æ›´é‡è¦ã€‚åªæœ‰å½“ä½ æœ‰è¶³å¤Ÿçš„ç†ç”±ä¸€å®šè¦åœ¨ç±»çš„å†…éƒ¨åŒæ­¥çš„æ—¶å€™ï¼Œæ‰åº”è¯¥è¿™ä¹ˆåšï¼ŒåŒæ—¶è¿˜åº”è¯¥å°†è¿™ä¸ªå†³å®šæ¸…æ¥šåœ°å†™åˆ°æ–‡æ¡£ä¸­ï¼ˆè¯¦è§ç¬¬ 82 æ¡)ã€‚

## 80. executorã€task å’Œ stream ä¼˜äº thread

### Executor Framework

java.util.concurrent ä¸­åŒ…å«äº†ä¸€ä¸ª Executor Frameworkï¼Œè¿™æ˜¯ä¸€ä¸ªçµæ´»çš„åŸºäºæ¥å£çš„ä»»åŠ¡æ‰§è¡Œå·¥å…·ï¼š

ExecutorService exec = Executors.newSingleThreadExecutor();

æ‰§è¡Œä¸€ä¸ª runnableï¼š

exec.execute(runnable);

ç»ˆæ­¢ï¼ˆå¦‚æœä¸æ‰‹åŠ¨ç»ˆæ­¢ï¼ŒVM å¯èƒ½å°±ä¸ä¼šé€€å‡ºï¼‰ï¼š

exec.shutdown();

> ä½¿ç”¨ executor service è¿˜å¯ä»¥å®Œæˆå¾ˆå¤šäº‹ï¼Œæ¯”å¦‚ï¼Œç­‰å¾…æŒ‡å®šä»»åŠ¡å®Œæˆï¼ˆä½¿ç”¨ `get` æ–¹æ³•ï¼‰ã€ç­‰å¾…ä»»åŠ¡é›†åˆä¸­ä»»æ„æˆ–æ‰€æœ‰çš„ä»»åŠ¡å®Œæˆï¼ˆä½¿ç”¨ `invokeAny` æˆ– `invokeAll` æ–¹æ³•ï¼‰ã€ç­‰å¾… executor service ç»ˆæ­¢ï¼ˆä½¿ç”¨ `awaitTermination` æ–¹æ³•ï¼‰ã€åœ¨ä»»åŠ¡å®Œæˆåé€ä¸€éå†ç»“æœï¼ˆä½¿ç”¨ `ExecutorCompletionService`ï¼‰ã€è°ƒåº¦ä»»åŠ¡åœ¨ç‰¹å®šæ—¶é—´æˆ–å‘¨æœŸæ€§æ‰§è¡Œï¼ˆä½¿ç”¨ `ScheduledThreadPollExecutor`ï¼‰ç­‰ç­‰ã€‚

å¦‚æœæƒ³è®©ä¸æ­¢ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†è¯·æ±‚ï¼Œåªè¦è°ƒç”¨ä¸€ä¸ªä¸åŒçš„é™æ€å·¥å‚ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªä¸åŒç§ç±»çš„ executor serviceï¼Œç§°ä½œçº¿ç¨‹æ± ã€‚å¯ä»¥åˆ›å»ºçº¿ç¨‹æ•°é‡å›ºå®šæˆ–å¯å˜çš„çº¿ç¨‹æ± ã€‚`java.util.concurrent.Executors` ç±»æä¾›äº†æ‰€éœ€çš„å¤§å¤šæ•° executorsã€‚å¦‚æœæ²¡æœ‰éœ€è¦çš„ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `ThreadPoolExecutor` ç±»ï¼Œå®ƒå¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± æ“ä½œçš„å‡ ä¹æ¯ä¸€æ–¹é¢ã€‚

### å¦‚ä½•é€‰æ‹© executor service

å¦‚æœæ˜¯ä¸€ä¸ªå°ç¨‹åºï¼Œæˆ–è€…æ˜¯è½»é‡è´Ÿè½½çš„æœåŠ¡å™¨ï¼Œ`Executors.newCachedThreadPool` é€šå¸¸éƒ½ä¼šæ˜¯ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚å› ä¸ºå®ƒä¸éœ€è¦é…ç½®ï¼Œå¹¶ä¸”åœ¨ä¸€èˆ¬æƒ…å†µä¸‹éƒ½èƒ½æ­£ç¡®å·¥ä½œã€‚ä½†æ˜¯ cached thread pool å¹¶ä¸é€‚åˆé«˜è´Ÿè½½çš„ç”Ÿäº§æœåŠ¡å™¨ã€‚å› ä¸ºåœ¨ cached thread pool ä¸­ï¼Œæäº¤çš„ä»»åŠ¡å¹¶æ²¡æœ‰è¿›å…¥é˜Ÿåˆ—ï¼Œè€Œæ˜¯ç›´æ¥äº¤ç»™ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œã€‚å¦‚æœæ²¡æœ‰å¯ç”¨çš„çº¿ç¨‹ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚å¦‚æœä¸€å°æœåŠ¡å™¨çš„è´Ÿè½½å¾ˆé«˜ï¼Œä»¥è‡³äºæ‰€æœ‰çš„ CPU éƒ½è¢«å®Œå…¨åˆ©ç”¨äº†ï¼Œè€Œæ›´å¤šçš„ä»»åŠ¡åˆ°æ¥ï¼Œæ›´å¤šçš„çº¿ç¨‹å°†è¢«åˆ›å»ºï¼Œè¿™åªä¼šè®©æƒ…å†µæ›´åã€‚å› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹æœ€å¥½ä½¿ç”¨ `Executors.newFixedThreadPool`ï¼Œå®ƒæä¾›ä¸€ä¸ªæœ‰å›ºå®šæ•°é‡çº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨`ThreadPoolExecutor` ç±»ï¼Œä»¥è·å¾—æœ€å¤§çš„æ§åˆ¶ã€‚

### é¿å…ç›´æ¥ä½¿ç”¨çº¿ç¨‹

ä¸ä»…åº”è¯¥é¿å…ç¼–å†™è‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—ï¼Œè€Œä¸”ä¸€èˆ¬æ¥è¯´ï¼Œåº”è¯¥é¿å…ç›´æ¥ä½¿ç”¨çº¿ç¨‹ã€‚å½“ç›´æ¥ä½¿ç”¨çº¿ç¨‹æ—¶ï¼Œçº¿ç¨‹æ—¢æ˜¯ä¸€ä¸ªå·¥ä½œå•ä½ï¼Œåˆæ˜¯æ‰§è¡Œæœºåˆ¶ã€‚åœ¨ executor framework ä¸­ï¼Œå·¥ä½œå•ä½å’Œæ‰§è¡Œæœºåˆ¶æ˜¯åˆ†å¼€çš„ã€‚

å·¥ä½œå•ä½ï¼Œä¹Ÿå°±æ˜¯ä»»åŠ¡ã€‚æœ‰ä¸¤ç§ç±»å‹çš„ä»»åŠ¡ï¼Œ`Runnable` å’Œ `Callable`ï¼ˆå®ƒæ¯” `Runnable` å¤šäº†è¿”å›å€¼å¹¶å¯ä»¥æŠ›å‡ºä»»æ„çš„å¼‚å¸¸ï¼‰ã€‚

æ‰§è¡Œä»»åŠ¡çš„ä¸€èˆ¬æœºåˆ¶æ˜¯ executor serviceã€‚å¦‚æœä½ ä»¥ä»»åŠ¡çš„è§’åº¦æ€è€ƒï¼Œå¹¶è®© executor service ä¸ºä½ æ‰§è¡Œä»»åŠ¡ï¼Œåœ¨é€‰æ‹©é€‚å½“çš„æ‰§è¡Œç­–ç•¥æ–¹é¢å°±è·å¾—äº†æå¤§çš„çµæ´»æ€§ã€‚ä»æœ¬è´¨ä¸Šè®²ï¼ŒExecutor Framework æ‰€åšçš„å·¥ä½œæ˜¯æ‰§è¡Œï¼ŒCollections Framework æ‰€åšçš„å·¥ä½œæ˜¯èšåˆ (aggregation)ã€‚

åœ¨ Java 7 ä¸­ï¼ŒExecutor Framework å¾—åˆ°äº†æ‰©å±•ï¼Œå®ƒå¯ä»¥æ”¯æŒ fork-join ä»»åŠ¡äº†ï¼Œè¿™äº›ä»»åŠ¡æ˜¯é€šè¿‡ä¸€ç§ç‰¹æ®Šçš„executor service â€”â€” fork-join pool æ‰§è¡Œçš„ ã€‚ä¸€ä¸ª fork-join ä»»åŠ¡ç”¨ä¸€ä¸ª `ForkJoinTask` å®ä¾‹è¡¨ç¤ºï¼Œå®ƒå¯ä»¥è¢«åˆ†æˆæ›´å°çš„å­ä»»åŠ¡ï¼ŒåŒ…å« `ForkJoinPool` çš„çº¿ç¨‹ä¸ä»…è¦å¤„ç†è¿™äº›ä»»åŠ¡ï¼Œè¿˜è¦ä»å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ â€œå·â€ ä»»åŠ¡ï¼Œä»¥ç¡®ä¿æ‰€æœ‰çš„çº¿ç¨‹ä¿æŒå¿™ç¢Œï¼Œä»è€Œæé«˜ CPU ä½¿ç”¨ç‡å’Œååé‡ï¼Œå¹¶é™ä½å»¶è¿Ÿã€‚fork-join ä»»åŠ¡çš„ç¼–å†™å’Œè°ƒä¼˜æ˜¯å¾ˆæœ‰æŠ€å·§çš„ã€‚å¹¶å‘çš„ streamï¼ˆè¯¦è§ç¬¬ 48 æ¡ï¼‰æ˜¯åœ¨ fork-join pool ä¸Šç¼–å†™çš„ï¼Œå¯ä»¥ç®€å•çš„å°±èƒ½åˆ©ç”¨åˆ° fork-join pool çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œä½†ä½¿ç”¨çš„å‰ææ˜¯å®ƒä»¬æ­£å¥½é€‚ç”¨äºå½“å‰çš„ä»»åŠ¡ã€‚

> 1.  Executor Framework çš„å®Œæ•´å¤„ç†æ–¹æ³•è¶…å‡ºäº†æœ¬ä¹¦çš„è®¨è®ºèŒƒå›´ï¼Œä½†æ˜¯æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å‚é˜…ã€Š Java Concurrency in Practiceã€‹ ä¸€ä¹¦ã€‚
>     
> 2.  Fork-join poolï¼š[https://www.infoq.cn/article/fork-join-introduction](https://www.infoq.cn/article/fork-join-introduction)
>     

## 81. å¹¶å‘å·¥å…·ä¼˜äº wait å’Œ notify

java.util.concurrent æä¾›çš„é«˜çº§å¹¶å‘å·¥å…·åˆ†ä¸ºä¸‰ç±»ï¼š

-   Executor Frameworkï¼Œåœ¨ç¬¬ 80 æ¡ä¸­ç®€è¦ä»‹ç»äº†ï¼›
    
-   å¹¶å‘é›†åˆï¼›
    
-   åŒæ­¥å™¨ã€‚
    

### å¹¶å‘é›†åˆ

å¹¶å‘é›†åˆæ˜¯æ ‡å‡†é›†åˆæ¥å£ï¼Œå¦‚ Listã€Queue å’Œ Map çš„é«˜æ€§èƒ½å¹¶å‘å®ç°ã€‚ä¸ºäº†æä¾›é«˜å¹¶å‘ï¼Œè¿™äº›å®ç°é‡‡ç”¨äº†å†…éƒ¨åŒæ­¥ã€‚

#### åŸå­æ€§è°ƒç”¨å¤šæ–¹æ³•

å› ä¸ºæ— æ³•æ’é™¤å¹¶å‘é›†åˆä¸­çš„å¹¶å‘æ´»åŠ¨ï¼Œè¿™ä¹Ÿæ„å‘³ç€æ— æ³•åœ¨å¹¶å‘é›†åˆä¸­ç»„æˆåŸå­æ€§çš„å¤šæ–¹æ³•è°ƒç”¨ã€‚å› æ­¤ï¼Œæœ‰äº›å¹¶å‘é›†åˆæ¥å£é…å¤‡äº†ä¾èµ–çŠ¶æ€çš„ä¿®æ”¹æ“ä½œï¼ˆstate-dependent modify opreationsï¼‰ï¼Œè¿™äº›æ“ä½œå°†å‡ ä¸ªåŸå§‹æ“ä½œç»„åˆæˆä¸€æ•´ä¸ªåŸå­æ“ä½œã€‚è¿™äº›æ“ä½œè¢«è¯æ˜å¾ˆæœ‰ç”¨ï¼Œæ‰€ä»¥ Java 8 ä¸­ï¼Œåœ¨è¿™äº›å¹¶å‘é›†åˆå¯¹åº”çš„é›†åˆæ¥å£ä¸­ä¹Ÿæ·»åŠ äº†è¿™äº›æ“ä½œã€‚ä¾‹å¦‚ï¼ŒMap çš„ `putIfAbsent(key, value)` æ–¹æ³•ï¼Œå¦‚æœ key ä¸å­˜åœ¨åˆ™æ’å…¥ value å¹¶è¿”å› nullï¼Œå¦‚æœ key å­˜åœ¨ï¼Œåˆ™è¿”å› key æ˜ å°„çš„ valueã€‚

> ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ²¡æœ‰ `putIfAbsent` æ–¹æ³•ï¼ŒConcurrentHashMap å…ˆ get å† put çš„ä¸­é—´å¯èƒ½å¯¼è‡´å¹¶å‘é—®é¢˜ã€‚è€Œåœ¨ get å’Œ put è°ƒç”¨çš„å¤–éƒ¨ä½¿ç”¨åŒæ­¥ï¼Œåªä¼šä½¿ç¨‹åºæ›´æ…¢ã€‚

ä¸‹é¢è¿™ä¸ªæ–¹æ³•æ¨¡æ‹Ÿäº† `String.intern` çš„è¡Œä¸ºï¼š

// Concurrent canonicalizing map atop ConcurrentMap - not optimal  
private static final ConcurrentMap<String, String> map =   
    											new ConcurrentHashMap<>();  
  
public static String intern(String s) {  
    String previousValue = map.putIfAbsent(s, s);  
    return previousValue == null ? s : previousValue;  
}

è¿˜å¯ä»¥è¿›è¡Œä¼˜åŒ–ã€‚`ConcurrentHashMap` å¯¹æŸ¥æ‰¾æ“ä½œè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¦‚ `get`ã€‚å› æ­¤ï¼Œæ›´å¥½çš„åšæ³•çš„æ˜¯å…ˆè°ƒç”¨ `get`ï¼Œç„¶åæ ¹æ® `get` çš„ç»“æœå†³å®šæ˜¯å¦è°ƒç”¨ `putIfAbsent`ã€‚

// Concurrent canonicalizing map atop ConcurrentMap - faster!  
public static String intern(String s) {  
    String result = map.get(s);  
    if (result == null) {  
        result = map.putIfAbsent(s, s);  
        if (result == null)  
            result = s;  
    }  
    return result;  
}

Concurrent collections ä½¿ synchronized collections å¤§å¤šæ•°è¢«åºŸå¼ƒäº†ã€‚ä¾‹å¦‚ï¼Œä¼˜å…ˆä½¿ç”¨ `ConcurrentMap` è€Œä¸æ˜¯ `Collections.synchronizedMap`ã€‚

> Synchronized collections å’Œå¯¹åº” collection çš„æ¯ä¸ªæ–¹æ³•éƒ½ç›¸åŒï¼Œåªæ˜¯å‰è€…ç”¨ synchronized å°†å‡ ä¹æ¯ä¸ªæ–¹æ³•çš„å†…éƒ¨åŒ…èµ·æ¥ã€‚

#### é˜»å¡æ“ä½œ

æœ‰äº›é›†åˆæ¥å£æ‹“å±•å‡ºäº†é˜»å¡æ“ä½œï¼Œå®ƒä»¬ä¼šä¸€ç›´ç­‰å¾…ï¼ˆæˆ–é˜»å¡ï¼‰ç›´åˆ°å¯ä»¥è¢«æˆåŠŸæ‰§è¡Œã€‚ä¾‹å¦‚ `BlockingQueue` æ‰©å±•äº† `Queue` æ¥å£ï¼ŒåŒ…æ‹¬ `take`ã€‚å®ƒåˆ é™¤å¹¶è¿”å›é˜Ÿé¦–å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºåˆ™é˜»å¡ã€‚è¿™å°±ä½¿ `BolckingQueue` å¯ä»¥ç”¨äº work queueï¼ˆä¹Ÿè¢«ç§°ä¸º producer-consumer queueï¼‰ã€‚

> å¤§å¤šæ•° `ExecutorService` çš„å®ç°ï¼ŒåŒ…æ‹¬ `ThreadPoolExecutor`ï¼Œéƒ½ä½¿ç”¨äº† `BlockingQueue`ã€‚

### åŒæ­¥å™¨

åŒæ­¥å™¨å¯ä»¥ä½¿çº¿ç¨‹ä¹‹é—´äº’ç›¸ç­‰å¾…ï¼Œä½¿å®ƒä»¬èƒ½åè°ƒå®ƒä»¬çš„åŠ¨ä½œã€‚æœ€å¸¸ç”¨çš„åŒæ­¥å™¨æ˜¯ `CountDownLatch` å’Œ `Semaphore`ï¼›ä¸å¤ªå¸¸ç”¨çš„æ˜¯ `CyclicBarrier` å’Œ `Exchanger`ï¼›æœ€å¼ºå¤§çš„æ˜¯ `Phaser`ã€‚

`CountdownLatch` æ˜¯ä¸€æ¬¡æ€§ä½¿ç”¨çš„ barrierï¼Œå®ƒå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…ä¸€ä¸ªæˆ–å¤šä¸ªå…¶ä»–çº¿ç¨‹åšäº›äº‹æƒ…ã€‚`CountdownLatch` çš„å”¯ä¸€æ„é€ æ–¹æ³•åªæœ‰ä¸€ä¸ª `int` å‚æ•°ï¼Œå®ƒä»£è¡¨äº†åœ¨æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹è¢«å…è®¸ç»§ç»­è¿›è¡Œä¹‹å‰å¿…é¡»åœ¨ latch ä¸Šè°ƒç”¨ `countDown` æ–¹æ³•çš„æ¬¡æ•°ã€‚

åœ¨è¿™ä¸ªç®€å•çš„åŸºæœ¬ç±»å‹ä¸Šå¯ä»¥ç®€å•åœ°æ„å»ºå‡ºå¾ˆå¤šæœ‰ç”¨çš„ä¸œè¥¿ã€‚ä¾‹å¦‚ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„æ¡†æ¶ä¸ºå¹¶å‘æ‰§è¡Œçš„ action è®¡æ—¶ã€‚è¿™ä¸ªæ¡†æ¶åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒéœ€è¦ä¸€ä¸ª executor æ¥æ‰§è¡Œ actionï¼Œä¸€ä¸ªä»£è¡¨æ‰§è¡Œ action çš„å¹¶å‘çº¿ç¨‹æ•°é‡çš„ concurrency levelï¼Œä»¥åŠä¸€ä¸ªä»£è¡¨ action çš„ `Runnable`ã€‚

// Simple framework for timing concurrent execution  
public static long time(Executor executor, int concurrency,  
                        Runnable action) throws InterruptedException {  
    CountDownLatch ready = new CountDownLatch(concurrency);  
    CountDownLatch start = new CountDownLatch(1);  
    CountDownLatch done  = new CountDownLatch(concurrency);  
    for (int i = 0; i < concurrency; i++) {  
        executor.execute(() -> {  
            ready.countDown(); // Tell timer we're ready  
            try {  
                start.await(); // Wait till peers are ready  
                action.run();  
            } catch (InterruptedException e) {  
                Thread.currentThread().interrupt();  
            } finally {  
                done.countDown();  // Tell timer we're done  
            }  
        });   
    }  
    ready.await(); // Wait for all workers to be ready   
    long startNanos = System.nanoTime();   
    start.countDown(); // And they're off!  
    done.await(); // Wait for all workers to finish   
    return System.nanoTime() - startNanos;  
}

-   å‚æ•° executor å¿…é¡»æ”¯æŒåˆ›å»ºæ•°é‡å¤§äºç­‰äº concurrency level çš„çº¿ç¨‹ï¼Œå¦åˆ™è¿™ä¸ªæµ‹è¯•å°±ä¼šè¿›å…¥é¥¥é¥¿æ­»é”ï¼›
    
-   å¦‚æœå·¥ä½œçº¿ç¨‹æ•æ‰åˆ°äº† `InterruptedException`ï¼Œå°±ä¼šä½¿ç”¨ä¹ æƒ¯ç”¨æ³•`Thread.currentThread().interrupt()` é‡æ–°æ–­è¨€è¿™ä¸ªä¸­æ–­ï¼Œå¹¶ä»å®ƒçš„ run æ–¹æ³•ä¸­è¿”å›ã€‚è¿™æ ·å°±å…è®¸ executor å¯ä»¥åœ¨å…¶è®¤ä¸ºåˆé€‚çš„æ—¶å€™å¤„ç†ä¸­æ–­ã€‚
    
-   å¯¹äºåŒºé—´è®¡æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨ `System.nanoTime` è€Œä¸æ˜¯ `System.currentTimeMillis`ã€‚å‰è€…æ¯”åè€…æ›´å‡†ç¡®ä¹Ÿæ›´ç²¾ç¡®ï¼Œå¹¶ä¸”ä¸å—ç³»ç»Ÿå®æ—¶æ—¶é’Ÿçš„å½±å“ï¼›
    
-   æ³¨æ„æœ¬ä¾‹ä»£ç å¹¶ä¸èƒ½å‡†ç¡®åŠæ—¶ï¼Œé™¤é action çš„å·¥ä½œéœ€è¦æ‰§è¡Œè‡³å°‘ä¸€ç§’ã€‚
    

> æœ¬æ¡åªæ¶‰åŠåˆ°åŒæ­¥å™¨çš„çš®æ¯›ï¼Œäº‹å®ä¸Šä¸Šé¢çš„ä¸‰ä¸ª `CountDownLatch` å¯ä»¥åªç”¨ä¸€ä¸ª `SyclicBarrier` æˆ– `Phaser` å®ä¾‹ä»£æ›¿ï¼Œå¾—åˆ°çš„ä»£ç ä¼šæ›´ç®€æ´ï¼Œä½†ä¹Ÿå¯èƒ½æ›´éš¾ç†è§£ã€‚

### ç»´æŠ¤é—ç•™çš„ wait å’Œ notify

#### å¦‚ä½•ä½¿ç”¨ wait

`wait` æ–¹æ³•ç”¨æ¥ä½¿çº¿ç¨‹ç­‰å¾…æŸä¸ªæ¡ä»¶ã€‚å®ƒå¿…é¡»åœ¨åŒæ­¥åŒºåŸŸè¢«è°ƒç”¨ï¼Œä¸”è°ƒç”¨ `wait` çš„å¯¹è±¡æ˜¯åŒæ­¥åŒºåŸŸæ‰€åŒæ­¥çš„å¯¹è±¡ã€‚ä¸‹é¢æ˜¯ `wait` çš„æ ‡å‡†ä¹ æƒ¯ç”¨æ³•ï¼š

// The standard idiom for using the wait method  
synchronized (obj) {  
    while (<condition does not hold>)  
        obj.wait(); // (Releases lock, and reacquires on wakeup)   
    ... // Perform action appropriate to condition  
}

**æ°¸è¿œä½¿ç”¨ wait-loop å½¢å¼æ¥è°ƒç”¨ wait æ–¹æ³•ï¼Œæ°¸è¿œä¸è¦å†å¾ªç¯å¤–é¢è°ƒç”¨å®ƒã€‚**è¿™ä¸ªå¾ªç¯å¯ä»¥åœ¨ç­‰å¾…å‰å’Œç­‰å¾…åå¯¹æ¡ä»¶è¿›è¡Œæµ‹è¯•ï¼š

-   åœ¨ç­‰å¾…ä¹‹å‰æµ‹è¯•ï¼Œå¦‚æœæ¡ä»¶æˆç«‹å°±è·³è¿‡ç­‰å¾…ï¼Œè¿™å¯¹ç¡®ä¿ liveness æ˜¯æœ‰å¿…è¦çš„ã€‚å¦‚æœæŠŠå¾ªç¯æ¢æˆ ifï¼Œå‡è®¾æ¡ä»¶å·²ç»æˆç«‹ï¼Œå¹¶ä¸”åœ¨çº¿ç¨‹ wait ä¹‹å‰å·²ç»è°ƒç”¨äº†`notify`ï¼ˆæˆ– `notifyAll`ï¼‰æ–¹æ³•ï¼Œå°±ä¸èƒ½ä¿è¯çº¿ç¨‹ä¼šä»ç­‰å¾…ä¸­é†’æ¥ï¼›
    
    > TODOï¼›åŸæ–‡å¦‚ä¸‹ï¼Œçœ‹ä¸æ‡‚
    > 
    > Testing the condition before waiting and skipping the wait if the condition already holds are necessary to ensure liveness. If the condition already holds and the notify (or notifyAll) method has already been invoked before a thread waits, there is no guarantee that the thread will _ever_ wake from the wait.
    
-   åœ¨ç­‰å¾…ä¹‹åæµ‹è¯•æ¡ä»¶ï¼Œå¦‚æœæ¡ä»¶ä¸æˆç«‹çš„è¯ç»§ç»­ç­‰å¾…ï¼Œè¿™å¯¹äºç¡®ä¿ safety æ˜¯å¿…è¦çš„ã€‚å¦‚æœæŠŠå¾ªç¯æ¢æˆ ifï¼Œå‡è®¾æ¡ä»¶ä¸æˆç«‹ï¼Œçº¿ç¨‹è°ƒç”¨äº† wait è¿›å…¥ç­‰å¾…ï¼Œä½†åœ¨æœ‰äº›æƒ…å†µä¸‹çº¿ç¨‹å¯èƒ½è¢«å”¤é†’ä»è€Œç»§ç»­è¿è¡Œï¼Œè¿™å°±å¯èƒ½ç ´åè¢«é”ä¿æŠ¤çš„çº¦æŸå…³ç³»ï¼ˆinvariantï¼‰ã€‚è¿™äº›æƒ…å†µåŒ…æ‹¬ï¼š
    
    -   åœ¨ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `notify` å’Œè¯¥ç­‰å¾…çš„çº¿ç¨‹é†’æ¥ä¹‹é—´ï¼Œå¯èƒ½æœ‰å¦ä¸€ä¸ªçº¿ç¨‹å·²ç»è·å¾—äº†é”å¹¶æ”¹å˜äº†è¢«ä¿æŠ¤çš„çŠ¶æ€ã€‚
        
        > TODOï¼šåŸæ–‡å¦‚ä¸‹ï¼Œçœ‹ä¸æ‡‚
        > 
        > Another thread could have obtained the lock and changed the guarded state between the time a thread invoked notify and the waiting thread woke up.
        
    -   æ¡ä»¶å¹¶ä¸æˆç«‹ï¼Œä½†æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½æœ‰æ„æˆ–æ— æ„è°ƒç”¨äº† `notify` æ–¹æ³•ã€‚åœ¨ public å¯¹è±¡çš„åŒæ­¥åŒºåŸŸå†…è°ƒç”¨å®ƒçš„ wait æ–¹æ³•å°±å¾ˆå®¹æ˜“å‡ºç°è¿™æ ·çš„é—®é¢˜ã€‚
        
    -   å³ä½¿åªæœ‰æŸäº›ç­‰å¾…çº¿ç¨‹çš„æ¡ä»¶å·²ç»è¢«æ»¡è¶³ï¼Œä½†æ˜¯é€šçŸ¥çº¿ç¨‹ï¼ˆnotifying threadï¼‰å¯èƒ½ä»ç„¶è°ƒç”¨ `notifyAll` æ–¹æ³•ã€‚
        
    -   åœ¨æ²¡æœ‰ notify çš„æƒ…å†µä¸‹ï¼Œç­‰å¾…çº¿ç¨‹ä¹Ÿå¯èƒ½ï¼ˆä½†å¾ˆå°‘ï¼‰ä¼šè‹é†’è¿‡æ¥ï¼Œè¿™è¢«ç§°ä¸º â€œä¼ªå”¤é†’â€ã€‚
        

#### notify è¿˜æ˜¯ notifyAll

ä¸€ç§å¸¸è§çš„è¯´æ³•æ˜¯ï¼Œåº”è¯¥å§‹ç»ˆä½¿ç”¨ `notifyAll` æ–¹æ³•ã€‚è¿™æ˜¯åˆç†è€Œä¿å®ˆçš„å»ºè®®ã€‚å®ƒæ€»ä¼šäº§ç”Ÿæ­£ç¡®çš„ç»“æœï¼Œå› ä¸ºå®ƒå¯ä»¥ä¿è¯å°†ä¼šå”¤é†’æ‰€æœ‰éœ€è¦è¢«å”¤é†’çš„çº¿ç¨‹ã€‚ è™½ç„¶ä¹Ÿå¯èƒ½ä¼šå”¤é†’å…¶ä»–ä¸€äº›çº¿ç¨‹ï¼Œä½†æ˜¯è¿™ä¸ä¼šå½±å“ç¨‹åºçš„æ­£ç¡®æ€§ã€‚ è¿™äº›çº¿ç¨‹é†’æ¥ä¹‹åï¼Œä¼šæ£€æŸ¥å®ƒä»¬æ­£åœ¨ç­‰å¾…çš„æ¡ä»¶ï¼Œå¦‚æœå‘ç°æ¡ä»¶å¹¶ä¸æ»¡è¶³ï¼Œå°±ä¼šç»§ç»­ç­‰å¾…ã€‚

ä»ä¼˜åŒ–çš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœå¤„äºç­‰å¾…çŠ¶æ€çš„æ‰€æœ‰çº¿ç¨‹éƒ½åœ¨ç­‰å¾…åŒä¸€ä¸ªæ¡ä»¶ï¼Œè€Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ä»è¿™ä¸ªæ¡ä»¶ä¸­è¢«å”¤é†’ï¼Œé‚£ä¹ˆå°±åº”è¯¥é€‰æ‹©è°ƒç”¨ `notify` æ–¹æ³•ï¼Œè€Œä¸æ˜¯ `notifyAll` æ–¹æ³• ã€‚

å³ä½¿è¿™äº›å‰ææ¡ä»¶éƒ½æ»¡è¶³ï¼Œä¹Ÿè®¸è¿˜æ˜¯æœ‰ç†ç”±ä½¿ç”¨ `notifyAll` æ–¹æ³•è€Œä¸æ˜¯ `notify` æ–¹æ³•ã€‚å°±å¥½åƒæŠŠ wait æ–¹æ³•è°ƒç”¨æ”¾åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œä»¥é¿å…åœ¨ public å¯¹è±¡ä¸Šçš„æ„å¤–æˆ–æ¶æ„çš„ `notify` ä¸€æ ·ï¼Œä½¿ç”¨ `notifyAll` æ–¹æ³•ä»£æ›¿ `notify` æ–¹æ³•å¯ä»¥é¿å…å”¤é†’æ„å¤–æˆ–æ¶æ„ç­‰å¾…ä¸­çš„ä¸ç›¸å…³çº¿ç¨‹ã€‚

### æ€»ç»“

æ€»è€Œè¨€ä¹‹ï¼Œç›´æ¥ä½¿ç”¨ wait æ–¹æ³•å’Œ notify æ–¹æ³•å°±åƒç”¨ â€Java å¹¶å‘æ±‡ç¼–è¯­è¨€â€œ è¿›è¡Œç¼–ç¨‹ä¸€æ ·ï¼Œ è€Œ java.util.concurrent åˆ™æä¾›äº†æ›´é«˜çº§çš„è¯­è¨€ã€‚ä¸è¦åœ¨æ–°ä»£ç ä¸­ä½¿ç”¨ wait æ–¹æ³•å’Œ notify æ–¹æ³•ã€‚å¦‚æœç»´æŠ¤ä½¿ç”¨ wait æ–¹æ³•å’Œ notify æ–¹æ³•çš„ä»£ç ï¼ŒåŠ¡å¿…ç¡®ä¿å§‹ç»ˆä½¿ç”¨ wait-loop æ¥è°ƒç”¨ `wait` æ–¹æ³•ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåº”è¯¥ä¼˜å…ˆä½¿ç”¨ `notifyAll` æ–¹æ³•ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `notify` æ–¹æ³•ï¼›å¦‚æœä½¿ç”¨ `notify` æ–¹æ³•ï¼Œä¸€å®šè¦å°å¿ƒã€‚

## 82. æ–‡æ¡£åŒ–çº¿ç¨‹çš„å®‰å…¨æ€§

â€œå¦‚æœæ–¹æ³•çš„æ–‡æ¡£ä¸­å‡ºç° synchronized ä¿®é¥°ç¬¦ï¼Œåˆ™è¯´æ˜è¿™ä¸ªæ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚â€ è¿™ç§è¯´æ³•æ˜¯é”™è¯¯çš„ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼ŒJavadoc åœ¨è¾“å‡ºä¸­å¹¶ä¸åŒ…å« synchronized ä¿®é¥°ç¬¦ï¼Œå› ä¸ºæ–¹æ³•å£°æ˜ä¸­çš„ synchronized ä¿®é¥°ç¬¦æ˜¯å®ç°ç»†èŠ‚ï¼Œè€Œä¸æ˜¯ API çš„ä¸€éƒ¨åˆ†ã€‚å®ƒå¹¶ä¸ä¸€å®šèƒ½è¡¨æ˜è¿™ä¸ªæ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

å¹¶ä¸”ï¼Œä¸Šé¢çš„è¯´æ³•å°±æ˜¯è®¤ä¸ºçº¿ç¨‹å®‰å…¨æ˜¯ä¸ªéé»‘å³ç™½çš„å±æ€§ã€‚ä½†äº‹å®ä¸Šï¼Œçº¿ç¨‹å®‰å…¨æœ‰å¥½å‡ ç§ç­‰çº§ã€‚ä¸ºäº†å®ç°å®‰å…¨çš„å¹¶å‘ä½¿ç”¨ï¼Œç±»å¿…é¡»æ¸…æ¥šè®°å½•å®ƒæ‰€æ”¯æŒçš„çº¿ç¨‹å®‰å…¨ç­‰çº§ã€‚ä¸‹é¢åˆ—å‡ºäº†éƒ¨åˆ†çº¿ç¨‹å®‰å…¨ç­‰çº§ï¼ŒåŒ…æ‹¬äº†å¤§éƒ¨åˆ†æƒ…å†µï¼š

-   ä¸å¯å˜çš„ï¼šè¿™ä¸ªç±»çš„å®ä¾‹æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦ä»»ä½•å¤–éƒ¨åŒæ­¥ã€‚ä¾‹å¦‚ `String`ã€`Long` å’Œ `BigInteger`ï¼ˆè¯¦è§ç¬¬ 17 æ¡ï¼‰ï¼›
    
-   æ— æ¡ä»¶çš„çº¿ç¨‹å®‰å…¨ï¼šè¿™ä¸ªç±»çš„å®ä¾‹æ˜¯å¯å˜çš„ï¼Œä½†æ˜¯ç±»æœ‰è¶³å¤Ÿçš„å†…éƒ¨åŒæ­¥ï¼Œä½¿å¾—å®ƒçš„å®ä¾‹ä¸éœ€è¦ä»»ä½•å¤–éƒ¨åŒæ­¥å³å¯åœ¨å¹¶å‘ä¸­ä½¿ç”¨ã€‚ä¾‹å¦‚ `AtomicLong` å’Œ `ConcurrentHashMap`ï¼›
    
-   æœ‰æ¡ä»¶çš„çº¿ç¨‹å®‰å…¨ï¼šç±»ä¼¼æ— æ¡ä»¶çš„çº¿ç¨‹å®‰å…¨ï¼Œä½†æœ‰ä¸€äº›æ–¹æ³•ä¼šéœ€è¦å¤–éƒ¨åŒæ­¥ã€‚ä¾‹å¦‚è¢« `Collections.synchronized` åŒ…è£…è¿”å›çš„é›†åˆï¼Œå®ƒä»¬çš„è¿­ä»£å™¨è¦æ±‚å¤–éƒ¨åŒæ­¥ï¼›
    
-   éçº¿ç¨‹å®‰å…¨ï¼šè¿™ä¸ªç±»çš„å®ä¾‹æ˜¯å¯å˜çš„ï¼Œä¸ºäº†å¹¶å‘ä½¿ç”¨å®ƒä»¬ï¼Œå¿…é¡»ä½¿ç”¨å¤–éƒ¨åŒæ­¥æ¥åŒ…å›´æ¯ä¸ªæ–¹æ³•è°ƒç”¨ï¼ˆæˆ–æ–¹æ³•è°ƒç”¨åºåˆ—ï¼‰ã€‚å¦‚ `ArrayList` å’Œ `HashMap`ï¼›
    
-   çº¿ç¨‹å¯¹ç«‹ï¼ˆThread-hostileï¼‰ï¼šåœ¨å¹¶å‘ä¸­ï¼Œå³ä½¿æ¯ä¸ªæ–¹æ³•è°ƒç”¨éƒ½ä½¿ç”¨äº†å¤–éƒ¨åŒæ­¥ï¼Œè¿™ä¸ªç±»ä¹Ÿæ˜¯ä¸å®‰å…¨çš„ã€‚çº¿ç¨‹å¯¹ç«‹é€šå¸¸æ˜¯ç”±äºåœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹ä¿®æ”¹é™æ€æ•°æ®é€ æˆçš„ã€‚æ²¡æœ‰äººæ•…æ„å†™ä¸€ä¸ªçº¿ç¨‹æ•Œå¯¹çš„ç±»ï¼Œè¿™ç§ç±»é€šå¸¸æ˜¯ç”±äºæ²¡æœ‰è€ƒè™‘åˆ°å¹¶å‘æ€§è€Œå¯¼è‡´çš„ã€‚å½“ä¸€ä¸ªç±»æˆ–æ–¹æ³•è¢«å‘ç°å¯¹çº¿ç¨‹æœ‰æ•Œæ„æ—¶ï¼Œå®ƒé€šå¸¸ä¼šè¢«ä¿®å¤æˆ–åºŸå¼ƒã€‚å¦‚ç¬¬ 78 é¡¹ä¸­çš„ `generateSerialNumber` æ–¹æ³•åœ¨æ²¡æœ‰å†…éƒ¨åŒæ­¥çš„æƒ…å†µä¸‹å°†æ˜¯çº¿ç¨‹å¯¹ç«‹çš„ï¼ˆè¯¦è§ç¬¬ 322 é¡µï¼‰ã€‚
    

> ä¸Šé¢çš„åˆ†ç±»ï¼ˆé™¤äº†çº¿ç¨‹å¯¹ç«‹ï¼‰éƒ½å¤§è‡´å’Œã€ŠJava Concurrency in Practiceã€‹ä¹¦ä¸­çš„ thread safety annotations å¯¹åº”ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ `Immutable`ã€`ThreadSafe` å’Œ `NotThreadSafe`ã€‚æ— æ¡ä»¶çš„çº¿ç¨‹å®‰å…¨å’Œæœ‰æ¡ä»¶çš„çº¿ç¨‹å®‰å…¨éƒ½åŒ…æ‹¬åœ¨ `ThreadSafe` æ³¨è§£é‡Œã€‚

åœ¨å†™æœ‰æ¡ä»¶çº¿ç¨‹å®‰å…¨ç±»çš„æ–‡æ¡£æ—¶è¦ååˆ†æ³¨æ„ï¼Œå¿…é¡»æŒ‡æ˜å“ªäº›è°ƒç”¨åºåˆ—éœ€è¦å¤–éƒ¨åŒæ­¥ï¼Œè¿˜è¦æŒ‡æ˜å“ªä¸€ä¸ªé”ï¼ˆå°‘æ•°æƒ…å†µä¸‹å¯èƒ½æ˜¯å¥½å‡ ä¸ªé”ï¼‰å¿…é¡»è·å¾—ï¼Œæ‰èƒ½æ‰§è¡Œè¿™äº›è°ƒç”¨åºåˆ—ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé”éƒ½æ˜¯å®ä¾‹è‡ªèº«ï¼Œä½†ä¹Ÿæœ‰ä¾‹å¤–ã€‚æ¯”å¦‚ï¼Œ`Collections.synchronizedMap` çš„æ–‡æ¡£æœ‰è¿™æ ·çš„è¯´æ˜ï¼š

It is imperative that the user manually synchronize on the returned map when iterating over any of its collection views:  
Map<K, V> m = Collections.synchronizedMap(new HashMap<>());  
Set<K> s = m.keySet();  // Needn't be in synchronized block  
	...  
synchronized(m) {  // Synchronizing on m, not s!  
    for (K key : s)  
        key.f();  
}

ç±»çš„çº¿ç¨‹å®‰å…¨è¯´æ˜é€šå¸¸æ”¾åœ¨ç±»çš„æ–‡æ¡£æ³¨é‡Šä¸­ï¼Œä½†æ˜¯æœ‰ç‰¹æ®Šçº¿ç¨‹å®‰å…¨å±æ€§çš„æ–¹æ³•åº”è¯¥åœ¨è‡ªå·±çš„æ–‡æ¡£æ³¨é‡Šä¸­ä½œå‡ºè¯´æ˜è¿™äº›å±æ€§ã€‚æ²¡æœ‰å¿…è¦è¯´æ˜æšä¸¾ç±»å‹çš„ä¸å¯å˜æ€§ã€‚é™æ€å·¥å‚å¿…é¡»æ³¨æ˜è¿”å›å¯¹è±¡çš„çº¿ç¨‹å®‰å…¨ï¼ˆé™¤éè¿™åœ¨è¿”å›ç±»å‹ä¸­å¾ˆæ˜æ˜¾ï¼‰ï¼Œä¾‹å¦‚ä¸Šé¢çš„ `Collections.synchronizedMap`ã€‚

å½“ä¸€ä¸ªç±»ä½¿ç”¨ä¸€ä¸ª public é”æ—¶ï¼Œå®ƒå°±å…è®¸äº†å®¢æˆ·ç«¯å¯ä»¥åŸå­æ€§åœ°è°ƒç”¨ä¸€ç³»åˆ—æ–¹æ³•ï¼ˆä¸ªäººç†è§£ï¼šå› ä¸ºå®¢æˆ·ç«¯èƒ½æ‹¿åˆ°è¿™ä¸ªç±»ä½¿ç”¨çš„é”ï¼Œä¹Ÿå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªé”åŒæ—¶æ¥åŒæ­¥è¿™ä¸ªç±»çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä»è€Œåšåˆ°åŸå­æ€§ï¼‰ï¼Œä½†æ˜¯è¿™ç§çµæ´»æ€§æ˜¯è¦ä»˜å‡ºä»£ä»·çš„ã€‚å®ƒä¸é«˜æ€§èƒ½çš„å†…éƒ¨å¹¶å‘æ§åˆ¶ä¸å…¼å®¹ï¼Œä¾‹å¦‚ `ConcurrentHashMap` ç­‰å¹¶å‘é›†åˆæ‰€ä½¿ç”¨çš„é‚£ç§ã€‚åŒæ ·ï¼Œå®¢æˆ·ç«¯å¯ä»¥æœ‰æ„æˆ–æ— æ„é€šè¿‡é•¿æœŸå æœ‰è¿™ä¸ª public lock æ¥å‘èµ·ï¼ˆmountï¼‰æ‹’ç»æœåŠ¡æ”»å‡»ï¼ˆdenial-of- service attackï¼‰ã€‚

ä¸ºäº†é˜²æ­¢æ‹’ç»æœåŠ¡æ”»å‡»ï¼Œå¯ä»¥æ”¹ç”¨ä¸€ä¸ª private é”å¯¹è±¡æ¥ä»£æ›¿ä½¿ç”¨ synchronized ä¿®é¥°çš„æ–¹æ³•ï¼ˆè¿™ç§æ–¹æ³•å®é™…ä¸Šæä¾›äº† public é”å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªç±»çš„å®ä¾‹ï¼‰ï¼š

// Private lock object idiom - thwarts denial-of-service attack  
private final Object lock = new Object();  
  
public void foo() {  
    synchronized(lock) {  
        ...   
    }  
}

å®é™…ä¸Šè¿™é‡Œä½¿ç”¨äº†ç¬¬ 15 æ¡çš„å»ºè®®ï¼ŒæŠŠé”å¯¹è±¡å°è£…åœ¨å®ƒæ‰€åŒæ­¥çš„å¯¹è±¡ä¸­ã€‚è¿™ä¸ªé”è¢«å£°æ˜ä¸º `final`ï¼Œè¿™é˜²æ­¢ä¸å°å¿ƒæ”¹å˜äº†å®ƒçš„å†…å®¹ï¼Œä»è€Œå¯¼è‡´ç¾éš¾æ€§åœ°éåŒæ­¥è®¿é—®ï¼ˆè¯¦è§ç¬¬ 79 æ¡ï¼‰ã€‚è¿™ä¹Ÿæ˜¯åœ¨ç”¨ç¬¬ 17 æ¡çš„å»ºè®®ï¼Œæœ€å°åŒ–é”åŸŸçš„å¯ä¿®æ”¹æ€§ã€‚æ— è®ºä½¿ç”¨æ™®é€šçš„ç›‘è§†å™¨é”è¿˜æ˜¯ `java.util.concurrent.locks` åŒ…ä¸­çš„é”ï¼Œéƒ½åº”è¯¥å°†é”åŸŸå£°æ˜ä¸º `final` çš„ã€‚

private é”å¯¹è±¡æ¨¡å¼åªå¯ä»¥ç”¨äºæ— æ¡ä»¶çº¿ç¨‹å®‰å…¨çš„ç±»ã€‚æœ‰æ¡ä»¶çº¿ç¨‹å®‰å…¨çš„ç±»ä¸èƒ½ç”¨ï¼Œå› ä¸ºå®ƒä»¬å¿…é¡»æ³¨æ˜å®¢æˆ·ç«¯åœ¨æ‰§è¡ŒæŸä¸ªæ–¹æ³•è°ƒç”¨åºåˆ—çš„æ—¶å€™éœ€è¦è·å¾—å“ªäº›é”ã€‚

private é”å¯¹è±¡æ¨¡å¼å°¤å…¶é€‚åˆé‚£äº›ä¸“é—¨ä¸ºç»§æ‰¿è®¾è®¡çš„ç±»ï¼ˆè¯¦è§ç¬¬ 19 æ¡ï¼‰ã€‚å¦‚æœè¿™ç§å¯¹è±¡ä½¿ç”¨å®ƒä»¬çš„å®ä¾‹ä½œä¸ºé”ï¼Œå­ç±»å°±å¯èƒ½å¾ˆè½»æ¾åœ°å¹²æ¶‰çˆ¶ç±»çš„æ“ä½œï¼Œåä¹‹äº¦ç„¶ã€‚è¿™ç§æƒ…å†µåœ¨ `Thread` ç±»ä¸Šå‡ºç°è¿‡ã€‚

> çˆ¶ç±»çš„åŒæ­¥æ–¹æ³•å¯ä»¥è¢«å­ç±»é‡å†™è€Œé¿å…åŒæ­¥ï¼Œè¿™æ˜¯äººä¸ºå› ç´ ï¼Œæ˜¯æ— è®ºå¦‚ä½•ä¹Ÿè§£å†³ä¸äº†çš„ã€‚private é”å¯¹è±¡æ¨¡å¼åªæ˜¯åœ¨ç¼–å†™å­ç±»çš„æ—¶å€™ï¼Œä»¥æ›´å¥½çš„æ–¹å¼æ¥ä¸å¹²æ‰°çˆ¶ç±»æˆ–ä¸è®©çˆ¶ç±»å¹²æ‰°è‡ªå·±ã€‚
> 
> [https://wiki.sei.cmu.edu/confluence/display/java/TSM00-J.+Do+not+override+thread-safe+methods+with+methods+that+are+not+thread-safe](https://wiki.sei.cmu.edu/confluence/display/java/TSM00-J.+Do+not+override+thread-safe+methods+with+methods+that+are+not+thread-safe)
> 
> ä¸è¿‡è¿™æ®µè¯è¿˜æ˜¯ä¸æ˜¯å¾ˆèƒ½çœ‹æ‡‚ï¼ŒåŸæ–‡ï¼ˆTODOï¼‰ï¼š
> 
> The private lock object idiom is particularly well-suited to classes designed for inheritance (Item 19). If such a class were to use its instances for locking, a subclass could easily and unintentionally interfere with the operation of the base class, or vice versa. By using the same lock for different purposes, the subclass and the base class could end up â€œstepping on each otherâ€™s toes.â€ This is not just a theoretical problem; it happened with the Thread class [Bloch05, Puzzle 77].

æ€»è€Œè¨€ä¹‹ï¼Œæ¯ä¸ªç±»çš„æ–‡æ¡£éƒ½åº”è¯¥æ¸…æ¥šåœ°æ³¨æ˜å®ƒçš„çº¿ç¨‹å®‰å…¨å±æ€§ï¼Œ`synchronized` ä¿®é¥°ç¬¦ä¸è¿™ä¸ªæ–‡æ¡£æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚æœ‰æ¡ä»¶çš„çº¿ç¨‹å®‰å…¨ç±»å¿…é¡»æ³¨æ˜å“ªäº›æ–¹æ³•è°ƒç”¨åºåˆ—éœ€è¦å¤–éƒ¨åŒæ­¥ï¼Œä»¥åŠåœ¨æ‰§è¡Œè¿™äº›åºåˆ—çš„æ—¶å€™è¦è·å¾—å“ªä¸ªé”ã€‚åœ¨ç¼–å†™æ— æ¡ä»¶çš„çº¿ç¨‹å®‰å…¨ç±»çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ private é”å¯¹è±¡æ¥ä»£æ›¿åŒæ­¥æ–¹æ³•ã€‚è¿™å¯ä»¥ä¿æŠ¤åŒæ­¥æ—¶ä¸å—æ¥è‡ªå®¢æˆ·ç«¯å’Œå­ç±»çš„å¹²æ‰°ï¼Œå¹¶ä½¿ä½ åœ¨ä»¥åçš„ç‰ˆæœ¬ä¸­æ›´çµæ´»åœ°å¯¹å¹¶å‘æ§åˆ¶é‡‡ç”¨æ›´åŠ å¤æ‚çš„æ–¹æ³•ã€‚

## 83. æ…ç”¨æ‡’åŠ è½½

### ä»€ä¹ˆæ˜¯æ‡’åŠ è½½

æ‡’åŠ è½½æ˜¯å°†åŸŸçš„åˆå§‹åŒ–æ¨è¿Ÿåˆ°éœ€è¦å®ƒçš„å€¼æ—¶æ‰è¿›è¡Œã€‚å¦‚æœæ°¸è¿œä¸éœ€è¦å®ƒçš„å€¼ï¼Œè¿™ä¸ªåŸŸå°±æ°¸è¿œä¸ä¼šè¢«åˆå§‹åŒ–ã€‚è¿™ç§æ–¹å¼é€‚ç”¨äº static åŸŸå’Œå®ä¾‹åŸŸã€‚è™½ç„¶æ‡’åŠ è½½ä¸»è¦æ˜¯ä¸€ç§ä¼˜åŒ–ï¼Œä½†å®ƒä¹Ÿå¯ä»¥ç”¨æ¥æ‰“ç ´ç±»å’Œå®ä¾‹åˆå§‹åŒ–ä¸­çš„æœ‰å®³å¾ªç¯ï¼ˆharmful circularitiesï¼ŒTODOï¼šä»€ä¹ˆæ˜¯æœ‰å®³å¾ªç¯ï¼‰ã€‚

æ­£å¦‚ç¬¬ 67 æ¡æ‰€è¯´ï¼Œå’Œå¤§å¤šæ•°ä¼˜åŒ–ä¸€æ ·ï¼Œå¯¹æ‡’åŠ è½½æœ€å¥½çš„å»ºè®®å°±æ˜¯ã€Œé™¤ééœ€è¦ï¼Œå¦åˆ™ä¸è¦åšã€ã€‚æ‡’åŠ è½½æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œå®ƒé™ä½äº†åˆå§‹åŒ–ç±»æˆ–åˆ›å»ºå®ä¾‹æ—¶çš„å¼€é”€ï¼Œä½†ä¹Ÿå¢åŠ äº†è®¿é—®è¢«æ‡’åŠ è½½çš„åŸŸçš„å¼€é”€ã€‚æ ¹æ®è¿™äº›åŸŸä¸­æœ€ç»ˆéœ€è¦åˆå§‹åŒ–çš„éƒ¨åˆ†ã€åˆå§‹åŒ–å®ƒä»¬çš„æˆæœ¬æœ‰å¤šé«˜ã€ä»¥åŠæ¯ä¸ªåŸŸåœ¨åˆå§‹åŒ–åè¢«è®¿é—®çš„é¢‘ç‡ï¼Œæ‡’åŠ è½½ï¼ˆåƒè®¸å¤š "ä¼˜åŒ–" ä¸€æ ·ï¼‰å¯èƒ½ä¼šæŸå®³æ€§èƒ½ã€‚å°½ç®¡å¦‚æ­¤ï¼Œæ‡’åŠ è½½ä¹Ÿæœ‰å…¶ç”¨é€”ã€‚å¦‚æœä¸€ä¸ªåŸŸåªåœ¨ä¸€ä¸ªç±»çš„ä¸€éƒ¨åˆ†å®ä¾‹ä¸Šè¢«è®¿é—®ï¼Œå¹¶ä¸”åˆå§‹åŒ–è¯¥åŸŸçš„æˆæœ¬å¾ˆé«˜ï¼Œé‚£ä¹ˆæ‡’åŠ è½½å¯èƒ½æ˜¯å€¼å¾—çš„ã€‚å”¯ä¸€èƒ½ç¡®å®šçš„æ–¹æ³•æ˜¯æµ‹é‡æœ‰æ— æ‡’åŠ è½½çš„ç±»çš„æ€§èƒ½ã€‚

åœ¨æœ‰å¤šä¸ªçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œæ‡’åŠ è½½æ˜¯å¾ˆæ£˜æ‰‹çš„ã€‚å¦‚æœå¤šä¸ªçº¿ç¨‹å…±äº«ä¸€ä¸ªæ‡’åŠ è½½çš„åŸŸï¼Œå°±å¿…é¡»é‡‡ç”¨æŸç§å½¢å¼çš„åŒæ­¥ï¼Œå¦åˆ™ä¼šäº§ç”Ÿä¸¥é‡çš„é”™è¯¯ï¼ˆè¯¦è§ç¬¬ 78 æ¡ï¼‰ã€‚æœ¬æ¡ä¸­è®¨è®ºçš„æ‰€æœ‰åˆå§‹åŒ–æŠ€æœ¯éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

### æ­£å¸¸çš„åˆå§‹åŒ–å’Œæ‡’åŠ è½½

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ­£å¸¸çš„åˆå§‹åŒ–éƒ½ä¼˜äºæ‡’åŠ è½½ã€‚ä¸‹é¢æ˜¯æ­£å¸¸åˆå§‹åŒ–å®ä¾‹åŸŸçš„å…¸å‹ä¾‹å­ï¼š

// Normal initialization of an instance field  
private final FieldType field = computeFieldValue();

å¦‚æœä½¿ç”¨æ‡’åŠ è½½æ¥ç ´ååˆå§‹åŒ–å¾ªç¯ï¼ˆinitialization circularityï¼‰ï¼Œè¦ä½¿ç”¨ä¸€ä¸ªåŒæ­¥çš„è®¿é—®æ–¹æ³•ï¼Œå› ä¸ºè¿™æ˜¯æœ€ç®€å•æ¸…æ¥šçš„æ–¹æ³•ï¼š

// Lazy initialization of instance field - synchronized accessor  
   
private FieldType field;  
private synchronized FieldType getField() {   
    if (field == null)  
        field = computeFieldValue();  
    return field;  
}

è¿™ä¸¤ç§æ–¹æ³•åº”ç”¨åˆ° static åŸŸæ—¶ä¿æŒä¸å˜ï¼Œé™¤äº†è¦åœ¨åŸŸå’Œè®¿é—®å™¨å£°æ˜ä¸­åŠ ä¸Š static ä¿®é¥°ç¬¦ã€‚

### æ›´å¥½çš„ä½¿ç”¨æ‡’åŠ è½½

#### static åŸŸ

å¦‚æœéœ€è¦åœ¨ static åŸŸä¸Šä½¿ç”¨æ‡’åŠ è½½ï¼Œä½¿ç”¨ lazy initialization holder class æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼ä¿è¯äº†ç±»ç›´åˆ°è¢«ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–ï¼š

// Lazy initialization holder class idiom for static fields  
private static class FieldHolder {  
	static final FieldType field = computeFieldValue();  
}  
  
private static FieldType getField() {   
    return FieldHolder.field;   
}

å½“ç¬¬ä¸€æ¬¡è°ƒç”¨ `getField` æ–¹æ³•çš„æ—¶å€™ï¼Œå®ƒç¬¬ä¸€æ¬¡è¯»å– `FieldHolder.field`ï¼Œå¯¼è‡´ `FieldHolder` ç±»çš„åˆå§‹åŒ–ã€‚è¿™ç§ç”¨æ³•çš„å¥½å¤„æ˜¯ï¼Œ`getField` æ–¹æ³•æ²¡æœ‰è¢«åŒæ­¥ï¼Œä¸”åªæ‰§è¡Œäº†ä¸€ä¸ªåŸŸçš„è®¿é—®ï¼Œæ‰€ä»¥æ‡’åŠ è½½å®é™…ä¸Šæ²¡æœ‰å¢åŠ ä»»ä½•è®¿é—®çš„æˆæœ¬ã€‚ç°ä»£çš„ VM å°†åœ¨åˆå§‹ åŒ–è¯¥ç±»çš„æ—¶å€™ï¼ŒåŒæ­¥åŸŸçš„è®¿é—®ã€‚ä¸€æ—¦è¿™ä¸ªç±»è¢«åˆå§‹åŒ–ï¼ŒVM å°†ä¿®è¡¥ä»£ç ï¼Œä»¥ä¾¿åç»­å¯¹è¯¥åŸŸçš„è®¿é—®ä¸ä¼šå¯¼è‡´ä»»ä½•æµ‹è¯•æˆ–è€…åŒæ­¥ ã€‚

#### å®ä¾‹åŸŸ

#### double-check

å¦‚æœéœ€è¦åœ¨å®ä¾‹åŸŸä¸Šä½¿ç”¨æ‡’åŠ è½½ï¼Œä½¿ç”¨åŒé‡æ£€æŸ¥æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼é¿å…äº†åŸŸåŠ è½½ä¹‹åçš„è®¿é—®è¿˜éœ€è¦åŠ é”ï¼ˆè¯¦è§ç¬¬ 79 æ¡ï¼‰ã€‚å› ä¸ºå¦‚æœåŸŸè¢«åˆå§‹åŒ–ä¹‹åï¼Œå°±ä¸ä¼šå†æœ‰åŒæ­¥äº†ï¼Œæ‰€ä»¥å¿…é¡»å°†è¿™ä¸ªåŸŸå£°æ˜ä¸º `volatile`ï¼š

// Double-check idiom for lazy initialization of instance fields   
private volatile FieldType field;  
  
private FieldType getField() {  
    FieldType result = field;  
    if (result == null) {  // First check (no locking)  
        synchronized(this) {  
            if (field == null)  // Second check (with locking)  
                field = result = computeFieldValue();  
        }   
    }  
    return result;  
}

`getField` æ–¹æ³•ä¸­ä½¿ç”¨äº† `result` å˜é‡ï¼Œå®ƒçš„ä½œç”¨æ˜¯ç¡®ä¿åœ¨å·²ç»åˆå§‹åŒ–çš„å¸¸è§æƒ…å†µä¸‹ï¼ŒåŸŸåªè¢«è¯»å–ä¸€æ¬¡ã€‚è™½ç„¶ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„å¿…è¦ï¼Œä½†è¿™å¯èƒ½ä¼šæé«˜æ€§èƒ½ï¼Œè€Œä¸”æŒ‰ç…§é€‚ç”¨äºä½çº§å¹¶å‘ç¼–ç¨‹çš„æ ‡å‡†ï¼Œè¿™æ ·åšæ›´ä¼˜é›…ã€‚åœ¨ä½œè€…çš„æœºå™¨ä¸Šï¼Œä¸Šè¿°æ–¹æ³•çš„é€Ÿåº¦å¤§çº¦æ˜¯æ²¡æœ‰å±€éƒ¨å˜é‡çš„æ˜æ˜¾ç‰ˆæœ¬çš„ 1.4 å€ã€‚ï¼ˆå› ä¸ºåœ¨æœ¬åœ°æ–¹æ³•æ ˆä¸­ï¼Ÿï¼‰

> è™½ç„¶ä¹Ÿå¯ä»¥å¯¹æ‡’åŠ è½½çš„ static åŸŸä½¿ç”¨åŒé‡æ£€æŸ¥æ¨¡å¼ï¼Œä½†æ²¡æœ‰å¿…è¦ï¼Œå› ä¸º lazy initialization holder class æ¨¡å¼æ›´å¥½ã€‚

#### single-check

æœ‰æ—¶å¯èƒ½éœ€è¦æ‡’åŠ è½½ä¸€ä¸ªå¯ä»¥å®¹å¿é‡å¤åˆå§‹åŒ–çš„å®ä¾‹åŸŸï¼Œå¯ä»¥ä½¿ç”¨åŒé‡æ£€æŸ¥æ¨¡å¼çš„ä¸€ä¸ªå˜ä½“ï¼Œå®ƒçœå»äº†ç¬¬äºŒæ¬¡æ£€æŸ¥ã€‚è¿™å°±æ˜¯æ‰€è°“çš„å•æ¬¡æ£€æŸ¥æ¨¡å¼ã€‚ä¸‹é¢æ˜¯å®ƒçš„æ ·å­ã€‚æ³¨æ„ï¼ŒåŸŸä»ç„¶è¢«å£°æ˜ä¸º `volatile`ï¼š

// Single-check idiom - can cause repeated initialization!   
private volatile FieldType field;  
private FieldType getField() {  
    FieldType result = field;  
    if (result == null)  
        field = result = computeFieldValue();  
    return result;  
}

> æœ¬æ¡ç›®ä¸­è®¨è®ºçš„æ‰€æœ‰åˆå§‹åŒ–æ–¹æ³•éƒ½é€‚ç”¨äºåŸºæœ¬ç±»å‹çš„åŸŸï¼Œä¹Ÿé€‚ç”¨äºå¯¹è±¡å¼•ç”¨åŸŸã€‚å½“å¯¹æ•°å€¼å‹åŸºæœ¬ç±»å‹åŸŸä½¿ç”¨åŒé‡æ£€æŸ¥æˆ–å•æ¬¡æ£€æŸ¥æ¨¡å¼çš„æ—¶å€™ï¼Œå°±ä¼šç”¨ 0 æ¥æ£€æŸ¥è¿™ä¸ªåŸŸçš„å€¼è€Œä¸æ˜¯ nullã€‚

#### racy single-check

å½“ä½¿ç”¨å•æ¬¡æ£€æŸ¥æ¨¡å¼æ—¶ï¼Œå¦‚æœå¹¶ä¸åœ¨æ„**æ¯ä¸ª**çº¿ç¨‹éƒ½é‡æ–°è®¡ç®—åŸŸçš„å€¼ï¼Œå¹¶ä¸”åŸŸæ˜¯åŸºæœ¬ç±»å‹ï¼ˆé™¤äº† `long` å’Œ `double`ï¼‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€‰æ‹©ä»åŸŸçš„å£°æ˜å¤„åˆ é™¤ `volatile` ä¿®é¥°ç¬¦ã€‚è¿™ç§å˜ä½“ç§°ä½œ racy single-check æ¨¡å¼ã€‚å®ƒåŠ å¿«äº†æŸäº›æ¶æ„ä¸Šçš„åŸŸè®¿é—®ã€‚ä»£ä»·æ˜¯å¢åŠ äº†é¢å¤–çš„åˆå§‹åŒ–ï¼ˆæ¯ä¸ªè®¿é—®åŸŸçš„çº¿ç¨‹æœ€å¤šåˆå§‹åŒ–ä¸€æ¬¡ï¼‰ã€‚è¿™æ˜¾ç„¶æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–¹æ³•ï¼Œä¸é€‚åˆæ—¥å¸¸ä½¿ç”¨ã€‚

> TODOï¼šè¿™ä¸¤ç§ single-check çš„åŒºåˆ«å°±æ˜¯ç¬¬ä¸€ç§é‡å¤åˆå§‹åŒ–çš„æ¬¡æ•°ä¼šå°‘ä¸€ç‚¹ï¼Ÿ

## 84. ä¸è¦ä¾èµ–çº¿ç¨‹è°ƒåº¦å™¨

å½“å¤šä¸ªçº¿ç¨‹å¯ä»¥è¿è¡Œæ—¶ï¼Œçº¿ç¨‹è°ƒåº¦å™¨å†³å®šäº†å“ªä¸ªè¿è¡Œï¼Œä»¥åŠè¿è¡Œå¤šä¹…ã€‚æ¯ä¸ªæ“ä½œç³»ç»Ÿéƒ½ä¼šè¯•å›¾è®©è¿™ä¸ªå†³å®šå˜å¾—å…¬æ­£ï¼Œä½†å®ƒä»¬çš„ç­–ç•¥ä¸åŒã€‚**ä»»ä½•ä¾èµ–äºçº¿ç¨‹è°ƒåº¦å™¨æ¥è¾¾åˆ°æ­£ç¡®æ€§æˆ–æ€§èƒ½è¦æ±‚çš„ç¨‹åºï¼Œå¾ˆæœ‰å¯èƒ½éƒ½æ˜¯ä¸å¯ç§»æ¤çš„ã€‚**

### å¯è¿è¡Œçº¿ç¨‹å¹³å‡æ•°é‡ä»¥åŠæ‰€åšçš„ä»»åŠ¡

ç¼–å†™å¥å£®ã€å“åº”å¿«ã€å¯ç§»æ¤çš„ç¨‹åºï¼Œæœ€å¥½çš„åŠæ³•æ˜¯ç¡®ä¿å¯è¿è¡Œçº¿ç¨‹çš„å¹³å‡æ•°é‡ä¸æ˜æ˜¾å¤§äºå¤„ç†å™¨çš„æ•°é‡ã€‚è¿™ä½¿å¾—çº¿ç¨‹è°ƒåº¦å™¨æ²¡æœ‰ä»€ä¹ˆé€‰æ‹©ï¼šå®ƒåªæ˜¯è¿è¡Œå¯è¿è¡Œçš„çº¿ç¨‹ï¼Œç›´åˆ°å®ƒä»¬ä¸å†å¯è¿è¡Œã€‚å³ä½¿åœ¨å®Œå…¨ä¸åŒçš„çº¿ç¨‹è°ƒåº¦ç­–ç•¥ä¸‹ï¼Œç¨‹åºçš„è¡Œä¸ºä¹Ÿä¸ä¼šæœ‰å¤ªå¤§çš„å˜åŒ–ã€‚è¯·æ³¨æ„ï¼Œå¯è¿è¡Œçº¿ç¨‹çš„æ•°é‡å¹¶ä¸ç­‰åŒäºçº¿ç¨‹çš„æ€»æ•°ï¼Œåè€…å¯èƒ½è¦é«˜å¾—å¤šï¼Œæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹æ˜¯ä¸èƒ½è¿è¡Œçš„ã€‚

ä¿æŒå¯è¿è¡Œçº¿ç¨‹æ•°é‡å°‘çš„ä¸»è¦æ–¹æ³•æ˜¯è®©æ¯ä¸ªçº¿ç¨‹åšä¸€äº›æœ‰ç”¨çš„å·¥ä½œï¼Œç„¶åç­‰å¾…æ›´å¤šã€‚å¦‚æœçº¿ç¨‹ä¸åšæœ‰ç”¨çš„å·¥ä½œï¼Œå®ƒä»¬å°±ä¸åº”è¯¥è¿è¡Œã€‚å°± Executor Framworkï¼ˆè¯¦è§ç¬¬ 80 æ¡ï¼‰è€Œè¨€ï¼Œè¿™æ„å‘³ç€è¦é€‚å½“è°ƒæ•´çº¿ç¨‹æ± çš„å¤§å°ï¼Œå¹¶ä¿æŒä»»åŠ¡ç®€çŸ­ï¼Œä½†ä¸èƒ½å¤ªçŸ­ï¼Œå¦åˆ™è°ƒåº¦å¼€é”€ä¼šæŸå®³æ€§èƒ½ã€‚

> è¿™é‡Œçš„å¯è¿è¡ŒæŒ‡çš„æ˜¯ runnableï¼Œè€Œå¹¶ä¸æ˜¯ runningã€‚

### ä¸è¦è®©çº¿ç¨‹å¤„äºå¿™ç­‰

çº¿ç¨‹ä¸åº”å¿™äºç­‰å¾…ï¼ˆbusy-waitï¼‰ï¼Œå³åå¤æ£€æŸ¥å…±äº«å¯¹è±¡ï¼Œç­‰å¾…å…¶çŠ¶æ€å˜åŒ–ã€‚é™¤äº†ä½¿ç¨‹åºå®¹æ˜“å—åˆ°çº¿ç¨‹è°ƒåº¦å™¨çš„å½±å“å¤–ï¼Œå¿™ç¢Œç­‰å¾…è¿˜å¤§å¤§å¢åŠ äº†å¤„ç†å™¨çš„è´Ÿè½½ï¼Œå‡å°‘äº†å…¶ä»–çº¿ç¨‹å¯ä»¥å®Œæˆçš„æœ‰ç”¨çš„å·¥ä½œé‡ã€‚ä½œä¸ºä¸€ä¸ªä¸åº”è¯¥åšçš„åé¢ä¾‹å­ï¼Œè€ƒè™‘ä¸€ä¸‹`CountDownLatch` çš„è¿™ä¸ªåå¸¸çš„é‡æ–°å®ç°ï¼š

// Awful CountDownLatch implementation - busy-waits incessantly!  
public class SlowCountDownLatch {  
    private int count;  
    public SlowCountDownLatch(int count) {  
        if (count < 0)  
            throw new IllegalArgumentException(count + " < 0");  
        this.count = count;  
    }  
  
    public void await() {  
        while (true) {  
            synchronized(this) {  
                if (count == 0)  
                    return;  
            }   
        }  
    }  
  
    public synchronized void countDown() {  
        if (count != 0)  
            count--;  
    }   
}

åœ¨ä½œè€…çš„æœºå™¨ä¸Šï¼Œå½“ 1000 ä¸ªçº¿ç¨‹åœ¨ latch ä¸Šç­‰å¾…æ—¶ï¼Œ`SlowCountDownLatch` æ¯” `CountDownLatch` æ…¢äº† 10 å€ã€‚ è™½ç„¶è¿™ä¸ªä¾‹å­çœ‹èµ·æ¥æœ‰ç‚¹ç‰µå¼ºï¼Œä½†åœ¨å¾ˆå¤šç³»ç»Ÿä¸Šï¼Œéƒ½å­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹å¤„äºæ²¡å¿…è¦çš„å¯è¿è¡ŒçŠ¶æ€ã€‚æ€§èƒ½å’Œå¯ç§»æ¤æ€§éƒ½å¯èƒ½å—åˆ°å½±å“ã€‚

### è°¨æ…ä½¿ç”¨ Thread.yield

å½“é¢å¯¹ä¸€ä¸ªå› ä¸ºæŸäº›çº¿ç¨‹ç›¸å¯¹äºå…¶ä»–çº¿ç¨‹æ²¡æœ‰è·å¾—è¶³å¤Ÿçš„ CPU æ—¶é—´è€Œå‹‰å¼ºè¿è¡Œçš„ç¨‹åºæ—¶ï¼Œä¸è¦é€šè¿‡è°ƒç”¨ `Thread.yield` æ¥ "ä¿®å¤" ç¨‹åºã€‚è™½ç„¶å¯èƒ½ä¼šåœ¨æŸç§ç¨‹åº¦ä¸ŠæˆåŠŸåœ°è®©ç¨‹åºå·¥ä½œï¼Œä½†å®ƒå°†æ— æ³•è¢«ç§»æ¤ã€‚åŒæ ·çš„ `yield` è°ƒç”¨ï¼Œåœ¨ä¸€ä¸ª JVM å®ç°ä¸Šå¯èƒ½å¯ä»¥æå‡æ€§èƒ½ï¼Œä½†åœ¨ç¬¬äºŒä¸ª JVM å®ç°ä¸Šå¯èƒ½ä¼šé™ä½æ€§èƒ½ï¼Œä¹Ÿå¯èƒ½åœ¨ç¬¬ä¸‰ä¸ª JVM å®ç°ä¸Šå®ƒæ²¡æœ‰ä»»ä½•æ•ˆæœã€‚`Thread.yield` æ²¡æœ‰å¯æµ‹è¯•çš„è¯­ä¹‰ï¼ˆtestable semanticï¼ŒTODOï¼šä»€ä¹ˆå«å¯æµ‹è¯•ï¼‰ã€‚ä¸€ä¸ªæ›´å¥½çš„åšæ³•æ˜¯é‡æ„åº”ç”¨ç¨‹åºï¼Œä»¥å‡å°‘å¯å¹¶å‘è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚

### è°¨æ…è°ƒæ•´çº¿ç¨‹ä¼˜å…ˆçº§

ä¸€ä¸ªç›¸å…³çš„æ–¹æ³•æ˜¯è°ƒæ•´çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œä½†è¿™ç§æ–¹æ³•ä¹Ÿæœ‰ç±»ä¼¼çš„æ³¨æ„äº‹é¡¹ã€‚çº¿ç¨‹ä¼˜å…ˆçº§æ˜¯ Java ä¸­æœ€ä¸å®¹æ˜“ç§»æ¤çš„ç‰¹æ€§ä¹‹ä¸€ã€‚é€šè¿‡è°ƒæ•´ä¸€äº›çº¿ç¨‹çš„ä¼˜å…ˆçº§æ¥è°ƒæ•´åº”ç”¨ç¨‹åºçš„å“åº”é€Ÿåº¦ä¸æ˜¯æ²¡æœ‰é“ç†çš„ï¼Œä½†è¿™å¾ˆå°‘æ˜¯å¿…è¦çš„ï¼Œå¹¶ä¸”æ˜¯ä¸å¯ç§»æ¤çš„ã€‚åƒä¸‡ä¸è¦é€šè¿‡è°ƒæ•´çº¿ç¨‹ä¼˜å…ˆçº§æ¥è§£å†³ä¸€ä¸ªä¸¥é‡çš„æ´»æ€§é—®é¢˜ï¼Œé™¤éæ‰¾åˆ°å¹¶è§£å†³æ ¹æœ¬åŸå› ï¼Œå¦åˆ™è¿™ä¸ªé—®é¢˜å¾ˆå¯èƒ½ä¼šé‡æ–°å‡ºç°ã€‚

### æ€»ç»“

æ€»è€Œè¨€ä¹‹ï¼Œä¸è¦ä¾èµ–çº¿ç¨‹è°ƒåº¦å™¨æ¥ä¿è¯ä½ ç¨‹åºçš„æ­£ç¡®æ€§ã€‚è¿™æ ·çš„ç¨‹åºæ—¢ä¸å¥å£®ï¼Œä¹Ÿä¸å®¹æ˜“ç§»æ¤ã€‚ä½œä¸ºä¸€ä¸ªæ¨è®ºï¼Œä¸è¦ä¾èµ– `Thread.yield` æˆ–çº¿ç¨‹ä¼˜å…ˆçº§ã€‚è¿™äº›è®¾æ–½åªæ˜¯å¯¹è°ƒåº¦å™¨çš„æç¤ºã€‚çº¿ç¨‹ä¼˜å…ˆçº§å¯ä»¥å°‘é‡ä½¿ç”¨æ¥æé«˜ä¸€ä¸ªå·²ç»å·¥ä½œçš„ç¨‹åºçš„æœåŠ¡è´¨é‡ï¼Œä½†å®ƒä»¬ç»ä¸åº”è¯¥è¢«ç”¨æ¥ "ä¿®å¤" ä¸€ä¸ªå‡ ä¹ä¸èƒ½å·¥ä½œçš„ç¨‹åºã€‚

# åä¸€. åºåˆ—åŒ–

å¯¹è±¡åºåˆ—åŒ–æ˜¯ä¸€ä¸ª Java æ¡†æ¶ï¼Œç”¨æ¥å°†å¯¹è±¡ç¼–ç æˆå­—èŠ‚æµï¼ˆåºåˆ—åŒ–ï¼‰ï¼Œæˆ–è€…ä»å­—èŠ‚æµç¼–ç ä¸­é‡æ–°åˆ›å»ºå¯¹è±¡ï¼ˆååºåˆ—åŒ–ï¼‰ã€‚å¯¹è±¡è¢«åºåˆ—åŒ–åï¼Œå®ƒçš„ç¼–ç å¯ä»¥ä»ä¸€ä¸ª VM å‘é€åˆ°å¦ä¸€ä¸ª VMï¼Œæˆ–è€…å­˜å‚¨åœ¨ç£ç›˜ä¸Šä»¥ä¾¿ä»¥åååºåˆ—åŒ–ã€‚æœ¬ç« ä¸»è¦è®¨è®ºåºåˆ—åŒ–çš„å±é™©æ€§ä»¥åŠå¦‚ä½•å°†å…¶é™è‡³æœ€ä½ã€‚

## 85. å…¶ä»–æ–¹æ³•ä¼˜äº Java åºåˆ—åŒ–

### å±é™©çš„ Java åºåˆ—åŒ–

ç®€å•å³å¯å®ç°åˆ†å¸ƒå¼å¯¹è±¡å¯¹ç¨‹åºå‘˜æ¥è¯´å¾ˆæœ‰å¸å¼•åŠ›ï¼Œä½†ä»£ä»·æ˜¯çœ‹ä¸è§çš„æ„é€ å™¨å’Œ API ä¸å®ç°ä¹‹é—´çš„æ¨¡ç³Šç•Œé™ï¼Œä»¥åŠæ½œåœ¨çš„æ­£ç¡®æ€§ã€æ€§èƒ½ã€å®‰å…¨æ€§å’Œç»´æŠ¤æ–¹é¢çš„é—®é¢˜ã€‚æ”¯æŒè€…ä»¬è®¤ä¸ºå¥½å¤„å¤šäºé£é™©ï¼Œä½†å†å²è¡¨æ˜å¹¶éå¦‚æ­¤ã€‚

åºåˆ—åŒ–çš„æ ¹æœ¬é—®é¢˜åœ¨äºï¼Œå®ƒçš„æ”»å‡»é¢ï¼ˆattack surfaceï¼‰è¿‡äºåºå¤§ï¼Œæ— æ³•é˜²æŠ¤ï¼Œå¹¶ä¸”å®ƒè¿˜åœ¨ä¸æ–­æ‰©å¤§ï¼šå¯¹è±¡å›¾ï¼ˆobject graphsï¼‰æ˜¯é€šè¿‡è°ƒç”¨ `ObjectInputStream` ä¸Šçš„ `readObject` æ–¹æ³•æ¥ååºåˆ—åŒ–çš„ã€‚è¿™ä¸ªæ–¹æ³•æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç¥å¥‡çš„æ„é€ å‡½æ•°ï¼Œå®ƒå¯ä»¥å®ä¾‹åŒ–ç±»è·¯å¾„ï¼ˆclass pathï¼‰ä¸Šçš„å‡ ä¹ä»»ä½•ç±»å‹çš„å¯¹è±¡ï¼Œåªè¦è¿™ä¸ªç±»å‹å®ç°äº† `Serializable` æ¥å£ã€‚åœ¨ååºåˆ—åŒ–å­—èŠ‚æµçš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥æ‰§è¡Œä»»ä½•è¿™äº›ç±»å‹çš„ä»£ç ï¼Œæ‰€ä»¥æ‰€æœ‰è¿™äº›ç±»å‹çš„ä»£ç éƒ½æ˜¯æ”»å‡»é¢çš„ä¸€éƒ¨åˆ†ã€‚

æ”»å‡»é¢è¿˜åŒ…æ‹¬ Java ç±»åº“ã€ç¬¬ä¸‰æ–¹ç±»åº“ä»¥åŠåº”ç”¨ç¨‹åºè‡ªèº«ä¸­çš„ç±»ã€‚å³ä½¿éµå®ˆæ‰€æœ‰ç›¸å…³çš„æœ€ä½³å®è·µï¼Œå¹¶ä¸”å†™å‡ºäº†æ— æ‡ˆå¯å‡»çš„å¯åºåˆ—åŒ–ç±»ï¼Œè¿™ä¸ªç¨‹åºä¹Ÿä¾ç„¶æ˜¯è„†å¼±çš„ã€‚

> â€œ Java ååºåˆ—åŒ–æ˜¯ä¸€ä¸ªæ˜æ˜¾å­˜åœ¨çš„é£é™©ï¼Œå®ƒä¸ä»…è¢«åº”ç”¨ç›´æ¥å¹¿æ³›ä½¿ç”¨ï¼Œä¹Ÿè¢« Java å­ç³»ç»Ÿå¦‚ RMI ï¼ˆè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼‰ã€JMXï¼ˆJava Management Extensionï¼‰å’Œ JMSï¼ˆJava Messaging Systemï¼‰ç­‰å¤§é‡åœ°é—´æ¥ä½¿ç”¨ã€‚å¯¹ä¸è¢«ä¿¡ä»»çš„æµè¿›è¡Œååºåˆ—åŒ–ï¼Œå¯èƒ½å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRemote Code Execution, RCEï¼‰ã€æ‹’ç»æœåŠ¡ï¼ˆDenial-of-Service, DoSï¼‰ï¼Œä»¥åŠä¸€ç³»åˆ—å…¶ä»–çš„æ”»å‡» ã€‚å³ä½¿åº”ç”¨æœ¬èº«æ²¡æœ‰åšé”™ä»»ä½•äº‹æƒ…ï¼Œä¹Ÿå¯èƒ½å—åˆ°è¿™äº›æ”»å‡»â€ã€‚

æ”»å‡»è€…å’Œå®‰å…¨ç ”ç©¶å‘˜éƒ½åœ¨ç ”ç©¶ Java ç±»åº“å’Œå¸¸ç”¨çš„ç¬¬ä¸‰æ–¹ç±»åº“ä¸­å¯åºåˆ—åŒ–çš„ç±»å‹ï¼Œå¯»æ‰¾åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­è°ƒç”¨çš„ã€æ‰§è¡Œæ½œåœ¨å±é™©æ´»åŠ¨çš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•è¢«ç§°ä¸º gadgetã€‚å¤šä¸ª gadget å¯ä»¥ååŒä½¿ç”¨ï¼Œå½¢æˆä¸€ä¸ª gadget é“¾ã€‚å½“å‘ç°ä¸€ä¸ªè¶³å¤Ÿå¼ºå¤§çš„ gadget é“¾ï¼Œå…è®¸æ”»å‡»è€…åœ¨åº•å±‚ç¡¬ä»¶ä¸Šæ‰§è¡Œä»»æ„çš„æœ¬åœ°ä»£ç ï¼Œåªè¦æœ‰æœºä¼šæäº¤ä¸€ä¸ªç²¾å¿ƒåˆ¶ä½œçš„å­—èŠ‚æµè¿›è¡Œååºåˆ—åŒ–ï¼Œå°±ä¼šé€ æˆä¸¥é‡åæœã€‚

åœ¨ä¸ä½¿ç”¨ä»»ä½• gadget çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åˆ¶ä½œå‡ºéœ€è¦é•¿æ—¶é—´è¿›è¡Œååºåˆ—åŒ–çš„ç®€çŸ­å­—èŠ‚æµï¼Œåªè¦å¼•å‘ååºåˆ—åŒ–ï¼Œå°±å¯ä»¥è½»æ¾åœ°å±•å¼€ä¸€æ¬¡æ‹’ç»æœåŠ¡æ”»å‡»ã€‚è¿™ç§æµè¢«ç§°ä¸ºååºåˆ—åŒ–ç‚¸å¼¹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå®ƒåªä½¿ç”¨ `HashSet` å’Œä¸€ä¸ªå­—ç¬¦ä¸²ï¼š

// Deserialization bomb - deserializing this stream takes forever  
static byte[] bomb() {  
    Set<Object> root = new HashSet<>();  
    Set<Object> s1 = root;  
    Set<Object> s2 = new HashSet<>();  
    for (int i = 0; i < 100; i++) {  
        Set<Object> t1 = new HashSet<>();  
        Set<Object> t2 = new HashSet<>();  
        t1.add("foo"); // Make t1 unequal to t2  
        s1.add(t1);  s1.add(t2);  
        s2.add(t1);  s2.add(t2);  
        s1 = t1;  
        s2 = t2;  
    }  
    return serialize(root); // Method omitted for brevity  
}

è¿™ä¸ªå¯¹è±¡å›¾åŒ…å«äº† 201 ä¸ª `HashSet` å®ä¾‹ï¼Œæ¯ä¸ªåˆåŒ…å«äº†æœ€å¤š 3 ä¸ªå¯¹è±¡å¼•ç”¨ã€‚æ•´ä¸ªæµçš„é•¿åº¦ä¸º 5733 å­—èŠ‚ï¼Œä½†åœ¨ååºåˆ—åŒ–ä¹‹å‰ï¼Œæ€»é•¿åº¦ä¼šçˆ†ç‚¸å¼å¢é•¿ã€‚é—®é¢˜å°±æ˜¯ååºåˆ—åŒ–ä¸€ä¸ª `HashSet` å®ä¾‹éœ€è¦è®¡ç®—å®ƒæ‰€æœ‰å…ƒç´ çš„å“ˆå¸Œç ã€‚æ ¹ HashSet çš„ 2 ä¸ªå…ƒç´ æœ¬èº«ä¹Ÿæ˜¯ `HashSet`ï¼Œä¸”æ¯ä¸ªä¹Ÿéƒ½åŒ…å« 2 ä¸ª `HashSet` å…ƒç´ ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ° 100 å±‚ã€‚å› æ­¤ï¼Œååºåˆ—åŒ–å°±ä¼šé€ æˆ `hashCode` æ–¹æ³•è°ƒç”¨è¶…è¿‡ 2^100 æ¬¡ã€‚è€Œä¸”ï¼Œååºåˆ—åŒ–èŠ±è´¹çš„æ—¶é—´æ˜¯æ— é™çš„ï¼Œè€Œä¸”å®ƒä¸ä¼šæç¤ºå“ªé‡Œå‡ºäº†é”™ã€‚å®ƒå‡ ä¹ä¸äº§ç”Ÿä»»ä½•å¯¹è±¡ï¼Œæ ˆæ·±åº¦ä¹Ÿæ˜¯æœ‰é™åˆ¶çš„ã€‚

### è·¨å¹³å°çš„ç»“æ„åŒ–æ•°æ®è¡¨ç¤ºæ³•

è¯¥æ€ä¹ˆé¢„é˜²è¿™äº›é—®é¢˜å‘¢ï¼Ÿåªè¦å¯¹ä¸€ä¸ªä¸ä¿¡ä»»çš„å­—èŠ‚æµè¿›è¡Œååºåˆ—åŒ–ï¼Œå°±ä¼šå°†è‡ªå·±æš´éœ²åœ¨æ”»å‡»ä¹‹ä¸‹ã€‚**é¿å…åºåˆ—åŒ–æ¼æ´çš„æœ€å¥½æ–¹æ³•æ˜¯æ°¸è¿œä¸è¦å¯¹ä»»ä½•ä¸œè¥¿è¿›è¡Œååºåˆ—åŒ–ã€‚åœ¨å†™æ–°ç³»ç»Ÿçš„æ—¶å€™ï¼Œæ²¡æœ‰ç†ç”±å†ä½¿ç”¨ Java åºåˆ—åŒ–ã€‚**åº”è¯¥ä½¿ç”¨å…¶ä»–æœºåˆ¶æ¥å®Œæˆå¯¹è±¡å’Œå­—èŠ‚åºåˆ—ä¹‹é—´çš„è½¬åŒ–ï¼Œä½œè€…å°†è¿™ç§æœºåˆ¶ç§°ä¸º**è·¨å¹³å°çš„ç»“æ„åŒ–æ•°æ®è¡¨ç¤ºæ³•ï¼ˆcross-platform structured-data representationsï¼‰**ï¼ˆå…¶ä»–åœ°æ–¹å¯èƒ½ä¼šç®€å•å«ä½œåºåˆ—åŒ–ç³»ç»Ÿï¼‰ã€‚

æœ€å‰æ²¿çš„è·¨å¹³å°çš„ç»“æ„åŒ–æ•°æ®è¡¨ç¤ºæ³•æ˜¯ JSON å’Œ Protocl Buffersï¼Œä¹Ÿè¢«å«ä½œ protobufã€‚å®ƒä»¬æœ€å¤§çš„åŒºåˆ«å°±æ˜¯ JSON æ˜¯åŸºäºæ–‡æœ¬ã€å¯é˜…è¯»çš„ï¼Œä½† protobuf æ˜¯äºŒè¿›åˆ¶çš„ï¼Œè€Œä¸”æ•ˆç‡é«˜å¾—å¤šï¼›JSON çº¯ç²¹æ˜¯ä¸€ç§æ•°æ®è¡¨ç¤ºæ³•ï¼Œè€Œ protobuf æä¾›æ¨¡å¼ï¼ˆç±»å‹ï¼‰æ¥è®°å½•å’Œæ‰§è¡Œé€‚å½“çš„ç”¨æ³•ã€‚å°½ç®¡ protobuf æ¯” JSON æ›´é«˜æ•ˆï¼Œä½† JSON å¯¹äºåŸºäºæ–‡æœ¬çš„è¡¨ç¤ºæ³•æ¥è¯´æ˜¯éå¸¸é«˜æ•ˆçš„ã€‚è™½ç„¶ protobuf æ˜¯ä¸€ç§äºŒè¿›åˆ¶è¡¨ç¤ºæ³•ï¼Œä½†å®ƒç¡®å®æä¾›äº†ä¸€ç§æ›¿ä»£çš„æ–‡æœ¬è¡¨ç¤ºæ³•ï¼Œç”¨äºéœ€è¦é˜…è¯»çš„åœ°æ–¹ã€‚

### å¦‚æœæ— æ³•é¿å… Java åºåˆ—åŒ–

å¦‚æœæ— æ³•é¿å… Java åºåˆ—åŒ–ï¼Œä¹Ÿè®¸æ˜¯å› ä¸ºåœ¨ä¸€ä¸ªéœ€è¦å®ƒçš„ä¼ ç»Ÿç³»ç»Ÿä¸­å·¥ä½œï¼Œé‚£ä¹ˆä½ çš„æœ€å¥½çš„ä¸‹ä¸€æ­¥å°±æ˜¯æ°¸è¿œä¸è¦ååºåˆ—åŒ–ä¸å—ä¿¡ä»»çš„æ•°æ®ã€‚ç‰¹åˆ«æ˜¯ä¸åº”è¯¥æ¥å—æ¥è‡ªä¸å—ä¿¡ä»»æ¥æºçš„ RMI é€šä¿¡ã€‚Java çš„å®˜æ–¹å®‰å…¨ç¼–ç æŒ‡å—è¯´ï¼šâ€œå¯¹ä¸å¯ä¿¡ä»»çš„æ•°æ®è¿›è¡Œååºåˆ—åŒ–ï¼Œæœ¬è´¨ä¸Šæ¥è¯´å¾ˆå±é™©ï¼Œåº”è¯¥é¿å…ã€‚" è¿™å¥è¯è¢«è®¾ç½®ä¸ºå¤§å·ã€ç²—ä½“ã€æ–œä½“ã€çº¢è‰²å­—ä½“ï¼Œå®ƒæ˜¯æ•´ä¸ªæ–‡æ¡£ä¸­å”¯ä¸€å¾—åˆ°è¿™ç§å¾…é‡çš„æ–‡æœ¬ã€‚

å¦‚æœæ— æ³•ç»å¯¹ä¿è¯ååºåˆ—åŒ–çš„æ•°æ®çš„å®‰å…¨æ€§ï¼Œä½¿ç”¨ Java 9 æ–°å¢çš„å¯¹è±¡ååºåˆ—åŒ–è¿‡æ»¤ï¼Œè¿™ä¸€åŠŸèƒ½ä¹Ÿå·²ç»è¢«ç§»æ¤åˆ°äº†æ—©æœŸç‰ˆæœ¬ï¼ˆjava.io.ObjectInputFilterï¼‰ã€‚å®ƒå¯ä»¥åœ¨æ•°æ®æµè¢«ååºåˆ—åŒ–ä¹‹å‰ï¼ŒæŒ‡å®šä¸€ä¸ªè¿‡æ»¤å™¨ã€‚å®ƒçš„æ“ä½œç²’åº¦æ˜¯ç±»ï¼Œå¯ä»¥é€‰æ‹©æ¥å—æˆ–æ‹’ç»å“ªäº›ç±»ã€‚é»˜è®¤æ¥å—ç±»ï¼Œä½†æ‹’ç»ä¸€äº›æ½œåœ¨å±é™©çš„é»‘åå•ï¼›é»˜è®¤æ‹’ç»ç±»ï¼ŒåŒæ—¶æ¥å—å‡è®¾å®‰å…¨çš„ç™½åå•ã€‚**ç™½åå•ä¼˜äºé»‘åå•**ï¼Œå› ä¸ºé»‘åå•åªèƒ½æŠµå¾¡å·²çŸ¥çš„å¨èƒï¼ˆä¸€ä¸ªå«åš Serial Whitelist Application Trainerï¼ˆSWATï¼‰çš„å·¥å…·å¯ä»¥è‡ªåŠ¨ä¸ºç¨‹åºå‡†å¤‡ä¸€ä»½ç™½åå•ï¼‰ã€‚è¿‡æ»¤è®¾æ–½ä¹Ÿå°†ä¿æŠ¤å…å—è¿‡åº¦çš„å†…å­˜ä½¿ç”¨ï¼Œä»¥åŠè¿‡åº¦æ·±å…¥çš„å¯¹è±¡å›¾ï¼Œä½†å®ƒä¸ä¼šä¿æŠ¤ä½ å…å—åƒä¸Šé¢æ‰€ç¤ºçš„åºåˆ—åŒ–ç‚¸å¼¹çš„ä¼¤å®³ï¼ˆTODOï¼šè¿‡æ·±çš„å¯¹è±¡å›¾ä¸å°±æ˜¯ä¸Šé¢çš„åºåˆ—åŒ–ç‚¸å¼¹å—ï¼Ÿï¼‰ã€‚

### æ€»ç»“

é—æ†¾çš„æ˜¯ï¼Œåºåˆ—åŒ–åœ¨ Java ç”Ÿæ€ç³»ç»Ÿä¸­å¾ˆå¸¸è§ã€‚å¦‚æœè¦ç»´æŠ¤ä¸€ä¸ªåŸºäº Java åºåˆ—åŒ–çš„ç³»ç»Ÿï¼Œè¯·è®¤çœŸè€ƒè™‘è¿ç§»åˆ°ä¸€ä¸ªè·¨å¹³å°çš„ç»“æ„åŒ–æ•°æ®è¡¨ç¤ºæ³•ï¼Œå°½ç®¡è¿™å¯èƒ½æ˜¯ä¸€ä¸ªè€—æ—¶çš„åŠªåŠ›ã€‚ç°å®ä¸­ï¼Œå¯èƒ½ä»ç„¶ä¼šä¸å¾—ä¸ç¼–å†™æˆ–ç»´æŠ¤ä¸€ä¸ªå¯åºåˆ—åŒ–çš„ç±»ã€‚è¦ç¼–å†™ä¸€ä¸ªæ­£ç¡®ã€å®‰å…¨å’Œé«˜æ•ˆçš„å¯åºåˆ—åŒ–ç±»ï¼Œéœ€è¦éå¸¸è°¨æ…ã€‚æœ¬ç« çš„å…¶ä½™éƒ¨åˆ†æä¾›äº†å…³äºä½•æ—¶å’Œå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„å»ºè®®ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œåºåˆ—åŒ–æ˜¯å±é™©çš„ï¼Œåº”è¯¥é¿å…ã€‚å¦‚æœè¦ä»å¤´å¼€å§‹è®¾è®¡ä¸€ä¸ªç³»ç»Ÿï¼Œè¯·ä½¿ç”¨è·¨å¹³å°çš„ç»“æ„åŒ–æ•°æ®è¡¨ç¤ºæ³•ã€‚ä¸è¦å¯¹ä¸å—ä¿¡ä»»çš„æ•°æ®è¿›è¡Œååºåˆ—åŒ–ã€‚å¦‚æœä½ å¿…é¡»è¿™æ ·åšï¼Œè¯·ä½¿ç”¨å¯¹è±¡ååºåˆ—åŒ–è¿‡æ»¤ï¼Œä½†è¦æ³¨æ„ï¼Œå®ƒä¸èƒ½ä¿è¯é˜»æŒ¡æ‰€æœ‰æ”»å‡»ã€‚é¿å…ç¼–å†™å¯åºåˆ—åŒ–çš„ç±»ï¼Œå¦‚æœå¿…é¡»è¿™æ ·åšï¼Œè¦éå¸¸è°¨æ…ã€‚

## 86. è°¨æ…åœ°å®ç° Serializable æ¥å£

è¦æƒ³ä½¿ä¸€ä¸ªç±»å¯ä»¥è¢«åºåˆ—åŒ–ï¼Œåªè¦è®©å®ƒå®ç° `Serializable` æ¥å£å³å¯ã€‚æ­£æ˜¯å› ä¸ºå¤ªå®¹æ˜“äº†ï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªæ™®éçš„è¯¯è§£ï¼Œè®¤ä¸ºåºåˆ—åŒ–ä¸éœ€è¦ç¨‹åºå‘˜ä»˜å‡ºä»€ä¹ˆã€‚äº‹å®è¦å¤æ‚å¾—å¤šã€‚è™½ç„¶ä½¿ä¸€ä¸ªç±»å®ç°å¯åºåˆ—åŒ–çš„ç›´æ¥æˆæœ¬å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œä½†é•¿æœŸæˆæœ¬å¾€å¾€æ˜¯å·¨å¤§çš„ã€‚

å®ç° `Serializable` æ¥å£æœ€å¤§ä»£ä»·å°±æ˜¯ï¼Œä¸€æ—¦è¢«å‘å¸ƒï¼Œå°±å¤§å¤§é™ä½äº†æ”¹å˜è¿™ä¸ªç±»çš„å®ç°çš„çµæ´»æ€§ã€‚å½“ä¸€ä¸ªç±»å®ç°äº† Serializableï¼Œå®ƒçš„å­—èŠ‚æµç¼–ç ï¼ˆæˆ–è€…åºåˆ—åŒ–å½¢å¼ï¼‰å°±æˆäº†å®ƒå¯¼å‡º API çš„ä¸€éƒ¨åˆ†ã€‚

TODOï¼šå¤ªéš¾äº†ï¼Œçœ‹ä¸æ‡‚
